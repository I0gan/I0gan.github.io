<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Maybe fun game | I0gan</title><meta name="keywords" content="c++"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Hong Ming Gu Cup OnlinePWN - [Maybe_fun_game (双边协议1.0)]This challenge I think is a little bit difficult for me. because these vulnerability cannot exploit easily. 战队名称：没有任何 战队排名：41 战队ID：T566675 解题数量：5">
<meta property="og:type" content="article">
<meta property="og:title" content="Maybe fun game">
<meta property="og:url" content="http://blog.i0gan.cn/2021/04/02/wp-maybe-fun-game/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Hong Ming Gu Cup OnlinePWN - [Maybe_fun_game (双边协议1.0)]This challenge I think is a little bit difficult for me. because these vulnerability cannot exploit easily. 战队名称：没有任何 战队排名：41 战队ID：T566675 解题数量：5">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2021-04-02T12:01:00.000Z">
<meta property="article:modified_time" content="2021-04-02T12:06:23.050Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="c++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2021/04/02/wp-maybe-fun-game/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-02 20:06:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">61</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">28</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Maybe fun game</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-04-02T12:01:00.000Z" title="Created 2021-04-02 20:01:00">2021-04-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-04-02T12:06:23.050Z" title="Updated 2021-04-02 20:06:23">2021-04-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/c/">c++</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Hong-Ming-Gu-Cup-Online"><a href="#Hong-Ming-Gu-Cup-Online" class="headerlink" title="Hong Ming Gu Cup Online"></a>Hong Ming Gu Cup Online</h1><h2 id="PWN-Maybe-fun-game-双边协议1-0"><a href="#PWN-Maybe-fun-game-双边协议1-0" class="headerlink" title="PWN - [Maybe_fun_game (双边协议1.0)]"></a>PWN - [Maybe_fun_game (双边协议1.0)]</h2><p>This challenge I think is a little bit difficult for me. because these vulnerability cannot exploit easily.</p>
<pre><code>战队名称：没有任何
战队排名：41
战队ID：T566675
解题数量：5
得分：634</code></pre>
<p>Attachment:</p>
<p>Maybe_fun_game.zip </p>
<p>Just a single binary file, not include libc.so.6 file. So we have to leak information of libc version by some ways.</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre><code>Checksec file: pwn
[*] &#39;/run/media/i0gan/disk1/share/hmgb/pwn1/pwn&#39;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled</code></pre>
<h3 id="Reversing"><a href="#Reversing" class="headerlink" title="Reversing"></a>Reversing</h3><pre><code>[i0gan@arch pwn1]$ ./pwn 
eFY0EnhWNBIuAAAAAAAAAAgAAAAAAAAABgAAAAAAAABBQUFBQUFBQTEuTmV3Lg==
eFY0EnhWNBIuAAAAAAAAAAgAAAAAAAAABgAAAAAAAABBQUFBQUFBQTIuRGVsLg==
eFY0EnhWNBIvAAAAAAAAAAgAAAAAAAAABwAAAAAAAABBQUFBQUFBQTMuRWRpdC4=
eFY0EnhWNBIvAAAAAAAAAAgAAAAAAAAABwAAAAAAAABBQUFBQUFBQTQuU2hvdy4=
eFY0EnhWNBIxAAAAAAAAAAgAAAAAAAAACQAAAAAAAABBQUFBQUFBQUNob2ljZSA/Pg==
AAA
eFY0EnhWNBI2AAAAAAAAAAgAAAAAAAAADgAAAAAAAABBQUFBQUFBQUlsbGVnYWwgTWFnaWMh</code></pre>
<p>We don’t know how these words means, But easily guess that it is base64 encoded. Now we should analyse this binary file by IDA tools.</p>
<h4 id="main-function"><a href="#main-function" class="headerlink" title="main function"></a>main function</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// al</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>body<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">char</span> c<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// cl</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>body_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">char</span> c_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// cl</span>
  __int64 v11<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">init_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>                                 <span class="token comment" spellcheck="true">// delete</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v3 <span class="token operator">=</span> <span class="token function">dec_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token string">"ERROR"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token function">free</span><span class="token punctuation">(</span>global_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        v4 <span class="token operator">=</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token string">'2'</span> <span class="token punctuation">)</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        src <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">></span> <span class="token string">'2'</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token string">'1'</span> <span class="token punctuation">)</span>                          <span class="token comment" spellcheck="true">// new</span>
      <span class="token punctuation">{</span>
        <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Size >>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v5 <span class="token operator">=</span> <span class="token function">dec_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>global_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x7E</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Content >>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          body_ <span class="token operator">=</span> <span class="token function">dec_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            c_ <span class="token operator">=</span> <span class="token operator">*</span>body_<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>body_ <span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              v11 <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
              <span class="token keyword">do</span>
              <span class="token punctuation">{</span>
                src<span class="token punctuation">[</span>v11 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c_<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v11 <span class="token punctuation">)</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
                c_ <span class="token operator">=</span> body_<span class="token punctuation">[</span>v11<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">while</span> <span class="token punctuation">(</span> c_ <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
LABEL_18<span class="token punctuation">:</span>
          <span class="token function">free</span><span class="token punctuation">(</span>global_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Illegal size!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
LABEL_12<span class="token punctuation">:</span>
        <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Your Choice is invaild."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token string">'3'</span> <span class="token punctuation">)</span>                            <span class="token comment" spellcheck="true">// edit</span>
    <span class="token punctuation">{</span>
      <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Content >>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      body <span class="token operator">=</span> <span class="token function">dec_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        c <span class="token operator">=</span> <span class="token operator">*</span>body<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>body <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          v8 <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
          <span class="token keyword">do</span>
          <span class="token punctuation">{</span>
            src<span class="token punctuation">[</span>v8 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> size <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v8 <span class="token punctuation">)</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            c <span class="token operator">=</span> body<span class="token punctuation">[</span>v8<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span> c <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token string">'4'</span> <span class="token punctuation">)</span>                            <span class="token comment" spellcheck="true">// print</span>
      <span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>
    <span class="token function">enc_print</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="munu-function"><a href="#munu-function" class="headerlink" title="munu function"></a>munu function</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"1.New."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"2.Del."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"3.Edit."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"4.Show."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">enc_print</span><span class="token punctuation">(</span><span class="token string">"Choice >>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Call enc_print function encoding string to print.</p>
<h4 id="enc-print-function"><a href="#enc-print-function" class="headerlink" title="enc_print function"></a>enc_print function</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">printw</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 size_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>
  _QWORD <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// r14</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  size_t v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// r13</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 vars0<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp+0h] BYREF</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">4104</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1000h] [rbp+1000h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 vars2008<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+2008h] [rbp+2008h]</span>

  qword_203110 <span class="token operator">=</span> <span class="token number">8LL</span><span class="token punctuation">;</span>
  vars2008 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>vars0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vars0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_203100 <span class="token operator">=</span> <span class="token number">0x1234567812345678LL</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// magic</span>
  size_ <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Get length of string</span>
  real_size <span class="token operator">=</span> size_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// size</span>
  v2 <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">8uLL</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_203120 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v2<span class="token punctuation">;</span>
  <span class="token operator">*</span>v2 <span class="token operator">=</span> <span class="token number">0x4141414141414141LL</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// end flag</span>
  v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>size_<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> size_<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  qword_203128 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">;</span>
  size_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0x28LL</span><span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> src<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_203108 <span class="token operator">=</span> size_<span class="token punctuation">;</span>
  vars0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> size_<span class="token punctuation">;</span>
  vars0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> qword_203100<span class="token punctuation">;</span>
  vars0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> qword_203110<span class="token punctuation">;</span>
  vars0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> real_size<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">_stpcpy_chk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>vars0<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>vars0<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token number">4064LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// copy end flag</span>
  <span class="token function">_strcpy_chk</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v5<span class="token punctuation">,</span> <span class="token number">4064LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">base64_enc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>vars0<span class="token punctuation">,</span> size_<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> vars2008<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We should reverse this protocol by read pseudo code.</p>
<p><code>src</code> is a source string will be encoded.</p>
<p><code>qword_203100 = 0x1234567812345678</code> is protocol’s magic.</p>
<p><code>v2</code> store end flag of protocol </p>
<p>vars0 is an array to store information of this protocol</p>
<p>vars0[0]: protocol’s magic (0x1234567812345678)</p>
<p>vars0[1]: strlen(source string) + 0x28</p>
<p>vars0[2]: store <code>qword_203100</code>, value is 8, this value we can change.</p>
<p>vars0[3]: strlen(source string)</p>
<p>vars0[4]: header’s end flag of protocol, (0x4141414141414141)</p>
<p>Then source string will copy to end after vars0[4] and encoded with base64.</p>
<p>Now we can write decode function to decode what this program print.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dec</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token punctuation">]</span></code></pre>
<p>It’s too easy, just use base64 decode what this program print, then cuts header data, let body data return.</p>
<p>Now we can write encode function to encode what we want input.</p>
<p>dec_input function pseudo code as follows.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sub_1070</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 j<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbp</span>
  <span class="token keyword">double</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// xmm2_8</span>
  <span class="token keyword">double</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// xmm1_8</span>
  __int64 k<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbp</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">double</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// xmm1_8</span>
  size_t size_<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdi</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// r12</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">int</span> v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">double</span> v11<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// xmm1_8</span>
  <span class="token keyword">double</span> v12<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// xmm0_8</span>
  __int64 v13<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v14<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>
  __int64 l<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v16<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v18<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdi</span>
  __int64 v19<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-5058h]</span>
  __int64 v20<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-5048h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+30h] [rbp-5038h] BYREF</span>
  <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1030h] [rbp-4038h] BYREF</span>
  <span class="token keyword">char</span> v23<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+3030h] [rbp-2038h] BYREF</span>
  <span class="token keyword">char</span> v24<span class="token punctuation">[</span><span class="token number">8160</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+3050h] [rbp-2018h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v25<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+5038h] [rbp-30h]</span>
  <span class="token keyword">char</span> v26<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+5040h] [rbp-28h] BYREF</span>

  v25 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">base64_dec</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v19<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1234567812345678LL</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">// check magic</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v19 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v18 <span class="token operator">=</span> <span class="token string">"Illegal Magic!"</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// check_magic... goto error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  qword_2030C8 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> j <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">// calc vars[1]: strlen(source string) + 0x28</span>
  <span class="token punctuation">{</span>
    v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>str<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>j<span class="token punctuation">;</span>
    qword_2030C8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>qword_2030C8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sz <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> k <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">// vars[2]: defualt value is 8, this value we can control malloc size</span>
  <span class="token punctuation">{</span>
    v5 <span class="token operator">=</span> str<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>k<span class="token punctuation">;</span>
    size_ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token punctuation">,</span> v6<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>v5 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sz <span class="token operator">=</span> size_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  v8 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  qword_2030D8 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  data_buf <span class="token operator">=</span> v9<span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">{</span>                                             <span class="token comment" spellcheck="true">// vars[3]: strlen(source string)</span>
    v10 <span class="token operator">=</span> str<span class="token punctuation">[</span>v8 <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v11 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v8<span class="token operator">++</span><span class="token punctuation">;</span>
    v12 <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token punctuation">,</span> v11<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>qword_2030D8<span class="token punctuation">;</span>
    qword_2030D8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v12<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v8 <span class="token operator">!=</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  global_ptr <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v12<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> qword_2030C8 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v12 <span class="token operator">+</span> sz <span class="token operator">+</span> <span class="token number">0x20</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">// check_size</span>
  <span class="token punctuation">{</span>
    v18 <span class="token operator">=</span> <span class="token string">"Illegal Head!"</span><span class="token punctuation">;</span>
ERROR<span class="token punctuation">:</span>
    <span class="token function">enc_print</span><span class="token punctuation">(</span>v18<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>global_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>data_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  v20<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4141414141414141LL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> sz <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>                                 <span class="token comment" spellcheck="true">// copy data to data_buf</span>
  <span class="token punctuation">{</span>
    v13 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>data_buf <span class="token operator">+</span> v13<span class="token punctuation">)</span> <span class="token operator">=</span> str<span class="token punctuation">[</span>v13 <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token operator">++</span>v13<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> sz <span class="token operator">></span> v13 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  v14 <span class="token operator">=</span> data_buf<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> l <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> l <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>l <span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true">// check end flag of protocol</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v20 <span class="token operator">+</span> l<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>data_buf <span class="token operator">+</span> l<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">strcpy</span><span class="token punctuation">(</span>v23<span class="token punctuation">,</span> <span class="token string">"Illegal Key!Your key is "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>v24<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v24<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_strcpy_chk</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v23<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>data_buf<span class="token punctuation">,</span> <span class="token number">0x2000LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v18 <span class="token operator">=</span> v23<span class="token punctuation">;</span>
      <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> qword_2030D8 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v16 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>global_ptr <span class="token operator">+</span> v16<span class="token punctuation">)</span> <span class="token operator">=</span> v26<span class="token punctuation">[</span>v16 <span class="token operator">-</span> <span class="token number">0x3FF0</span> <span class="token operator">+</span> sz<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token operator">++</span>v16<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> qword_2030D8 <span class="token operator">></span> v16 <span class="token punctuation">)</span><span class="token punctuation">;</span>
    v14 <span class="token operator">=</span> data_buf<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">free</span><span class="token punctuation">(</span>v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>global_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We can learn a lot from this function. because some especial data in header of protocol is very important, that can control malloc and calloc memory’s size, and some information can result parsing protocol error.</p>
<p>So we can write a encode function as follows:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">enc</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> ca_sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ma_sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p  <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1234567812345678</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># vars[0]: magic</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ca_sz <span class="token operator">+</span> ma_sz <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># vars[1]: size</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ma_sz<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># vars[2]: control malloc(size), data_buf</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ca_sz<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># vars[3]: strlen(source string), that can control calloc size</span>
    <span class="token comment" spellcheck="true"># through the check function</span>
    <span class="token comment" spellcheck="true"># we must make vars[1] == vars[2] + vars[3]</span>
    p <span class="token operator">+=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">8</span>  <span class="token comment" spellcheck="true"># end flags of protocol</span>
    p <span class="token operator">+=</span> d
    p <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">return</span> p</code></pre>
<p>Updating…</p>
<p>Last: There are some questions helped by: flzx3qc, cnitlrt</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2021/04/02/wp-maybe-fun-game/">http://blog.i0gan.cn/2021/04/02/wp-maybe-fun-game/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/c/">c++</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/04/01/cve-2021-3156/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Heap-Based Buffer Overflow in Sudo</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/02/24/c++-class/" title="C++ Class"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-24</div><div class="title">C++ Class</div></div></a></div><div><a href="/2020/02/22/c++-keywords/" title="C++ Keywords"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-22</div><div class="title">C++ Keywords</div></div></a></div><div><a href="/2020/02/23/c++-others/" title="C++ Others"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-23</div><div class="title">C++ Others</div></div></a></div><div><a href="/2020/02/22/c++-principle/" title="C++ Principle"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-22</div><div class="title">C++ Principle</div></div></a></div><div><a href="/2020/02/24/c++-smart-pointer/" title="C++ Smart Pointer"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-24</div><div class="title">C++ Smart Pointer</div></div></a></div><div><a href="/2020/02/24/c++-stl/" title="C++ STL"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-24</div><div class="title">C++ STL</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">61</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">28</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hong-Ming-Gu-Cup-Online"><span class="toc-number">1.</span> <span class="toc-text">Hong Ming Gu Cup Online</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-Maybe-fun-game-%E5%8F%8C%E8%BE%B9%E5%8D%8F%E8%AE%AE1-0"><span class="toc-number">1.1.</span> <span class="toc-text">PWN - [Maybe_fun_game (双边协议1.0)]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-number">1.1.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reversing"><span class="toc-number">1.1.2.</span> <span class="toc-text">Reversing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main-function"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">main function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#munu-function"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">munu function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#enc-print-function"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">enc_print function</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/wp-maybe-fun-game/" title="Maybe fun game"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Maybe fun game"/></a><div class="content"><a class="title" href="/2021/04/02/wp-maybe-fun-game/" title="Maybe fun game">Maybe fun game</a><time datetime="2021-04-02T12:01:00.000Z" title="Created 2021-04-02 20:01:00">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/cve-2021-3156/" title="Heap-Based Buffer Overflow in Sudo"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Heap-Based Buffer Overflow in Sudo"/></a><div class="content"><a class="title" href="/2021/04/01/cve-2021-3156/" title="Heap-Based Buffer Overflow in Sudo">Heap-Based Buffer Overflow in Sudo</a><time datetime="2021-03-31T16:48:43.000Z" title="Created 2021-04-01 00:48:43">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/31/auto-pwn/" title="AUTO PWN"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AUTO PWN"/></a><div class="content"><a class="title" href="/2021/03/31/auto-pwn/" title="AUTO PWN">AUTO PWN</a><time datetime="2021-03-31T07:58:43.000Z" title="Created 2021-03-31 15:58:43">2021-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/31/fuzz-afl/" title="Binary fuzzing way of american fuzzy lop"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binary fuzzing way of american fuzzy lop"/></a><div class="content"><a class="title" href="/2021/03/31/fuzz-afl/" title="Binary fuzzing way of american fuzzy lop">Binary fuzzing way of american fuzzy lop</a><time datetime="2021-03-31T02:00:43.000Z" title="Created 2021-03-31 10:00:43">2021-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/30/v8-01/" title="V8 EXPLOIT ONE"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 EXPLOIT ONE"/></a><div class="content"><a class="title" href="/2021/03/30/v8-01/" title="V8 EXPLOIT ONE">V8 EXPLOIT ONE</a><time datetime="2021-03-30T11:28:43.000Z" title="Created 2021-03-30 19:28:43">2021-03-30</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>