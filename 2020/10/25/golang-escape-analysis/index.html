<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Golang 逃逸分析 | I0gan</title><meta name="keywords" content="golang"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Golang 逃逸学习golang的内存管理比较安全，不可直接操作内存，且在编译期间会进行数组越界检查，在运行的时候直接报错。 这篇文章就记录一下golang逃逸的一些相关原理吧。 golang逃逸分析wikiIn compiler optimization, escape analysis is a method for determining the dynamic scope of poin">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang 逃逸分析">
<meta property="og:url" content="http://blog.i0gan.cn/2020/10/25/golang-escape-analysis/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Golang 逃逸学习golang的内存管理比较安全，不可直接操作内存，且在编译期间会进行数组越界检查，在运行的时候直接报错。 这篇文章就记录一下golang逃逸的一些相关原理吧。 golang逃逸分析wikiIn compiler optimization, escape analysis is a method for determining the dynamic scope of poin">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2020-10-25T10:38:56.000Z">
<meta property="article:modified_time" content="2021-03-24T03:20:47.763Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="golang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2020/10/25/golang-escape-analysis/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-24 11:20:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">61</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">28</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Golang 逃逸分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-10-25T10:38:56.000Z" title="Created 2020-10-25 18:38:56">2020-10-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-03-24T03:20:47.763Z" title="Updated 2021-03-24 11:20:47">2021-03-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/golang/">golang</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Golang-逃逸学习"><a href="#Golang-逃逸学习" class="headerlink" title="Golang 逃逸学习"></a>Golang 逃逸学习</h1><p>golang的内存管理比较安全，不可直接操作内存，且在编译期间会进行数组越界检查，在运行的时候直接报错。</p>
<p>这篇文章就记录一下golang逃逸的一些相关原理吧。</p>
<h2 id="golang逃逸分析wiki"><a href="#golang逃逸分析wiki" class="headerlink" title="golang逃逸分析wiki"></a>golang逃逸分析wiki</h2><p>In compiler optimization, escape analysis is a method for determining the dynamic scope of pointers - where in the program a pointer can be accessed. It is related to pointer analysis and shape analysis.</p>
<p>When a variable (or an object) is allocated in a subroutine, a pointer to the variable can escape to other threads of execution, or to calling subroutines. If an implementation uses tail call optimization (usually required for functional languages), objects may also be seen as escaping to called subroutines. If a language supports first-class continuations (as do Scheme and Standard ML of New Jersey), portions of the call stack may also escape.</p>
<p>If a subroutine allocates an object and returns a pointer to it, the object can be accessed from undetermined places in the program — the pointer has “escaped”. Pointers can also escape if they are stored in global variables or other data structures that, in turn, escape the current procedure.</p>
<p>Escape analysis determines all the places where a pointer can be stored and whether the lifetime of the pointer can be proven to be restricted only to the current procedure and/or thread</p>
<h2 id="逃逸分析优势"><a href="#逃逸分析优势" class="headerlink" title="逃逸分析优势"></a>逃逸分析优势</h2><p>1 最大的好处应该是减少gc的压力，不逃逸的对象分配在栈上，当函数返回时就回收了资源，不需要gc标记清除。</p>
<p>2 因为逃逸分析完后可以确定哪些变量可以分配在栈上，栈的分配比堆快，性能好</p>
<p>3 同步消除，如果你定义的对象的方法上有同步锁，但在运行时，却只有一个线程在访问，此时逃逸分析后的机器码，会去掉同步锁运行。</p>
<h2 id="go与c-c-编译的程序区别"><a href="#go与c-c-编译的程序区别" class="headerlink" title="go与c/c++编译的程序区别"></a>go与c/c++编译的程序区别</h2><p>c/c++编译的程序，堆栈空间给的比较少，一般做大型项目的时候，数据量大了就把数据放在堆里储存，而go呢，内存机制有自己本身管理，采用堆栈迁移的方式把堆栈迁移到所开辟出来空间比较大的地方，所以golang 在运行完大多数对象都可以放在堆栈中。下面来跟踪一下golang程序的运行</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">hack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fake_flag <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span>
    p <span class="token operator">=</span> fake_flag
    p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> flag <span class="token punctuation">{</span>
        flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token function">hack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span></code></pre>
<p>以上编译为elf文件后是gdb进行调试</p>
<p>main_mian的地址为0x45DA40</p>
<p>程序刚开始运行时的堆栈就为操作系统所给的堆栈空间</p>
<p> <strong>RSP</strong>  0x7fffffffdf30 ◂— 0x1<br> <strong>RIP</strong>  0x45b9e0 (_rt0_amd64_linux) ◂— jmp   0x458580</p>
<p>下断点到main_main函数</p>
<p> <strong>RBP</strong>  0xc00003e7d0 ◂— 0x0<br> <strong>RSP</strong>  0xc00003e780 —▸ 0x42fb29 (runtime.main+521) ◂— mov   eax, dword ptr [rip + 0xcbbf5]<br> <strong>RIP</strong>  0x45da40 (main.main) ◂— mov   rcx, qword ptr fs:[0xfffffffffffffff8]</p>
<p>可以看到以上,rsp与rbp已经不再是0x7f开头的地址了而是进行了堆栈迁移</p>
<pre class=" language-text"><code class="language-text">pwndbg> vmmap 
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x45e000 r-xp    5e000 0      /home/logan/share/bytectf/leak/leak
          0x45e000           0x4c8000 r--p    6a000 5e000  /home/logan/share/bytectf/leak/leak
          0x4c8000           0x4cc000 rw-p     4000 c8000  /home/logan/share/bytectf/leak/leak
          0x4cc000           0x4fe000 rw-p    32000 0      [heap]
      0xc000000000       0xc004000000 rw-p  4000000 0      
    0x7fffd1328000     0x7fffd3699000 rw-p  2371000 0      
    0x7fffd3699000     0x7fffe3819000 ---p 10180000 0      
    0x7fffe3819000     0x7fffe381a000 rw-p     1000 0      
    0x7fffe381a000     0x7ffff56c9000 ---p 11eaf000 0      
    0x7ffff56c9000     0x7ffff56ca000 rw-p     1000 0      
    0x7ffff56ca000     0x7ffff7a9f000 ---p  23d5000 0      
    0x7ffff7a9f000     0x7ffff7aa0000 rw-p     1000 0      
    0x7ffff7aa0000     0x7ffff7f19000 ---p   479000 0      
    0x7ffff7f19000     0x7ffff7f1a000 rw-p     1000 0      
    0x7ffff7f1a000     0x7ffff7f99000 ---p    7f000 0      
    0x7ffff7f99000     0x7ffff7ff9000 rw-p    60000 0      
    0x7ffff7ff9000     0x7ffff7ffd000 r--p     4000 0      [vvar]
    0x7ffff7ffd000     0x7ffff7fff000 r-xp     2000 0      [vdso]
    0x7ffffffde000     0x7ffffffff000 rw-p    21000 0      [stack]
0xffffffffff600000 0xffffffffff601000 --xp     1000 0      [vsyscall]</code></pre>
<p>可以发现新的堆栈空间大小为0x4000000, 而操作系统所给的为0x21000, 所以golang的变量大部分都会优先储存在堆栈上，因为堆栈空间比较大，且内存管理比较简单。</p>
<h2 id="go的逃逸分析"><a href="#go的逃逸分析" class="headerlink" title="go的逃逸分析"></a>go的逃逸分析</h2><p>go在动态编译的时候进行逃逸分析，来决定一个对象放栈上还是放堆上，不逃逸的对象放栈上，可能逃逸的放堆上。</p>
<h3 id="开启逃逸分析日志"><a href="#开启逃逸分析日志" class="headerlink" title="开启逃逸分析日志"></a>开启逃逸分析日志</h3><p>在编译的时候参数加上<code>-gcflags &#39;-m&#39;</code>,为了不产生inline函数，一般都会加上<code>-l</code></p>
<p>也就是 <code>-gcflags &#39;-m -l&#39;</code></p>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">:=</span> <span class="token string">"Hello World"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>逃逸分析</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 1.go
# command-line-arguments
./1.go:6:13: ... argument does not escape
./1.go:6:13: s escapes to heap
Hello World</code></pre>
<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x S
    y <span class="token operator">:=</span> <span class="token operator">&amp;</span>x
    <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">identity</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">identity</span><span class="token punctuation">(</span>z <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token operator">*</span>S <span class="token punctuation">{</span>
    <span class="token keyword">return</span> z
<span class="token punctuation">}</span></code></pre>
<p>输出</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 2.go
# command-line-arguments
./2.go:11:15: leaking param: z to result ~r1 level=0</code></pre>
<p>x没有被引用，没有发生逃逸</p>
<h3 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x S
    <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token function">ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ref</span><span class="token punctuation">(</span>z S<span class="token punctuation">)</span> <span class="token operator">*</span>S <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>z
<span class="token punctuation">}</span></code></pre>
<p>输出</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 3.go             
# command-line-arguments
./3.go:10:10: moved to heap: z</code></pre>
<p>go进行值传递，而在调用ref后进行引用，避免内存错误，则会将z放在heap上。</p>
<h3 id="Example-4"><a href="#Example-4" class="headerlink" title="Example 4"></a>Example 4</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    M <span class="token operator">*</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> i <span class="token builtin">int</span> 
    <span class="token function">refStruct</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">refStruct</span><span class="token punctuation">(</span>y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>z S<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    z<span class="token punctuation">.</span>M <span class="token operator">=</span> <span class="token operator">&amp;</span>y
    <span class="token keyword">return</span> z 
<span class="token punctuation">}</span></code></pre>
<p>输出</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 4.go
# command-line-arguments
./4.go:12:16: moved to heap: y</code></pre>
<p>对y进行了值引用，则使y放在heap上</p>
<h3 id="Example-5"><a href="#Example-5" class="headerlink" title="Example 5"></a>Example 5</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    M <span class="token operator">*</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> i <span class="token builtin">int</span> 
    <span class="token function">refStruct</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">refStruct</span><span class="token punctuation">(</span>y <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>z S<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    z<span class="token punctuation">.</span>M <span class="token operator">=</span> y
    <span class="token keyword">return</span> z 
<span class="token punctuation">}</span></code></pre>
<p>输出</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 5.go
# command-line-arguments
./5.go:12:16: leaking param: y to result z level=0</code></pre>
<p>对原先堆栈里的数据进行引用，没有发生逃逸</p>
<h3 id="Example-6"><a href="#Example-6" class="headerlink" title="Example 6"></a>Example 6</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    M <span class="token operator">*</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> x S
    <span class="token keyword">var</span> i <span class="token builtin">int</span>
    <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ref</span><span class="token punctuation">(</span>y <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">,</span> z <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    z<span class="token punctuation">.</span>M <span class="token operator">=</span> y
<span class="token punctuation">}</span></code></pre>
<p>输出</p>
<pre class=" language-text"><code class="language-text">┌[logan☮arch]-(~/share/bytectf/leak)
└> go run -gcflags '-m -l' 6.go
# command-line-arguments
./6.go:13:10: leaking param: y
./6.go:13:18: z does not escape
./6.go:9:9: moved to heap: i</code></pre>
<p>z没有逃逸，有两个指针指向i变量，而i逃逸了，go的逃逸分析不知道z和i的关系，逃逸分析不知道参数y是z的一个成员，所以只能把i分配给堆管理</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是golang编译器通过分析代码会在编译时觉得哪些变量该分配在stack中，哪些变量该分配在heap中。</p>
<p>ref: <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/For-learning-Go-Tutorial/src-chapter13-01.0.md">https://www.bookstack.cn/read/For-learning-Go-Tutorial/src-chapter13-01.0.md</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2020/10/25/golang-escape-analysis/">http://blog.i0gan.cn/2020/10/25/golang-escape-analysis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/golang/">golang</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/29/new-heap-exploit/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">HEAP-2020-姿势学习</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/20/against_reverse/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">反逆向分析</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">61</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">28</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Golang-%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">Golang 逃逸学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#golang%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90wiki"><span class="toc-number">1.1.</span> <span class="toc-text">golang逃逸分析wiki</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90%E4%BC%98%E5%8A%BF"><span class="toc-number">1.2.</span> <span class="toc-text">逃逸分析优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E4%B8%8Ec-c-%E7%BC%96%E8%AF%91%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.</span> <span class="toc-text">go与c&#x2F;c++编译的程序区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%9A%84%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">go的逃逸分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.1.</span> <span class="toc-text">开启逃逸分析日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">Example 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-2"><span class="toc-number">1.4.3.</span> <span class="toc-text">Example 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">Example 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-4"><span class="toc-number">1.4.5.</span> <span class="toc-text">Example 4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-5"><span class="toc-number">1.4.6.</span> <span class="toc-text">Example 5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-6"><span class="toc-number">1.4.7.</span> <span class="toc-text">Example 6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/wp-hong-ming-gu/" title="The Writeup Of Hong Ming Gu Cup Online"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="The Writeup Of Hong Ming Gu Cup Online"/></a><div class="content"><a class="title" href="/2021/04/02/wp-hong-ming-gu/" title="The Writeup Of Hong Ming Gu Cup Online">The Writeup Of Hong Ming Gu Cup Online</a><time datetime="2021-04-02T12:01:00.000Z" title="Created 2021-04-02 20:01:00">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/cve-2021-3156/" title="Heap-Based Buffer Overflow in Sudo"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Heap-Based Buffer Overflow in Sudo"/></a><div class="content"><a class="title" href="/2021/04/01/cve-2021-3156/" title="Heap-Based Buffer Overflow in Sudo">Heap-Based Buffer Overflow in Sudo</a><time datetime="2021-03-31T16:48:43.000Z" title="Created 2021-04-01 00:48:43">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/31/auto-pwn/" title="AUTO PWN"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AUTO PWN"/></a><div class="content"><a class="title" href="/2021/03/31/auto-pwn/" title="AUTO PWN">AUTO PWN</a><time datetime="2021-03-31T07:58:43.000Z" title="Created 2021-03-31 15:58:43">2021-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/31/fuzz-afl/" title="Binary fuzzing way of american fuzzy lop"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Binary fuzzing way of american fuzzy lop"/></a><div class="content"><a class="title" href="/2021/03/31/fuzz-afl/" title="Binary fuzzing way of american fuzzy lop">Binary fuzzing way of american fuzzy lop</a><time datetime="2021-03-31T02:00:43.000Z" title="Created 2021-03-31 10:00:43">2021-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/30/v8-01/" title="V8 EXPLOIT ONE"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 EXPLOIT ONE"/></a><div class="content"><a class="title" href="/2021/03/30/v8-01/" title="V8 EXPLOIT ONE">V8 EXPLOIT ONE</a><time datetime="2021-03-30T11:28:43.000Z" title="Created 2021-03-30 19:28:43">2021-03-30</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>