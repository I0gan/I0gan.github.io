<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>kernel pwn knowledge 1 | I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later. Mainly refer to Linux Kernel Exploitation KernelThe kernel is also a program that manages the data I&#x2F;O r">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel pwn knowledge 1">
<meta property="og:url" content="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later. Mainly refer to Linux Kernel Exploitation KernelThe kernel is also a program that manages the data I&#x2F;O r">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/images/Kernel_Layout.svg">
<meta property="article:published_time" content="2020-09-14T12:26:47.000Z">
<meta property="article:modified_time" content="2020-09-14T12:58:40.000Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/images/Kernel_Layout.svg">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-kernel-pwn-knowledge-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/14/kernel-pwn-knowledge-1/" class="article-date">
  <time datetime="2020-09-14T12:26:47.000Z" itemprop="datePublished">2020-09-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      kernel pwn knowledge 1
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later.</p>
<p>Mainly refer to <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/kernel/ref/13_lecture.pdf">Linux Kernel Exploitation</a></p>
<h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><p>The kernel is also a program that manages the data I/O requirements issued by the software, escaping these requirements into instructions, and handing them over to the CPU and other components in the computer. The kernel is the most basic part of modern operating systems.</p>
<p><img src="/images/Kernel_Layout.svg" alt="Kernel_Layout"></p>
<p>The main function of the kernel is twofold:</p>
<ol>
<li>Control and interact with the hardware</li>
<li>Provide an environment in which the application can run</li>
</ol>
<p>Various functions including I/O, permission control, system call, process management, memory management, etc. can be attributed to the above two points.</p>
<p>It should be noted that the <strong>kernel crash usually causes a reboot</strong>.</p>
<h2 id="Ring-Model"><a href="#Ring-Model" class="headerlink" title="Ring Model"></a>Ring Model</h2><p>The intel CPU divides the privilege level of the CPU into four levels: Ring 0, Ring 1, Ring 2, Ring 3.</p>
<p>Ring0 is only used by the OS. All Ring 3 programs can be used. The inner ring can use the resources of the outer ring.</p>
<p>The Ring Model is used to improve system security. For example, a spyware as a user program running on Ring 3 will be blocked when the user is not notified, because the access hardware needs to use the Ring 1 reserved by the being driver. method.</p>
<p>Most modern operating systems use only Ring 0 and Ring 3.</p>
<h2 id="Loadable-Kernel-Modules-LKMs"><a href="#Loadable-Kernel-Modules-LKMs" class="headerlink" title="Loadable Kernel Modules(LKMs)"></a>Loadable Kernel Modules(LKMs)</h2><p>Loadable core modules (or directly called kernel modules) are like executable programs running in kernel space, including:</p>
<ul>
<li><p>Drivers</p>
</li>
<li><p>device driver</p>
</li>
<li><p>File system driver</p>
<ul>
<li>…</li>
</ul>
</li>
<li><p>kernel extension modules (modules)</p>
</li>
</ul>
<p>The file format of LKMs is the same as that of user mode. ELF under Linux, exe/dll under Windows, and MACH-O under mac, so we can use IDA and other tools to analyze kernel modules.</p>
<p>Modules can be compiled separately, but not separately. It is linked to the kernel as part of the kernel at run time, running in kernel space, unlike processes running on user controls.</p>
<p>Modules are often used to implement a file system, a driver, or other kernel-level functionality.</p>
<p>&gt; The Linux kernel provides a modular mechanism because it is itself a monolithic kernel. The advantage of a single core is that it is efficient because all the content is brought together, but the disadvantage is that the scalability and maintainability are relatively poor, and the module mechanism is to make up for this defect.</p>
<h3 id="Related-Instructions"><a href="#Related-Instructions" class="headerlink" title="Related Instructions"></a>Related Instructions</h3><ul>
<li><strong>insmod</strong>: Load the specified module into the kernel</li>
<li><strong>rmmod</strong>: Unload the specified module from the kernel</li>
<li><strong>lsmod</strong>: List the modules that have been loaded</li>
</ul>
<p>&gt; Most kernel vulnerability is also in LKM.</p>
<h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p>A system call is a program in which user space requests a service that requires higher privileges from the operating system kernel, such as IO operations or interprocess communication. The system call provides an interface between the user program and the operating system. Some library functions (such as scanf, puts, etc. IO related functions are actually the encapsulation (read and write) of the system call).</p>
<p>&gt; View 64-bit and 32-bit system calls in <em>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</em> and <em>/usr/include/x86_64-linux-gnu/asm/unistd_32.h</em> respectively number.</p>
<p>&gt; Also recommend a very useful website <a target="_blank" rel="noopener" href="https://syscalls.kernelgrok.com/">Linux Syscall Reference</a>, you can refer to the register meaning and source code of the 32-bit system call. Teachers are welcome to recommend 64-bit similar features.</p>
<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><p>Directly view the man page</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line"></span><br><span class="line">       ioctl - control device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line"></span><br><span class="line">       #include &lt;sys&#x2F;ioctl.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       int ioctl(int fd, unsigned long request, ...);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line"></span><br><span class="line">       The ioctl() system call manipulates the underlying device parameters of special</span><br><span class="line"></span><br><span class="line">       files.  In particular, many  operating  characteristics  of  character  special</span><br><span class="line"></span><br><span class="line">       files  (e.g., terminals) may be controlled with ioctl() requests.  The argument</span><br><span class="line"></span><br><span class="line">       fd must be an open file descriptor.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       The second argument is a device-dependent request code.  The third argument  is</span><br><span class="line"></span><br><span class="line">       an  untyped  pointer  to  memory.  It&#39;s traditionally char *argp (from the days</span><br><span class="line"></span><br><span class="line">       before void * was valid C), and will be so named for this discussion.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       An ioctl() request has encoded in it whether the argument is an in parameter or</span><br><span class="line"></span><br><span class="line">       out  parameter, and the size of the argument argp in bytes.  Macros and defines</span><br><span class="line"></span><br><span class="line">       used in specifying an ioctl() request are located in the file &lt;sys&#x2F;ioctl.h&gt;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>It can be seen that ioctl is also a system call for communicating with devices.</p>
<p>The first argument to <code>int ioctl(int fd, unsigned long request, ...)</code> is the [file descriptor] returned by the open device [open](<a target="_blank" rel="noopener" href="http://m4x.fun/post/play-with-file">http://m4x.fun/post/play-with-file</a> -descriptor-1/), the second parameter is the user program&#39;s control command for the device, and the latter parameter is some supplementary parameter, which is related to the device.</p>
<p>&gt; Reasons for communicating with ioctl:</p>
<p>&gt; The operating system provides kernel access to system calls to standard external devices, as most hardware devices can only be addressed directly within kernel space, but when accessing non-standard hardware devices these system calls are not appropriate, and sometimes user mode may need to be directly Access the device.</p>
<p>&gt; For example, a system administrator might want to modify the configuration of the NIC. Modern operating systems provide support for a wide variety of devices, and some devices may not be considered by the kernel designer, thus making it impossible to provide such a system call to use the device.</p>
<p>&gt; To solve this problem, the kernel is designed to be extensible, and a module called device driver can be added. The driver code allows it to run in kernel space and directly address the device. An Ioctl interface is a separate system call through which user space can communicate with device drivers. The device-driven request is an Ioctl call with the device and request number as parameters, so the kernel allows user space to access the device driver and access the device without knowing the specific device details, and does not require a lot of different devices. System call.</p>
<h2 id="Status-Switch"><a href="#Status-Switch" class="headerlink" title="Status Switch"></a>Status Switch</h2><h3 id="user-space-to-kernel-space"><a href="#user-space-to-kernel-space" class="headerlink" title="user space to kernel space"></a>user space to kernel space</h3><p>When a &#39;system call&#39;, <code>generate exception</code>, <code>peripheral generate interrupt</code>, etc. event occurs, the user mode to kernel mode switch occurs. The specific process is:</p>
<ol>
<li>Switch the GS segment register with <code>swapgs</code> to exchange the GS register value with the value of a specific location. The purpose is to save the GS value and use the value of this location as the GS value when the kernel is executed.</li>
<li>Record the current top of the stack (the top of the user space stack) in the CPU exclusive variable area, and put the top of the kernel stack recorded in the CPU exclusive area into rsp/esp.</li>
<li>Save each register value by push. The specific <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S">code</a> is as follows:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">	 ENTRY(entry_SYSCALL_64)</span><br><span class="line"></span><br><span class="line">&#x2F;* SWAPGS_UNSAFE_STACK is a macro, x86 is directly defined as the swapgs command *&#x2F;</span><br><span class="line">​	 SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">&#x2F;* Save the stack value and set the kernel stack *&#x2F;</span><br><span class="line">​	 movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"></span><br><span class="line">	 movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">&#x2F;* Save the register value by push to form a pt_regs structure*&#x2F;</span><br><span class="line">​	&#x2F;* Construct struct pt_regs on stack *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  $__USER_DS      &#x2F;* pt_regs-&gt;ss *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  PER_CPU_VAR(rsp_scratch)  &#x2F;* pt_regs-&gt;sp *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %r11             &#x2F;* pt_regs-&gt;flags *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  $__USER_CS      &#x2F;* pt_regs-&gt;cs *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %rcx             &#x2F;* pt_regs-&gt;ip *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %rax             &#x2F;* pt_regs-&gt;orig_ax *&#x2F;</span><br><span class="line"></span><br><span class="line">pushq% rdi &#x2F; * pt_regs-&gt; at * &#x2F;</span><br><span class="line">pushq% rsi &#x2F; * pt_regs-&gt; and * &#x2F;</span><br><span class="line">​	pushq  %rdx             &#x2F;* pt_regs-&gt;dx *&#x2F;</span><br><span class="line">Pushq %rcx tuichu &#x2F;* pt_regs-&gt;cx *&#x2F;</span><br><span class="line">​	pushq  $-ENOSYS        &#x2F;* pt_regs-&gt;ax *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  %r8              &#x2F;* pt_regs-&gt;r8 *&#x2F;</span><br><span class="line"></span><br><span class="line">pushq% r9 &#x2F; * pt_regs-&gt; r9 * &#x2F;</span><br><span class="line">​	pushq  %r10             &#x2F;* pt_regs-&gt;r10 *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  %r11             &#x2F;* pt_regs-&gt;r11 *&#x2F;</span><br><span class="line">	</span><br><span class="line">	sub $(6*8), %rsp      &#x2F;* pt_regs-&gt;bp, bx, r12-15 not saved *&#x2F;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Determine if it is x32_abi by the assembly instruction.</li>
<li>Continue to execute the system call by jumping to the corresponding location of the global variable <code>sys_call_table</code> by the system call number.</li>
</ol>
<h3 id="kernel-space-to-user-space"><a href="#kernel-space-to-user-space" class="headerlink" title="kernel space to user space"></a>kernel space to user space</h3><p>When exiting, the process is as follows:</p>
<ol>
<li>Restore GS value by <code>swapgs</code></li>
<li>Resume to the user control via <code>sysretq</code> or <code>iretq</code> to continue execution. If you use <code>iretq</code> you also need to give some information about the user space (CS, eflags/rflags, esp/rsp, etc.)</li>
</ol>
<h2 id="structure-I-think"><a href="#structure-I-think" class="headerlink" title="structure I think"></a>structure I think</h2><p>As mentioned before, the kernel records the permissions of the process. More specifically, it is recorded by the cred structure. Each process has a cred structure. This structure saves the permissions of the process (uid, gid, etc.). Can modify the cred of a process, then modify the permissions of this process.</p>
<p><a target="_blank" rel="noopener" href="https://code.woboq.org/linux/linux/include/linux/cred.h.html#cred">source code</a> as follows:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">​	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">​	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">but_t</span> fsuid; / * UID <span class="keyword">for</span> VFS ops * /</span><br><span class="line">​	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">​	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line"></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Kernel-state-function"><a href="#Kernel-state-function" class="headerlink" title="Kernel state function"></a>Kernel state function</h2><p>Kernel state functions have some changes compared to user state library functions</p>
<ul>
<li><p>printf() -&gt; <strong>printk()</strong>, but note that printk() does not necessarily display the content on the terminal, but it must be in the kernel buffer. You can view the effect via <code>dmesg</code></p>
</li>
<li><p>memcpy()        -&gt;        <strong>copy_from_user()/copy_to_user()</strong></p>
</li>
<li><p>copy_from_user() implements transferring user space data to kernel space</p>
</li>
<li><p>copy_to_user() implements transferring kernel space data to user space</p>
</li>
<li><p>malloc() -&gt; <strong>kmalloc()</strong>, kernel-mode memory allocation function, similar to malloc(), but using the <code>slab/slub allocator</code></p>
</li>
<li><p>free()        -&gt;        **kfree()**，同 kmalloc()</p>
</li>
</ul>
<p>Also note that the <code>kernel manages the process, so the kernel also records the permissions of the process</code>. There are two functions in the kernel that can easily change permissions:</p>
<ul>
<li><p><strong>int commit_creds(struct cred *new)</strong></p>
</li>
<li><p><strong>struct cred* prepare_kernel_cred(struct task_struct* daemon)</strong></p>
</li>
</ul>
<p>As you can see from the function name, execute <code>commit_creds(prepare_kernel_cred(0))</code> to get root privileges (root&#39;s uid, gid is 0)</p>
<p>Executing <code>commit_creds(prepare_kernel_cred(0))</code> is also the most commonly used method of lifting. The addresses of both functions can be viewed in <code>/proc/kallsyms</code> (the older kernel version is <code>/proc/ksyms</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post sudo grep commit_creds /proc/kallsyms </span><br><span class="line"></span><br><span class="line">[sudo] m4x password:</span><br><span class="line">ffffffffbb6af9e0 T commit_creds</span><br><span class="line"></span><br><span class="line">ffffffffbc7cb3d0 r __ksymtab_commit_creds</span><br><span class="line"></span><br><span class="line">ffffffffbc7f06fe r __kstrtab_commit_creds</span><br><span class="line"></span><br><span class="line">post sudo grep prepare_kernel_cred /proc/kallsyms</span><br><span class="line"></span><br><span class="line">ffffffffbb6afd90 T prepare_kernel_cred</span><br><span class="line"></span><br><span class="line">ffffffffbc7d4f20 r __ksymtab_prepare_kernel_cred</span><br><span class="line"></span><br><span class="line">ffffffffbc7f06b7 r __kstrtab_prepare_kernel_cred</span><br></pre></td></tr></table></figure>



<p>&gt; In general, the contents of /proc/kallsyms require root privileges to view</p>
<h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>&gt; canary, dep, PIE, RELRO and other protections are the same as user principles</p>
<ul>
<li>smep: Supervisor Mode Execution Protection, when the processor is in <code>ring0</code> mode, executing the <code>userspace</code> code will trigger a page fault. (This protection is called <code>PXN</code> in arm)</li>
</ul>
<ul>
<li>smap: Superivisor Mode Access Protection, similar to smep, usually when accessing data.</li>
</ul>
<ul>
<li>mmap_min_addr:</li>
</ul>
<h2 id="CTF-kernel-pwn-Related"><a href="#CTF-kernel-pwn-Related" class="headerlink" title="CTF kernel pwn Related"></a>CTF kernel pwn Related</h2><p>Generally given the following three documents</p>
<ol>
<li><p>boot.sh: a script for starting the shell of the kernel, mostly using qemu, the protection measures are related to the different startup parameters of qemu</p>
</li>
<li><p>bzImage: kernel binary</p>
</li>
<li><p>rootfs.cpio: file system image</p>
</li>
</ol>
<p>such as:<br>​    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CISCN2017_babydriver [master]] ls</span><br><span class="line">babydriver.tar</span><br><span class="line">CISCN2017_babydriver [master ●] x baby driver.tar</span><br><span class="line">​	boot.sh</span><br><span class="line"></span><br><span class="line">	bzImage</span><br><span class="line">	</span><br><span class="line">	rootfs.cpio</span><br><span class="line"></span><br><span class="line">CISCN2017_babydriver [master]] ls</span><br><span class="line">​	babydriver.tar  boot.sh  bzImage  rootfs.cpio</span><br><span class="line"></span><br><span class="line">	CISCN2017_babydriver [master●] file bzImage</span><br><span class="line">	</span><br><span class="line">	bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) <span class="comment">#1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0x6, Normal VGA</span></span><br><span class="line">	</span><br><span class="line">	CISCN2017_babydriver [master●] file rootfs.cpio</span><br><span class="line">	</span><br><span class="line">	rootfs.cpio: gzip compressed data, last modified: Tue Jul  4 08:39:15 2017, max compression, from Unix, original size 2844672</span><br><span class="line">	CISCN2017_babydriver [master●] file boot.sh</span><br><span class="line">	</span><br><span class="line">	boot.sh: Bourne-Again shell script, ASCII text executable</span><br><span class="line"></span><br><span class="line">CISCN2017_babydriver [master ●] bat boot.sh</span><br><span class="line">​	───────┬─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">	       │ File: boot.sh</span><br><span class="line">	</span><br><span class="line">	───────┼─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">	</span><br><span class="line">	   1   │ <span class="comment">#!/bin/bash</span></span><br><span class="line">	</span><br><span class="line">	   2   │ </span><br><span class="line">	</span><br><span class="line">	   3   │ qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">&#x27;console=ttyS0 ro</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	       │ ot=/dev/ram oops=panic panic=1&#x27;</span> -enable-kvm -monitor /dev/null -m 64M --nographi</span><br><span class="line">	</span><br><span class="line">	       │ c  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br><span class="line">	</span><br><span class="line">	───────┴─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Explain the parameters that qemu starts:<br>​    </p>
<ul>
<li>-initrd rootfs.cpio, using rootfs.cpio as the kernel-initiated file system</li>
<li>-kernel bzImage, using bzImage as the kernel image</li>
<li>-cpu kvm64, +smep, set the security options for the CPU, here smep is enabled</li>
<li>-m 64M, set the virtual RAM to 64M, the default is 128M<br>Other options can be viewed with –help.</li>
</ul>
<ol start="4">
<li>After writing the exploit locally, you can save the compiled binary file to the remote directory by base64 encoding, etc., and then get the flag.</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/kernel">Https://en.wikipedia.org/wiki/kernel</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Classified">https://en.wikipedia.org/wiki/Classified</a> protection domain</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Ioctl">https://zh.wikipedia.org/wiki/Ioctl</a></p>
<p><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/system/54263.html">http://www.freebuf.com/articles/system/54263.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zqixiao_09/article/details/50839042">https://blog.csdn.net/zqixiao_09/article/details/50839042</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/53679">https://yq.aliyun.com/articles/53679</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/" data-id="ckhemv806000iwdcm232phdrg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/15/wp-babydriver/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          wp baby driver
        
      </div>
    </a>
  
  
    <a href="/2020/09/13/kernel-pwn-env/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">kernel pwn环境搭建</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>