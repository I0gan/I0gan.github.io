<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>kernel pwn knowledge 1 | I0gan</title><meta name="keywords" content="kernel"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later. Mainly refer to Linux Kernel Exploitation KernelThe kernel is also a program that manages the data I&#x2F;O r">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel pwn knowledge 1">
<meta property="og:url" content="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later. Mainly refer to Linux Kernel Exploitation KernelThe kernel is also a program that manages the data I&#x2F;O r">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2020-09-14T12:26:47.000Z">
<meta property="article:modified_time" content="2020-09-14T12:58:40.000Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-09-14 20:58:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">65</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">kernel pwn knowledge 1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-09-14T12:26:47.000Z" title="Created 2020-09-14 20:26:47">2020-09-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-09-14T12:58:40.000Z" title="Updated 2020-09-14 20:58:40">2020-09-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later.</p>
<p>Mainly refer to <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/kernel/ref/13_lecture.pdf">Linux Kernel Exploitation</a></p>
<h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><p>The kernel is also a program that manages the data I/O requirements issued by the software, escaping these requirements into instructions, and handing them over to the CPU and other components in the computer. The kernel is the most basic part of modern operating systems.</p>
<p><img src="/images/Kernel_Layout.svg" alt="Kernel_Layout"></p>
<p>The main function of the kernel is twofold:</p>
<ol>
<li>Control and interact with the hardware</li>
<li>Provide an environment in which the application can run</li>
</ol>
<p>Various functions including I/O, permission control, system call, process management, memory management, etc. can be attributed to the above two points.</p>
<p>It should be noted that the <strong>kernel crash usually causes a reboot</strong>.</p>
<h2 id="Ring-Model"><a href="#Ring-Model" class="headerlink" title="Ring Model"></a>Ring Model</h2><p>The intel CPU divides the privilege level of the CPU into four levels: Ring 0, Ring 1, Ring 2, Ring 3.</p>
<p>Ring0 is only used by the OS. All Ring 3 programs can be used. The inner ring can use the resources of the outer ring.</p>
<p>The Ring Model is used to improve system security. For example, a spyware as a user program running on Ring 3 will be blocked when the user is not notified, because the access hardware needs to use the Ring 1 reserved by the being driver. method.</p>
<p>Most modern operating systems use only Ring 0 and Ring 3.</p>
<h2 id="Loadable-Kernel-Modules-LKMs"><a href="#Loadable-Kernel-Modules-LKMs" class="headerlink" title="Loadable Kernel Modules(LKMs)"></a>Loadable Kernel Modules(LKMs)</h2><p>Loadable core modules (or directly called kernel modules) are like executable programs running in kernel space, including:</p>
<ul>
<li><p>Drivers</p>
</li>
<li><p>device driver</p>
</li>
<li><p>File system driver</p>
<ul>
<li>…</li>
</ul>
</li>
<li><p>kernel extension modules (modules)</p>
</li>
</ul>
<p>The file format of LKMs is the same as that of user mode. ELF under Linux, exe/dll under Windows, and MACH-O under mac, so we can use IDA and other tools to analyze kernel modules.</p>
<p>Modules can be compiled separately, but not separately. It is linked to the kernel as part of the kernel at run time, running in kernel space, unlike processes running on user controls.</p>
<p>Modules are often used to implement a file system, a driver, or other kernel-level functionality.</p>
<p>&gt; The Linux kernel provides a modular mechanism because it is itself a monolithic kernel. The advantage of a single core is that it is efficient because all the content is brought together, but the disadvantage is that the scalability and maintainability are relatively poor, and the module mechanism is to make up for this defect.</p>
<h3 id="Related-Instructions"><a href="#Related-Instructions" class="headerlink" title="Related Instructions"></a>Related Instructions</h3><ul>
<li><strong>insmod</strong>: Load the specified module into the kernel</li>
<li><strong>rmmod</strong>: Unload the specified module from the kernel</li>
<li><strong>lsmod</strong>: List the modules that have been loaded</li>
</ul>
<p>&gt; Most kernel vulnerability is also in LKM.</p>
<h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p>A system call is a program in which user space requests a service that requires higher privileges from the operating system kernel, such as IO operations or interprocess communication. The system call provides an interface between the user program and the operating system. Some library functions (such as scanf, puts, etc. IO related functions are actually the encapsulation (read and write) of the system call).</p>
<p>&gt; View 64-bit and 32-bit system calls in <em>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</em> and <em>/usr/include/x86_64-linux-gnu/asm/unistd_32.h</em> respectively number.</p>
<p>&gt; Also recommend a very useful website <a target="_blank" rel="noopener" href="https://syscalls.kernelgrok.com/">Linux Syscall Reference</a>, you can refer to the register meaning and source code of the 32-bit system call. Teachers are welcome to recommend 64-bit similar features.</p>
<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><p>Directly view the man page</p>
<pre><code>NAME

       ioctl - control device



SYNOPSIS

       #include &lt;sys/ioctl.h&gt;



       int ioctl(int fd, unsigned long request, ...);



DESCRIPTION

       The ioctl() system call manipulates the underlying device parameters of special

       files.  In particular, many  operating  characteristics  of  character  special

       files  (e.g., terminals) may be controlled with ioctl() requests.  The argument

       fd must be an open file descriptor.



       The second argument is a device-dependent request code.  The third argument  is

       an  untyped  pointer  to  memory.  It&#39;s traditionally char *argp (from the days

       before void * was valid C), and will be so named for this discussion.



       An ioctl() request has encoded in it whether the argument is an in parameter or

       out  parameter, and the size of the argument argp in bytes.  Macros and defines

       used in specifying an ioctl() request are located in the file &lt;sys/ioctl.h&gt;.
</code></pre>
<p>It can be seen that ioctl is also a system call for communicating with devices.</p>
<p>The first argument to <code>int ioctl(int fd, unsigned long request, ...)</code> is the [file descriptor] returned by the open device [open](<a target="_blank" rel="noopener" href="http://m4x.fun/post/play-with-file">http://m4x.fun/post/play-with-file</a> -descriptor-1/), the second parameter is the user program&#39;s control command for the device, and the latter parameter is some supplementary parameter, which is related to the device.</p>
<p>&gt; Reasons for communicating with ioctl:</p>
<p>&gt; The operating system provides kernel access to system calls to standard external devices, as most hardware devices can only be addressed directly within kernel space, but when accessing non-standard hardware devices these system calls are not appropriate, and sometimes user mode may need to be directly Access the device.</p>
<p>&gt; For example, a system administrator might want to modify the configuration of the NIC. Modern operating systems provide support for a wide variety of devices, and some devices may not be considered by the kernel designer, thus making it impossible to provide such a system call to use the device.</p>
<p>&gt; To solve this problem, the kernel is designed to be extensible, and a module called device driver can be added. The driver code allows it to run in kernel space and directly address the device. An Ioctl interface is a separate system call through which user space can communicate with device drivers. The device-driven request is an Ioctl call with the device and request number as parameters, so the kernel allows user space to access the device driver and access the device without knowing the specific device details, and does not require a lot of different devices. System call.</p>
<h2 id="Status-Switch"><a href="#Status-Switch" class="headerlink" title="Status Switch"></a>Status Switch</h2><h3 id="user-space-to-kernel-space"><a href="#user-space-to-kernel-space" class="headerlink" title="user space to kernel space"></a>user space to kernel space</h3><p>When a &#39;system call&#39;, <code>generate exception</code>, <code>peripheral generate interrupt</code>, etc. event occurs, the user mode to kernel mode switch occurs. The specific process is:</p>
<ol>
<li>Switch the GS segment register with <code>swapgs</code> to exchange the GS register value with the value of a specific location. The purpose is to save the GS value and use the value of this location as the GS value when the kernel is executed.</li>
<li>Record the current top of the stack (the top of the user space stack) in the CPU exclusive variable area, and put the top of the kernel stack recorded in the CPU exclusive area into rsp/esp.</li>
<li>Save each register value by push. The specific <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S">code</a> is as follows:</li>
</ol>
<pre class=" language-asm"><code class="language-asm">     ENTRY(entry_SYSCALL_64)

/* SWAPGS_UNSAFE_STACK is a macro, x86 is directly defined as the swapgs command */
​     SWAPGS_UNSAFE_STACK

​    

/* Save the stack value and set the kernel stack */
​     movq %rsp, PER_CPU_VAR(rsp_scratch)

     movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp


​    

​    

/* Save the register value by push to form a pt_regs structure*/
​    /* Construct struct pt_regs on stack */

    pushq  $__USER_DS      /* pt_regs->ss */

    pushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs->sp */

    pushq  %r11             /* pt_regs->flags */

    pushq  $__USER_CS      /* pt_regs->cs */

    pushq  %rcx             /* pt_regs->ip */

    pushq  %rax             /* pt_regs->orig_ax */

pushq% rdi / * pt_regs-&gt; at * /
pushq% rsi / * pt_regs-&gt; and * /
​    pushq  %rdx             /* pt_regs->dx */
Pushq %rcx tuichu /* pt_regs-&gt;cx */
​    pushq  $-ENOSYS        /* pt_regs->ax */

    pushq  %r8              /* pt_regs->r8 */

pushq% r9 / * pt_regs-&gt; r9 * /
​    pushq  %r10             /* pt_regs->r10 */

    pushq  %r11             /* pt_regs->r11 */

    sub $(6*8), %rsp      /* pt_regs->bp, bx, r12-15 not saved */
</code></pre>
<ol start="4">
<li>Determine if it is x32_abi by the assembly instruction.</li>
<li>Continue to execute the system call by jumping to the corresponding location of the global variable <code>sys_call_table</code> by the system call number.</li>
</ol>
<h3 id="kernel-space-to-user-space"><a href="#kernel-space-to-user-space" class="headerlink" title="kernel space to user space"></a>kernel space to user space</h3><p>When exiting, the process is as follows:</p>
<ol>
<li>Restore GS value by <code>swapgs</code></li>
<li>Resume to the user control via <code>sysretq</code> or <code>iretq</code> to continue execution. If you use <code>iretq</code> you also need to give some information about the user space (CS, eflags/rflags, esp/rsp, etc.)</li>
</ol>
<h2 id="structure-I-think"><a href="#structure-I-think" class="headerlink" title="structure I think"></a>structure I think</h2><p>As mentioned before, the kernel records the permissions of the process. More specifically, it is recorded by the cred structure. Each process has a cred structure. This structure saves the permissions of the process (uid, gid, etc.). Can modify the cred of a process, then modify the permissions of this process.</p>
<p><a target="_blank" rel="noopener" href="https://code.woboq.org/linux/linux/include/linux/cred.h.html#cred">source code</a> as follows:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> cred <span class="token punctuation">{</span>
​    atomic_t    usage<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span>

    atomic_t    subscribers<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of processes subscribed */</span>

    <span class="token keyword">void</span>        <span class="token operator">*</span>put_addr<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span>    magic<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC    0x43736564</span>

<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC_DEAD    0x44656144</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
​    kuid_t        uid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* real UID of the task */</span>

    kgid_t        gid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* real GID of the task */</span>

    kuid_t        suid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* saved UID of the task */</span>

    kgid_t        sgid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* saved GID of the task */</span>

    kuid_t        euid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* effective UID of the task */</span>

    kgid_t        egid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* effective GID of the task */</span>

but_t fsuid<span class="token punctuation">;</span> <span class="token operator">/</span> <span class="token operator">*</span> UID <span class="token keyword">for</span> VFS ops <span class="token operator">*</span> <span class="token operator">/</span>
​    kgid_t        fsgid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* GID for VFS ops */</span>

    <span class="token keyword">unsigned</span>    securebits<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* SUID-less security management */</span>

    kernel_cap_t    cap_inheritable<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* caps our children can inherit */</span>

    kernel_cap_t    cap_permitted<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* caps we're permitted */</span>

    kernel_cap_t    cap_effective<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* caps we can actually use */</span>

    kernel_cap_t    cap_bset<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* capability bounding set */</span>

    kernel_cap_t    cap_ambient<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Ambient capability set */</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_KEYS</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    jit_keyring<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* default keyring to attach requested

                     * keys to */</span>

    <span class="token keyword">struct</span> key __rcu <span class="token operator">*</span>session_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring inherited over fork */</span>

    <span class="token keyword">struct</span> key    <span class="token operator">*</span>process_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring private to this process */</span>

    <span class="token keyword">struct</span> key    <span class="token operator">*</span>thread_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring private to this thread */</span>

    <span class="token keyword">struct</span> key    <span class="token operator">*</span>request_key_auth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* assumed request_key authority */</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SECURITY</span>

    <span class="token keyword">void</span>        <span class="token operator">*</span>security<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* subjective LSM security */</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
​    <span class="token keyword">struct</span> user_struct <span class="token operator">*</span>user<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* real user ID subscription */</span>

    <span class="token keyword">struct</span> user_namespace <span class="token operator">*</span>user_ns<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* user_ns the caps and keyrings are relative to. */</span>

    <span class="token keyword">struct</span> group_info <span class="token operator">*</span>group_info<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* supplementary groups for euid/fsgid */</span>

    <span class="token keyword">struct</span> rcu_head    rcu<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* RCU deletion hook */</span>

<span class="token punctuation">}</span> __randomize_layout<span class="token punctuation">;</span>
</code></pre>
<h2 id="Kernel-state-function"><a href="#Kernel-state-function" class="headerlink" title="Kernel state function"></a>Kernel state function</h2><p>Kernel state functions have some changes compared to user state library functions</p>
<ul>
<li><p>printf() -&gt; <strong>printk()</strong>, but note that printk() does not necessarily display the content on the terminal, but it must be in the kernel buffer. You can view the effect via <code>dmesg</code></p>
</li>
<li><p>memcpy()        -&gt;        <strong>copy_from_user()/copy_to_user()</strong></p>
</li>
<li><p>copy_from_user() implements transferring user space data to kernel space</p>
</li>
<li><p>copy_to_user() implements transferring kernel space data to user space</p>
</li>
<li><p>malloc() -&gt; <strong>kmalloc()</strong>, kernel-mode memory allocation function, similar to malloc(), but using the <code>slab/slub allocator</code></p>
</li>
<li><p>free()        -&gt;        **kfree()**，同 kmalloc()</p>
</li>
</ul>
<p>Also note that the <code>kernel manages the process, so the kernel also records the permissions of the process</code>. There are two functions in the kernel that can easily change permissions:</p>
<ul>
<li><p><strong>int commit_creds(struct cred *new)</strong></p>
</li>
<li><p><strong>struct cred* prepare_kernel_cred(struct task_struct* daemon)</strong></p>
</li>
</ul>
<p>As you can see from the function name, execute <code>commit_creds(prepare_kernel_cred(0))</code> to get root privileges (root&#39;s uid, gid is 0)</p>
<p>Executing <code>commit_creds(prepare_kernel_cred(0))</code> is also the most commonly used method of lifting. The addresses of both functions can be viewed in <code>/proc/kallsyms</code> (the older kernel version is <code>/proc/ksyms</code>.</p>
<pre class=" language-bash"><code class="language-bash">
post <span class="token function">sudo</span> <span class="token function">grep</span> commit_creds /proc/kallsyms 

<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> m4x password:
ffffffffbb6af9e0 T commit_creds

ffffffffbc7cb3d0 r __ksymtab_commit_creds

ffffffffbc7f06fe r __kstrtab_commit_creds

post <span class="token function">sudo</span> <span class="token function">grep</span> prepare_kernel_cred /proc/kallsyms

ffffffffbb6afd90 T prepare_kernel_cred

ffffffffbc7d4f20 r __ksymtab_prepare_kernel_cred

ffffffffbc7f06b7 r __kstrtab_prepare_kernel_cred</code></pre>
<p>&gt; In general, the contents of /proc/kallsyms require root privileges to view</p>
<h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>&gt; canary, dep, PIE, RELRO and other protections are the same as user principles</p>
<ul>
<li>smep: Supervisor Mode Execution Protection, when the processor is in <code>ring0</code> mode, executing the <code>userspace</code> code will trigger a page fault. (This protection is called <code>PXN</code> in arm)</li>
</ul>
<ul>
<li>smap: Superivisor Mode Access Protection, similar to smep, usually when accessing data.</li>
</ul>
<ul>
<li>mmap_min_addr:</li>
</ul>
<h2 id="CTF-kernel-pwn-Related"><a href="#CTF-kernel-pwn-Related" class="headerlink" title="CTF kernel pwn Related"></a>CTF kernel pwn Related</h2><p>Generally given the following three documents</p>
<ol>
<li><p>boot.sh: a script for starting the shell of the kernel, mostly using qemu, the protection measures are related to the different startup parameters of qemu</p>
</li>
<li><p>bzImage: kernel binary</p>
</li>
<li><p>rootfs.cpio: file system image</p>
</li>
</ol>
<p>such as:<br>​    </p>
<pre class=" language-bash"><code class="language-bash">
CISCN2017_babydriver <span class="token punctuation">[</span>master<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token function">ls</span>
babydriver.tar
CISCN2017_babydriver <span class="token punctuation">[</span>master ●<span class="token punctuation">]</span> x baby driver.tar
​    boot.sh

    bzImage

    rootfs.cpio

CISCN2017_babydriver <span class="token punctuation">[</span>master<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token function">ls</span>
​    babydriver.tar  boot.sh  bzImage  rootfs.cpio

    CISCN2017_babydriver <span class="token punctuation">[</span>master●<span class="token punctuation">]</span> <span class="token function">file</span> bzImage

    bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 <span class="token punctuation">(</span>atum@ubuntu<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0x6, Normal VGA</span>

    CISCN2017_babydriver <span class="token punctuation">[</span>master●<span class="token punctuation">]</span> <span class="token function">file</span> rootfs.cpio

    rootfs.cpio: <span class="token function">gzip</span> compressed data, last modified: Tue Jul  4 08:39:15 2017, max compression, from Unix, original size 2844672
    CISCN2017_babydriver <span class="token punctuation">[</span>master●<span class="token punctuation">]</span> <span class="token function">file</span> boot.sh

    boot.sh: Bourne-Again shell script, ASCII text executable

CISCN2017_babydriver <span class="token punctuation">[</span>master ●<span class="token punctuation">]</span> bat boot.sh
​    ───────┬─────────────────────────────────────────────────────────────────────────────────

           │ File: boot.sh

    ───────┼─────────────────────────────────────────────────────────────────────────────────

       1   │ <span class="token comment" spellcheck="true">#!/bin/bash</span>

       2   │ 

       3   │ qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="token string">'console=ttyS0 ro

           │ ot=/dev/ram oops=panic panic=1'</span> -enable-kvm -monitor /dev/null -m 64M --nographi

           │ c  -smp cores<span class="token operator">=</span>1,threads<span class="token operator">=</span>1 -cpu kvm64,+smep

    ───────┴─────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>Explain the parameters that qemu starts:<br>​    </p>
<ul>
<li>-initrd rootfs.cpio, using rootfs.cpio as the kernel-initiated file system</li>
<li>-kernel bzImage, using bzImage as the kernel image</li>
<li>-cpu kvm64, +smep, set the security options for the CPU, here smep is enabled</li>
<li>-m 64M, set the virtual RAM to 64M, the default is 128M<br>Other options can be viewed with –help.</li>
</ul>
<ol start="4">
<li>After writing the exploit locally, you can save the compiled binary file to the remote directory by base64 encoding, etc., and then get the flag.</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/kernel">Https://en.wikipedia.org/wiki/kernel</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Classified">https://en.wikipedia.org/wiki/Classified</a> protection domain</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Ioctl">https://zh.wikipedia.org/wiki/Ioctl</a></p>
<p><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/system/54263.html">http://www.freebuf.com/articles/system/54263.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zqixiao_09/article/details/50839042">https://blog.csdn.net/zqixiao_09/article/details/50839042</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/53679">https://yq.aliyun.com/articles/53679</a></p>
<pre><code></code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/">http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kernel/">kernel</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/15/wp-babydriver/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">wp baby driver</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/13/kernel-pwn-env/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">kernel pwn环境搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/09/13/kernel-pwn-env/" title="kernel pwn环境搭建"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-13</div><div class="title">kernel pwn环境搭建</div></div></a></div><div><a href="/2020/11/21/wp-qwb-2018-core/" title="强网杯 2018 core"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-21</div><div class="title">强网杯 2018 core</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">65</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel"><span class="toc-number">1.</span> <span class="toc-text">Kernel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ring-Model"><span class="toc-number">2.</span> <span class="toc-text">Ring Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loadable-Kernel-Modules-LKMs"><span class="toc-number">3.</span> <span class="toc-text">Loadable Kernel Modules(LKMs)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Related-Instructions"><span class="toc-number">3.1.</span> <span class="toc-text">Related Instructions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#syscall"><span class="toc-number">4.</span> <span class="toc-text">syscall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ioctl"><span class="toc-number">5.</span> <span class="toc-text">ioctl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Status-Switch"><span class="toc-number">6.</span> <span class="toc-text">Status Switch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user-space-to-kernel-space"><span class="toc-number">6.1.</span> <span class="toc-text">user space to kernel space</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-space-to-user-space"><span class="toc-number">6.2.</span> <span class="toc-text">kernel space to user space</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#structure-I-think"><span class="toc-number">7.</span> <span class="toc-text">structure I think</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel-state-function"><span class="toc-number">8.</span> <span class="toc-text">Kernel state function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigation"><span class="toc-number">9.</span> <span class="toc-text">Mitigation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTF-kernel-pwn-Related"><span class="toc-number">10.</span> <span class="toc-text">CTF kernel pwn Related</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">11.</span> <span class="toc-text">Reference:</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HUAWEI XCTF 2020 PWN WRITE UP"/></a><div class="content"><a class="title" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP">HUAWEI XCTF 2020 PWN WRITE UP</a><time datetime="2021-01-08T06:43:24.000Z" title="Created 2021-01-08 14:43:24">2021-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Some small records of the I-SOON Cup Of CUIT CTF Competition final"/></a><div class="content"><a class="title" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final">Some small records of the I-SOON Cup Of CUIT CTF Competition final</a><time datetime="2020-12-06T10:42:47.000Z" title="Created 2020-12-06 18:42:47">2020-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="祥云杯 2020 WP"/></a><div class="content"><a class="title" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP">祥云杯 2020 WP</a><time datetime="2020-11-24T14:47:47.000Z" title="Created 2020-11-24 22:47:47">2020-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/21/wp-qwb-2018-core/" title="强网杯 2018 core"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="强网杯 2018 core"/></a><div class="content"><a class="title" href="/2020/11/21/wp-qwb-2018-core/" title="强网杯 2018 core">强网杯 2018 core</a><time datetime="2020-11-21T14:47:47.000Z" title="Created 2020-11-21 22:47:47">2020-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/15/issues/" title="issues"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="issues"/></a><div class="content"><a class="title" href="/2020/11/15/issues/" title="issues">issues</a><time datetime="2020-11-15T13:36:30.000Z" title="Created 2020-11-15 21:36:30">2020-11-15</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>